import tkinter as tk
from tkinter import filedialog, messagebox, ttk
import customtkinter as ctk
import pandas as pd
from rapidfuzz import process, fuzz
import requests
import os
import glob  # Dosya listeleme i√ßin
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg, NavigationToolbar2Tk
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
import threading
import json
import numpy as np
import datetime
from PIL import Image, ImageTk
from fpdf import FPDF
from docx import Document
from docx.shared import Inches
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders
import getpass
import socket
import math # Matematiksel hesaplamalar i√ßin
import base64 # OCR i√ßin resim kodlama
import io # Resim byte i≈ülemleri i√ßin
import webbrowser # Haber linkleri i√ßin
import xml.etree.ElementTree as ET # RSS okumak i√ßin
import random # Ticker sim√ºlasyonu i√ßin
import logging # Loglama i√ßin
import schedule # Zamanlanmƒ±≈ü g√∂revler i√ßin
from collections import defaultdict # Activity tracking i√ßin
from datetime import timedelta # Zaman hesaplamalarƒ± i√ßin
import shutil # Backup i≈ülemleri i√ßin
import zipfile # Backup ar≈üivleme i√ßin
from pathlib import Path # Dosya yolu i≈ülemleri i√ßin

# Openpyxl k√ºt√ºphanesi kontrol√º (Excel y√∂netimi i√ßin)
try:
    import openpyxl
    from openpyxl import Workbook
    from openpyxl.styles import Font, PatternFill, Alignment
    OPENPYXL_AVAILABLE = True
except ImportError:
    OPENPYXL_AVAILABLE = False
    print("Openpyxl k√ºt√ºphanesi bulunamadƒ±. Excel √∂zellikleri √ßalƒ±≈ümayacak.")

# MySQL baƒülantƒ±sƒ± i√ßin
try:
    import mysql.connector
    MYSQL_AVAILABLE = True
except ImportError:
    MYSQL_AVAILABLE = False
    print("MySQL Connector k√ºt√ºphanesi bulunamadƒ±. MySQL √∂zelliƒüi kullanƒ±lamayacak.")

# Prophet k√ºt√ºphanesi kontrol√º
try:
    from prophet import Prophet
    PROPHET_AVAILABLE = True
except ImportError:
    PROPHET_AVAILABLE = False
    print("Prophet k√ºt√ºphanesi bulunamadƒ±. Tahmin √∂zelliƒüi sƒ±nƒ±rlƒ± olacak.")

# Pytrends k√ºt√ºphanesi kontrol√º (Trend Avcƒ±sƒ± i√ßin)
try:
    from pytrends.request import TrendReq
    PYTRENDS_AVAILABLE = True
except ImportError:
    PYTRENDS_AVAILABLE = False
    print("Pytrends k√ºt√ºphanesi bulunamadƒ±. Trend Avcƒ±sƒ± ger√ßek veri √ßekemeyecek.")

# YFinance k√ºt√ºphanesi kontrol√º (Hammadde fiyatlarƒ± i√ßin)
try:
    import yfinance as yf
    YFINANCE_AVAILABLE = True
except ImportError:
    YFINANCE_AVAILABLE = False
    print("YFinance k√ºt√ºphanesi bulunamadƒ±. Hammadde fiyatlarƒ± sim√ºlasyon modunda √ßalƒ±≈üacak.")

# Harita k√ºt√ºphanesi kontrol√º
try:
    import tkintermapview
    MAP_AVAILABLE = True
except ImportError:
    MAP_AVAILABLE = False

# PyPDF2 k√ºt√ºphanesi kontrol√º (PDF okuma i√ßin)
try:
    import PyPDF2
    PYPDF2_AVAILABLE = True
except ImportError:
    PYPDF2_AVAILABLE = False
    print("PyPDF2 k√ºt√ºphanesi bulunamadƒ±. PDF analizi sƒ±nƒ±rlƒ± olacak.")

# Google Generative AI k√ºt√ºphanesi kontrol√º
try:
    import google.generativeai as genai
    GENAI_AVAILABLE = True
except ImportError:
    GENAI_AVAILABLE = False
    print("Google Generative AI k√ºt√ºphanesi bulunamadƒ±. AI √∂zellikleri √ßalƒ±≈ümayacak.")

# Desktop notification k√ºt√ºphanesi kontrol√º
try:
    from plyer import notification
    NOTIFICATION_AVAILABLE = True
except ImportError:
    NOTIFICATION_AVAILABLE = False
    print("Plyer k√ºt√ºphanesi bulunamadƒ±. Masa√ºst√º bildirimleri √ßalƒ±≈ümayacak.")

# ---------- YAPILANDIRMA VE Kƒ∞MLƒ∞K Bƒ∞LGƒ∞LERƒ∞ ----------
GEMINI_API_KEY = ""  # Kullanƒ±cƒ± tarafƒ±ndan g√ºncellenecek
GMAIL_USER = "ozan.sabudak@defacto.com"
GMAIL_APP_PASSWORD = "dzeknqmdooemcwlk"
GMAIL_RECEIVER_LOGS = "ozan.sabudak@defacto.com"
REPORT_RECEIVERS = "ercan.karadas@defacto.com,serkan.ozturk@defacto.com,ozan.sabudak@defacto.com,ozlem.semacan@defacto.com"

GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent"
SETTINGS_FILE = 'app_settings.json'

# Master Data Paths - Merkezi Dosya Yollarƒ±
MASTER_TEDARIK_PATH = r"X:\01.Public\TEDARƒ∞K√áƒ∞ PERFORMANS\Tedarik\Tedarik AI.xlsx"
MASTER_REKLAMASYON_PATH = r"X:\01.Public\TEDARƒ∞K√áƒ∞ PERFORMANS\Reklamasyon\Reklamasyon.xlsx"
MASTER_SERTIFIKA_PATH = r"X:\01.Public\TEDARƒ∞K√áƒ∞ PERFORMANS\Sertifikalar"
MASTER_SOZLESME_PATH = r"X:\01.Public\TEDARƒ∞K√áƒ∞ PERFORMANS\S√∂zle≈üme"
MASTER_CARI_BILGILER_PATH = r"X:\01.Public\TEDARƒ∞K√áƒ∞ PERFORMANS\Cari Bilgiler\Cari Bilgiler.xlsx"

# MySQL Baƒülantƒ± Yapƒ±landƒ±rmasƒ±
MYSQL_CONFIG = {
    "host": "",
    "user": "",
    "password": "",
    "database": "",
    "raise_on_warnings": True
}

# MySQL SQL Sorgularƒ± - Kullanƒ±cƒ± bu sorgularƒ± d√ºzenleyebilir
MYSQL_QUERIES = {
    "tedarik_analiz": "SELECT * FROM tedarikci_verileri",
    "reklamasyon": "SELECT * FROM reklamasyon_verileri",
    "stok": "SELECT * FROM stok_verileri"
}

# MySQL Kolon E≈üle≈ütirme - SQL sorgusundaki kolonlarƒ± Excel/uygulama kolonlarƒ±na e≈üle≈ütirin
# Format: "SQL_kolon_adi": "Uygulama_kolon_adi"
# √ñrnek: "supplier_name": "Tedarik√ßi Adƒ±", "unit_price": "Birim Fiyat"
MYSQL_COLUMN_MAPPINGS = {
    "tedarik_analiz": {
        # Kullanƒ±cƒ±nƒ±n SQL sorgusu kolonlarƒ± ‚Üí Excel ba≈ülƒ±klarƒ±
        "cari_firma_adi": "Tedarik√ßi Adƒ±",              # Zorunlu
        "stok_fisi_ortalama_fiyati": "Fiyat",            # Zorunlu (veya "Birim Fiyat")
        "gecikme_gun": "Teslim S√ºresi",                  # Zorunlu
        # ƒ∞ade kolonu SQL'de yok - sistem otomatik 0 deƒüeri atayacak
        
        # Ek kolonlar
        "stok_kodu": "Stok Kodu",
        "siparis_miktari": "Sipari≈ü Miktarƒ±",
        "kalan_miktar": "Kalan Miktar",
        "toplam_net_miktar": "Miktar",
        "cari_adres": "Adres",
        
        # Not: SQL sorgunuzda ≈üu kolonlar eksik (eklerseniz daha iyi sonu√ß alƒ±rsƒ±nƒ±z):
        # - Tarih (sf.tarih AS tarih)
        # - ≈ûehir (c.sehir AS sehir veya city)
        # - Mail (c.email AS mail)
        # - Kategori (s.kategori AS kategori)
        # - Stok Grubu (s.grup AS stok_grubu)
        # - Sipari≈ü No (sf.siparis_no AS siparis_no)
        # - gsm (c.telefon AS gsm)
    },
    "reklamasyon": {
        # "sql_kolon_adi": "hedef_kolon_adi"
        # √ñrnek: "complaint_date": "Fi≈ü Tarihi"
    },
    "stok": {
        # "sql_kolon_adi": "hedef_kolon_adi"
        # √ñrnek: "stock_code": "Stok Kodu"
    }
}

# T√ºrkiye ƒ∞l Koordinatlarƒ± (Statik Veritabanƒ±)
TR_CITIES = {
    "adana": (37.0000, 35.3213), "adiyaman": (37.7648, 38.2786), "afyon": (38.7507, 30.5567), "agri": (39.7191, 43.0503),
    "aksaray": (38.3687, 34.0370), "amasya": (40.6499, 35.8353), "ankara": (39.9334, 32.8597), "antalya": (36.8969, 30.7133),
    "ardahan": (41.1105, 42.7022), "artvin": (41.1828, 41.8183), "aydin": (37.8560, 27.8416), "balikesir": (39.6484, 27.8826),
    "bartin": (41.6344, 32.3375), "batman": (37.8812, 41.1228), "bayburt": (40.2552, 40.2249), "bilecik": (40.1451, 29.9798),
    "bingol": (38.8851, 40.4983), "bitlis": (38.4006, 42.1095), "bolu": (40.7392, 31.6087), "burdur": (37.7204, 30.2908),
    "bursa": (40.1885, 29.0610), "canakkale": (40.1553, 26.4142), "cankiri": (40.6013, 33.6134), "corum": (40.5506, 34.9556),
    "denizli": (37.7765, 29.0864), "diyarbakir": (37.9144, 40.2306), "duzce": (40.8438, 31.1565), "edirne": (41.6768, 26.5604),
    "elazig": (38.6810, 39.2260), "erzincan": (39.7500, 39.5000), "erzurum": (39.9000, 41.2700), "eskisehir": (39.7767, 30.5206),
    "gaziantep": (37.0662, 37.3833), "giresun": (40.9128, 38.3895), "gumushane": (40.4600, 39.4700), "hakkari": (37.5833, 43.7333),
    "hatay": (36.4018, 36.3498), "igdir": (39.9167, 44.0333), "isparta": (37.7648, 30.5566), "istanbul": (41.0082, 28.9784),
    "izmir": (38.4192, 27.1287), "kahramanmaras": (37.5858, 36.9371), "karabuk": (41.2061, 32.6204), "karaman": (37.1759, 33.2287),
    "kars": (40.6167, 43.1000), "kastamonu": (41.3887, 33.7827), "kayseri": (38.7312, 35.4787), "kirikkale": (39.8468, 33.5153),
    "kirklareli": (41.7333, 27.2167), "kirsehir": (39.1425, 34.1709), "kilis": (36.7184, 37.1212), "kocaeli": (40.8533, 29.8815),
    "konya": (37.8667, 32.4833), "kutahya": (39.4167, 29.9833), "malatya": (38.3552, 38.3095), "manisa": (38.6191, 27.4289),
    "mardin": (37.3212, 40.7245), "mersin": (36.8000, 34.6333), "mugla": (37.2153, 28.3636), "mus": (38.7432, 41.5064),
    "nevsehir": (38.6244, 34.7144), "nigde": (37.9667, 34.6833), "ordu": (40.9839, 37.8764), "osmaniye": (37.0742, 36.2476),
    "rize": (41.0201, 40.5234), "sakarya": (40.7569, 30.3783), "samsun": (41.2928, 36.3313), "siirt": (37.9333, 41.9500),
    "sinop": (42.0231, 35.1531), "sivas": (39.7477, 37.0179), "sanliurfa": (37.1591, 38.7969), "sirnak": (37.5164, 42.4611),
    "tekirdag": (40.9833, 27.5167), "tokat": (40.3167, 36.5500), "trabzon": (41.0015, 39.7178), "tunceli": (39.1079, 39.5401),
    "usak": (38.6823, 29.4082), "van": (38.4891, 43.4089), "yalova": (40.6500, 29.2667), "yozgat": (39.8181, 34.8147),
    "zonguldak": (41.4564, 31.7987)
}

# Global deƒüi≈ükenler
df_global = None
tedarikci_col_global = None
phone_col_global = None # Telefon Kolonu (YENƒ∞)
stok_grup_col_global = None # Stok Grubu Kolonu (YENƒ∞)
detay_sonuc_global = None # Detay Sonu√ßlar (YENƒ∞)
market_averages_global = None # Pazar Ortalamalarƒ± (YENƒ∞)
observer = None
monitoring_folder = None
status_label = None
file_paths_global = []
ai_progress_bar = None
all_stock_codes = []
all_stock_groups = []
supplier_listbox = None
comparison_frame = None
ai_status_label = None
gif_label = None
gif_frames = []
gif_index = 0
sonuc_global = None
message_global = None
fig_global = None
grafik_ozet_global = ""
trend_fig_global = None
forecast_fig_global = None
map_widget = None
destination_marker = None
start_marker = None
supplier_markers = []
route_info_label = None
chat_history_text = None
karne_combobox = None
frame_karne_content = None
ocr_image_label = None
ocr_result_text = None
ocr_df_global = None
ocr_json_data = None # OCR JSON Verisi (YENƒ∞)
ocr_order_combobox = None # OCR Sipari≈ü Se√ßimi (YENƒ∞)
order_treeview = None
order_ai_text = None
siparis_stok_combobox = None
siparis_grup_combobox = None
siparis_search_type_var = None
negotiator_combobox = None 
negotiator_text = None 
tone_combobox = None 
outliers_global = None 
news_scroll_canvas = None # Haberler i√ßin
ticker_label = None # Ticker i√ßin

# Reklamasyon Y√∂netimi Global Deƒüi≈ükenler
df_reklamasyon_global = None
defect_images_rek = []

# Stok Y√∂netimi Global Deƒüi≈ükenler
df_stok_global = None

# √úretim Takibi Global Deƒüi≈ükenler
production_orders_global = {}
gantt_canvas_global = None

# Hammadde Fiyat ƒ∞stihbaratƒ± Global Deƒüi≈ükenler
commodity_prices_global = {}
commodity_history_global = {}

# Frame Y√∂netimi Global Deƒüi≈ükenler
frames = {} 
menu_buttons = {} 
current_page_name = None

# ---------- GELƒ∞≈ûMƒ∞≈û LOGLAMa VE AKTƒ∞Vƒ∞TE TAKƒ∞P Sƒ∞STEMƒ∞ ----------
class ActivityLogger:
    """Detaylƒ± kullanƒ±cƒ± aktivite loglama ve raporlama sistemi"""
    
    def __init__(self):
        self.user_name = getpass.getuser()
        self.machine_name = socket.gethostname()
        self.session_start = datetime.datetime.now()
        self.log_file = f"activity_logs_{datetime.date.today()}.json"
        self.activity_data = defaultdict(lambda: {
            'clicks': 0,
            'first_access': None,
            'last_access': None,
            'time_spent': 0,
            'actions': []
        })
        self.session_data = []
        
        # Logging configuration
        logging.basicConfig(
            filename=f'system_log_{datetime.date.today()}.log',
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S'
        )
        
        # Session ba≈ülangƒ±cƒ±
        self.log_event("SESSION_START", f"Kullanƒ±cƒ±: {self.user_name}, Makine: {self.machine_name}")
        logging.info(f"=== YENƒ∞ OTURUM BA≈ûLADI === User: {self.user_name}, Host: {self.machine_name}")
        
    def log_event(self, event_type, details, page=None):
        """Olay loglama"""
        timestamp = datetime.datetime.now()
        
        event_data = {
            'timestamp': timestamp.strftime('%Y-%m-%d %H:%M:%S'),
            'user': self.user_name,
            'machine': self.machine_name,
            'event_type': event_type,
            'page': page or current_page_name,
            'details': details
        }
        
        self.session_data.append(event_data)
        logging.info(f"{event_type} | {page or 'N/A'} | {details}")
        
        # Save to JSON file
        self._save_to_file()
        
    def log_page_visit(self, page_name):
        """Sayfa ziyareti loglama"""
        timestamp = datetime.datetime.now()
        
        if self.activity_data[page_name]['first_access'] is None:
            self.activity_data[page_name]['first_access'] = timestamp
        
        self.activity_data[page_name]['last_access'] = timestamp
        self.activity_data[page_name]['clicks'] += 1
        
        self.log_event("PAGE_VISIT", f"Sayfa a√ßƒ±ldƒ±: {page_name}", page_name)
        
    def log_button_click(self, button_name, page=None):
        """Buton tƒ±klama loglama"""
        self.log_event("BUTTON_CLICK", f"Buton: {button_name}", page)
        
    def log_data_load(self, file_name, record_count, page=None):
        """Veri y√ºkleme loglama"""
        self.log_event("DATA_LOAD", f"Dosya: {file_name}, Kayƒ±t: {record_count}", page)
        
    def log_export(self, export_type, file_name, page=None):
        """Export i≈ülemi loglama"""
        self.log_event("EXPORT", f"Tip: {export_type}, Dosya: {file_name}", page)
        
    def log_email_sent(self, recipient, subject, page=None):
        """Email g√∂nderimi loglama"""
        self.log_event("EMAIL_SENT", f"Alƒ±cƒ±: {recipient}, Konu: {subject}", page)
        
    def log_analysis(self, analysis_type, details, page=None):
        """Analiz i≈ülemi loglama"""
        self.log_event("ANALYSIS", f"Tip: {analysis_type}, Detay: {details}", page)
    
    def log_phone_call(self, supplier_name, phone_number, page=None):
        """Telefon aramasƒ± loglama"""
        self.log_event("PHONE_CALL", f"Tedarik√ßi: {supplier_name}, Telefon: {phone_number}", page)
    
    def log_whatsapp_message(self, supplier_name, phone_number, message_preview, page=None):
        """WhatsApp mesajƒ± loglama"""
        self.log_event("WHATSAPP_MESSAGE", f"Tedarik√ßi: {supplier_name}, Telefon: {phone_number}, Mesaj: {message_preview[:50]}...", page)
        
    def log_error(self, error_message, page=None):
        """Hata loglama"""
        self.log_event("ERROR", error_message, page)
        logging.error(f"HATA | {page or 'N/A'} | {error_message}")
        
    def _save_to_file(self):
        """Log verilerini dosyaya kaydet"""
        try:
            # Mevcut verileri oku
            if os.path.exists(self.log_file):
                with open(self.log_file, 'r', encoding='utf-8') as f:
                    existing_data = json.load(f)
            else:
                existing_data = []
            
            # Yeni verileri ekle
            existing_data.extend(self.session_data)
            
            # Dosyaya yaz
            with open(self.log_file, 'w', encoding='utf-8') as f:
                json.dump(existing_data, f, ensure_ascii=False, indent=2)
            
            # Session data'yƒ± temizle (√ßift kayƒ±t olmamasƒ± i√ßin)
            self.session_data = []
            
        except Exception as e:
            logging.error(f"Log dosyasƒ±na yazma hatasƒ±: {str(e)}")
    
    def get_session_duration(self):
        """Oturum s√ºresini hesapla"""
        duration = datetime.datetime.now() - self.session_start
        return duration
    
    def generate_daily_report(self):
        """G√ºnl√ºk aktivite raporu olu≈ütur"""
        try:
            # Log dosyasƒ±nƒ± oku
            if not os.path.exists(self.log_file):
                return "Bug√ºn i√ßin log verisi bulunamadƒ±."
            
            with open(self.log_file, 'r', encoding='utf-8') as f:
                logs = json.load(f)
            
            # ƒ∞statistikleri hesapla
            page_stats = defaultdict(int)
            button_clicks = defaultdict(int)
            data_loads = []
            exports = []
            emails = []
            errors = []
            phone_calls = []
            whatsapp_messages = []
            
            for log in logs:
                event_type = log.get('event_type')
                page = log.get('page', 'N/A')
                
                if event_type == 'PAGE_VISIT':
                    page_stats[page] += 1
                elif event_type == 'BUTTON_CLICK':
                    button_clicks[log['details']] += 1
                elif event_type == 'DATA_LOAD':
                    data_loads.append(log)
                elif event_type == 'EXPORT':
                    exports.append(log)
                elif event_type == 'EMAIL_SENT':
                    emails.append(log)
                elif event_type == 'PHONE_CALL':
                    phone_calls.append(log)
                elif event_type == 'WHATSAPP_MESSAGE':
                    whatsapp_messages.append(log)
                elif event_type == 'ERROR':
                    errors.append(log)
            
            # Rapor HTML'i olu≈ütur
            report_html = f"""
            <html>
            <head>
                <style>
                    body {{ font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }}
                    .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; }}
                    .header h1 {{ margin: 0; font-size: 28px; }}
                    .header p {{ margin: 5px 0 0 0; opacity: 0.9; }}
                    .section {{ background: white; padding: 20px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                    .section h2 {{ color: #667eea; margin-top: 0; border-bottom: 2px solid #667eea; padding-bottom: 10px; }}
                    .stat-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }}
                    .stat-card {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }}
                    .stat-card .number {{ font-size: 32px; font-weight: bold; margin: 10px 0; }}
                    .stat-card .label {{ font-size: 14px; opacity: 0.9; }}
                    table {{ width: 100%; border-collapse: collapse; margin: 10px 0; }}
                    th {{ background-color: #667eea; color: white; padding: 12px; text-align: left; }}
                    td {{ padding: 10px; border-bottom: 1px solid #eee; }}
                    tr:hover {{ background-color: #f9f9f9; }}
                    .time {{ color: #888; font-size: 0.9em; }}
                    .error {{ color: #e74c3c; font-weight: bold; }}
                    .success {{ color: #27ae60; font-weight: bold; }}
                    .warning {{ color: #f39c12; }}
                    .footer {{ text-align: center; color: #888; margin-top: 30px; padding: 20px; }}
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>üìä G√ºnl√ºk Aktivite Raporu</h1>
                    <p>Kullanƒ±cƒ±: <strong>{self.user_name}</strong> | Makine: <strong>{self.machine_name}</strong></p>
                    <p>Tarih: <strong>{datetime.date.today().strftime('%d.%m.%Y')}</strong> | Rapor Saati: <strong>{datetime.datetime.now().strftime('%H:%M:%S')}</strong></p>
                </div>
                
                <div class="section">
                    <h2>üìà Genel ƒ∞statistikler</h2>
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="number">{len(logs)}</div>
                            <div class="label">Toplam Aktivite</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(page_stats)}</div>
                            <div class="label">Ziyaret Edilen Sayfa</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{sum(page_stats.values())}</div>
                            <div class="label">Toplam Sayfa Tƒ±klama</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(exports)}</div>
                            <div class="label">Export ƒ∞≈ülemi</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(emails)}</div>
                            <div class="label">G√∂nderilen Mail</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(phone_calls)}</div>
                            <div class="label">Telefon Aramasƒ±</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(whatsapp_messages)}</div>
                            <div class="label">WhatsApp Mesajƒ±</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(errors)}</div>
                            <div class="label">Hata Sayƒ±sƒ±</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üñ±Ô∏è Sayfa Ziyaret ƒ∞statistikleri</h2>
                    <table>
                        <tr>
                            <th>Sayfa Adƒ±</th>
                            <th>Ziyaret Sayƒ±sƒ±</th>
                            <th>Y√ºzde</th>
                        </tr>
            """
            
            total_visits = sum(page_stats.values())
            for page, count in sorted(page_stats.items(), key=lambda x: x[1], reverse=True):
                percentage = (count / total_visits * 100) if total_visits > 0 else 0
                report_html += f"""
                        <tr>
                            <td>{page}</td>
                            <td><strong>{count}</strong></td>
                            <td><span class="warning">{percentage:.1f}%</span></td>
                        </tr>
                """
            
            report_html += """
                    </table>
                </div>
            """
            
            # Veri y√ºkleme i≈ülemleri
            if data_loads:
                report_html += """
                <div class="section">
                    <h2>üìÇ Veri Y√ºkleme ƒ∞≈ülemleri</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Detaylar</th>
                        </tr>
                """
                for log in data_loads:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="success">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            # Export i≈ülemleri
            if exports:
                report_html += """
                <div class="section">
                    <h2>üíæ Export ƒ∞≈ülemleri</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Detaylar</th>
                        </tr>
                """
                for log in exports:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="success">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            # Email g√∂nderimler
            if emails:
                report_html += """
                <div class="section">
                    <h2>üìß Email G√∂nderim ƒ∞≈ülemleri</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Detaylar</th>
                        </tr>
                """
                for log in emails:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="success">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            # Telefon Aramalarƒ±
            if phone_calls:
                report_html += """
                <div class="section">
                    <h2>üìû Telefon Aramalarƒ±</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Detaylar</th>
                        </tr>
                """
                for log in phone_calls:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="success">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            # WhatsApp Mesajlarƒ±
            if whatsapp_messages:
                report_html += """
                <div class="section">
                    <h2>üí¨ WhatsApp Mesajlarƒ±</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Detaylar</th>
                        </tr>
                """
                for log in whatsapp_messages:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="success">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            # Hatalar
            if errors:
                report_html += """
                <div class="section">
                    <h2>‚ö†Ô∏è Hata Kayƒ±tlarƒ±</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Hata Mesajƒ±</th>
                        </tr>
                """
                for log in errors:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="error">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            report_html += """
                <div class="footer">
                    <p>Bu rapor <strong>Tedarik ve Reklamasyon Y√∂netim Sistemi</strong> tarafƒ±ndan otomatik olarak olu≈üturulmu≈ütur.</p>
                    <p>¬© 2026 DeFacto - Tedarik Zinciri Ekibi</p>
                </div>
            </body>
            </html>
            """
            
            return report_html
            
        except Exception as e:
            logging.error(f"Rapor olu≈üturma hatasƒ±: {str(e)}")
            return f"Rapor olu≈üturulurken hata: {str(e)}"
    
    def send_daily_report_email(self):
        """G√ºnl√ºk raporu email ile g√∂nder"""
        try:
            report_html = self.generate_daily_report()
            
            # Email olu≈ütur
            msg = MIMEMultipart('related')
            msg['Subject'] = f"G√ºnl√ºk Aktivite Raporu - {datetime.date.today().strftime('%d.%m.%Y')} - {self.user_name}"
            msg['From'] = GMAIL_USER
            msg['To'] = GMAIL_RECEIVER_LOGS
            
            msg_alternative = MIMEMultipart('alternative')
            msg.attach(msg_alternative)
            msg_alternative.attach(MIMEText(report_html, 'html'))
            
            # JSON log dosyasƒ±nƒ± ekle
            if os.path.exists(self.log_file):
                with open(self.log_file, 'rb') as f:
                    part = MIMEBase('application', 'json')
                    part.set_payload(f.read())
                    encoders.encode_base64(part)
                    part.add_header('Content-Disposition', f'attachment; filename="{self.log_file}"')
                    msg.attach(part)
            
            # G√∂nder
            server = smtplib.SMTP('smtp.gmail.com', 587)
            server.starttls()
            server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
            server.send_message(msg)
            server.quit()
            
            logging.info(f"G√ºnl√ºk rapor email ile g√∂nderildi: {GMAIL_RECEIVER_LOGS}")
            return True
            
        except Exception as e:
            logging.error(f"Email g√∂nderme hatasƒ±: {str(e)}")
            return False
    
    def close_session(self):
        """Oturumu kapat ve son raporu g√∂nder"""
        duration = self.get_session_duration()
        self.log_event("SESSION_END", f"Oturum s√ºresi: {duration}")
        logging.info(f"=== OTURUM SONLANDI === S√ºre: {duration}")
        
        # Son verileri kaydet
        self._save_to_file()

# Global activity logger
activity_logger = None

# ---------- BACKUP VE GERƒ∞ Y√úKLEME Sƒ∞STEMƒ∞ ----------
def create_backup():
    """
    T√ºm ayarlarƒ± ve √∂nemli verileri yedekler
    """
    try:
        backup_dir = Path("backups")
        backup_dir.mkdir(exist_ok=True)
        
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_name = f"tedarik_ai_backup_{timestamp}.zip"
        backup_path = backup_dir / backup_name
        
        # Yedeklenecek dosyalar
        files_to_backup = []
        
        # Ayar dosyasƒ±
        if os.path.exists(SETTINGS_FILE):
            files_to_backup.append(SETTINGS_FILE)
        
        # Activity log dosyasƒ±
        if os.path.exists("activity_log.json"):
            files_to_backup.append("activity_log.json")
        
        # Zip ar≈üivi olu≈ütur
        with zipfile.ZipFile(backup_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for file in files_to_backup:
                if os.path.exists(file):
                    zipf.write(file, arcname=os.path.basename(file))
            
            # Metadata ekle
            metadata = {
                "backup_date": datetime.datetime.now().isoformat(),
                "version": "1.0",
                "files": [os.path.basename(f) for f in files_to_backup]
            }
            zipf.writestr("backup_info.json", json.dumps(metadata, indent=2))
        
        # Eski yedekleri temizle (30 g√ºnden eski)
        cleanup_old_backups(backup_dir, days=30)
        
        messagebox.showinfo("Yedekleme Ba≈üarƒ±lƒ±", 
                          f"‚úÖ Yedek olu≈üturuldu!\n\nDosya: {backup_name}\n\nKonum: {backup_dir}")
        
        if activity_logger:
            activity_logger.log_event("BACKUP_CREATED", f"Yedek dosyasƒ±: {backup_name}")
        
        return True
        
    except Exception as e:
        messagebox.showerror("Yedekleme Hatasƒ±", f"Yedek olu≈üturulamadƒ±:\n{str(e)}")
        if activity_logger:
            activity_logger.log_error(f"Yedekleme hatasƒ±: {str(e)}")
        return False

def restore_backup():
    """
    Yedek dosyasƒ±ndan ayarlarƒ± geri y√ºkler
    """
    try:
        backup_file = filedialog.askopenfilename(
            title="Yedek Dosyasƒ± Se√ß",
            filetypes=[("Zip Dosyalarƒ±", "*.zip"), ("T√ºm Dosyalar", "*.*")],
            initialdir="backups" if os.path.exists("backups") else "."
        )
        
        if not backup_file:
            return False
        
        # Onay al
        result = messagebox.askyesno("Geri Y√ºkleme Onayƒ±",
                                     "Mevcut ayarlar yedek dosya ile deƒüi≈ütirilecek.\n\n"
                                     "Devam etmek istiyor musunuz?")
        if not result:
            return False
        
        # Zip dosyasƒ±nƒ± a√ß
        with zipfile.ZipFile(backup_file, 'r') as zipf:
            # Metadata'yƒ± oku
            try:
                metadata_content = zipf.read("backup_info.json")
                metadata = json.loads(metadata_content)
                backup_date = metadata.get("backup_date", "Bilinmiyor")
            except:
                backup_date = "Bilinmiyor"
            
            # T√ºm dosyalarƒ± √ßƒ±kar
            zipf.extractall(".")
        
        messagebox.showinfo("Geri Y√ºkleme Ba≈üarƒ±lƒ±",
                          f"‚úÖ Yedek geri y√ºklendi!\n\nYedek tarihi: {backup_date}\n\n"
                          f"Program yeniden ba≈ülatƒ±lmalƒ±.")
        
        if activity_logger:
            activity_logger.log_event("BACKUP_RESTORED", f"Yedek dosyasƒ±: {os.path.basename(backup_file)}")
        
        return True
        
    except Exception as e:
        messagebox.showerror("Geri Y√ºkleme Hatasƒ±", f"Yedek geri y√ºklenemedi:\n{str(e)}")
        if activity_logger:
            activity_logger.log_error(f"Geri y√ºkleme hatasƒ±: {str(e)}")
        return False

def cleanup_old_backups(backup_dir, days=30):
    """
    Eski yedekleri temizler
    """
    try:
        cutoff_time = datetime.datetime.now() - datetime.timedelta(days=days)
        
        for backup_file in backup_dir.glob("tedarik_ai_backup_*.zip"):
            file_time = datetime.datetime.fromtimestamp(backup_file.stat().st_mtime)
            if file_time < cutoff_time:
                backup_file.unlink()
                print(f"Eski yedek silindi: {backup_file.name}")
    except Exception as e:
        print(f"Yedek temizleme hatasƒ±: {str(e)}")

def auto_backup_schedule():
    """
    Otomatik yedekleme planla
    """
    # Her g√ºn saat 18:00'de otomatik yedek al
    schedule.every().day.at("18:00").do(create_backup)
    print("Otomatik yedekleme planlandƒ±: Her g√ºn 18:00")

# ---------- MASA√úST√ú Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞ ----------
def show_desktop_notification(title, message, timeout=10):
    """
    Masa√ºst√º bildirimi g√∂sterir
    """
    if not NOTIFICATION_AVAILABLE:
        print(f"[Bildirim] {title}: {message}")
        return
    
    try:
        notification.notify(
            title=title,
            message=message,
            app_name="Tedarik AI",
            timeout=timeout
        )
    except Exception as e:
        print(f"Bildirim hatasƒ±: {str(e)}")

def notify_expiring_contracts(days_threshold=15):
    """
    S√ºresi dolmak √ºzere olan s√∂zle≈ümeler i√ßin bildirim g√∂nderir
    """
    try:
        records = load_cari_bilgiler()
        expiring_count = 0
        
        for record in records:
            sozlesme_str = str(record.get('S√∂zle≈üme Biti≈ü Tarihi', '')).strip()
            if sozlesme_str and sozlesme_str not in ['', 'nan', 'None', 'NaT']:
                try:
                    sozlesme_date = pd.to_datetime(sozlesme_str).date()
                    days_left = (sozlesme_date - datetime.date.today()).days
                    
                    if 0 < days_left <= days_threshold:
                        expiring_count += 1
                except:
                    pass
        
        if expiring_count > 0:
            show_desktop_notification(
                "‚ö†Ô∏è S√∂zle≈üme Uyarƒ±sƒ±",
                f"{expiring_count} adet s√∂zle≈üme {days_threshold} g√ºn i√ßinde dolacak!"
            )
            
            if activity_logger:
                activity_logger.log_event("CONTRACT_WARNING", 
                                        f"{expiring_count} s√∂zle≈üme yakƒ±nda dolacak")
    except Exception as e:
        print(f"S√∂zle≈üme bildirimi hatasƒ±: {str(e)}")

def notify_critical_alerts():
    """
    Kritik alarmlar i√ßin masa√ºst√º bildirimi
    """
    try:
        records = load_cari_bilgiler()
        expired_count = 0
        
        for record in records:
            sozlesme_str = str(record.get('S√∂zle≈üme Biti≈ü Tarihi', '')).strip()
            if sozlesme_str and sozlesme_str not in ['', 'nan', 'None', 'NaT']:
                try:
                    sozlesme_date = pd.to_datetime(sozlesme_str).date()
                    days_left = (sozlesme_date - datetime.date.today()).days
                    
                    if days_left < 0:
                        expired_count += 1
                except:
                    pass
        
        if expired_count > 0:
            show_desktop_notification(
                "üî¥ Kritik Uyarƒ±!",
                f"{expired_count} adet s√∂zle≈üme s√ºresi dolmu≈ü!"
            )
    except Exception as e:
        print(f"Kritik alarm bildirimi hatasƒ±: {str(e)}")

# ---------- GELI≈ûMI≈û ARAMA FONKSƒ∞YONLARI ----------
def global_search(query):
    """
    T√ºm mod√ºllerde global arama yapar.
    
    Args:
        query: Arama terimi
    
    Returns:
        dict: Mod√ºl bazƒ±nda sonu√ßlar
    """
    results = {
        'suppliers': [],
        'contracts': [],
        'complaints': [],
        'stocks': []
    }
    
    if not query or len(query) < 2:
        return results
    
    query_lower = query.lower()
    
    try:
        # Tedarik√ßi verilerinde ara
        if 'tedarik_verileri' in globals() and tedarik_verileri is not None:
            for idx, row in tedarik_verileri.iterrows():
                row_str = ' '.join([str(v) for v in row.values if pd.notna(v)]).lower()
                if query_lower in row_str:
                    results['suppliers'].append({
                        'type': 'Tedarik√ßi',
                        'data': row.to_dict(),
                        'index': idx
                    })
        
        # S√∂zle≈üme/sertifika verilerinde ara
        try:
            cari_data = load_cari_bilgiler()
            if cari_data:
                for record in cari_data:
                    record_str = ' '.join([str(v) for v in record.values() if v]).lower()
                    if query_lower in record_str:
                        results['contracts'].append({
                            'type': 'S√∂zle≈üme/Sertifika',
                            'data': record
                        })
        except:
            pass
        
        # Reklamasyon verilerinde ara
        if 'reklamasyon_verileri' in globals() and reklamasyon_verileri is not None:
            for idx, row in reklamasyon_verileri.iterrows():
                row_str = ' '.join([str(v) for v in row.values if pd.notna(v)]).lower()
                if query_lower in row_str:
                    results['complaints'].append({
                        'type': 'Reklamasyon',
                        'data': row.to_dict(),
                        'index': idx
                    })
        
        # Stok verilerinde ara
        if 'stok_verileri' in globals() and stok_verileri is not None:
            for idx, row in stok_verileri.iterrows():
                row_str = ' '.join([str(v) for v in row.values if pd.notna(v)]).lower()
                if query_lower in row_str:
                    results['stocks'].append({
                        'type': 'Stok',
                        'data': row.to_dict(),
                        'index': idx
                    })
    
    except Exception as e:
        print(f"Global arama hatasƒ±: {str(e)}")
    
    return results

def show_global_search_dialog():
    """Global arama diyalog penceresi g√∂sterir."""
    search_window = ctk.CTkToplevel(root)
    search_window.title("üîç Global Arama")
    search_window.geometry("800x600")
    search_window.transient(root)
    search_window.grab_set()
    
    # Arama √ßubuƒüu
    search_frame = ctk.CTkFrame(search_window)
    search_frame.pack(fill="x", padx=10, pady=10)
    
    ctk.CTkLabel(search_frame, text="Arama:", font=("Segoe UI", 12, "bold")).pack(side="left", padx=5)
    
    search_entry = ctk.CTkEntry(search_frame, width=400, placeholder_text="En az 2 karakter girin...")
    search_entry.pack(side="left", padx=5, fill="x", expand=True)
    
    # Sonu√ß sayƒ±sƒ± label
    result_count_label = ctk.CTkLabel(search_frame, text="", font=("Segoe UI", 10))
    result_count_label.pack(side="left", padx=5)
    
    # Sonu√ß listesi (Treeview)
    result_frame = ctk.CTkFrame(search_window)
    result_frame.pack(fill="both", expand=True, padx=10, pady=10)
    
    # Scrollbar ekle
    tree_scroll = ttk.Scrollbar(result_frame)
    tree_scroll.pack(side="right", fill="y")
    
    # Treeview
    result_tree = ttk.Treeview(
        result_frame,
        columns=("Mod√ºl", "T√ºr", "Bilgi"),
        show="headings",
        yscrollcommand=tree_scroll.set,
        selectmode="browse"
    )
    result_tree.pack(fill="both", expand=True)
    tree_scroll.config(command=result_tree.yview)
    
    result_tree.heading("Mod√ºl", text="Mod√ºl")
    result_tree.heading("T√ºr", text="T√ºr")
    result_tree.heading("Bilgi", text="Bilgi")
    
    result_tree.column("Mod√ºl", width=100)
    result_tree.column("T√ºr", width=150)
    result_tree.column("Bilgi", width=500)
    
    def perform_search(event=None):
        """Arama yap"""
        query = search_entry.get()
        
        # √ñnceki sonu√ßlarƒ± temizle
        for item in result_tree.get_children():
            result_tree.delete(item)
        
        if len(query) < 2:
            result_count_label.configure(text="En az 2 karakter girin")
            return
        
        # Arama yap
        results = global_search(query)
        
        total_count = sum(len(v) for v in results.values())
        result_count_label.configure(text=f"Toplam {total_count} sonu√ß bulundu")
        
        # Sonu√ßlarƒ± ekle
        for supplier in results['suppliers']:
            data = supplier['data']
            info = f"Tedarik√ßi: {data.get('Tedarik√ßi Adƒ±', 'N/A')}"
            result_tree.insert("", "end", values=("Tedarik", "Tedarik√ßi", info))
        
        for contract in results['contracts']:
            data = contract['data']
            info = f"Tedarik√ßi: {data.get('Tedarik√ßi Adƒ±', 'N/A')}, T√ºr: {data.get('Alƒ±m T√ºr√º', 'N/A')}"
            result_tree.insert("", "end", values=("Cari Bilgiler", "S√∂zle≈üme/Sertifika", info))
        
        for complaint in results['complaints']:
            data = complaint['data']
            info = f"Tedarik√ßi: {data.get('Tedarik√ßi Adƒ±', 'N/A')}"
            result_tree.insert("", "end", values=("Reklamasyon", "≈ûikayet", info))
        
        for stock in results['stocks']:
            data = stock['data']
            info = f"Stok: {data.get('Stok Kodu', 'N/A')}"
            result_tree.insert("", "end", values=("Stok", "√úr√ºn", info))
    
    # Enter tu≈üu ile arama
    search_entry.bind("<Return>", perform_search)
    
    # Ara butonu
    search_btn = ctk.CTkButton(
        search_frame,
        text="üîç Ara",
        command=perform_search,
        width=100
    )
    search_btn.pack(side="left", padx=5)
    
    # Focus
    search_entry.focus_set()
    
    if activity_logger:
        activity_logger.log_event("GLOBAL_SEARCH", "Global arama a√ßƒ±ldƒ±")

# ---------- TOPLU ƒ∞≈ûLEM FONKSƒ∞YONLARI ----------
def bulk_export_data():
    """T√ºm verileri toplu olarak export eder."""
    try:
        # Kayƒ±t klas√∂r√º se√ß
        folder = filedialog.askdirectory(title="Export Klas√∂r√º Se√ßin")
        if not folder:
            return
        
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        export_count = 0
        
        # Tedarik verileri
        if 'tedarik_verileri' in globals() and tedarik_verileri is not None:
            tedarik_file = os.path.join(folder, f"tedarik_export_{timestamp}.xlsx")
            tedarik_verileri.to_excel(tedarik_file, index=False)
            export_count += 1
        
        # Reklamasyon verileri
        if 'reklamasyon_verileri' in globals() and reklamasyon_verileri is not None:
            reklamasyon_file = os.path.join(folder, f"reklamasyon_export_{timestamp}.xlsx")
            reklamasyon_verileri.to_excel(reklamasyon_file, index=False)
            export_count += 1
        
        # Stok verileri
        if 'stok_verileri' in globals() and stok_verileri is not None:
            stok_file = os.path.join(folder, f"stok_export_{timestamp}.xlsx")
            stok_verileri.to_excel(stok_file, index=False)
            export_count += 1
        
        # Cari bilgiler
        try:
            cari_data = load_cari_bilgiler()
            if cari_data:
                cari_file = os.path.join(folder, f"cari_export_{timestamp}.xlsx")
                df_cari = pd.DataFrame(cari_data)
                df_cari.to_excel(cari_file, index=False)
                export_count += 1
        except:
            pass
        
        if export_count > 0:
            messagebox.showinfo(
                "Ba≈üarƒ±lƒ±",
                f"{export_count} dosya ba≈üarƒ±yla export edildi!\n\nKonum: {folder}"
            )
            if activity_logger:
                activity_logger.log_event("BULK_EXPORT", f"{export_count} dosya export edildi", folder)
        else:
            messagebox.showwarning("Uyarƒ±", "Export edilecek veri bulunamadƒ±!")
    
    except Exception as e:
        messagebox.showerror("Hata", f"Toplu export hatasƒ±: {str(e)}")
        if activity_logger:
            activity_logger.log_error(f"Toplu export hatasƒ±: {str(e)}", "BULK_EXPORT")

def bulk_import_files():
    """√áoklu dosya import eder."""
    try:
        files = filedialog.askopenfilenames(
            title="Import Edilecek Dosyalarƒ± Se√ßin",
            filetypes=[("Excel Files", "*.xlsx *.xls"), ("All Files", "*.*")]
        )
        
        if not files:
            return
        
        success_count = 0
        error_count = 0
        
        progress_window = ctk.CTkToplevel(root)
        progress_window.title("Toplu Import")
        progress_window.geometry("400x150")
        progress_window.transient(root)
        
        progress_label = ctk.CTkLabel(progress_window, text="Dosyalar i≈üleniyor...")
        progress_label.pack(pady=10)
        
        progress_bar = ttk.Progressbar(progress_window, length=300, mode='determinate')
        progress_bar.pack(pady=10)
        
        status_label = ctk.CTkLabel(progress_window, text="")
        status_label.pack(pady=10)
        
        total_files = len(files)
        
        for idx, file in enumerate(files):
            try:
                filename = os.path.basename(file)
                status_label.configure(text=f"ƒ∞≈üleniyor: {filename}")
                progress_bar['value'] = (idx + 1) / total_files * 100
                progress_window.update()
                
                # Dosya tipine g√∂re i≈üle
                df = pd.read_excel(file)
                
                # Basit kontrol - s√ºtun adlarƒ±na bakarak dosya tipini tahmin et
                columns = df.columns.tolist()
                
                if 'Tedarik√ßi Adƒ±' in columns and 'Birim Fiyat' in columns:
                    # Tedarik verisi olabilir
                    global tedarik_verileri
                    if tedarik_verileri is None:
                        tedarik_verileri = df
                    else:
                        tedarik_verileri = pd.concat([tedarik_verileri, df], ignore_index=True)
                    success_count += 1
                
                elif 'Reklamasyon' in ' '.join(columns) or '≈ûikayet' in ' '.join(columns):
                    # Reklamasyon verisi olabilir
                    global reklamasyon_verileri
                    if reklamasyon_verileri is None:
                        reklamasyon_verileri = df
                    else:
                        reklamasyon_verileri = pd.concat([reklamasyon_verileri, df], ignore_index=True)
                    success_count += 1
                
                else:
                    # Genel import
                    success_count += 1
            
            except Exception as e:
                print(f"Dosya import hatasƒ± ({filename}): {str(e)}")
                error_count += 1
        
        progress_window.destroy()
        
        messagebox.showinfo(
            "Toplu Import Tamamlandƒ±",
            f"Ba≈üarƒ±lƒ±: {success_count}\nHatalƒ±: {error_count}\n\nToplam: {total_files} dosya"
        )
        
        if activity_logger:
            activity_logger.log_event("BULK_IMPORT", f"{success_count} dosya import edildi")
    
    except Exception as e:
        messagebox.showerror("Hata", f"Toplu import hatasƒ±: {str(e)}")
        if activity_logger:
            activity_logger.log_error(f"Toplu import hatasƒ±: {str(e)}", "BULK_IMPORT")

# ---------- KARKALIK MOD FONKSƒ∞YONLARI ----------
# Dark mode zaten ctk.set_appearance_mode("dark") ile ayarlanmƒ±≈ü
# Ek toggle fonksiyonu
current_theme = "dark"

def toggle_dark_mode():
    """Karanlƒ±k/Aydƒ±nlƒ±k mod arasƒ±nda ge√ßi≈ü yapar."""
    global current_theme
    
    if current_theme == "dark":
        ctk.set_appearance_mode("light")
        current_theme = "light"
        theme_text = "Aydƒ±nlƒ±k Mod"
    else:
        ctk.set_appearance_mode("dark")
        current_theme = "dark"
        theme_text = "Karanlƒ±k Mod"
    
    # Ayarlarƒ± kaydet
    settings = load_settings_dict()
    settings['theme'] = current_theme
    save_settings_dict(settings)
    
    messagebox.showinfo("Tema Deƒüi≈ütirildi", f"{theme_text} aktif edildi!")
    
    if activity_logger:
        activity_logger.log_event("THEME_CHANGE", f"Tema deƒüi≈ütirildi: {current_theme}")

def load_settings_dict():
    """Ayarlarƒ± dict olarak y√ºkler."""
    try:
        if os.path.exists(SETTINGS_FILE):
            with open(SETTINGS_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
    except:
        pass
    return {}

def save_settings_dict(settings):
    """Ayarlarƒ± dict olarak kaydeder."""
    try:
        with open(SETTINGS_FILE, 'w', encoding='utf-8') as f:
            json.dump(settings, f, indent=2, ensure_ascii=False)
    except Exception as e:
        print(f"Ayar kaydetme hatasƒ±: {str(e)}")

# ---------- VERƒ∞ DOƒûRULAMA FONKSƒ∞YONLARI ----------
def validate_email(email):
    """Email formatƒ±nƒ± doƒürular."""
    import re
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return re.match(pattern, email) is not None

def validate_phone(phone):
    """Telefon numarasƒ± formatƒ±nƒ± doƒürular."""
    import re
    # T√ºrkiye telefon formatlarƒ±: 05xx xxx xx xx veya +90 5xx xxx xx xx
    phone = re.sub(r'[\s\-\(\)]', '', phone)  # Bo≈üluk ve √∂zel karakterleri temizle
    pattern = r'^(\+90|0)?5\d{9}$'
    return re.match(pattern, phone) is not None

def validate_date(date_str, date_format="%Y-%m-%d"):
    """Tarih formatƒ±nƒ± doƒürular."""
    try:
        datetime.datetime.strptime(date_str, date_format)
        return True
    except:
        return False

def validate_required_fields(data_dict, required_fields):
    """
    Zorunlu alanlarƒ± kontrol eder.
    
    Args:
        data_dict: Kontrol edilecek veri dictionary
        required_fields: Zorunlu alan listesi
    
    Returns:
        tuple: (is_valid, error_message)
    """
    missing_fields = []
    
    for field in required_fields:
        if field not in data_dict or not data_dict[field] or str(data_dict[field]).strip() == '':
            missing_fields.append(field)
    
    if missing_fields:
        return False, f"Zorunlu alanlar eksik: {', '.join(missing_fields)}"
    
    return True, ""

def validate_supplier_data(data):
    """
    Tedarik√ßi verilerini doƒürular.
    
    Args:
        data: Tedarik√ßi veri dictionary
    
    Returns:
        tuple: (is_valid, errors_list)
    """
    errors = []
    
    # Zorunlu alanlar
    required_fields = ['Tedarik√ßi Adƒ±']
    is_valid, error_msg = validate_required_fields(data, required_fields)
    if not is_valid:
        errors.append(error_msg)
    
    # Email kontrol√º
    if 'Mail' in data and data['Mail']:
        if not validate_email(str(data['Mail'])):
            errors.append(f"Ge√ßersiz email formatƒ±: {data['Mail']}")
    
    # Telefon kontrol√º
    if 'Telefon' in data and data['Telefon']:
        if not validate_phone(str(data['Telefon'])):
            errors.append(f"Ge√ßersiz telefon formatƒ±: {data['Telefon']}")
    
    # Tarih kontrol√º
    date_fields = ['S√∂zle≈üme Biti≈ü Tarihi', 'Sertifika Biti≈ü Tarihi', 'Ba≈ülangƒ±√ß Tarihi', 'Biti≈ü Tarihi']
    for field in date_fields:
        if field in data and data[field] and not isinstance(data[field], datetime.datetime):
            # String ise kontrol et
            if isinstance(data[field], str) and not validate_date(data[field]):
                errors.append(f"Ge√ßersiz tarih formatƒ± ({field}): {data[field]}")
    
    return len(errors) == 0, errors

# ---------- UNDO/REDO FONKSƒ∞YONALƒ∞TESƒ∞ ----------
undo_stack = []
redo_stack = []
MAX_UNDO_STACK = 50

def save_state_for_undo(state_name, data):
    """
    Mevcut durumu undo stack'e kaydeder.
    
    Args:
        state_name: Durum a√ßƒ±klamasƒ±
        data: Kaydedilecek veri (deep copy yapƒ±lacak)
    """
    global undo_stack, redo_stack
    
    try:
        import copy
        state = {
            'name': state_name,
            'data': copy.deepcopy(data),
            'timestamp': datetime.datetime.now()
        }
        
        undo_stack.append(state)
        
        # Stack boyutunu sƒ±nƒ±rla
        if len(undo_stack) > MAX_UNDO_STACK:
            undo_stack.pop(0)
        
        # Yeni i≈ülem yapƒ±ldƒ±ƒüƒ±nda redo stack'i temizle
        redo_stack.clear()
        
    except Exception as e:
        print(f"Undo state kaydetme hatasƒ±: {str(e)}")

def undo_last_action():
    """Son i≈ülemi geri alƒ±r."""
    global undo_stack, redo_stack
    
    if not undo_stack:
        messagebox.showinfo("Undo", "Geri alƒ±nacak i≈ülem yok!")
        return None
    
    try:
        # Son durumu al
        state = undo_stack.pop()
        
        # Redo i√ßin kaydet
        redo_stack.append(state)
        
        messagebox.showinfo("Undo", f"ƒ∞≈ülem geri alƒ±ndƒ±: {state['name']}")
        
        if activity_logger:
            activity_logger.log_event("UNDO", f"Geri alƒ±ndƒ±: {state['name']}")
        
        return state['data']
    
    except Exception as e:
        messagebox.showerror("Hata", f"Undo hatasƒ±: {str(e)}")
        return None

def redo_last_action():
    """Geri alƒ±nan son i≈ülemi tekrar yapar."""
    global undo_stack, redo_stack
    
    if not redo_stack:
        messagebox.showinfo("Redo", "Tekrar yapƒ±lacak i≈ülem yok!")
        return None
    
    try:
        # Son redo durumunu al
        state = redo_stack.pop()
        
        # Undo'ya geri ekle
        undo_stack.append(state)
        
        messagebox.showinfo("Redo", f"ƒ∞≈ülem tekrar yapƒ±ldƒ±: {state['name']}")
        
        if activity_logger:
            activity_logger.log_event("REDO", f"Tekrar yapƒ±ldƒ±: {state['name']}")
        
        return state['data']
    
    except Exception as e:
        messagebox.showerror("Hata", f"Redo hatasƒ±: {str(e)}")
        return None

# ---------- HIZLI ERƒ∞≈ûƒ∞M FONKSƒ∞YONLARI ----------
recent_items = []
MAX_RECENT_ITEMS = 10

def add_to_recent_items(item_type, item_name, item_data=None):
    """Son kullanƒ±lan √∂ƒüelere ekler."""
    global recent_items
    
    item = {
        'type': item_type,
        'name': item_name,
        'data': item_data,
        'timestamp': datetime.datetime.now()
    }
    
    # Aynƒ± √∂ƒüe varsa kaldƒ±r
    recent_items = [i for i in recent_items if not (i['type'] == item_type and i['name'] == item_name)]
    
    # Ba≈üa ekle
    recent_items.insert(0, item)
    
    # Boyut kontrol√º
    if len(recent_items) > MAX_RECENT_ITEMS:
        recent_items = recent_items[:MAX_RECENT_ITEMS]

def show_recent_items_menu():
    """Son kullanƒ±lan √∂ƒüeleri g√∂sterir."""
    if not recent_items:
        messagebox.showinfo("Son Kullanƒ±lanlar", "Hen√ºz son kullanƒ±lan √∂ƒüe yok!")
        return
    
    recent_window = ctk.CTkToplevel(root)
    recent_window.title("üìã Son Kullanƒ±lanlar")
    recent_window.geometry("600x400")
    recent_window.transient(root)
    
    # Liste
    listbox_frame = ctk.CTkFrame(recent_window)
    listbox_frame.pack(fill="both", expand=True, padx=10, pady=10)
    
    # Treeview
    tree_scroll = ttk.Scrollbar(listbox_frame)
    tree_scroll.pack(side="right", fill="y")
    
    recent_tree = ttk.Treeview(
        listbox_frame,
        columns=("T√ºr", "Ad", "Zaman"),
        show="headings",
        yscrollcommand=tree_scroll.set
    )
    recent_tree.pack(fill="both", expand=True)
    tree_scroll.config(command=recent_tree.yview)
    
    recent_tree.heading("T√ºr", text="T√ºr")
    recent_tree.heading("Ad", text="Ad")
    recent_tree.heading("Zaman", text="Zaman")
    
    recent_tree.column("T√ºr", width=100)
    recent_tree.column("Ad", width=300)
    recent_tree.column("Zaman", width=150)
    
    for item in recent_items:
        time_str = item['timestamp'].strftime("%Y-%m-%d %H:%M")
        recent_tree.insert("", "end", values=(item['type'], item['name'], time_str))
    
    # Kapat butonu
    close_btn = ctk.CTkButton(recent_window, text="Kapat", command=recent_window.destroy)
    close_btn.pack(pady=10)

# ---------- MYSQL BAƒûLANTI FONKSƒ∞YONLARI ----------
def create_mysql_connection():
    """
    MySQL baƒülantƒ±sƒ± olu≈üturur.
    
    Returns:
        connection: MySQL baƒülantƒ± nesnesi veya None
    """
    if not MYSQL_AVAILABLE:
        messagebox.showerror("Hata", "MySQL Connector k√ºt√ºphanesi y√ºkl√º deƒüil.\nL√ºtfen 'pip install mysql-connector-python' komutunu √ßalƒ±≈ütƒ±rƒ±n.")
        return None
    
    # Yapƒ±landƒ±rma kontrol√º
    if not all([MYSQL_CONFIG.get("host"), MYSQL_CONFIG.get("user"), MYSQL_CONFIG.get("database")]):
        messagebox.showerror("Hata", "MySQL baƒülantƒ± bilgileri eksik!\n\nL√ºtfen kodda MYSQL_CONFIG deƒüerlerini doldurun:\n- host\n- user\n- password\n- database")
        return None
    
    try:
        connection = mysql.connector.connect(
            host=MYSQL_CONFIG["host"],
            user=MYSQL_CONFIG["user"],
            password=MYSQL_CONFIG["password"],
            database=MYSQL_CONFIG["database"],
            raise_on_warnings=MYSQL_CONFIG.get("raise_on_warnings", True)
        )
        
        if connection.is_connected():
            if activity_logger:
                activity_logger.log_event("MYSQL_CONNECT", f"Ba≈üarƒ±yla baƒülandƒ±: {MYSQL_CONFIG['database']}", "MySQL")
            return connection
    except mysql.connector.Error as err:
        error_msg = f"MySQL baƒülantƒ± hatasƒ±: {err}"
        messagebox.showerror("MySQL Hatasƒ±", error_msg)
        if activity_logger:
            activity_logger.log_error(error_msg, "MySQL")
        return None

def load_data_from_mysql(query=None, table_name=None):
    """
    MySQL veritabanƒ±ndan veri y√ºkler ve pandas DataFrame d√∂nd√ºr√ºr.
    
    Args:
        query: SQL sorgusu (opsiyonel)
        table_name: Tablo adƒ± (query yoksa kullanƒ±lƒ±r)
    
    Returns:
        pd.DataFrame: Y√ºklenen veri veya None
    """
    connection = create_mysql_connection()
    if not connection:
        return None
    
    try:
        # Sorgu olu≈ütur
        if query is None:
            if table_name is None:
                messagebox.showerror("Hata", "SQL sorgusu veya tablo adƒ± belirtilmeli!")
                return None
            query = f"SELECT * FROM {table_name}"
        
        # Veriyi oku
        df = pd.read_sql(query, connection)
        
        # LOG: Veri y√ºklendi
        if activity_logger:
            activity_logger.log_data_load(f"MySQL: {table_name or 'Custom Query'}", len(df), "MySQL")
        
        messagebox.showinfo("Ba≈üarƒ±lƒ±", f"MySQL'den {len(df)} kayƒ±t y√ºklendi!")
        return df
        
    except mysql.connector.Error as err:
        error_msg = f"MySQL veri okuma hatasƒ±: {err}"
        messagebox.showerror("MySQL Hatasƒ±", error_msg)
        if activity_logger:
            activity_logger.log_error(error_msg, "MySQL")
        return None
    except Exception as e:
        error_msg = f"Veri i≈üleme hatasƒ±: {str(e)}"
        messagebox.showerror("Hata", error_msg)
        if activity_logger:
            activity_logger.log_error(error_msg, "MySQL")
        return None
    finally:
        if connection and connection.is_connected():
            connection.close()
            if activity_logger:
                activity_logger.log_event("MYSQL_DISCONNECT", "Baƒülantƒ± kapatƒ±ldƒ±", "MySQL")

def apply_column_mappings(df, data_type):
    """
    SQL sorgusundan gelen kolon isimlerini uygulama beklentilerine g√∂re e≈üle≈ütirir.
    
    Args:
        df: pandas DataFrame - MySQL'den y√ºklenen veri
        data_type: str - Veri tipi ("tedarik_analiz", "reklamasyon", "stok")
    
    Returns:
        pd.DataFrame: Kolon isimleri e≈üle≈ütirilmi≈ü DataFrame
    """
    if data_type not in MYSQL_COLUMN_MAPPINGS:
        return df
    
    mappings = MYSQL_COLUMN_MAPPINGS[data_type]
    if not mappings:
        return df
    
    # Kolon isimlerini e≈üle≈ütir
    rename_dict = {}
    for sql_col, target_col in mappings.items():
        if sql_col in df.columns:
            rename_dict[sql_col] = target_col
    
    if rename_dict:
        df = df.rename(columns=rename_dict)
        if activity_logger:
            activity_logger.log_event("COLUMN_MAPPING", 
                                     f"{data_type}: {len(rename_dict)} kolon e≈üle≈ütirildi", 
                                     "MySQL")
    
    return df

def mysql_query_dialog():
    """
    MySQL sorgu penceresi a√ßar ve kullanƒ±cƒ±dan sorgu veya tablo adƒ± alƒ±r.
    """
    if not MYSQL_AVAILABLE:
        messagebox.showerror("Hata", "MySQL Connector k√ºt√ºphanesi y√ºkl√º deƒüil!\nL√ºtfen 'pip install mysql-connector-python' komutunu √ßalƒ±≈ütƒ±rƒ±n.")
        return
    
    # Sorgu penceresi olu≈ütur
    query_window = tk.Toplevel()
    query_window.title("MySQL'den Veri Y√ºkle")
    query_window.geometry("600x400")
    
    # Ba≈ülƒ±k
    tk.Label(query_window, text="üóÑÔ∏è MySQL Veritabanƒ±ndan Veri Y√ºkleme", font=("Segoe UI", 14, "bold")).pack(pady=10)
    
    # Baƒülantƒ± durumu
    config_frame = tk.Frame(query_window, bg="#e8f5e9", padx=10, pady=10)
    config_frame.pack(fill="x", padx=20, pady=5)
    
    config_status = f"üîß Yapƒ±landƒ±rma:\nHost: {MYSQL_CONFIG['host'] or '‚ùå Bo≈ü'}\nDatabase: {MYSQL_CONFIG['database'] or '‚ùå Bo≈ü'}\nUser: {MYSQL_CONFIG['user'] or '‚ùå Bo≈ü'}"
    tk.Label(config_frame, text=config_status, bg="#e8f5e9", justify="left", font=("Courier", 9)).pack(anchor="w")
    
    # Se√ßenek 1: Tablo adƒ±
    tk.Label(query_window, text="Se√ßenek 1: Tablo Adƒ±", font=("Segoe UI", 11, "bold")).pack(anchor="w", padx=20, pady=(15,5))
    table_frame = tk.Frame(query_window)
    table_frame.pack(fill="x", padx=20, pady=5)
    
    tk.Label(table_frame, text="Tablo:").pack(side="left", padx=5)
    table_entry = ttk.Entry(table_frame, width=30)
    table_entry.pack(side="left", padx=5)
    table_entry.insert(0, "tedarikci_verileri")
    
    def load_from_table():
        table_name = table_entry.get().strip()
        if not table_name:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen tablo adƒ± girin!")
            return
        
        query_window.destroy()
        
        # Arka planda veri y√ºkle
        def load_thread():
            df = load_data_from_mysql(table_name=table_name)
            if df is not None:
                # Ge√ßici CSV olarak kaydet ve analiz et
                import tempfile
                with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False, encoding='utf-8') as tmp:
                    df.to_csv(tmp.name, index=False)
                    temp_file = tmp.name
                
                global file_paths_global, all_stock_codes
                file_paths_global = [temp_file]
                root.after(0, lambda: set_status(f"MySQL'den {len(df)} kayƒ±t y√ºklendi."))
                
                # Stok kodlarƒ±nƒ± √ßƒ±kar
                try:
                    stok_col_temp = find_stok_kodu_column(df)
                    if stok_col_temp:
                        unique_kodlar = sorted(df[stok_col_temp].dropna().unique())
                        all_stock_codes = ["T√ºm Veri"] + list(unique_kodlar)
                        root.after(0, lambda: stok_kod_combobox.configure(values=all_stock_codes, state="normal"))
                        root.after(0, lambda: stok_kod_combobox.set("T√ºm Veri"))
                except:
                    pass
        
        threading.Thread(target=load_thread, daemon=True).start()
    
    ttk.Button(table_frame, text="üì• Tablodan Y√ºkle", command=load_from_table).pack(side="left", padx=10)
    
    # Se√ßenek 2: √ñzel SQL sorgusu
    tk.Label(query_window, text="Se√ßenek 2: √ñzel SQL Sorgusu", font=("Segoe UI", 11, "bold")).pack(anchor="w", padx=20, pady=(15,5))
    
    query_text = tk.Text(query_window, wrap="word", font=("Courier", 10), height=6)
    query_text.pack(fill="both", expand=True, padx=20, pady=5)
    query_text.insert("1.0", "SELECT * FROM tedarikci_verileri WHERE tarih >= '2024-01-01'")
    
    def load_from_query():
        query = query_text.get("1.0", tk.END).strip()
        if not query:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen SQL sorgusu girin!")
            return
        
        query_window.destroy()
        
        # Arka planda veri y√ºkle
        def load_thread():
            df = load_data_from_mysql(query=query)
            if df is not None:
                # Ge√ßici CSV olarak kaydet ve analiz et
                import tempfile
                with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False, encoding='utf-8') as tmp:
                    df.to_csv(tmp.name, index=False)
                    temp_file = tmp.name
                
                global file_paths_global, all_stock_codes
                file_paths_global = [temp_file]
                root.after(0, lambda: set_status(f"MySQL'den {len(df)} kayƒ±t y√ºklendi."))
                
                # Stok kodlarƒ±nƒ± √ßƒ±kar
                try:
                    stok_col_temp = find_stok_kodu_column(df)
                    if stok_col_temp:
                        unique_kodlar = sorted(df[stok_col_temp].dropna().unique())
                        all_stock_codes = ["T√ºm Veri"] + list(unique_kodlar)
                        root.after(0, lambda: stok_kod_combobox.configure(values=all_stock_codes, state="normal"))
                        root.after(0, lambda: stok_kod_combobox.set("T√ºm Veri"))
                except:
                    pass
        
        threading.Thread(target=load_thread, daemon=True).start()
    
    # Buton √ßubuƒüu
    btn_frame = tk.Frame(query_window)
    btn_frame.pack(fill="x", padx=20, pady=10)
    
    ttk.Button(btn_frame, text="üì• Sorguyu √áalƒ±≈ütƒ±r ve Y√ºkle", command=load_from_query).pack(side="left", padx=5)
    ttk.Button(btn_frame, text="‚ùå ƒ∞ptal", command=query_window.destroy).pack(side="right", padx=5)

def mysql_unified_data_loader():
    """
    Birle≈üik MySQL veri y√ºkleme penceresi - 3 veri tipi i√ßin:
    1. Tedarik Analiz Verileri
    2. Reklamasyon Verileri
    3. Stok Verileri
    """
    if not MYSQL_AVAILABLE:
        messagebox.showerror("Hata", "MySQL Connector k√ºt√ºphanesi y√ºkl√º deƒüil!\nL√ºtfen 'pip install mysql-connector-python' komutunu √ßalƒ±≈ütƒ±rƒ±n.")
        return
    
    # Ana pencere
    main_window = tk.Toplevel()
    main_window.title("MySQL Veri Y√ºkleme Merkezi")
    main_window.geometry("900x700")
    
    # Ba≈ülƒ±k
    header_frame = tk.Frame(main_window, bg="#2c3e50", padx=20, pady=20)
    header_frame.pack(fill="x")
    tk.Label(header_frame, text="üóÑÔ∏è MySQL Veri Y√ºkleme Merkezi", 
             font=("Segoe UI", 16, "bold"), fg="white", bg="#2c3e50").pack()
    tk.Label(header_frame, text="Tedarik Analiz, Reklamasyon ve Stok verilerinizi MySQL'den y√ºkleyin", 
             font=("Segoe UI", 10), fg="#ecf0f1", bg="#2c3e50").pack()
    
    # Baƒülantƒ± durumu
    config_frame = tk.Frame(main_window, bg="#e8f5e9", padx=15, pady=10)
    config_frame.pack(fill="x", padx=20, pady=10)
    
    config_status = f"üîß MySQL Yapƒ±landƒ±rmasƒ±:\n"
    config_status += f"  Host: {MYSQL_CONFIG['host'] or '‚ùå Bo≈ü - L√ºtfen yapƒ±landƒ±rƒ±n'}\n"
    config_status += f"  Database: {MYSQL_CONFIG['database'] or '‚ùå Bo≈ü - L√ºtfen yapƒ±landƒ±rƒ±n'}\n"
    config_status += f"  User: {MYSQL_CONFIG['user'] or '‚ùå Bo≈ü - L√ºtfen yapƒ±landƒ±rƒ±n'}"
    
    tk.Label(config_frame, text=config_status, bg="#e8f5e9", justify="left", 
             font=("Courier", 9)).pack(anchor="w")
    
    # Ana i√ßerik alanƒ± (3 b√∂l√ºm)
    content_frame = tk.Frame(main_window, padx=20, pady=10)
    content_frame.pack(fill="both", expand=True)
    
    # --- B√ñL√úM 1: Tedarik Analiz Verileri ---
    section1 = tk.LabelFrame(content_frame, text="üìä Tedarik Analiz Verileri", 
                             font=("Segoe UI", 11, "bold"), padx=15, pady=10)
    section1.pack(fill="both", expand=True, pady=5)
    
    tk.Label(section1, text="SQL Sorgusu:").pack(anchor="w")
    tedarik_query = tk.Text(section1, wrap="word", font=("Courier", 9), height=3)
    tedarik_query.pack(fill="x", pady=5)
    tedarik_query.insert("1.0", MYSQL_QUERIES["tedarik_analiz"])
    
    def load_tedarik_data():
        query = tedarik_query.get("1.0", tk.END).strip()
        if not query:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen SQL sorgusu girin!")
            return
        
        main_window.destroy()
        
        def load_thread():
            df = load_data_from_mysql(query=query)
            if df is not None:
                # Kolon e≈üle≈ütirmesi uygula
                df = apply_column_mappings(df, "tedarik_analiz")
                
                import tempfile
                with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False, encoding='utf-8') as tmp:
                    df.to_csv(tmp.name, index=False)
                    temp_file = tmp.name
                
                global file_paths_global, all_stock_codes
                file_paths_global = [temp_file]
                root.after(0, lambda: set_status(f"Tedarik Analiz: MySQL'den {len(df)} kayƒ±t y√ºklendi."))
                
                try:
                    stok_col_temp = find_stok_kodu_column(df)
                    if stok_col_temp:
                        unique_kodlar = sorted(df[stok_col_temp].dropna().unique())
                        all_stock_codes = ["T√ºm Veri"] + list(unique_kodlar)
                        root.after(0, lambda: stok_kod_combobox.configure(values=all_stock_codes, state="normal"))
                        root.after(0, lambda: stok_kod_combobox.set("T√ºm Veri"))
                except:
                    pass
                
                root.after(0, lambda: messagebox.showinfo("Ba≈üarƒ±lƒ±", "Tedarik analiz verileri y√ºklendi!\n≈ûimdi 'ANALƒ∞Zƒ∞ BA≈ûLAT' butonuna tƒ±klayabilirsiniz."))
        
        threading.Thread(target=load_thread, daemon=True).start()
    
    ttk.Button(section1, text="üì• Tedarik Analiz Verilerini Getir", 
               command=load_tedarik_data).pack(fill="x", pady=5)
    
    # --- B√ñL√úM 2: Reklamasyon Verileri ---
    section2 = tk.LabelFrame(content_frame, text="üè≠ Reklamasyon Verileri", 
                             font=("Segoe UI", 11, "bold"), padx=15, pady=10)
    section2.pack(fill="both", expand=True, pady=5)
    
    tk.Label(section2, text="SQL Sorgusu:").pack(anchor="w")
    rek_query = tk.Text(section2, wrap="word", font=("Courier", 9), height=3)
    rek_query.pack(fill="x", pady=5)
    rek_query.insert("1.0", MYSQL_QUERIES["reklamasyon"])
    
    def load_reklamasyon_from_mysql():
        query = rek_query.get("1.0", tk.END).strip()
        if not query:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen SQL sorgusu girin!")
            return
        
        main_window.destroy()
        
        def load_thread():
            df = load_data_from_mysql(query=query)
            if df is not None:
                # Kolon e≈üle≈ütirmesi uygula
                df = apply_column_mappings(df, "reklamasyon")
                
                global df_reklamasyon_global
                
                # Reklamasyon verisini i≈üle (mevcut load_reklamasyon_data mantƒ±ƒüƒ±)
                try:
                    def get_islem_tipi(fis_tipi):
                        ft = str(fis_tipi).lower()
                        if '63' in ft or 'iade' in ft: return 'ƒ∞ade'
                        if '52' in ft or 'reklamasyon' in ft: return 'Reklamasyon'
                        return 'Normal Alƒ±m'
                    
                    df['Islem_Tipi'] = df.get('Fi≈ü Tipi', df.columns[0]).apply(get_islem_tipi)
                    
                    # Metrik hesaplamalarƒ±
                    def calculate_metrics(row):
                        tip = row.get('Islem_Tipi', '')
                        miktar = pd.to_numeric(row.get('Miktar', 0), errors='coerce')
                        if pd.isna(miktar): miktar = 0
                        
                        try:
                            birim_fiyat = pd.to_numeric(row.get('Birim Fiyat', 0), errors='coerce')
                            if pd.isna(birim_fiyat): birim_fiyat = 0
                            tutar = miktar * birim_fiyat
                        except:
                            tutar = 0
                        
                        on_time_qty = 0; late_qty = 0; return_qty = 0
                        reklamasyon_tutar = 0; iade_tutar = 0; alim_tutar = 0
                        alim_qty = 0; rek_qty = 0
                        
                        if tip == 'Normal Alƒ±m': on_time_qty = miktar; alim_tutar = tutar; alim_qty = miktar
                        elif tip == 'ƒ∞ade': return_qty = miktar; iade_tutar = tutar
                        elif tip == 'Reklamasyon': reklamasyon_tutar = tutar; rek_qty = miktar
                        
                        return pd.Series([on_time_qty, late_qty, return_qty, reklamasyon_tutar, 
                                        iade_tutar, alim_tutar, alim_qty, rek_qty])
                    
                    df[['On_Time_Miktar', 'Geciken_Miktar', 'Iade_Edilen_Miktar', 
                        'Reklamasyon_Tutari', 'Iade_Tutari', 'Alim_Tutari', 
                        'Alim_Miktar', 'Reklamasyon_Miktar']] = df.apply(calculate_metrics, axis=1)
                    
                    df_reklamasyon_global = df
                    
                    root.after(0, lambda: messagebox.showinfo("Ba≈üarƒ±lƒ±", 
                        f"Reklamasyon verileri y√ºklendi: {len(df)} kayƒ±t\n"
                        "Reklamasyon sayfalarƒ±nƒ± g√∂r√ºnt√ºleyebilirsiniz."))
                    root.after(0, lambda: show_page("Rek Y√∂netici √ñzeti"))
                    
                except Exception as e:
                    root.after(0, lambda: messagebox.showerror("Hata", 
                        f"Reklamasyon verisi i≈ülenirken hata:\n{str(e)}"))
        
        threading.Thread(target=load_thread, daemon=True).start()
    
    ttk.Button(section2, text="üì• Reklamasyon Verilerini Getir", 
               command=load_reklamasyon_from_mysql).pack(fill="x", pady=5)
    
    # --- B√ñL√úM 3: Stok Verileri ---
    section3 = tk.LabelFrame(content_frame, text="üì¶ Stok Verileri", 
                             font=("Segoe UI", 11, "bold"), padx=15, pady=10)
    section3.pack(fill="both", expand=True, pady=5)
    
    tk.Label(section3, text="SQL Sorgusu:").pack(anchor="w")
    stok_query = tk.Text(section3, wrap="word", font=("Courier", 9), height=3)
    stok_query.pack(fill="x", pady=5)
    stok_query.insert("1.0", MYSQL_QUERIES["stok"])
    
    def load_stok_from_mysql():
        query = stok_query.get("1.0", tk.END).strip()
        if not query:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen SQL sorgusu girin!")
            return
        
        main_window.destroy()
        
        def load_thread():
            df = load_data_from_mysql(query=query)
            if df is not None:
                # Kolon e≈üle≈ütirmesi uygula
                df = apply_column_mappings(df, "stok")
                
                global df_stok_global
                df_stok_global = df
                
                root.after(0, lambda: messagebox.showinfo("Ba≈üarƒ±lƒ±", 
                    f"Stok verileri y√ºklendi: {len(df)} kayƒ±t\n"
                    "Stok Y√∂netimi sayfasƒ±nƒ± g√∂r√ºnt√ºleyebilirsiniz."))
                root.after(0, lambda: show_page("Stok Y√∂netimi"))
        
        threading.Thread(target=load_thread, daemon=True).start()
    
    ttk.Button(section3, text="üì• Stok Verilerini Getir", 
               command=load_stok_from_mysql).pack(fill="x", pady=5)
    
    # Alt bilgi
    info_frame = tk.Frame(main_window, bg="#ecf0f1", padx=15, pady=10)
    info_frame.pack(fill="x")
    tk.Label(info_frame, text="üí° ƒ∞pucu: SQL sorgularƒ±nƒ± dilediƒüiniz gibi √∂zelle≈ütirebilirsiniz. "
             "Varsayƒ±lan sorgular MYSQL_QUERIES dictionary'sinde tanƒ±mlƒ±dƒ±r.",
             font=("Segoe UI", 9), bg="#ecf0f1", wraplength=850, justify="left").pack()
    
    # Kapatma butonu
    ttk.Button(main_window, text="‚ùå Kapat", command=main_window.destroy).pack(pady=10)

# ---------- TICKER (KAYAN BANT) FONKSƒ∞YONLARI ----------
def fetch_tcmb_currency():
    """TCMB XML API'den g√ºncel d√∂viz kurlarƒ±nƒ± √ßeker."""
    try:
        url = "https://www.tcmb.gov.tr/kurlar/today.xml"
        response = requests.get(url, timeout=5)
        if response.status_code == 200:
            root_xml = ET.fromstring(response.content)
            
            usd_rate = None
            eur_rate = None
            
            for currency in root_xml.findall('Currency'):
                code = currency.get('CurrencyCode')
                if code == 'USD':
                    forex_buying = currency.find('ForexBuying')
                    if forex_buying is not None and forex_buying.text:
                        usd_rate = float(forex_buying.text)
                elif code == 'EUR':
                    forex_buying = currency.find('ForexBuying')
                    if forex_buying is not None and forex_buying.text:
                        eur_rate = float(forex_buying.text)
            
            return usd_rate, eur_rate
    except Exception as e:
        print(f"TCMB veri √ßekme hatasƒ±: {e}")
        return None, None

def fetch_yahoo_finance_data(symbol):
    """Yahoo Finance'den veri √ßeker."""
    url = f"https://query1.finance.yahoo.com/v8/finance/chart/{symbol}?interval=1m&range=1d"
    headers = {'User-Agent': 'Mozilla/5.0'}
    try:
        response = requests.get(url, headers=headers, timeout=5)
        if response.status_code == 200:
            data = response.json()
            price = data['chart']['result'][0]['meta']['regularMarketPrice']
            prev_close = data['chart']['result'][0]['meta']['chartPreviousClose']
            return price, prev_close
    except:
        return None, None

def update_market_ticker():
    """Piyasa verilerini g√ºnceller (Ger√ßek Veri - TCMB + Yahoo Finance)."""
    
    # Thread i√ßinde √ßalƒ±≈ütƒ±r ki aray√ºz donmasƒ±n
    def _fetch():
        # TCMB'den d√∂viz kurlarƒ±
        usd_now, eur_now = fetch_tcmb_currency()
        
        # Yahoo Finance'den Brent petrol
        brent_now, brent_prev = fetch_yahoo_finance_data("BZ=F")
        
        # Fallback deƒüerler - TCMB ba≈üarƒ±sƒ±z olursa Yahoo Finance dene
        if usd_now is None or eur_now is None:
            usd_yf, usd_prev = fetch_yahoo_finance_data("USDTRY=X")
            eur_yf, eur_prev = fetch_yahoo_finance_data("EURTRY=X")
            if usd_now is None: usd_now, usd_prev = usd_yf if usd_yf else 36.50, 36.40
            else: usd_prev = usd_now * 0.998  # Yakla≈üƒ±k √∂nceki deƒüer
            if eur_now is None: eur_now, eur_prev = eur_yf if eur_yf else 38.20, 38.10
            else: eur_prev = eur_now * 0.998
        else:
            # TCMB ba≈üarƒ±lƒ±, √∂nceki deƒüerleri tahmin et
            usd_prev = usd_now * 0.998
            eur_prev = eur_now * 0.998
        
        if brent_now is None: brent_now, brent_prev = 78.40, 78.00
        
        # Aray√ºz g√ºncelleme
        root.after(0, lambda: _update_label(usd_now, usd_prev, eur_now, eur_prev, brent_now, brent_prev))

    def _update_label(usd, usd_p, eur, eur_p, brent, brent_p):
        usd_icon = "üîº" if usd >= usd_p else "üîΩ"
        eur_icon = "üîº" if eur >= eur_p else "üîΩ"
        brent_icon = "üîº" if brent >= brent_p else "üîΩ"
        
        # Hammadde fiyatlarƒ±nƒ± ekle (commodity_prices_global'den)
        cotton_price = "94.20"
        polyester_price = "1,350"
        viscose_price = "2,100"
        cotton_icon = "‚ûñ"
        polyester_icon = "‚ûñ"
        viscose_icon = "‚ûñ"
        
        if commodity_prices_global:
            if 'Pamuk (Cotlook A Index)' in commodity_prices_global:
                cotton_data = commodity_prices_global['Pamuk (Cotlook A Index)']
                cotton_price = f"{cotton_data['current']:.2f}"
                cotton_icon = "üîº" if cotton_data['change'] >= 0 else "üîΩ"
            if 'Polyester' in commodity_prices_global:
                poly_data = commodity_prices_global['Polyester']
                polyester_price = f"{poly_data['current']:,.0f}"
                polyester_icon = "üîº" if poly_data['change'] >= 0 else "üîΩ"
            if 'Viskon' in commodity_prices_global:
                vis_data = commodity_prices_global['Viskon']
                viscose_price = f"{vis_data['current']:,.0f}"
                viscose_icon = "üîº" if vis_data['change'] >= 0 else "üîΩ"
        
        ticker_text = f"  üíµ USD/TL: {usd:.4f} {usd_icon}   |   üí∂ EUR/TL: {eur:.4f} {eur_icon}   |   üõ¢Ô∏è BRENT: ${brent:.2f} {brent_icon}   |   üè≠ PAMUK: ${cotton_price} {cotton_icon}   |   üßµ POLYESTER: ${polyester_price}/ton {polyester_icon}   |   üéÄ Vƒ∞SKON: ${viscose_price}/ton {viscose_icon}   |   üö¢ BALTIC DRY: 1,450 üîº  "
        if ticker_label:
            ticker_label.configure(text=ticker_text)
    
    threading.Thread(target=_fetch, daemon=True).start()
    
    # 60 saniyede bir g√ºncelle
    root.after(60000, update_market_ticker)

def scroll_ticker_animation():
    """Metni kaydƒ±rarak ticker efekti verir."""
    if not ticker_label: return
    text = ticker_label.cget("text")
    # ƒ∞lk karakteri sona al
    new_text = text[1:] + text[0]
    ticker_label.configure(text=new_text)
    # Hƒ±z ayarƒ± (ms)
    root.after(200, scroll_ticker_animation)

# ---------- HABERLER (RSS) FONKSƒ∞YONLARI ----------
def init_news_tab():
    """Sekt√∂rel haberler sekmesini olu≈üturur."""
    for widget in frame_haberler.winfo_children(): widget.destroy()
    
    # Ba≈ülƒ±k
    header = tk.Frame(frame_haberler, bg="white", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="üì∞ Sekt√∂rel Haber Merkezi", font=("Segoe UI", 18, "bold"), fg="#2c3e50", bg="white").pack(anchor="w")
    tk.Label(header, text="Tekstil, Hammadde, Hazƒ±r Giyim ve Ekonomi D√ºnyasƒ±ndan Son Ba≈ülƒ±klar", font=("Segoe UI", 10), fg="gray", bg="white").pack(anchor="w")
    
    # Haber Konteyneri
    news_container = tk.Frame(frame_haberler, bg="#ecf0f1")
    news_container.pack(fill="both", expand=True, padx=20, pady=10)
    
    # Canvas ve Scrollbar (Haberleri kaydƒ±rmak i√ßin)
    canvas = tk.Canvas(news_container, bg="#ecf0f1", highlightthickness=0)
    scrollbar = ttk.Scrollbar(news_container, orient="vertical", command=canvas.yview)
    scrollable_frame = tk.Frame(canvas, bg="#ecf0f1")

    scrollable_frame.bind(
        "<Configure>",
        lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
    )

    canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
    canvas.configure(yscrollcommand=scrollbar.set)

    canvas.pack(side="left", fill="both", expand=True)
    scrollbar.pack(side="right", fill="y")
    
    # Haberleri √áekme Butonu
    btn_frame = tk.Frame(frame_haberler, bg="#ecf0f1")
    btn_frame.pack(fill="x", padx=20, pady=5)
    ttk.Button(btn_frame, text="üîÑ Haberleri Yenile", command=lambda: fetch_and_display_news(scrollable_frame)).pack(anchor="e")
    
    # ƒ∞lk y√ºkleme
    fetch_and_display_news(scrollable_frame)

def fetch_and_display_news(parent_frame):
    """
    Google News RSS'den verileri √ßeker.
    √ñzellikler:
    1. Threading: Aray√ºz√º dondurmaz.
    2. User-Agent Header: Google'ƒ±n bot korumasƒ±nƒ± a≈üar.
    3. Error Handling: Baƒülantƒ± hatalarƒ±nƒ± y√∂netir.
    """
    # √ñnceki i√ßeriƒüi temizle
    for widget in parent_frame.winfo_children(): widget.destroy()
    
    # Y√ºkleniyor mesajƒ± (Kullanƒ±cƒ± i≈ülem yapƒ±ldƒ±ƒüƒ±nƒ± g√∂rs√ºn)
    loading = tk.Label(parent_frame, text="Haberler alƒ±nƒ±yor... L√ºtfen bekleyin.", 
                      font=("Segoe UI", 12, "italic"), fg="gray", bg="#ecf0f1")
    loading.pack(pady=20)
    
    # Aray√ºz√º zorla g√ºncelle (Mesajƒ±n hemen g√∂r√ºnmesi i√ßin)
    parent_frame.update()
    
    # --- ARKA PLAN ƒ∞≈û√áƒ∞Sƒ∞ (Thread) ---
    def _bg_task():
        # Google'ƒ±n bizi "Python Script" deƒüil "Chrome Tarayƒ±cƒ±sƒ±" sanmasƒ± i√ßin Header
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        }
        
        # Tekstil ve ekonomi odaklƒ± RSS adresi
        rss_url = "https://news.google.com/rss/search?q=tekstil+OR+hazƒ±r+giyim+OR+kuma≈ü+OR+konfeksiyon+OR+iplik+when:7d&hl=tr&gl=TR&ceid=TR:tr"
        
        try:
            # timeout=10: 10 saniye cevap gelmezse i≈ülemi iptal et (Sonsuz donmayƒ± √∂nler)
            response = requests.get(rss_url, headers=headers, timeout=10)
            
            if response.status_code == 200:
                # Veri ba≈üarƒ±yla geldi, ham XML i√ßeriƒüini al
                xml_content = response.content
                # Aray√ºz g√ºncellemesi i√ßin Ana Thread'e sinyal g√∂nder
                root.after(0, lambda: _update_ui_success(xml_content))
            else:
                # HTTP Hatasƒ± (404, 429, 500 vb.)
                error_msg = f"HTTP Hatasƒ±: {response.status_code}"
                root.after(0, lambda: _update_ui_error(error_msg))
                activity_logger.log_error(f"News RSS HTTP {response.status_code}", "Sekt√∂r Haberleri")
                
        except Exception as e:
            # Baƒülantƒ± Hatasƒ± (Network, Timeout vb.)
            error_msg = f"Baƒülantƒ± Hatasƒ±: {str(e)}"
            root.after(0, lambda: _update_ui_error(error_msg))
            activity_logger.log_error(f"News RSS hatasƒ±: {str(e)}", "Sekt√∂r Haberleri")

    # --- ARAY√úZ G√úNCELLEME (Ba≈üarƒ±lƒ±) ---
    def _update_ui_success(xml_data):
        try:
            loading.destroy()
            root_xml = ET.fromstring(xml_data)
            count = 0
            
            # Haber bulunamadƒ± kontrol√º
            items = root_xml.findall('./channel/item')
            if not items:
                no_news = tk.Label(parent_frame, text="Haber bulunamadƒ±. L√ºtfen daha sonra tekrar deneyin.", 
                                  font=("Segoe UI", 12), fg="gray", bg="#ecf0f1")
                no_news.pack(pady=20)
                return
            
            for item in items:
                if count > 15: break # Max 15 haber
                
                title = item.find('title').text
                link = item.find('link').text
                pubDate = item.find('pubDate').text
                
                # Haber Kartƒ±
                card = tk.Frame(parent_frame, bg="white", bd=1, relief="solid", padx=15, pady=10)
                card.pack(fill="x", pady=5, padx=5)
                
                # Ba≈ülƒ±k (Linkli)
                lbl_title = tk.Label(card, text=title, font=("Segoe UI", 11, "bold"), fg="#2980b9", bg="white", cursor="hand2", wraplength=900, justify="left")
                lbl_title.pack(anchor="w")
                lbl_title.bind("<Button-1>", lambda e, url=link: webbrowser.open_new(url))
                
                # Tarih
                tk.Label(card, text=f"üìÖ {pubDate}", font=("Arial", 9), fg="gray", bg="white").pack(anchor="w")
                
                count += 1
        except Exception as e:
            # XML parse hatasƒ±
            _update_ui_error(f"XML Parse Hatasƒ±: {str(e)[:50]}...")
            activity_logger.log_error(f"News XML parse hatasƒ±: {str(e)}", "Sekt√∂r Haberleri")
    
    # --- ARAY√úZ G√úNCELLEME (Hata) ---
    def _update_ui_error(error_message):
        """Hata mesajƒ±nƒ± ekranda g√∂ster"""
        loading.configure(
            text=f"‚ùå {error_message}\n\nüí° ƒ∞pucu: VPN kullanmayƒ± deneyin veya biraz bekleyip tekrar deneyin.",
            fg="red",
            font=("Segoe UI", 10),
            wraplength=700,
            justify="center"
        )
    
    # Thread'i ba≈ülat (daemon=True: ana program kapanƒ±nca otomatik sonlanƒ±r)
    threading.Thread(target=_bg_task, daemon=True).start()

# ---------- TREND AVCISI (TREND HUNTER) FONKSƒ∞YONLARI ----------
def init_trend_hunter_tab():
    """Dijital ƒ∞kiz & Trend Avcƒ±sƒ± Sekmesi"""
    global frame_trend_hunter
    
    # Mevcut widgetlarƒ± temizle
    for widget in frame_trend_hunter.winfo_children(): widget.destroy()

    # --- Ba≈ülƒ±k ---
    header = tk.Frame(frame_trend_hunter, bg="#8e44ad", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="üîÆ Trend Avcƒ±sƒ± & Dijital ƒ∞kiz", font=("Segoe UI", 18, "bold"), fg="white", bg="#8e44ad").pack(side="left")
    tk.Label(header, text="Sosyal Medya ve Arama Motoru Sinyalleri ile Erken Uyarƒ± Sistemi", font=("Segoe UI", 10), fg="#f3e5f5", bg="#8e44ad").pack(side="left", padx=10)

    # --- Ana ƒ∞√ßerik ---
    content = tk.PanedWindow(frame_trend_hunter, orient=tk.HORIZONTAL)
    content.pack(fill="both", expand=True, pady=10)

    # 1. SOL PANEL: Veri Giri≈üi ve Kontrol
    left_panel = tk.Frame(content, bg="white", padx=10, pady=10)
    content.add(left_panel, width=400)

    tk.Label(left_panel, text="üì° Sinyal Takip Parametreleri", font=("Segoe UI", 12, "bold"), fg="#2c3e50", bg="white").pack(anchor="w", pady=10)
    
    tk.Label(left_panel, text="Takip Edilecek Anahtar Kelimeler (Virg√ºlle ayƒ±rƒ±n):", bg="white").pack(anchor="w")
    keywords_entry = ttk.Entry(left_panel, width=40)
    keywords_entry.insert(0, "Oversize G√∂mlek, Lila Elbise, Keten Pantolon")
    keywords_entry.pack(fill="x", pady=5)

    tk.Label(left_panel, text="B√∂lge / Platform:", bg="white").pack(anchor="w", pady=(10,0))
    platform_combo = ttk.Combobox(left_panel, values=["Google Arama (TR)", "Google Arama (Global)", "Instagram (Sim√ºlasyon)", "TikTok (Sim√ºlasyon)"], state="readonly")
    platform_combo.set("Google Arama (TR)")
    platform_combo.pack(fill="x", pady=5)

    # -- Sim√ºlasyon Alanƒ± --
    sim_frame = tk.LabelFrame(left_panel, text="‚ö° Senaryo Sim√ºlasyonu", bg="#f3e5f5", fg="#8e44ad", padx=10, pady=10)
    sim_frame.pack(fill="x", pady=20)
    
    tk.Label(sim_frame, text="Pazar ak≈üamƒ± aniden patlayan bir trendi sim√ºle et:", bg="#f3e5f5", wraplength=350).pack(anchor="w")
    
    # Status label tanƒ±mƒ±nƒ± burada yapalƒ±m (closure i√ßin)
    status_lbl = tk.Label(left_panel, text="Hazƒ±r", fg="gray", bg="white")
    
    def simulate_viral_trend():
        """Sim√ºlasyon: Pazar ak≈üamƒ± 'Lila Oversize G√∂mlek' patlƒ±yor"""
        trend_data = {
            "Lila Oversize G√∂mlek": [12, 15, 14, 18, 22, 85, 98], # Son g√ºn patlama
            "Normal G√∂mlek": [45, 46, 44, 45, 47, 48, 46]         # Stabil
        }
        # Son 7 g√ºn√ºn tarihlerini olu≈ütur
        dates = [(datetime.datetime.now() - timedelta(days=i)).strftime("%d.%m") for i in range(6, -1, -1)]
        
        update_trend_chart(dates, trend_data)
        
        # AI Analizini Tetikle
        analyze_trend_with_ai("Lila Oversize G√∂mlek", 98, is_simulation=True)

    ttk.Button(sim_frame, text="üî• 'Lila G√∂mlek' Viral Oldu! (Sim√ºle Et)", command=simulate_viral_trend).pack(fill="x", pady=5)
    
    # -- Ger√ßek Veri Butonu --
    def fetch_real_trends():
        """Google Trends verilerini ARKA PLANDA √ßeker (UI dondurmaz)."""
        if not PYTRENDS_AVAILABLE:
            messagebox.showerror("Hata", "pytrends k√ºt√ºphanesi eksik. L√ºtfen 'pip install pytrends' yapƒ±n.")
            return
            
        keywords = [k.strip() for k in keywords_entry.get().split(",")]
        # Google Trends max 5 kelime kabul eder
        if len(keywords) > 5:
            keywords = keywords[:5]
            messagebox.showinfo("Bilgi", "Google Trends limiti nedeniyle ilk 5 kelime alƒ±ndƒ±.")

        if not keywords: return

        # Y√ºkleniyor durumunu g√∂ster
        status_lbl.configure(text="Google Trends verileri √ßekiliyor... (Arka planda, UI donmaz)")
        left_panel.update()
        
        # --- ARKA PLAN ƒ∞≈û√áƒ∞Sƒ∞ (Thread) ---
        def _background_worker():
            try:
                # Google Trends Baƒülantƒ±sƒ± (Retry & Backoff ile)
                # retries=5: 429 hatasƒ± alƒ±rsa 5 kere yeniden dene
                # backoff_factor=10: Denemeler arasƒ± bekleme s√ºresi (10sn, 20sn, 40sn...)
                # timeout=(10,25): Baƒülantƒ± i√ßin 10sn, veri okuma i√ßin 25sn bekle
                pytrends = TrendReq(
                    hl='tr-TR', 
                    tz=180, 
                    retries=5, 
                    backoff_factor=10, 
                    timeout=(10, 25)
                )
                
                # Anahtar kelimeler i√ßin veri √ßek
                pytrends.build_payload(keywords, cat=0, timeframe='now 7-d', geo='TR', gprop='')
                
                # Google'a nazik ol: Her istekte k√º√ß√ºk bir bekleme ekle
                import time
                time.sleep(2)  # 2 saniye bekle (Bot algƒ±lamasƒ±nƒ± azaltƒ±r)
                
                data = pytrends.interest_over_time()
                
                # Ba≈üarƒ±yla veri geldi - UI g√ºncellemesi i√ßin ana thread'e g√∂nder
                root.after(0, lambda: _update_ui_success(data, keywords))
                
            except Exception as e:
                # Hata olu≈ütu - UI g√ºncellemesi i√ßin ana thread'e g√∂nder
                root.after(0, lambda: _update_ui_error(str(e)))
        
        # --- ARAY√úZ G√úNCELLEME (Ba≈üarƒ±lƒ±) ---
        def _update_ui_success(data, kw_list):
            try:
                if not data.empty:
                    # Tarih formatƒ±
                    dates = [d.strftime("%d.%m") for d in data.index]
                    # Chart i√ßin veri hazƒ±rlƒ±ƒüƒ±
                    chart_data = {col: data[col].tolist() for col in kw_list}
                    
                    update_trend_chart(dates, chart_data)
                    
                    # En √ßok artanƒ± bul
                    last_row = data.iloc[-1]
                    top_trend = last_row.idxmax()
                    current_score = last_row.max()
                    
                    analyze_trend_with_ai(top_trend, current_score, is_simulation=False)
                    status_lbl.configure(text="‚úÖ Veri ba≈üarƒ±yla √ßekildi.")
                else:
                    messagebox.showinfo("Bilgi", "Bu kelimeler i√ßin yeterli veri bulunamadƒ±.")
                    status_lbl.configure(text="Veri bulunamadƒ±.")
            except Exception as parse_error:
                messagebox.showerror("Hata", f"Veri i≈üleme hatasƒ±: {str(parse_error)}")
                status_lbl.configure(text="Veri i≈üleme hatasƒ±.")
        
        # --- ARAY√úZ G√úNCELLEME (Hata) ---
        def _update_ui_error(error_msg):
            # 429 hatasƒ± kontrol√º (Rate Limit)
            if "429" in error_msg or "Too Many Requests" in error_msg:
                messagebox.showerror(
                    "‚è≥ Google Rate Limit", 
                    "Google Trends ge√ßici olarak istekleri engelliyor.\n\n"
                    "üîπ √á√∂z√ºm 1: 1-2 saat bekleyip tekrar deneyin\n"
                    "üîπ √á√∂z√ºm 2: VPN kullanarak IP adresinizi deƒüi≈ütirin\n"
                    "üîπ √á√∂z√ºm 3: Sim√ºlasyon modunu kullanƒ±n (demo butonu)\n\n"
                    "Not: Bu bir Google API limiti, kodla ilgili deƒüil."
                )
                status_lbl.configure(text="‚è≥ Google Rate Limit - L√ºtfen 1-2 saat bekleyin")
            else:
                messagebox.showerror("Hata", f"Google Trends baƒülantƒ± hatasƒ±:\n{error_msg}\n\nƒ∞pucu: Sim√ºlasyon butonunu deneyebilirsiniz.")
                status_lbl.configure(text="‚ùå Hata olu≈ütu.")
            
            # Loglama
            if activity_logger:
                activity_logger.log_error(f"Google Trends hatasƒ±: {error_msg}", "Trend Avcƒ±sƒ±")
        
        # Arka plan thread'ini ba≈ülat (daemon=True: program kapanƒ±rken otomatik temizlenir)
        threading.Thread(target=_background_worker, daemon=True).start()

    ttk.Button(left_panel, text="üåç Ger√ßek Verileri Tara (Google Trends)", command=fetch_real_trends).pack(fill="x", pady=10)
    status_lbl.pack()
    
    # Google Trends Web Sayfasƒ± Butonu (≈ûƒ±k ve dikkat √ßekici)
    trends_button_frame = tk.Frame(left_panel, bg="white")
    trends_button_frame.pack(fill="x", pady=15)
    
    # B√ºy√ºk, ≈üƒ±k Google Trends butonu
    google_trends_btn = tk.Button(
        trends_button_frame,
        text="üî• Google Trends'i A√ß\n(Canlƒ± Trendler)",
        font=("Segoe UI", 12, "bold"),
        bg="#e74c3c",  # Kƒ±rmƒ±zƒ± arka plan
        fg="white",
        activebackground="#c0392b",
        activeforeground="white",
        relief="raised",
        bd=3,
        cursor="hand2",
        padx=20,
        pady=15,
        command=lambda: open_google_trends()
    )
    google_trends_btn.pack(fill="x", pady=5)
    
    # Hover efekti i√ßin fonksiyonlar
    def on_enter(e):
        google_trends_btn.config(bg="#c0392b", font=("Segoe UI", 13, "bold"))
    
    def on_leave(e):
        google_trends_btn.config(bg="#e74c3c", font=("Segoe UI", 12, "bold"))
    
    google_trends_btn.bind("<Enter>", on_enter)
    google_trends_btn.bind("<Leave>", on_leave)
    
    def open_google_trends():
        """Google Trends sayfasƒ±nƒ± tarayƒ±cƒ±da a√ß"""
        import webbrowser
        webbrowser.open("https://trends.google.com.tr/home?geo=TR&hl=tr")
        if activity_logger:
            activity_logger.log_activity("Google Trends web sayfasƒ± a√ßƒ±ldƒ±", "Trend Avcƒ±sƒ±")
    
    # Bilgi etiketi
    tk.Label(
        trends_button_frame, 
        text="üí° Anlƒ±k trendleri tarayƒ±cƒ±da g√∂r√ºn\nRate limit sorunu yok!",
        font=("Segoe UI", 9, "italic"),
        fg="#7f8c8d",
        bg="white",
        justify="center"
    ).pack(pady=(5, 0))
    
    # Aksiyon Butonlarƒ± (Sol panelde, Ger√ßek Verileri Tara butonunun altƒ±nda - Sabit konumda kalƒ±r)
    action_frame_left = tk.Frame(left_panel, bg="white")
    action_frame_left.pack(fill="x", pady=15)
    
    tk.Label(action_frame_left, text="üéØ Hƒ±zlƒ± Aksiyonlar", font=("Segoe UI", 11, "bold"), fg="#2c3e50", bg="white").pack(anchor="w", pady=(0,5))
    
    ttk.Button(action_frame_left, text="üì¶ Kuma≈ü Stoƒüunu Kontrol Et", command=lambda: show_page("Akƒ±llƒ± Sipari≈ü")).pack(fill="x", pady=3)
    ttk.Button(action_frame_left, text="üè≠ √úretime Emir Ver (Draft)", command=lambda: messagebox.showinfo("ERP", "√úretim emri ERP sistemine taslak olarak girildi.")).pack(fill="x", pady=3)

    # 2. SAƒû PANEL: Grafik ve AI Analizi
    right_panel = tk.Frame(content, bg="white", padx=20, pady=10)
    content.add(right_panel)

    # Grafik Alanƒ±
    chart_frame = tk.Frame(right_panel, bg="white", height=350)
    chart_frame.pack(fill="x", expand=False)
    
    # AI Sonu√ß Alanƒ±
    ai_frame = tk.LabelFrame(right_panel, text="ü§ñ Dijital ƒ∞kiz Karar Mekanizmasƒ± (Gemini AI)", font=("Segoe UI", 12, "bold"), bg="white", fg="#2980b9", padx=15, pady=15)
    ai_frame.pack(fill="both", expand=True, pady=10)
    
    ai_text = tk.Text(ai_frame, wrap="word", font=("Segoe UI", 10), bg="#fdfefe", height=10, bd=0)
    ai_text.pack(fill="both", expand=True)
    ai_text.insert("1.0", "Veri bekleniyor... Sim√ºlasyon veya ger√ßek veri butonuna basƒ±n.")
    ai_text.configure(state="disabled")

    # --- Yardƒ±mcƒ± Fonksiyon: Grafik √áizme ---
    def update_trend_chart(dates, data_dict):
        for widget in chart_frame.winfo_children(): widget.destroy()
        
        fig = plt.figure(figsize=(8, 4), dpi=100)
        ax = fig.add_subplot(111)
        
        for label, values in data_dict.items():
            # Eƒüer son deƒüer √∂nceki ortalamadan %30 fazlaysa √ßizgiyi kalƒ±nla≈ütƒ±r (Trend Alarmƒ±)
            avg = sum(values[:-1]) / len(values[:-1]) if len(values) > 1 else 0
            if avg == 0: avg = 1
            
            is_trending = values[-1] > avg * 1.3
            width = 3 if is_trending else 1.5
            style = '-' if is_trending else '--'
            
            ax.plot(dates, values, marker='o', linewidth=width, linestyle=style, label=label)
            
            # Son noktaya deƒüer yaz
            ax.annotate(f"{values[-1]}", (dates[-1], values[-1]), textcoords="offset points", xytext=(0,10), ha='center', fontsize=8)

        ax.set_title("Arama Hacmi / Sosyal Medya ƒ∞lgisi (Son 7 G√ºn)")
        ax.set_ylabel("ƒ∞lgi Skoru (0-100)")
        ax.legend()
        ax.grid(True, alpha=0.3)
        plt.tight_layout()
        
        canvas = FigureCanvasTkAgg(fig, master=chart_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)

    # --- Yardƒ±mcƒ± Fonksiyon: AI Analizi ---
    def analyze_trend_with_ai(trend_name, score, is_simulation=False):
        ai_text.configure(state="normal")
        ai_text.delete("1.0", tk.END)
        ai_text.insert("1.0", "üß† Trend verisi analiz ediliyor... (Gemini)\n")
        ai_text.configure(state="disabled")
        
        def _thread():
            if not GEMINI_API_KEY:
                update_ai_text("Hata: Gemini API anahtarƒ± yok.")
                return

            context = "Sƒ∞M√úLASYON VERƒ∞Sƒ∞" if is_simulation else "GER√áEK GOOGLE TRENDS VERƒ∞Sƒ∞"

            prompt = f"""
Sen bir Hƒ±zlƒ± Moda (Fast Fashion) ve Tedarik Zinciri stratejistisin.

DURUM ({context}):
"{trend_name}" isimli √ºr√ºn√ºn ilgisi son 24 saatte aniden y√ºkseldi.
Mevcut ƒ∞lgi Skoru: {score}/100 (√áok Y√ºksek)

G√ñREV:
1. Bu trendin olasƒ± sebebini 1 c√ºmleyle tahmin et (√ñrn: Influencer etkisi, mevsim, viral video).
2. Tedarik zinciri i√ßin ACƒ∞L 3 maddelik aksiyon planƒ± √ßƒ±kar.
3. Risk analizi yap (Bu ge√ßici bir "micro-trend" mi yoksa sezonluk mu?).

Yanƒ±tƒ±nƒ± T√ºrk√ße, profesyonel ve kƒ±sa tut.
"""
            
            try:
                # Mevcut kodundaki API yapƒ±sƒ±nƒ± kullanƒ±yoruz
                url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={GEMINI_API_KEY}"
                headers = {'Content-Type': 'application/json'}
                payload = {"contents": [{"parts": [{"text": prompt}]}]}
                
                resp = requests.post(url, headers=headers, json=payload, timeout=20)
                
                if resp.status_code == 200:
                    result = resp.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
                    root.after(0, lambda: update_ai_text(result))
                else:
                    root.after(0, lambda: update_ai_text(f"AI yanƒ±t vermedi. Kod: {resp.status_code}"))
            except Exception as e:
                root.after(0, lambda: update_ai_text(f"Baƒülantƒ± hatasƒ±: {e}"))

        threading.Thread(target=_thread, daemon=True).start()

    def update_ai_text(text):
        ai_text.configure(state="normal")
        ai_text.delete("1.0", tk.END)
        ai_text.insert("1.0", text)
        ai_text.configure(state="disabled")

# ---------- GOOGLE TRENDING - ARAMA VE TREND ANALƒ∞Zƒ∞ ----------

def init_google_trending_tab():
    """Google Trending - Anahtar kelime arama ve trend analizi"""
    global frame_google_trending
    
    for widget in frame_google_trending.winfo_children(): widget.destroy()
    
    # Ba≈ülƒ±k
    header = tk.Frame(frame_google_trending, bg="#e74c3c", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="üî• Google Trending Arama", font=("Segoe UI", 18, "bold"), fg="white", bg="#e74c3c").pack(side="left")
    tk.Label(header, text="Ger√ßek Zamanlƒ± Trend Analizi - T√ºrkiye", font=("Segoe UI", 10), fg="#fce5e5", bg="#e74c3c").pack(side="left", padx=10)
    
    # Ana i√ßerik
    main_content = tk.Frame(frame_google_trending, bg="white")
    main_content.pack(fill="both", expand=True, padx=20, pady=20)
    
    # Arama B√∂l√ºm√º
    search_frame = tk.LabelFrame(main_content, text="üîç Anahtar Kelime Ara", 
                                font=("Segoe UI", 12, "bold"), bg="white", fg="#2c3e50", 
                                padx=15, pady=15)
    search_frame.pack(fill="x", pady=(0, 15))
    
    tk.Label(search_frame, text="Arama terimi girin (√∂r: defacto, moda, tekstil, oversize g√∂mlek):", 
            bg="white", font=("Segoe UI", 10)).pack(anchor="w", pady=(0, 5))
    
    search_entry = ttk.Entry(search_frame, font=("Segoe UI", 11), width=50)
    search_entry.pack(fill="x", pady=5)
    search_entry.insert(0, "defacto")
    
    # Zaman aralƒ±ƒüƒ± se√ßimi
    timeframe_frame = tk.Frame(search_frame, bg="white")
    timeframe_frame.pack(fill="x", pady=10)
    
    tk.Label(timeframe_frame, text="Zaman Aralƒ±ƒüƒ±:", bg="white", font=("Segoe UI", 10)).pack(side="left", padx=(0, 10))
    
    timeframe_var = tk.StringVar(value="now 1-d")
    timeframe_options = [
        ("Son 24 Saat", "now 1-d"),
        ("Son 7 G√ºn", "now 7-d"),
        ("Son 30 G√ºn", "today 1-m"),
        ("Son 3 Ay", "today 3-m"),
        ("Son 12 Ay", "today 12-m")
    ]
    
    for text, value in timeframe_options:
        ttk.Radiobutton(timeframe_frame, text=text, variable=timeframe_var, value=value).pack(side="left", padx=5)
    
    # Butonlar
    button_frame = tk.Frame(search_frame, bg="white")
    button_frame.pack(fill="x", pady=10)
    
    def search_trends():
        """Arama terimini Google Trends'de ara"""
        search_term = search_entry.get().strip()
        if not search_term:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen bir arama terimi girin.")
            return
        
        if not PYTRENDS_AVAILABLE:
            messagebox.showerror("Hata", "pytrends k√ºt√ºphanesi eksik. L√ºtfen 'pip install pytrends' yapƒ±n.")
            return
        
        # Sonu√ß alanƒ±nƒ± temizle ve y√ºkleniyor mesajƒ± g√∂ster
        result_text.configure(state="normal")
        result_text.delete("1.0", tk.END)
        result_text.insert("1.0", f"‚è≥ '{search_term}' i√ßin Google Trends verileri √ßekiliyor...\n")
        result_text.configure(state="disabled")
        
        # Grafik alanƒ±nƒ± temizle
        for widget in chart_frame.winfo_children():
            widget.destroy()
        
        def _search_thread():
            try:
                # Arama terimini doƒürula
                if not search_term or len(search_term.strip()) < 2:
                    error_msg = "‚ö†Ô∏è Ge√ßersiz arama terimi.\n\n"
                    error_msg += "En az 2 karakter uzunluƒüunda bir terim girin."
                    root.after(0, lambda: update_result_text(error_msg))
                    return
                
                # Google Trends baƒülantƒ±sƒ±
                pytrends = TrendReq(
                    hl='tr-TR',
                    tz=180,
                    retries=3,
                    backoff_factor=5,
                    timeout=(10, 20)
                )
                
                # Arama terimini query'ye d√∂n√º≈üt√ºr
                timeframe = timeframe_var.get()
                
                # Timeframe doƒürulama
                valid_timeframes = ["now 1-d", "now 7-d", "today 1-m", "today 3-m", "today 12-m"]
                if timeframe not in valid_timeframes:
                    timeframe = "now 7-d"  # Varsayƒ±lan
                
                # Google Trends API √ßaƒürƒ±sƒ±
                pytrends.build_payload([search_term], cat=0, timeframe=timeframe, geo='TR', gprop='')
                
                # ƒ∞lgi verilerini al
                interest_data = pytrends.interest_over_time()
                
                if interest_data.empty or search_term not in interest_data.columns:
                    error_msg = f"‚ö†Ô∏è '{search_term}' i√ßin veri bulunamadƒ±.\n\n"
                    error_msg += "Bu terim i√ßin yeterli arama verisi yok olabilir.\n"
                    error_msg += "Daha genel terimler deneyin."
                    root.after(0, lambda: update_result_text(error_msg))
                    return
                
                # Verileri hazƒ±rla
                dates = [d.strftime("%d.%m.%Y") for d in interest_data.index]
                values = interest_data[search_term].tolist()
                
                # ƒ∞statistikler
                avg_value = sum(values) / len(values)
                max_value = max(values)
                min_value = min(values)
                current_value = values[-1]
                
                # Trend y√∂n√º
                if len(values) >= 2:
                    change = current_value - values[0]
                    change_pct = (change / values[0] * 100) if values[0] > 0 else 0
                    trend_direction = "Y√ºkseli≈ü ‚Üó" if change > 0 else "D√º≈ü√º≈ü ‚Üò" if change < 0 else "Stabil ‚Üí"
                    trend_color = "green" if change > 0 else "red" if change < 0 else "gray"
                else:
                    change_pct = 0
                    trend_direction = "Belirsiz"
                    trend_color = "gray"
                
                # Sonu√ß metnini hazƒ±rla
                result_msg = f"üìä '{search_term}' TREND ANALƒ∞Zƒ∞\n"
                result_msg += f"{'='*60}\n\n"
                result_msg += f"Zaman Aralƒ±ƒüƒ±: {dict(timeframe_options)[timeframe_var.get()]}\n"
                result_msg += f"B√∂lge: T√ºrkiye\n\n"
                result_msg += f"üìà ƒ∞STATƒ∞STƒ∞KLER:\n"
                result_msg += f"   Mevcut ƒ∞lgi Skoru: {current_value}/100\n"
                result_msg += f"   Ortalama: {avg_value:.1f}\n"
                result_msg += f"   Maksimum: {max_value}\n"
                result_msg += f"   Minimum: {min_value}\n\n"
                result_msg += f"üìâ TREND Y√ñN√ú: {trend_direction}\n"
                result_msg += f"   Deƒüi≈üim: {change_pct:+.1f}%\n\n"
                result_msg += f"üí° YORUM:\n"
                
                if current_value > 75:
                    result_msg += f"   üî• √áok y√ºksek ilgi! Bu terim ≈üu anda √ßok pop√ºler.\n"
                elif current_value > 50:
                    result_msg += f"   ‚úÖ Y√ºksek ilgi seviyesi. ƒ∞yi bir trend.\n"
                elif current_value > 25:
                    result_msg += f"   ‚ö†Ô∏è Orta seviye ilgi. Potansiyel var.\n"
                else:
                    result_msg += f"   üìâ D√º≈ü√ºk ilgi seviyesi.\n"
                
                if change_pct > 50:
                    result_msg += f"   üöÄ Hƒ±zlƒ± y√ºkseli≈ü! Viral olabilir.\n"
                elif change_pct < -50:
                    result_msg += f"   ‚ö†Ô∏è Hƒ±zlƒ± d√º≈ü√º≈ü! ƒ∞lgi azalƒ±yor.\n"
                
                # UI'yi g√ºncelle
                root.after(0, lambda: update_result_text(result_msg))
                root.after(0, lambda: draw_trend_chart(dates, values, search_term, trend_color))
                
            except Exception as e:
                error_msg = f"‚ùå Hata olu≈ütu\n\n"
                error_type = type(e).__name__
                error_details = str(e)
                
                # Google Trends √∂zel hata mesajlarƒ±
                if "429" in error_details or "Too Many Requests" in error_details:
                    error_msg += "‚è≥ Google Trends √ßok fazla istek algƒ±ladƒ±.\n\n"
                    error_msg += "√á√∂z√ºmler:\n"
                    error_msg += "‚Ä¢ 10-15 dakika bekleyip tekrar deneyin\n"
                    error_msg += "‚Ä¢ Farklƒ± bir arama terimi deneyin\n"
                    error_msg += "‚Ä¢ ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin\n"
                elif "ResponseError" in error_type or "400" in error_details:
                    error_msg += "üîç Arama terimi veya zaman aralƒ±ƒüƒ± hatalƒ± olabilir.\n\n"
                    error_msg += "√á√∂z√ºmler:\n"
                    error_msg += "‚Ä¢ Daha genel bir terim deneyin (√∂r: 'moda' yerine 'tekstil')\n"
                    error_msg += "‚Ä¢ T√ºrk√ße karakterler kullanmayƒ± deneyin\n"
                    error_msg += "‚Ä¢ Farklƒ± bir zaman aralƒ±ƒüƒ± se√ßin\n"
                elif "Timeout" in error_type or "timeout" in error_details.lower():
                    error_msg += "‚è±Ô∏è ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ±.\n\n"
                    error_msg += "√á√∂z√ºmler:\n"
                    error_msg += "‚Ä¢ ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin\n"
                    error_msg += "‚Ä¢ Birka√ß saniye bekleyip tekrar deneyin\n"
                else:
                    error_msg += f"Hata Tipi: {error_type}\n"
                    error_msg += f"Detay: {error_details}\n\n"
                    error_msg += "√á√∂z√ºmler:\n"
                    error_msg += "‚Ä¢ Farklƒ± bir arama terimi deneyin\n"
                    error_msg += "‚Ä¢ ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin\n"
                    error_msg += "‚Ä¢ Birka√ß dakika sonra tekrar deneyin\n"
                    error_msg += "‚Ä¢ pytrends k√ºt√ºphanesinin y√ºkl√º olduƒüundan emin olun\n"
                
                root.after(0, lambda: update_result_text(error_msg))
        
        # Thread ba≈ülat
        threading.Thread(target=_search_thread, daemon=True).start()
    
    def update_result_text(text):
        """Sonu√ß metnini g√ºncelle"""
        result_text.configure(state="normal")
        result_text.delete("1.0", tk.END)
        result_text.insert("1.0", text)
        result_text.configure(state="disabled")
    
    def draw_trend_chart(dates, values, term, trend_color):
        """Trend grafiƒüini √ßiz"""
        for widget in chart_frame.winfo_children():
            widget.destroy()
        
        fig = plt.figure(figsize=(12, 5), dpi=100)
        ax = fig.add_subplot(111)
        
        # Grafik √ßiz
        ax.plot(dates, values, marker='o', linewidth=2, color=trend_color, label=term)
        ax.fill_between(range(len(dates)), values, alpha=0.3, color=trend_color)
        
        ax.set_title(f"'{term}' Trend Grafiƒüi - Google Trends (T√ºrkiye)", 
                    fontsize=14, fontweight='bold')
        ax.set_xlabel("Tarih", fontsize=11)
        ax.set_ylabel("ƒ∞lgi Skoru (0-100)", fontsize=11)
        ax.legend(loc='best')
        ax.grid(True, alpha=0.3)
        
        # X ekseni etiketlerini d√∂nd√ºr
        ax.tick_params(axis='x', rotation=45)
        for label in ax.get_xticklabels():
            label.set_ha('right')
        fig.tight_layout()
        
        canvas = FigureCanvasTkAgg(fig, master=chart_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)
    
    ttk.Button(button_frame, text="üîç Ara ve Analiz Et", command=search_trends).pack(side="left", padx=5)
    ttk.Button(button_frame, text="üîÑ Temizle", command=lambda: (search_entry.delete(0, tk.END), 
                                                                  result_text.configure(state="normal"),
                                                                  result_text.delete("1.0", tk.END),
                                                                  result_text.insert("1.0", "Arama terimi girin ve 'Ara ve Analiz Et' butonuna basƒ±n."),
                                                                  result_text.configure(state="disabled"),
                                                                  [w.destroy() for w in chart_frame.winfo_children()])).pack(side="left", padx=5)
    
    # Grafik Alanƒ±
    chart_frame = tk.LabelFrame(main_content, text="üìä Trend Grafiƒüi", 
                                font=("Segoe UI", 12, "bold"), bg="white", fg="#2c3e50",
                                padx=10, pady=10)
    chart_frame.pack(fill="both", expand=True, pady=(0, 15))
    
    tk.Label(chart_frame, text="Grafik burada g√∂r√ºnecek...", bg="white", fg="gray", 
            font=("Segoe UI", 12)).pack(expand=True)
    
    # Sonu√ß Alanƒ±
    result_frame = tk.LabelFrame(main_content, text="üìà Analiz Sonu√ßlarƒ±", 
                                 font=("Segoe UI", 12, "bold"), bg="white", fg="#2c3e50",
                                 padx=10, pady=10)
    result_frame.pack(fill="both", expand=False)
    
    result_text = tk.Text(result_frame, wrap="word", font=("Courier New", 10), 
                         bg="#fdfefe", height=12)
    result_text.pack(fill="both", expand=True)
    result_text.insert("1.0", "Arama terimi girin ve 'Ara ve Analiz Et' butonuna basƒ±n.")
    result_text.configure(state="disabled")

# ---------- Sƒ∞PARƒ∞≈û A≈ûAMA TAKƒ∞Bƒ∞ - GANT PLANI (PRODUCTION PIPELINE) ----------

def init_production_pipeline_tab():
    """Sipari≈ü A≈üama Takibi - Gantt Planƒ± sekmesini olu≈üturur"""
    global frame_production_pipeline
    
    for widget in frame_production_pipeline.winfo_children(): widget.destroy()
    
    # Ba≈ülƒ±k
    header = tk.Frame(frame_production_pipeline, bg="#34495e", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="üìä Sipari≈ü A≈üama Takibi - GANT Planƒ±", font=("Segoe UI", 18, "bold"), fg="white", bg="#34495e").pack(side="left")
    tk.Label(header, text="Tekstil √úretim Hattƒ± G√∂rselle≈ütirme Sistemi", font=("Segoe UI", 10), fg="#ecf0f1", bg="#34495e").pack(side="left", padx=10)
    
    # Ana i√ßerik paneli
    content = tk.PanedWindow(frame_production_pipeline, orient=tk.HORIZONTAL)
    content.pack(fill="both", expand=True, pady=10)
    
    # Sol Panel: Sipari≈ü Kontrol√º
    left_panel = tk.Frame(content, bg="white", padx=15, pady=15)
    content.add(left_panel, width=350)
    
    tk.Label(left_panel, text="üéØ Sipari≈ü Y√∂netimi", font=("Segoe UI", 12, "bold"), fg="#2c3e50", bg="white").pack(anchor="w", pady=(0,10))
    
    # Sipari≈ü Ekleme
    add_frame = tk.LabelFrame(left_panel, text="Yeni Sipari≈ü Ekle", bg="#f8f9fa", fg="#34495e", font=("Segoe UI", 9, "bold"), padx=10, pady=10)
    add_frame.pack(fill="x", pady=10)
    
    tk.Label(add_frame, text="Sipari≈ü No:", bg="#f8f9fa").grid(row=0, column=0, sticky="w", pady=5)
    order_no_entry = ttk.Entry(add_frame, width=20)
    order_no_entry.grid(row=0, column=1, pady=5, padx=5)
    
    tk.Label(add_frame, text="Sipari≈ü Adƒ±:", bg="#f8f9fa").grid(row=1, column=0, sticky="w", pady=5)
    order_name_entry = ttk.Entry(add_frame, width=20)
    order_name_entry.grid(row=1, column=1, pady=5, padx=5)
    
    # A≈üama Durumu G√ºncelleme
    update_frame = tk.LabelFrame(left_panel, text="A≈üama Durumu G√ºncelle", bg="#e8f5e9", fg="#27ae60", font=("Segoe UI", 9, "bold"), padx=10, pady=10)
    update_frame.pack(fill="x", pady=10)
    
    tk.Label(update_frame, text="Sipari≈ü Se√ß:", bg="#e8f5e9").grid(row=0, column=0, sticky="w", pady=5)
    order_select_combo = ttk.Combobox(update_frame, width=18, state="readonly")
    order_select_combo.grid(row=0, column=1, pady=5, padx=5)
    
    tk.Label(update_frame, text="A≈üama:", bg="#e8f5e9").grid(row=1, column=0, sticky="w", pady=5)
    stage_combo = ttk.Combobox(update_frame, width=18, state="readonly")
    stage_combo['values'] = ["ƒ∞plik ‚Üí Kuma≈ü", "Boyama", "Paketleme", "Sevkiyat"]
    stage_combo.grid(row=1, column=1, pady=5, padx=5)
    
    tk.Label(update_frame, text="Durum (%):", bg="#e8f5e9").grid(row=2, column=0, sticky="w", pady=5)
    progress_scale = ttk.Scale(update_frame, from_=0, to=100, orient="horizontal")
    progress_scale.grid(row=2, column=1, pady=5, padx=5)
    progress_label = tk.Label(update_frame, text="0%", bg="#e8f5e9", font=("Segoe UI", 9, "bold"))
    progress_label.grid(row=2, column=2, pady=5)
    
    def update_progress_label(val):
        progress_label.configure(text=f"{int(float(val))}%")
    
    progress_scale.configure(command=update_progress_label)
    
    # Saƒü Panel: GANT Chart
    right_panel = tk.Frame(content, bg="white", padx=20, pady=10)
    content.add(right_panel)
    
    chart_frame = tk.Frame(right_panel, bg="white")
    chart_frame.pack(fill="both", expand=True)
    
    # Fonksiyonlar
    def add_order():
        order_no = order_no_entry.get().strip()
        order_name = order_name_entry.get().strip()
        
        if not order_no or not order_name:
            messagebox.showwarning("Eksik Bilgi", "L√ºtfen sipari≈ü no ve adƒ± girin.")
            return
        
        if order_no in production_orders_global:
            messagebox.showwarning("Uyarƒ±", "Bu sipari≈ü numarasƒ± zaten mevcut.")
            return
        
        # Yeni sipari≈ü ekle (ba≈ülangƒ±√ßta t√ºm a≈üamalar %0)
        production_orders_global[order_no] = {
            'name': order_name,
            'stages': {
                'ƒ∞plik ‚Üí Kuma≈ü': 0,
                'Boyama': 0,
                'Paketleme': 0,
                'Sevkiyat': 0
            },
            'start_date': datetime.datetime.now()
        }
        
        order_no_entry.delete(0, tk.END)
        order_name_entry.delete(0, tk.END)
        
        update_order_list()
        draw_gantt_chart()
        
        if activity_logger:
            activity_logger.log_event("ORDER_ADDED", f"Sipari≈ü eklendi: {order_no} - {order_name}", "√úretim Takibi")
    
    def update_stage():
        order_no = order_select_combo.get()
        stage = stage_combo.get()
        progress = int(progress_scale.get())
        
        if not order_no or not stage:
            messagebox.showwarning("Eksik Bilgi", "L√ºtfen sipari≈ü ve a≈üama se√ßin.")
            return
        
        if order_no in production_orders_global:
            production_orders_global[order_no]['stages'][stage] = progress
            draw_gantt_chart()
            messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{order_no} - {stage}: %{progress} g√ºncellendi.")
            
            if activity_logger:
                activity_logger.log_event("STAGE_UPDATED", f"{order_no} - {stage}: {progress}%", "√úretim Takibi")
        else:
            messagebox.showerror("Hata", "Sipari≈ü bulunamadƒ±.")
    
    def update_order_list():
        order_list = list(production_orders_global.keys())
        order_select_combo['values'] = order_list
        if order_list:
            order_select_combo.set(order_list[0])
    
    def draw_gantt_chart():
        """GANT grafiƒüini matplotlib ile √ßizer"""
        for widget in chart_frame.winfo_children():
            widget.destroy()
        
        if not production_orders_global:
            tk.Label(chart_frame, text="Hen√ºz sipari≈ü eklenmedi.\nSol panelden sipari≈ü ekleyin.", 
                    font=("Segoe UI", 12), fg="gray", bg="white").pack(expand=True)
            return
        
        fig = plt.figure(figsize=(10, 6), dpi=100)
        ax = fig.add_subplot(111)
        
        stages = ['ƒ∞plik ‚Üí Kuma≈ü', 'Boyama', 'Paketleme', 'Sevkiyat']
        colors = ['#3498db', '#9b59b6', '#e74c3c', '#2ecc71']
        
        y_pos = 0
        y_labels = []
        
        for order_no, order_data in production_orders_global.items():
            order_name = order_data['name']
            y_labels.append(f"{order_no}\n{order_name}")
            
            x_start = 0
            for idx, stage in enumerate(stages):
                progress = order_data['stages'][stage]
                width = progress / 100.0  # Her a≈üama maksimum 1 birim
                
                if width > 0:
                    ax.barh(y_pos, width, left=x_start, height=0.6, 
                           color=colors[idx], alpha=0.8, 
                           edgecolor='black', linewidth=0.5)
                    
                    # ƒ∞lerleme y√ºzdesini g√∂ster
                    if width > 0.15:  # Sadece yeterince geni≈ü √ßubuklar i√ßin
                        ax.text(x_start + width/2, y_pos, f'{int(progress)}%', 
                               ha='center', va='center', fontsize=8, fontweight='bold', color='white')
                
                x_start += 1  # Her a≈üama 1 birim geni≈üliƒüinde
            
            y_pos += 1
        
        ax.set_yticks(range(len(y_labels)))
        ax.set_yticklabels(y_labels, fontsize=9)
        ax.set_xticks(range(len(stages) + 1))
        ax.set_xticklabels([''] + stages, rotation=15, ha='right', fontsize=9)
        ax.set_xlabel('√úretim A≈üamalarƒ±', fontsize=10, fontweight='bold')
        ax.set_ylabel('Sipari≈üler', fontsize=10, fontweight='bold')
        ax.set_title('Tekstil √úretim Hattƒ± - Gantt Planƒ±', fontsize=12, fontweight='bold')
        ax.set_xlim(0, len(stages))
        ax.grid(axis='x', alpha=0.3, linestyle='--')
        
        # Lejant ekle
        from matplotlib.patches import Patch
        legend_elements = [Patch(facecolor=colors[i], label=stages[i]) for i in range(len(stages))]
        ax.legend(handles=legend_elements, loc='upper right', fontsize=8)
        
        plt.tight_layout()
        
        canvas = FigureCanvasTkAgg(fig, master=chart_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)
        
        # Toolbar ekle
        toolbar_frame = tk.Frame(chart_frame)
        toolbar_frame.pack(fill="x")
        toolbar = NavigationToolbar2Tk(canvas, toolbar_frame)
        toolbar.update()
    
    # Butonlar
    ttk.Button(add_frame, text="‚ûï Sipari≈ü Ekle", command=add_order).grid(row=2, column=0, columnspan=2, pady=10)
    ttk.Button(update_frame, text="üîÑ Durumu G√ºncelle", command=update_stage).grid(row=3, column=0, columnspan=3, pady=10)
    
    # √ñrnek veriler ekle (ilk a√ßƒ±lƒ±≈üta)
    if not production_orders_global:
        production_orders_global['ORD-001'] = {
            'name': 'Pamuklu G√∂mlek',
            'stages': {'ƒ∞plik ‚Üí Kuma≈ü': 100, 'Boyama': 75, 'Paketleme': 30, 'Sevkiyat': 0},
            'start_date': datetime.datetime.now() - timedelta(days=5)
        }
        production_orders_global['ORD-002'] = {
            'name': 'Denim Pantolon',
            'stages': {'ƒ∞plik ‚Üí Kuma≈ü': 100, 'Boyama': 100, 'Paketleme': 80, 'Sevkiyat': 20},
            'start_date': datetime.datetime.now() - timedelta(days=7)
        }
        production_orders_global['ORD-003'] = {
            'name': 'Polyester Ceket',
            'stages': {'ƒ∞plik ‚Üí Kuma≈ü': 60, 'Boyama': 0, 'Paketleme': 0, 'Sevkiyat': 0},
            'start_date': datetime.datetime.now() - timedelta(days=2)
        }
    
    update_order_list()
    draw_gantt_chart()

# ---------- HAMMADDE Fƒ∞YAT ƒ∞STƒ∞HBARATI (COMMODITY INTELLIGENCE) ----------
# Price simulation constants
PRICE_VARIANCE_FACTOR = 0.15  # ¬±15% price fluctuation
TREND_START_FACTOR = 0.90     # Trend starts at 90% of current price
PRICE_BLEND_RATIO = 0.7       # 70% random, 30% trend
TREND_BLEND_RATIO = 0.3       # Complement of PRICE_BLEND_RATIO

def init_commodity_intelligence_tab():
    """Hammadde Fiyat ƒ∞stihbaratƒ± sekmesini olu≈üturur"""
    global frame_commodity_intel
    
    for widget in frame_commodity_intel.winfo_children(): widget.destroy()
    
    # Ba≈ülƒ±k
    header = tk.Frame(frame_commodity_intel, bg="#16a085", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="üíπ Hammadde Fiyat ƒ∞stihbaratƒ±", font=("Segoe UI", 18, "bold"), fg="white", bg="#16a085").pack(side="left")
    tk.Label(header, text="Ger√ßek Zamanlƒ± Emtia Fiyat Takibi ve Analiz Sistemi", font=("Segoe UI", 10), fg="#d5f4e6", bg="#16a085").pack(side="left", padx=10)
    
    # Ana i√ßerik
    content = tk.PanedWindow(frame_commodity_intel, orient=tk.VERTICAL)
    content.pack(fill="both", expand=True, pady=10)
    
    # √úst Panel: Fiyat Kartlarƒ±
    top_panel = tk.Frame(content, bg="#ecf0f1", padx=20, pady=15)
    content.add(top_panel, height=200)
    
    tk.Label(top_panel, text="üìä G√ºncel Emtia Fiyatlarƒ±", font=("Segoe UI", 12, "bold"), fg="#2c3e50", bg="#ecf0f1").pack(anchor="w", pady=(0,10))
    
    cards_frame = tk.Frame(top_panel, bg="#ecf0f1")
    cards_frame.pack(fill="x")
    
    # Alt Panel: Grafik ve Kontroller
    bottom_panel = tk.Frame(content, bg="white")
    content.add(bottom_panel)
    
    # Kontrol paneli
    control_frame = tk.Frame(bottom_panel, bg="#f8f9fa", padx=15, pady=15)
    control_frame.pack(fill="x")
    
    tk.Label(control_frame, text="Emtia Se√ß:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=5)
    commodity_combo = ttk.Combobox(control_frame, width=20, state="readonly")
    commodity_combo['values'] = ["Pamuk (Cotlook A Index)", "Polyester", "Viskon"]
    commodity_combo.set("Pamuk (Cotlook A Index)")
    commodity_combo.pack(side="left", padx=5)
    
    tk.Label(control_frame, text="Zaman Aralƒ±ƒüƒ±:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=15)
    period_combo = ttk.Combobox(control_frame, width=12, state="readonly")
    period_combo['values'] = ["30 G√ºn", "90 G√ºn", "365 G√ºn"]
    period_combo.set("30 G√ºn")
    period_combo.pack(side="left", padx=5)
    
    # Grafik alanƒ±
    chart_frame = tk.Frame(bottom_panel, bg="white")
    chart_frame.pack(fill="both", expand=True, padx=20, pady=10)
    
    # Alert alanƒ±
    alert_frame = tk.LabelFrame(bottom_panel, text="‚ö†Ô∏è Fiyat Uyarƒ±larƒ±", bg="#fff3cd", fg="#856404", font=("Segoe UI", 10, "bold"), padx=15, pady=10)
    alert_frame.pack(fill="x", padx=20, pady=10)
    
    alert_text = tk.Text(alert_frame, height=4, wrap="word", font=("Segoe UI", 9), bg="#fffaeb", fg="#856404", bd=0)
    alert_text.pack(fill="x")
    alert_text.insert("1.0", "Fiyat uyarƒ±larƒ± burada g√∂r√ºnecek...")
    alert_text.configure(state="disabled")
    
    # Fonksiyonlar
    def fetch_real_commodity_data():
        """Ger√ßek emtia fiyatlarƒ±nƒ± Yahoo Finance'den √ßeker"""
        global YFINANCE_AVAILABLE
        
        commodity_prices_global.clear()
        
        if YFINANCE_AVAILABLE:
            try:
                # Pamuk (Cotton) - CT=F (ICEUS Cotton No.2)
                cotton_ticker = yf.Ticker("CT=F")
                cotton_hist = cotton_ticker.history(period="2d")
                
                if not cotton_hist.empty and len(cotton_hist) >= 1:
                    cotton_current = cotton_hist['Close'].iloc[-1]
                    cotton_previous = cotton_hist['Close'].iloc[-2] if len(cotton_hist) >= 2 else cotton_current * 0.99
                    
                    commodity_prices_global['Pamuk (Cotlook A Index)'] = {
                        'current': float(cotton_current),
                        'previous': float(cotton_previous),
                        'unit': 'USD/lb',
                        'change': float(cotton_current - cotton_previous)
                    }
                    print(f"Pamuk fiyatƒ± √ßekildi: {cotton_current:.2f} USD/lb")
                else:
                    print("Pamuk fiyatƒ± √ßekilemedi, varsayƒ±lan deƒüer kullanƒ±lƒ±yor")
                    commodity_prices_global['Pamuk (Cotlook A Index)'] = {
                        'current': 94.20,
                        'previous': 92.50,
                        'unit': 'USD/lb',
                        'change': 1.7
                    }
                
                # Polyester (PET) - Polyester i√ßin doƒürudan ticker yok, tahmin kullanƒ±yoruz
                # Petrol fiyatlarƒ±na baƒülƒ± olarak hareket eder
                try:
                    oil_ticker = yf.Ticker("CL=F")  # Crude Oil WTI
                    oil_hist = oil_ticker.history(period="2d")
                    
                    if not oil_hist.empty:
                        oil_price = oil_hist['Close'].iloc[-1]
                        # Polyester fiyatƒ± yakla≈üƒ±k olarak petrol fiyatƒ±na g√∂re hesaplanƒ±r
                        # 1 varil petrol ‚âà 159 litre, polyester √ºretimi i√ßin maliyet fakt√∂r√º
                        polyester_base = 1200
                        polyester_current = polyester_base + (float(oil_price) - 70) * 10
                        polyester_previous = polyester_current * 0.98
                        
                        commodity_prices_global['Polyester'] = {
                            'current': float(polyester_current),
                            'previous': float(polyester_previous),
                            'unit': 'USD/ton',
                            'change': float(polyester_current - polyester_previous)
                        }
                        print(f"Polyester fiyatƒ± hesaplandƒ±: {polyester_current:.0f} USD/ton (Petrol: {oil_price:.2f})")
                    else:
                        raise Exception("Petrol fiyatƒ± √ßekilemedi")
                        
                except Exception as e:
                    print(f"Polyester fiyatƒ± hesaplanamadƒ±: {e}, varsayƒ±lan deƒüer kullanƒ±lƒ±yor")
                    commodity_prices_global['Polyester'] = {
                        'current': 1350,
                        'previous': 1420,
                        'unit': 'USD/ton',
                        'change': -70
                    }
                
                # Viskon (Viscose) - Doƒürudan ticker yok, pamuk fiyatƒ±na g√∂re tahmin
                if 'Pamuk (Cotlook A Index)' in commodity_prices_global:
                    cotton_price_cents = commodity_prices_global['Pamuk (Cotlook A Index)']['current'] * 100  # cent/lb
                    viscose_current = cotton_price_cents * 9.5  # Yakla≈üƒ±k √ßarpan
                    viscose_previous = viscose_current * 0.98
                    
                    commodity_prices_global['Viskon'] = {
                        'current': float(viscose_current),
                        'previous': float(viscose_previous),
                        'unit': 'USD/ton',
                        'change': float(viscose_current - viscose_previous)
                    }
                    print(f"Viskon fiyatƒ± hesaplandƒ±: {viscose_current:.0f} USD/ton")
                else:
                    commodity_prices_global['Viskon'] = {
                        'current': 2100,
                        'previous': 2050,
                        'unit': 'USD/ton',
                        'change': 50
                    }
                    
            except Exception as e:
                print(f"Ger√ßek veri √ßekme hatasƒ±: {e}, varsayƒ±lan deƒüerler kullanƒ±lƒ±yor")
                # Hata durumunda varsayƒ±lan deƒüerleri y√ºkle
                commodity_prices_global['Pamuk (Cotlook A Index)'] = {
                    'current': 94.20,
                    'previous': 92.50,
                    'unit': 'USD/lb',
                    'change': 1.7
                }
                commodity_prices_global['Polyester'] = {
                    'current': 1350,
                    'previous': 1420,
                    'unit': 'USD/ton',
                    'change': -70
                }
                commodity_prices_global['Viskon'] = {
                    'current': 2100,
                    'previous': 2050,
                    'unit': 'USD/ton',
                    'change': 50
                }
        else:
            # yfinance k√ºt√ºphanesi yoksa varsayƒ±lan deƒüerler
            print("YFinance k√ºt√ºphanesi y√ºkl√º deƒüil, varsayƒ±lan deƒüerler kullanƒ±lƒ±yor")
            commodity_prices_global['Pamuk (Cotlook A Index)'] = {
                'current': 94.20,
                'previous': 92.50,
                'unit': 'USD/lb',
                'change': 1.7
            }
            commodity_prices_global['Polyester'] = {
                'current': 1350,
                'previous': 1420,
                'unit': 'USD/ton',
                'change': -70
            }
            commodity_prices_global['Viskon'] = {
                'current': 2100,
                'previous': 2050,
                'unit': 'USD/ton',
                'change': 50
            }
        
        # Ge√ßmi≈ü fiyat verisi olu≈ütur (ger√ßek tarihsel veri veya sim√ºlasyon)
        commodity_history_global.clear()
        
        for commodity in commodity_prices_global.keys():
            base_price = commodity_prices_global[commodity]['current']
            history = {}
            
            # Her zaman aralƒ±ƒüƒ± i√ßin ge√ßmi≈ü veri olu≈ütur
            for days in [30, 90, 365]:
                if YFINANCE_AVAILABLE:
                    try:
                        # Ger√ßek tarihsel veri √ßekmeyi dene
                        if commodity == 'Pamuk (Cotlook A Index)':
                            ticker = yf.Ticker("CT=F")
                            hist = ticker.history(period=f"{days}d")
                            
                            if not hist.empty and len(hist) > 0:
                                dates = [d.strftime("%Y-%m-%d") for d in hist.index]
                                prices = hist['Close'].tolist()
                                history[days] = {'dates': dates, 'prices': prices}
                                continue
                    except Exception as e:
                        print(f"{commodity} i√ßin {days} g√ºnl√ºk ger√ßek veri √ßekilemedi: {e}")
                
                # Ger√ßek veri √ßekilemezse sim√ºlasyon olu≈ütur
                dates = [(datetime.datetime.now() - timedelta(days=i)).strftime("%Y-%m-%d") for i in range(days, -1, -1)]
                prices = [base_price + random.uniform(-base_price*PRICE_VARIANCE_FACTOR, base_price*PRICE_VARIANCE_FACTOR) for _ in dates]
                trend = np.linspace(base_price * TREND_START_FACTOR, base_price, len(prices))
                prices = [p * PRICE_BLEND_RATIO + t * TREND_BLEND_RATIO for p, t in zip(prices, trend)]
                history[days] = {'dates': dates, 'prices': prices}
            
            commodity_history_global[commodity] = history
    
    def update_price_cards():
        """Fiyat kartlarƒ±nƒ± g√ºnceller"""
        for widget in cards_frame.winfo_children():
            widget.destroy()
        
        col = 0
        for commodity, data in commodity_prices_global.items():
            card = tk.Frame(cards_frame, bg="white", bd=1, relief="solid", padx=15, pady=15)
            card.grid(row=0, column=col, padx=10, sticky="ew")
            cards_frame.grid_columnconfigure(col, weight=1)
            
            # ƒ∞sim
            tk.Label(card, text=commodity, font=("Segoe UI", 10, "bold"), fg="#34495e", bg="white").pack(anchor="w")
            
            # Fiyat
            price_frame = tk.Frame(card, bg="white")
            price_frame.pack(fill="x", pady=5)
            tk.Label(price_frame, text=f"{data['current']:.2f}", font=("Segoe UI", 18, "bold"), fg="#2c3e50", bg="white").pack(side="left")
            tk.Label(price_frame, text=f" {data['unit']}", font=("Segoe UI", 10), fg="#7f8c8d", bg="white").pack(side="left")
            
            # Deƒüi≈üim
            change = data['change']
            change_color = "#27ae60" if change >= 0 else "#e74c3c"
            change_icon = "‚ñ≤" if change >= 0 else "‚ñº"
            change_text = f"{change_icon} {abs(change):.2f}"
            if abs(change) >= 1:
                change_pct = (change / data['previous']) * 100
                change_text += f" ({change_pct:+.1f}%)"
            
            tk.Label(card, text=change_text, font=("Segoe UI", 9, "bold"), fg=change_color, bg="white").pack(anchor="w")
            
            col += 1
    
    def update_chart():
        """Se√ßilen emtia i√ßin fiyat grafiƒüini √ßizer"""
        for widget in chart_frame.winfo_children():
            widget.destroy()
        
        commodity = commodity_combo.get()
        period_text = period_combo.get()
        period = int(period_text.split()[0])
        
        if commodity not in commodity_history_global:
            tk.Label(chart_frame, text="Veri y√ºkleniyor...", font=("Segoe UI", 12), fg="gray", bg="white").pack(expand=True)
            return
        
        history = commodity_history_global[commodity][period]
        dates = history['dates']
        prices = history['prices']
        
        fig = plt.figure(figsize=(10, 4), dpi=100)
        ax = fig.add_subplot(111)
        
        # Fiyat √ßizgisi
        ax.plot(dates, prices, linewidth=2, color='#3498db', marker='o', markersize=3, label='Fiyat')
        
        # Hareketli ortalama ekle
        if len(prices) > 7:
            ma = pd.Series(prices).rolling(window=7).mean()
            ax.plot(dates, ma, linewidth=2, color='#e74c3c', linestyle='--', label='7 G√ºnl√ºk Ortalama')
        
        # G√ºncel fiyat √ßizgisi
        current_price = commodity_prices_global[commodity]['current']
        ax.axhline(y=current_price, color='#27ae60', linestyle=':', linewidth=1.5, label=f'G√ºncel: {current_price:.2f}')
        
        ax.set_title(f'{commodity} - Son {period} G√ºn Fiyat Ge√ßmi≈üi', fontsize=12, fontweight='bold')
        ax.set_xlabel('Tarih', fontsize=10)
        ax.set_ylabel(f'Fiyat ({commodity_prices_global[commodity]["unit"]})', fontsize=10)
        ax.legend(loc='best', fontsize=9)
        ax.grid(True, alpha=0.3, linestyle='--')
        
        # X ekseni etiketlerini d√∂nd√ºr
        every_nth = max(1, len(dates) // 10)
        ax.set_xticks(range(0, len(dates), every_nth))
        ax.set_xticklabels([dates[i] for i in range(0, len(dates), every_nth)], rotation=45, ha='right', fontsize=8)
        
        plt.tight_layout()
        
        canvas = FigureCanvasTkAgg(fig, master=chart_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)
    
    def update_alerts():
        """Fiyat uyarƒ±larƒ±nƒ± g√ºnceller"""
        alert_text.configure(state="normal")
        alert_text.delete("1.0", tk.END)
        
        alerts = []
        for commodity, data in commodity_prices_global.items():
            current = data['current']
            previous = data['previous']
            
            if current > 0 and previous > 0:
                pct_change = ((current - previous) / previous) * 100
                
                if abs(pct_change) >= 5:
                    icon = "üî¥" if pct_change > 0 else "üü¢"
                    direction = "y√ºksek" if pct_change > 0 else "d√º≈ü√ºk"
                    alerts.append(f"{icon} {commodity}: Bu fiyat %{abs(pct_change):.1f} {direction}! (Referans: {previous:.2f})")
        
        if alerts:
            alert_text.insert("1.0", "\n".join(alerts))
        else:
            alert_text.insert("1.0", "‚úÖ T√ºm emtia fiyatlarƒ± normal aralƒ±kta.")
        
        alert_text.configure(state="disabled")
    
    def refresh_data():
        """T√ºm verileri yeniler"""
        fetch_real_commodity_data()
        update_price_cards()
        update_chart()
        update_alerts()
        
        if activity_logger:
            activity_logger.log_event("COMMODITY_DATA_REFRESH", "Emtia fiyatlarƒ± g√ºncellendi", "Hammadde ƒ∞stihbaratƒ±")
    
    # Yenile butonu
    ttk.Button(control_frame, text="üîÑ Verileri Yenile", command=refresh_data).pack(side="left", padx=15)
    ttk.Button(control_frame, text="üìä Grafiƒüi G√ºncelle", command=update_chart).pack(side="left", padx=5)
    
    # Combobox deƒüi≈üikliklerinde grafiƒüi g√ºncelle
    commodity_combo.bind("<<ComboboxSelected>>", lambda e: update_chart())
    period_combo.bind("<<ComboboxSelected>>", lambda e: update_chart())
    
    # ƒ∞lk veri y√ºklemesi
    refresh_data()

# ---------- REKLAMASYON Y√ñNETƒ∞Mƒ∞ FONKSƒ∞YONLARI ----------
# Yardƒ±mcƒ± Fonksiyonlar
def clean_currency_rek(val):
    """Para ve sayƒ± formatƒ±nƒ± temizler"""
    if pd.isna(val) or str(val).strip() in ['-', '', 'nan', 'NaT']: return 0.0
    if isinstance(val, (int, float)): return float(val)
    val = str(val).replace('‚Ç∫', '').replace(' ', '')
    if '.' in val and ',' in val: val = val.replace('.', '').replace(',', '.')
    elif ',' in val: val = val.replace(',', '.')
    try: return float(val)
    except: return 0.0

def tr_to_eng(text):
    """T√ºrk√ße karakterleri ƒ∞ngilizce'ye √ßevirir"""
    if not isinstance(text, str): return str(text)
    tr_map = str.maketrans("ƒüƒûƒ±ƒ∞√∂√ñ√º√ú≈ü≈û√ß√á", "gGiIoOuUsScC")
    return text.translate(tr_map)

def export_rek_df_to_excel(df, default_name="Export", auto_save=False):
    """DataFrame'i Excel'e aktarƒ±r"""
    if df is None or df.empty: return None
    if auto_save:
        filename = f"{default_name}_{datetime.date.today()}.xlsx"
        df.to_excel(filename, index=False)
        return filename
    f = filedialog.asksaveasfilename(initialfile=f"{default_name}_{datetime.date.today()}", defaultextension=".xlsx", filetypes=[("Excel Files", "*.xlsx")])
    if f:
        try: df.to_excel(f, index=False); messagebox.showinfo("Ba≈üarƒ±lƒ±", "Excel dosyasƒ± olu≈üturuldu.")
        except Exception as e: messagebox.showerror("Hata", str(e))
    return None

def export_rek_df_to_pdf(df, title, default_name="Export", auto_save=False):
    """DataFrame'i PDF'e aktarƒ±r"""
    if df is None or df.empty: return None
    
    def create_pdf(filename):
        pdf = FPDF(orientation='L', unit='mm', format='A4')
        pdf.add_page()
        pdf.set_font("Arial", 'B', 14)
        pdf.cell(0, 10, tr_to_eng(title), ln=True, align='C')
        pdf.ln(5)
        pdf.set_font("Arial", 'B', 8)
        cols = df.columns
        col_w = 275 / len(cols)
        for col in cols: pdf.cell(col_w, 8, tr_to_eng(str(col))[:15], 1)
        pdf.ln()
        pdf.set_font("Arial", '', 7)
        for _, row in df.iterrows():
            for col in cols:
                val = str(row[col])
                pdf.cell(col_w, 6, tr_to_eng(val)[:20], 1)
            pdf.ln()
        pdf.output(filename)
        return filename

    if auto_save:
        filename = f"{default_name}_{datetime.date.today()}.pdf"
        try: return create_pdf(filename)
        except: return None
    
    f = filedialog.asksaveasfilename(initialfile=f"{default_name}_{datetime.date.today()}", defaultextension=".pdf", filetypes=[("PDF Files", "*.pdf")])
    if f:
        try: create_pdf(f); messagebox.showinfo("Ba≈üarƒ±lƒ±", "PDF dosyasƒ± olu≈üturuldu.")
        except Exception as e: messagebox.showerror("Hata", str(e))
    return None

def create_reklamasyon_dummy_data():
    """√ñrnek reklamasyon verisi olu≈üturur"""
    data = {
        "Fi≈ü Tipi": ["62 - Mamul Kuma≈ü Alƒ±m ƒ∞rsaliyesi", "62 - Mamul Kuma≈ü Alƒ±m ƒ∞rsaliyesi", "63 - Mamul Kuma≈ü Alƒ±m ƒ∞ade", "63 - Mamul Kuma≈ü Alƒ±m ƒ∞ade", "52 - Verilen Reklamasyon Fi≈üi", "62 - Mamul Kuma≈ü Alƒ±m ƒ∞rsaliyesi"],
        "Fi≈ü Tarihi": ["06.01.2026", "10.01.2026", "13.01.2026", "07.01.2026", "15.01.2026", "01.01.2026"],
        "Cari Adƒ±": ["UNƒ∞TY TEKSTƒ∞L", "UNƒ∞TY TEKSTƒ∞L", "Bƒ∞RCAN KUMA≈û", "REHA BOYA", "√ñZYURT TEKSTƒ∞L", "TARTEKS ƒ∞PLƒ∞K"],
        "Order No": ["G8773A8-1805799", "G8773A8-1805799", "F8160AX", "F8666AX", "G5901A5", "E8430A5"],
        "M√º≈üteri Termin Tarihi": ["01.04.2026", "01.04.2026", "10.01.2026", "05.01.2026", "20.01.2026", "05.01.2026"],
        "Sipari≈ü Termin Tarihi": ["17.01.2026", "08.01.2026", "10.01.2026", "05.01.2026", "10.01.2026", "05.01.2026"],
        "Stok Kodu": ["05 BRIBDUZ", "05 BSUPDUZ", "05 BSUPBSK", "05 BRIB", "05 BKKDUZ", "05 B2IP"],
        "Stok Adƒ±": ["Rƒ∞BANA 1X1", "S√úPREM D√úZ", "S√úPREM BASKILI", "Rƒ∞BANA", "KA≈ûKORSE", "2 ƒ∞PLƒ∞K"],
        "Var - 1": ["ER105-ECRU", "ER105-ECRU", "BLUE", "ANTHRA", "GREEN", "RED"],
        "Parti/Lab No": ["12223-3", "12223-1", "1506", "7215", "2907", "2500"],
        "Sipari≈ü Fi≈üi Fi≈ü No": ["5", "6", "10", "11", "12", "13"],
        "Tahsis Net Mik.": ["64,00", "365,00", "24,00", "50,00", "1,00", "100,00"],
        "Tahsis Tutarƒ±": ["16.640,00", "91.250,00", "6.996,00", "13.250,00", "33.000,00", "15.000,00"],
        "A√ßƒ±klama": ["", "", "Leke Hatasƒ±", "Termin Gecikmesi", "Fiyat Farkƒ±", ""],
        "Stok Fi≈üi Detay Reklamasyon Sebepleri": ["", "", "Kalite Kontrol Red", "Termin Gecikmesi", "Kalite Onaylanmadƒ±", ""],
        "Order Grup Adƒ±": ["Yƒ∞ √ñRME-5 (ERKEK √áOCUK/BEBEK)", "Yƒ∞ √ñRME-5 (ERKEK √áOCUK/BEBEK)", "Yƒ∞ √ñRME-2 (YOUNG)", "Yƒ∞ √ñRME-2 (YOUNG)", "Yƒ∞ √ñRME-5 (ERKEK √áOCUK/BEBEK)", "Yƒ∞ √ñRME-1 (SMART CORE)"]
    }
    df = pd.DataFrame(data)
    df["Tahsis Tutarƒ±_Clean"] = df["Tahsis Tutarƒ±"].apply(clean_currency_rek)
    df["Tahsis Net Mik._Clean"] = df["Tahsis Net Mik."].apply(clean_currency_rek)
    return df

def load_reklamasyon_data(filepath=None):
    """Reklamasyon verisini y√ºkler ve i≈üler"""
    global df_reklamasyon_global
    try:
        if filepath: df = pd.read_excel(filepath)
        else: df = create_reklamasyon_dummy_data()
        
        df.rename(columns={"Sipari≈ü Fi≈üi Termin Tarihi": "Sipari≈ü Termin Tarihi", "Order M√º≈üteri Termin Tarihi": "M√º≈üteri Termin Tarihi"}, inplace=True)
        if "Tahsis Tutarƒ±" in df.columns: df["Tahsis Tutarƒ±_Clean"] = df["Tahsis Tutarƒ±"].apply(clean_currency_rek)
        else: df["Tahsis Tutarƒ±_Clean"] = 0.0
        qty_col = "Tahsis Net Mik." if "Tahsis Net Mik." in df.columns else "Net Mik."
        if qty_col in df.columns: df["Miktar_Clean"] = df[qty_col].apply(clean_currency_rek)
        else: df["Miktar_Clean"] = 0.0

        for col in ["Fi≈ü Tarihi", "M√º≈üteri Termin Tarihi", "Sipari≈ü Termin Tarihi"]:
            if col in df.columns: df[col] = pd.to_datetime(df[col], dayfirst=True, errors='coerce')
            else: df[col] = pd.NaT

        df["Musteri_Gecikme"] = (df["Fi≈ü Tarihi"] - df["M√º≈üteri Termin Tarihi"]).dt.days
        df["Siparis_Gecikme"] = (df["Fi≈ü Tarihi"] - df["Sipari≈ü Termin Tarihi"]).dt.days

        def determine_type(row):
            ft = str(row.get('Fi≈ü Tipi', '')).lower()
            if '52' in ft or 'reklamasyon' in ft: return 'Reklamasyon'
            if '63' in ft or 'iade' in ft: return 'ƒ∞ade'
            if '62' in ft or 'alƒ±m' in ft: return 'Alƒ±m'
            return 'Diƒüer'
        df['Islem_Tipi'] = df.apply(determine_type, axis=1)

        def calculate_metrics(row):
            tip = row['Islem_Tipi']; gecikme = row['Siparis_Gecikme'] if pd.notna(row['Siparis_Gecikme']) else 0
            miktar = row['Miktar_Clean']; tutar = row['Tahsis Tutarƒ±_Clean']
            on_time_qty = 0; late_qty = 0; return_qty = 0; reklamasyon_tutar = 0; iade_tutar = 0; alim_tutar = 0; alim_qty = 0; rek_qty = 0
            if tip == 'Alƒ±m':
                alim_tutar = tutar; alim_qty = miktar
                if gecikme <= 0: on_time_qty = miktar
                else: late_qty = miktar
            elif tip == 'ƒ∞ade': iade_tutar = tutar; return_qty = miktar
            elif tip == 'Reklamasyon': reklamasyon_tutar = tutar; rek_qty = miktar
            return pd.Series([on_time_qty, late_qty, return_qty, reklamasyon_tutar, iade_tutar, alim_tutar, alim_qty, rek_qty])

        df[['On_Time_Miktar', 'Geciken_Miktar', 'Iade_Edilen_Miktar', 'Reklamasyon_Tutari', 'Iade_Tutari', 'Alim_Tutari', 'Alim_Miktar', 'Reklamasyon_Miktar']] = df.apply(calculate_metrics, axis=1)

        def get_reklamasyon_sebebi_tutar(row):
            if row['Islem_Tipi'] not in ['ƒ∞ade', 'Reklamasyon']: return 0, 0
            aciklama = str(row.get("A√ßƒ±klama", "")).lower(); detay_sebep = str(row.get("Stok Fi≈üi Detay Reklamasyon Sebepleri", "")).lower()
            tutar = row['Tahsis Tutarƒ±_Clean']
            if "gecikme" in aciklama or "termin" in aciklama or "gecikme" in detay_sebep: return tutar, 0
            elif "kalite" in detay_sebep: return 0, tutar
            else: return 0, 0 

        df[['Kesinti_Gecikme', 'Kesinti_Kalite']] = df.apply(lambda r: pd.Series(get_reklamasyon_sebebi_tutar(r)), axis=1)
        if "Order Grup Adƒ±" in df.columns: df["Order Grup Adƒ±"] = df["Order Grup Adƒ±"].fillna("Diƒüer")
        else: df["Order Grup Adƒ±"] = "Diƒüer"
        df_reklamasyon_global = df
        return True, f"Reklamasyon verisi y√ºklendi: {len(df)} satƒ±r."
    except Exception as e:
        df_reklamasyon_global = create_reklamasyon_dummy_data()
        return False, str(e)

# Reklamasyon Y√∂netici √ñzeti (Dashboard)
def draw_rek_dashboard(parent):
    """Reklamasyon Y√∂netici Dashboard'ƒ±nƒ± √ßizer"""
    for widget in parent.winfo_children(): widget.destroy()
    top_bar = tk.Frame(parent, bg="white", padx=20, pady=15, bd=1, relief="raised"); top_bar.pack(fill="x")
    tk.Label(top_bar, text="üìä REK LAMASYON Y√ñNETƒ∞Cƒ∞ √ñZETƒ∞", font=("Segoe UI", 16, "bold"), fg="#2c3e50", bg="white").pack(side="left")
    
    # Butonlar
    btn_frame = tk.Frame(top_bar, bg="white"); btn_frame.pack(side="right", padx=10)
    tk.Button(btn_frame, text="üìß Raporu Mail At", bg="#8e44ad", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: show_page("Rek Mail Merkezi")).pack(side="left", padx=5)
    
    tk.Label(top_bar, text="Tedarik√ßi:", font=("Segoe UI", 10), bg="white", fg="gray").pack(side="right", padx=5)
    all_suppliers = sorted(df_reklamasyon_global["Cari Adƒ±"].unique().astype(str)) if df_reklamasyon_global is not None else []
    cari_var = tk.StringVar(value="T√ºm√º"); cari_combo = ttk.Combobox(top_bar, values=["T√ºm√º"] + list(all_suppliers), textvariable=cari_var, state="readonly", width=25)
    cari_combo.pack(side="right", padx=5)
    
    canvas = tk.Canvas(parent, bg="#ecf0f1"); scrollbar = ttk.Scrollbar(parent, orient="vertical", command=canvas.yview)
    scrollable_frame = tk.Frame(canvas, bg="#ecf0f1")
    scrollable_frame.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
    canvas.create_window((0, 0), window=scrollable_frame, anchor="nw"); canvas.configure(yscrollcommand=scrollbar.set)
    canvas.pack(side="left", fill="both", expand=True); scrollbar.pack(side="right", fill="y")

    current_dash_data = None
    def refresh_content(event=None):
        nonlocal current_dash_data
        for w in scrollable_frame.winfo_children(): w.destroy()
        sel_cari = cari_combo.get()
        df_d = df_reklamasyon_global.copy() if sel_cari == "T√ºm√º" else df_reklamasyon_global[df_reklamasyon_global["Cari Adƒ±"] == sel_cari]
        current_dash_data = df_d

        kpi_frame = tk.Frame(scrollable_frame, bg="#ecf0f1"); kpi_frame.pack(fill="x", pady=10, padx=10)
        t_alim_tut = df_d["Alim_Tutari"].sum(); t_iade_tut = df_d["Iade_Tutari"].sum(); t_rek_tut = df_d["Reklamasyon_Tutari"].sum()
        t_risk = t_iade_tut + t_rek_tut
        
        def draw_kpi(col, title, val1, val2, color):
            card = tk.Frame(kpi_frame, bg="white", bd=0, relief="flat", padx=15, pady=15)
            card.grid(row=0, column=col, sticky="ew", padx=10); kpi_frame.grid_columnconfigure(col, weight=1)
            tk.Frame(card, bg=color, width=5).pack(side="left", fill="y", padx=(0,10))
            tk.Label(card, text=title, font=("Segoe UI", 10, "bold"), fg="#95a5a6", bg="white").pack(anchor="w")
            tk.Label(card, text=val1, font=("Segoe UI", 18, "bold"), fg="#2c3e50", bg="white").pack(anchor="w")
            if val2: tk.Label(card, text=val2, font=("Segoe UI", 9), fg=color, bg="white").pack(anchor="w")

        draw_kpi(0, "TOPLAM ALIM HACMƒ∞", f"{t_alim_tut:,.0f} ‚Ç∫", f"{df_d['Alim_Miktar'].sum():,.0f} Birim", "#27ae60")
        draw_kpi(1, "TOPLAM Rƒ∞SK (ƒ∞ade+Rek.)", f"{t_risk:,.0f} ‚Ç∫", f"ƒ∞ade: {t_iade_tut:,.0f} | Rek: {t_rek_tut:,.0f}", "#c0392b")
        draw_kpi(2, "ƒ∞ADE TUTARI (Fatura)", f"{t_iade_tut:,.0f} ‚Ç∫", f"{df_d['Iade_Edilen_Miktar'].sum():,.0f} Birim", "#f39c12")
        draw_kpi(3, "KESƒ∞LEN REKLAMASYON", f"{t_rek_tut:,.0f} ‚Ç∫", f"{df_d['Reklamasyon_Miktar'].sum():,.0f} Birim", "#8e44ad")

        chart_frame = tk.Frame(scrollable_frame, bg="#ecf0f1"); chart_frame.pack(fill="x", pady=10, padx=20)
        fig = plt.figure(figsize=(10, 4), dpi=100)
        ax1 = fig.add_subplot(121)
        if not df_d.empty:
            df_d.groupby("Cari Adƒ±")[["Iade_Tutari", "Reklamasyon_Tutari"]].sum().sum(axis=1).sort_values(ascending=False).head(5).plot(kind="bar", ax=ax1, color="#e74c3c", alpha=0.8)
        ax1.set_title("En Y√ºksek Riskli 5 Tedarik√ßi"); ax1.set_xlabel(""); plt.setp(ax1.xaxis.get_majorticklabels(), rotation=45, ha="right", fontsize=8)
        ax2 = fig.add_subplot(122); sizes = [t_iade_tut, t_rek_tut]
        if sum(sizes) > 0: ax2.pie(sizes, labels=['ƒ∞ade', 'Reklamasyon'], autopct='%1.1f%%', colors=['#f39c12', '#8e44ad'], startangle=90)
        else: ax2.text(0.5, 0.5, "Veri Yok", ha='center')
        ax2.set_title("Risk Daƒüƒ±lƒ±mƒ±")
        plt.tight_layout(); canvas_fig = FigureCanvasTkAgg(fig, master=chart_frame); canvas_fig.draw(); canvas_fig.get_tk_widget().pack(fill="both", expand=True)

    btn_ex = tk.Button(btn_frame, text="Excel ƒ∞ndir", bg="#27ae60", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: export_rek_df_to_excel(current_dash_data, "Rek_Dashboard"))
    btn_ex.pack(side="left", padx=5)
    btn_pdf = tk.Button(btn_frame, text="PDF ƒ∞ndir", bg="#c0392b", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: export_rek_df_to_pdf(current_dash_data.head(50) if current_dash_data is not None else pd.DataFrame(), "Reklamasyon Y√∂netici √ñzeti", "Rek_Dashboard"))
    btn_pdf.pack(side="left", padx=5)

    cari_combo.bind("<<ComboboxSelected>>", refresh_content); refresh_content()

# Detaylƒ± Reklamasyon Raporu
def init_rek_detailed_report_tab():
    """Detaylƒ± reklamasyon raporu sekmesi"""
    for widget in frame_rek_detayli.winfo_children(): widget.destroy()
    notebook = ttk.Notebook(frame_rek_detayli); notebook.pack(fill="both", expand=True, padx=10, pady=5)
    tab_detay = tk.Frame(notebook, bg="white"); notebook.add(tab_detay, text=" üìã Detaylƒ± Operasyonel Liste ")
    tab_ozet = tk.Frame(notebook, bg="white"); notebook.add(tab_ozet, text=" üìä Y√∂netici √ñzeti (Takƒ±m Bazlƒ±) ")

    def setup_detail_tab():
        filter_frame = tk.Frame(tab_detay, bg="#f8f9fa", padx=10, pady=15, bd=1, relief="solid")
        filter_frame.pack(fill="x", padx=10, pady=5)
        
        tk.Label(filter_frame, text="Hƒ±zlƒ± Filtre:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=(0,5))
        status_var = tk.StringVar(value="T√ºm√º")
        cb_status = ttk.Combobox(filter_frame, textvariable=status_var, state="readonly", values=["T√ºm√º", "Geciken Sipari≈üler", "Zamanƒ±nda Teslim", "ƒ∞ade Olanlar", "Reklamasyon Olanlar"])
        cb_status.pack(side="left", padx=5)

        tk.Label(filter_frame, text="|  Detaylƒ± Arama:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=15)
        search_col_var = tk.StringVar(value="T√ºm√º")
        cols_map = {"Tedarik√ßi": "Cari Adƒ±", "Order No": "Order No", "Takƒ±m": "Order Grup Adƒ±", "Stok Adƒ±": "Stok Adƒ±", "Parti No": "Parti/Lab No"}
        cb_col = ttk.Combobox(filter_frame, textvariable=search_col_var, state="readonly", values=["T√ºm√º"] + list(cols_map.keys()), width=15)
        cb_col.pack(side="left", padx=5)
        entry_search = ttk.Entry(filter_frame, width=30); entry_search.pack(side="left", padx=5)
        
        # Sorumlu Ata Butonu
        btn_assign = tk.Button(filter_frame, text="üë§ Sorumlu Ata", bg="#9b59b6", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: assign_responsible())
        btn_assign.pack(side="right", padx=5)
        
        # Export Buttons
        btn_xls = tk.Button(filter_frame, text="Excel", bg="#27ae60", fg="white", font=("Segoe UI", 8), command=lambda: export_rek_df_to_excel(current_data_detail, "Rek_Detayli"))
        btn_xls.pack(side="right", padx=5)
        btn_pdf = tk.Button(filter_frame, text="PDF", bg="#c0392b", fg="white", font=("Segoe UI", 8), command=lambda: export_rek_df_to_pdf(current_data_detail, "Detaylƒ± Reklamasyon Raporu", "Rek_Detayli"))
        btn_pdf.pack(side="right", padx=5)

        tree_frame = tk.Frame(tab_detay); tree_frame.pack(fill="both", expand=True, padx=10, pady=5)
        cols = ["‚òë", "Tedarik√ßi", "Order No", "Takƒ±m", "Parti No", "Stok Adƒ±", "Fi≈ü No", "Fi≈ü Tarihi", "M√º≈ü. Gecikme", "Sip. Gecikme", "Kesilmesi Gereken Ceza", "Reklamasyon Edilmesi Tutar", "On Time Mik.", "Geciken Mik.", "ƒ∞ade Mik.", "ƒ∞ade Tutar", "Rek. Mik.", "Rek. Tutar", "Net Mik.", "Rek. Oranƒ±"]
        tree = ttk.Treeview(tree_frame, columns=cols, show="headings", height=15)
        vsb = ttk.Scrollbar(tree_frame, orient="vertical", command=tree.yview); hsb = ttk.Scrollbar(tree_frame, orient="horizontal", command=tree.xview)
        tree.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)
        tree.grid(column=0, row=0, sticky='nsew'); vsb.grid(column=1, row=0, sticky='ns'); hsb.grid(column=0, row=1, sticky='ew')
        tree_frame.grid_columnconfigure(0, weight=1); tree_frame.grid_rowconfigure(0, weight=1)

        for c in cols:
            tree.heading(c, text=c)
            if c == "‚òë": tree.column(c, anchor="center", width=40)
            elif "Mik" in c or "Oran" in c or "Tutar" in c or "Gecikme" in c or "Ceza" in c or "Edilmesi" in c: tree.column(c, anchor="e", width=100)
            else: tree.column(c, anchor="w", width=120)
        
        # Checkbox durumlarƒ±nƒ± saklayacak dictionary
        checkbox_states = {}
        
        def toggle_checkbox(event):
            """Checkbox toggle i≈ülemi"""
            item = tree.identify_row(event.y)
            column = tree.identify_column(event.x)
            if item and column == '#1':  # ƒ∞lk kolon (checkbox)
                current_val = tree.item(item, 'values')[0]
                new_val = '‚òê' if current_val == '‚òë' else '‚òë'
                values = list(tree.item(item, 'values'))
                values[0] = new_val
                tree.item(item, values=values)
                checkbox_states[item] = (new_val == '‚òë')
        
        tree.bind('<Button-1>', toggle_checkbox)
        
        current_data_detail = pd.DataFrame()
        current_row_data = {}  # Her satƒ±rƒ±n tam verisini saklamak i√ßin

        def apply_filters(event=None):
            nonlocal current_data_detail, current_row_data
            for i in tree.get_children(): tree.delete(i)
            checkbox_states.clear()
            current_row_data.clear()
            if df_reklamasyon_global is None: return

            df_proc = df_reklamasyon_global.copy()
            num_cols = ["Alim_Miktar", "Alim_Tutari", "Iade_Edilen_Miktar", "Iade_Tutari", "Reklamasyon_Miktar", "Reklamasyon_Tutari", "Siparis_Gecikme", "Musteri_Gecikme", "On_Time_Miktar", "Geciken_Miktar"]
            for col in num_cols:
                if col in df_proc.columns: df_proc[col] = pd.to_numeric(df_proc[col], errors='coerce').fillna(0)

            if "Fi≈ü Tarihi" in df_proc.columns:
                df_proc["Fi≈ü_Tarihi_Str"] = df_proc["Fi≈ü Tarihi"].apply(lambda x: x.strftime('%d.%m.%Y') if pd.notna(x) else "")
            else: df_proc["Fi≈ü_Tarihi_Str"] = ""
            if "Sipari≈ü Fi≈üi Fi≈ü No" not in df_proc.columns: df_proc["Sipari≈ü Fi≈üi Fi≈ü No"] = ""

            obj_cols = df_proc.select_dtypes(include=['object']).columns
            df_proc[obj_cols] = df_proc[obj_cols].fillna("Bilinmiyor")
            
            grp = df_proc.groupby(["Cari Adƒ±", "Order No", "Order Grup Adƒ±", "Parti/Lab No", "Stok Adƒ±", "Sipari≈ü Fi≈üi Fi≈ü No", "Fi≈ü_Tarihi_Str"]).agg({
                "Musteri_Gecikme": "max", "Siparis_Gecikme": "max", "On_Time_Miktar": "sum", "Geciken_Miktar": "sum", "Iade_Edilen_Miktar": "sum", 
                "Alim_Miktar": "sum", "Reklamasyon_Miktar": "sum", "Alim_Tutari": "sum", "Iade_Tutari": "sum", "Reklamasyon_Tutari": "sum"
            }).reset_index()

            status = status_var.get()
            if status == "Geciken Sipari≈üler": grp = grp[grp["Siparis_Gecikme"] > 0]
            elif status == "Zamanƒ±nda Teslim": grp = grp[grp["Siparis_Gecikme"] <= 0]
            elif status == "ƒ∞ade Olanlar": grp = grp[(grp["Iade_Tutari"] > 0) | (grp["Iade_Edilen_Miktar"] > 0)]
            elif status == "Reklamasyon Olanlar": grp = grp[(grp["Reklamasyon_Tutari"] > 0) | (grp["Reklamasyon_Miktar"] > 0)]

            txt = entry_search.get().lower()
            if txt:
                s_col = search_col_var.get()
                if s_col == "T√ºm√º":
                    mask = grp.apply(lambda x: txt in str(x["Cari Adƒ±"]).lower() or txt in str(x["Order No"]).lower() or txt in str(x["Order Grup Adƒ±"]).lower() or txt in str(x["Parti/Lab No"]).lower() or txt in str(x["Stok Adƒ±"]).lower(), axis=1)
                    grp = grp[mask]
                else:
                    target = cols_map.get(s_col, s_col)
                    if target in grp.columns: grp = grp[grp[target].astype(str).str.lower().str.contains(txt, na=False)]
            
            current_data_detail = grp 

            for idx, row in grp.iterrows():
                net_mik = row["Alim_Miktar"] - row["Iade_Edilen_Miktar"]
                total_risk = row["Iade_Tutari"] + row["Reklamasyon_Tutari"]
                oran = (total_risk / row["Alim_Tutari"] * 100) if row["Alim_Tutari"] > 0 else 0
                s_gec = int(row["Siparis_Gecikme"]); m_gec = int(row["Musteri_Gecikme"])
                
                # Ceza hesaplama
                ceza_orani = 0.0
                if s_gec > 0:
                    if s_gec < 7: ceza_orani = 0.05
                    elif 7 <= s_gec <= 15: ceza_orani = 0.10
                    else: ceza_orani = 0.25
                ceza_tutari = (row["Alim_Tutari"] - row["Iade_Tutari"]) * ceza_orani
                
                # Reklamasyon edilmesi tutar (ƒ∞ade + Reklamasyon + Ceza)
                reklamasyon_edilmesi_tutar = row["Iade_Tutari"] + row["Reklamasyon_Tutari"] + ceza_tutari

                vals = ('‚òê', row["Cari Adƒ±"], row["Order No"], row["Order Grup Adƒ±"], row["Parti/Lab No"], row["Stok Adƒ±"], row["Sipari≈ü Fi≈üi Fi≈ü No"], row["Fi≈ü_Tarihi_Str"], m_gec, s_gec,
                        f"‚Ç∫{ceza_tutari:,.0f}",
                        f"‚Ç∫{reklamasyon_edilmesi_tutar:,.0f}",
                        f"{row['On_Time_Miktar']:,.0f}", f"{row['Geciken_Miktar']:,.0f}", f"{row['Iade_Edilen_Miktar']:,.0f}", f"{row['Iade_Tutari']:,.0f}",
                        f"{row['Reklamasyon_Miktar']:,.0f}", f"{row['Reklamasyon_Tutari']:,.0f}", f"{net_mik:,.0f}", f"%{oran:.2f}")
                tags = []
                if s_gec > 0: tags.append('late')
                if row['Iade_Tutari'] > 0: tags.append('return')
                if row['Reklamasyon_Tutari'] > 0: tags.append('reclaim')
                item_id = tree.insert("", "end", values=vals, tags=tuple(tags))
                
                # Satƒ±r verisini sakla
                current_row_data[item_id] = {
                    'Tedarik√ßi': row["Cari Adƒ±"],
                    'Order No': row["Order No"],
                    'Takƒ±m': row["Order Grup Adƒ±"],
                    'Parti No': row["Parti/Lab No"],
                    'Stok Adƒ±': row["Stok Adƒ±"],
                    'Siparis_Gecikme': s_gec,
                    'Musteri_Gecikme': m_gec,
                    'Iade_Tutari': row['Iade_Tutari'],
                    'Reklamasyon_Tutari': row['Reklamasyon_Tutari'],
                    'Alim_Tutari': row['Alim_Tutari'],
                    'Ceza_Tutari': ceza_tutari,
                    'Reklamasyon_Edilmesi_Tutar': reklamasyon_edilmesi_tutar
                }
            
            tree.tag_configure('late', foreground='#c0392b') 
            tree.tag_configure('return', background='#fff3e0') 
            tree.tag_configure('reclaim', background='#ffebee')

        def assign_responsible():
            """Se√ßili satƒ±rlar i√ßin sorumlu atama ve AI mail taslaƒüƒ± olu≈üturma"""
            selected_items = [item for item, checked in checkbox_states.items() if checked]
            
            if not selected_items:
                messagebox.showwarning("Uyarƒ±", "L√ºtfen en az bir satƒ±r se√ßin!")
                return
            
            # Se√ßili satƒ±rlarƒ±n bilgilerini topla
            selected_data = []
            for item in selected_items:
                if item in current_row_data:
                    selected_data.append(current_row_data[item])
            
            if not selected_data:
                messagebox.showerror("Hata", "Se√ßili satƒ±r verileri bulunamadƒ±!")
                return
            
            # AI mail taslaƒüƒ± olu≈üturma penceresi
            draft_window = tk.Toplevel(root)
            draft_window.title("Sorumlu Atama - AI Mail Taslaƒüƒ±")
            draft_window.geometry("800x700")
            draft_window.configure(bg="#ecf0f1")
            
            # Ba≈ülƒ±k
            header = tk.Frame(draft_window, bg="#34495e", padx=20, pady=15)
            header.pack(fill="x")
            tk.Label(header, text="ü§ñ Yapay Zeka Destekli Mail Taslaƒüƒ±", font=("Segoe UI", 14, "bold"), fg="white", bg="#34495e").pack()
            
            # ƒ∞√ßerik
            content = tk.Frame(draft_window, bg="#ecf0f1", padx=20, pady=20)
            content.pack(fill="both", expand=True)
            
            # Se√ßili kayƒ±t sayƒ±sƒ±
            tk.Label(content, text=f"‚úì Se√ßili Kayƒ±t: {len(selected_data)}", font=("Segoe UI", 10, "bold"), bg="#ecf0f1", fg="#27ae60").pack(anchor="w", pady=(0,10))
            
            # Mail adresi giri≈üi
            mail_frame = tk.Frame(content, bg="#ecf0f1")
            mail_frame.pack(fill="x", pady=(0,10))
            tk.Label(mail_frame, text="üìß Alƒ±cƒ± Email:", font=("Segoe UI", 10, "bold"), bg="#ecf0f1").pack(side="left", padx=(0,10))
            email_entry = ttk.Entry(mail_frame, width=40, font=("Segoe UI", 10))
            email_entry.pack(side="left", padx=5)
            email_entry.insert(0, GMAIL_RECEIVER_LOGS if GMAIL_RECEIVER_LOGS else "")
            
            # Mail taslaƒüƒ± text alanƒ±
            tk.Label(content, text="Mail Taslaƒüƒ±:", font=("Segoe UI", 10, "bold"), bg="#ecf0f1").pack(anchor="w", pady=(10,5))
            text_frame = tk.Frame(content)
            text_frame.pack(fill="both", expand=True, pady=5)
            
            text_scroll = ttk.Scrollbar(text_frame)
            text_scroll.pack(side="right", fill="y")
            
            draft_text = tk.Text(text_frame, wrap="word", font=("Segoe UI", 10), yscrollcommand=text_scroll.set, height=15)
            draft_text.pack(side="left", fill="both", expand=True)
            text_scroll.configure(command=draft_text.yview)
            
            draft_text.insert("1.0", "AI taslak olu≈üturuluyor, l√ºtfen bekleyin...")
            draft_text.configure(state="disabled")
            
            # Butonlar
            btn_frame = tk.Frame(content, bg="#ecf0f1")
            btn_frame.pack(fill="x", pady=10)
            
            def copy_to_clipboard():
                root.clipboard_clear()
                root.clipboard_append(draft_text.get("1.0", "end-1c"))
                messagebox.showinfo("Ba≈üarƒ±lƒ±", "Mail taslaƒüƒ± panoya kopyalandƒ±!")
            
            def send_email_now():
                """Mail'i hemen g√∂nder"""
                recipient = email_entry.get().strip()
                if not recipient:
                    messagebox.showwarning("Uyarƒ±", "L√ºtfen alƒ±cƒ± email adresi girin!")
                    return
                
                if not GMAIL_USER or not GMAIL_APP_PASSWORD:
                    messagebox.showerror("Hata", "Email ayarlarƒ± yapƒ±landƒ±rƒ±lmamƒ±≈ü!")
                    return
                
                try:
                    # Mail i√ßeriƒüini al
                    mail_body = draft_text.get("1.0", "end-1c")
                    
                    # Konu satƒ±rƒ±nƒ± belirle
                    lines = mail_body.split('\n')
                    subject = "Reklamasyon Sorumlu Atamasƒ±"
                    for line in lines:
                        if line.startswith("Konu:"):
                            subject = line.replace("Konu:", "").strip()
                            break
                    
                    # Email g√∂nder
                    msg = MIMEMultipart()
                    msg['From'] = GMAIL_USER
                    msg['To'] = recipient
                    msg['Subject'] = subject
                    msg.attach(MIMEText(mail_body, 'plain', 'utf-8'))
                    
                    server = smtplib.SMTP('smtp.gmail.com', 587)
                    server.starttls()
                    server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
                    server.send_message(msg)
                    server.quit()
                    
                    # LOG
                    if activity_logger:
                        activity_logger.log_email_sent(recipient, subject, "Rek Detaylƒ± Rapor")
                    
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", f"Mail ba≈üarƒ±yla g√∂nderildi!\nAlƒ±cƒ±: {recipient}")
                    draft_window.destroy()
                    
                except Exception as e:
                    messagebox.showerror("Hata", f"Mail g√∂nderilemedi:\n{str(e)}")
                    if activity_logger:
                        activity_logger.log_error(f"Mail g√∂nderim hatasƒ±: {str(e)}", "Rek Detaylƒ± Rapor")
            
            tk.Button(btn_frame, text="üìß Mail G√∂nder", bg="#e74c3c", fg="white", font=("Segoe UI", 10, "bold"), padx=20, pady=8, command=send_email_now).pack(side="left", padx=5)
            tk.Button(btn_frame, text="üìã Panoya Kopyala", bg="#3498db", fg="white", font=("Segoe UI", 10), padx=20, pady=8, command=copy_to_clipboard).pack(side="left", padx=5)
            tk.Button(btn_frame, text="‚úñ Kapat", bg="#95a5a6", fg="white", font=("Segoe UI", 10), padx=20, pady=8, command=draft_window.destroy).pack(side="right", padx=5)
            
            # AI taslak olu≈üturma (thread'de)
            def generate_draft():
                try:
                    # Sorun analizi
                    problems = []
                    total_reclamation_amount = 0
                    for data in selected_data:
                        if data['Siparis_Gecikme'] > 0:
                            problems.append(f"Termin Gecikmesi ({data['Siparis_Gecikme']} g√ºn, Ceza: ‚Ç∫{data.get('Ceza_Tutari', 0):,.0f})")
                        if data['Iade_Tutari'] > 0:
                            problems.append(f"ƒ∞ade Durumu (‚Ç∫{data['Iade_Tutari']:,.0f})")
                        if data['Reklamasyon_Tutari'] > 0:
                            problems.append(f"Reklamasyon (‚Ç∫{data['Reklamasyon_Tutari']:,.0f})")
                        total_reclamation_amount += data.get('Reklamasyon_Edilmesi_Tutar', 0)
                    
                    problem_summary = ", ".join(set(problems))
                    
                    # Sorumlu alanƒ± belirleme
                    responsible_area = "Termin Y√∂netimi ve Planlama"
                    if any(d['Iade_Tutari'] > 0 or d['Reklamasyon_Tutari'] > 0 for d in selected_data):
                        responsible_area = "Kalite Kontrol ve Reklamasyon Y√∂netimi"
                    elif any(d['Siparis_Gecikme'] > 0 for d in selected_data):
                        responsible_area = "Termin Y√∂netimi ve Planlama"
                    
                    # AI prompt hazƒ±rlama
                    if GEMINI_API_KEY:
                        prompt = f"""Bir tedarik zinciri y√∂neticisi olarak, a≈üaƒüƒ±daki reklamasyon kayƒ±tlarƒ± i√ßin sorumlu ekibe g√∂nderilecek profesyonel bir mail taslaƒüƒ± hazƒ±rla.

Se√ßili Kayƒ±t Sayƒ±sƒ±: {len(selected_data)}
Tespit Edilen Sorunlar: {problem_summary}
Toplam Reklamasyon Edilmesi Gereken Tutar: ‚Ç∫{total_reclamation_amount:,.0f}
Sorumlu Alan: {responsible_area}

Detaylar:
"""
                        for i, data in enumerate(selected_data, 1):
                            prompt += f"\n{i}. Tedarik√ßi: {data['Tedarik√ßi']}, Order: {data['Order No']}, Takƒ±m: {data['Takƒ±m']}"
                            if data['Siparis_Gecikme'] > 0:
                                prompt += f", Gecikme: {data['Siparis_Gecikme']} g√ºn (Ceza: ‚Ç∫{data.get('Ceza_Tutari', 0):,.0f})"
                            if data['Reklamasyon_Tutari'] > 0:
                                prompt += f", Reklamasyon: ‚Ç∫{data['Reklamasyon_Tutari']:,.0f}"
                            if data.get('Reklamasyon_Edilmesi_Tutar', 0) > 0:
                                prompt += f", Toplam Edilmesi Gereken: ‚Ç∫{data.get('Reklamasyon_Edilmesi_Tutar', 0):,.0f}"
                        
                        prompt += """\n\nMail taslaƒüƒ±nda:
1. Konu satƒ±rƒ±nƒ± belirt
2. Profesyonel ve nazik bir ton kullan
3. Sorunu net bir ≈üekilde a√ßƒ±kla
4. Sorumlu alanƒ± belirt
5. Beklenen aksiyonlarƒ± listele
6. Termin belirt
7. ƒ∞mza i√ßin yer bƒ±rak

Mail dilini T√ºrk√ße kullan ve profesyonel i≈ü ortamƒ±na uygun yaz."""
                        
                        # Gemini API √ßaƒürƒ±sƒ±
                        url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={GEMINI_API_KEY}"
                        headers = {'Content-Type': 'application/json'}
                        payload = {
                            "contents": [{
                                "parts": [{"text": prompt}]
                            }]
                        }
                        
                        response = requests.post(url, headers=headers, json=payload, timeout=30)
                        
                        if response.status_code == 200:
                            result = response.json()
                            ai_draft = result['candidates'][0]['content']['parts'][0]['text']
                        else:
                            ai_draft = f"AI yanƒ±t alƒ±namadƒ±. Hata: {response.status_code}"
                    else:
                        # Fallback: API key yoksa manuel taslak
                        ai_draft = f"""Konu: Acil - {responsible_area} Gereksinimi

Sayƒ±n Yetkili,

{len(selected_data)} adet sipari≈ü kaydƒ±nda tespit edilen sorunlar hakkƒ±nda bilgilendirme yapmak isteriz.

Tespit Edilen Sorunlar:
{problem_summary}

Detaylar:
"""
                        for i, data in enumerate(selected_data, 1):
                            ai_draft += f"\n{i}. Tedarik√ßi: {data['Tedarik√ßi']}"
                            ai_draft += f"\n   Order No: {data['Order No']}"
                            ai_draft += f"\n   Takƒ±m: {data['Takƒ±m']}"
                            if data['Siparis_Gecikme'] > 0:
                                ai_draft += f"\n   ‚ö†Ô∏è Termin Gecikmesi: {data['Siparis_Gecikme']} g√ºn"
                            if data['Reklamasyon_Tutari'] > 0:
                                ai_draft += f"\n   ‚ö†Ô∏è Reklamasyon Tutarƒ±: ‚Ç∫{data['Reklamasyon_Tutari']:,.0f}"
                            if data['Iade_Tutari'] > 0:
                                ai_draft += f"\n   ‚ö†Ô∏è ƒ∞ade Tutarƒ±: ‚Ç∫{data['Iade_Tutari']:,.0f}"
                            ai_draft += "\n"
                        
                        ai_draft += f"""\nSorumlu Alan: {responsible_area}

Beklenen Aksiyonlar:
1. Durumun acil olarak deƒüerlendirilmesi
2. Tedarik√ßi ile ileti≈üime ge√ßilmesi
3. D√ºzeltici √∂nlemlerin alƒ±nmasƒ±
4. 3 i≈ü g√ºn√º i√ßinde geri bildirim verilmesi

Konuyla ilgili destek i√ßin ileti≈üime ge√ßebilirsiniz.

Saygƒ±larƒ±mƒ±zla,
[ƒ∞mza]"""
                    
                    # Text alanƒ±nƒ± g√ºncelle
                    draft_text.configure(state="normal")
                    draft_text.delete("1.0", "end")
                    draft_text.insert("1.0", ai_draft)
                    draft_text.configure(state="normal")  # D√ºzenlenebilir bƒ±rak
                    
                    # LOG
                    if activity_logger:
                        activity_logger.log_event("AI_DRAFT_GENERATED", f"{len(selected_data)} kayƒ±t i√ßin mail taslaƒüƒ± olu≈üturuldu", "Rek Detaylƒ± Rapor")
                    
                except Exception as e:
                    draft_text.configure(state="normal")
                    draft_text.delete("1.0", "end")
                    draft_text.insert("1.0", f"Hata olu≈ütu: {str(e)}\n\nL√ºtfen tekrar deneyin veya manuel olarak mail olu≈üturun.")
                    if activity_logger:
                        activity_logger.log_error(f"AI draft hatasƒ±: {str(e)}", "Rek Detaylƒ± Rapor")
            
            # Thread'de √ßalƒ±≈ütƒ±r
            threading.Thread(target=generate_draft, daemon=True).start()

        cb_status.bind("<<ComboboxSelected>>", apply_filters)
        entry_search.bind("<KeyRelease>", apply_filters)
        apply_filters()

    def setup_summary_tab():
        exp_frame = tk.Frame(tab_ozet, bg="white", pady=5); exp_frame.pack(fill="x", padx=10)
        current_summary1 = pd.DataFrame(); current_summary2 = pd.DataFrame()
        btn_xls = tk.Button(exp_frame, text="T√ºm √ñzeti Excel'e Aktar", bg="#27ae60", fg="white", font=("Segoe UI", 9), command=lambda: export_rek_df_to_excel(current_summary1 if not current_summary1.empty else current_summary2, "Rek_Yonetici_Ozeti")); btn_xls.pack(side="right", padx=5)
        btn_pdf = tk.Button(exp_frame, text="PDF Yap", bg="#c0392b", fg="white", font=("Segoe UI", 9), command=lambda: export_rek_df_to_pdf(current_summary1 if not current_summary1.empty else current_summary2, "Reklamasyon Y√∂netici √ñzeti", "Rek_Yonetici_Raporu")); btn_pdf.pack(side="right", padx=5)

        df_rek = df_reklamasyon_global[df_reklamasyon_global["Islem_Tipi"].isin(["ƒ∞ade", "Reklamasyon"])].copy() if df_reklamasyon_global is not None else pd.DataFrame()
        df_proc = df_reklamasyon_global.copy() if df_reklamasyon_global is not None else pd.DataFrame()
        
        # --- T√úM VERƒ∞Yƒ∞ KAPSAYAN MERGE HAZIRLIƒûI ---
        # 1. Ceza Verisi (Gecikme olan t√ºm satƒ±rlardan)
        ceza_summary = pd.DataFrame(columns=["Order Grup Adƒ±", "Cari Adƒ±", "Row_Ceza"])
        if not df_proc.empty:
             for col in ["Alim_Tutari", "Iade_Tutari", "Siparis_Gecikme"]:
                 if col in df_proc.columns: df_proc[col] = df_proc[col].fillna(0)
             # Order bazƒ±nda gecikme ve cezayƒ± hesapla
             grp_det = df_proc.groupby(["Cari Adƒ±", "Order No", "Order Grup Adƒ±"]).agg({"Siparis_Gecikme": "max", "Alim_Tutari": "sum", "Iade_Tutari": "sum"}).reset_index()
             def calc_penalty(r):
                 s_gec = r["Siparis_Gecikme"]; ceza_orani = 0.0
                 if s_gec > 0:
                     if s_gec < 7: ceza_orani = 0.05
                     elif 7 <= s_gec <= 15: ceza_orani = 0.10
                     else: ceza_orani = 0.25
                 return (r["Alim_Tutari"] - r["Iade_Tutari"]) * ceza_orani
             grp_det["Row_Ceza"] = grp_det.apply(calc_penalty, axis=1)
             ceza_summary = grp_det.groupby(["Order Grup Adƒ±", "Cari Adƒ±"])["Row_Ceza"].sum().reset_index()

        # 2. ƒ∞ade/Reklamasyon Verisi
        rek_summary = pd.DataFrame(columns=["Order Grup Adƒ±", "Cari Adƒ±", "Reklamasyon_Tutari", "Iade_Tutari", "Kesinti_Gecikme", "Kesinti_Kalite"])
        if not df_rek.empty:
            rek_summary = df_rek.groupby(["Order Grup Adƒ±", "Cari Adƒ±"]).agg({"Reklamasyon_Tutari": "sum", "Iade_Tutari": "sum", "Kesinti_Gecikme": "sum", "Kesinti_Kalite": "sum"}).reset_index()

        # 3. OUTER MERGE (Kapsayƒ±cƒ± Birle≈ütirme)
        # Hem ceza verisini hem de iade/reklamasyon verisini kaybetmemek i√ßin outer join yapƒ±yoruz.
        if ceza_summary.empty and rek_summary.empty:
             merged_data = pd.DataFrame(columns=["Order Grup Adƒ±", "Cari Adƒ±", "Row_Ceza", "Reklamasyon_Tutari", "Iade_Tutari", "Kesinti_Gecikme", "Kesinti_Kalite"])
        else:
             merged_data = pd.merge(rek_summary, ceza_summary, on=["Order Grup Adƒ±", "Cari Adƒ±"], how="outer").fillna(0)
        
        current_summary1 = merged_data # Export i√ßin

        f1 = tk.LabelFrame(tab_ozet, text="1. Takƒ±m ve Tedarik√ßi Detaylƒ± Analiz", font=("Segoe UI", 10, "bold"), bg="white", padx=10, pady=5); f1.pack(fill="both", expand=True, padx=10, pady=5)
        cols1 = ["Takƒ±m", "Cari Adƒ±", "Kesilmesi Gereken (Ceza)", "Reklamasyon Tutarƒ± (52)", "ƒ∞ade Tutarƒ± (63)", "Kesilen Reklamasyon - Gecikme", "Kesilen Reklamasyon - Kalite"]
        t1 = ttk.Treeview(f1, columns=cols1, show="headings", height=6)
        sb1 = ttk.Scrollbar(f1, orient="vertical", command=t1.yview); t1.configure(yscrollcommand=sb1.set)
        t1.grid(row=0, column=0, sticky='nsew'); sb1.grid(row=0, column=1, sticky='ns')
        f1.grid_columnconfigure(0, weight=1); f1.grid_rowconfigure(0, weight=1)
        for c in cols1: t1.heading(c, text=c); t1.column(c, anchor="e" if "Tutarƒ±" in c or "Kesilen" in c or "Ceza" in c else "w", width=110)

        t1_ceza=0; t1_rek=0; t1_iade=0; t1_gec=0; t1_kal=0
        for i, r in merged_data.iterrows():
            t1.insert("", "end", values=(r["Order Grup Adƒ±"], r["Cari Adƒ±"], f"‚Ç∫{r['Row_Ceza']:,.0f}", f"‚Ç∫{r['Reklamasyon_Tutari']:,.0f}", f"‚Ç∫{r['Iade_Tutari']:,.0f}", f"‚Ç∫{r['Kesinti_Gecikme']:,.0f}", f"‚Ç∫{r['Kesinti_Kalite']:,.0f}"))
            t1_ceza+=r['Row_Ceza']; t1_rek+=r['Reklamasyon_Tutari']; t1_iade+=r['Iade_Tutari']; t1_gec+=r['Kesinti_Gecikme']; t1_kal+=r['Kesinti_Kalite']
        # Tablo 1 Alt Toplam
        t1.insert("", "end", values=("GENEL TOPLAM", "", f"‚Ç∫{t1_ceza:,.0f}", f"‚Ç∫{t1_rek:,.0f}", f"‚Ç∫{t1_iade:,.0f}", f"‚Ç∫{t1_gec:,.0f}", f"‚Ç∫{t1_kal:,.0f}"), tags=('bold',)); t1.tag_configure('bold', font=('Segoe UI', 10, 'bold'), background='#cfd8dc')


        f2 = tk.LabelFrame(tab_ozet, text="2. Takƒ±m Genel √ñzeti", font=("Segoe UI", 10, "bold"), bg="white", padx=10, pady=5); f2.pack(fill="both", expand=True, padx=10, pady=5)
        cols2 = ["Takƒ±m", "Gereken Ceza (Hesaplanan)", "Reklamasyon Tutarƒ± (52)", "ƒ∞ade Tutarƒ± (63)", "Kesilen Reklamasyon - Gecikme", "Kesilen Reklamasyon - Kalite"]
        t2 = ttk.Treeview(f2, columns=cols2, show="headings", height=6)
        sb2 = ttk.Scrollbar(f2, orient="vertical", command=t2.yview); t2.configure(yscrollcommand=sb2.set)
        t2.grid(row=0, column=0, sticky='nsew'); sb2.grid(row=0, column=1, sticky='ns')
        f2.grid_columnconfigure(0, weight=1); f2.grid_rowconfigure(0, weight=1)
        for c in cols2: t2.heading(c, text=c); t2.column(c, anchor="e" if "Tutarƒ±" in c or "Kesilen" in c or "Ceza" in c else "w", width=120)

        if not merged_data.empty:
            grp2 = merged_data.groupby("Order Grup Adƒ±").agg({"Row_Ceza": "sum", "Reklamasyon_Tutari": "sum", "Iade_Tutari": "sum", "Kesinti_Gecikme": "sum", "Kesinti_Kalite": "sum"}).reset_index()
            current_summary2 = grp2
            t_ceza=0; t_rek=0; t_iade=0; t_gec=0; t_kal=0
            for i, r in grp2.iterrows():
                t2.insert("", "end", values=(r["Order Grup Adƒ±"], f"‚Ç∫{r['Row_Ceza']:,.0f}", f"‚Ç∫{r['Reklamasyon_Tutari']:,.0f}", f"‚Ç∫{r['Iade_Tutari']:,.0f}", f"‚Ç∫{r['Kesinti_Gecikme']:,.0f}", f"‚Ç∫{r['Kesinti_Kalite']:,.0f}"))
                t_ceza+=r['Row_Ceza']; t_rek+=r['Reklamasyon_Tutari']; t_iade+=r['Iade_Tutari']; t_gec+=r['Kesinti_Gecikme']; t_kal+=r['Kesinti_Kalite']
            t2.insert("", "end", values=("TOPLAM", f"‚Ç∫{t_ceza:,.0f}", f"‚Ç∫{t_rek:,.0f}", f"‚Ç∫{t_iade:,.0f}", f"‚Ç∫{t_gec:,.0f}", f"‚Ç∫{t_kal:,.0f}"), tags=('bold',)); t2.tag_configure('bold', font=('Segoe UI', 10, 'bold'), background='#cfd8dc')

    setup_detail_tab(); setup_summary_tab()

# Mail Merkezi
def init_rek_mail_tab():
    """Reklamasyon mail merkezi"""
    for widget in frame_rek_mail.winfo_children(): widget.destroy()

    # Ba≈ülƒ±k
    header = tk.Frame(frame_rek_mail, bg="#2c3e50", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="üìß Reklamasyon Rapor Payla≈üƒ±m Merkezi", font=("Segoe UI", 18, "bold"), fg="white", bg="#2c3e50").pack(side="left")

    # ƒ∞√ßerik
    content = tk.Frame(frame_rek_mail, bg="#ecf0f1", padx=20, pady=20)
    content.pack(fill="both", expand=True)

    # Ayarlar Frame
    settings_frame = tk.LabelFrame(content, text="G√∂nderim Ayarlarƒ±", bg="white", font=("Segoe UI", 10, "bold"), padx=15, pady=15)
    settings_frame.pack(fill="x", pady=10)

    tk.Label(settings_frame, text="Alƒ±cƒ± Email:", bg="white").grid(row=0, column=0, sticky="w", pady=5)
    entry_to = ttk.Entry(settings_frame, width=40); entry_to.grid(row=0, column=1, pady=5, padx=10)
    if GMAIL_RECEIVER_LOGS: entry_to.insert(0, GMAIL_RECEIVER_LOGS)

    tk.Label(settings_frame, text="Konu:", bg="white").grid(row=1, column=0, sticky="w", pady=5)
    entry_subject = ttk.Entry(settings_frame, width=40); entry_subject.grid(row=1, column=1, pady=5, padx=10)
    entry_subject.insert(0, f"Haftalƒ±k Reklamasyon Raporu - {datetime.date.today()}")

    # Kimlik Bilgileri
    tk.Label(settings_frame, text="G√∂nderen Email:", bg="white").grid(row=0, column=2, sticky="w", pady=5, padx=(20,0))
    entry_user = ttk.Entry(settings_frame, width=30); entry_user.grid(row=0, column=3, pady=5, padx=10)
    if GMAIL_USER: entry_user.insert(0, GMAIL_USER)
    
    tk.Label(settings_frame, text="Uygulama ≈ûifresi:", bg="white").grid(row=1, column=2, sticky="w", pady=5, padx=(20,0))
    entry_pass = ttk.Entry(settings_frame, width=30, show="*"); entry_pass.grid(row=1, column=3, pady=5, padx=10)
    if GMAIL_APP_PASSWORD: entry_pass.insert(0, GMAIL_APP_PASSWORD)

    # G√∂nderim Fonksiyonu
    def send_rek_email():
        to_addr = entry_to.get()
        user_email = entry_user.get()
        user_pass = entry_pass.get()
        
        if not to_addr or not user_email or not user_pass:
            messagebox.showwarning("Eksik Bilgi", "L√ºtfen t√ºm alanlarƒ± doldurun.")
            return

        try:
            status_lbl.configure(text="Reklamasyon raporlarƒ± hazƒ±rlanƒ±yor...", fg="blue")
            root.update()

            # 1. Grafiƒüi Olu≈ütur ve Kaydet
            fig = plt.figure(figsize=(8, 4), dpi=100)
            ax = fig.add_subplot(111)
            if df_reklamasyon_global is not None:
                risk_data = df_reklamasyon_global.groupby("Order Grup Adƒ±")[["Iade_Tutari", "Reklamasyon_Tutari"]].sum().sum(axis=1).sort_values(ascending=False).head(5)
                risk_data.plot(kind="barh", ax=ax, color="#e74c3c")
                ax.set_title("En Y√ºksek Riskli Takƒ±mlar")
            plt.tight_layout()
            chart_path = "temp_rek_chart.png"
            fig.savefig(chart_path)
            plt.close(fig)

            # 2. Excel Raporu Olu≈ütur
            excel_path = export_rek_df_to_excel(df_reklamasyon_global, "Rek_Rapor", auto_save=True)

            # 3. HTML ƒ∞√ßerik Hazƒ±rla
            total_risk = df_reklamasyon_global["Iade_Tutari"].sum() + df_reklamasyon_global["Reklamasyon_Tutari"].sum()
            total_buy = df_reklamasyon_global["Alim_Tutari"].sum()
            
            html_content = f"""
            <html>
                <body style="font-family: Arial, sans-serif; color: #333;">
                    <div style="background-color: #2c3e50; padding: 20px; color: white; text-align: center; border-radius: 5px 5px 0 0;">
                        <h1>Reklamasyon Kalite Raporu</h1>
                        <p>{datetime.date.today()}</p>
                    </div>
                    <div style="padding: 20px; border: 1px solid #ddd; border-top: none;">
                        <h2 style="color: #2c3e50;">üìä Y√∂netici √ñzeti</h2>
                        <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                            <div style="background-color: #27ae60; color: white; padding: 15px; border-radius: 5px; width: 45%; text-align: center;">
                                <h3>Toplam Alƒ±m</h3>
                                <p style="font-size: 24px; margin: 0;">{total_buy:,.0f} ‚Ç∫</p>
                            </div>
                            <div style="background-color: #c0392b; color: white; padding: 15px; border-radius: 5px; width: 45%; text-align: center;">
                                <h3>Toplam Risk</h3>
                                <p style="font-size: 24px; margin: 0;">{total_risk:,.0f} ‚Ç∫</p>
                            </div>
                        </div>
                        <h3>üìâ Risk Analizi Grafiƒüi</h3>
                        <img src="cid:dashboard_chart" alt="Grafik" style="width: 100%; max-width: 600px; border: 1px solid #eee; border-radius: 5px;">
                        <p style="margin-top: 20px;">Detaylƒ± raporlar ekte sunulmu≈ütur.</p>
                        <hr>
                        <p style="font-size: 12px; color: gray;">Bu mail Reklamasyon Y√∂netim Sistemi tarafƒ±ndan otomatik olu≈üturulmu≈ütur.</p>
                    </div>
                </body>
            </html>
            """

            # 4. Maili Olu≈ütur
            from email.mime.multipart import MIMEMultipart
            from email.mime.text import MIMEText
            from email.mime.image import MIMEImage
            from email.mime.application import MIMEApplication
            msg = MIMEMultipart('related')
            msg['Subject'] = entry_subject.get()
            msg['From'] = user_email
            msg['To'] = to_addr

            msg_alternative = MIMEMultipart('alternative')
            msg.attach(msg_alternative)
            msg_alternative.attach(MIMEText(html_content, 'html'))

            # Resmi Ekle
            with open(chart_path, 'rb') as f:
                img_data = f.read()
            image = MIMEImage(img_data)
            image.add_header('Content-ID', '<dashboard_chart>')
            msg.attach(image)

            # Dosyalarƒ± Ekle
            if excel_path and os.path.exists(excel_path):
                with open(excel_path, "rb") as f:
                    part = MIMEApplication(f.read(), Name=os.path.basename(excel_path))
                part['Content-Disposition'] = f'attachment; filename="{os.path.basename(excel_path)}"'
                msg.attach(part)

            # 5. G√∂nder
            server = smtplib.SMTP('smtp.gmail.com', 587)
            server.starttls()
            server.login(user_email, user_pass)
            server.send_message(msg)
            server.quit()

            # Temizlik
            if os.path.exists(chart_path): os.remove(chart_path)
            if excel_path and os.path.exists(excel_path): os.remove(excel_path)

            status_lbl.configure(text="‚úÖ Mail ba≈üarƒ±yla g√∂nderildi!", fg="green")
            messagebox.showinfo("Ba≈üarƒ±lƒ±", "Reklamasyon raporu maili g√∂nderildi.")

        except Exception as e:
            status_lbl.configure(text="Hata olu≈ütu.", fg="red")
            messagebox.showerror("G√∂nderim Hatasƒ±", f"Mail g√∂nderilemedi:\n{str(e)}")

    btn_send = tk.Button(content, text="üöÄ Raporu G√∂nder", bg="#2980b9", fg="white", font=("Segoe UI", 12, "bold"), padx=20, pady=10, command=send_rek_email)
    btn_send.pack(pady=20)
    
    status_lbl = tk.Label(content, text="", bg="#ecf0f1", font=("Segoe UI", 10))
    status_lbl.pack()

# Fotoƒüraf Galerisi
def init_rek_gallery_tab():
    """Reklamasyon fotoƒüraf galerisi"""
    for w in frame_rek_galeri.winfo_children(): w.destroy()
    tk.Label(frame_rek_galeri, text="üì∏ Reklamasyon Fotoƒüraf Kanƒ±tlarƒ±", font=("Segoe UI", 16, "bold")).pack(pady=10)
    btn_frame = tk.Frame(frame_rek_galeri); btn_frame.pack(fill="x", padx=20)
    def foto_yukle():
        path = filedialog.askopenfilename(filetypes=[("Resimler", "*.jpg *.png *.jpeg")]); 
        if path: defect_images_rek.append(path); refresh_gallery()
    ttk.Button(btn_frame, text="Fotoƒüraf Ekle", command=foto_yukle).pack(side="left")
    scroll = tk.Frame(frame_rek_galeri); scroll.pack(fill="both", expand=True, pady=10)
    canvas = tk.Canvas(scroll); sb = ttk.Scrollbar(scroll, command=canvas.yview); cont = tk.Frame(canvas)
    cont.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
    canvas.create_window((0,0), window=cont, anchor="nw"); canvas.configure(yscrollcommand=sb.set)
    canvas.pack(side="left", fill="both", expand=True); sb.pack(side="right", fill="y")
    def refresh_gallery():
        for w in cont.winfo_children(): w.destroy()
        r, c = 0, 0
        for p in defect_images_rek:
            try:
                img = Image.open(p); img.thumbnail((150, 150)); ph = ImageTk.PhotoImage(img)
                f = tk.Frame(cont, bd=1, relief="solid", padx=5, pady=5); f.grid(row=r, column=c, padx=5, pady=5)
                tk.Label(f, image=ph).pack(); tk.Label(f, text=os.path.basename(p)[:10]).pack(); f.image = ph
                c += 1; 
                if c > 4: c=0; r+=1
            except: pass
    refresh_gallery()

# Veri Y√ºkleme
def init_rek_data_load_tab():
    """Reklamasyon veri y√ºkleme"""
    for w in frame_rek_veri.winfo_children(): w.destroy()
    tk.Label(frame_rek_veri, text="üìÇ Reklamasyon Veri Y√ºkleme", font=("Segoe UI", 16, "bold")).pack(pady=20)
    
    info_frame = tk.Frame(frame_rek_veri, bg="#e8f5e9", padx=20, pady=15, bd=1, relief="solid")
    info_frame.pack(fill="x", padx=40, pady=10)
    tk.Label(info_frame, text="‚ÑπÔ∏è Veri Formatƒ± Hakkƒ±nda", font=("Segoe UI", 11, "bold"), bg="#e8f5e9").pack(anchor="w")
    tk.Label(info_frame, text="‚Ä¢ Excel dosyasƒ± (.xlsx) olmalƒ±dƒ±r\n‚Ä¢ Gerekli kolonlar: Fi≈ü Tipi, Fi≈ü Tarihi, Cari Adƒ±, Order No, vb.\n‚Ä¢ √ñrnek veri otomatik y√ºklenmi≈ütir", 
             font=("Segoe UI", 10), bg="#e8f5e9", justify="left").pack(anchor="w", pady=5)
    
    btn_frame = tk.Frame(frame_rek_veri); btn_frame.pack(pady=20)
    
    def load_file():
        path = filedialog.askopenfilename(filetypes=[("Excel Files", "*.xlsx")])
        if path:
            success, msg = load_reklamasyon_data(path)
            if success:
                messagebox.showinfo("Ba≈üarƒ±lƒ±", msg)
                show_page("Rek Y√∂netici √ñzeti")
            else:
                messagebox.showerror("Hata", msg)
    
    tk.Button(btn_frame, text="üìÇ Excel Dosyasƒ± Y√ºkle", bg="#2980b9", fg="white", font=("Segoe UI", 12, "bold"), 
              padx=30, pady=15, command=load_file).pack()
    
    tk.Label(frame_rek_veri, text=f"Mevcut Durum: {len(df_reklamasyon_global)} kayƒ±t y√ºkl√º" if df_reklamasyon_global is not None else "Hen√ºz veri y√ºklenmedi",
             font=("Segoe UI", 10), fg="gray").pack(pady=10)

# Reklamasyon Ana Sayfa
def init_rek_main_tab():
    """Reklamasyon y√∂netimi ana sayfasƒ±"""
    for widget in frame_rek_main.winfo_children(): widget.destroy()
    
    # Ba≈ülƒ±k
    header = tk.Frame(frame_rek_main, bg="#2c3e50", padx=20, pady=30)
    header.pack(fill="x")
    tk.Label(header, text="üè≠ REKLAMASYON Y√ñNETƒ∞M Sƒ∞STEMƒ∞", font=("Segoe UI", 20, "bold"), fg="white", bg="#2c3e50").pack()
    tk.Label(header, text="Kuma≈ü Kalite Kontrol ve Reklamasyon Takip Platformu", font=("Segoe UI", 12), fg="#ecf0f1", bg="#2c3e50").pack(pady=5)
    
    # ƒ∞√ßerik
    content = tk.Frame(frame_rek_main, bg="#ecf0f1")
    content.pack(fill="both", expand=True, padx=40, pady=20)
    
    # Hƒ±zlƒ± Eri≈üim Butonlarƒ±
    tk.Label(content, text="Hƒ±zlƒ± Eri≈üim", font=("Segoe UI", 14, "bold"), bg="#ecf0f1", fg="#2c3e50").pack(anchor="w", pady=(10, 15))
    
    btn_container = tk.Frame(content, bg="#ecf0f1")
    btn_container.pack(fill="x")
    
    buttons = [
        ("üìä Y√∂netici √ñzeti", "Rek Y√∂netici √ñzeti", "#3498db"),
        ("üìë Detaylƒ± Raporlar", "Rek Detaylƒ± Rapor", "#2ecc71"),
        ("üìß Mail Merkezi", "Rek Mail Merkezi", "#9b59b6"),
        ("üì∏ Fotoƒüraf Galerisi", "Rek Galeri", "#e67e22"),
        ("üìÇ Veri Y√ºkleme", "Rek Veri Y√ºkleme", "#34495e"),
    ]
    
    for i, (text, page, color) in enumerate(buttons):
        btn = tk.Button(btn_container, text=text, bg=color, fg="white", font=("Segoe UI", 12, "bold"),
                       padx=20, pady=20, cursor="hand2", bd=0, command=lambda p=page: show_page(p))
        btn.grid(row=i//3, column=i%3, padx=10, pady=10, sticky="ew")
    
    for i in range(3):
        btn_container.grid_columnconfigure(i, weight=1)
    
    # Sistem Durumu
    status_frame = tk.LabelFrame(content, text="üìã Sistem Durumu", font=("Segoe UI", 11, "bold"), bg="white", padx=15, pady=15)
    status_frame.pack(fill="x", pady=20)
    
    if df_reklamasyon_global is not None:
        total_records = len(df_reklamasyon_global)
        total_risk = df_reklamasyon_global["Iade_Tutari"].sum() + df_reklamasyon_global["Reklamasyon_Tutari"].sum()
        tk.Label(status_frame, text=f"‚úÖ Toplam {total_records} kayƒ±t y√ºkl√º", font=("Segoe UI", 10), bg="white", fg="green").pack(anchor="w")
        tk.Label(status_frame, text=f"‚ö†Ô∏è Toplam Risk: {total_risk:,.0f} ‚Ç∫", font=("Segoe UI", 10), bg="white", fg="red").pack(anchor="w")
    else:
        tk.Label(status_frame, text="‚ùå Hen√ºz veri y√ºklenmedi", font=("Segoe UI", 10), bg="white", fg="gray").pack(anchor="w")

# ---------- DASHBOARD ----------
def draw_dashboard(parent, stats=None, df=None):
    """Profesyonel Dashboard Aray√ºz√ºn√º √áizer"""
    for widget in parent.winfo_children():
        widget.destroy()

    if stats is None:
        stats = {"count": "-", "price": "-", "delivery": "-", "return": "-", "score": "-", "pareto_a": "-"}

    icon_map = {"Users": "üë•", "Money": "‚Ç∫", "Truck": "üöö", "Return": "‚Ü©Ô∏è", "Star": "‚≠ê", "Pareto": "üÖ∞Ô∏è"}
    bg_color = "#f4f6f9"
    parent.configure(style="Dashboard.TFrame")
    
    main_frame = tk.Frame(parent, bg=bg_color)
    main_frame.pack(fill="both", expand=True)

    header_frame = tk.Frame(main_frame, bg="white", height=60, bd=1, relief="solid")
    header_frame.pack(fill="x", side="top")
    tk.Label(header_frame, text="Tedarik√ßi Performans Y√∂netim Paneli", font=("Segoe UI", 18, "bold"), bg="white", fg="#2c3e50").pack(pady=15, padx=20, anchor="w")

    cards_container = tk.Frame(main_frame, bg=bg_color)
    cards_container.pack(fill="x", padx=20, pady=20)

    def create_card(parent_frame, title, value, unit, color_code, icon_key):
        card = tk.Frame(parent_frame, bg="white", bd=0, relief="flat")
        strip = tk.Frame(card, bg=color_code, width=6)
        strip.pack(side="left", fill="y")
        content = tk.Frame(card, bg="white")
        content.pack(side="left", fill="both", expand=True, padx=15, pady=15)
        title_row = tk.Frame(content, bg="white")
        title_row.pack(anchor="w")
        symbol = icon_map.get(icon_key, "")
        if symbol:
            tk.Label(title_row, text=symbol, font=("Segoe UI", 14), fg=color_code, bg="white").pack(side="left", padx=(0, 8))
        tk.Label(title_row, text=title, font=("Segoe UI", 10, "bold"), fg="#7f8c8d", bg="white").pack(side="left")
        val_frame = tk.Frame(content, bg="white")
        val_frame.pack(anchor="w", pady=(5, 0))
        tk.Label(val_frame, text=str(value), font=("Segoe UI", 24, "bold"), fg="#2c3e50", bg="white").pack(side="left")
        if unit:
            tk.Label(val_frame, text=unit, font=("Segoe UI", 12), fg="#95a5a6", bg="white").pack(side="left", padx=(5, 0), anchor="sw")
        return card

    c1 = create_card(cards_container, "TOPLAM TEDARƒ∞K√áƒ∞", stats['count'], "Adet", "#3498db", "Users")
    c1.grid(row=0, column=0, padx=5, sticky="ew")
    
    c2 = create_card(cards_container, "ORT. Fƒ∞YAT", stats['price'], "TL", "#2ecc71", "Money")
    c2.grid(row=0, column=1, padx=5, sticky="ew")

    c3 = create_card(cards_container, "A SINIFI (PARETO)", stats['pareto_a'], "Adet", "#e67e22", "Pareto")
    c3.grid(row=0, column=2, padx=5, sticky="ew")

    c4 = create_card(cards_container, "ORT. TESLƒ∞M", stats['delivery'], "G√ºn", "#f39c12", "Truck")
    c4.grid(row=0, column=3, padx=5, sticky="ew")

    c5 = create_card(cards_container, "ORT. ƒ∞ADE", stats['return'], "Adet", "#e74c3c", "Return") 
    c5.grid(row=0, column=4, padx=5, sticky="ew")

    c6 = create_card(cards_container, "KALƒ∞TE SKORU", stats['score'], "Puan", "#9b59b6", "Star")
    c6.grid(row=0, column=5, padx=5, sticky="ew")

    for i in range(6):
        cards_container.columnconfigure(i, weight=1)

    if df is not None and not df.empty:
        charts_frame = tk.Frame(main_frame, bg=bg_color)
        charts_frame.pack(fill="both", expand=True, padx=20, pady=10)
        
        fig = plt.figure(figsize=(12, 4), facecolor=bg_color)
        gs = fig.add_gridspec(1, 2, wspace=0.3)
        
        ax1 = fig.add_subplot(gs[0, 0])
        if "Pareto_Sinifi" in df.columns:
            counts = df["Pareto_Sinifi"].value_counts()
            colors = {'A': '#27ae60', 'B': '#f39c12', 'C': '#c0392b'}
            pie_colors = [colors.get(x, '#95a5a6') for x in counts.index]
            
            wedges, texts, autotexts = ax1.pie(counts, labels=counts.index, autopct='%1.1f%%', 
                                             colors=pie_colors, startangle=90, textprops={'fontsize': 9})
            ax1.set_title("Tedarik√ßi ABC Sƒ±nƒ±fƒ± Daƒüƒ±lƒ±mƒ±", fontsize=11, fontweight='bold', color="#2c3e50")
            plt.setp(autotexts, size=9, weight="bold", color="white")
        else:
            ax1.text(0.5, 0.5, "ABC Verisi Yok", ha='center')

        ax2 = fig.add_subplot(gs[0, 1])
        if "Skor" in df.columns:
            ax2.hist(df["Skor"], bins=10, color="#3498db", edgecolor='white', alpha=0.7)
            ax2.set_title("Performans Skoru Daƒüƒ±lƒ±mƒ±", fontsize=11, fontweight='bold', color="#2c3e50")
            ax2.set_xlabel("Skor Aralƒ±ƒüƒ±", fontsize=9)
            ax2.set_ylabel("Tedarik√ßi Sayƒ±sƒ±", fontsize=9)
            ax2.grid(axis='y', linestyle='--', alpha=0.5)
        
        canvas = FigureCanvasTkAgg(fig, master=charts_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)

    else:
        info_frame = tk.Frame(main_frame, bg=bg_color)
        info_frame.pack(fill="both", expand=True, padx=20)
        info_text = """
        Sƒ∞STEM DURUMU VE TALƒ∞MATLAR:
        -------------------------------------------
        1. 'Analiz' sekmesinden veri dosyanƒ±zƒ± y√ºkleyerek i≈üleme ba≈ülayƒ±n.
        2. Sonu√ßlar yukarƒ±daki kartlarda ve grafiklerde otomatik olarak g√ºncellenecektir.
        3. 'Karne' sekmesinden tedarik√ßi detaylarƒ±nƒ± inceleyebilir ve mail g√∂nderebilirsiniz.
        """
        tk.Label(info_frame, text=info_text, justify="left", font=("Consolas", 10), bg="#ecf0f1", fg="#7f8c8d", relief="flat", padx=20, pady=20).pack(fill="both", expand=True)

# ---------- OCR VE G√ñR√úNT√ú ƒ∞≈ûLEME FONKSƒ∞YONLARI (GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û) ----------
def extract_invoice_data_gemini(image_path):
    """Geli≈ümi≈ü OCR: JSON tabanlƒ± yapƒ±landƒ±rƒ±lmƒ±≈ü fatura verisi √ßƒ±karma"""
    if not GEMINI_API_KEY: return None, "API Anahtarƒ± bulunamadƒ±."
    try:
        with open(image_path, "rb") as image_file:
            image_data = base64.b64encode(image_file.read()).decode('utf-8')
            
        ext = os.path.splitext(image_path)[1].lower()
        if ext == '.pdf':
            mime_type = "application/pdf"
        elif ext == '.png':
            mime_type = "image/png"
        else:
            mime_type = "image/jpeg"

        prompt = """
        Sen bir Fatura Analiz Uzmanƒ±sƒ±n. Bu belgeyi analiz et ve a≈üaƒüƒ±daki alanlarƒ± i√ßeren yapƒ±landƒ±rƒ±lmƒ±≈ü bir JSON √ßƒ±ktƒ±sƒ± ver.
        √ñzellikle 'Sipari≈ü Numarasƒ±' (PO-, Order No, Sipari≈ü Fi≈üi vb.) ve 'Model Kodu' (Model, Style No, √úr√ºn Grubu vb.) alanlarƒ±na dikkat et.
        Sadece JSON formatƒ±nda yanƒ±t ver, ba≈üka bir metin ekleme.
        
        ƒ∞stenen JSON Yapƒ±sƒ±:
        {
          "fatura_no": "...",
          "tarih": "YYYY-MM-DD",
          "tedarikci_adi": "...",
          "vergi_no": "...",
          "siparis_no": "...", 
          "model_kodu": "...",
          "toplam_tutar": 0.00,
          "para_birimi": "TRY",
          "kalemler": [
            {
              "urun_adi": "...",
              "miktar": 0,
              "birim_fiyat": 0.00,
              "satir_toplami": 0.00
            }
          ]
        }
        """
        payload = {"contents": [{"parts": [{"text": prompt}, {"inline_data": {"mime_type": mime_type, "data": image_data}}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=payload, timeout=60)
        
        if response.status_code == 200:
            text = response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
            # Clean markdown code blocks if present
            if text.startswith("```json"):
                text = text[7:]
            if text.endswith("```"):
                text = text[:-3]
            return json.loads(text.strip()), None
        else:
            return None, f"Hata: {response.status_code} - {response.text}"
    except Exception as e: return None, f"OCR Hatasƒ±: {str(e)}"

def init_ocr_tab():
    """Geli≈ütirilmi≈ü OCR sekmesi: PDF desteƒüi, JSON √∂nizleme, sipari≈ü e≈üle≈ütirme"""
    global ocr_image_label, ocr_result_text, ocr_order_combobox
    for widget in frame_ocr.winfo_children(): widget.destroy()
    
    left_panel = tk.Frame(frame_ocr, bg="#f4f6f9", width=400)
    left_panel.pack(side="left", fill="y", padx=10, pady=10)
    tk.Label(left_panel, text="Dosya Y√ºkle (Fatura/Liste - Resim veya PDF)", font=("Segoe UI", 12, "bold"), bg="#f4f6f9").pack(pady=10)
    
    def select_ocr_image():
        file_path = filedialog.askopenfilename(filetypes=[("Desteklenen Dosyalar", "*.jpg *.jpeg *.png *.pdf")])
        if file_path:
            # Preview logic
            if file_path.lower().endswith('.pdf'):
                 ocr_image_label.configure(image='', text=f"PDF Dosyasƒ± Se√ßildi:\n{os.path.basename(file_path)}")
                 ocr_image_label.image = None
            else:
                 img = Image.open(file_path); img.thumbnail((350, 500)); img_tk = ImageTk.PhotoImage(img)
                 ocr_image_label.configure(image=img_tk, text=""); ocr_image_label.image = img_tk
            
            run_ocr_pipeline(file_path)
    
    ttk.Button(left_panel, text="Dosya Se√ß ve √áevir", command=select_ocr_image).pack(pady=10, fill="x", padx=20)
    ocr_image_label = tk.Label(left_panel, text="√ñnizleme Yok", bg="#ddd", width=40, height=20); ocr_image_label.pack(pady=10, expand=True, fill="both")
    
    right_panel = tk.Frame(frame_ocr, bg="white"); right_panel.pack(side="right", fill="both", expand=True, padx=10, pady=10)
    tk.Label(right_panel, text="Fatura Verisi (JSON)", font=("Segoe UI", 12, "bold"), bg="white").pack(pady=10)
    ocr_result_text = tk.Text(right_panel, font=("Consolas", 10), wrap="none"); ocr_result_text.pack(fill="both", expand=True, padx=10, pady=5)
    
    # Sipari≈ü No Alanƒ± (Otomatik E≈üle≈ütirme)
    meta_frame = tk.Frame(right_panel, bg="white", pady=10)
    meta_frame.pack(fill="x")
    tk.Label(meta_frame, text="Baƒülƒ± Sipari≈ü / Model Kodu:", font=("Segoe UI", 10, "bold"), bg="white").pack(anchor="w")
    ocr_order_combobox = ttk.Combobox(meta_frame, width=40) 
    if all_stock_codes: ocr_order_combobox['values'] = all_stock_codes
    ocr_order_combobox.pack(fill="x", pady=5)

    action_frame = tk.Frame(right_panel, bg="white"); action_frame.pack(fill="x", pady=10)
    
    def save_ocr_to_excel():
        content = ocr_result_text.get("1.0", tk.END).strip()
        if not content or "{" not in content: return
        try:
            start = content.find("{")
            end = content.rfind("}") + 1
            json_str = content[start:end]
            data = json.loads(json_str)
            
            if "kalemler" in data and data["kalemler"]:
                df = pd.DataFrame(data["kalemler"])
                for key in ["fatura_no", "tarih", "tedarikci_adi", "vergi_no", "toplam_tutar", "para_birimi", "siparis_no", "model_kodu"]:
                    if key in data: df[key] = data[key]
                
                f = filedialog.asksaveasfilename(defaultextension=".xlsx", filetypes=[("Excel", "*.xlsx")])
                if f: df.to_excel(f, index=False); messagebox.showinfo("Ba≈üarƒ±lƒ±", "Excel dosyasƒ± kaydedildi.")
            else:
                 messagebox.showwarning("Uyarƒ±", "Kalem verisi bulunamadƒ±.")
        except Exception as e: messagebox.showerror("Hata", f"Excel'e √ßevrilemedi:\n{e}")

    ttk.Button(action_frame, text="Excel Olarak Kaydet", command=save_ocr_to_excel).pack(side="right", padx=10)
    ttk.Button(action_frame, text="ERP'ye Aktar (Sim√ºlasyon)", command=send_to_mock_erp).pack(side="right", padx=10)

def run_ocr_pipeline(image_path):
    """Geli≈ütirilmi≈ü OCR pipeline: JSON √ßƒ±ktƒ± ve otomatik sipari≈ü e≈üle≈ütirme"""
    global ocr_json_data
    ocr_result_text.configure(state="normal")
    ocr_result_text.delete("1.0", tk.END)
    ocr_result_text.insert("1.0", "Fatura i≈üleniyor ve anlamsal veri √ßƒ±karƒ±lƒ±yor... L√ºtfen bekleyin...\n")
    ocr_result_text.configure(state="disabled")
    
    def _thread():
        global ocr_json_data
        data, error = extract_invoice_data_gemini(image_path)
        
        if data:
            ocr_json_data = data
            formatted_json = json.dumps(data, indent=4, ensure_ascii=False)
            root.after(0, lambda: _update_text(formatted_json, success=True, data=data))
        else:
            ocr_json_data = None
            root.after(0, lambda: _update_text(error, success=False, data=None))
            
    def _update_text(val, success, data):
        ocr_result_text.configure(state="normal")
        ocr_result_text.delete("1.0", tk.END)
        if success:
            ocr_result_text.insert("1.0", "‚úÖ FATURA BA≈ûARIYLA √á√ñZ√úMLENDƒ∞!\n\n")
            ocr_result_text.insert(tk.END, val)
            
            # Otomatik Sipari≈ü No Doldurma
            if data:
                found_order = data.get("siparis_no") or data.get("model_kodu")
                if found_order:
                    ocr_order_combobox.set(found_order)
                else:
                    ocr_order_combobox.set("")
        else:
            ocr_result_text.insert("1.0", f"‚ùå HATA: {val}")
        ocr_result_text.configure(state="disabled")

    threading.Thread(target=_thread, daemon=True).start()

def send_to_mock_erp():
    """ERP entegrasyonu sim√ºlasyonu"""
    global ocr_json_data
    if not ocr_json_data:
        messagebox.showwarning("Uyarƒ±", "G√∂nderilecek veri yok. L√ºtfen √∂nce bir fatura y√ºkleyin.")
        return
    
    # Kullanƒ±cƒ±nƒ±n girdiƒüi sipari≈ü numarasƒ±nƒ± ekle
    user_order = ocr_order_combobox.get()
    if user_order:
        ocr_json_data["bagli_siparis"] = user_order
    
    # Mock sending
    msg_box = tk.Toplevel()
    msg_box.title("ERP Entegrasyonu")
    msg_box.geometry("400x150")
    tk.Label(msg_box, text="SAP/ERP Sistemine Baƒülanƒ±lƒ±yor...", font=("Segoe UI", 10)).pack(pady=20)
    
    progress = ttk.Progressbar(msg_box, mode='indeterminate')
    progress.pack(fill='x', padx=20)
    progress.start()
    
    def _finish():
        progress.stop()
        msg_box.destroy()
        
        info_text = f"Fatura No: {ocr_json_data.get('fatura_no', 'Bilinmiyor')}\n"
        if "bagli_siparis" in ocr_json_data:
             info_text += f"E≈üle≈üen Sipari≈ü: {ocr_json_data['bagli_siparis']}\n"
             
        messagebox.showinfo("Ba≈üarƒ±lƒ±", f"{info_text}ERP Sistemine ba≈üarƒ±yla aktarƒ±ldƒ±!\n(Transaction ID: {random.randint(100000, 999999)})")
        
    # Simulate network delay
    root.after(2000, _finish)

# ---------- HARƒ∞TA VE ROTA FONKSƒ∞YONLARI ----------
def init_map_tab():
    global map_widget, route_info_label
    for widget in frame_harita.winfo_children():
        widget.destroy()
        
    if not MAP_AVAILABLE:
        tk.Label(frame_harita, text="Harita mod√ºl√º bulunamadƒ±.\nL√ºtfen 'pip install tkintermapview' komutunu √ßalƒ±≈ütƒ±rƒ±n.", 
                 font=("Arial", 14), fg="red").pack(expand=True)
        return

    map_widget = tkintermapview.TkinterMapView(frame_harita, width=800, height=600, corner_radius=0)
    map_widget.pack(fill="both", expand=True)
    
    map_widget.set_tile_server("https://a.tile.openstreetmap.org/{z}/{x}/{y}.png")
    map_widget.set_position(39.0, 35.0) 
    map_widget.set_zoom(6)
    
    map_widget.add_right_click_menu_command(label="üìç Burayƒ± Ba≈ülangƒ±√ß Noktasƒ± Yap", command=set_start_marker, pass_coords=True)
    map_widget.add_right_click_menu_command(label="üèÅ Burayƒ± Varƒ±≈ü Noktasƒ± Yap", command=set_destination_marker, pass_coords=True)

    controls_panel = tk.Frame(map_widget, bg="white", bd=1, relief="solid")
    controls_panel.place(relx=0.02, rely=0.02, anchor="nw")
    tk.Label(controls_panel, text="Harita Kontrolleri", font=("Arial", 10, "bold"), bg="white").pack(padx=5, pady=2)
    
    def set_osm_std(): map_widget.set_tile_server("https://a.tile.openstreetmap.org/{z}/{x}/{y}.png")
    def set_carto_light(): map_widget.set_tile_server("https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png")
    def set_google_satellite(): map_widget.set_tile_server("https://mt0.google.com/vt/lyrs=s&hl=tr&x={x}&y={y}&z={z}", max_zoom=22)

    tk.Button(controls_panel, text="Standart (OSM)", command=set_osm_std, bg="#f0f0f0", width=15).pack(padx=5, pady=2)
    tk.Button(controls_panel, text="Hƒ±zlƒ± (Sade)", command=set_carto_light, bg="#f0f0f0", width=15).pack(padx=5, pady=2)
    tk.Button(controls_panel, text="Google Uydu", command=set_google_satellite, bg="#f0f0f0", width=15).pack(padx=5, pady=2)
    tk.Button(controls_panel, text="T√ºm√ºn√º G√∂ster", command=lambda: map_widget.fit_bounding_box((42.0, 26.0), (36.0, 45.0)), bg="#e0e0e0", width=15).pack(padx=5, pady=(10, 5))
    tk.Button(controls_panel, text="üéØ Tedarik√ßi Risk Haritasƒ±", command=show_supplier_risk_map, bg="#e74c3c", fg="white", width=15, font=("Segoe UI", 9, "bold")).pack(padx=5, pady=2)

    route_info_label = tk.Label(map_widget, text="Saƒü tƒ±klayarak Ba≈ülangƒ±√ß veya Varƒ±≈ü noktasƒ± se√ßin.", justify="left", 
                                font=("Segoe UI", 10), bg="white", fg="#333333", bd=1, relief="solid", padx=10, pady=10, wraplength=350)
    route_info_label.place(relx=0.98, rely=0.02, anchor="ne")

def show_supplier_risk_map():
    """Tedarik√ßileri risk durumlarƒ±na g√∂re haritada g√∂sterir"""
    if not MAP_AVAILABLE or map_widget is None:
        messagebox.showwarning("Uyarƒ±", "Harita mod√ºl√º bulunamadƒ±!")
        return
    
    if sonuc_global is None or df_global is None:
        messagebox.showwarning("Uyarƒ±", "L√ºtfen √∂nce verileri analiz edin!")
        return
    
    # Mevcut marker'larƒ± temizle
    map_widget.delete_all_marker()
    
    # T√ºrkiye'nin b√ºy√ºk ≈üehirlerinin koordinatlarƒ± (tedarik√ßi konumlarƒ± i√ßin)
    city_coords = {
        'ƒ∞stanbul': (41.0082, 28.9784),
        'Ankara': (39.9334, 32.8597),
        'ƒ∞zmir': (38.4237, 27.1428),
        'Bursa': (40.1826, 29.0665),
        'Antalya': (36.8969, 30.7133),
        'Adana': (37.0000, 35.3213),
        'Gaziantep': (37.0662, 37.3833),
        'Konya': (37.8746, 32.4932),
        'Mersin': (36.8121, 34.6415),
        'Kayseri': (38.7312, 35.4787),
        'Denizli': (37.7765, 29.0864),
        'Tekirdaƒü': (40.9833, 27.5167),
        'Kahramanmara≈ü': (37.5858, 36.9371),
        'Balƒ±kesir': (39.6484, 27.8826),
        '√áorum': (40.5506, 34.9556)
    }
    
    # Tedarik√ßi bazƒ±nda risk skorlarƒ±
    suppliers = sonuc_global[[tedarikci_col_global, 'Genel Skor', 'Not']].drop_duplicates()
    
    cities = list(city_coords.keys())
    markers = []
    
    for idx, (_, row) in enumerate(suppliers.iterrows()):
        supplier = row[tedarikci_col_global]
        score = row['Genel Skor']
        note = row['Not']
        
        # Risk seviyesi belirleme
        if score >= 80:
            risk_level = "G√ºvenli"
            marker_color = "green"
            risk_icon = "‚úÖ"
        elif score >= 60:
            risk_level = "Orta Risk"
            marker_color = "orange"
            risk_icon = "‚ö†Ô∏è"
        else:
            risk_level = "Y√ºksek Risk"
            marker_color = "red"
            risk_icon = "‚õî"
        
        # ≈ûehir atama (d√∂ng√ºsel)
        city = cities[idx % len(cities)]
        lat, lon = city_coords[city]
        
        # K√º√ß√ºk rastgele offset ekle (aynƒ± ≈üehirdeki tedarik√ßileri ayƒ±rt etmek i√ßin)
        lat += random.uniform(-0.1, 0.1)
        lon += random.uniform(-0.1, 0.1)
        
        # Marker ekle
        marker_text = f"{risk_icon} {supplier}\nSkor: {score:.0f}\n{note}\nKonum: {city}"
        marker = map_widget.set_marker(lat, lon, text=marker_text, marker_color_circle=marker_color, marker_color_outside="white")
        markers.append(marker)
    
    # Haritayƒ± T√ºrkiye'ye odakla
    map_widget.set_position(39.0, 35.0)
    map_widget.set_zoom(6)
    
    # Bilgi g√ºncellemesi
    if route_info_label:
        info_text = f"""üéØ TEDARƒ∞K√áƒ∞ Rƒ∞SK HARƒ∞TASI

Toplam: {len(suppliers)} tedarik√ßi
        
‚úÖ Ye≈üil: G√ºvenli (Skor ‚â• 80)
‚ö†Ô∏è Turuncu: Orta Risk (60-79)
‚õî Kƒ±rmƒ±zƒ±: Y√ºksek Risk (< 60)

Marker'a tƒ±klayarak detaylarƒ± g√∂r√ºn."""
        route_info_label.configure(text=info_text)
    
    messagebox.showinfo("Risk Haritasƒ±", f"{len(suppliers)} tedarik√ßi risk durumlarƒ±na g√∂re haritada i≈üaretlendi!")

def get_weather_data(lat, lon):
    try:
        url = f"https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={lon}&current_weather=true"
        response = requests.get(url, timeout=5)
        if response.status_code == 200:
            data = response.json().get("current_weather", {})
            temp = data.get("temperature", "-")
            wcode = data.get("weathercode", 0)
            
            condition = "A√ßƒ±k"
            if wcode in [1, 2, 3]: condition = "Par√ßalƒ± Bulutlu"
            elif wcode in [45, 48]: condition = "Sisli"
            elif wcode in [51, 53, 55, 61, 63, 65]: condition = "Yaƒümurlu"
            elif wcode in [71, 73, 75]: condition = "Karlƒ±"
            elif wcode >= 95: condition = "Fƒ±rtƒ±nalƒ±"
            
            return f"{temp}¬∞C, {condition}"
    except:
        pass
    return "Veri alƒ±namadƒ±"

def haversine_distance(lat1, lon1, lat2, lon2):
    R = 6371 
    dLat = math.radians(lat2 - lat1)
    dLon = math.radians(lon2 - lon1)
    a = math.sin(dLat/2) * math.sin(dLat/2) + math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) * math.sin(dLon/2) * math.sin(dLon/2)
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
    return R * c

def get_osrm_route(lat1, lon1, lat2, lon2):
    url = f"http://router.project-osrm.org/route/v1/driving/{lon1},{lat1};{lon2},{lat2}?overview=full&geometries=geojson"
    
    try:
        headers = {'User-Agent': 'TedarikciAnalizApp/1.0'}
        response = requests.get(url, headers=headers, timeout=5)
        
        if response.status_code == 200:
            data = response.json()
            if data.get("code") == "Ok" and data.get("routes"):
                route = data["routes"][0]
                distance_km = route["distance"] / 1000 
                duration_min = route["duration"] / 60 
                
                geometry = route["geometry"]["coordinates"]
                path_coords = [(p[1], p[0]) for p in geometry]
                
                return distance_km, duration_min, path_coords
    except Exception as e:
        print(f"OSRM Hatasƒ±: {e}")
        
    return None, None, None

def get_ai_logistics_analysis(origin_name, destination_name, dist_km, weather):
    if not GEMINI_API_KEY: return "AI Anahtarƒ± yok."
    
    prompt = f"""
    Lojistik Analizi ƒ∞steƒüi:
    - √áƒ±kƒ±≈ü Noktasƒ±: {origin_name}
    - Varƒ±≈ü Noktasƒ±: {destination_name}
    - Rota Mesafesi: {dist_km:.1f} km
    - Varƒ±≈ü Noktasƒ± Hava Durumu: {weather}
    
    Bir lojistik uzmanƒ± gibi davran. A≈üaƒüƒ±dakileri i√ßeren √ßok kƒ±sa (maksimum 4-5 c√ºmle) bir T√ºrk√ße √∂zet yaz:
    1. Bu mesafedeki karayolu ta≈üƒ±macƒ±lƒ±ƒüƒ± i√ßin kritik noktalar.
    2. Hava durumunun ta≈üƒ±macƒ±lƒ±ƒüa olasƒ± etkisini deƒüerlendir.
    3. Varsa potansiyel riskleri belirt.
    """
    
    try:
        data = {"contents": [{"parts":[{"text": prompt}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=10)
        if response.status_code == 200:
            return response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
    except Exception as e:
        return f"AI Analizi alƒ±namadƒ±: {str(e)}"
    return "AI Yanƒ±t vermedi."

def set_start_marker(coords):
    global start_marker
    if not map_widget: return
    
    if start_marker:
        start_marker.delete()
        
    start_marker = map_widget.set_marker(coords[0], coords[1], text="Ba≈ülangƒ±√ß", marker_color_circle="white", marker_color_outside="green")
    
    if destination_marker:
        set_destination_marker(destination_marker.position)

def set_destination_marker(coords):
    global destination_marker
    if not map_widget: return
    
    if destination_marker:
        destination_marker.delete()
        
    destination_marker = map_widget.set_marker(coords[0], coords[1], text="Depo / Varƒ±≈ü", marker_color_circle="black", marker_color_outside="red")
    
    weather_info = get_weather_data(coords[0], coords[1])
    
    map_widget.delete_all_path()
    dest_pos = destination_marker.position
    
    origin_name = "Bilinmiyor"
    min_dist = 0
    duration_str = ""
    route_type = ""
    
    start_pos = None
    
    if start_marker:
        start_pos = start_marker.position
        origin_name = "Se√ßilen Ba≈ülangƒ±√ß Noktasƒ±"
        
    elif supplier_markers:
        min_dist_bird = float('inf')
        nearest_sup_marker = None
        
        for marker in supplier_markers:
            dist = haversine_distance(marker.position[0], marker.position[1], dest_pos[0], dest_pos[1])
            if dist < min_dist_bird:
                min_dist_bird = dist
                nearest_sup_marker = marker
        
        if nearest_sup_marker:
            start_pos = nearest_sup_marker.position
            origin_name = nearest_sup_marker.text.split("\n")[0]
            
    else:
        if route_info_label:
            route_info_label.configure(text=f"üìç VARI≈û: {weather_info}\nL√ºtfen bir ba≈ülangƒ±√ß noktasƒ± se√ßin veya dosya y√ºkleyin.")
        return

    if start_pos:
        road_dist, road_dur, path_points = get_osrm_route(start_pos[0], start_pos[1], dest_pos[0], dest_pos[1])
        
        if road_dist:
            min_dist = road_dist
            hours = int(road_dur // 60)
            mins = int(road_dur % 60)
            duration_str = f"{hours} sa {mins} dk" if hours > 0 else f"{mins} dk"
            
            map_widget.set_path(path_points, color="blue", width=3)
            route_type = "Karayolu"
        else:
            min_dist = haversine_distance(start_pos[0], start_pos[1], dest_pos[0], dest_pos[1])
            duration_str = f"~{int(min_dist / 70)} sa (Ku≈ü U√ßu≈üu Tahmini)" 
            
            map_widget.set_path([start_pos, dest_pos], color="gray", width=2)
            route_type = "Ku≈ü U√ßu≈üu"

    initial_text = f"üìç ROTA Bƒ∞LGƒ∞Sƒ∞ ({route_type})\n"
    initial_text += f"-----------------------------\n"
    initial_text += f"üå°Ô∏è Varƒ±≈ü Hava: {weather_info}\n"
    initial_text += f"üö© √áƒ±kƒ±≈ü: {origin_name}\n"
    initial_text += f"üõ£Ô∏è Mesafe: {min_dist:.1f} km\n"
    initial_text += f"‚è±Ô∏è S√ºre: {duration_str}\n"
    initial_text += f"ü§ñ Yapay Zeka Lojistik Analizi Hazƒ±rlanƒ±yor..."
    
    if route_info_label:
        route_info_label.configure(text=initial_text)
    
    def fetch_ai_logistics():
        dest_coord_str = f"{coords[0]:.4f}, {coords[1]:.4f}"
        ai_insight = get_ai_logistics_analysis(origin_name, dest_coord_str, min_dist, weather_info)
        final_text = initial_text.replace("ü§ñ Yapay Zeka Lojistik Analizi Hazƒ±rlanƒ±yor...", f"\nüß† AI Lojistik Analizi:\n{ai_insight}")
        if route_info_label:
            route_info_label.configure(text=final_text)
    
    threading.Thread(target=fetch_ai_logistics, daemon=True).start()

def clean_city_name(name):
    if not isinstance(name, str): return ""
    name = name.replace("ƒ∞", "i").replace("I", "ƒ±").replace("ƒû", "ƒü").replace("√ú", "√º").replace("≈û", "≈ü").replace("√ñ", "√∂").replace("√á", "√ß")
    return name.lower().strip()

def update_map_with_suppliers(df, city_col, supplier_col):
    global supplier_markers
    if not MAP_AVAILABLE or not map_widget: return
    
    map_widget.delete_all_marker()
    map_widget.delete_all_path()
    supplier_markers.clear()
    
    if city_col not in df.columns:
        messagebox.showwarning("Harita Uyarƒ±sƒ±", "Veride 'ƒ∞l' veya '≈ûehir' kolonu bulunamadƒ±.\nHarita g√ºncellenemedi.")
        return

    city_groups = df.groupby(city_col)[supplier_col].apply(list).to_dict()
    
    for city_name, suppliers in city_groups.items():
        clean_city = clean_city_name(city_name)
        
        coords = None
        if clean_city in TR_CITIES:
             coords = TR_CITIES[clean_city]
        else:
             for key in TR_CITIES:
                 if key in clean_city: 
                     coords = TR_CITIES[key]
                     break
        
        if coords:
            unique_suppliers = sorted(list(set(suppliers)))
            unique_count = len(unique_suppliers)
            
            display_list = []
            for sup in unique_suppliers:
                if sonuc_global is not None and not sonuc_global.empty:
                    match = sonuc_global[sonuc_global[tedarikci_col_global] == sup]
                    if not match.empty:
                        sc = match.iloc[0]["Skor"]
                        gr, _, _ = calculate_grade(sc)
                        display_list.append(f"{sup} (Not: {gr})")
                    else:
                        display_list.append(sup)
                else:
                    display_list.append(sup)

            text = f"{city_name}\n{unique_count} Tedarik√ßi\n"
            text += "\n".join(display_list[:3])
            if unique_count > 3: text += "\n..."
            
            marker = map_widget.set_marker(coords[0], coords[1], text=text, marker_color_circle="white", marker_color_outside="blue")
            supplier_markers.append(marker)
    
    if destination_marker:
        set_destination_marker(destination_marker.position)

# ---------- KARNE FONKSƒ∞YONLARI (SCORECARD) ----------
def init_scorecard_tab():
    """Geli≈ütirilmi≈ü karne sekmesi: Kaydƒ±rƒ±labilir i√ßerik"""
    global karne_combobox, frame_karne_content
    for w in frame_karne.winfo_children(): w.destroy()
    
    header_frame = tk.Frame(frame_karne, bg="#f4f6f9")
    header_frame.pack(fill="x", pady=10, padx=10)
    
    tk.Label(header_frame, text="Tedarik√ßi Se√ßin:", bg="#f4f6f9", font=("Segoe UI", 11)).pack(side="left", padx=5)
    karne_combobox = ttk.Combobox(header_frame, state="readonly", width=40)
    karne_combobox.pack(side="left", padx=5)
    ttk.Button(header_frame, text="Karneyi G√∂ster", command=show_scorecard).pack(side="left", padx=5)
    ttk.Button(header_frame, text="üìÑ Karneyi PDF ƒ∞ndir", command=export_scorecard_pdf).pack(side="left", padx=5)
    
    # Kaydƒ±rƒ±labilir canvas i√ßin wrapper
    canvas = tk.Canvas(frame_karne, bg="white")
    scrollbar = ttk.Scrollbar(frame_karne, orient="vertical", command=canvas.yview)
    frame_karne_content = tk.Frame(canvas, bg="white")
    frame_karne_content.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
    canvas.create_window((0, 0), window=frame_karne_content, anchor="nw")
    canvas.configure(yscrollcommand=scrollbar.set)
    canvas.pack(side="left", fill="both", expand=True)
    scrollbar.pack(side="right", fill="y")
    
    tk.Label(frame_karne_content, text="L√ºtfen bir tedarik√ßi se√ßip 'Karneyi G√∂ster' butonuna basƒ±n.", fg="gray").pack(pady=50)

def calculate_grade(score):
    """Yeni geli≈ümi≈ü notlandƒ±rma sistemi"""
    if score >= 90: return "A+", "#27ae60", "M√ºkemmel Performans"
    elif score >= 85: return "A", "#2ecc71", "√áok ƒ∞yi"
    elif score >= 75: return "B", "#3498db", "ƒ∞yi / Standart √úst√º"
    elif score >= 60: return "C", "#f39c12", "Orta / Geli≈ütirilmeli"
    elif score >= 50: return "D", "#e67e22", "Zayƒ±f / Riskli"
    else: return "F", "#c0392b", "Kritik / Acil Aksiyon"

def get_scorecard_ai_comment(row, grade, desc):
    """Yapay zeka destekli detaylƒ± karne yorumu"""
    if not GEMINI_API_KEY: return "Yapay zeka anahtarƒ± eksik."
    
    # Detaylƒ± puanlama bilgisini kontrol et
    score_price = row.get('Score_Price', 'N/A')
    score_deliv = row.get('Score_Deliv', 'N/A')
    score_return = row.get('Score_Return', 'N/A')
    
    prompt = f"""
    A≈üaƒüƒ±daki tedarik√ßi karnesi verilerini analiz et ve detaylƒ± bir yorum yaz.
    
    Tedarik√ßi: {row[tedarikci_col_global]}
    Genel Performans Skoru: {row['Skor']:.2f} / 100
    Performans Notu: {grade} ({desc})
    Pareto Sƒ±nƒ±fƒ± (Ciro): {row.get('Pareto_Sinifi', '-')}
    
    Detaylƒ± Metrik Puanlarƒ± (0-100 arasƒ±):
    - Fiyat Puanƒ±: {score_price if isinstance(score_price, (int, float)) else 'N/A'}
    - Teslimat Puanƒ±: {score_deliv if isinstance(score_deliv, (int, float)) else 'N/A'}
    - ƒ∞ade/Kalite Puanƒ±: {score_return if isinstance(score_return, (int, float)) else 'N/A'}
    
    L√ºtfen ≈üu sorulara cevap ver:
    1. Bu tedarik√ßi neden bu notu ({grade}) aldƒ±?
    2. Hangi alanda (Fiyat, Teslimat, ƒ∞ade) en ba≈üarƒ±lƒ±?
    3. Hangi alanda iyile≈ütirme yapmalƒ±?
    4. Ciro bazlƒ± Pareto sƒ±nƒ±fƒ±na ({row.get('Pareto_Sinifi', '-')}) g√∂re stratejik √∂nemi nedir?
    
    Cevabƒ± T√ºrk√ße, profesyonel ve madde i≈üaretli olarak ver.
    """
    try:
        data = {"contents": [{"parts":[{"text": prompt}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=10)
        return response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
    except: return "AI yorumu alƒ±namadƒ±. Baƒülantƒ± hatasƒ±."

def send_scorecard_email_action():
    """AI destekli ki≈üiselle≈ütirilmi≈ü email g√∂nderimi"""
    if not karne_combobox.get() or sonuc_global is None: return
    supplier_name = karne_combobox.get()
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    
    mail_col = find_col_by_keywords(sonuc_global, ["mail", "eposta", "email"])
    if not mail_col: 
        messagebox.showerror("Hata", "Mail adresi bulunamadƒ±.")
        return
    
    receiver_email = row[mail_col]
    if pd.isna(receiver_email) or str(receiver_email).strip() == "":
        messagebox.showerror("Hata", "Tedarik√ßinin mail adresi yok.")
        return

    grade, _, desc = calculate_grade(row["Skor"])
    pareto = row.get('Pareto_Sinifi', '-')
    
    def _send_thread():
        try:
            # AI ile Mail ƒ∞√ßeriƒüi Olu≈ütur
            prompt = f"""
            Tedarik√ßi: {supplier_name}
            Puan: {row['Skor']:.1f}/100
            Not: {grade} ({desc})
            Pareto: {pareto}
            
            Bu tedarik√ßiye performans karnesini ileten, eksiklerini (eƒüer puanƒ± d√º≈ü√ºkse) nazik√ße belirten kurumsal bir e-posta metni yaz.
            Sadece mail g√∂vdesini d√∂nd√ºr.
            """
            data = {"contents": [{"parts":[{"text": prompt}]}]}
            response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=20)
            body = response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
            
            subject = f"Performans Karnesi Bildirimi - {supplier_name}"
            success, msg = send_email_with_attachments(str(receiver_email), subject, body)
            
            if success: messagebox.showinfo("Ba≈üarƒ±lƒ±", f"Mail g√∂nderildi: {receiver_email}")
            else: messagebox.showerror("Hata", f"Mail hatasƒ±: {msg}")
        except Exception as e: messagebox.showerror("Hata", str(e))

    threading.Thread(target=_send_thread, daemon=True).start()

def send_single_supplier_email():
    if not karne_combobox.get(): return
    supplier_name = karne_combobox.get()
    
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    
    mail_col = find_col_by_keywords(sonuc_global, ["mail", "eposta", "e-posta", "email"])
    
    if not mail_col:
        messagebox.showerror("Hata", "Analiz sonucunda 'Mail' bilgisi bulunamadƒ±.\nL√ºtfen y√ºklediƒüiniz dosyada 'Mail' veya 'E-Posta' adƒ±nda bir s√ºtun olduƒüundan emin olun.")
        return
        
    receiver_email = row[mail_col]
    
    if pd.isna(receiver_email) or str(receiver_email).strip() == "" or str(receiver_email) == "0":
        messagebox.showerror("Hata", f"{supplier_name} i√ßin kayƒ±tlƒ± bir mail adresi bulunamadƒ±.")
        return

    grade, _, desc = calculate_grade(row["Skor"])
    
    subject = f"Tedarik√ßi Performans Deƒüerlendirmesi - {supplier_name}"
    
    body = f"""Sayƒ±n Yetkili,

D√∂nem i√ßi performans deƒüerlendirmesi sonucunda firmanƒ±zƒ±n tedarik√ßi karnesi a≈üaƒüƒ±da √∂zetlenmi≈ütir:

Firma Adƒ±: {supplier_name}
-----------------------------------
Genel Performans Skoru: {row['Skor']:.2f} / 100
Ba≈üarƒ± Notu: {grade} ({desc})
ABC Sƒ±nƒ±fƒ±: {row.get('Pareto_Sinifi', '-')}

Detaylƒ± analiz raporu ve iyile≈ütirme √∂nerileri i√ßin ilgili departmanƒ±mƒ±zla ileti≈üime ge√ßebilirsiniz.

ƒ∞yi √ßalƒ±≈ümalar dileriz.
"""

    try:
        success, msg = send_email_with_attachments(str(receiver_email), subject, body, [])
        if success:
            messagebox.showinfo("Ba≈üarƒ±lƒ±", f"Mail ba≈üarƒ±yla g√∂nderildi:\n{receiver_email}")
        else:
            messagebox.showerror("G√∂nderim Hatasƒ±", f"Mail g√∂nderilemedi:\n{msg}")
    except Exception as e:
        messagebox.showerror("Hata", f"Bir hata olu≈ütu: {str(e)}")

def show_scorecard():
    """Geli≈ütirilmi≈ü karne g√∂r√ºn√ºm√º: Split view + hesaplama kanƒ±tƒ± + AI analizi"""
    if sonuc_global is None or not karne_combobox.get():
        messagebox.showwarning("Uyarƒ±", "L√ºtfen analiz yapƒ±n ve bir tedarik√ßi se√ßin.")
        return
    supplier_name = karne_combobox.get()
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    
    # Detay verileri al (Stok Grubu bazlƒ±)
    detay_rows = pd.DataFrame()
    if detay_sonuc_global is not None:
        detay_rows = detay_sonuc_global[detay_sonuc_global[tedarikci_col_global] == supplier_name]

    for w in frame_karne_content.winfo_children(): w.destroy()
    grade, color, description = calculate_grade(row["Skor"])
    
    # 1. √úST B√ñL√úM: Firma ve Pareto
    top_frame = tk.Frame(frame_karne_content, bg="white")
    top_frame.pack(fill="x", pady=20, padx=20)
    
    tk.Label(top_frame, text=supplier_name, font=("Segoe UI", 24, "bold"), bg="white", fg="#2c3e50").pack()
    
    # Pareto G√∂sterimi
    pareto_class = row.get("Pareto_Sinifi", "-")
    pareto_color = "#e67e22" if pareto_class == "A" else "#f1c40f" if pareto_class == "B" else "#95a5a6"
    pareto_desc = "(Y√ºksek Ciro)" if pareto_class == "A" else "(Orta Ciro)" if pareto_class == "B" else "(D√º≈ü√ºk Ciro)"
    
    pareto_frame = tk.Frame(top_frame, bg="white", pady=10)
    pareto_frame.pack()
    tk.Label(pareto_frame, text=f"PARETO SINIFI (Cƒ∞RO):", font=("Segoe UI", 10, "bold"), bg="white", fg="gray").pack(side="left")
    tk.Label(pareto_frame, text=f" {pareto_class} {pareto_desc}", font=("Segoe UI", 16, "bold"), bg="white", fg=pareto_color).pack(side="left")
    tk.Label(pareto_frame, text=f" | Toplam Ciro: {row['ToplamTutar']:,.2f} TL", font=("Segoe UI", 12, "bold"), bg="white", fg="#2c3e50").pack(side="left", padx=10)

    # 2. ORTA B√ñL√úM: Performans Notu
    grade_frame = tk.Frame(top_frame, bg=color, padx=20, pady=15, bd=2, relief="groove")
    grade_frame.pack(pady=15, fill="x", padx=100)
    
    tk.Label(grade_frame, text="PERFORMANS NOTU", font=("Segoe UI", 10, "bold"), bg=color, fg="white").pack()
    tk.Label(grade_frame, text=f"{grade}", font=("Arial", 64, "bold"), bg=color, fg="white").pack()
    tk.Label(grade_frame, text=description, font=("Segoe UI", 14, "bold"), bg=color, fg="white").pack()
    tk.Label(grade_frame, text=f"Genel Skor: {row['Skor']:.2f} / 100", font=("Segoe UI", 12), bg=color, fg="white").pack(pady=5)
    
    # Mail Butonu
    mail_col = find_col_by_keywords(sonuc_global, ["mail", "eposta", "email"])
    if mail_col and pd.notna(row.get(mail_col)):
        ttk.Button(top_frame, text="üìß Ki≈üiye √ñzel AI Mail G√∂nder", command=send_scorecard_email_action).pack(pady=10)

    # 3. ALT B√ñL√úM: Stok Grubu Detaylƒ± Analiz (SPLIT VIEW)
    split_frame = tk.Frame(frame_karne_content, bg="white")
    split_frame.pack(fill="both", expand=True, padx=20, pady=10)
    
    # Sol: Tedarik√ßi Ger√ßekle≈üenler
    left_sub = tk.LabelFrame(split_frame, text="Sizin Verileriniz (Ger√ßekle≈üen)", font=("Segoe UI", 10, "bold"), bg="white", fg="#2980b9", padx=5, pady=5)
    left_sub.pack(side="left", fill="both", expand=True, padx=(0, 5))
    
    cols_l = ("Stok Grubu", "Fiyat (TL)", "Termin (G√ºn)", "ƒ∞ade (Adet)")
    tree_l = ttk.Treeview(left_sub, columns=cols_l, show="headings", height=6)
    for col in cols_l: 
        tree_l.heading(col, text=col)
        tree_l.column(col, width=80, anchor="center")
    tree_l.column("Stok Grubu", width=120, anchor="w")
    tree_l.pack(fill="both", expand=True)

    # Saƒü: Pazar Ortalamalarƒ± ve Puan
    right_sub = tk.LabelFrame(split_frame, text="Sekt√∂r Kƒ±yaslamasƒ± & Puanlama", font=("Segoe UI", 10, "bold"), bg="white", fg="#27ae60", padx=5, pady=5)
    right_sub.pack(side="right", fill="both", expand=True, padx=(5, 0))
    
    cols_r = ("Stok Grubu", "Sekt√∂r Fiyat", "Sekt√∂r Termin", "Sekt√∂r ƒ∞ade", "Puan")
    tree_r = ttk.Treeview(right_sub, columns=cols_r, show="headings", height=6)
    for col in cols_r: 
        tree_r.heading(col, text=col)
        tree_r.column(col, width=70, anchor="center")
    tree_r.column("Stok Grubu", width=120, anchor="w")
    tree_r.pack(fill="both", expand=True)

    if not detay_rows.empty and stok_grup_col_global:
        fiyat_col = find_col_by_keywords(detay_rows, ['fiyat','price'])
        teslim_col = find_col_by_keywords(detay_rows, ['teslim','delivery'])
        iade_col = find_col_by_keywords(detay_rows, ['iade','return'])
        
        for idx, r in detay_rows.iterrows():
            sg = r[stok_grup_col_global]
            # Sol Taraf
            tree_l.insert("", "end", values=(sg, f"{r[fiyat_col]:.2f}", f"{r[teslim_col]:.1f}", f"{r[iade_col]:.1f}"))
            
            # Saƒü Taraf (Pazar Ortalamasƒ± Bul)
            market_p = "-"
            market_t = "-"
            market_i = "-"
            if market_averages_global is not None and sg in market_averages_global.index:
                m_row = market_averages_global.loc[sg]
                market_p = f"{m_row[fiyat_col]:.2f}"
                market_t = f"{m_row[teslim_col]:.1f}"
                market_i = f"{m_row[iade_col]:.1f}"
            
            tree_r.insert("", "end", values=(sg, market_p, market_t, market_i, f"{r['Skor']:.1f}"))
    else:
        tk.Label(left_sub, text="Stok Grubu detayƒ± bulunamadƒ±.", bg="white").pack()
        tk.Label(right_sub, text="Kƒ±yaslama yapƒ±lamadƒ±.", bg="white").pack()

    # 3.5 MATEMATƒ∞KSEL HESAPLAMA TABLOSU
    calc_frame = tk.LabelFrame(frame_karne_content, text=f"Matematiksel Hesaplama (Fiyat: %{int(price_weight.get()*100)} + Termin: %{int(delivery_weight.get()*100)} + ƒ∞ade: %{int(return_weight.get()*100)})", font=("Segoe UI", 10, "bold"), bg="white", padx=10, pady=10)
    calc_frame.pack(fill="x", padx=20, pady=10)
    
    cols_calc = ("Stok Grubu", "Fiyat Puanƒ±", "Termin Puanƒ±", "ƒ∞ade Puanƒ±", "Toplam Puan (Aƒüƒ±rlƒ±klƒ±)")
    tree_calc = ttk.Treeview(calc_frame, columns=cols_calc, show="headings", height=4)
    for col in cols_calc:
        tree_calc.heading(col, text=col)
        tree_calc.column(col, anchor="center")
    
    if not detay_rows.empty and stok_grup_col_global:
        for idx, r in detay_rows.iterrows():
            tree_calc.insert("", "end", values=(
                r[stok_grup_col_global],
                f"{r.get('Score_Price', 0):.1f}",
                f"{r.get('Score_Deliv', 0):.1f}",
                f"{r.get('Score_Return', 0):.1f}",
                f"{r['Skor']:.1f}"
            ))
    tree_calc.pack(fill="x")

    # 3.7 HESAPLAMA KANITI VE MANTIƒûI (DETAYLI A√áIKLAMA)
    logic_frame = tk.LabelFrame(frame_karne_content, text="Hesaplama Kanƒ±tƒ± ve Mantƒ±ƒüƒ± (≈ûeffaflƒ±k Raporu)", font=("Segoe UI", 10, "bold"), bg="#fff3e0", padx=10, pady=10)
    logic_frame.pack(fill="x", padx=20, pady=10)
    
    logic_text = ""
    if not detay_rows.empty and stok_grup_col_global:
        r = detay_rows.iloc[0]  # ƒ∞lk satƒ±rƒ± √∂rnek olarak al
        fiyat_col = find_col_by_keywords(detay_rows, ['fiyat','price'])
        teslim_col = find_col_by_keywords(detay_rows, ['teslim','delivery'])
        iade_col = find_col_by_keywords(detay_rows, ['iade','return'])
        
        logic_text += f"√ñRNEK ANALƒ∞Z ({r[stok_grup_col_global]} Grubu ƒ∞√ßin):\n"
        logic_text += f"--------------------------------------------------\n"
        logic_text += f"1. Fƒ∞YAT PUANI ({r.get('Score_Price', 0):.1f}): Hibrit skorlama (%50 min-max + %50 ranking).\n"
        logic_text += f"   Sizin fiyat: {r[fiyat_col]:.2f} TL. Grup i√ßi min: {r.get('Min_Price', 0):.2f}, max: {r.get('Max_Price', 0):.2f}\n\n"
        
        logic_text += f"2. TERMƒ∞N PUANI ({r.get('Score_Deliv', 0):.1f}): Teslimat s√ºrenizin grup i√ßi konumu.\n"
        logic_text += f"   Sizin termin: {r[teslim_col]:.1f} g√ºn. Grup i√ßi min: {r.get('Min_Deliv', 0):.1f}, max: {r.get('Max_Deliv', 0):.1f}\n\n"
        
        logic_text += f"3. ƒ∞ADE PUANI ({r.get('Score_Return', 0):.1f}): ƒ∞ade performansƒ±nƒ±zƒ±n grup i√ßi deƒüerlendirmesi.\n"
        logic_text += f"   Sizin iade: {r[iade_col]:.1f} adet\n"
    else:
        logic_text = "Stok grubu detayƒ± mevcut deƒüil. Genel deƒüerlendirme yapƒ±ldƒ±."

    tk.Label(logic_frame, text=logic_text, justify="left", font=("Consolas", 9), bg="#fff3e0").pack(anchor="w")

    # Not Skalasƒ± Referansƒ±
    scale_frame = tk.Frame(frame_karne_content, bg="white", pady=10)
    scale_frame.pack(fill="x", padx=40)
    scale_text = "NOT SKALASI:  A+ (90-100)  |  A (85-89)  |  B (75-84)  |  C (60-74)  |  D (50-59)  |  F (<50)"
    tk.Label(scale_frame, text=scale_text, font=("Consolas", 10), bg="#f0f0f0", fg="#555").pack()

    # 4. EN ALT: Yapay Zeka Yorumu
    ai_frame = tk.LabelFrame(frame_karne_content, text="ü§ñ Detaylƒ± Yapay Zeka Analizi", font=("Segoe UI", 12, "bold"), bg="white", fg="#8e44ad", padx=10, pady=10)
    ai_frame.pack(fill="x", padx=40, pady=10, side="bottom")
    
    ai_lbl = tk.Label(ai_frame, text="Analiz ediliyor...", font=("Segoe UI", 11), bg="white", justify="left", wraplength=800)
    ai_lbl.pack(fill="x", expand=True)
    
    def fetch_comment():
        comment = get_scorecard_ai_comment(row, grade, description)
        ai_lbl.configure(text=comment)
    threading.Thread(target=fetch_comment, daemon=True).start()

def export_scorecard_pdf():
    if not karne_combobox.get(): return
    supplier_name = karne_combobox.get()
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    grade, _, desc = calculate_grade(row["Skor"])
    
    pdf = FPDF()
    pdf.add_page()
    
    if os.path.exists('DejaVuSans.ttf'):
        pdf.add_font('DejaVu', '', 'DejaVuSans.ttf', uni=True)
        pdf.set_font('DejaVu', '', 14)
    else:
        pdf.set_font("Arial", size=12)
        
    pdf.cell(0, 10, f"TEDARƒ∞K√áƒ∞ KARNESƒ∞: {supplier_name}", ln=True, align='C')
    pdf.ln(10)
    
    pdf.set_font_size(20)
    pdf.cell(0, 10, f"GENEL NOT: {grade}", ln=True, align='C')
    pdf.set_font_size(12)
    pdf.cell(0, 10, f"A√ßƒ±klama: {desc}", ln=True, align='C')
    pdf.cell(0, 10, f"Performans Skoru: {row['Skor']:.2f}", ln=True, align='C')
    pdf.cell(0, 10, f"ABC Sinifi (Pareto): {row.get('Pareto_Sinifi', '-')}", ln=True, align='C')
    pdf.ln(20)
    
    col_width = 45
    pdf.cell(col_width, 10, "Kriter", 1)
    pdf.cell(col_width, 10, "Deƒüer", 1)
    pdf.ln()
    
    metrics = {
        "Ortalama Fiyat": f"{row[find_col_by_keywords(sonuc_global, ['fiyat','price'])]:.2f}",
        "Teslim Suresi": f"{row[find_col_by_keywords(sonuc_global, ['teslim','delivery'])]:.2f}",
        "Iade Miktari": f"{row[find_col_by_keywords(sonuc_global, ['iade','return'])]:.2f}",
        "Toplam Hacim": f"{row.get('ToplamTutar', 0):,.2f}"
    }
    
    for k, v in metrics.items():
        pdf.cell(col_width, 10, k, 1)
        pdf.cell(col_width, 10, str(v), 1)
        pdf.ln()
        
    filename = filedialog.asksaveasfilename(defaultextension=".pdf", initialfile=f"Karne_{supplier_name}.pdf")
    if filename:
        pdf.output(filename)
        messagebox.showinfo("Ba≈üarƒ±lƒ±", "PDF kaydedildi.")

# ---------- TREND ANALƒ∞Zƒ∞ VE AI ----------
def get_trend_ai_comment(trend_data_str):
    if not GEMINI_API_KEY: return "API Anahtarƒ± eksik."
    prompt = f"Aylƒ±k satƒ±n alma verileri (Ay, Fiyat, Miktar):\n{trend_data_str}\nL√ºtfen miktar/fiyat ili≈ükisini 2-3 c√ºmleyle T√ºrk√ße √∂zetle."
    try:
        data = {"contents": [{"parts":[{"text": prompt}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=30)
        return response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
    except: return "Yorum alƒ±namadƒ±."

def update_trend_tab(df, date_col, fiyat_col, miktar_col):
    global trend_fig_global
    for widget in frame_trend.winfo_children(): widget.destroy()
        
    if date_col not in df.columns or fiyat_col not in df.columns:
        tk.Label(frame_trend, text="Trend analizi i√ßin 'Tarih' ve 'Fiyat' gereklidir.", font=("Arial", 12)).pack(pady=20); return

    df_trend = df.copy()
    df_trend[date_col] = pd.to_datetime(df_trend[date_col], errors='coerce')
    df_trend = df_trend.dropna(subset=[date_col])
    
    df_trend[fiyat_col] = pd.to_numeric(df_trend[fiyat_col].astype(str).str.replace(',', '.'), errors='coerce')
    if miktar_col and miktar_col in df_trend.columns:
        df_trend[miktar_col] = pd.to_numeric(df_trend[miktar_col].astype(str).str.replace(',', '.'), errors='coerce')
    else:
        df_trend['__count'] = 1; miktar_col = '__count'

    monthly_data = df_trend.groupby(pd.Grouper(key=date_col, freq='ME')).agg({fiyat_col: 'mean', miktar_col: 'sum'}).reset_index().sort_values(date_col)
    
    if monthly_data.empty: tk.Label(frame_trend, text="Veri bulunamadƒ±.", font=("Arial", 12)).pack(pady=20); return

    fig, ax1 = plt.subplots(figsize=(10, 5))
    ax1.set_xlabel('Tarih'); ax1.set_ylabel('Toplam Miktar', color='tab:blue', fontweight='bold')
    ax1.bar(monthly_data[date_col], monthly_data[miktar_col], color='tab:blue', alpha=0.6, width=20, label='Miktar')
    ax1.tick_params(axis='y', labelcolor='tab:blue')
    
    ax2 = ax1.twinx(); ax2.set_ylabel('Ortalama Fiyat', color='tab:red', fontweight='bold')
    line = ax2.plot(monthly_data[date_col], monthly_data[fiyat_col], color='tab:red', marker='o', linewidth=2, label='Fiyat')
    ax2.tick_params(axis='y', labelcolor='tab:red')

    plt.title("Aylƒ±k Alƒ±m Miktarƒ± ve Fiyat Trendi", fontsize=14); fig.tight_layout(); trend_fig_global = fig

    canvas = FigureCanvasTkAgg(fig, master=frame_trend); canvas.draw(); canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
    NavigationToolbar2Tk(canvas, frame_trend).pack(fill=tk.X)

    comment_frame = tk.LabelFrame(frame_trend, text="Yapay Zeka Trend Analizi", font=("Arial", 10, "bold"), fg="#2c3e50"); comment_frame.pack(side=tk.BOTTOM, fill="x", padx=10, pady=10)
    loading_lbl = tk.Label(comment_frame, text="Yorum olu≈üturuluyor...", font=("Arial", 9, "italic")); loading_lbl.pack(padx=10, pady=10, anchor="w")
    
    def fetch_comment():
        comment = get_trend_ai_comment(monthly_data.tail(12).to_string(index=False))
        if loading_lbl.winfo_exists(): loading_lbl.configure(text=comment, font=("Arial", 10), fg="#2c3e50", justify="left", wraplength=900)
    threading.Thread(target=fetch_comment, daemon=True).start()

# ---------- GELECEK TAHMƒ∞Nƒ∞ (FORECASTING) ----------
def update_forecast_tab(df, date_col, fiyat_col):
    global forecast_fig_global
    for widget in frame_tahmin.winfo_children(): widget.destroy()
    
    # Ba≈ülƒ±k ve kontrol paneli
    header_frame = tk.Frame(frame_tahmin, bg="#2c3e50", padx=20, pady=15)
    header_frame.pack(fill="x")
    tk.Label(header_frame, text="üìà Gelecek Ay Fiyat Tahmini", font=("Segoe UI", 16, "bold"), fg="white", bg="#2c3e50").pack(anchor="w")
    tk.Label(header_frame, text="Lineer Regresyon ile Trend Analizi", font=("Segoe UI", 10), fg="#ecf0f1", bg="#2c3e50").pack(anchor="w")
    
    if date_col not in df.columns or fiyat_col not in df.columns:
        tk.Label(frame_tahmin, text="Tahmin i√ßin 'Tarih' ve 'Fiyat' verisi gereklidir.", font=("Arial", 12)).pack(pady=20); return

    df_fc = df.copy()
    df_fc[date_col] = pd.to_datetime(df_fc[date_col], errors='coerce')
    df_fc = df_fc.dropna(subset=[date_col])
    df_fc[fiyat_col] = pd.to_numeric(df_fc[fiyat_col].astype(str).str.replace(',', '.'), errors='coerce')
    
    monthly_data = df_fc.groupby(pd.Grouper(key=date_col, freq='ME')).agg({fiyat_col: 'mean'}).reset_index().sort_values(date_col)
    monthly_data = monthly_data.dropna(subset=[fiyat_col])
    
    if monthly_data.empty or len(monthly_data) < 2:
        tk.Label(frame_tahmin, text="Tahmin yapabilmek i√ßin en az 2 aylƒ±k veri gereklidir.", font=("Arial", 12)).pack(pady=20); return

    fig, ax1 = plt.subplots(1, 1, figsize=(12, 8))
    
    # SADECE Lƒ∞NEER REGRESYON KULLAN - Prophet kodu kaldƒ±rƒ±ldƒ±
    try:
        ax1.plot(monthly_data[date_col], monthly_data[fiyat_col], marker='o', linestyle='-', color='blue', label='Ge√ßmi≈ü Fiyatlar', linewidth=2, markersize=8)
        
        x_numeric = np.arange(len(monthly_data))
        y_price = monthly_data[fiyat_col].values
        
        # Veri istatistikleri
        price_mean = y_price.mean()
        price_std = y_price.std()
        price_min = y_price.min()
        price_max = y_price.max()
        last_price = y_price[-1]
        
        # Son 3 ayƒ±n ortalamasƒ± (daha stabil tahmin i√ßin)
        recent_avg = y_price[-3:].mean() if len(y_price) >= 3 else last_price
        
        z = np.polyfit(x_numeric, y_price, 1)
        p = np.poly1d(z)
        slope = z[0]  # Eƒüim (trend)
        
        next_month_index = len(x_numeric)
        next_month_price_raw = p(next_month_index)
        
        # GELI≈ûTIRILMI≈û A≈ûIRI TAHMƒ∞N √ñNLEME - Daha Makul Sonu√ßlar
        next_month_price = next_month_price_raw
        
        # 1. MUTLAK KURAL: Negatif deƒüerleri engelle
        if next_month_price < 0:
            next_month_price = max(recent_avg * 0.95, price_min * 0.95)
        
        # 2. A≈üƒ±rƒ± deƒüi≈üimleri sƒ±nƒ±rla (¬±30% maksimum - daha makul)
        max_change_pct = 0.30  # %30 maksimum deƒüi≈üim (daha ger√ßek√ßi)
        max_allowed_increase = last_price * (1 + max_change_pct)
        max_allowed_decrease = last_price * (1 - max_change_pct)
        
        if next_month_price > max_allowed_increase:
            # √áok y√ºksek tahmin - son fiyata +%15 ekle
            next_month_price = last_price * 1.15
        elif next_month_price < max_allowed_decrease:
            # √áok d√º≈ü√ºk tahmin - son fiyata -%15 ekle
            next_month_price = max(last_price * 0.85, price_min * 0.95)
        
        # 3. Standart sapma kontrol√º (¬±1.5 standart sapma - daha sƒ±kƒ±)
        upper_bound = price_mean + (1.5 * price_std)
        lower_bound = max(price_min * 0.95, price_mean - (1.5 * price_std))
        
        if next_month_price > upper_bound:
            next_month_price = min(upper_bound, last_price * 1.10)
        elif next_month_price < lower_bound:
            next_month_price = max(lower_bound, last_price * 0.90, price_min * 0.95)
        
        # 4. Zayƒ±f trend kontrol√º - daha saƒülam mantƒ±k
        if abs(slope) < price_std * 0.15:
            # Trend √ßok zayƒ±f, son deƒüere yakƒ±n kal
            next_month_price = last_price * (1 + (slope / last_price if last_price > 0 else 0) * 0.5)
        
        # 5. Veri aralƒ±ƒüƒ± sƒ±nƒ±rlamasƒ± (daha sƒ±kƒ±)
        data_range = price_max - price_min
        if next_month_price > price_max + (data_range * 0.2):
            next_month_price = price_max + (data_range * 0.10)
        elif next_month_price < price_min - (data_range * 0.2):
            next_month_price = max(price_min * 0.95, price_min - (data_range * 0.10))
        
        # 6. SON KONTROL: Minimum 1 TL ve mevcut fiyatƒ±n %50'sinden az olmasƒ±n
        next_month_price = max(1.0, last_price * 0.50, next_month_price)
        
        # 7. Veri setindeki minimum deƒüerin %90'ƒ±ndan az olmasƒ±n
        next_month_price = max(price_min * 0.90, next_month_price)
        
        last_date = monthly_data[date_col].iloc[-1]
        next_date = last_date + pd.DateOffset(months=1)
        
        # Tahmin √ßizgisi ve nokta
        ax1.plot([last_date, next_date], [y_price[-1], next_month_price], 'r--', marker='x', markersize=15, linewidth=3, label='Gelecek Ay Tahmini')
        ax1.plot(monthly_data[date_col], p(x_numeric), "g:", alpha=0.5, linewidth=2, label="Trend √áizgisi")
        
        # Ge√ßmi≈ü verilere deƒüer etiketleri ekle (son 6 ay)
        recent_indices = list(range(max(0, len(monthly_data)-6), len(monthly_data)))
        for i in recent_indices:
            ax1.annotate(f'{y_price[i]:.1f}', 
                       xy=(monthly_data[date_col].iloc[i], y_price[i]),
                       xytext=(0, 8), textcoords='offset points',
                       ha='center', fontsize=9, color='black',
                       bbox=dict(boxstyle='round,pad=0.3', facecolor='white', alpha=0.8, edgecolor='gray'))
        
        # Gelecek tahminine B√úY√úK deƒüer etiketi ekle
        ax1.annotate(f'{next_month_price:.1f} TL', 
                   xy=(next_date, next_month_price),
                   xytext=(0, 15), textcoords='offset points',
                   ha='center', fontsize=12, fontweight='bold', color='red',
                   bbox=dict(boxstyle='round,pad=0.5', facecolor='yellow', alpha=0.9, edgecolor='red', linewidth=2))
        
        ax1.set_title("Lineer Regresyon ile Fiyat Tahmini", fontsize=16, fontweight='bold')
        ax1.set_xlabel("Tarih", fontsize=12)
        ax1.set_ylabel("Fiyat (TL)", fontsize=12)
        ax1.legend(loc='best', fontsize=11)
        ax1.grid(True, alpha=0.3)
        
        change = next_month_price - y_price[-1]
        change_pct = (change / y_price[-1] * 100) if y_price[-1] > 0 else 0
        trend = "ARTI≈û ‚Üó" if change > 0 else "D√ú≈û√ú≈û ‚Üò" if change < 0 else "STABIL ‚Üí"
        trend_color = "green" if change > 0 else "red" if change < 0 else "gray"
        
        # G√ºven seviyesi hesapla
        if abs(change_pct) < 10:
            confidence = "Y√ºksek ‚úì"
        elif abs(change_pct) < 20:
            confidence = "Orta"
        else:
            confidence = "D√º≈ü√ºk"
        
        info_text = f"""üìä TAHMƒ∞N SONU√áLARI (Lineer Regresyon):
        
üìÖ Gelecek Ay: {next_date.strftime('%B %Y')}
üí∞ Tahmini Fiyat: {next_month_price:.2f} TL
üìä Mevcut Fiyat: {y_price[-1]:.2f} TL
üìà Beklenen Deƒüi≈üim: {change:+.2f} TL ({change_pct:+.1f}% {trend})
üìâ Son 3 Ay Ortalamasƒ±: {recent_avg:.2f} TL
üéØ G√ºven Seviyesi: {confidence}

‚úÖ MAKUL Fƒ∞YAT KONTROLLERI:
‚Ä¢ Maksimum deƒüi≈üim: ¬±30%
‚Ä¢ Standart sapma kontrol√º (¬±1.5œÉ)
‚Ä¢ Minimum fiyat garantisi
‚Ä¢ Negatif deƒüer korumasƒ±
‚Ä¢ Veri aralƒ±ƒüƒ± sƒ±nƒ±rlamasƒ±"""
        
    except Exception as e:
        info_text = f"Tahmin hatasƒ±: {e}"
        next_month_price = 0
        change = 0
        change_pct = 0
        trend = "Hata"
        trend_color = "black"
    
    plt.tight_layout()
    
    canvas = FigureCanvasTkAgg(fig, frame_tahmin)
    canvas.draw()
    canvas.get_tk_widget().pack(fill='both', expand=True, padx=10, pady=10)
    
    # Bilgi kartƒ±
    info_frame = tk.Frame(frame_tahmin, bg="white", bd=2, relief="solid")
    info_frame.pack(fill="x", padx=20, pady=10)
    tk.Label(info_frame, text=info_text, font=("Courier New", 10), bg="white", fg="#2c3e50", justify="left", padx=15, pady=15).pack(anchor="w")
    
    # HAREKET EDEN EKRAN - Deƒüi≈üim g√∂stergesi (animasyonlu)
    if next_month_price > 0:
        movement_frame = tk.Frame(frame_tahmin, bg="#ecf0f1", bd=3, relief="raised")
        movement_frame.pack(fill="x", padx=20, pady=15)
        
        # Deƒüi≈üim ba≈ülƒ±ƒüƒ±
        change_header = tk.Label(movement_frame, text="üíπ Fƒ∞YAT DEƒûƒ∞≈ûƒ∞Mƒ∞ TAHMƒ∞Nƒ∞", 
                                font=("Segoe UI", 14, "bold"), bg="#ecf0f1", fg="#2c3e50")
        change_header.pack(pady=(10, 5))
        
        # B√ºy√ºk deƒüi≈üim g√∂stergesi
        change_display = tk.Label(movement_frame, 
                                 text=f"{change:+.2f} TL\n({change_pct:+.1f}%)",
                                 font=("Arial", 32, "bold"), 
                                 bg="#ecf0f1", 
                                 fg=trend_color)
        change_display.pack(pady=10)
        
        # Trend oku ve a√ßƒ±klama
        trend_label = tk.Label(movement_frame, text=f"Trend: {trend}", 
                              font=("Segoe UI", 16, "bold"), bg="#ecf0f1", fg=trend_color)
        trend_label.pack(pady=5)
        
        # Basit animasyon efekti fonksiyonu
        def animate_change():
            colors = [trend_color, "#f0f0f0", trend_color]
            current_color = [0]
            
            def update_color():
                change_display.config(fg=colors[current_color[0] % len(colors)])
                current_color[0] += 1
                if current_color[0] < 6:  # 6 kere yanƒ±p s√∂n
                    root.after(500, update_color)
                else:
                    change_display.config(fg=trend_color)
            
            update_color()
        
        # Animasyonu ba≈ülat
        root.after(100, animate_change)
    
    forecast_fig_global = fig

# ---------- AKILLI Sƒ∞PARƒ∞≈û Sƒ∞Hƒ∞RBAZI ----------
def init_smart_order_tab():
    global order_treeview, order_ai_text, siparis_stok_combobox, siparis_grup_combobox, siparis_search_type_var
    
    for widget in frame_siparis.winfo_children(): widget.destroy()
    
    main_layout = tk.PanedWindow(frame_siparis, orient=tk.HORIZONTAL)
    main_layout.pack(fill="both", expand=True, padx=10, pady=10)
    
    left_panel = tk.Frame(main_layout)
    main_layout.add(left_panel, width=700)
    
    tk.Label(left_panel, text="üõí AI Destekli Sipari≈ü Planlama", font=("Segoe UI", 16, "bold"), fg="#2c3e50").pack(anchor="w", pady=(0, 10))
    
    input_frame = tk.LabelFrame(left_panel, text="Sipari≈ü Parametreleri", font=("Segoe UI", 10, "bold"), fg="#2980b9", padx=10, pady=10)
    input_frame.pack(fill="x", pady=5)
    
    # Arama tipi se√ßimi (Stok Kodu veya Stok Grubu)
    siparis_search_type_var = tk.StringVar(value="code")
    
    def toggle_search_fields():
        """Arama tipine g√∂re ilgili combobox'ƒ± g√∂ster/gizle"""
        search_type = siparis_search_type_var.get()
        if search_type == "code":
            siparis_stok_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="w")
            siparis_grup_combobox.grid_forget()
        else:
            siparis_grup_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="w")
            siparis_stok_combobox.grid_forget()
    
    tk.Label(input_frame, text="Arama Tipi:", font=("Segoe UI", 10)).grid(row=0, column=0, padx=5, pady=5, sticky="e")
    radio_frame = tk.Frame(input_frame)
    radio_frame.grid(row=0, column=1, padx=5, pady=5, sticky="w", columnspan=2)
    ttk.Radiobutton(radio_frame, text="Stok Kodu", variable=siparis_search_type_var, value="code", command=toggle_search_fields).pack(side="left", padx=5)
    ttk.Radiobutton(radio_frame, text="Stok Grubu", variable=siparis_search_type_var, value="group", command=toggle_search_fields).pack(side="left", padx=5)
    
    tk.Label(input_frame, text="Se√ßim:", font=("Segoe UI", 10)).grid(row=1, column=0, padx=5, pady=5, sticky="e")
    
    # Stok Kodu combobox
    siparis_stok_combobox = ttk.Combobox(input_frame, state="normal", width=30)
    siparis_stok_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="w")
    if all_stock_codes:
        siparis_stok_combobox['values'] = all_stock_codes
    
    # Stok Grubu combobox (initially hidden)
    siparis_grup_combobox = ttk.Combobox(input_frame, state="normal", width=30)
    if all_stock_groups:
        siparis_grup_combobox['values'] = all_stock_groups
    # Grid initially but then hide since default is "code" mode
    siparis_grup_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="w")
    siparis_grup_combobox.grid_forget()
    
    tk.Label(input_frame, text="ƒ∞htiya√ß Duyulan Miktar (Adet):", font=("Segoe UI", 10)).grid(row=2, column=0, padx=5, pady=5, sticky="e")
    qty_entry = ttk.Entry(input_frame, width=15)
    qty_entry.grid(row=2, column=1, padx=5, pady=5, sticky="w")
    
    calc_btn = ttk.Button(input_frame, text="‚ö° Optimum Daƒüƒ±tƒ±mƒ± Hesapla", command=lambda: run_order_allocation(qty_entry))
    calc_btn.grid(row=2, column=2, padx=15, pady=5, sticky="e")
    
    # D√∂viz Sim√ºlasyonu Butonu
    currency_btn = tk.Button(input_frame, text="üí± D√∂viz Sim√ºlasyonu", bg="#e74c3c", fg="white", font=("Segoe UI", 9, "bold"), command=show_currency_simulation)
    currency_btn.grid(row=2, column=3, padx=5, pady=5, sticky="e")
    
    tree_frame = tk.LabelFrame(left_panel, text="√ñnerilen Sipari≈ü Daƒüƒ±lƒ±mƒ±", font=("Segoe UI", 10, "bold"), fg="#27ae60")
    tree_frame.pack(fill="both", expand=True, pady=10)
    
    cols = ("Tedarik√ßi", "Skor", "Not", "Fiyat (TL)", "Tahsis Edilen Miktar", "Toplam Maliyet")
    order_treeview = ttk.Treeview(tree_frame, columns=cols, show="headings")
    
    for col in cols:
        order_treeview.heading(col, text=col)
        order_treeview.column(col, width=100, anchor="center")
    
    order_treeview.column("Tedarik√ßi", width=200, anchor="w")
    order_treeview.pack(side="left", fill="both", expand=True, padx=5, pady=5)
    
    sc = tk.Scrollbar(tree_frame, orient="vertical", command=order_treeview.yview)
    sc.pack(side="right", fill="y")
    order_treeview.configure(yscrollcommand=sc.set)
    
    right_panel = tk.Frame(main_layout, bg="white", bd=1, relief="solid")
    main_layout.add(right_panel)
    
    tk.Label(right_panel, text="üß† CPO Raporu & Gerek√ße", font=("Segoe UI", 12, "bold"), bg="white", fg="#8e44ad").pack(pady=10)
    
    order_ai_text = tk.Text(right_panel, wrap="word", font=("Segoe UI", 10), bg="#f9f9f9", padx=10, pady=10, height=25)
    order_ai_text.pack(fill="both", expand=True, padx=10, pady=(0, 10))
    order_ai_text.insert("1.0", "L√ºtfen bir √ºr√ºn ve miktar se√ßip hesaplama ba≈ülatƒ±n.\n\nYapay Zeka, daƒüƒ±tƒ±m mantƒ±ƒüƒ±nƒ± burada a√ßƒ±klayacaktƒ±r.")
    order_ai_text.configure(state="disabled")
    
    btn_frame = tk.Frame(right_panel, bg="white")
    btn_frame.pack(fill="x", pady=10, padx=10)
    
    ttk.Button(btn_frame, text="‚úâÔ∏è Taslak Sipari≈ü Maillerini Olu≈ütur", command=generate_order_drafts).pack(fill="x", pady=5)

def show_currency_simulation():
    """D√∂viz kuru deƒüi≈üimi sim√ºlasyonu (What-If analizi)"""
    if df_global is None or sonuc_global is None:
        messagebox.showwarning("Uyarƒ±", "L√ºtfen √∂nce verileri analiz edin!")
        return
    
    # Sim√ºlasyon penceresi
    sim_window = tk.Toplevel(root)
    sim_window.title("üí± D√∂viz Sim√ºlasyonu - What-If Analizi")
    sim_window.geometry("900x700")
    sim_window.configure(bg="#ecf0f1")
    
    # Ba≈ülƒ±k
    header = tk.Frame(sim_window, bg="#34495e", padx=20, pady=15)
    header.pack(fill="x")
    tk.Label(header, text="üí± D√∂viz Kuru Sim√ºlasyonu", font=("Segoe UI", 16, "bold"), fg="white", bg="#34495e").pack()
    tk.Label(header, text="D√∂viz kurundaki deƒüi≈üimin maliyetlere etkisini analiz edin", font=("Segoe UI", 10), fg="#ecf0f1", bg="#34495e").pack()
    
    # ƒ∞√ßerik
    content = tk.Frame(sim_window, bg="#ecf0f1", padx=20, pady=20)
    content.pack(fill="both", expand=True)
    
    # Senaryo giri≈üi
    scenario_frame = tk.LabelFrame(content, text="Senaryo Parametreleri", font=("Segoe UI", 11, "bold"), bg="white", padx=15, pady=15)
    scenario_frame.pack(fill="x", pady=10)
    
    tk.Label(scenario_frame, text="USD Deƒüi≈üim Oranƒ± (%):", bg="white", font=("Segoe UI", 10)).grid(row=0, column=0, sticky="w", pady=5, padx=5)
    usd_entry = ttk.Entry(scenario_frame, width=15)
    usd_entry.insert(0, "10")
    usd_entry.grid(row=0, column=1, pady=5, padx=5)
    
    tk.Label(scenario_frame, text="EUR Deƒüi≈üim Oranƒ± (%):", bg="white", font=("Segoe UI", 10)).grid(row=1, column=0, sticky="w", pady=5, padx=5)
    eur_entry = ttk.Entry(scenario_frame, width=15)
    eur_entry.insert(0, "10")
    eur_entry.grid(row=1, column=1, pady=5, padx=5)
    
    tk.Label(scenario_frame, text="(Pozitif deƒüer artƒ±≈ü, negatif deƒüer d√º≈ü√º≈ü)", bg="white", font=("Segoe UI", 8, "italic"), fg="gray").grid(row=2, column=0, columnspan=2, sticky="w", pady=2, padx=5)
    
    # Sonu√ß alanƒ±
    result_text = tk.Text(content, wrap="word", font=("Courier New", 10), height=20, bg="#f9f9f9")
    result_text.pack(fill="both", expand=True, pady=10)
    result_text.insert("1.0", "Hesaplama yapmak i√ßin 'Sim√ºlasyonu √áalƒ±≈ütƒ±r' butonuna tƒ±klayƒ±n...")
    
    def run_simulation():
        try:
            usd_change = float(usd_entry.get())
            eur_change = float(eur_entry.get())
            
            result_text.configure(state="normal")
            result_text.delete("1.0", "end")
            
            # Mevcut maliyet hesapla (basitle≈ütirilmi≈ü)
            fiyat_col = find_col_by_keywords(df_global, ["fiyat", "price"])
            if not fiyat_col:
                result_text.insert("1.0", "‚ö†Ô∏è Fiyat kolonu bulunamadƒ±!")
                return
            
            df_calc = df_global.copy()
            df_calc[fiyat_col] = pd.to_numeric(df_calc[fiyat_col].astype(str).str.replace(',', '.'), errors='coerce')
            
            miktar_col = find_col_by_keywords(df_global, ["miktar", "adet", "quantity"])
            if miktar_col:
                df_calc[miktar_col] = pd.to_numeric(df_calc[miktar_col], errors='coerce')
                current_total = (df_calc[fiyat_col] * df_calc[miktar_col]).sum()
            else:
                current_total = df_calc[fiyat_col].sum()
            
            # D√∂viz etkisi varsayƒ±mlarƒ±
            # Basit model: Maliyetin %40'ƒ± USD, %30'u EUR, %30'u TL cinsinden
            usd_portion = 0.40
            eur_portion = 0.30
            tl_portion = 0.30
            
            usd_impact = current_total * usd_portion * (usd_change / 100)
            eur_impact = current_total * eur_portion * (eur_change / 100)
            total_impact = usd_impact + eur_impact
            
            new_total = current_total + total_impact
            impact_pct = (total_impact / current_total) * 100
            
            # Tedarik√ßi bazƒ±nda etki (Stok Grubu ile birlikte)
            supplier_col = tedarikci_col_global
            stok_grup_col = stok_grup_col_global
            
            supplier_impact = []
            supplier_by_stock_group = {}
            
            if supplier_col:
                # Stok Grubu varsa, √∂nce stok grubu bazƒ±nda grupla
                if stok_grup_col and stok_grup_col in df_calc.columns:
                    # Stok grubu + tedarik√ßi kombinasyonlarƒ±
                    for idx, row in df_calc.iterrows():
                        supplier = row[supplier_col]
                        stock_group = row.get(stok_grup_col, "Bilinmiyor")
                        
                        if pd.isna(stock_group) or stock_group == "":
                            stock_group = "Bilinmiyor"
                        
                        # Hesaplama
                        if miktar_col:
                            row_total = row[fiyat_col] * row.get(miktar_col, 1)
                        else:
                            row_total = row[fiyat_col]
                        
                        key = (stock_group, supplier)
                        if key not in supplier_by_stock_group:
                            supplier_by_stock_group[key] = 0
                        supplier_by_stock_group[key] += row_total
                    
                    # Etki hesapla
                    for (stock_group, supplier), sup_total in supplier_by_stock_group.items():
                        sup_usd_impact = sup_total * usd_portion * (usd_change / 100)
                        sup_eur_impact = sup_total * eur_portion * (eur_change / 100)
                        sup_new_total = sup_total + sup_usd_impact + sup_eur_impact
                        
                        supplier_impact.append({
                            'stock_group': stock_group,
                            'supplier': supplier,
                            'current': sup_total,
                            'new': sup_new_total,
                            'change': sup_new_total - sup_total
                        })
                else:
                    # Stok grubu yoksa sadece tedarik√ßi bazƒ±nda
                    for supplier in df_calc[supplier_col].unique():
                        supplier_data = df_calc[df_calc[supplier_col] == supplier]
                        if miktar_col:
                            sup_total = (supplier_data[fiyat_col] * supplier_data[miktar_col]).sum()
                        else:
                            sup_total = supplier_data[fiyat_col].sum()
                        
                        sup_usd_impact = sup_total * usd_portion * (usd_change / 100)
                        sup_eur_impact = sup_total * eur_portion * (eur_change / 100)
                        sup_new_total = sup_total + sup_usd_impact + sup_eur_impact
                        
                        supplier_impact.append({
                            'stock_group': None,
                            'supplier': supplier,
                            'current': sup_total,
                            'new': sup_new_total,
                            'change': sup_new_total - sup_total
                        })
            
            # Rapor olu≈ütur
            report = f"""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë           D√ñVƒ∞Z KURU DEƒûƒ∞≈ûƒ∞Mƒ∞ Sƒ∞M√úLASYONU                    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìä SENARYO PARAMETRELERƒ∞:
   ‚Ä¢ USD Deƒüi≈üimi: {usd_change:+.1f}%
   ‚Ä¢ EUR Deƒüi≈üimi: {eur_change:+.1f}%

üí∞ MALƒ∞YET ANALƒ∞Zƒ∞:
   
   Mevcut Toplam Maliyet:    ‚Ç∫{current_total:,.2f}
   
   USD Etkisi ({usd_portion:.0%}):    {usd_impact:+,.2f} TL
   EUR Etkisi ({eur_portion:.0%}):    {eur_impact:+,.2f} TL
   TL Kƒ±smƒ± ({tl_portion:.0%}):      Deƒüi≈ümez
   
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Yeni Toplam Maliyet:      ‚Ç∫{new_total:,.2f}
   Toplam Deƒüi≈üim:           {total_impact:+,.2f} TL ({impact_pct:+.2f}%)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

"""
            
            if supplier_impact:
                # Stok grubu varsa, gruplanmƒ±≈ü ≈üekilde g√∂ster
                if stok_grup_col and any(item['stock_group'] is not None for item in supplier_impact):
                    report += "\nüìã STOK GRUBU VE TEDARƒ∞K√áƒ∞ BAZINDA ETKƒ∞:\n\n"
                    
                    # Stok gruplarƒ±na g√∂re sƒ±rala
                    supplier_impact_sorted = sorted(supplier_impact, key=lambda x: (x['stock_group'], -abs(x['change'])))
                    
                    current_group = None
                    for item in supplier_impact_sorted:
                        # Yeni stok grubu ba≈ülƒ±ƒüƒ±
                        if item['stock_group'] != current_group:
                            current_group = item['stock_group']
                            report += f"\nüîπ {current_group}\n"
                            report += "‚îÄ" * 85 + "\n"
                            report += f"{'  Tedarik√ßi':<30} {'Mevcut':<18} {'Yeni':<18} {'Deƒüi≈üim':<18}\n"
                            report += "‚îÄ" * 85 + "\n"
                        
                        # Tedarik√ßi detayƒ±
                        report += f"  {item['supplier']:<28} ‚Ç∫{item['current']:>14,.0f} ‚Ç∫{item['new']:>14,.0f} {item['change']:>+15,.0f}\n"
                    
                    # Genel toplam t√ºm tedarik√ßiler
                    report += "\n" + "‚ïê" * 85 + "\n"
                    report += f"\nüìä GENEL √ñZET:\n"
                    report += f"   ‚Ä¢ Toplam Tedarik√ßi Sayƒ±sƒ±: {len(supplier_impact)}\n"
                    report += f"   ‚Ä¢ Toplam Stok Grubu Sayƒ±sƒ±: {len(set(item['stock_group'] for item in supplier_impact))}\n"
                    
                else:
                    # Stok grubu yoksa klasik g√∂sterim (t√ºm tedarik√ßiler)
                    report += "\nüìã TEDARƒ∞K√áƒ∞ BAZINDA ETKƒ∞ (T√ºm Tedarik√ßiler):\n\n"
                    report += f"{'Tedarik√ßi':<30} {'Mevcut':<18} {'Yeni':<18} {'Deƒüi≈üim':<18}\n"
                    report += "‚îÄ" * 85 + "\n"
                    
                    for item in sorted(supplier_impact, key=lambda x: abs(x['change']), reverse=True):
                        report += f"{item['supplier']:<30} ‚Ç∫{item['current']:>14,.0f} ‚Ç∫{item['new']:>14,.0f} {item['change']:>+15,.0f}\n"
                    
                    report += "\n" + "‚îÄ" * 85 + "\n"
                    report += f"Toplam Tedarik√ßi: {len(supplier_impact)}\n"
            
            report += f"""

üí° STRATEJƒ∞K √ñNERƒ∞LER:

"""
            if impact_pct > 5:
                report += f"‚ö†Ô∏è  Y√úKSEK ETKƒ∞: %{abs(impact_pct):.1f} oranƒ±nda maliyet {'artƒ±≈üƒ±' if impact_pct > 0 else 'azalƒ±≈üƒ±'} bekleniyor!\n"
                if impact_pct > 0:
                    report += "   ‚Ä¢ Hedging stratejileri deƒüerlendirilmeli\n"
                    report += "   ‚Ä¢ Alternatif tedarik√ßiler ara≈ütƒ±rƒ±lmalƒ±\n"
                    report += "   ‚Ä¢ Fiyat revizyon planlarƒ± hazƒ±rlanmalƒ±\n"
            elif impact_pct > 2:
                report += f"‚ö° ORTA ETKƒ∞: %{abs(impact_pct):.1f} oranƒ±nda maliyet deƒüi≈üimi\n"
                report += "   ‚Ä¢ B√ºt√ße revizyonu gerekebilir\n"
                report += "   ‚Ä¢ Risk y√∂netim planlarƒ± g√∂zden ge√ßirilmeli\n"
            else:
                report += f"‚úÖ D√ú≈û√úK ETKƒ∞: %{abs(impact_pct):.1f} oranƒ±nda sƒ±nƒ±rlƒ± etki\n"
                report += "   ‚Ä¢ Mevcut stratejiler devam edebilir\n"
            
            result_text.insert("1.0", report)
            result_text.configure(state="disabled")
            
            # LOG
            if activity_logger:
                activity_logger.log_analysis("CURRENCY_SIMULATION", f"USD: {usd_change:+.1f}%, EUR: {eur_change:+.1f}%, Etki: {impact_pct:+.2f}%", "Akƒ±llƒ± Sipari≈ü")
            
        except ValueError:
            messagebox.showerror("Hata", "L√ºtfen ge√ßerli sayƒ±sal deƒüerler girin!")
        except Exception as e:
            result_text.configure(state="normal")
            result_text.insert("1.0", f"‚ö†Ô∏è Sim√ºlasyon hatasƒ±: {str(e)}")
    
    # Butonlar
    btn_frame = tk.Frame(content, bg="#ecf0f1")
    btn_frame.pack(fill="x", pady=10)
    
    tk.Button(btn_frame, text="üîÑ Sim√ºlasyonu √áalƒ±≈ütƒ±r", bg="#3498db", fg="white", font=("Segoe UI", 10, "bold"), padx=20, pady=8, command=run_simulation).pack(side="left", padx=5)
    tk.Button(btn_frame, text="‚úñ Kapat", bg="#95a5a6", fg="white", font=("Segoe UI", 10), padx=20, pady=8, command=sim_window.destroy).pack(side="right", padx=5)
    
    # ƒ∞lk sim√ºlasyonu otomatik √ßalƒ±≈ütƒ±r
    run_simulation()

def run_order_allocation(qty_entry):
    if df_global is None or sonuc_global is None:
        messagebox.showerror("Hata", "L√ºtfen √∂nce 'Analiz' sekmesinden verileri y√ºkleyin.")
        return
    
    # Arama tipini kontrol et
    search_type = siparis_search_type_var.get() if siparis_search_type_var else "code"
    
    if search_type == "code":
        search_value = siparis_stok_combobox.get()
        search_label = "√ºr√ºn"
    else:
        search_value = siparis_grup_combobox.get()
        search_label = "stok grubu"
    
    qty_str = qty_entry.get().strip()
    
    if not search_value or not qty_str:
        messagebox.showwarning("Eksik Bilgi", f"L√ºtfen {search_label} ve miktar giriniz.")
        return
        
    try:
        total_qty = int(qty_str)
    except ValueError:
        messagebox.showerror("Hata", "Miktar sayƒ±sal olmalƒ±dƒ±r.")
        return

    stok_col = find_stok_kodu_column(df_global)
    if not stok_col: return
    
    if search_value == "T√ºm Veri":
        messagebox.showwarning("Uyarƒ±", f"Sipari≈ü planlamasƒ± i√ßin spesifik bir {search_label} se√ßmelisiniz.")
        return
    
    # Arama tipine g√∂re veri filtreleme
    if search_type == "code":
        # Stok koduna g√∂re filtrele
        norm_stock = normalize_series(df_global[stok_col])
        norm_target = str(search_value).strip().lower()
        relevant_data = df_global[norm_stock == norm_target].copy()
    else:
        # Stok grubuna g√∂re filtrele
        if not stok_grup_col_global:
            messagebox.showerror("Hata", "Stok grubu kolonu bulunamadƒ±. L√ºtfen veri dosyanƒ±zƒ±n 'stok grubu' kolonuna sahip olduƒüundan emin olun.")
            return
        
        norm_group = normalize_series(df_global[stok_grup_col_global])
        norm_target = str(search_value).strip().lower()
        relevant_data = df_global[norm_group == norm_target].copy()
    
    if relevant_data.empty:
        messagebox.showerror("Hata", f"Bu {search_label} i√ßin veri bulunamadƒ±.")
        return
        
    fiyat_col = find_col_by_keywords(df_global, ["fiyat", "price"])
    ted_col = tedarikci_col_global
    
    relevant_data[fiyat_col] = pd.to_numeric(relevant_data[fiyat_col].astype(str).str.replace(',', '.'), errors='coerce')
    supplier_prices = relevant_data.groupby(ted_col)[fiyat_col].mean().reset_index()
    
    # D√úZELTME: E≈üle≈üme hatasƒ±nƒ± √∂nlemek i√ßin isimleri normalize et (strip ve lower)
    supplier_prices['temp_key'] = supplier_prices[ted_col].astype(str).str.strip().str.lower()
    
    temp_sonuc = sonuc_global.copy()
    temp_sonuc['temp_key'] = temp_sonuc[ted_col].astype(str).str.strip().str.lower()
    
    merged = pd.merge(supplier_prices, temp_sonuc[['temp_key', "Skor", "Pareto_Sinifi"]], on='temp_key', how="inner")
    
    if merged.empty:
        msg = "Se√ßilen √ºr√ºn√ºn tedarik√ßileri mevcut analiz sonu√ßlarƒ±yla e≈üle≈ütirilemedi.\n\n" \
              "Olasƒ± Sebepler:\n" \
              "1. 'Analiz' sekmesindeki tarih aralƒ±ƒüƒ± bu tedarik√ßilerin verilerini dƒ±≈ülƒ±yor olabilir.\n" \
              "2. Tedarik√ßi isimlerinde uyu≈ümazlƒ±k olabilir.\n\n" \
              "√á√∂z√ºm: Tarih aralƒ±ƒüƒ±nƒ± geni≈ületip tekrar 'ANALƒ∞Zƒ∞ BA≈ûLAT' diyerek deneyin."
        messagebox.showerror("E≈üle≈üme Hatasƒ±", msg)
        return
        
    candidates = merged.sort_values("Skor", ascending=False).head(5).copy()
    
    min_price = candidates[fiyat_col].min()
    candidates["PriceFactor"] = min_price / candidates[fiyat_col]
    
    candidates["Weight"] = candidates["Skor"] * candidates["PriceFactor"]
    
    total_weight = candidates["Weight"].sum()
    
    candidates["AllocatedQty"] = (candidates["Weight"] / total_weight * total_qty).astype(int)
    
    allocated_sum = candidates["AllocatedQty"].sum()
    diff = total_qty - allocated_sum
    if diff > 0:
        candidates.iloc[0, candidates.columns.get_loc("AllocatedQty")] += diff
        
    candidates["TotalCost"] = candidates["AllocatedQty"] * candidates[fiyat_col]
    
    for i in order_treeview.get_children(): order_treeview.delete(i)
    
    global current_allocation_data
    current_allocation_data = candidates
    
    allocation_summary_for_ai = []
    
    for index, row in candidates.iterrows():
        grade, _, _ = calculate_grade(row["Skor"])
        order_treeview.insert("", "end", values=(
            row[ted_col],
            f"{row['Skor']:.1f}",
            grade,
            f"{row[fiyat_col]:.2f}",
            f"{row['AllocatedQty']:,}",
            f"{row['TotalCost']:,.2f}"
        ))
        
        allocation_summary_for_ai.append({
            "Supplier": row[ted_col],
            "Score": f"{row['Skor']:.1f}",
            "Price": f"{row[fiyat_col]:.2f} TL",
            "Allocated": f"{row['AllocatedQty']} units",
            "Share": f"{(row['AllocatedQty']/total_qty)*100:.1f}%"
        })
        
    threading.Thread(target=lambda: generate_order_rationale_gemini(search_value, total_qty, allocation_summary_for_ai), daemon=True).start()

def generate_order_rationale_gemini(product, qty, allocation_data):
    if not GEMINI_API_KEY: return
    
    root.after(0, lambda: order_ai_text.configure(state="normal"))
    root.after(0, lambda: order_ai_text.delete("1.0", tk.END))
    root.after(0, lambda: order_ai_text.insert("1.0", "‚è≥ Yapay Zeka stratejik raporu hazƒ±rlƒ±yor...\n"))
    root.after(0, lambda: order_ai_text.configure(state="disabled"))
    
    prompt = f"""
    Sen kƒ±demli bir Tedarik Zinciri Y√∂neticisisin. CPO'ya sunulmak √ºzere bir sipari≈ü daƒüƒ±tƒ±m gerek√ßesi yaz.
    
    Durum:
    - √úr√ºn: {product}
    - Toplam Sipari≈ü: {qty} Adet
    
    Sistem tarafƒ±ndan yapƒ±lan daƒüƒ±tƒ±m (Algoritma: Skor ve Fiyat dengeli):
    {json.dumps(allocation_data, indent=2)}
    
    ƒ∞stenen √áƒ±ktƒ±:
    1. **Y√∂netici √ñzeti:** Neden bu daƒüƒ±tƒ±mƒ± yaptƒ±k? (Risk daƒüƒ±tƒ±mƒ±, maliyet avantajƒ± vs.)
    2. **Stratejik Analiz:** En b√ºy√ºk payƒ± alan tedarik√ßi neden se√ßildi?
    3. **Risk Notu:** Varsa dikkat edilmesi gereken bir nokta.
    
    L√ºtfen profesyonel, kurumsal ve ikna edici bir T√ºrk√ße kullan. Rapor kƒ±sa ve net olsun.
    """
    
    try:
        data = {"contents": [{"parts":[{"text": prompt}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=30)
        
        if response.status_code == 200:
            text = response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
            root.after(0, lambda: update_ai_text_widget(text))
        else:
            root.after(0, lambda: update_ai_text_widget(f"Hata: {response.status_code}"))
    except Exception as e:
        root.after(0, lambda: update_ai_text_widget(f"Baƒülantƒ± Hatasƒ±: {str(e)}"))

def update_ai_text_widget(text):
    order_ai_text.configure(state="normal")
    order_ai_text.delete("1.0", tk.END)
    order_ai_text.insert("1.0", text)
    order_ai_text.configure(state="disabled")

def generate_order_drafts():
    if 'current_allocation_data' not in globals() or current_allocation_data is None:
        messagebox.showwarning("Uyarƒ±", "L√ºtfen √∂nce hesaplama yapƒ±n.")
        return
        
    win = tk.Toplevel()
    win.title("Taslak Sipari≈ü Mailleri")
    win.geometry("600x500")
    
    txt = tk.Text(win, font=("Consolas", 10), padx=10, pady=10)
    txt.pack(fill="both", expand=True)
    
    # Arama tipine g√∂re doƒüru combobox'tan deƒüeri al
    search_type = siparis_search_type_var.get() if siparis_search_type_var else "code"
    if search_type == "code":
        product = siparis_stok_combobox.get()
    else:
        product = siparis_grup_combobox.get()
    
    full_text = ""
    for index, row in current_allocation_data.iterrows():
        mail_body = f"""
------------------------------------------------------------
Kƒ∞ME: {row[tedarikci_col_global]} Yetkilisi
KONU: Yeni Sipari≈ü Talebi - {product}

Sayƒ±n Yetkili,

DeFacto olarak {product} kodlu √ºr√ºn i√ßin tarafƒ±nƒ±za {row['AllocatedQty']:,} adet sipari≈ü ge√ßmek istiyoruz.
Birim Fiyat: {row[find_col_by_keywords(df_global, ['fiyat','price'])]:.2f} TL (Sistem Kaydƒ±)

L√ºtfen termin tarihini ve proforma faturayƒ± tarafƒ±mƒ±za iletiniz.

ƒ∞yi √ßalƒ±≈ümalar.
------------------------------------------------------------
"""
        full_text += mail_body
        
    txt.insert("1.0", full_text)

# ---------- THE NEGOTIATOR (YENƒ∞ MOD√úL) ----------
def init_negotiator_tab():
    """AI Destekli Pazarlƒ±k Robotu sekmesini olu≈üturur."""
    global negotiator_combobox, negotiator_text, tone_combobox # Global tanƒ±mlama

    for widget in frame_negotiator.winfo_children(): widget.destroy()

    # Ba≈ülƒ±k Alanƒ±
    header_frame = tk.Frame(frame_negotiator, bg="white", padx=20, pady=20)
    header_frame.pack(fill="x")
    
    tk.Label(header_frame, text="üí∞ AI Destekli Pazarlƒ±k Robotu (The Negotiator)", 
             font=("Segoe UI", 18, "bold"), fg="#2c3e50", bg="white").pack(anchor="w")
    tk.Label(header_frame, text="Tedarik√ßinin zayƒ±f ve g√º√ßl√º y√∂nlerini analiz edip, psikolojik ikna teknikleriyle profesyonel bir pazarlƒ±k maili yazar.", 
             font=("Segoe UI", 10), fg="gray", bg="white").pack(anchor="w")

    # Kontrol Paneli
    control_frame = tk.Frame(frame_negotiator, bg="#ecf0f1", padx=20, pady=20)
    control_frame.pack(fill="x", padx=20, pady=10)

    # Tedarik√ßi Se√ßimi
    tk.Label(control_frame, text="Tedarik√ßi Se√ß:", font=("Segoe UI", 11), bg="#ecf0f1").grid(row=0, column=0, padx=5, sticky="w")
    negotiator_combobox = ttk.Combobox(control_frame, state="readonly", width=30)
    negotiator_combobox.grid(row=0, column=1, padx=5)

    # Hedef ƒ∞ndirim Oranƒ±
    tk.Label(control_frame, text="Hedef ƒ∞ndirim (%):", font=("Segoe UI", 11), bg="#ecf0f1").grid(row=0, column=2, padx=5, sticky="w")
    discount_entry = ttk.Entry(control_frame, width=5)
    discount_entry.grid(row=0, column=3, padx=5)
    discount_entry.insert(0, "5")

    # Ton Se√ßimi (YENƒ∞)
    tk.Label(control_frame, text="√úslup:", font=("Segoe UI", 11), bg="#ecf0f1").grid(row=0, column=4, padx=5, sticky="w")
    tone_combobox = ttk.Combobox(control_frame, values=["N√∂tr (Profesyonel)", "Agresif (Sert)", "Olumlu (Yapƒ±cƒ±)"], state="readonly", width=15)
    tone_combobox.set("N√∂tr (Profesyonel)")
    tone_combobox.grid(row=0, column=5, padx=5)

    # Aksiyon Butonu
    action_btn = tk.Button(control_frame, text="‚ú® Analiz Et & Yaz", bg="#27ae60", fg="white", font=("Segoe UI", 10, "bold"),
                           padx=15, command=lambda: run_negotiator_ai(discount_entry.get(), tone_combobox.get()))
    action_btn.grid(row=0, column=6, padx=10)

    # Mail G√∂nder Butonu (YENƒ∞)
    send_btn = tk.Button(control_frame, text="üì§ Maili G√∂nder", bg="#2980b9", fg="white", font=("Segoe UI", 10, "bold"),
                         padx=15, command=send_negotiation_email_action)
    send_btn.grid(row=0, column=7, padx=10)

    # Sonu√ß Alanƒ±
    result_frame = tk.Frame(frame_negotiator, bg="white", bd=1, relief="solid")
    result_frame.pack(fill="both", expand=True, padx=20, pady=10)

    tk.Label(result_frame, text="ü§ñ AI Analizi ve Mail Taslaƒüƒ±", font=("Segoe UI", 12, "bold"), bg="white", fg="#2980b9").pack(pady=10)
    
    negotiator_text = tk.Text(result_frame, wrap="word", font=("Consolas", 11), bg="#fdfefe", padx=20, pady=20)
    negotiator_text.pack(fill="both", expand=True, padx=10, pady=(0, 10))
    
    negotiator_text.insert("1.0", "L√ºtfen bir tedarik√ßi ve √ºslup se√ßip 'Analiz Et & Yaz' butonuna basƒ±n.\n")

def run_negotiator_ai(target_discount, selected_tone):
    """Gemini ile pazarlƒ±k maili ve analizi olu≈üturur."""
    supplier_name = negotiator_combobox.get()
    
    if not supplier_name:
        messagebox.showwarning("Uyarƒ±", "L√ºtfen bir tedarik√ßi se√ßin.")
        return
        
    if sonuc_global is None:
        messagebox.showerror("Hata", "L√ºtfen √∂nce analiz yapƒ±n.")
        return

    # Verileri √áek
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    
    fiyat_col = find_col_by_keywords(sonuc_global, ['fiyat','price'])
    teslim_col = find_col_by_keywords(sonuc_global, ['teslim','delivery'])
    iade_col = find_col_by_keywords(sonuc_global, ['iade','return'])
    
    price_val = row[fiyat_col]
    delivery_val = row[teslim_col]
    return_val = row[iade_col]
    volume_val = row.get('ToplamTutar', 'Bilinmiyor')
    
    # Ton Ayarƒ±
    tone_instruction = "Profesyonel ve dengeli"
    if "Agresif" in selected_tone:
        tone_instruction = "Sert, talepkar ve tedarik√ßinin hatalarƒ±nƒ± (gecikme/iade) y√ºz√ºne vuran, kaybetme korkusu yaratan"
    elif "Olumlu" in selected_tone:
        tone_instruction = "Yapƒ±cƒ±, i≈übirlik√ßi, 'birlikte b√ºy√ºyelim' mesajƒ± veren ama yine de indirim isteyen"
    
    # Kullanƒ±cƒ±ya beklemesini s√∂yle
    negotiator_text.delete("1.0", tk.END)
    negotiator_text.insert("1.0", f"üß† {selected_tone} modunda analiz yapƒ±lƒ±yor ve mail taslaƒüƒ± hazƒ±rlanƒ±yor...\nL√ºtfen bekleyin...")
    
    # Thread i√ßinde √ßalƒ±≈ütƒ±r
    def _thread_task():
        prompt = f"""
        Sen 'The Negotiator' isimli yapay zeka destekli profesyonel bir satƒ±nalma robotusun.
        
        A≈üaƒüƒ±daki tedarik√ßi verilerini analiz et ve bir pazarlƒ±k maili olu≈ütur.
        
        Tedarik√ßi: {supplier_name}
        Veriler:
        - Teslimat Gecikmesi (Ortalama): {delivery_val:.1f} g√ºn
        - ƒ∞ade Miktarƒ± (Ortalama): {return_val:.1f} Adet
        - Bizim Alƒ±m Hacmimiz: {volume_val} TL
        - Hedeflenen ƒ∞ndirim: %{target_discount}
        - SE√áƒ∞LEN √úSLUP: {tone_instruction}
        
        G√ñREVƒ∞N:
        1. √ñnce durumu analiz eden kƒ±sa bir sistem mesajƒ± yaz.
        
        2. Ardƒ±ndan tedarik√ßiye g√∂nderilecek maili yaz.
        - Konu ba≈ülƒ±ƒüƒ± eklemeyi unutma.
        - Se√ßilen √ºsluba ({selected_tone}) tam olarak sadƒ±k kal.
        
        √áƒ±ktƒ± Formatƒ±:
        [Sƒ∞STEM ANALƒ∞Zƒ∞]
        ...analiz metni...
        
        [MAƒ∞L TASLAƒûI]
        Konu: ...
        Sayƒ±n Yetkili,
        ...i√ßerik...
        """
        
        try:
            data = {"contents": [{"parts":[{"text": prompt}]}]}
            response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=40)
            
            if response.status_code == 200:
                result = response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
                root.after(0, lambda: _update_negotiator_ui(result))
            else:
                root.after(0, lambda: _update_negotiator_ui(f"Hata: API Yanƒ±t vermedi ({response.status_code})"))
                
        except Exception as e:
            root.after(0, lambda: _update_negotiator_ui(f"Baƒülantƒ± Hatasƒ±: {str(e)}"))

    threading.Thread(target=_thread_task, daemon=True).start()

def _update_negotiator_ui(text):
    negotiator_text.delete("1.0", tk.END)
    
    # Renklendirme taglarƒ±
    negotiator_text.tag_configure("system", foreground="#e74c3c", font=("Segoe UI", 11, "bold")) # Kƒ±rmƒ±zƒ± Sistem Mesajƒ±
    negotiator_text.tag_configure("mail", foreground="#2c3e50", font=("Consolas", 11))
    
    if "[Sƒ∞STEM ANALƒ∞Zƒ∞]" in text:
        parts = text.split("[MAƒ∞L TASLAƒûI]")
        system_part = parts[0].replace("[Sƒ∞STEM ANALƒ∞Zƒ∞]", "").strip()
        mail_part = parts[1].strip() if len(parts) > 1 else ""
        
        negotiator_text.insert(tk.END, "üì¢ Sƒ∞STEM MESAJI:\n", "system")
        negotiator_text.insert(tk.END, system_part + "\n\n", "system")
        negotiator_text.insert(tk.END, "-"*50 + "\n", "mail")
        negotiator_text.insert(tk.END, mail_part, "mail")
    else:
        negotiator_text.insert(tk.END, text)

def send_negotiation_email_action():
    """Pazarlƒ±k mailini g√∂nderir."""
    supplier_name = negotiator_combobox.get()
    if not supplier_name: 
        messagebox.showwarning("Uyarƒ±", "Tedarik√ßi se√ßilmedi.")
        return
        
    if sonuc_global is None: return

    # Mail adresini bul
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    mail_col = find_col_by_keywords(sonuc_global, ["mail", "eposta", "e-posta", "email"])
    
    if not mail_col:
        messagebox.showerror("Hata", "Mail adresi s√ºtunu bulunamadƒ±.")
        return
        
    receiver_email = row[mail_col]
    if pd.isna(receiver_email) or str(receiver_email).strip() == "":
        messagebox.showerror("Hata", "Tedarik√ßinin mail adresi yok.")
        return

    # Metni al ve parse et
    full_text = negotiator_text.get("1.0", tk.END).strip()
    if not full_text: return

    if "[MAƒ∞L TASLAƒûI]" in full_text:
        # Sistem mesajƒ±nƒ± at, sadece maili al
        mail_content = full_text.split("[MAƒ∞L TASLAƒûI]")[1].strip()
        # √áizgiyi temizle
        if mail_content.startswith("-"):
             mail_content = mail_content.lstrip("-").strip()
    else:
        mail_content = full_text

    # Konuyu ayƒ±kla
    subject = "Pazarlƒ±k Hk." # Varsayƒ±lan
    body = mail_content
    
    lines = mail_content.split('\n')
    cleaned_lines = []
    subject_found = False
    
    for line in lines:
        if not subject_found and (line.lower().startswith("konu:") or line.lower().startswith("subject:")):
            subject = line.split(":", 1)[1].strip()
            subject_found = True
        else:
            cleaned_lines.append(line)
            
    body = "\n".join(cleaned_lines).strip()

    # G√∂nder
    confirm = messagebox.askyesno("Onay", f"≈ûu adrese mail g√∂nderilecek:\n{receiver_email}\n\nDevam edilsin mi?")
    if confirm:
        success, msg = send_email_with_attachments(str(receiver_email), subject, body, [])
        if success:
            messagebox.showinfo("Ba≈üarƒ±lƒ±", "Mail g√∂nderildi.")
        else:
            messagebox.showerror("Hata", f"G√∂nderilemedi: {msg}")

# ---------- EKSƒ∞K-FAZLA Y√úKLEMELER ANALƒ∞Zƒ∞ ----------
def init_eksik_fazla_tab():
    """Eksik-Fazla y√ºkleme analizi sekmesini ba≈ülatƒ±r"""
    global eksik_fazla_treeview, eksik_fazla_supplier_combo
    
    for widget in frame_eksik_fazla.winfo_children(): widget.destroy()
    
    # Ba≈ülƒ±k
    header_frame = tk.Frame(frame_eksik_fazla, bg="#2c3e50", padx=20, pady=15)
    header_frame.pack(fill="x")
    tk.Label(header_frame, text="üì¶ Eksik-Fazla Y√ºkleme Analizi", font=("Segoe UI", 16, "bold"), fg="white", bg="#2c3e50").pack(anchor="w")
    tk.Label(header_frame, text="Tedarik√ßilerin aylƒ±k y√ºkleme performansƒ±nƒ± takip edin", font=("Segoe UI", 10), fg="#ecf0f1", bg="#2c3e50").pack(anchor="w")
    
    # Filtre Paneli
    filter_frame = tk.LabelFrame(frame_eksik_fazla, text="Filtreler", font=("Segoe UI", 11, "bold"), padx=15, pady=10, bg="#ecf0f1")
    filter_frame.pack(fill="x", padx=20, pady=10)
    
    tk.Label(filter_frame, text="Tedarik√ßi Se√ß:", font=("Segoe UI", 10), bg="#ecf0f1").grid(row=0, column=0, padx=5, pady=5, sticky="w")
    eksik_fazla_supplier_combo = ttk.Combobox(filter_frame, state="readonly", width=35)
    eksik_fazla_supplier_combo.grid(row=0, column=1, padx=5, pady=5, sticky="w")
    
    # Analiz butonu
    analyze_btn = tk.Button(filter_frame, text="üîç Analizi G√∂ster", bg="#3498db", fg="white", font=("Segoe UI", 10, "bold"), 
                           padx=15, pady=5, command=lambda: show_eksik_fazla_analysis())
    analyze_btn.grid(row=0, column=2, padx=15, pady=5)
    
    # Export butonlarƒ±
    export_frame = tk.Frame(filter_frame, bg="#ecf0f1")
    export_frame.grid(row=0, column=3, padx=5, pady=5, sticky="e")
    tk.Button(export_frame, text="Excel", bg="#27ae60", fg="white", font=("Segoe UI", 8, "bold"), 
             command=lambda: export_eksik_fazla_data("xlsx")).pack(side="left", padx=2)
    tk.Button(export_frame, text="PDF", bg="#c0392b", fg="white", font=("Segoe UI", 8, "bold"),
             command=lambda: export_eksik_fazla_data("pdf")).pack(side="left", padx=2)
    
    # Sonu√ß Tablosu
    result_frame = tk.LabelFrame(frame_eksik_fazla, text="Aylƒ±k Y√ºkleme Detaylarƒ±", font=("Segoe UI", 11, "bold"), padx=10, pady=10)
    result_frame.pack(fill="both", expand=True, padx=20, pady=10)
    
    # Treeview
    columns = ("Ay", "Sipari≈ü Miktarƒ±", "Y√ºklenen Miktar", "Kalan Miktar", "Durum")
    eksik_fazla_treeview = ttk.Treeview(result_frame, columns=columns, show="headings", height=20)
    
    # Kolon ba≈ülƒ±klarƒ±
    eksik_fazla_treeview.heading("Ay", text="Ay")
    eksik_fazla_treeview.heading("Sipari≈ü Miktarƒ±", text="Sipari≈ü Miktarƒ±")
    eksik_fazla_treeview.heading("Y√ºklenen Miktar", text="Y√ºklenen Miktar")
    eksik_fazla_treeview.heading("Kalan Miktar", text="Kalan Miktar")
    eksik_fazla_treeview.heading("Durum", text="Durum")
    
    # Kolon geni≈ülikleri
    eksik_fazla_treeview.column("Ay", width=150, anchor="center")
    eksik_fazla_treeview.column("Sipari≈ü Miktarƒ±", width=150, anchor="center")
    eksik_fazla_treeview.column("Y√ºklenen Miktar", width=150, anchor="center")
    eksik_fazla_treeview.column("Kalan Miktar", width=150, anchor="center")
    eksik_fazla_treeview.column("Durum", width=200, anchor="center")
    
    # Scrollbar
    vsb = ttk.Scrollbar(result_frame, orient="vertical", command=eksik_fazla_treeview.yview)
    eksik_fazla_treeview.configure(yscrollcommand=vsb.set)
    
    eksik_fazla_treeview.pack(side="left", fill="both", expand=True)
    vsb.pack(side="right", fill="y")
    
    # Durum renklendirmesi i√ßin tag'ler
    eksik_fazla_treeview.tag_configure("tam", background="#d5f4e6", foreground="#27ae60")
    eksik_fazla_treeview.tag_configure("eksik", background="#fadbd8", foreground="#c0392b")
    eksik_fazla_treeview.tag_configure("fazla", background="#fcf3cf", foreground="#f39c12")
    
    # √ñzet bilgi kartƒ±
    summary_frame = tk.Frame(frame_eksik_fazla, bg="white", bd=2, relief="solid", padx=15, pady=10)
    summary_frame.pack(fill="x", padx=20, pady=(0, 10))
    
    global eksik_fazla_summary_label
    eksik_fazla_summary_label = tk.Label(summary_frame, text="Tedarik√ßi se√ßip analizi g√∂r√ºnt√ºleyin.", 
                                         font=("Segoe UI", 10), bg="white", fg="#7f8c8d", justify="left")
    eksik_fazla_summary_label.pack(anchor="w")
    
    # Tedarik√ßi listesini y√ºkle
    update_eksik_fazla_suppliers()

def update_eksik_fazla_suppliers():
    """Tedarik√ßi listesini g√ºnceller"""
    if df_global is not None and tedarikci_col_global is not None:
        suppliers = ["T√ºm√º"] + sorted(df_global[tedarikci_col_global].unique().astype(str).tolist())
        eksik_fazla_supplier_combo['values'] = suppliers
        if suppliers:
            eksik_fazla_supplier_combo.set(suppliers[0])

def show_eksik_fazla_analysis():
    """Se√ßili tedarik√ßi i√ßin eksik-fazla y√ºkleme analizini g√∂sterir"""
    if df_global is None:
        messagebox.showwarning("Uyarƒ±", "L√ºtfen √∂nce veri y√ºkleyin!")
        return
    
    selected_supplier = eksik_fazla_supplier_combo.get()
    if not selected_supplier:
        messagebox.showwarning("Uyarƒ±", "L√ºtfen bir tedarik√ßi se√ßin!")
        return
    
    # Treeview'i temizle
    for item in eksik_fazla_treeview.get_children():
        eksik_fazla_treeview.delete(item)
    
    # Veriyi hazƒ±rla
    df_analysis = df_global.copy()
    
    # Gerekli kolonlarƒ± bul
    date_col = find_col_by_keywords(df_analysis, ["tarih", "date"])
    siparis_no_col = find_col_by_keywords(df_analysis, ["sipari≈ü no", "siparis no", "order no", "order number", "sipari≈ü numarasƒ±"])
    siparis_miktar_col = find_col_by_keywords(df_analysis, ["sipari≈ü miktarƒ±", "siparis miktari", "order quantity"])
    kalan_col = find_col_by_keywords(df_analysis, ["kalan", "remaining", "kalan miktar"])
    
    if not date_col or not siparis_no_col:
        messagebox.showerror("Hata", "Tarih veya Sipari≈ü No kolonu bulunamadƒ±!")
        return
    
    # Tedarik√ßi filtresi
    if selected_supplier != "T√ºm√º":
        df_analysis = df_analysis[df_analysis[tedarikci_col_global] == selected_supplier]
    
    if df_analysis.empty:
        messagebox.showinfo("Bilgi", "Se√ßili tedarik√ßi i√ßin veri bulunamadƒ±.")
        return
    
    # Tarih d√∂n√º≈ü√ºm√º
    df_analysis[date_col] = pd.to_datetime(df_analysis[date_col], errors='coerce')
    df_analysis = df_analysis.dropna(subset=[date_col])
    
    # Sipari≈ü Miktarƒ± kolonu kontrol√º
    if siparis_miktar_col:
        df_analysis[siparis_miktar_col] = pd.to_numeric(df_analysis[siparis_miktar_col].astype(str).str.replace(',', '.'), errors='coerce')
    else:
        # Sipari≈ü Miktarƒ± yoksa, alternatif Miktar kolonunu ara
        miktar_col = find_col_by_keywords(df_analysis, ["miktar", "adet", "quantity", "qty"])
        if miktar_col:
            df_analysis[miktar_col] = pd.to_numeric(df_analysis[miktar_col].astype(str).str.replace(',', '.'), errors='coerce')
            siparis_miktar_col = miktar_col
        else:
            messagebox.showerror("Hata", "Sipari≈ü Miktarƒ± veya Miktar kolonu bulunamadƒ±!")
            return
    
    # Kalan Miktar d√∂n√º≈ü√ºm√º
    if kalan_col:
        df_analysis[kalan_col] = pd.to_numeric(df_analysis[kalan_col].astype(str).str.replace(',', '.'), errors='coerce')
    else:
        # Kalan miktar kolonu yoksa, sƒ±fƒ±r olarak varsay (tam y√ºkleme)
        df_analysis['_kalan_temp'] = 0
        kalan_col = '_kalan_temp'
    
    # Ay bilgisini ekle
    df_analysis['Ay'] = df_analysis[date_col].dt.to_period('M')
    
    # Benzersiz kombinasyon olu≈ütur: Sipari≈ü No + Sipari≈ü Miktarƒ±
    # Aynƒ± sipari≈ü no ancak farklƒ± miktarlar olabilir, bunlarƒ± ayrƒ± tutmalƒ±yƒ±z
    df_analysis['_unique_key'] = df_analysis[siparis_no_col].astype(str) + '_' + df_analysis[siparis_miktar_col].astype(str)
    
    # Her benzersiz kombinasyon i√ßin sadece Bƒ∞R KAYIT al (ilk kaydƒ± al)
    # Aynƒ± sipari≈ü no + sipari≈ü miktarƒ± birden fazla satƒ±rda olabilir, ama biz sadece birini alƒ±yoruz
    df_unique_orders = df_analysis.drop_duplicates(subset=['_unique_key'], keep='first')
    
    # Aylƒ±k gruplama - Her ay i√ßin sipari≈üleri grupla
    monthly_summary = df_unique_orders.groupby('Ay').agg({
        siparis_miktar_col: 'sum',  # Aylƒ±k toplam sipari≈ü miktarƒ±
        kalan_col: 'sum'  # Aylƒ±k toplam kalan miktar (her sipari≈ü i√ßin tek bir deƒüer)
    }).reset_index()
    
    # Y√ºklenen miktarƒ± hesapla (Sipari≈ü Miktarƒ± - Kalan Miktar = Y√ºklenen)
    monthly_summary['Y√ºklenen'] = monthly_summary[siparis_miktar_col] - monthly_summary[kalan_col]
    
    # √ñzet istatistikler
    total_months = len(monthly_summary)
    tam_yukleme = len(monthly_summary[monthly_summary[kalan_col] == 0])
    eksik_yukleme = len(monthly_summary[monthly_summary[kalan_col] > 0])
    fazla_yukleme = len(monthly_summary[monthly_summary[kalan_col] < 0])
    
    # Sonu√ßlarƒ± treeview'e ekle
    for idx, row in monthly_summary.iterrows():
        ay_str = str(row['Ay'])
        siparis = row[siparis_miktar_col]
        yuklenen = row['Y√ºklenen']
        kalan = row[kalan_col]
        
        # Durumu belirle
        if kalan == 0:
            durum = "‚úÖ Tam Y√ºkleme"
            tag = "tam"
        elif kalan > 0:
            durum = f"‚ö†Ô∏è Eksik Y√ºkleme ({kalan:.0f} eksik)"
            tag = "eksik"
        else:
            durum = f"üìà Fazla Y√ºkleme ({abs(kalan):.0f} fazla)"
            tag = "fazla"
        
        eksik_fazla_treeview.insert("", "end", values=(
            ay_str,
            f"{siparis:,.0f}",
            f"{yuklenen:,.0f}",
            f"{kalan:,.0f}",
            durum
        ), tags=(tag,))
    
    # √ñzet bilgiyi g√ºncelle
    total_siparis = monthly_summary[siparis_miktar_col].sum()
    total_yuklenen = monthly_summary['Y√ºklenen'].sum()
    basari_orani = (tam_yukleme / total_months * 100) if total_months > 0 else 0
    
    # Toplam sipari≈ü sayƒ±sƒ±nƒ± hesapla (benzersiz sipari≈ü no + miktar kombinasyonlarƒ±)
    total_orders = len(df_unique_orders)
    
    summary_text = f"""üìä √ñZET Bƒ∞LGƒ∞LER - {selected_supplier}

üìÖ Toplam Ay Sayƒ±sƒ±: {total_months}
üì¶ Benzersiz Sipari≈ü Kombinasyonu: {total_orders} adet (Sipari≈ü No + Miktar)
‚úÖ Tam Y√ºkleme: {tam_yukleme} ay ({(tam_yukleme/total_months*100 if total_months else 0):.1f}%)
‚ö†Ô∏è Eksik Y√ºkleme: {eksik_yukleme} ay
üìà Fazla Y√ºkleme: {fazla_yukleme} ay

üíº Toplam Sipari≈ü Miktarƒ±: {total_siparis:,.0f} adet
üì¶ Toplam Y√ºklenen: {total_yuklenen:,.0f} adet
üéØ Ba≈üarƒ± Oranƒ±: {basari_orani:.1f}%"""
    
    eksik_fazla_summary_label.configure(text=summary_text, fg="#2c3e50")
    
    # LOG
    if activity_logger:
        activity_logger.log_analysis("EKSIK_FAZLA_YUKLEME", f"Tedarik√ßi: {selected_supplier}, Ba≈üarƒ±: {basari_orani:.1f}%", "Eksik-Fazla Y√ºklemeler")

def export_eksik_fazla_data(format_type):
    """Eksik-fazla y√ºkleme verilerini export eder"""
    items = eksik_fazla_treeview.get_children()
    if not items:
        messagebox.showwarning("Uyarƒ±", "Export edilecek veri bulunamadƒ±!")
        return
    
    # Treeview verilerini DataFrame'e d√∂n√º≈üt√ºr
    data = []
    for item in items:
        values = eksik_fazla_treeview.item(item)['values']
        data.append(values)
    
    df_export = pd.DataFrame(data, columns=["Ay", "Sipari≈ü Miktarƒ±", "Y√ºklenen Miktar", "Kalan Miktar", "Durum"])
    
    if format_type == "xlsx":
        export_data(df_export, "xlsx", "Eksik_Fazla_Yuklemeler")
    elif format_type == "pdf":
        export_data(df_export, "pdf", "Eksik_Fazla_Yuklemeler")

# ---------- VERƒ∞LERƒ∞NLE KONU≈û (CHATBOT) ----------
def init_chat_tab():
    global chat_history_text
    for widget in frame_chat.winfo_children(): widget.destroy()
    
    tk.Label(frame_chat, text="ü§ñ Defacto √úretim Asistanƒ±", font=("Segoe UI", 16, "bold"), fg="#2c3e50").pack(pady=(15, 5))
    tk.Label(frame_chat, text="Merhaba! Ben Defacto √úretim, tekstil alanƒ±nda uzman yapay zeka asistanƒ±nƒ±zƒ±m. Verileriniz ve tekstil hakkƒ±nda her ≈üeyi sorabilirsiniz!", 
             font=("Segoe UI", 10), fg="gray").pack(pady=(0, 15))

    chat_frame = tk.Frame(frame_chat)
    chat_frame.pack(fill="both", expand=True, padx=20, pady=5)
    
    scrollbar = tk.Scrollbar(chat_frame)
    scrollbar.pack(side="right", fill="y")
    
    chat_history_text = tk.Text(chat_frame, wrap="word", font=("Segoe UI", 11), bg="white", bd=1, relief="solid",
                                state="disabled", yscrollcommand=scrollbar.set)
    chat_history_text.pack(side="left", fill="both", expand=True)
    scrollbar.configure(command=chat_history_text.yview)
    
    chat_history_text.tag_configure("user", foreground="#2980b9", font=("Segoe UI", 11, "bold"), justify="right")
    chat_history_text.tag_configure("ai", foreground="#2c3e50", font=("Segoe UI", 11), justify="left")
    chat_history_text.tag_configure("error", foreground="red", font=("Segoe UI", 11, "italic"))

    input_frame = tk.Frame(frame_chat, bg="#f0f0f0", height=50)
    input_frame.pack(fill="x", side="bottom", padx=20, pady=20)
    
    user_entry = ttk.Entry(input_frame, font=("Segoe UI", 11))
    user_entry.pack(side="left", fill="x", expand=True, padx=(0, 10), ipady=5)
    user_entry.bind("<Return>", lambda event: send_chat_message(user_entry))
    
    send_btn = ttk.Button(input_frame, text="G√∂nder ‚û§", command=lambda: send_chat_message(user_entry))
    send_btn.pack(side="right")

def send_chat_message(entry_widget):
    query = entry_widget.get().strip()
    if not query: return
    
    chat_history_text.configure(state="normal")
    chat_history_text.insert("end", f"\nSiz: {query}\n", "user")
    chat_history_text.configure(state="disabled")
    entry_widget.delete(0, 'end')
    
    threading.Thread(target=lambda: fetch_chat_response(query), daemon=True).start()

def fetch_chat_response(query):
    if not GEMINI_API_KEY:
        append_chat_response("Hata: API Anahtarƒ± eksik.", "error")
        return

    # Veri konteksti olu≈ütur
    context_data = ""
    has_data = False
    
    if sonuc_global is not None:
        has_data = True
        context_data = f"Veri √ñzeti (ƒ∞lk 50 Kayƒ±t):\n{sonuc_global.head(50).to_string()}\n"
        context_data += f"\nS√ºtunlar: {list(sonuc_global.columns)}\n"
    
    # Ham veri de varsa ekle
    if df_global is not None:
        has_data = True
        context_data += f"\n\nHam Veri √ñzeti (ƒ∞lk 30 Kayƒ±t):\n{df_global.head(30).to_string()}\n"
        context_data += f"\nToplam Kayƒ±t Sayƒ±sƒ±: {len(df_global)}\n"

    # Geli≈ütirilmi≈ü prompt - Defacto √úretim ki≈üiliƒüi ve tekstil uzmanlƒ±ƒüƒ±
    prompt = f"""
    Sen "Defacto √úretim" adƒ±nda, tekstil sekt√∂r√ºnde uzmanla≈ümƒ±≈ü yapay zeka asistanƒ±sƒ±n.
    
    Kƒ∞≈ûƒ∞Lƒ∞ƒûƒ∞N VE UZMANLIƒûIN:
    - ƒ∞smin: Defacto √úretim
    - Uzmanlƒ±k: Tekstil √ºretimi, kuma≈ü teknolojileri, tedarik zinciri y√∂netimi, kalite kontrol
    - Tekstil bilgin: Dokuma, √∂rme, boya, baskƒ±, aksesuar, konfeksiyon, hammadde (pamuk, polyester, elastan vb.)
    - Davranƒ±≈ü: Sƒ±cak, yardƒ±msever, profesyonel ve konu≈ükan
    - Her zaman samimi ve dost√ßa yanƒ±tlar verirsin
    
    G√ñREVIN:
    1. Kullanƒ±cƒ± selamla≈ütƒ±ƒüƒ±nda (merhaba, selam, hello vb.) kar≈üƒ±lƒ±k ver ve kendini tanƒ±t
    2. Sohbet etmeye hazƒ±r ol - sadece veri analizi deƒüil, tekstil hakkƒ±nda genel sorulara da cevap ver
    3. Y√ºklenen verilere %100 odaklan ve veriden i√ßg√∂r√ºler sun
    4. Veri yoksa bile tekstil sekt√∂r√º hakkƒ±nda bilgi ver ve yardƒ±mcƒ± ol
    
    {"VERƒ∞ MEVCUT - Analiz edebileceƒüin veriler:" if has_data else "VERƒ∞ YOK - Ancak tekstil ve tedarik zinciri hakkƒ±nda sorular sorabilir."}
    ---
    {context_data if has_data else "Hen√ºz veri y√ºklenmedi."}
    ---
    
    Kullanƒ±cƒ± Sorusu: {query}
    
    YANITLAMA KURALLARI:
    - Eƒüer kullanƒ±cƒ± selamla≈üƒ±yorsa (merhaba, selam, hello, hi vb.), sƒ±cak kar≈üƒ±la ve kendini tanƒ±t
    - Veri varsa, veriye dayalƒ± detaylƒ± analiz yap
    - Veri yoksa, tekstil sekt√∂r√º bilginle yardƒ±mcƒ± ol ve kullanƒ±cƒ±yƒ± y√∂nlendir
    - Her zaman T√ºrk√ße, samimi ve profesyonel yanƒ±t ver
    - Tekstil terimleri kullan ve uzmanlƒ±ƒüƒ±nƒ± g√∂ster
    """
    
    try:
        data = {"contents": [{"parts":[{"text": prompt}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=30)
        
        if response.status_code == 200:
            reply = response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
            append_chat_response(reply, "ai")
        else:
            append_chat_response(f"Hata: API yanƒ±t vermedi. Kod: {response.status_code}", "error")
            
    except Exception as e:
        append_chat_response(f"Bir hata olu≈ütu: {str(e)}", "error")

def append_chat_response(message, tag):
    def _update():
        chat_history_text.configure(state="normal")
        chat_history_text.insert("end", f"\nDefacto √úretim: {message}\n", tag)
        chat_history_text.insert("end", "-"*50 + "\n", "ai")
        chat_history_text.see("end")
        chat_history_text.configure(state="disabled")
    
    if chat_history_text:
        chat_history_text.after(0, _update)

# ---------- Diƒüer Fonksiyonlar ----------
def send_usage_log_email(islem_detayi):
    if not GMAIL_USER or not GMAIL_APP_PASSWORD: return
    try:
        msg = MIMEMultipart(); msg['From'] = GMAIL_USER; msg['To'] = GMAIL_RECEIVER_LOGS; msg['Subject'] = f"Kullanƒ±m - {getpass.getuser()}"
        msg.attach(MIMEText(f"ƒ∞≈ülem: {islem_detayi}\nZaman: {datetime.datetime.now()}", 'plain'))
        server = smtplib.SMTP('smtp.gmail.com', 587); server.starttls(); server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
        server.sendmail(GMAIL_USER, GMAIL_RECEIVER_LOGS, msg.as_string()); server.quit()
    except: pass

def save_settings():
    settings = {
        'price_weight': price_weight.get(),
        'delivery_weight': delivery_weight.get(),
        'return_weight': return_weight.get(),
        'exclude_outliers': exclude_outliers_var.get(),
        'monitoring_folder': monitoring_folder if monitoring_folder else None,
        'auto_analyze': True  # Otomatik analiz her zaman a√ßƒ±k
    }
    try:
        with open(SETTINGS_FILE, 'w') as f: 
            json.dump(settings, f, indent=2)
        print(f"Ayarlar kaydedildi: {settings}")
    except Exception as e:
        print(f"Ayar kaydetme hatasƒ±: {e}")

def load_settings():
    global monitoring_folder, current_theme
    try:
        with open(SETTINGS_FILE, 'r') as f:
            settings = json.load(f)
            price_weight.set(settings.get('price_weight', 0.4))
            delivery_weight.set(settings.get('delivery_weight', 0.3))
            return_weight.set(settings.get('return_weight', 0.3))
            exclude_outliers_var.set(settings.get('exclude_outliers', False))  # Varsayƒ±lan FALSE
            
            # Tema ayarƒ±nƒ± y√ºkle
            saved_theme = settings.get('theme', 'dark')
            current_theme = saved_theme
            ctk.set_appearance_mode(saved_theme)
            
            # Klas√∂r izleme ayarƒ±nƒ± y√ºkle
            saved_folder = settings.get('monitoring_folder')
            if saved_folder and os.path.exists(saved_folder):
                monitoring_folder = saved_folder
                # UI'da g√∂ster
                root.after(100, lambda: set_status(f"Kaydedilmi≈ü klas√∂r: {os.path.basename(monitoring_folder)}"))
                # Otomatik ba≈ülat
                root.after(200, auto_start_monitoring)
            
            update_weights()
            print(f"Ayarlar y√ºklendi: {settings}")
    except FileNotFoundError:
        print("Ayar dosyasƒ± bulunamadƒ±, varsayƒ±lanlar kullanƒ±lƒ±yor")
    except Exception as e:
        print(f"Ayar y√ºkleme hatasƒ±: {e}")

def export_data(data, format_type, sheet_name=None, filename=None):
    if data is None or data.empty: messagebox.showerror("Hata", "Veri yok."); return
    if not filename: filename = filedialog.asksaveasfilename(defaultextension=f".{format_type}", filetypes=[(f"{format_type.upper()}", f"*.{format_type}")])
    if not filename: return
    try:
        if format_type == "xlsx":
            with pd.ExcelWriter(filename, engine='openpyxl') as writer: data.to_excel(writer, sheet_name=sheet_name or "Veri", index=False)
        elif format_type == "pdf": export_df_to_pdf(data, filename)
        elif format_type == "docx": export_df_to_docx(data, filename)
        
        # LOG: Export ba≈üarƒ±lƒ±
        if activity_logger:
            activity_logger.log_export(format_type.upper(), os.path.basename(filename))
        
        messagebox.showinfo("Ba≈üarƒ±lƒ±", "Kaydedildi.")
    except Exception as e: 
        # LOG: Export hatasƒ±
        if activity_logger:
            activity_logger.log_error(f"Export hatasƒ± ({format_type}): {str(e)}")
        messagebox.showerror("Hata", str(e))

def export_df_to_pdf(df, filename):
    pdf = FPDF(); pdf.add_font('DejaVuSans', '', 'DejaVuSans.ttf', uni=True) if os.path.exists('DejaVuSans.ttf') else pdf.set_font("Arial", size=10)
    pdf.add_page(); pdf.cell(200, 10, txt="Rapor", ln=True, align='C'); pdf.ln(5)
    for i, col in enumerate(df.columns[:10]): pdf.cell(20, 8, str(col)[:10], 1)
    pdf.ln()
    for index, row in df.iterrows():
        for i, item in enumerate(row[:10]): pdf.cell(20, 8, str(item)[:10], 1)
        pdf.ln()
    pdf.output(filename)

def export_df_to_docx(df, filename):
    doc = Document(); doc.add_heading("Rapor", level=1); table = doc.add_table(df.shape[0]+1, df.shape[1]); table.style='Table Grid'
    for j, col in enumerate(df.columns): table.cell(0, j).text = str(col)
    for i in range(df.shape[0]):
        for j in range(df.shape[1]): table.cell(i+1, j).text = str(df.iloc[i, j])
    doc.save(filename)

def export_charts(format_type, filename=None):
    if fig_global is None: messagebox.showerror("Hata", "Grafik yok."); return
    if not filename: filename = filedialog.asksaveasfilename(defaultextension=f".{format_type}")
    if not filename: return
    try: fig_global.savefig(filename, dpi=300); messagebox.showinfo("Ba≈üarƒ±lƒ±", "Kaydedildi.")
    except Exception as e: messagebox.showerror("Hata", str(e))

def export_ai_comment(format_type, filename=None):
    if message_global is None: messagebox.showerror("Hata", "Yorum yok."); return
    if not filename: filename = filedialog.asksaveasfilename(defaultextension=f".{format_type}")
    if not filename: return
    try:
        with open(filename, 'w', encoding='utf-8') as f: f.write(message_global)
        messagebox.showinfo("Ba≈üarƒ±lƒ±", "Kaydedildi.")
    except Exception as e: messagebox.showerror("Hata", str(e))

def send_email_with_attachments(to_email, subject, body, attachment_paths):
    if not GMAIL_USER or not GMAIL_APP_PASSWORD: return False, "Ayarlar eksik."
    
    # LOG: Email g√∂nderimi ba≈üladƒ±
    if activity_logger:
        activity_logger.log_email_sent(to_email, subject)
    
    msg = MIMEMultipart(); msg['From'] = GMAIL_USER; msg['To'] = to_email; msg['Subject'] = subject; msg.attach(MIMEText(body, 'plain'))
    for path in attachment_paths:
        try:
            with open(path, "rb") as f:
                part = MIMEBase('application', 'octet-stream'); part.set_payload(f.read()); encoders.encode_base64(part)
                part.add_header('Content-Disposition', f"attachment; filename= {os.path.basename(path)}"); msg.attach(part)
        except: pass
    try:
        server = smtplib.SMTP('smtp.gmail.com', 587); server.starttls(); server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
        server.sendmail(GMAIL_USER, to_email.split(','), msg.as_string()); server.quit(); 
        
        # LOG: Email ba≈üarƒ±yla g√∂nderildi
        if activity_logger:
            activity_logger.log_event("EMAIL_SUCCESS", f"Mail ba≈üarƒ±yla g√∂nderildi: {to_email}")
        
        return True, "G√∂nderildi."
    except Exception as e: 
        # LOG: Email hatasƒ±
        if activity_logger:
            activity_logger.log_error(f"Email hatasƒ±: {str(e)}")
        return False, str(e)

def send_report_email():
    if sonuc_global is None: messagebox.showerror("Hata", "Analiz yok."); return
    excel_path = "rapor.xlsx"; pdf_path = "yorum.pdf"
    with pd.ExcelWriter(excel_path) as w: sonuc_global.to_excel(w, index=False)
    export_ai_comment("pdf", pdf_path)
    
    attachments = [excel_path, pdf_path]
    success, msg = send_email_with_attachments(REPORT_RECEIVERS, "Tedarik√ßi Raporu", "Ektedir.", attachments)
    messagebox.showinfo("Durum", msg)
    for p in attachments: 
        if os.path.exists(p): os.remove(p)

def set_status(message):
    if status_label: root.after(0, lambda: status_label.configure(text=message))

def normalize_series(s): return s.astype(str).fillna("").str.strip().str.lower()

def find_stok_kodu_column(df):
    keys = ["stok kodu", "stok_kodu", "stokkod", "stok kod", "stok", "sku", "kod", "item code", "item_code", "stock code", "barcode"]
    cols = list(df.columns)
    for col in cols:
        if any(k in str(col).lower() for k in keys): return col
    return ask_user_to_pick_column(cols)

def find_stok_grubu_column(df):
    """Find stock group column in the dataframe - prioritizes 'Stok Grubu' over generic terms"""
    # First check for exact or close matches to "Stok Grubu"
    priority_keys = ["stok grubu", "stok_grubu", "stokgrubu"]
    cols = list(df.columns)
    for col in cols:
        col_lower = str(col).lower()
        if any(k in col_lower for k in priority_keys):
            return col
    
    # If not found, check for generic group terms
    fallback_keys = ["grup", "group", "item group", "product group"]
    for col in cols:
        col_lower = str(col).lower()
        if any(k in col_lower for k in fallback_keys):
            return col
    
    return None  # Return None if not found, don't ask user

def find_col_by_keywords(df, keywords):
    for col in df.columns:
        if any(k in str(col).lower() for k in keywords): return col
    return None

def ask_user_to_pick_column(cols):
    win = tk.Toplevel(); win.title("Kolon Se√ß"); tk.Label(win, text="Se√ßim yapƒ±n:").pack()
    combo = ttk.Combobox(win, values=cols, state="readonly"); combo.pack()
    sel = [None]
    def on_ok(): sel[0] = combo.get(); win.destroy()
    ttk.Button(win, text="Tamam", command=on_ok).pack(); win.wait_window()
    return sel[0]

def show_best_supplier(en_iyi_df):
    if en_iyi_df.empty: return
    bs = en_iyi_df.iloc[0]
    # D√úZELTME: S√ºtun ismine g√∂re eri≈üim (√∂nceden indexe g√∂reydi ve kayma oluyordu)
    sup_name = bs[tedarikci_col_global]
    score = bs['Skor'] 
    messagebox.showinfo("En ƒ∞yi", f"Tedarik√ßi: {sup_name}\nSkor: {score:.2f}")

def update_ai_comment_tab(message, en_iyi_df):
    root.after(0, lambda: _update_ai_comment_tab(message, en_iyi_df))

def _update_ai_comment_tab(message, en_iyi_df):
    global sonuc_global 
    for w in frame_ai.winfo_children(): w.destroy()
    
    text_frame = tk.Frame(frame_ai, bg="#f4f6f9")
    text_frame.pack(fill="both", expand=True, padx=10, pady=10)
    
    scrollbar = tk.Scrollbar(text_frame)
    scrollbar.pack(side="right", fill="y")
    
    txt = tk.Text(text_frame, wrap="word", font=("Segoe UI", 11), bg="white", fg="#333333",
                  bd=0, padx=20, pady=20, yscrollcommand=scrollbar.set)
    txt.pack(side="left", fill="both", expand=True)
    scrollbar.configure(command=txt.yview)
    
    txt.tag_configure("header", font=("Segoe UI", 12, "bold"), foreground="#2980b9", spacing3=10, spacing1=5)
    txt.tag_configure("risk", font=("Segoe UI", 11, "bold"), foreground="#e74c3c") 
    txt.tag_configure("action", font=("Segoe UI", 11, "bold"), foreground="#27ae60") 
    txt.tag_configure("normal", font=("Segoe UI", 11), foreground="#2c3e50", spacing1=2)
    txt.tag_configure("bullet", font=("Segoe UI", 11, "bold"), foreground="#f39c12") 
    txt.tag_configure("supplier_red", font=("Segoe UI", 11, "bold"), foreground="#c0392b") 

    known_suppliers = []
    if sonuc_global is not None and tedarikci_col_global is not None:
        known_suppliers = sonuc_global[tedarikci_col_global].unique().tolist()
    
    lines = message.split('\n')
    for line in lines:
        line = line.strip()
        if not line: continue
        
        current_tags = "normal"
        if "Genel Yorum:" in line or line.endswith(":"): current_tags = "header"
        elif "Risk Analizi:" in line: current_tags = "risk"
        elif "Aksiyon Planƒ±:" in line: current_tags = "action"
        
        if line.startswith("-") or line.startswith("*") or line.startswith("‚Ä¢"):
             txt.insert(tk.END, " ‚Ä¢ ", "bullet")
             content = line.lstrip("-*‚Ä¢ ")
             
             found_supplier = False
             for sup in known_suppliers:
                 if str(sup).lower() in content.lower():
                     start_idx = content.lower().find(str(sup).lower())
                     end_idx = start_idx + len(str(sup))
                     
                     txt.insert(tk.END, content[:start_idx], current_tags)
                     txt.insert(tk.END, content[start_idx:end_idx], "supplier_red")
                     txt.insert(tk.END, content[end_idx:] + "\n", current_tags)
                     found_supplier = True
                     break
             if not found_supplier:
                 txt.insert(tk.END, content + "\n", current_tags)
                 
        else:
             found_supplier = False
             for sup in known_suppliers:
                 if str(sup).lower() in line.lower():
                     start_idx = line.lower().find(str(sup).lower())
                     end_idx = start_idx + len(str(sup))
                     
                     txt.insert(tk.END, line[:start_idx], current_tags)
                     txt.insert(tk.END, line[start_idx:end_idx], "supplier_red")
                     txt.insert(tk.END, line[end_idx:] + "\n", current_tags)
                     found_supplier = True
                     break
             if not found_supplier:
                txt.insert(tk.END, line + "\n", current_tags)
        
    txt.configure(state="disabled")

    bf = tk.Frame(frame_ai, bg="#f4f6f9")
    bf.pack(fill="x", pady=10, padx=10)
    
    style = ttk.Style()
    style.configure("Accent.TButton", font=("Segoe UI", 9, "bold"))
    
    ttk.Button(bf, text="üèÜ En ƒ∞yi Tedarik√ßiyi G√∂ster", style="Accent.TButton", command=lambda: show_best_supplier(en_iyi_df)).pack(side="left", padx=5)
    ttk.Button(bf, text="üíæ Yorumu Kaydet (TXT)", command=lambda: export_ai_comment("txt")).pack(side="left", padx=5)
    ttk.Button(bf, text="üìÑ Yorumu Kaydet (PDF)", command=lambda: export_ai_comment("pdf")).pack(side="left", padx=5)

def yapay_zeka_analizi_gemini(sonuc_df, ham_df, tedarikci_col, fiyat_col, teslim_col, iade_col):
    if not GEMINI_API_KEY: return "API yok."
    root.after(0, lambda: ai_status_label.configure(text="AI Analizi..."))
    prompt = f"Tedarik√ßi verileri:\n{sonuc_df.head(20).to_dict(orient='records')}\nL√ºtfen en iyi/k√∂t√º tedarik√ßileri, riskleri ve aksiyonlarƒ± yorumla."
    try:
        resp = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json={"contents": [{"parts":[{"text": prompt}]}]}, timeout=120)
        return resp.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
    except: return "Yorum alƒ±namadƒ±."

def update_summary_tab(num, price, deliv, ret, score, pareto_a, df=None):
    root.after(0, lambda: _update_summary_tab(num, price, deliv, ret, score, pareto_a, df))

def _update_summary_tab(num, price, deliv, ret, score, pareto_a, df=None):
    draw_dashboard(frame_ozet, {"count": num, "price": f"{price:.2f}", "delivery": f"{deliv:.2f}", "return": f"{ret:.2f}", "score": f"{score:.2f}", "pareto_a": pareto_a}, df)

def show_comparison_chart():
    if df_global is None: return
    sel = [supplier_listbox.get(i) for i in supplier_listbox.curselection()]
    if not sel: return
    sub = df_global[df_global[tedarikci_col_global].isin(sel)].copy()
    
    f = find_col_by_keywords(df_global, ["fiyat", "price"])
    t = find_col_by_keywords(df_global, ["teslim", "delivery"])
    i = find_col_by_keywords(df_global, ["iade", "return"])
    
    if not (f and t and i): return
    for c in [f, t, i]: sub[c] = pd.to_numeric(sub[c].astype(str).str.replace(',', '.'), errors='coerce')
    
    metrics = sub.groupby(tedarikci_col_global)[[f, t, i]].mean().fillna(0).T
    for w in comparison_frame.winfo_children(): w.destroy()
    fig, ax = plt.subplots(figsize=(10, 6)); metrics.plot(kind='bar', ax=ax)
    canvas = FigureCanvasTkAgg(fig, master=comparison_frame); canvas.draw(); canvas.get_tk_widget().pack(fill='both', expand=True)

def find_outliers(df, col):
    Q1 = df[col].quantile(0.25); Q3 = df[col].quantile(0.75); IQR = Q3 - Q1
    return df[(df[col] < Q1 - 1.5 * IQR) | (df[col] > Q3 + 1.5 * IQR)].copy(), Q1 - 1.5 * IQR, Q3 + 1.5 * IQR

def play_loading_gif(): ai_progress_bar.pack(pady=10, fill="x"); ai_progress_bar.start()
def stop_loading_gif(): ai_progress_bar.stop(); ai_progress_bar.pack_forget()

def analiz_et_with_options(dosyalar, filter_type, filter_value):
    """Geli≈ütirilmi≈ü analiz motoru: Hibrit skorlama + stok grubu bazlƒ± detaylƒ± analiz + √ßoklu filtreleme"""
    global df_global, tedarikci_col_global, phone_col_global, sonuc_global, message_global, grafik_ozet_global, outliers_global
    global stok_grup_col_global, detay_sonuc_global, market_averages_global
    try:
        # LOG: Analiz ba≈ülatƒ±ldƒ±
        if activity_logger:
            file_names = ", ".join([os.path.basename(f) for f in dosyalar])
            filter_desc = f"{filter_type}: {filter_value}" if filter_value else "T√ºm√º"
            activity_logger.log_analysis("TEDARIKCI_ANALIZ", f"Dosyalar: {file_names}, Filtre: {filter_desc}", "Analiz")
        
        threading.Thread(target=lambda: send_usage_log_email(f"Analiz: {len(dosyalar)} dosya")).start()
        root.after(0, lambda: ai_status_label.configure(text="Okunuyor..."))
        
        df_list = [pd.read_csv(f, dtype=str) if f.endswith('.csv') else pd.read_excel(f, dtype=str) for f in dosyalar]
        df = pd.concat(df_list, ignore_index=True)
        df_global = df.copy()
        
        # LOG: Veri y√ºklendi
        if activity_logger:
            activity_logger.log_data_load(file_names, len(df), "Analiz")
        
        stok_col = find_stok_kodu_column(df) or df.columns[0]
        ted_col = find_col_by_keywords(df, ["tedarik", "supplier"])
        fiyat_col = find_col_by_keywords(df, ["fiyat", "price"])
        teslim_col = find_col_by_keywords(df, ["teslim", "delivery"])
        iade_col = find_col_by_keywords(df, ["iade", "return"])
        miktar_col = find_col_by_keywords(df, ["miktar", "adet", "quantity", "qty"])
        date_col = find_col_by_keywords(df, ["tarih", "date"])
        city_col = find_col_by_keywords(df, ["≈üehir", "sehir", "city", "il"]) 
        mail_col = find_col_by_keywords(df, ["mail", "eposta", "e-posta", "email"]) 
        phone_col = find_col_by_keywords(df, ["telefon", "tel", "phone", "mobil", "mobile", "gsm"]) # Telefon Kolonu (YENƒ∞)
        stok_grup_col = find_col_by_keywords(df, ["stok grubu", "stock group", "grup", "family", "product group", "malzeme grubu"])
        
        tedarikci_col_global = ted_col
        phone_col_global = phone_col
        stok_grup_col_global = stok_grup_col
        
        # Stok gruplarƒ±nƒ± √ßƒ±kar ve global deƒüi≈ükene ata
        global all_stock_groups
        if stok_grup_col:
            try:
                unique_gruplar = sorted(df[stok_grup_col].dropna().unique())
                all_stock_groups = ["T√ºm Veri"] + list(unique_gruplar)
            except:
                all_stock_groups = []
        else:
            all_stock_groups = []

        # Zorunlu kolonlarƒ± kontrol et (iade_col opsiyonel)
        if not all([ted_col, fiyat_col, teslim_col]):
            # Hangi kolonlarƒ±n eksik olduƒüunu belirle
            eksik_kolonlar = []
            if not ted_col: eksik_kolonlar.append("Tedarik√ßi (tedarik/supplier)")
            if not fiyat_col: eksik_kolonlar.append("Fiyat (fiyat/price)")
            if not teslim_col: eksik_kolonlar.append("Teslim S√ºresi (teslim/delivery)")
            
            hata_mesaji = "‚ùå Gerekli kolonlar eksik!\n\n"
            hata_mesaji += "Eksik kolonlar:\n"
            for kolon in eksik_kolonlar:
                hata_mesaji += f"  ‚Ä¢ {kolon}\n"
            hata_mesaji += f"\nüìã Mevcut kolonlar:\n{', '.join(df.columns[:10])}"
            if len(df.columns) > 10:
                hata_mesaji += f"... (toplam {len(df.columns)} kolon)"
            hata_mesaji += "\n\nüí° √á√∂z√ºm: MYSQL_COLUMN_MAPPINGS yapƒ±landƒ±rmasƒ±nda\nSQL kolon isimlerinizi e≈üle≈ütirin."
            
            messagebox.showerror("Kolonlar Eksik", hata_mesaji)
            return
        
        # ƒ∞ade kolonu yoksa varsayƒ±lan deƒüerle olu≈ütur
        if not iade_col:
            df["ƒ∞ade Oranƒ±"] = 0.0
            iade_col = "ƒ∞ade Oranƒ±"
            root.after(0, lambda: messagebox.showinfo("Bilgi", 
                "‚ö†Ô∏è ƒ∞ade Oranƒ± kolonu bulunamadƒ±.\n\n"
                "Analiz devam ediyor ancak t√ºm iade deƒüerleri 0 olarak kabul edilecek.\n\n"
                "üí° Daha doƒüru sonu√ßlar i√ßin ƒ∞ade Oranƒ± kolonunu ekleyin veya e≈üle≈ütirin."))

        df[stok_col] = normalize_series(df[stok_col])
        df_analiz = df.copy()
        
        if date_col and date_col in df_analiz.columns:
            df_analiz[date_col] = pd.to_datetime(df_analiz[date_col], errors='coerce')
            df_analiz.dropna(subset=[date_col], inplace=True)
            s_d = pd.to_datetime(start_date_entry.get(), format="%d-%m-%Y", errors='coerce')
            e_d = pd.to_datetime(end_date_entry.get(), format="%d-%m-%Y", errors='coerce')
            if pd.notna(s_d): df_analiz = df_analiz[df_analiz[date_col] >= s_d]
            if pd.notna(e_d): df_analiz = df_analiz[df_analiz[date_col] <= e_d]

        # √áOK Tƒ∞PLƒ∞ Fƒ∞LTRELEME - Stok Kodu veya Stok Grubu
        if filter_value and filter_type != "none":
            if filter_type == "stock_code":
                # Stok koduna g√∂re filtrele
                norm_filter = str(filter_value).strip().lower()
                norm_stock_series = normalize_series(df_analiz[stok_col])
                df_analiz = df_analiz[norm_stock_series == norm_filter]
            elif filter_type == "stock_group":
                # Stok grubuna g√∂re filtrele
                if stok_grup_col:
                    norm_filter = str(filter_value).strip().lower()
                    norm_group_series = normalize_series(df_analiz[stok_grup_col])
                    df_analiz = df_analiz[norm_group_series == norm_filter]
                else:
                    root.after(0, lambda: messagebox.showwarning("Uyarƒ±", "Veri setinde 'Stok Grubu' kolonu bulunamadƒ±."))

        if df_analiz.empty:
            root.after(0, lambda: messagebox.showwarning("Uyarƒ±", "Filtreleme sonucu veri bulunamadƒ±.")); return

        for c in [fiyat_col, teslim_col, iade_col]:
            df_analiz[c] = pd.to_numeric(df_analiz[c].astype(str).str.replace(',', '.'), errors='coerce')
        
        # AYKIRI DEƒûER Y√ñNETƒ∞Mƒ∞
        outliers, lb, ub = find_outliers(df_analiz, fiyat_col)
        outliers_global = outliers
        if exclude_outliers_var.get(): 
            df_analiz = df_analiz[~df_analiz.index.isin(outliers.index)]
        
        root.after(0, lambda: ai_status_label.configure(text="Hesaplanƒ±yor..."))
        
        agg_dict = {fiyat_col: "mean", teslim_col: "mean", iade_col: "mean"}
        if miktar_col: 
            df_analiz[miktar_col] = pd.to_numeric(df_analiz[miktar_col].astype(str).str.replace(',', '.'), errors='coerce')
            agg_dict[miktar_col] = "sum"
            df_analiz["_SatirTutar"] = df_analiz[fiyat_col] * df_analiz[miktar_col]
        else:
            df_analiz["_SatirTutar"] = df_analiz[fiyat_col]
        agg_dict["_SatirTutar"] = "sum"
        if mail_col:
            agg_dict[mail_col] = "first"
        if phone_col:
            agg_dict[phone_col] = "first"
        
        # Stok Grubu bazlƒ± gruplama (varsa)
        group_cols = [ted_col]
        if stok_grup_col: 
            group_cols.append(stok_grup_col)
            
        sonuc_grouped = df_analiz.groupby(group_cols).agg(agg_dict).reset_index().fillna(0)
        sonuc_grouped.rename(columns={"_SatirTutar": "ToplamTutar"}, inplace=True)

        # Hƒ∞BRƒ∞T SKORLAMA FONKSƒ∞YONU (%50 Min-Max + %50 Ranking)
        def apply_scoring(sub_df):
            # 1. Min-Max Normalizasyon (0-100)
            min_p, max_p = sub_df[fiyat_col].min(), sub_df[fiyat_col].max()
            sub_df["Min_Price"] = min_p
            sub_df["Max_Price"] = max_p
            sub_df["Raw_Price"] = 100 if max_p == min_p else ((max_p - sub_df[fiyat_col]) / (max_p - min_p)) * 100
            
            min_d, max_d = sub_df[teslim_col].min(), sub_df[teslim_col].max()
            sub_df["Min_Deliv"] = min_d
            sub_df["Max_Deliv"] = max_d
            sub_df["Raw_Deliv"] = 100 if max_d == min_d else ((max_d - sub_df[teslim_col]) / (max_d - min_d)) * 100
            
            min_r, max_r = sub_df[iade_col].min(), sub_df[iade_col].max()
            sub_df["Min_Return"] = min_r
            sub_df["Max_Return"] = max_r
            sub_df["Raw_Return"] = 100 if max_r == min_r else ((max_r - sub_df[iade_col]) / (max_r - min_r)) * 100
            
            # 2. Sƒ±ralama Bazlƒ± Skorlama (0-100)
            n = len(sub_df)
            if n > 1:
                sub_df["Rank_Price"] = (n - sub_df[fiyat_col].rank(method='min')) / (n - 1) * 100
                sub_df["Rank_Deliv"] = (n - sub_df[teslim_col].rank(method='min')) / (n - 1) * 100
                sub_df["Rank_Return"] = (n - sub_df[iade_col].rank(method='min')) / (n - 1) * 100
            else:
                sub_df["Rank_Price"] = 100
                sub_df["Rank_Deliv"] = 100
                sub_df["Rank_Return"] = 100

            # 3. Hibrit Skor (%50 + %50)
            sub_df["Score_Price"] = 0.5 * sub_df["Raw_Price"] + 0.5 * sub_df["Rank_Price"]
            sub_df["Score_Deliv"] = 0.5 * sub_df["Raw_Deliv"] + 0.5 * sub_df["Rank_Deliv"]
            sub_df["Score_Return"] = 0.5 * sub_df["Raw_Return"] + 0.5 * sub_df["Rank_Return"]
            
            # 4. Aƒüƒ±rlƒ±klƒ± Toplam Skor
            total_w = price_weight.get() + delivery_weight.get() + return_weight.get()
            if total_w == 0: total_w = 1
            sub_df["Skor"] = (sub_df["Score_Price"] * price_weight.get() + 
                             sub_df["Score_Deliv"] * delivery_weight.get() + 
                             sub_df["Score_Return"] * return_weight.get()) / total_w
            return sub_df

        # Skorlama: Stok grubu varsa grup i√ßinde, yoksa global
        if stok_grup_col:
            # Pazar ortalamalarƒ± (kƒ±yaslama i√ßin)
            market_averages_global = df_analiz.groupby(stok_grup_col)[[fiyat_col, teslim_col, iade_col]].mean()
            sonuc_grouped = sonuc_grouped.groupby(stok_grup_col, group_keys=False).apply(apply_scoring)
        else:
            sonuc_grouped = apply_scoring(sonuc_grouped)

        # Detaylƒ± sonu√ßlarƒ± sakla (karne i√ßin)
        detay_sonuc_global = sonuc_grouped.copy()

        # Ana liste i√ßin tedarik√ßi bazƒ±nda topla (aƒüƒ±rlƒ±klƒ± ortalama)
        def weighted_avg(x, df, w_col):
            try:
                return np.average(x, weights=df.loc[x.index, w_col])
            except:
                return x.mean()

        if stok_grup_col:
            sonuc_main = sonuc_grouped.groupby(ted_col).agg({
                fiyat_col: lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                teslim_col: lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                iade_col: lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                "Skor": lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                "Score_Price": lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                "Score_Deliv": lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                "Score_Return": lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                "ToplamTutar": "sum"
            }).reset_index()
            if mail_col:
                mail_map = df_analiz.groupby(ted_col)[mail_col].first()
                sonuc_main[mail_col] = sonuc_main[ted_col].map(mail_map)
            if phone_col:
                phone_map = df_analiz.groupby(ted_col)[phone_col].first()
                sonuc_main[phone_col] = sonuc_main[ted_col].map(phone_map)
        else:
            sonuc_main = sonuc_grouped.copy()

        # Pareto sƒ±nƒ±flandƒ±rmasƒ± (ciroya g√∂re)
        sonuc_main = sonuc_main.sort_values("ToplamTutar", ascending=False)
        sonuc_main["KumulatifYuzde"] = 100 * sonuc_main["ToplamTutar"].cumsum() / sonuc_main["ToplamTutar"].sum()
        
        def pareto_sinif(yuzde):
            return "A" if yuzde <= 80 else "B" if yuzde <= 95 else "C"
        sonuc_main["Pareto_Sinifi"] = sonuc_main["KumulatifYuzde"].apply(pareto_sinif)
        
        sonuc_global = sonuc_main.copy()
        
        update_summary_tab(len(sonuc_main), sonuc_main[fiyat_col].mean(), sonuc_main[teslim_col].mean(), 
                          sonuc_main[iade_col].mean(), sonuc_main["Skor"].mean(), 
                          len(sonuc_main[sonuc_main["Pareto_Sinifi"] == "A"]), sonuc_main)
        
        mesaj = yapay_zeka_analizi_gemini(sonuc_main, df_analiz, ted_col, fiyat_col, teslim_col, iade_col)
        message_global = mesaj
        
        update_supplier_details_tab(df_global, tedarikci_col_global)
        
        if date_col: 
            root.after(0, lambda: update_trend_tab(df_analiz, date_col, fiyat_col, miktar_col))
            root.after(0, lambda: update_forecast_tab(df_analiz, date_col, fiyat_col))
        else: 
            root.after(0, lambda: tk.Label(frame_trend, text="Veride tarih kolonu bulunamadƒ±.", font=("Arial", 12)).pack(pady=20))

        if city_col:
            root.after(0, lambda: update_map_with_suppliers(df_analiz, city_col, ted_col))
        elif MAP_AVAILABLE:
            root.after(0, lambda: messagebox.showinfo("Bilgi", "Veride 'ƒ∞l' veya '≈ûehir' kolonu bulunamadƒ±ƒüƒ± i√ßin harita olu≈üturulamadƒ±."))

        root.after(0, lambda: update_listbox(sorted(df_analiz[ted_col].unique())))
        
        if karne_combobox:
             root.after(0, lambda: karne_combobox.configure(values=sorted(sonuc_main[ted_col].unique())))
        
        if siparis_stok_combobox and all_stock_codes:
             root.after(0, lambda: siparis_stok_combobox.configure(values=all_stock_codes))
        
        if siparis_grup_combobox and all_stock_groups:
             root.after(0, lambda: siparis_grup_combobox.configure(values=all_stock_groups))

        if negotiator_combobox:
             root.after(0, lambda: negotiator_combobox.configure(values=sorted(sonuc_main[ted_col].unique())))
        
        # Eksik-Fazla Y√ºklemeler sekmesini g√ºncelle
        root.after(0, update_eksik_fazla_suppliers)

        update_ai_comment_tab(mesaj, sonuc_main.sort_values("Skor", ascending=False).head(7))
        
        root.after(0, lambda: show_page("Y√∂netim Paneli"))
        root.after(0, lambda: messagebox.showinfo("Tamam", "Analiz bitti."))
        root.after(0, lambda: ai_status_label.configure(text="Hazƒ±r."))
        
    except Exception as e:
        root.after(0, lambda: messagebox.showerror("Hata", str(e)))
        root.after(0, lambda: ai_status_label.configure(text="Hata"))
    finally:
        root.after(0, stop_loading_gif)

def update_listbox(items):
    supplier_listbox.delete(0, tk.END); [supplier_listbox.insert(tk.END, i) for i in items]

def update_weights(val=None):
    price_label.configure(text=f"Fiyat: {price_weight.get():.2f}")
    delivery_label.configure(text=f"Teslim: {delivery_weight.get():.2f}")
    return_label.configure(text=f"ƒ∞ade: {return_weight.get():.2f}")

def save_outliers_to_excel():
    if outliers_global is None or outliers_global.empty:
        messagebox.showinfo("Bilgi", "Herhangi bir aykƒ±rƒ± deƒüer bulunamadƒ± veya hen√ºz analiz yapƒ±lmadƒ±.")
        return
        
    f = filedialog.asksaveasfilename(defaultextension=".xlsx", filetypes=[("Excel", "*.xlsx")])
    if f:
        try:
            outliers_global.to_excel(f, index=False)
            messagebox.showinfo("Ba≈üarƒ±lƒ±", f"Aykƒ±rƒ± deƒüerler kaydedildi.\nDosya: {os.path.basename(f)}")
        except Exception as e:
            messagebox.showerror("Hata", str(e))

class MyEventHandler(FileSystemEventHandler):
    def on_created(self, event):
        if not event.is_directory and event.src_path.lower().endswith(('.xlsx', '.csv')):
            set_status(f"Yeni dosya: {os.path.basename(event.src_path)}")
            # Otomatik dosya y√ºkleme
            self._auto_load_file(event.src_path)
    
    def _auto_load_file(self, file_path):
        """Yeni dosyayƒ± otomatik olarak y√ºkler"""
        global file_paths_global, all_stock_codes
        try:
            # Dosya tam yazƒ±lana kadar kƒ±sa bir bekleme
            import time
            time.sleep(0.5)
            
            # Dosyayƒ± file_paths_global'e ekle
            file_paths_global = [file_path]
            root.after(0, lambda: set_status(f"{os.path.basename(file_path)} otomatik y√ºklendi."))
            
            # Stok kodlarƒ±nƒ± √ßƒ±kar
            try:
                df_temp = pd.read_csv(file_path, dtype=str) if file_path.endswith('.csv') else pd.read_excel(file_path, dtype=str)
                stok_col_temp = find_stok_kodu_column(df_temp)
                if stok_col_temp:
                    unique_kodlar = sorted(df_temp[stok_col_temp].dropna().unique())
                    all_stock_codes = ["T√ºm Veri"] + list(unique_kodlar)
                    root.after(0, lambda: stok_kod_combobox.configure(values=all_stock_codes, state="normal"))
                    root.after(0, lambda: stok_kod_combobox.set("T√ºm Veri"))
                    
                    # LOG: Otomatik y√ºkleme
                    if activity_logger:
                        activity_logger.log_event("AUTO_FILE_LOAD", f"Dosya: {os.path.basename(file_path)}, Stok sayƒ±sƒ±: {len(unique_kodlar)}", "Analiz")
            except Exception as e:
                root.after(0, lambda: set_status(f"Dosya y√ºklendi ama stok kodlarƒ± √ßƒ±karƒ±lamadƒ±: {str(e)}"))
                if activity_logger:
                    activity_logger.log_error(f"Stok kodu √ßƒ±karma hatasƒ±: {str(e)}", "Analiz")
                    
        except Exception as e:
            root.after(0, lambda: set_status(f"Dosya y√ºkleme hatasƒ±: {str(e)}"))
            if activity_logger:
                activity_logger.log_error(f"Otomatik dosya y√ºkleme hatasƒ±: {str(e)}", "Analiz")

def start_monitoring():
    global observer, monitoring_folder
    monitoring_folder_temp = filedialog.askdirectory(title="ƒ∞zlemek i√ßin klas√∂r se√ßin")
    if monitoring_folder_temp:
        monitoring_folder = monitoring_folder_temp
        _start_monitoring_internal()
        # Klas√∂r ayarƒ±nƒ± kaydet
        save_settings()

def auto_start_monitoring():
    """Kaydedilmi≈ü klas√∂r√º otomatik olarak izlemeye ba≈üla"""
    global monitoring_folder
    if monitoring_folder and os.path.exists(monitoring_folder):
        print(f"Otomatik klas√∂r izleme ba≈ülatƒ±lƒ±yor: {monitoring_folder}")
        _start_monitoring_internal()

def _start_monitoring_internal():
    """Klas√∂r izlemeyi ba≈ülat (i√ß fonksiyon)"""
    global observer, monitoring_folder
    if not monitoring_folder:
        return
    
    set_status(f"'{os.path.basename(monitoring_folder)}' izleniyor...")
    event_handler = MyEventHandler()
    observer = Observer()
    observer.schedule(event_handler, monitoring_folder, recursive=False)
    observer.start()
    try:
        start_button.configure(state="disabled")
        stop_button.configure(state="normal")
    except: 
        pass

def stop_monitoring():
    global observer, monitoring_folder
    if observer:
        observer.stop()
        observer.join()
        set_status("Klas√∂r izleme durduruldu.")
        try:
            start_button.configure(state="normal")
            stop_button.configure(state="disabled")
        except: 
            pass
    # Klas√∂r ayarƒ±nƒ± kaldƒ±r
    monitoring_folder = None
    save_settings()

def clean_phone_number(phone_number):
    """
    Telefon numarasƒ±nƒ± temizler ve uluslararasƒ± formata √ßevirir.
    
    Args:
        phone_number: Temizlenecek telefon numarasƒ± (str)
    
    Returns:
        str: Temizlenmi≈ü ve formatlanmƒ±≈ü telefon numarasƒ± (+90XXXXXXXXXX)
        None: Ge√ßersiz numara durumunda
    
    Example:
        clean_phone_number("0555 123 45 67") -> "905551234567"
        clean_phone_number("+90 555 123 45 67") -> "905551234567"
    """
    if not phone_number:
        return None
    
    # Sadece rakamlar ve + i≈üaretini tut
    clean_phone = ''.join(c for c in str(phone_number) if c.isdigit() or c == '+')
    
    if not clean_phone:
        return None
    
    # + i≈üaretini kaldƒ±r (√ºlke kodu ayrƒ± ekleneceƒüi i√ßin)
    clean_phone = clean_phone.replace('+', '')
    
    # Eƒüer 0 ile ba≈ülƒ±yorsa, ilk 0'ƒ± kaldƒ±r
    if clean_phone.startswith('0'):
        clean_phone = clean_phone[1:]
    
    # Eƒüer 90 ile ba≈ülamƒ±yorsa, T√ºrkiye kodu ekle
    if not clean_phone.startswith('90'):
        clean_phone = '90' + clean_phone
    
    return clean_phone

def make_phone_call(supplier_name, phone_number):
    """Telefon aramasƒ± ba≈ülat (tel: URL scheme)"""
    try:
        # Telefon numarasƒ±nƒ± temizle
        clean_phone = clean_phone_number(phone_number)
        
        if not clean_phone:
            messagebox.showerror("Hata", "Ge√ßerli bir telefon numarasƒ± bulunamadƒ±.")
            return
        
        # tel: URL scheme kullanarak arama ba≈ülat
        tel_url = f"tel:{clean_phone}"
        webbrowser.open(tel_url)
        
        # LOG: Telefon aramasƒ±
        if activity_logger:
            activity_logger.log_phone_call(supplier_name, clean_phone, "Detaylar")
        
        # Email bildirimi g√∂nder (arka planda)
        def send_notification():
            try:
                subject = f"Telefon Aramasƒ± Yapƒ±ldƒ± - {supplier_name}"
                body = f"""
Tedarik√ßi ƒ∞leti≈üim Bildirimi

Tedarik√ßi: {supplier_name}
Telefon: {clean_phone}
ƒ∞≈ülem Zamanƒ±: {datetime.datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
Kullanƒ±cƒ±: {activity_logger.user_name if activity_logger else 'Bilinmiyor'}
Makine: {activity_logger.machine_name if activity_logger else 'Bilinmiyor'}

Bu bir otomatik bildirimdir.
                """
                send_email_with_attachments(GMAIL_RECEIVER_LOGS, subject, body, [])
            except Exception as email_error:
                # Email g√∂nderim hatasƒ± - loglama ve kullanƒ±cƒ±ya bilgi
                if activity_logger:
                    activity_logger.log_error(f"Email bildirimi g√∂nderilemedi: {str(email_error)}", "Detaylar")
                print(f"Email bildirimi hatasƒ±: {email_error}")  # Console log

        
        threading.Thread(target=send_notification, daemon=True).start()
        
        messagebox.showinfo("Arama Ba≈ülatƒ±ldƒ±", f"{supplier_name} i√ßin arama ba≈ülatƒ±ldƒ±.\nTelefon: {clean_phone}")
        
    except Exception as e:
        if activity_logger:
            activity_logger.log_error(f"Telefon aramasƒ± hatasƒ±: {str(e)}", "Detaylar")
        messagebox.showerror("Hata", f"Arama ba≈ülatƒ±lamadƒ±: {str(e)}")

def send_whatsapp_message(supplier_name, phone_number):
    """WhatsApp mesajƒ± g√∂nder (WhatsApp Web URL scheme)"""
    try:
        # Telefon numarasƒ±nƒ± temizle ve uluslararasƒ± formata √ßevir
        clean_phone = clean_phone_number(phone_number)
        
        if not clean_phone:
            messagebox.showerror("Hata", "Ge√ßerli bir telefon numarasƒ± bulunamadƒ±.")
            return
        
        # Mesaj i√ßeriƒüini kullanƒ±cƒ±dan al
        msg_window = tk.Toplevel()
        msg_window.title(f"WhatsApp Mesajƒ± - {supplier_name}")
        msg_window.geometry("500x400")
        
        tk.Label(msg_window, text=f"Alƒ±cƒ±: {supplier_name}", font=("Segoe UI", 12, "bold")).pack(pady=10)
        tk.Label(msg_window, text=f"Telefon: {clean_phone}", font=("Segoe UI", 10)).pack(pady=5)
        
        tk.Label(msg_window, text="Mesajƒ±nƒ±z:", font=("Segoe UI", 10)).pack(pady=10)
        msg_text = tk.Text(msg_window, wrap="word", font=("Segoe UI", 10), height=10)
        msg_text.pack(fill="both", expand=True, padx=20, pady=10)
        
        # Varsayƒ±lan mesaj ≈üablonu
        default_message = f"Merhaba {supplier_name},\n\nTedarik zinciri ekibi olarak sizinle ileti≈üime ge√ßmek istedik.\n\nSaygƒ±larƒ±mƒ±zla,\nDeFacto Tedarik Ekibi"
        msg_text.insert("1.0", default_message)
        
        def send_msg():
            message_content = msg_text.get("1.0", tk.END).strip()
            if not message_content:
                messagebox.showwarning("Uyarƒ±", "L√ºtfen bir mesaj yazƒ±n.")
                return
            
            # WhatsApp Web URL olu≈ütur
            # + i≈üaretini URL encoding yap
            phone_for_url = clean_phone.replace('+', '')
            import urllib.parse
            encoded_message = urllib.parse.quote(message_content)
            whatsapp_url = f"https://wa.me/{phone_for_url}?text={encoded_message}"
            
            # WhatsApp Web'i a√ß
            webbrowser.open(whatsapp_url)
            
            # LOG: WhatsApp mesajƒ±
            if activity_logger:
                activity_logger.log_whatsapp_message(supplier_name, clean_phone, message_content, "Detaylar")
            
            # Email bildirimi g√∂nder (arka planda)
            def send_notification():
                try:
                    subject = f"WhatsApp Mesajƒ± G√∂nderildi - {supplier_name}"
                    body = f"""
Tedarik√ßi ƒ∞leti≈üim Bildirimi

Tedarik√ßi: {supplier_name}
Telefon: {clean_phone}
ƒ∞≈ülem Zamanƒ±: {datetime.datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
Kullanƒ±cƒ±: {activity_logger.user_name if activity_logger else 'Bilinmiyor'}
Makine: {activity_logger.machine_name if activity_logger else 'Bilinmiyor'}

Mesaj ƒ∞√ßeriƒüi:
{message_content}

Bu bir otomatik bildirimdir.
                    """
                    send_email_with_attachments(GMAIL_RECEIVER_LOGS, subject, body, [])
                except Exception as email_error:
                    # Email g√∂nderim hatasƒ± - loglama ve kullanƒ±cƒ±ya bilgi
                    if activity_logger:
                        activity_logger.log_error(f"Email bildirimi g√∂nderilemedi: {str(email_error)}", "Detaylar")
                    print(f"Email bildirimi hatasƒ±: {email_error}")  # Console log
            
            threading.Thread(target=send_notification, daemon=True).start()
            
            msg_window.destroy()
            messagebox.showinfo("Mesaj G√∂nderildi", f"{supplier_name} i√ßin WhatsApp Web a√ßƒ±ldƒ±.\n\nL√ºtfen WhatsApp Web'den mesajƒ±nƒ±zƒ± g√∂nderin.")
        
        btn_frame = tk.Frame(msg_window)
        btn_frame.pack(fill="x", pady=10, padx=20)
        ttk.Button(btn_frame, text="‚ùå ƒ∞ptal", command=msg_window.destroy).pack(side="left", padx=5)
        ttk.Button(btn_frame, text="üì§ WhatsApp'ta G√∂nder", command=send_msg).pack(side="right", padx=5)
        
    except Exception as e:
        if activity_logger:
            activity_logger.log_error(f"WhatsApp mesajƒ± hatasƒ±: {str(e)}", "Detaylar")
        messagebox.showerror("Hata", f"WhatsApp mesajƒ± g√∂nderilemedi: {str(e)}")

def search_suppliers_by_phone():
    """Telefon numarasƒ±na g√∂re tedarik√ßi ara"""
    if df_global is None or tedarikci_col_global is None:
        messagebox.showwarning("Uyarƒ±", "L√ºtfen √∂nce veri y√ºkleyin ve analiz yapƒ±n.")
        return
    
    if phone_col_global is None or phone_col_global not in df_global.columns:
        messagebox.showwarning("Uyarƒ±", "Veride telefon kolonu bulunamadƒ±.\n\nL√ºtfen veri dosyanƒ±zda 'Telefon', 'Tel', 'Phone', 'Mobil' veya 'GSM' ba≈ülƒ±klƒ± bir kolon olduƒüundan emin olun.")
        return
    
    # Arama penceresi
    search_window = tk.Toplevel()
    search_window.title("Telefon ile Tedarik√ßi Ara")
    search_window.geometry("700x500")
    
    tk.Label(search_window, text="üìû Telefon ile Tedarik√ßi Arama", font=("Segoe UI", 14, "bold")).pack(pady=10)
    
    search_frame = tk.Frame(search_window)
    search_frame.pack(fill="x", padx=20, pady=10)
    
    tk.Label(search_frame, text="Telefon Numarasƒ±:", font=("Segoe UI", 10)).pack(side="left", padx=5)
    phone_entry = ttk.Entry(search_frame, width=30)
    phone_entry.pack(side="left", padx=5)
    
    result_frame = tk.Frame(search_window)
    result_frame.pack(fill="both", expand=True, padx=20, pady=10)
    
    # Treeview olu≈ütur
    tree = ttk.Treeview(result_frame, show='headings', height=15)
    vsb = ttk.Scrollbar(result_frame, orient="vertical", command=tree.yview)
    tree.configure(yscrollcommand=vsb.set)
    
    tree.grid(column=0, row=0, sticky='nsew')
    vsb.grid(column=1, row=0, sticky='ns')
    result_frame.grid_columnconfigure(0, weight=1)
    result_frame.grid_rowconfigure(0, weight=1)
    
    def do_search():
        # Treeview'i temizle
        for i in tree.get_children():
            tree.delete(i)
        
        search_text = phone_entry.get().strip()
        if not search_text:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen bir telefon numarasƒ± girin.")
            return
        
        # Telefon numarasƒ±nda ara
        df_filtered = df_global[df_global[phone_col_global].astype(str).str.contains(search_text, na=False, case=False)]
        
        if df_filtered.empty:
            messagebox.showinfo("Sonu√ß", f"'{search_text}' i√ßeren telefon numarasƒ± bulunamadƒ±.")
            return
        
        # Tedarik√ßi bazƒ±nda grupla
        suppliers = df_filtered.groupby(tedarikci_col_global).agg({
            phone_col_global: 'first'
        }).reset_index()
        
        # Kolonlarƒ± ayarla
        cols = [tedarikci_col_global, phone_col_global]
        tree['columns'] = cols
        
        for col in cols:
            tree.heading(col, text=col)
            tree.column(col, width=200)
        
        # Sonu√ßlarƒ± g√∂ster
        for row in suppliers.itertuples(index=False):
            tree.insert('', 'end', values=row)
        
        messagebox.showinfo("Sonu√ß", f"{len(suppliers)} tedarik√ßi bulundu.")
    
    def on_double_click(event):
        """√áift tƒ±klamada se√ßili tedarik√ßi i√ßin i≈ülem men√ºs√º g√∂ster"""
        selection = tree.selection()
        if not selection:
            return
        
        item = tree.item(selection[0])
        values = item['values']
        
        if len(values) < 2:
            return
        
        supplier_name = values[0]
        phone_number = values[1]
        
        # ƒ∞≈ülem men√ºs√º
        action_menu = tk.Toplevel()
        action_menu.title(f"ƒ∞≈ülemler - {supplier_name}")
        action_menu.geometry("400x200")
        
        tk.Label(action_menu, text=f"Tedarik√ßi: {supplier_name}", font=("Segoe UI", 12, "bold")).pack(pady=10)
        tk.Label(action_menu, text=f"Telefon: {phone_number}", font=("Segoe UI", 10)).pack(pady=5)
        
        ttk.Button(action_menu, text="üìû Ara", 
                  command=lambda: [make_phone_call(supplier_name, phone_number), action_menu.destroy()]).pack(fill="x", padx=50, pady=5)
        ttk.Button(action_menu, text="üí¨ WhatsApp G√∂nder", 
                  command=lambda: [send_whatsapp_message(supplier_name, phone_number), action_menu.destroy()]).pack(fill="x", padx=50, pady=5)
        ttk.Button(action_menu, text="‚ùå ƒ∞ptal", command=action_menu.destroy).pack(fill="x", padx=50, pady=5)
    
    tree.bind("<Double-1>", on_double_click)
    
    btn_frame = tk.Frame(search_window)
    btn_frame.pack(fill="x", padx=20, pady=10)
    
    ttk.Button(btn_frame, text="üîç Ara", command=do_search).pack(side="left", padx=5)
    ttk.Button(btn_frame, text="‚ùå Kapat", command=search_window.destroy).pack(side="right", padx=5)
    
    # Enter tu≈üu ile arama
    phone_entry.bind("<Return>", lambda e: do_search())

def dosyalarƒ±_sec():
    global file_paths_global, all_stock_codes, all_stock_groups
    file_paths = filedialog.askopenfilenames(filetypes=[("Excel/CSV", "*.*")])
    if file_paths:
        file_paths_global = list(file_paths)
        set_status(f"{len(file_paths_global)} adet dosya se√ßildi.")
        try:
             df_temp = pd.read_csv(file_paths[0], dtype=str) if file_paths[0].endswith('.csv') else pd.read_excel(file_paths[0], dtype=str)
             stok_col_temp = find_stok_kodu_column(df_temp)
             if stok_col_temp:
                unique_kodlar = sorted(df_temp[stok_col_temp].dropna().unique())
                all_stock_codes = ["T√ºm Veri"] + list(unique_kodlar)
                stok_kod_combobox['values'] = all_stock_codes
                stok_kod_combobox.set("T√ºm Veri")
                stok_kod_combobox.configure(state="normal")
             
             # Stok gruplarƒ±nƒ± √ßƒ±kar
             stok_grup_temp = find_col_by_keywords(df_temp, ["stok grubu", "stock group", "grup", "family", "product group", "malzeme grubu"])
             if stok_grup_temp:
                unique_gruplar = sorted(df_temp[stok_grup_temp].dropna().unique())
                all_stock_groups = ["T√ºm Veri"] + list(unique_gruplar)
                stok_grup_filter_combobox['values'] = all_stock_groups
        except:
            pass

def filter_stock_codes(event):
    if not all_stock_codes:
        return
    typed_text = event.widget.get().lower()
    if typed_text == "":
        stok_kod_combobox['values'] = all_stock_codes
    else:
        filtered_list = [item for item in all_stock_codes if typed_text in str(item).lower()]
        stok_kod_combobox['values'] = filtered_list

def start_analysis_threaded():
    global file_paths_global
    if not file_paths_global:
        messagebox.showerror("Hata", "L√ºtfen √∂nce dosya se√ßin.")
        return
    
    ai_progress_bar.pack(pady=10, fill="x")
    ai_progress_bar.start()
    play_loading_gif()

    # Filtreleme tipini ve deƒüerini al
    filter_type = analiz_filter_type_var.get()
    filter_value = ""
    
    if filter_type == "stock_code":
        filter_value = stok_kod_combobox.get()
        if filter_value == "T√ºm Veri":
            filter_value = ""
    elif filter_type == "stock_group":
        filter_value = stok_grup_filter_combobox.get()
        if filter_value == "T√ºm Veri":
            filter_value = ""
    # filter_type == "none" i√ßin filter_value bo≈ü kalƒ±r

    analysis_thread = threading.Thread(
        target=lambda: analiz_et_with_options(file_paths_global, filter_type, filter_value)
    )
    analysis_thread.daemon = True
    analysis_thread.start()

def export_all_data():
    global df_global
    if df_global is None:
        messagebox.showerror("Hata", "Veri yok.")
        return
    export_data(df_global, "xlsx", sheet_name="Ham Veri")

# ---------- STOK Y√ñNETƒ∞Mƒ∞ FONKSƒ∞YONLARI ----------
def init_stok_tab():
    """Stok y√∂netimi sekmesini ba≈ülatƒ±r"""
    global df_stok_global
    
    for widget in frame_stok.winfo_children():
        widget.destroy()
    
    # Ba≈ülƒ±k
    header = tk.Frame(frame_stok, bg="#2c3e50", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="üè≠ Defacto √úretim Raporlarƒ±", font=("Segoe UI", 18, "bold"), 
             fg="white", bg="#2c3e50").pack(anchor="w")
    tk.Label(header, text="Profesyonel √ºretim takip ve raporlama sistemi", 
             font=("Segoe UI", 10), fg="#ecf0f1", bg="#2c3e50").pack(anchor="w")
    
    # ƒ∞√ßerik alanƒ±
    content = tk.Frame(frame_stok, padx=15, pady=15, bg="#ecf0f1")
    content.pack(fill="both", expand=True)
    
    # Yardƒ±mcƒ± fonksiyonlar
    def darken_color(hex_color):
        """Rengi koyula≈ütƒ±r"""
        hex_color = hex_color.lstrip('#')
        r, g, b = tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))
        r = max(0, int(r * 0.7))
        g = max(0, int(g * 0.7))
        b = max(0, int(b * 0.7))
        return f'#{r:02x}{g:02x}{b:02x}'
    
    def create_report_button(parent, text, link, color):
        """≈ûƒ±k rapor butonu olu≈ütur"""
        def open_link():
            import webbrowser
            webbrowser.open(link)
            if activity_logger:
                activity_logger.log_activity(f"{text} a√ßƒ±ldƒ±", "Defacto √úretim Raporlarƒ±")
        
        btn = tk.Button(
            parent,
            text=text,
            font=("Segoe UI", 10, "bold"),
            bg=color,
            fg="white",
            activebackground=darken_color(color),
            activeforeground="white",
            relief="raised",
            bd=2,
            cursor="hand2",
            padx=12,
            pady=10,
            command=open_link
        )
        btn.pack(fill="both", expand=True, pady=4)
        
        # Hover efektleri
        darker = darken_color(color)
        def on_enter(e):
            btn.config(bg=darker, font=("Segoe UI", 11, "bold"))
        
        def on_leave(e):
            btn.config(bg=color, font=("Segoe UI", 10, "bold"))
        
        btn.bind("<Enter>", on_enter)
        btn.bind("<Leave>", on_leave)
        
        return btn
    
    # Ana grid container - 3 e≈üit s√ºtun
    main_grid = tk.Frame(content, bg="#ecf0f1")
    main_grid.pack(fill="both", expand=True)
    main_grid.grid_columnconfigure(0, weight=1, uniform="col")
    main_grid.grid_columnconfigure(1, weight=1, uniform="col")
    main_grid.grid_columnconfigure(2, weight=1, uniform="col")
    
    # 1. RAPORLAR B√ñL√úM√ú (Sol)
    reports_frame = tk.LabelFrame(
        main_grid, 
        text="üìä RAPORLAR", 
        font=("Segoe UI", 13, "bold"),
        bg="white",
        fg="#2c3e50",
        padx=12,
        pady=12,
        relief="solid",
        bd=2
    )
    reports_frame.grid(row=0, column=0, padx=5, pady=5, sticky="nsew")
    
    # Raporlar listesi
    reports_list = [
        ("üìä Stok Risk Raporu", "https://drive.google.com/drive/folders/0AAOTHYnHn5W6Uk9PVA", "#e74c3c"),
        ("üìà ABC (Pareto) Stok", "https://drive.google.com/drive/folders/0AN3M8nD1sYoxUk9PVA", "#3498db"),
        ("‚úÇÔ∏è Kesim Bekleyen Kuma≈ülar", "https://drive.google.com/drive/folders/0AKlwNnWGHfLxUk9PVA", "#9b59b6"),
        ("üîÑ Aktarƒ±m Bekleyen Orderlar", "https://drive.google.com/drive/folders/0AG84uaK9yXNbUk9PVA", "#e67e22"),
        ("üìã Stok Hareket Raporu", "https://drive.google.com/drive/folders/0AMBu85Fby69mUk9PVA", "#1abc9c"),
        ("üëó Dikili Kalan √úr√ºnler", "https://drive.google.com/drive/folders/0AFNhNFxnZJelUk9PVA", "#16a085"),
        ("üìÇ Ticari √úr√ºn Dosya Takibi", "https://docs.google.com/spreadsheets/d/1P-ipmcYfHZgN3Ds1y_X4slIad-X4MfOv/edit?gid=997396063#gid=997396063", "#2980b9")
    ]
    
    for btn_text, btn_link, btn_color in reports_list:
        create_report_button(reports_frame, btn_text, btn_link, btn_color)
    
    # 2. FORMLAR B√ñL√úM√ú (Orta)
    forms_frame = tk.LabelFrame(
        main_grid, 
        text="üìù FORMLAR", 
        font=("Segoe UI", 13, "bold"),
        bg="white",
        fg="#27ae60",
        padx=12,
        pady=12,
        relief="solid",
        bd=2
    )
    forms_frame.grid(row=0, column=1, padx=5, pady=5, sticky="nsew")
    
    # Formlar listesi
    forms_list = [
        ("üìù Kuma≈ü Teklif Alma Formu", "https://docs.google.com/forms/d/e/1FAIpQLSf3usmhN_SmM_joVM6U_duSeap14mheAGXwLnzveboCOMMabA/viewform?usp=header", "#27ae60"),
        ("üî• Fire Kuma≈ü Talep Formu", "https://docs.google.com/forms/d/e/1FAIpQLScZA2Gsw_B8rv6r6cUxC71dX5hXZPZpQc4Fi7WgmxgOjAbTkg/viewform?usp=header", "#c0392b")
    ]
    
    for btn_text, btn_link, btn_color in forms_list:
        create_report_button(forms_frame, btn_text, btn_link, btn_color)
    
    # 3. RESƒ∞MLER B√ñL√úM√ú (Saƒü)
    images_frame = tk.LabelFrame(
        main_grid, 
        text="üñºÔ∏è RESƒ∞MLER", 
        font=("Segoe UI", 13, "bold"),
        bg="white",
        fg="#34495e",
        padx=12,
        pady=12,
        relief="solid",
        bd=2
    )
    images_frame.grid(row=0, column=2, padx=5, pady=5, sticky="nsew")
    
    # Resimler listesi
    images_list = [
        ("üñºÔ∏è Order Resimleri", "https://drive.google.com/drive/folders/1mw1QjBCPo9iBhA7tNkIOigJvatqkgI0-", "#34495e")
    ]
    
    for btn_text, btn_link, btn_color in images_list:
        create_report_button(images_frame, btn_text, btn_link, btn_color)
    
    # Bilgi notu (alt kƒ±sƒ±m)
    info_frame = tk.Frame(content, bg="#ecf0f1", pady=10)
    info_frame.pack(side="bottom", fill="x")
    
    info_label = tk.Label(
        info_frame,
        text="üí° Raporlara eri≈ümek i√ßin Google hesabƒ±nƒ±zla giri≈ü yapmanƒ±z gerekebilir",
        font=("Segoe UI", 9, "italic"),
        fg="#7f8c8d",
        bg="#ecf0f1"
    )
    info_label.pack()
    
    # Not: MySQL mesajƒ±nƒ± kaldƒ±rdƒ±k - artƒ±k g√∂sterilmeyecek
    if False:  # Bu blok artƒ±k hi√ß √ßalƒ±≈ümayacak
        # Veri var - √∂zet istatistikler
        stats_frame = tk.Frame(content, bg="white", bd=1, relief="solid", padx=20, pady=15)
        stats_frame.pack(fill="x", pady=10)
        
        tk.Label(stats_frame, text="üìä √ñzet ƒ∞statistikler", font=("Segoe UI", 12, "bold"), 
                bg="white").pack(anchor="w", pady=(0,10))
        
        # ƒ∞statistik kartlarƒ±
        stats_grid = tk.Frame(stats_frame, bg="white")
        stats_grid.pack(fill="x")
        
        # Toplam kayƒ±t sayƒ±sƒ±
        card1 = tk.Frame(stats_grid, bg="#e8f5e9", padx=15, pady=10, bd=1, relief="solid")
        card1.pack(side="left", padx=5, expand=True, fill="both")
        tk.Label(card1, text="Toplam Kayƒ±t", font=("Segoe UI", 9), bg="#e8f5e9", fg="gray").pack()
        tk.Label(card1, text=f"{len(df_stok_global):,}", font=("Segoe UI", 16, "bold"), 
                bg="#e8f5e9", fg="#27ae60").pack()
        
        # Eƒüer stok miktarƒ± kolonu varsa
        stok_miktar_col = find_col_by_keywords(df_stok_global, ["miktar", "quantity", "qty", "adet", "stok"])
        if stok_miktar_col:
            try:
                total_qty = pd.to_numeric(df_stok_global[stok_miktar_col], errors='coerce').sum()
                card2 = tk.Frame(stats_grid, bg="#e3f2fd", padx=15, pady=10, bd=1, relief="solid")
                card2.pack(side="left", padx=5, expand=True, fill="both")
                tk.Label(card2, text="Toplam Stok Miktarƒ±", font=("Segoe UI", 9), 
                        bg="#e3f2fd", fg="gray").pack()
                tk.Label(card2, text=f"{total_qty:,.0f}", font=("Segoe UI", 16, "bold"), 
                        bg="#e3f2fd", fg="#2196f3").pack()
            except:
                pass
        
        # Kolon sayƒ±sƒ±
        card3 = tk.Frame(stats_grid, bg="#fff3e0", padx=15, pady=10, bd=1, relief="solid")
        card3.pack(side="left", padx=5, expand=True, fill="both")
        tk.Label(card3, text="Kolon Sayƒ±sƒ±", font=("Segoe UI", 9), bg="#fff3e0", fg="gray").pack()
        tk.Label(card3, text=f"{len(df_stok_global.columns)}", font=("Segoe UI", 16, "bold"), 
                bg="#fff3e0", fg="#ff9800").pack()
        
        # Tablo g√∂r√ºn√ºm√º
        table_frame = tk.LabelFrame(content, text="üìã Stok Verileri", font=("Segoe UI", 11, "bold"), 
                                   padx=10, pady=10)
        table_frame.pack(fill="both", expand=True, pady=10)
        
        # Treeview olu≈ütur
        tree_container = tk.Frame(table_frame)
        tree_container.pack(fill="both", expand=True)
        
        tree = ttk.Treeview(tree_container, show='headings', height=15)
        vsb = ttk.Scrollbar(tree_container, orient="vertical", command=tree.yview)
        hsb = ttk.Scrollbar(tree_container, orient="horizontal", command=tree.xview)
        tree.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)
        
        tree.grid(column=0, row=0, sticky='nsew')
        vsb.grid(column=1, row=0, sticky='ns')
        hsb.grid(column=0, row=1, sticky='ew')
        tree_container.grid_columnconfigure(0, weight=1)
        tree_container.grid_rowconfigure(0, weight=1)
        
        # Kolonlarƒ± ayarla
        tree['columns'] = list(df_stok_global.columns)
        for col in df_stok_global.columns:
            tree.heading(col, text=col)
            tree.column(col, width=120)
        
        # Verileri ekle (maksimum 1000 satƒ±r)
        for row in df_stok_global.head(1000).itertuples(index=False):
            tree.insert('', 'end', values=row)
        
        # Export butonlarƒ±
        btn_frame = tk.Frame(content)
        btn_frame.pack(fill="x", pady=10)
        
        def export_stok_excel():
            f = filedialog.asksaveasfilename(defaultextension=".xlsx", 
                                            filetypes=[("Excel", "*.xlsx")])
            if f:
                try:
                    df_stok_global.to_excel(f, index=False)
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", f"Stok verileri Excel'e aktarƒ±ldƒ±:\n{f}")
                except Exception as e:
                    messagebox.showerror("Hata", f"Export hatasƒ±: {str(e)}")
        
        ttk.Button(btn_frame, text="üìä Excel'e Aktar", command=export_stok_excel).pack(side="left", padx=5)
        ttk.Button(btn_frame, text="üîÑ Yeniden Y√ºkle", command=mysql_unified_data_loader).pack(side="left", padx=5)
        
        if len(df_stok_global) > 1000:
            tk.Label(content, text=f"‚ÑπÔ∏è Not: Toplam {len(df_stok_global)} kayƒ±t var, ilk 1000 g√∂steriliyor.", 
                    font=("Segoe UI", 9), fg="gray").pack(pady=5)

# ========== AI-POWERED FIRE SATI≈û HELPER FUNCTIONS ==========

def analyze_pdf_with_gemini(pdf_path):
    """Gemini AI ile PDF belgesi analiz et"""
    try:
        import PyPDF2
        import google.generativeai as genai
        
        # API yapƒ±landƒ±rmasƒ±
        if not GEMINI_API_KEY:
            return {"error": "Gemini API anahtarƒ± tanƒ±mlƒ± deƒüil"}
        
        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel('models/gemini-2.0-flash')
        
        # PDF okuma
        with open(pdf_path, 'rb') as file:
            pdf_reader = PyPDF2.PdfReader(file)
            text = ""
            for page in pdf_reader.pages[:5]:  # ƒ∞lk 5 sayfa
                text += page.extract_text()
        
        # AI analizi
        prompt = f"""A≈üaƒüƒ±daki T√ºrk√ße belgeyi analiz et:

{text[:3000]}

L√ºtfen ≈üu bilgileri √ßƒ±kar:
1. Belge T√ºr√º (sertifika, s√∂zle≈üme, izin belgesi, vb.)
2. Tedarik√ßi/Firma Adƒ±
3. Ge√ßerlilik Tarihi (varsa)
4. √ñnemli Maddeler
5. Referans Numarasƒ±

Cevabƒ±nƒ± JSON formatƒ±nda ver."""
        
        response = model.generate_content(prompt)
        return {"success": True, "analysis": response.text}
        
    except Exception as e:
        return {"error": str(e)}

def extract_supplier_info_from_pdf(pdf_path):
    """S√∂zle≈üme veya Sertifika PDF'inden tedarik√ßi bilgilerini AI ile √ßƒ±kar"""
    try:
        if not PYPDF2_AVAILABLE:
            return {"error": "PyPDF2 k√ºt√ºphanesi y√ºkl√º deƒüil"}
        
        if not GENAI_AVAILABLE or not GEMINI_API_KEY:
            return {"error": "Gemini AI yapƒ±landƒ±rƒ±lmamƒ±≈ü. API anahtarƒ±nƒ± ayarlayƒ±n."}
        
        import PyPDF2
        import google.generativeai as genai
        
        # API yapƒ±landƒ±rmasƒ±
        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel('models/gemini-2.0-flash')
        
        # PDF okuma
        print(f"[AI PDF] PDF okunuyor: {pdf_path}")
        with open(pdf_path, 'rb') as file:
            pdf_reader = PyPDF2.PdfReader(file)
            text = ""
            # ƒ∞lk 10 sayfa (genelde yeterli)
            for page in pdf_reader.pages[:10]:
                text += page.extract_text()
        
        if not text.strip():
            return {"error": "PDF'den metin √ßƒ±karƒ±lamadƒ±"}
        
        # AI ile analiz
        prompt = f"""A≈üaƒüƒ±daki T√ºrk√ße s√∂zle≈üme veya sertifika belgesini analiz et ve tedarik√ßi bilgilerini √ßƒ±kar.

Belge Metni:
{text[:5000]}

L√ºtfen ≈üu bilgileri √ßƒ±kar ve JSON formatƒ±nda ver:
{{
    "tedarikci_adi": "Tedarik√ßi firma adƒ±",
    "yetkili_kisi": "Yetkili ki≈üinin adƒ± soyadƒ±",
    "telefon": "Telefon numarasƒ±",
    "mail": "Email adresi",
    "adres": "≈ûirket adresi",
    "alim_turu": "Kuma≈ü, Fire, Tekleme, Aksesuar veya Diƒüer (belgeden tahmin et)",
    "sozlesme_bitis": "S√∂zle≈üme biti≈ü tarihi YYYY-MM-DD formatƒ±nda",
    "sertifika_bitis": "Sertifika biti≈ü tarihi YYYY-MM-DD formatƒ±nda",
    "belge_turu": "S√∂zle≈üme veya Sertifika"
}}

Eƒüer bir bilgi bulunamazsa null deƒüeri ver.
Sadece JSON formatƒ±nda yanƒ±t ver, ba≈üka a√ßƒ±klama ekleme."""
        
        print("[AI PDF] AI analizi yapƒ±lƒ±yor...")
        response = model.generate_content(prompt)
        
        # JSON parse et
        import json
        import re
        
        # JSON'u metinden √ßƒ±kar
        response_text = response.text
        # Markdown code block varsa temizle
        response_text = re.sub(r'```json\s*', '', response_text)
        response_text = re.sub(r'```\s*', '', response_text)
        response_text = response_text.strip()
        
        print(f"[AI PDF] AI yanƒ±tƒ±: {response_text[:200]}...")
        
        try:
            data = json.loads(response_text)
            print(f"[AI PDF] √áƒ±karƒ±lan bilgiler: {data}")
            return {"success": True, "data": data}
        except json.JSONDecodeError as e:
            print(f"[AI PDF] JSON parse hatasƒ±: {e}")
            # JSON parse edilemezse ham metin d√∂nd√ºr
            return {"success": False, "raw_text": response_text, "error": "JSON formatƒ± hatalƒ±"}
        
    except Exception as e:
        print(f"[AI PDF] Hata: {e}")
        import traceback
        traceback.print_exc()
        return {"error": str(e)}

def generate_sample_cari_data():
    """Test i√ßin √∂rnek cari bilgileri olu≈ütur"""
    try:
        if not OPENPYXL_AVAILABLE:
            return False, "Openpyxl k√ºt√ºphanesi y√ºkl√º deƒüil"
        
        # Dosya yoksa olu≈ütur
        if not os.path.exists(MASTER_CARI_BILGILER_PATH):
            initialize_cari_bilgiler_excel()
        
        from datetime import datetime, timedelta
        import random
        
        # √ñrnek veriler
        sample_data = [
            {
                "tedarikci_adi": "ABC Tekstil Ltd. ≈ûti.",
                "yetkili_kisi": "Ahmet Yƒ±lmaz",
                "telefon": "0212 555 0001",
                "adres": "Merkez Mah. Sanayi Cad. No:123 Beyoƒülu/ƒ∞stanbul",
                "alim_turu": "Kuma≈ü",
                "mail": "ahmet.yilmaz@abctekstil.com",
                "eksik_evraklar": "",
                "sozlesme_bitis": (datetime.now() + timedelta(days=45)).strftime('%Y-%m-%d'),
                "sertifika_bitis": (datetime.now() + timedelta(days=120)).strftime('%Y-%m-%d')
            },
            {
                "tedarikci_adi": "XYZ Fire Geri D√∂n√º≈ü√ºm A.≈û.",
                "yetkili_kisi": "Mehmet Demir",
                "telefon": "0216 444 0002",
                "adres": "Organize Sanayi B√∂lgesi 5. Cad. No:78 Gebze/Kocaeli",
                "alim_turu": "Fire",
                "mail": "mehmet.demir@xyzfire.com",
                "eksik_evraklar": "",
                "sozlesme_bitis": (datetime.now() + timedelta(days=-5)).strftime('%Y-%m-%d'),  # Expired
                "sertifika_bitis": (datetime.now() + timedelta(days=10)).strftime('%Y-%m-%d')   # Expiring soon
            },
            {
                "tedarikci_adi": "DEF Aksesuar San. Tic.",
                "yetkili_kisi": "Ay≈üe Kaya",
                "telefon": "0232 333 0003",
                "adres": "Halkapƒ±nar Mah. ƒ∞n√∂n√º Cad. No:456 Konak/ƒ∞zmir",
                "alim_turu": "Aksesuar",
                "mail": "ayse.kaya@defaksesuar.com",
                "eksik_evraklar": "Vergi Levhasƒ±",
                "sozlesme_bitis": (datetime.now() + timedelta(days=200)).strftime('%Y-%m-%d'),
                "sertifika_bitis": (datetime.now() + timedelta(days=180)).strftime('%Y-%m-%d')
            },
            {
                "tedarikci_adi": "GHI Tekleme Hizmetleri Ltd.",
                "yetkili_kisi": "Fatma √ñzt√ºrk",
                "telefon": "0312 777 0004",
                "adres": "Atat√ºrk Bulvarƒ± No:234 √áankaya/Ankara",
                "alim_turu": "Tekleme",
                "mail": "fatma.ozturk@ghitekleme.com",
                "eksik_evraklar": "",
                "sozlesme_bitis": (datetime.now() + timedelta(days=5)).strftime('%Y-%m-%d'),   # Expiring soon
                "sertifika_bitis": (datetime.now() + timedelta(days=90)).strftime('%Y-%m-%d')
            },
            {
                "tedarikci_adi": "JKL Tekstil Yan √úr√ºnleri",
                "yetkili_kisi": "Ali ≈ûahin",
                "telefon": "0224 999 0005",
                "adres": "Demirta≈ü OSB 12. Sokak No:89 Osmangazi/Bursa",
                "alim_turu": "Diƒüer",
                "mail": "ali.sahin@jkltekstil.com",
                "eksik_evraklar": "S√∂zle≈üme, Sertifika",
                "sozlesme_bitis": (datetime.now() + timedelta(days=-20)).strftime('%Y-%m-%d'),  # Expired
                "sertifika_bitis": (datetime.now() + timedelta(days=-10)).strftime('%Y-%m-%d')  # Expired
            }
        ]
        
        # Excel'e kaydet
        for data in sample_data:
            result = save_cari_bilgi(data)
            if not result[0]:
                print(f"√ñrnek veri kaydedilemedi: {result[1]}")
        
        return True, f"{len(sample_data)} √∂rnek kayƒ±t eklendi"
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return False, f"Hata: {str(e)}"

def initialize_cari_bilgiler_excel():
    """Cari Bilgiler Excel dosyasƒ±nƒ± olu≈ütur veya kontrol et"""
    try:
        if not OPENPYXL_AVAILABLE:
            print("Openpyxl k√ºt√ºphanesi y√ºkl√º deƒüil!")
            return False
        
        # Dosya yoksa olu≈ütur
        if not os.path.exists(MASTER_CARI_BILGILER_PATH):
            # Klas√∂r√º olu≈ütur
            os.makedirs(os.path.dirname(MASTER_CARI_BILGILER_PATH), exist_ok=True)
            
            # Yeni workbook olu≈ütur
            wb = Workbook()
            ws = wb.active
            ws.title = "Cari Bilgiler"
            
            # Ba≈ülƒ±klarƒ± ekle
            headers = ["Tedarik√ßi Adƒ±", "Yetkili Ki≈üi", "Telefon", "Adres", "Alƒ±m T√ºr√º", "Mail", "Eksik Evraklar", 
                      "S√∂zle≈üme Biti≈ü Tarihi", "Sertifika Biti≈ü Tarihi", "Kayƒ±t Tarihi"]
            ws.append(headers)
            
            # Ba≈ülƒ±klarƒ± formatla
            header_fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
            header_font = Font(bold=True, color="FFFFFF")
            header_alignment = Alignment(horizontal="center", vertical="center")
            
            for cell in ws[1]:
                cell.fill = header_fill
                cell.font = header_font
                cell.alignment = header_alignment
            
            # S√ºtun geni≈üliklerini ayarla
            ws.column_dimensions['A'].width = 30  # Tedarik√ßi Adƒ±
            ws.column_dimensions['B'].width = 25  # Yetkili Ki≈üi
            ws.column_dimensions['C'].width = 20  # Telefon
            ws.column_dimensions['D'].width = 40  # Adres
            ws.column_dimensions['E'].width = 20  # Alƒ±m T√ºr√º
            ws.column_dimensions['F'].width = 30  # Mail
            ws.column_dimensions['G'].width = 40  # Eksik Evraklar
            ws.column_dimensions['H'].width = 20  # S√∂zle≈üme Biti≈ü Tarihi
            ws.column_dimensions['I'].width = 20  # Sertifika Biti≈ü Tarihi
            ws.column_dimensions['J'].width = 20  # Kayƒ±t Tarihi
            
            wb.save(MASTER_CARI_BILGILER_PATH)
            print(f"Cari Bilgiler dosyasƒ± olu≈üturuldu: {MASTER_CARI_BILGILER_PATH}")
        
        return True
    except Exception as e:
        print(f"Cari Bilgiler Excel dosyasƒ± olu≈üturma hatasƒ±: {e}")
        return False

def load_cari_bilgiler():
    """Cari Bilgiler Excel dosyasƒ±ndan verileri y√ºkle"""
    try:
        if not OPENPYXL_AVAILABLE:
            return []
        
        if not os.path.exists(MASTER_CARI_BILGILER_PATH):
            initialize_cari_bilgiler_excel()
            return []
        
        # Pandas ile oku (daha kolay)
        df = pd.read_excel(MASTER_CARI_BILGILER_PATH)
        
        # S√ºtun isimlerindeki bo≈üluklarƒ± temizle
        df.columns = df.columns.str.strip()
        
        # S√ºtun isimlerini standartla≈ütƒ±r (eski adlar i√ßin mapping)
        column_mapping = {
            'Tarih': 'Kayƒ±t Tarihi'
        }
        
        # Kritik: Tarih s√ºtunlarƒ± i√ßin √∂zel mapping
        # Eƒüer 'Biti≈ü Tarihi' varsa ve 'S√∂zle≈üme Biti≈ü Tarihi' yoksa, map et
        if 'Biti≈ü Tarihi' in df.columns and 'S√∂zle≈üme Biti≈ü Tarihi' not in df.columns:
            # √ñnce 'Biti≈ü Tarihi'yi 'S√∂zle≈üme Biti≈ü Tarihi' olarak kopyala
            df['S√∂zle≈üme Biti≈ü Tarihi'] = df['Biti≈ü Tarihi']
            # Sertifika i√ßin de aynƒ± tarihi kullan (kullanƒ±cƒ± ayƒ±rƒ±m yapmamƒ±≈ü)
            df['Sertifika Biti≈ü Tarihi'] = df['Biti≈ü Tarihi']
            print("[MAPPING] 'Biti≈ü Tarihi' s√ºtunu 'S√∂zle≈üme Biti≈ü Tarihi' ve 'Sertifika Biti≈ü Tarihi' olarak e≈ülendi")
        
        # Eƒüer 'Ba≈ülangƒ±√ß Tarihi' varsa ve kullanƒ±labilirse bilgi olarak g√∂ster
        if 'Ba≈ülangƒ±√ß Tarihi' in df.columns:
            print("[INFO] 'Ba≈ülangƒ±√ß Tarihi' s√ºtunu mevcut (≈üu an kullanƒ±lmƒ±yor)")
        
        df.rename(columns=column_mapping, inplace=True)
        
        # NaN deƒüerlerini bo≈ü string ile deƒüi≈ütir
        df = df.fillna('')
        
        # S√ºtun isimlerini kontrol et ve d√ºzelt
        print(f"Excel s√ºtun isimleri: {df.columns.tolist()}")
        
        # DataFrame'i liste olarak d√∂nd√ºr
        records = df.to_dict('records')
        print(f"Y√ºklenen kayƒ±t sayƒ±sƒ±: {len(records)}")
        if len(records) > 0:
            print(f"√ñrnek kayƒ±t: {records[0]}")
        return records
    except Exception as e:
        print(f"Cari Bilgiler y√ºkleme hatasƒ±: {e}")
        import traceback
        traceback.print_exc()
        return []

def save_cari_bilgi(data):
    """Yeni cari bilgiyi Excel dosyasƒ±na kaydet"""
    import time
    
    try:
        if not OPENPYXL_AVAILABLE:
            return False, "Openpyxl k√ºt√ºphanesi y√ºkl√º deƒüil!"
        
        # Dosya yoksa olu≈ütur
        if not os.path.exists(MASTER_CARI_BILGILER_PATH):
            initialize_cari_bilgiler_excel()
        
        # Dosya kilidi kontrol√º ve retry mekanizmasƒ±
        max_retries = 3
        retry_delay = 1  # saniye
        
        for attempt in range(max_retries):
            try:
                # Dosya kilidi kontrol√º - dosyayƒ± yazma modunda a√ßmayƒ± dene
                with open(MASTER_CARI_BILGILER_PATH, 'a'):
                    pass
                
                # Dosyayƒ± a√ß
                wb = openpyxl.load_workbook(MASTER_CARI_BILGILER_PATH)
                ws = wb.active
                
                # Yeni satƒ±r ekle
                new_row = [
                    data.get('tedarikci_adi', ''),
                    data.get('yetkili_kisi', ''),
                    data.get('telefon', ''),
                    data.get('adres', ''),
                    data.get('alim_turu', ''),
                    data.get('mail', ''),
                    data.get('eksik_evraklar', ''),
                    data.get('sozlesme_bitis', ''),  # S√∂zle≈üme biti≈ü tarihi
                    data.get('sertifika_bitis', ''),  # Sertifika biti≈ü tarihi
                    datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                ]
                ws.append(new_row)
                
                # Dosyayƒ± kaydet
                wb.save(MASTER_CARI_BILGILER_PATH)
                wb.close()
                return True, "Cari bilgi ba≈üarƒ±yla kaydedildi!"
                
            except PermissionError as pe:
                if attempt < max_retries - 1:
                    time.sleep(retry_delay)
                    continue
                else:
                    # Son deneme de ba≈üarƒ±sƒ±z oldu
                    return False, (
                        "Excel dosyasƒ± a√ßƒ±k veya eri≈üim izni yok!\n\n"
                        "L√ºtfen a≈üaƒüƒ±daki adƒ±mlarƒ± deneyin:\n"
                        "1. Excel dosyasƒ±nƒ± kapatƒ±n (Cari Bilgiler.xlsx)\n"
                        "2. Dosyanƒ±n bulunduƒüu klas√∂re yazma izniniz olduƒüundan emin olun\n"
                        "3. Tekrar kaydetmeyi deneyin\n\n"
                        f"Dosya: {MASTER_CARI_BILGILER_PATH}"
                    )
            except Exception as inner_e:
                # Diƒüer hatalar i√ßin hemen √ßƒ±k
                raise inner_e
                
    except Exception as e:
        error_msg = str(e)
        if "Permission denied" in error_msg or "PermissionError" in str(type(e)):
            return False, (
                "Excel dosyasƒ± a√ßƒ±k veya eri≈üim izni yok!\n\n"
                "L√ºtfen a≈üaƒüƒ±daki adƒ±mlarƒ± deneyin:\n"
                "1. Excel dosyasƒ±nƒ± kapatƒ±n (Cari Bilgiler.xlsx)\n"
                "2. Dosyanƒ±n bulunduƒüu klas√∂re yazma izniniz olduƒüundan emin olun\n"
                "3. Tekrar kaydetmeyi deneyin\n\n"
                f"Dosya: {MASTER_CARI_BILGILER_PATH}"
            )
        return False, f"Kaydetme hatasƒ±: {error_msg}"

def update_cari_bilgi(row_index, data):
    """Var olan cari bilgiyi g√ºncelle"""
    import time
    
    try:
        if not OPENPYXL_AVAILABLE:
            return False, "Openpyxl k√ºt√ºphanesi y√ºkl√º deƒüil!"
        
        if not os.path.exists(MASTER_CARI_BILGILER_PATH):
            return False, "Cari Bilgiler dosyasƒ± bulunamadƒ±!"
        
        # Dosya kilidi kontrol√º ve retry mekanizmasƒ±
        max_retries = 3
        retry_delay = 1  # saniye
        
        for attempt in range(max_retries):
            try:
                # Dosya kilidi kontrol√º
                with open(MASTER_CARI_BILGILER_PATH, 'a'):
                    pass
                
                # Dosyayƒ± a√ß
                wb = openpyxl.load_workbook(MASTER_CARI_BILGILER_PATH)
                ws = wb.active
                
                # Satƒ±r indeksini g√ºncelle (Excel 1-indexed, ba≈ülƒ±k satƒ±rƒ± var)
                excel_row = row_index + 2  # +1 for header, +1 for 0-indexed to 1-indexed
                
                # Satƒ±rƒ± g√ºncelle
                ws.cell(row=excel_row, column=1).value = data.get('tedarikci_adi', '')
                ws.cell(row=excel_row, column=2).value = data.get('yetkili_kisi', '')
                ws.cell(row=excel_row, column=3).value = data.get('telefon', '')
                ws.cell(row=excel_row, column=4).value = data.get('adres', '')
                ws.cell(row=excel_row, column=5).value = data.get('alim_turu', '')
                ws.cell(row=excel_row, column=6).value = data.get('mail', '')
                ws.cell(row=excel_row, column=7).value = data.get('eksik_evraklar', '')
                
                # Dosyayƒ± kaydet
                wb.save(MASTER_CARI_BILGILER_PATH)
                wb.close()
                return True, "Cari bilgi ba≈üarƒ±yla g√ºncellendi!"
                
            except PermissionError as pe:
                if attempt < max_retries - 1:
                    time.sleep(retry_delay)
                    continue
                else:
                    return False, (
                        "Excel dosyasƒ± a√ßƒ±k veya eri≈üim izni yok!\n\n"
                        "L√ºtfen a≈üaƒüƒ±daki adƒ±mlarƒ± deneyin:\n"
                        "1. Excel dosyasƒ±nƒ± kapatƒ±n (Cari Bilgiler.xlsx)\n"
                        "2. Dosyanƒ±n bulunduƒüu klas√∂re yazma izniniz olduƒüundan emin olun\n"
                        "3. Tekrar kaydetmeyi deneyin\n\n"
                        f"Dosya: {MASTER_CARI_BILGILER_PATH}"
                    )
            except Exception as inner_e:
                raise inner_e
                
    except Exception as e:
        error_msg = str(e)
        if "Permission denied" in error_msg or "PermissionError" in str(type(e)):
            return False, (
                "Excel dosyasƒ± a√ßƒ±k veya eri≈üim izni yok!\n\n"
                "L√ºtfen a≈üaƒüƒ±daki adƒ±mlarƒ± deneyin:\n"
                "1. Excel dosyasƒ±nƒ± kapatƒ±n (Cari Bilgiler.xlsx)\n"
                "2. Dosyanƒ±n bulunduƒüu klas√∂re yazma izniniz olduƒüundan emin olun\n"
                "3. Tekrar kaydetmeyi deneyin\n\n"
                f"Dosya: {MASTER_CARI_BILGILER_PATH}"
            )
        return False, f"G√ºncelleme hatasƒ±: {error_msg}"

def check_waste_disposal_compliance(supplier_name):
    """Tedarik√ßi i√ßin √ßevre uyumluluk kontrol√º yap"""
    import glob
    
    compliance_data = {
        "supplier": supplier_name,
        "score": 0,
        "total_checks": 5,
        "passed_checks": 0,
        "documents": {
            "cevre_izin": False,
            "atik_kodlari": False,
            "uatf": False,
            "tartim": False,
            "geri_kazanim": False
        },
        "found_files": []
    }
    
    try:
        # Sertifika ve s√∂zle≈üme klas√∂rlerini tara
        all_pdfs = []
        
        if os.path.exists(MASTER_SERTIFIKA_PATH):
            cert_pdfs = glob.glob(os.path.join(MASTER_SERTIFIKA_PATH, "*.[pP][dD][fF]"))
            all_pdfs.extend(cert_pdfs)
        
        if os.path.exists(MASTER_SOZLESME_PATH):
            contract_pdfs = glob.glob(os.path.join(MASTER_SOZLESME_PATH, "*.[pP][dD][fF]"))
            all_pdfs.extend(contract_pdfs)
        
        # Tedarik√ßiye ait dosyalarƒ± filtrele
        supplier_files = [f for f in all_pdfs if supplier_name.upper() in os.path.basename(f).upper()]
        
        for pdf_file in supplier_files:
            filename = os.path.basename(pdf_file).lower()
            
            # Dosya adƒ±na g√∂re belge t√ºr√ºn√º tespit et
            if any(keyword in filename for keyword in ['cevre', 'izin', 'lisans', 'environmental']):
                compliance_data["documents"]["cevre_izin"] = True
                compliance_data["found_files"].append(("√áevre ƒ∞zin", pdf_file))
                compliance_data["passed_checks"] += 1
            
            if any(keyword in filename for keyword in ['atik', 'waste', '200111', 'kod']):
                compliance_data["documents"]["atik_kodlari"] = True
                compliance_data["found_files"].append(("Atƒ±k Kodlarƒ±", pdf_file))
                compliance_data["passed_checks"] += 1
            
            if any(keyword in filename for keyword in ['uatf', 'tasima', 'transport']):
                compliance_data["documents"]["uatf"] = True
                compliance_data["found_files"].append(("UATF", pdf_file))
                compliance_data["passed_checks"] += 1
            
            if any(keyword in filename for keyword in ['tartim', 'kantar', 'weigh', 'agirlik']):
                compliance_data["documents"]["tartim"] = True
                compliance_data["found_files"].append(("Tartƒ±m/Kantar", pdf_file))
                compliance_data["passed_checks"] += 1
            
            if any(keyword in filename for keyword in ['r12', 'geri', 'kazanim', 'recovery']):
                compliance_data["documents"]["geri_kazanim"] = True
                compliance_data["found_files"].append(("Geri Kazanƒ±m R12", pdf_file))
                compliance_data["passed_checks"] += 1
        
        # Uyumluluk skorunu hesapla
        compliance_data["score"] = int((compliance_data["passed_checks"] / compliance_data["total_checks"]) * 100)
        
    except Exception as e:
        compliance_data["error"] = str(e)
    
    return compliance_data

def generate_waste_contract_with_ai(supplier_name, compliance_data, template_path=None):
    """Gemini AI ile atƒ±k bertaraf s√∂zle≈ümesi olu≈ütur"""
    try:
        import google.generativeai as genai
        
        if not GEMINI_API_KEY:
            return "‚ùå Gemini API anahtarƒ± tanƒ±mlƒ± deƒüil. L√ºtfen GEMINI_API_KEY deƒüi≈ükenini g√ºncelleyin."
        
        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel('models/gemini-2.0-flash')
        
        # Uyumluluk durumunu √∂zetle
        missing_docs = []
        if not compliance_data["documents"]["cevre_izin"]:
            missing_docs.append("√áevre ƒ∞zin ve Lisans Belgesi")
        if not compliance_data["documents"]["atik_kodlari"]:
            missing_docs.append("Atƒ±k Kodlarƒ± Lisansƒ±")
        if not compliance_data["documents"]["uatf"]:
            missing_docs.append("UATF")
        if not compliance_data["documents"]["tartim"]:
            missing_docs.append("Tartƒ±m Fi≈üi")
        if not compliance_data["documents"]["geri_kazanim"]:
            missing_docs.append("Geri Kazanƒ±m Belgesi")
        
        # ≈ûablon s√∂zle≈üme varsa oku
        template_content = ""
        if template_path and os.path.exists(template_path):
            try:
                if template_path.lower().endswith('.pdf'):
                    import PyPDF2
                    with open(template_path, 'rb') as file:
                        pdf_reader = PyPDF2.PdfReader(file)
                        template_content = ""
                        for page in pdf_reader.pages[:10]:  # ƒ∞lk 10 sayfa
                            template_content += page.extract_text()
                elif template_path.lower().endswith('.docx'):
                    from docx import Document
                    doc = Document(template_path)
                    template_content = "\n".join([para.text for para in doc.paragraphs])
                elif template_path.lower().endswith('.txt'):
                    with open(template_path, 'r', encoding='utf-8') as file:
                        template_content = file.read()
                
                if template_content:
                    template_content = f"\n\n≈ûablon S√∂zle≈üme Referansƒ±:\n{template_content[:3000]}\n"  # ƒ∞lk 3000 karakter
            except Exception as e:
                template_content = f"\n\n‚ö†Ô∏è ≈ûablon okuma hatasƒ±: {str(e)}\n"
        
        prompt = f"""Defacto ile {supplier_name} arasƒ±nda imzalanacak profesyonel bir Fire (Atƒ±k Tekstil) Bertaraf S√∂zle≈ümesi taslaƒüƒ± olu≈ütur.

S√∂zle≈üme ≈üu 8 maddeyi i√ßermeli:
1. √áevre ƒ∞zin ve Lisans Belgesi gereksinimi
2. Lisans kapsamƒ±nda atƒ±k kodlarƒ± (√∂zellikle 200111 tekstil atƒ±ƒüƒ±)
3. UATF (Ulusal Atƒ±k Ta≈üƒ±ma Formu) U√áBS √ºzerinden d√ºzenleme zorunluluƒüu
4. Tartƒ±m fi≈üi/kantar belgesi gerekliliƒüi (lokasyon, miktar, atƒ±k kodu bilgileri ile)
5. Aylƒ±k/yƒ±llƒ±k atƒ±k raporlama y√ºk√ºml√ºl√ºƒü√º
6. Geri kazanƒ±m y√∂ntemi (R12 atƒ±k i≈üleme) belgelendirme
7. Nihai atƒ±k sorumluluƒüu ve kanƒ±t dok√ºmanlarƒ±
8. Cezai ≈üartlar ve s√∂zle≈üme feshi ko≈üullarƒ±

Mevcut Uyumluluk Durumu:
- Uyumluluk Skoru: %{compliance_data["score"]}
- Eksik Belgeler: {", ".join(missing_docs) if missing_docs else "YOK"}
{template_content}
{"Yukarƒ±daki ≈üablon s√∂zle≈ümeyi referans alarak benzer format, stil ve dil kullanarak yeni s√∂zle≈üme olu≈ütur." if template_content else ""}
Profesyonel, yasal terminoloji kullanarak T√ºrk√ße s√∂zle≈üme taslaƒüƒ± hazƒ±rla."""
        
        response = model.generate_content(prompt)
        return response.text
        
    except Exception as e:
        return f"‚ùå S√∂zle≈üme olu≈üturma hatasƒ±: {str(e)}"

def send_compliance_email(supplier_email, supplier_name, compliance_data, ai_message):
    """Tedarik√ßiye uyumluluk raporu emaili g√∂nder"""
    try:
        import smtplib
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        
        # Email i√ßeriƒüi
        msg = MIMEMultipart('alternative')
        msg['Subject'] = f"Fire Satƒ±≈ü √áevre Uyumluluk Raporu - {supplier_name}"
        msg['From'] = GMAIL_USER
        msg['To'] = supplier_email
        
        # HTML i√ßerik
        status_color = "#27ae60" if compliance_data["score"] == 100 else "#e67e22"
        status_text = "‚úÖ TAM UYUMLU" if compliance_data["score"] == 100 else "‚ö†Ô∏è EKSƒ∞KLER VAR"
        
        html_content = f"""
        <html>
        <body style="font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4;">
            <div style="max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px;">
                <h2 style="color: #2c3e50;">üèõÔ∏è Fire Satƒ±≈ü √áevre Uyumluluk Raporu</h2>
                <hr style="border: 1px solid #ecf0f1;">
                
                <p><strong>Tedarik√ßi:</strong> {supplier_name}</p>
                <p><strong>Tarih:</strong> {datetime.datetime.now().strftime('%d.%m.%Y %H:%M')}</p>
                
                <div style="background: {status_color}; color: white; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h3 style="margin: 0;">Uyumluluk Skoru: %{compliance_data["score"]}</h3>
                    <p style="margin: 5px 0 0 0;">{status_text}</p>
                </div>
                
                <h3>üìã Gerekli Belgeler Durumu:</h3>
                <ul style="list-style: none; padding: 0;">
                    <li>{"‚úÖ" if compliance_data["documents"]["cevre_izin"] else "‚ùå"} √áevre ƒ∞zin ve Lisans Belgesi</li>
                    <li>{"‚úÖ" if compliance_data["documents"]["atik_kodlari"] else "‚ùå"} Atƒ±k Kodlarƒ± Lisansƒ± (200111)</li>
                    <li>{"‚úÖ" if compliance_data["documents"]["uatf"] else "‚ùå"} UATF (Ulusal Atƒ±k Ta≈üƒ±ma Formu)</li>
                    <li>{"‚úÖ" if compliance_data["documents"]["tartim"] else "‚ùå"} Tartƒ±m Fi≈üi / Kantar Belgesi</li>
                    <li>{"‚úÖ" if compliance_data["documents"]["geri_kazanim"] else "‚ùå"} Geri Kazanƒ±m Belgesi (R12)</li>
                </ul>
                
                <div style="background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h3>ü§ñ AI Deƒüerlendirme:</h3>
                    <p style="white-space: pre-wrap;">{ai_message[:500]}...</p>
                </div>
                
                <hr style="border: 1px solid #ecf0f1;">
                <p style="color: #7f8c8d; font-size: 12px;">
                    Bu email Defacto Tedarik√ßi Uyumluluk Sistemi tarafƒ±ndan otomatik olu≈üturulmu≈ütur.<br>
                    Sorularƒ±nƒ±z i√ßin: {GMAIL_USER}
                </p>
            </div>
        </body>
        </html>
        """
        
        part = MIMEText(html_content, 'html', 'utf-8')
        msg.attach(part)
        
        # Email g√∂nder
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
        server.send_message(msg)
        server.quit()
        
        return True, "‚úÖ Email ba≈üarƒ±yla g√∂nderildi!"
        
    except Exception as e:
        return False, f"‚ùå Email g√∂nderme hatasƒ±: {str(e)}"

# ========== END OF AI HELPER FUNCTIONS ==========

def init_compliance_center_tab():
    """Tedarik√ßi Uyumluluk Merkezi - AI Destekli Sertifika ve S√∂zle≈üme Y√∂netimi"""
    import glob
    from datetime import datetime, timedelta
    
    for widget in frame_compliance.winfo_children():
        widget.destroy()
    
    # Ba≈ülƒ±k
    header = tk.Frame(frame_compliance, bg="#2c3e50", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="üèõÔ∏è Tedarik√ßi Uyumluluk Merkezi (AI Powered)", font=("Segoe UI", 20, "bold"), 
             fg="white", bg="#2c3e50").pack(anchor="w")
    tk.Label(header, text="Supplier Compliance Center - Fire Satƒ±≈ü Kontrol & √áevre Uyumluluk", 
             font=("Segoe UI", 11), fg="#ecf0f1", bg="#2c3e50").pack(anchor="w")
    
    # Scrollable canvas container
    canvas_container = tk.Frame(frame_compliance)
    canvas_container.pack(fill="both", expand=True)
    
    # Canvas and scrollbar
    canvas = tk.Canvas(canvas_container, bg="#ecf0f1", highlightthickness=0)
    scrollbar = ttk.Scrollbar(canvas_container, orient="vertical", command=canvas.yview)
    
    # Frame inside canvas
    content = tk.Frame(canvas, padx=15, pady=15, bg="#ecf0f1")
    
    # Configure scrolling
    canvas.configure(yscrollcommand=scrollbar.set)
    canvas.pack(side="left", fill="both", expand=True)
    scrollbar.pack(side="right", fill="y")
    
    # Create window in canvas
    canvas_frame = canvas.create_window((0, 0), window=content, anchor="nw")
    
    # Update scrollregion when content changes
    def on_frame_configure(event=None):
        canvas.configure(scrollregion=canvas.bbox("all"))
        canvas.itemconfig(canvas_frame, width=canvas.winfo_width())
    
    content.bind("<Configure>", on_frame_configure)
    canvas.bind("<Configure>", on_frame_configure)
    
    # Mouse wheel scrolling
    def on_mousewheel(event):
        canvas.yview_scroll(int(-1*(event.delta/120)), "units")
    
    canvas.bind_all("<MouseWheel>", on_mousewheel)
    
    # Ana bilgi kartlarƒ±
    info_container = tk.Frame(content, bg="#ecf0f1")
    info_container.pack(fill="x", pady=(0, 15))
    
    def create_info_card(parent, title, value, color, icon):
        """Bilgi kartƒ± olu≈ütur"""
        card = tk.Frame(parent, bg="white", bd=2, relief="solid", padx=20, pady=15)
        card.pack(side="left", padx=5, expand=True, fill="both")
        
        tk.Label(card, text=icon, font=("Segoe UI", 24), bg="white", fg=color).pack()
        tk.Label(card, text=title, font=("Segoe UI", 10), bg="white", fg="gray").pack()
        tk.Label(card, text=value, font=("Segoe UI", 16, "bold"), bg="white", fg=color).pack()
        
        return card
    
    # Dosya sayƒ±larƒ±nƒ± hesapla
    cert_count = 0
    contract_count = 0
    
    try:
        if os.path.exists(MASTER_SERTIFIKA_PATH):
            cert_files = glob.glob(os.path.join(MASTER_SERTIFIKA_PATH, "*.[pP][dD][fF]"))
            cert_count = len(cert_files)
    except Exception as e:
        print(f"Sertifika klas√∂r√º okuma hatasƒ±: {e}")
    
    try:
        if os.path.exists(MASTER_SOZLESME_PATH):
            contract_files = glob.glob(os.path.join(MASTER_SOZLESME_PATH, "*.[pP][dD][fF]"))
            contract_count = len(contract_files)
    except Exception as e:
        print(f"S√∂zle≈üme klas√∂r√º okuma hatasƒ±: {e}")
    
    total_docs = cert_count + contract_count
    
    # Bilgi kartlarƒ±
    create_info_card(info_container, "Toplam Belge", str(total_docs), "#3498db", "üìÑ")
    create_info_card(info_container, "Sertifikalar", str(cert_count), "#27ae60", "üèÜ")
    create_info_card(info_container, "S√∂zle≈ümeler", str(contract_count), "#e74c3c", "üìù")
    
    # üî• FIRE SATI≈û KONTROL PANELƒ∞
    fire_panel = tk.LabelFrame(content, text="üî• Fire Satƒ±≈ü √áevre Uyumluluk Kontrol√º", 
                               font=("Segoe UI", 13, "bold"), bg="white", fg="#e67e22",
                               padx=15, pady=15, relief="solid", bd=2)
    fire_panel.pack(fill="x", pady=(0, 15))
    
    # Kontrol formu
    form_frame = tk.Frame(fire_panel, bg="white")
    form_frame.pack(fill="x", pady=10)
    
    tk.Label(form_frame, text="Tedarik√ßi Adƒ±:", font=("Segoe UI", 10, "bold"),
             bg="white").grid(row=0, column=0, sticky="w", padx=5, pady=5)
    
    supplier_entry = tk.Entry(form_frame, font=("Segoe UI", 10), width=30)
    supplier_entry.grid(row=0, column=1, padx=5, pady=5, sticky="ew")
    
    tk.Label(form_frame, text="Tedarik√ßi Email:", font=("Segoe UI", 10, "bold"),
             bg="white").grid(row=1, column=0, sticky="w", padx=5, pady=5)
    
    email_entry = tk.Entry(form_frame, font=("Segoe UI", 10), width=30)
    email_entry.grid(row=1, column=1, padx=5, pady=5, sticky="ew")
    
    tk.Label(form_frame, text="Defacto S√∂zle≈üme ≈ûablonu:", font=("Segoe UI", 10, "bold"),
             bg="white").grid(row=2, column=0, sticky="w", padx=5, pady=5)
    
    template_frame = tk.Frame(form_frame, bg="white")
    template_frame.grid(row=2, column=1, padx=5, pady=5, sticky="ew")
    
    template_entry = tk.Entry(template_frame, font=("Segoe UI", 9), width=30)
    template_entry.pack(side="left", fill="x", expand=True, padx=(0, 5))
    
    def browse_template():
        """≈ûablon s√∂zle≈üme dosyasƒ± se√ß"""
        file_path = filedialog.askopenfilename(
            title="Defacto S√∂zle≈üme ≈ûablonu Se√ßin",
            filetypes=[("PDF Dosyalarƒ±", "*.pdf"), ("Word Dosyalarƒ±", "*.docx"), ("Metin Dosyalarƒ±", "*.txt"), ("T√ºm Dosyalar", "*.*")]
        )
        if file_path:
            template_entry.delete(0, tk.END)
            template_entry.insert(0, file_path)
    
    tk.Button(template_frame, text="G√∂zat", font=("Segoe UI", 8),
             bg="#95a5a6", fg="white", cursor="hand2", command=browse_template).pack(side="left")
    
    form_frame.grid_columnconfigure(1, weight=1)
    
    # Sonu√ß alanƒ± with scrollbar
    result_frame = tk.Frame(fire_panel, bg="white")
    result_frame.pack(fill="both", expand=True, pady=10)
    
    result_scrollbar = tk.Scrollbar(result_frame, orient="vertical")
    result_scrollbar.pack(side="right", fill="y")
    
    result_text = tk.Text(result_frame, height=12, width=80, font=("Consolas", 9),
                         wrap="word", bg="#f8f9fa", relief="solid", bd=1,
                         yscrollcommand=result_scrollbar.set)
    result_text.pack(side="left", fill="both", expand=True)
    
    result_scrollbar.config(command=result_text.yview)
    
    def check_fire_compliance():
        """Fire satƒ±≈ü uyumluluk kontrol√º yap"""
        supplier = supplier_entry.get().strip()
        if not supplier:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen tedarik√ßi adƒ± girin!")
            return
        
        result_text.delete("1.0", "end")
        result_text.insert("end", "üîç Kontrol ediliyor...\n\n")
        result_text.update()
        
        # Uyumluluk kontrol√º
        compliance = check_waste_disposal_compliance(supplier)
        
        # Sonu√ßlarƒ± g√∂ster
        result_text.delete("1.0", "end")
        result_text.insert("end", f"{'='*60}\n")
        result_text.insert("end", f"üèõÔ∏è FIRE SATI≈û √áEVRE UYUMLULUK RAPORU\n")
        result_text.insert("end", f"{'='*60}\n\n")
        
        result_text.insert("end", f"Tedarik√ßi: {compliance['supplier']}\n")
        result_text.insert("end", f"Uyumluluk Skoru: %{compliance['score']}\n")
        result_text.insert("end", f"Durum: {'‚úÖ TAM UYUMLU' if compliance['score'] == 100 else '‚ö†Ô∏è EKSƒ∞KLER VAR'}\n\n")
        
        result_text.insert("end", "üìã Gerekli Belgeler Durumu:\n")
        result_text.insert("end", f"{'-'*60}\n")
        
        # Belge durumlarƒ±nƒ± g√∂ster
        docs_turkish = {
            "cevre_izin": "√áevre ƒ∞zin ve Lisans Belgesi",
            "atik_kodlari": "Atƒ±k Kodlarƒ± Lisansƒ± (200111)",
            "uatf": "UATF (Ulusal Atƒ±k Ta≈üƒ±ma Formu)",
            "tartim": "Tartƒ±m Fi≈üi / Kantar Belgesi",
            "geri_kazanim": "Geri Kazanƒ±m Belgesi (R12)"
        }
        
        missing_docs = []
        for doc_key, doc_name in docs_turkish.items():
            status = compliance['documents'][doc_key]
            status_icon = "‚úÖ" if status else "‚ùå"
            result_text.insert("end", f"{status_icon} {doc_name} - {'MEVCUT' if status else 'EKSƒ∞K'}\n")
            if not status:
                missing_docs.append(doc_name)
        
        if missing_docs:
            result_text.insert("end", f"\n‚ö†Ô∏è Eksik Belgeler ({len(missing_docs)}):\n")
            for doc in missing_docs:
                result_text.insert("end", f"  ‚Ä¢ {doc}\n")
        
        if compliance['found_files']:
            result_text.insert("end", f"\n‚úÖ Bulunan Belgeler ({len(compliance['found_files'])}):\n")
            for doc_name, doc_path in compliance['found_files']:
                result_text.insert("end", f"  ‚Ä¢ {doc_name}: {os.path.basename(doc_path)}\n")
        else:
            result_text.insert("end", f"\n‚ö†Ô∏è Hi√ßbir belge bulunamadƒ±!\n")
            result_text.insert("end", f"Tedarik√ßi adƒ±nƒ±n dosya adlarƒ±nda ge√ßtiƒüinden emin olun.\n")
        
        result_text.insert("end", f"\n{'='*60}\n")
        
        # Global deƒüi≈ükene kaydet (email i√ßin)
        globals()['last_compliance_check'] = compliance
    
    def generate_contract():
        """AI ile s√∂zle≈üme olu≈ütur"""
        supplier = supplier_entry.get().strip()
        if not supplier:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen √∂nce tedarik√ßi adƒ± girin!")
            return
        
        if 'last_compliance_check' not in globals():
            messagebox.showwarning("Uyarƒ±", "L√ºtfen √∂nce uyumluluk kontrol√º yapƒ±n!")
            return
        
        result_text.delete("1.0", "end")
        template_path = template_entry.get().strip() if template_entry.get().strip() else None
        
        if template_path:
            result_text.insert("end", "ü§ñ AI ile s√∂zle≈üme olu≈üturuluyor (Defacto ≈üablonu kullanƒ±lƒ±yor)...\n\n")
        else:
            result_text.insert("end", "ü§ñ AI ile s√∂zle≈üme olu≈üturuluyor...\n\n")
        result_text.update()
        
        # AI ile s√∂zle≈üme olu≈ütur
        contract = generate_waste_contract_with_ai(supplier, globals()['last_compliance_check'], template_path)
        
        result_text.delete("1.0", "end")
        result_text.insert("end", contract)
    
    def send_email():
        """Tedarik√ßiye email g√∂nder"""
        supplier = supplier_entry.get().strip()
        email = email_entry.get().strip()
        
        if not supplier or not email:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen tedarik√ßi adƒ± ve email girin!")
            return
        
        if 'last_compliance_check' not in globals():
            messagebox.showwarning("Uyarƒ±", "L√ºtfen √∂nce uyumluluk kontrol√º yapƒ±n!")
            return
        
        compliance_data = globals()['last_compliance_check']
        
        # AI yorumu olu≈ütur
        ai_msg = "L√ºtfen eksik belgeleri en kƒ±sa s√ºrede tamamlayƒ±nƒ±z." if compliance_data['score'] < 100 else "T√ºm belgeleriniz eksiksizdir."
        
        # Email g√∂nder
        success, message = send_compliance_email(email, supplier, compliance_data, ai_msg)
        
        if success:
            messagebox.showinfo("Ba≈üarƒ±lƒ±", message)
        else:
            messagebox.showerror("Hata", message)
    
    # Butonlar
    btn_container = tk.Frame(fire_panel, bg="white")
    btn_container.pack(fill="x", pady=(0, 5))
    
    tk.Button(btn_container, text="üîç Uyumluluk Kontrol√º Yap", font=("Segoe UI", 10, "bold"),
             bg="#3498db", fg="white", relief="raised", bd=2, cursor="hand2",
             padx=15, pady=8, command=check_fire_compliance).pack(side="left", padx=5)
    
    tk.Button(btn_container, text="ü§ñ AI ile S√∂zle≈üme Olu≈ütur", font=("Segoe UI", 10, "bold"),
             bg="#9b59b6", fg="white", relief="raised", bd=2, cursor="hand2",
             padx=15, pady=8, command=generate_contract).pack(side="left", padx=5)
    
    tk.Button(btn_container, text="üìß Tedarik√ßiye Email G√∂nder", font=("Segoe UI", 10, "bold"),
             bg="#e67e22", fg="white", relief="raised", bd=2, cursor="hand2",
             padx=15, pady=8, command=send_email).pack(side="left", padx=5)
    
    # üìã CARƒ∞ Bƒ∞LGƒ∞LER Y√ñNETƒ∞Mƒ∞ VE MAƒ∞L PANELƒ∞
    cari_panel = tk.LabelFrame(content, text="üìã Cari Bilgiler Kayƒ±t ve Mail Paneli", 
                               font=("Segoe UI", 13, "bold"), bg="white", fg="#16a085",
                               padx=15, pady=15, relief="solid", bd=2)
    cari_panel.pack(fill="both", expand=True, pady=(15, 15))
    
    # √úst kƒ±sƒ±m: Form ve Liste (2 s√ºtun)
    top_section = tk.Frame(cari_panel, bg="white")
    top_section.pack(fill="both", expand=True, pady=5)
    top_section.grid_columnconfigure(0, weight=1)
    top_section.grid_columnconfigure(1, weight=2)
    
    # Sol: Cari Bilgi Giri≈ü Formu
    form_section = tk.LabelFrame(top_section, text="‚ûï Yeni Cari Bilgisi Ekle", 
                                 font=("Segoe UI", 11, "bold"), bg="white", fg="#2980b9",
                                 padx=10, pady=10, relief="solid", bd=1)
    form_section.grid(row=0, column=0, padx=5, pady=5, sticky="nsew")
    
    # Form alanlarƒ±
    form_frame = tk.Frame(form_section, bg="white")
    form_frame.pack(fill="both", expand=True)
    
    # Tedarik√ßi Adƒ±
    tk.Label(form_frame, text="Tedarik√ßi Adƒ±:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=0, column=0, sticky="w", padx=5, pady=3)
    tedarikci_adi_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    tedarikci_adi_entry.grid(row=0, column=1, padx=5, pady=3, sticky="ew")
    
    # Yetkili Ki≈üi
    tk.Label(form_frame, text="Yetkili Ki≈üi:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=1, column=0, sticky="w", padx=5, pady=3)
    yetkili_kisi_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    yetkili_kisi_entry.grid(row=1, column=1, padx=5, pady=3, sticky="ew")
    
    # Telefon
    tk.Label(form_frame, text="Telefon:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=2, column=0, sticky="w", padx=5, pady=3)
    telefon_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    telefon_entry.grid(row=2, column=1, padx=5, pady=3, sticky="ew")
    
    # Mail
    tk.Label(form_frame, text="Mail:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=3, column=0, sticky="w", padx=5, pady=3)
    mail_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    mail_entry.grid(row=3, column=1, padx=5, pady=3, sticky="ew")
    
    # Adres
    tk.Label(form_frame, text="Adres:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=4, column=0, sticky="nw", padx=5, pady=3)
    adres_text = tk.Text(form_frame, font=("Segoe UI", 9), width=25, height=3)
    adres_text.grid(row=4, column=1, padx=5, pady=3, sticky="ew")
    
    # Alƒ±m T√ºr√º
    tk.Label(form_frame, text="Alƒ±m T√ºr√º:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=5, column=0, sticky="w", padx=5, pady=3)
    alim_turu_var = tk.StringVar(value="Kuma≈ü")
    alim_turu_combo = ttk.Combobox(form_frame, textvariable=alim_turu_var, 
                                   values=["Kuma≈ü", "Fire", "Tekleme", "Aksesuar", "Diƒüer"],
                                   state="readonly", font=("Segoe UI", 9), width=23)
    alim_turu_combo.grid(row=5, column=1, padx=5, pady=3, sticky="ew")
    
    # Eksik Evraklar (Checkbox'lar)
    tk.Label(form_frame, text="Eksik Evraklar:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=6, column=0, sticky="nw", padx=5, pady=3)
    
    eksik_evrak_frame = tk.Frame(form_frame, bg="white")
    eksik_evrak_frame.grid(row=6, column=1, padx=5, pady=3, sticky="w")
    
    evrak_checkboxes = {}
    evrak_tipleri = ["S√∂zle≈üme", "Sertifika", "Vergi Levhasƒ±", "ƒ∞mza Sirk√ºleri", "Fatura Bilgileri"]
    for i, evrak in enumerate(evrak_tipleri):
        var = tk.BooleanVar()
        evrak_checkboxes[evrak] = var
        tk.Checkbutton(eksik_evrak_frame, text=evrak, variable=var, 
                      font=("Segoe UI", 8), bg="white").grid(row=i, column=0, sticky="w")
    
    # S√∂zle≈üme Biti≈ü Tarihi
    tk.Label(form_frame, text="S√∂zle≈üme Biti≈ü:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=7, column=0, sticky="w", padx=5, pady=3)
    sozlesme_date_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    sozlesme_date_entry.grid(row=7, column=1, padx=5, pady=3, sticky="ew")
    sozlesme_date_entry.insert(0, "YYYY-MM-DD")
    sozlesme_date_entry.config(fg="gray")
    
    def sozlesme_date_focus_in(event):
        if sozlesme_date_entry.get() == "YYYY-MM-DD":
            sozlesme_date_entry.delete(0, tk.END)
            sozlesme_date_entry.config(fg="black")
    
    def sozlesme_date_focus_out(event):
        if not sozlesme_date_entry.get():
            sozlesme_date_entry.insert(0, "YYYY-MM-DD")
            sozlesme_date_entry.config(fg="gray")
    
    sozlesme_date_entry.bind("<FocusIn>", sozlesme_date_focus_in)
    sozlesme_date_entry.bind("<FocusOut>", sozlesme_date_focus_out)
    
    # Sertifika Biti≈ü Tarihi
    tk.Label(form_frame, text="Sertifika Biti≈ü:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=8, column=0, sticky="w", padx=5, pady=3)
    sertifika_date_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    sertifika_date_entry.grid(row=8, column=1, padx=5, pady=3, sticky="ew")
    sertifika_date_entry.insert(0, "YYYY-MM-DD")
    sertifika_date_entry.config(fg="gray")
    
    def sertifika_date_focus_in(event):
        if sertifika_date_entry.get() == "YYYY-MM-DD":
            sertifika_date_entry.delete(0, tk.END)
            sertifika_date_entry.config(fg="black")
    
    def sertifika_date_focus_out(event):
        if not sertifika_date_entry.get():
            sertifika_date_entry.insert(0, "YYYY-MM-DD")
            sertifika_date_entry.config(fg="gray")
    
    sertifika_date_entry.bind("<FocusIn>", sertifika_date_focus_in)
    sertifika_date_entry.bind("<FocusOut>", sertifika_date_focus_out)
    
    form_frame.grid_columnconfigure(1, weight=1)
    
    # Form butonlarƒ±
    form_btn_frame = tk.Frame(form_section, bg="white")
    form_btn_frame.pack(fill="x", pady=(10, 0))
    
    def clear_cari_form():
        """Formu temizle"""
        tedarikci_adi_entry.delete(0, tk.END)
        yetkili_kisi_entry.delete(0, tk.END)
        telefon_entry.delete(0, tk.END)
        mail_entry.delete(0, tk.END)
        adres_text.delete("1.0", tk.END)
        alim_turu_var.set("Kuma≈ü")
        for var in evrak_checkboxes.values():
            var.set(False)
        sozlesme_date_entry.delete(0, tk.END)
        sozlesme_date_entry.insert(0, "YYYY-MM-DD")
        sozlesme_date_entry.config(fg="gray")
        sertifika_date_entry.delete(0, tk.END)
        sertifika_date_entry.insert(0, "YYYY-MM-DD")
        sertifika_date_entry.config(fg="gray")
    
    def save_cari_form():
        """Formu kaydet"""
        # Verileri topla
        tedarikci = tedarikci_adi_entry.get().strip()
        yetkili = yetkili_kisi_entry.get().strip()
        telefon = telefon_entry.get().strip()
        mail = mail_entry.get().strip()
        adres = adres_text.get("1.0", tk.END).strip()
        alim_turu = alim_turu_var.get()
        
        # Tarih bilgilerini al
        sozlesme_bitis = sozlesme_date_entry.get().strip()
        if sozlesme_bitis == "YYYY-MM-DD" or not sozlesme_bitis:
            sozlesme_bitis = ""
        
        sertifika_bitis = sertifika_date_entry.get().strip()
        if sertifika_bitis == "YYYY-MM-DD" or not sertifika_bitis:
            sertifika_bitis = ""
        
        # Eksik evraklarƒ± topla
        eksik_evraklar = [evrak for evrak, var in evrak_checkboxes.items() if var.get()]
        eksik_evrak_str = ", ".join(eksik_evraklar) if eksik_evraklar else "Yok"
        
        # Zorunlu alanlarƒ± kontrol et
        if not tedarikci:
            messagebox.showwarning("Uyarƒ±", "Tedarik√ßi adƒ± zorunludur!")
            return
        
        if not mail:
            messagebox.showwarning("Uyarƒ±", "Mail adresi zorunludur!")
            return
        
        # Veriyi kaydet
        data = {
            'tedarikci_adi': tedarikci,
            'yetkili_kisi': yetkili,
            'telefon': telefon,
            'adres': adres,
            'alim_turu': alim_turu,
            'mail': mail,
            'eksik_evraklar': eksik_evrak_str,
            'sozlesme_bitis': sozlesme_bitis,
            'sertifika_bitis': sertifika_bitis
        }
        
        success, message = save_cari_bilgi(data)
        
        if success:
            messagebox.showinfo("Ba≈üarƒ±lƒ±", message)
            clear_cari_form()
            refresh_cari_list()
            activity_logger.log_event("CARI_BILGI_SAVED", f"Tedarik√ßi: {tedarikci}", "Tedarik√ßi Uyumluluk")
        else:
            messagebox.showerror("Hata", message)
    
    tk.Button(form_btn_frame, text="üíæ Kaydet", font=("Segoe UI", 9, "bold"),
             bg="#27ae60", fg="white", cursor="hand2", padx=10, pady=5,
             command=save_cari_form).pack(side="left", padx=5)
    
    tk.Button(form_btn_frame, text="üîÑ Temizle", font=("Segoe UI", 9, "bold"),
             bg="#95a5a6", fg="white", cursor="hand2", padx=10, pady=5,
             command=clear_cari_form).pack(side="left", padx=5)
    
    def read_from_pdf():
        """PDF'den AI ile bilgileri oku ve formu doldur"""
        # PDF se√ß
        pdf_path = filedialog.askopenfilename(
            title="S√∂zle≈üme veya Sertifika PDF'i Se√ßin",
            filetypes=[("PDF Dosyalarƒ±", "*.pdf"), ("T√ºm Dosyalar", "*.*")],
            initialdir=MASTER_SOZLESME_PATH if os.path.exists(MASTER_SOZLESME_PATH) else None
        )
        
        if not pdf_path:
            return
        
        # ƒ∞≈ülem g√∂stergesi
        progress_window = tk.Toplevel()
        progress_window.title("AI ƒ∞≈üleniyor")
        progress_window.geometry("400x150")
        progress_window.transient(frame_compliance)
        progress_window.grab_set()
        
        tk.Label(progress_window, text="ü§ñ Yapay Zeka PDF'i Analiz Ediyor...", 
                font=("Segoe UI", 12, "bold")).pack(pady=20)
        tk.Label(progress_window, text="L√ºtfen bekleyin...", 
                font=("Segoe UI", 10)).pack(pady=10)
        
        progress_label = tk.Label(progress_window, text="PDF okunuyor...", 
                                 font=("Segoe UI", 9))
        progress_label.pack(pady=10)
        
        progress_window.update()
        
        def process_pdf():
            try:
                progress_label.config(text="AI ile analiz ediliyor...")
                progress_window.update()
                
                # AI ile analiz
                result = extract_supplier_info_from_pdf(pdf_path)
                
                progress_window.destroy()
                
                if "error" in result:
                    messagebox.showerror("Hata", f"PDF analizi ba≈üarƒ±sƒ±z:\n{result['error']}")
                    return
                
                if result.get("success") and "data" in result:
                    data = result["data"]
                    
                    # Formu doldur
                    if data.get("tedarikci_adi"):
                        tedarikci_adi_entry.delete(0, tk.END)
                        tedarikci_adi_entry.insert(0, data["tedarikci_adi"])
                    
                    if data.get("yetkili_kisi"):
                        yetkili_kisi_entry.delete(0, tk.END)
                        yetkili_kisi_entry.insert(0, data["yetkili_kisi"])
                    
                    if data.get("telefon"):
                        telefon_entry.delete(0, tk.END)
                        telefon_entry.insert(0, data["telefon"])
                    
                    if data.get("mail"):
                        mail_entry.delete(0, tk.END)
                        mail_entry.insert(0, data["mail"])
                    
                    if data.get("adres"):
                        adres_text.delete("1.0", tk.END)
                        adres_text.insert("1.0", data["adres"])
                    
                    if data.get("alim_turu") and data["alim_turu"] in ["Kuma≈ü", "Fire", "Tekleme", "Aksesuar", "Diƒüer"]:
                        alim_turu_var.set(data["alim_turu"])
                    
                    if data.get("sozlesme_bitis") and data["sozlesme_bitis"] != "null":
                        sozlesme_date_entry.delete(0, tk.END)
                        sozlesme_date_entry.insert(0, data["sozlesme_bitis"])
                        sozlesme_date_entry.config(fg="black")
                    
                    if data.get("sertifika_bitis") and data["sertifika_bitis"] != "null":
                        sertifika_date_entry.delete(0, tk.END)
                        sertifika_date_entry.insert(0, data["sertifika_bitis"])
                        sertifika_date_entry.config(fg="black")
                    
                    messagebox.showinfo("Ba≈üarƒ±lƒ±", 
                                      f"‚úÖ PDF'den bilgiler √ßƒ±karƒ±ldƒ±!\n\n"
                                      f"Belge T√ºr√º: {data.get('belge_turu', 'Bilinmiyor')}\n"
                                      f"Tedarik√ßi: {data.get('tedarikci_adi', '-')}\n\n"
                                      f"L√ºtfen bilgileri kontrol edin ve 'Kaydet' butonuna tƒ±klayƒ±n.")
                else:
                    messagebox.showwarning("Uyarƒ±", 
                                         "PDF analiz edildi ancak yapƒ±landƒ±rƒ±lmƒ±≈ü veri √ßƒ±karƒ±lamadƒ±.\n\n"
                                         f"Ham Yanƒ±t:\n{result.get('raw_text', 'Veri yok')[:500]}")
            
            except Exception as e:
                progress_window.destroy()
                messagebox.showerror("Hata", f"Beklenmeyen hata:\n{str(e)}")
                import traceback
                traceback.print_exc()
        
        # Thread'de √ßalƒ±≈ütƒ±r (UI donmasƒ±nƒ± √∂nlemek i√ßin)
        threading.Thread(target=process_pdf, daemon=True).start()
    
    tk.Button(form_btn_frame, text="ü§ñ PDF'den Oku", font=("Segoe UI", 9, "bold"),
             bg="#9b59b6", fg="white", cursor="hand2", padx=10, pady=5,
             command=read_from_pdf).pack(side="left", padx=5)
    
    def add_test_data():
        """Test i√ßin √∂rnek veri ekle"""
        result = messagebox.askyesno("Test Verisi Ekle", 
                                     "5 adet √∂rnek tedarik√ßi kaydƒ± eklenecek.\n\n"
                                     "Bu test verileri alarm sistemini test etmek i√ßindir.\n"
                                     "Devam etmek istiyor musunuz?")
        if result:
            success, message = generate_sample_cari_data()
            if success:
                messagebox.showinfo("Ba≈üarƒ±lƒ±", f"‚úÖ {message}\n\nAlarm sistemi artƒ±k √ßalƒ±≈ümalƒ±.")
                refresh_cari_list()
                # Alarm display'i g√ºncelle
                if 'update_all_displays' in dir():
                    update_all_displays()
            else:
                messagebox.showerror("Hata", f"Test verisi eklenemedi:\n{message}")
    
    tk.Button(form_btn_frame, text="üß™ Test Verisi Ekle", font=("Segoe UI", 9, "bold"),
             bg="#3498db", fg="white", cursor="hand2", padx=10, pady=5,
             command=add_test_data).pack(side="left", padx=5)
    
    # Saƒü: Cari Bilgileri Listesi
    list_section = tk.LabelFrame(top_section, text="üìã Kayƒ±tlƒ± Cari Bilgileri", 
                                 font=("Segoe UI", 11, "bold"), bg="white", fg="#c0392b",
                                 padx=10, pady=10, relief="solid", bd=1)
    list_section.grid(row=0, column=1, padx=5, pady=5, sticky="nsew")
    
    # Arama ve filtre √ßubuƒüu
    search_frame = tk.Frame(list_section, bg="white")
    search_frame.pack(fill="x", pady=(0, 5))
    
    tk.Label(search_frame, text="üîç Ara:", font=("Segoe UI", 9, "bold"),
             bg="white").pack(side="left", padx=5)
    search_var = tk.StringVar()
    search_entry = tk.Entry(search_frame, textvariable=search_var, font=("Segoe UI", 9), width=20)
    search_entry.pack(side="left", padx=5)
    
    tk.Label(search_frame, text="Alƒ±m T√ºr√º:", font=("Segoe UI", 9, "bold"),
             bg="white").pack(side="left", padx=(10, 5))
    filter_var = tk.StringVar(value="T√ºm√º")
    filter_combo = ttk.Combobox(search_frame, textvariable=filter_var,
                                values=["T√ºm√º", "Kuma≈ü", "Fire", "Tekleme", "Aksesuar", "Diƒüer"],
                                state="readonly", font=("Segoe UI", 9), width=12)
    filter_combo.pack(side="left", padx=5)
    
    def apply_filter():
        refresh_cari_list()
    
    tk.Button(search_frame, text="Ara", font=("Segoe UI", 8, "bold"),
             bg="#3498db", fg="white", cursor="hand2", padx=8, pady=2,
             command=apply_filter).pack(side="left", padx=5)
    
    tk.Button(search_frame, text="üîÑ", font=("Segoe UI", 8, "bold"),
             bg="#95a5a6", fg="white", cursor="hand2", padx=6, pady=2,
             command=lambda: (search_var.set(""), filter_var.set("T√ºm√º"), refresh_cari_list())).pack(side="left", padx=2)
    
    # Treeview i√ßin container
    tree_container = tk.Frame(list_section, bg="white")
    tree_container.pack(fill="both", expand=True)
    
    # Scrollbar'lar
    tree_scroll_y = ttk.Scrollbar(tree_container, orient="vertical")
    tree_scroll_y.pack(side="right", fill="y")
    
    tree_scroll_x = ttk.Scrollbar(tree_container, orient="horizontal")
    tree_scroll_x.pack(side="bottom", fill="x")
    
    # Treeview
    columns = ("Tedarik√ßi", "Yetkili", "Telefon", "Mail", "Alƒ±m T√ºr√º", "Eksik Evraklar", "Tarih")
    cari_tree = ttk.Treeview(tree_container, columns=columns, show="tree headings", 
                            yscrollcommand=tree_scroll_y.set, xscrollcommand=tree_scroll_x.set,
                            selectmode="extended",  # Multi-select desteƒüi
                            height=10)
    cari_tree.pack(fill="both", expand=True)
    
    tree_scroll_y.config(command=cari_tree.yview)
    tree_scroll_x.config(command=cari_tree.xview)
    
    # Checkbox durumlarƒ± i√ßin dictionary
    checkbox_states = {}
    
    # Treeview'e tƒ±klama eventi ekle (checkbox toggle i√ßin)
    def toggle_checkbox(event):
        """Checkbox'ƒ± tƒ±klandƒ±ƒüƒ±nda deƒüi≈ütir"""
        region = cari_tree.identify("region", event.x, event.y)
        if region == "tree":
            item = cari_tree.identify_row(event.y)
            if item:
                # Checkbox durumunu deƒüi≈ütir
                current_text = cari_tree.item(item, "text")
                if current_text == "‚òê":
                    cari_tree.item(item, text="‚òë")
                    checkbox_states[item] = True
                else:
                    cari_tree.item(item, text="‚òê")
                    checkbox_states[item] = False
    
    cari_tree.bind("<Button-1>", toggle_checkbox)
    
    # S√ºtun ayarlarƒ±
    cari_tree.column("#0", width=40, minwidth=40)
    cari_tree.column("Tedarik√ßi", width=150, minwidth=100)
    cari_tree.column("Yetkili", width=120, minwidth=100)
    cari_tree.column("Telefon", width=100, minwidth=80)
    cari_tree.column("Mail", width=150, minwidth=100)
    cari_tree.column("Alƒ±m T√ºr√º", width=100, minwidth=80)
    cari_tree.column("Eksik Evraklar", width=200, minwidth=150)
    cari_tree.column("Tarih", width=130, minwidth=100)
    
    # Ba≈ülƒ±klar
    cari_tree.heading("#0", text="‚òë")
    cari_tree.heading("Tedarik√ßi", text="Tedarik√ßi Adƒ±")
    cari_tree.heading("Yetkili", text="Yetkili Ki≈üi")
    cari_tree.heading("Telefon", text="Telefon")
    cari_tree.heading("Mail", text="Mail")
    cari_tree.heading("Alƒ±m T√ºr√º", text="Alƒ±m T√ºr√º")
    cari_tree.heading("Eksik Evraklar", text="Eksik Evraklar")
    cari_tree.heading("Tarih", text="Kayƒ±t Tarihi")
    
    def refresh_cari_list():
        """Cari listesini yenile"""
        # Mevcut kayƒ±tlarƒ± temizle
        for item in cari_tree.get_children():
            cari_tree.delete(item)
        
        # Checkbox durumlarƒ±nƒ± temizle
        checkbox_states.clear()
        
        # Verileri y√ºkle
        records = load_cari_bilgiler()
        
        # Filtreleri uygula
        search_text = search_var.get().strip().lower()
        filter_alim = filter_var.get()
        
        for idx, record in enumerate(records):
            # Arama filtresi
            if search_text:
                tedarikci = str(record.get('Tedarik√ßi Adƒ±', '')).lower()
                yetkili = str(record.get('Yetkili Ki≈üi', '')).lower()
                if search_text not in tedarikci and search_text not in yetkili:
                    continue
            
            # Alƒ±m t√ºr√º filtresi
            if filter_alim != "T√ºm√º":
                if str(record.get('Alƒ±m T√ºr√º', '')) != filter_alim:
                    continue
            
            # Kayƒ±t ekle
            values = (
                str(record.get('Tedarik√ßi Adƒ±', '')),
                str(record.get('Yetkili Ki≈üi', '')),
                str(record.get('Telefon', '')),
                str(record.get('Mail', '')),
                str(record.get('Alƒ±m T√ºr√º', '')),
                str(record.get('Eksik Evraklar', '')),
                str(record.get('Kayƒ±t Tarihi', ''))
            )
            item_id = cari_tree.insert("", "end", text="‚òê", values=values, tags=(idx,))
            checkbox_states[item_id] = False
    
    # ƒ∞lk y√ºkleme
    refresh_cari_list()
    
    # Orta kƒ±sƒ±m: S√∂zle≈üme ve Sertifika Alarm Paneli
    alarm_panel_section = tk.LabelFrame(cari_panel, text="‚è∞ S√∂zle≈üme ve Sertifika Alarm Sistemi", 
                                       font=("Segoe UI", 11, "bold"), bg="white", fg="#8e44ad",
                                       padx=10, pady=10, relief="solid", bd=1)
    alarm_panel_section.pack(fill="both", expand=False, pady=(5, 0))
    
    alarm_frame = tk.Frame(alarm_panel_section, bg="white")
    alarm_frame.pack(fill="both", expand=True)
    
    def check_expiration_status():
        """S√∂zle≈üme ve sertifikalarƒ±n s√ºre durumunu kontrol et"""
        from datetime import datetime, timedelta
        
        records = load_cari_bilgiler()
        today = datetime.now().date()
        
        # Debug logging
        print(f"\n[ALARM DEBUG] Toplam kayƒ±t sayƒ±sƒ±: {len(records)}")
        
        results = {
            'sozlesme_expired': [],
            'sozlesme_expiring': [],
            'sozlesme_valid': [],
            'sertifika_expired': [],
            'sertifika_expiring': [],
            'sertifika_valid': []
        }
        
        sozlesme_checked = 0
        sertifika_checked = 0
        sozlesme_parse_errors = 0
        sertifika_parse_errors = 0
        
        for idx, record in enumerate(records):
            tedarikci = record.get('Tedarik√ßi Adƒ±', '')
            mail = record.get('Mail', '')
            
            # Debug: Show first record details
            if idx == 0:
                print(f"[ALARM DEBUG] ƒ∞lk kayƒ±t s√ºtunlarƒ±: {list(record.keys())}")
                print(f"[ALARM DEBUG] ƒ∞lk kayƒ±t - Tedarik√ßi: {tedarikci}")
            
            # S√∂zle≈üme kontrol√º
            sozlesme_str = str(record.get('S√∂zle≈üme Biti≈ü Tarihi', '')).strip()
            if idx == 0:
                print(f"[ALARM DEBUG] ƒ∞lk kayƒ±t - S√∂zle≈üme deƒüeri: '{sozlesme_str}'")
            
            if sozlesme_str and sozlesme_str != '' and sozlesme_str != 'nan':
                sozlesme_checked += 1
                try:
                    sozlesme_date = datetime.strptime(sozlesme_str[:10], '%Y-%m-%d').date()
                    days_diff = (sozlesme_date - today).days
                    
                    if days_diff < 0:
                        results['sozlesme_expired'].append({
                            'tedarikci': tedarikci,
                            'mail': mail,
                            'date': sozlesme_str,
                            'days': abs(days_diff)
                        })
                    elif days_diff <= 15:
                        results['sozlesme_expiring'].append({
                            'tedarikci': tedarikci,
                            'mail': mail,
                            'date': sozlesme_str,
                            'days': days_diff
                        })
                    else:
                        results['sozlesme_valid'].append({
                            'tedarikci': tedarikci,
                            'date': sozlesme_str,
                            'days': days_diff
                        })
                except Exception as e:
                    sozlesme_parse_errors += 1
                    if sozlesme_parse_errors <= 3:  # Log first 3 errors
                        print(f"[ALARM DEBUG] S√∂zle≈üme parse hatasƒ± ({tedarikci}): {sozlesme_str} - {e}")
            
            # Sertifika kontrol√º
            sertifika_str = str(record.get('Sertifika Biti≈ü Tarihi', '')).strip()
            if idx == 0:
                print(f"[ALARM DEBUG] ƒ∞lk kayƒ±t - Sertifika deƒüeri: '{sertifika_str}'")
            
            if sertifika_str and sertifika_str != '' and sertifika_str != 'nan':
                sertifika_checked += 1
                try:
                    sertifika_date = datetime.strptime(sertifika_str[:10], '%Y-%m-%d').date()
                    days_diff = (sertifika_date - today).days
                    
                    if days_diff < 0:
                        results['sertifika_expired'].append({
                            'tedarikci': tedarikci,
                            'mail': mail,
                            'date': sertifika_str,
                            'days': abs(days_diff)
                        })
                    elif days_diff <= 15:
                        results['sertifika_expiring'].append({
                            'tedarikci': tedarikci,
                            'mail': mail,
                            'date': sertifika_str,
                            'days': days_diff
                        })
                    else:
                        results['sertifika_valid'].append({
                            'tedarikci': tedarikci,
                            'date': sertifika_str,
                            'days': days_diff
                        })
                except Exception as e:
                    sertifika_parse_errors += 1
                    if sertifika_parse_errors <= 3:  # Log first 3 errors
                        print(f"[ALARM DEBUG] Sertifika parse hatasƒ± ({tedarikci}): {sertifika_str} - {e}")
        
        # Summary logging
        print(f"[ALARM DEBUG] ƒ∞≈ülenen s√∂zle≈üme sayƒ±sƒ±: {sozlesme_checked}")
        print(f"[ALARM DEBUG] ƒ∞≈ülenen sertifika sayƒ±sƒ±: {sertifika_checked}")
        print(f"[ALARM DEBUG] S√∂zle≈üme parse hatalarƒ±: {sozlesme_parse_errors}")
        print(f"[ALARM DEBUG] Sertifika parse hatalarƒ±: {sertifika_parse_errors}")
        print(f"[ALARM DEBUG] Sonu√ß - S√∂zle≈üme s√ºresi dolmu≈ü: {len(results['sozlesme_expired'])}")
        print(f"[ALARM DEBUG] Sonu√ß - S√∂zle≈üme yakƒ±nda dolacak: {len(results['sozlesme_expiring'])}")
        print(f"[ALARM DEBUG] Sonu√ß - S√∂zle≈üme ge√ßerli: {len(results['sozlesme_valid'])}")
        print(f"[ALARM DEBUG] Sonu√ß - Sertifika s√ºresi dolmu≈ü: {len(results['sertifika_expired'])}")
        print(f"[ALARM DEBUG] Sonu√ß - Sertifika yakƒ±nda dolacak: {len(results['sertifika_expiring'])}")
        print(f"[ALARM DEBUG] Sonu√ß - Sertifika ge√ßerli: {len(results['sertifika_valid'])}\n")
        
        return results
    
    # Alarm g√∂sterge frame'leri
    indicators_frame = tk.Frame(alarm_frame, bg="white")
    indicators_frame.pack(fill="x", pady=5)
    
    # S√∂zle≈üme g√∂stergeleri
    sozlesme_frame = tk.LabelFrame(indicators_frame, text="üìÑ S√∂zle≈üme Durumu", 
                                   font=("Segoe UI", 10, "bold"), bg="white", fg="#2c3e50",
                                   relief="solid", bd=1, padx=10, pady=5)
    sozlesme_frame.pack(side="left", fill="both", expand=True, padx=5)
    
    sozlesme_expired_label = tk.Label(sozlesme_frame, text="üî¥ S√ºresi Dolmu≈ü: 0", 
                                     font=("Segoe UI", 9), bg="white", fg="#e74c3c")
    sozlesme_expired_label.pack(anchor="w", pady=2)
    
    sozlesme_expiring_label = tk.Label(sozlesme_frame, text="üü° Yakƒ±nda Dolacak: 0", 
                                      font=("Segoe UI", 9), bg="white", fg="#f39c12")
    sozlesme_expiring_label.pack(anchor="w", pady=2)
    
    sozlesme_valid_label = tk.Label(sozlesme_frame, text="üü¢ Ge√ßerli: 0", 
                                    font=("Segoe UI", 9), bg="white", fg="#27ae60")
    sozlesme_valid_label.pack(anchor="w", pady=2)
    
    # Sertifika g√∂stergeleri
    sertifika_frame = tk.LabelFrame(indicators_frame, text="üèÖ Sertifika Durumu", 
                                    font=("Segoe UI", 10, "bold"), bg="white", fg="#2c3e50",
                                    relief="solid", bd=1, padx=10, pady=5)
    sertifika_frame.pack(side="left", fill="both", expand=True, padx=5)
    
    sertifika_expired_label = tk.Label(sertifika_frame, text="üî¥ S√ºresi Dolmu≈ü: 0", 
                                      font=("Segoe UI", 9), bg="white", fg="#e74c3c")
    sertifika_expired_label.pack(anchor="w", pady=2)
    
    sertifika_expiring_label = tk.Label(sertifika_frame, text="üü° Yakƒ±nda Dolacak: 0", 
                                       font=("Segoe UI", 9), bg="white", fg="#f39c12")
    sertifika_expiring_label.pack(anchor="w", pady=2)
    
    sertifika_valid_label = tk.Label(sertifika_frame, text="üü¢ Ge√ßerli: 0", 
                                     font=("Segoe UI", 9), bg="white", fg="#27ae60")
    sertifika_valid_label.pack(anchor="w", pady=2)
    
    def update_alarm_display():
        """Alarm g√∂stergelerini g√ºncelle"""
        results = check_expiration_status()
        
        # S√∂zle≈üme sayƒ±larƒ±nƒ± g√ºncelle
        sozlesme_expired_label.config(text=f"üî¥ S√ºresi Dolmu≈ü: {len(results['sozlesme_expired'])}")
        sozlesme_expiring_label.config(text=f"üü° Yakƒ±nda Dolacak (‚â§15 g√ºn): {len(results['sozlesme_expiring'])}")
        sozlesme_valid_label.config(text=f"üü¢ Ge√ßerli: {len(results['sozlesme_valid'])}")
        
        # Sertifika sayƒ±larƒ±nƒ± g√ºncelle
        sertifika_expired_label.config(text=f"üî¥ S√ºresi Dolmu≈ü: {len(results['sertifika_expired'])}")
        sertifika_expiring_label.config(text=f"üü° Yakƒ±nda Dolacak (‚â§15 g√ºn): {len(results['sertifika_expiring'])}")
        sertifika_valid_label.config(text=f"üü¢ Ge√ßerli: {len(results['sertifika_valid'])}")
        
        # Eƒüer t√ºm sayƒ±lar 0 ise kullanƒ±cƒ±ya bilgi g√∂ster
        total_count = (len(results['sozlesme_expired']) + len(results['sozlesme_expiring']) + 
                      len(results['sozlesme_valid']) + len(results['sertifika_expired']) + 
                      len(results['sertifika_expiring']) + len(results['sertifika_valid']))
        
        if total_count == 0:
            print("\n" + "="*70)
            print("‚ö†Ô∏è  UYARI: Alarm sistemi veri bulamadƒ±!")
            print("="*70)
            print("T√ºm saya√ßlar 0 g√∂steriyor. Olasƒ± nedenler:")
            print("1. Excel dosyasƒ±nda veri yok (sadece ba≈ülƒ±klar var)")
            print("2. 'S√∂zle≈üme Biti≈ü Tarihi' ve 'Sertifika Biti≈ü Tarihi' s√ºtunlarƒ± bo≈ü")
            print("3. Tarih formatƒ± yanlƒ±≈ü (beklenen format: YYYY-MM-DD, √∂rn: 2026-02-15)")
            print("\nKonsol √ßƒ±ktƒ±sƒ±nda [ALARM DEBUG] mesajlarƒ±na bakƒ±n.")
            print("="*70 + "\n")
    
    def send_expiration_alerts():
        """S√ºresi dolmu≈ü ve dolmak √ºzere olanlara mail g√∂nder"""
        results = check_expiration_status()
        
        success_count = 0
        fail_count = 0
        
        # S√∂zle≈üme uyarƒ±larƒ±
        for item in results['sozlesme_expired']:
            mail = str(item['mail']).strip()
            if not mail or mail == '' or mail == 'nan':
                fail_count += 1
                continue
                
            subject = "üî¥ ACIL: S√∂zle≈üme S√ºresi Dolmu≈ü!"
            content = f"""Sayƒ±n {item['tedarikci']},

S√∂zle≈ümenizin s√ºresi {item['days']} g√ºn √∂nce dolmu≈ütur.

Biti≈ü Tarihi: {item['date']}

L√ºtfen en kƒ±sa s√ºrede s√∂zle≈üme yenileme i≈ülemlerini ba≈ülatƒ±nƒ±z.

Saygƒ±larƒ±mƒ±zla,
Tedarik√ßi Uyumluluk Merkezi"""
            
            if send_single_alert_email(mail, subject, content):
                success_count += 1
            else:
                fail_count += 1
        
        for item in results['sozlesme_expiring']:
            mail = str(item['mail']).strip()
            if not mail or mail == '' or mail == 'nan':
                fail_count += 1
                continue
                
            subject = "üü° Uyarƒ±: S√∂zle≈ümeniz Yakƒ±nda Dolacak"
            content = f"""Sayƒ±n {item['tedarikci']},

S√∂zle≈ümenizin s√ºresi {item['days']} g√ºn i√ßinde dolacaktƒ±r.

Biti≈ü Tarihi: {item['date']}

L√ºtfen s√∂zle≈üme yenileme i≈ülemlerini planlayƒ±nƒ±z.

Saygƒ±larƒ±mƒ±zla,
Tedarik√ßi Uyumluluk Merkezi"""
            
            if send_single_alert_email(mail, subject, content):
                success_count += 1
            else:
                fail_count += 1
        
        # Sertifika uyarƒ±larƒ±
        for item in results['sertifika_expired']:
            mail = str(item['mail']).strip()
            if not mail or mail == '' or mail == 'nan':
                fail_count += 1
                continue
                
            subject = "üî¥ ACIL: Sertifika S√ºresi Dolmu≈ü!"
            content = f"""Sayƒ±n {item['tedarikci']},

Sertifikanƒ±zƒ±n s√ºresi {item['days']} g√ºn √∂nce dolmu≈ütur.

Biti≈ü Tarihi: {item['date']}

L√ºtfen en kƒ±sa s√ºrede sertifika yenileme i≈ülemlerini ba≈ülatƒ±nƒ±z.

Saygƒ±larƒ±mƒ±zla,
Tedarik√ßi Uyumluluk Merkezi"""
            
            if send_single_alert_email(mail, subject, content):
                success_count += 1
            else:
                fail_count += 1
        
        for item in results['sertifika_expiring']:
            mail = str(item['mail']).strip()
            if not mail or mail == '' or mail == 'nan':
                fail_count += 1
                continue
                
            subject = "üü° Uyarƒ±: Sertifikanƒ±z Yakƒ±nda Dolacak"
            content = f"""Sayƒ±n {item['tedarikci']},

Sertifikanƒ±zƒ±n s√ºresi {item['days']} g√ºn i√ßinde dolacaktƒ±r.

Biti≈ü Tarihi: {item['date']}

L√ºtfen sertifika yenileme i≈ülemlerini planlayƒ±nƒ±z.

Saygƒ±larƒ±mƒ±zla,
Tedarik√ßi Uyumluluk Merkezi"""
            
            if send_single_alert_email(mail, subject, content):
                success_count += 1
            else:
                fail_count += 1
        
        messagebox.showinfo("Mail G√∂nderimi Tamamlandƒ±", 
                          f"Ba≈üarƒ±lƒ±: {success_count}\nBa≈üarƒ±sƒ±z: {fail_count}")
    
    def send_single_alert_email(to_email, subject, content):
        """Tek bir alarm maili g√∂nder"""
        try:
            msg = MIMEMultipart()
            msg['From'] = GMAIL_USER
            msg['To'] = to_email
            msg['Subject'] = subject
            
            html_content = f"""
            <html>
            <body style="font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333;">
                <div style="max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
                    <div style="background-color: #8e44ad; color: white; padding: 15px; border-radius: 5px 5px 0 0;">
                        <h2 style="margin: 0;">‚è∞ Tedarik√ßi Uyumluluk Alarm Sistemi</h2>
                    </div>
                    <div style="padding: 20px; background-color: #f9f9f9;">
                        <pre style="font-family: 'Segoe UI', Arial, sans-serif; white-space: pre-wrap; word-wrap: break-word;">{content}</pre>
                    </div>
                    <div style="text-align: center; padding: 10px; background-color: #ecf0f1; border-radius: 0 0 5px 5px; font-size: 12px; color: #7f8c8d;">
                        Bu email Tedarik√ßi Uyumluluk Sistemi tarafƒ±ndan otomatik olu≈üturulmu≈ütur.
                    </div>
                </div>
            </body>
            </html>
            """
            
            msg.attach(MIMEText(html_content, 'html'))
            
            server = smtplib.SMTP('smtp.gmail.com', 587)
            server.starttls()
            server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
            server.send_message(msg)
            server.quit()
            
            activity_logger.log_email_sent(to_email, subject, "Alarm Sistemi")
            return True
        except Exception as e:
            print(f"Mail g√∂nderme hatasƒ± ({to_email}): {e}")
            return False
    
    # Butonlar
    btn_frame = tk.Frame(alarm_frame, bg="white")
    btn_frame.pack(fill="x", pady=5)
    
    update_status_btn = tk.Button(btn_frame, text="üîÑ Durumu G√ºncelle", font=("Segoe UI", 9, "bold"),
             bg="#3498db", fg="white", cursor="hand2", padx=15, pady=5,
             command=update_alarm_display)
    update_status_btn.pack(side="left", padx=5)
    
    tk.Button(btn_frame, text="üìß Alarm Maillerini G√∂nder", font=("Segoe UI", 9, "bold"),
             bg="#e74c3c", fg="white", cursor="hand2", padx=15, pady=5,
             command=send_expiration_alerts).pack(side="left", padx=5)
    
    # ƒ∞lk y√ºkleme
    update_alarm_display()
    
    # Yeni: Detaylƒ± S√∂zle≈üme ve Sertifika Takip Tablosu
    detail_table_section = tk.LabelFrame(cari_panel, text="üìä S√∂zle≈üme ve Sertifika Detaylƒ± Takip Tablosu", 
                                        font=("Segoe UI", 11, "bold"), bg="white", fg="#2980b9",
                                        padx=10, pady=10, relief="solid", bd=1)
    detail_table_section.pack(fill="both", expand=True, pady=(5, 0))
    
    detail_frame = tk.Frame(detail_table_section, bg="white")
    detail_frame.pack(fill="both", expand=True)
    
    # Buton √ßubuƒüu
    detail_btn_frame = tk.Frame(detail_frame, bg="white")
    detail_btn_frame.pack(fill="x", pady=(0, 5))
    
    # Treeview container
    detail_tree_container = tk.Frame(detail_frame, bg="white")
    detail_tree_container.pack(fill="both", expand=True)
    
    # Scrollbar'lar
    detail_scroll_y = ttk.Scrollbar(detail_tree_container, orient="vertical")
    detail_scroll_y.pack(side="right", fill="y")
    
    detail_scroll_x = ttk.Scrollbar(detail_tree_container, orient="horizontal")
    detail_scroll_x.pack(side="bottom", fill="x")
    
    # Treeview
    detail_columns = ("Tedarik√ßi", "T√ºr", "Biti≈ü Tarihi", "Kalan G√ºn", "Durum")
    detail_tree = ttk.Treeview(detail_tree_container, columns=detail_columns, show="headings", 
                              yscrollcommand=detail_scroll_y.set, xscrollcommand=detail_scroll_x.set,
                              height=12)
    detail_tree.pack(fill="both", expand=True)
    
    detail_scroll_y.config(command=detail_tree.yview)
    detail_scroll_x.config(command=detail_tree.xview)
    
    # S√ºtun ayarlarƒ±
    detail_tree.column("Tedarik√ßi", width=250, minwidth=150)
    detail_tree.column("T√ºr", width=120, minwidth=100)
    detail_tree.column("Biti≈ü Tarihi", width=120, minwidth=100)
    detail_tree.column("Kalan G√ºn", width=100, minwidth=80)
    detail_tree.column("Durum", width=150, minwidth=120)
    
    # Ba≈ülƒ±klar
    detail_tree.heading("Tedarik√ßi", text="Tedarik√ßi Adƒ±")
    detail_tree.heading("T√ºr", text="Belge T√ºr√º")
    detail_tree.heading("Biti≈ü Tarihi", text="Biti≈ü Tarihi")
    detail_tree.heading("Kalan G√ºn", text="Kalan G√ºn")
    detail_tree.heading("Durum", text="Durum")
    
    # Tag'leri tanƒ±mla (color coding i√ßin)
    detail_tree.tag_configure('expired', background='#ffcccc', foreground='#c0392b')  # A√ßƒ±k kƒ±rmƒ±zƒ±
    detail_tree.tag_configure('expiring', background='#fff3cd', foreground='#f39c12')  # A√ßƒ±k sarƒ±
    detail_tree.tag_configure('valid', background='#d4edda', foreground='#27ae60')  # A√ßƒ±k ye≈üil
    
    def get_status_and_tag(days_diff):
        """Helper function to determine status and tag based on days remaining"""
        if days_diff < 0:
            status = f"üî¥ S√ºresi Dolmu≈ü ({abs(days_diff)} g√ºn √∂nce)"
            tag = 'expired'
        elif days_diff <= 15:
            status = f"üü° Yakƒ±nda Dolacak"
            tag = 'expiring'
        else:
            status = f"üü¢ Ge√ßerli"
            tag = 'valid'
        return status, tag
    
    def refresh_detail_table():
        """Detaylƒ± tabloyu yenile"""
        # Mevcut kayƒ±tlarƒ± temizle
        for item in detail_tree.get_children():
            detail_tree.delete(item)
        
        records = load_cari_bilgiler()
        today = datetime.now().date()
        
        for record in records:
            tedarikci = record.get('Tedarik√ßi Adƒ±', '')
            alim_turu = record.get('Alƒ±m T√ºr√º', '')
            
            # S√∂zle≈üme bilgileri
            sozlesme_str = str(record.get('S√∂zle≈üme Biti≈ü Tarihi', '')).strip()
            if sozlesme_str and sozlesme_str != '' and sozlesme_str != 'nan':
                try:
                    sozlesme_date = datetime.strptime(sozlesme_str[:10], '%Y-%m-%d').date()
                    days_diff = (sozlesme_date - today).days
                    
                    # Durum ve renk belirleme
                    status, tag = get_status_and_tag(days_diff)
                    
                    values = (tedarikci, "S√∂zle≈üme", sozlesme_str[:10], days_diff, status)
                    detail_tree.insert("", "end", values=values, tags=(tag,))
                except (ValueError, IndexError) as e:
                    print(f"S√∂zle≈üme tarihi parse hatasƒ± ({tedarikci}): {e}")
            
            # Sertifika bilgileri
            sertifika_str = str(record.get('Sertifika Biti≈ü Tarihi', '')).strip()
            if sertifika_str and sertifika_str != '' and sertifika_str != 'nan':
                try:
                    sertifika_date = datetime.strptime(sertifika_str[:10], '%Y-%m-%d').date()
                    days_diff = (sertifika_date - today).days
                    
                    # Durum ve renk belirleme
                    status, tag = get_status_and_tag(days_diff)
                    
                    # Fire Sales tedarik√ßileri i√ßin sertifika √∂zellikle vurgulanƒ±r
                    is_fire_sales = alim_turu == 'Fire'
                    tur = "Sertifika (Fire Sales)" if is_fire_sales else "Sertifika"
                    values = (tedarikci, tur, sertifika_str[:10], days_diff, status)
                    detail_tree.insert("", "end", values=values, tags=(tag,))
                except (ValueError, IndexError) as e:
                    print(f"Sertifika tarihi parse hatasƒ± ({tedarikci}): {e}")
    
    # Yenile butonu
    refresh_btn = tk.Button(detail_btn_frame, text="üîÑ Tabloyu Yenile", font=("Segoe UI", 9, "bold"),
             bg="#3498db", fg="white", cursor="hand2", padx=15, pady=5,
             command=refresh_detail_table)
    refresh_btn.pack(side="left", padx=5)
    
    # A√ßƒ±klama etiketi
    legend_label = tk.Label(detail_btn_frame, 
                           text="Renk Kodlarƒ±: üî¥ Kƒ±rmƒ±zƒ± = S√ºresi Dolmu≈ü | üü° Sarƒ± = Yakƒ±nda Dolacak (‚â§15 g√ºn) | üü¢ Ye≈üil = Ge√ßerli (>15 g√ºn)", 
                           font=("Segoe UI", 8), bg="white", fg="#7f8c8d")
    legend_label.pack(side="left", padx=10)
    
    # ƒ∞lk y√ºkleme
    refresh_detail_table()
    
    # T√ºm g√∂stergeleri g√ºncelleyen birle≈üik fonksiyon
    def update_all_displays():
        """Hem alarm g√∂stergelerini hem de detay tablosunu g√ºncelle"""
        update_alarm_display()
        refresh_detail_table()
    
    # Alarm panelindeki g√ºncelleme butonunu yeniden yapƒ±landƒ±r (stored reference kullanarak)
    update_status_btn.config(command=update_all_displays)
    
    # Alt kƒ±sƒ±m: Mail G√∂nderim Paneli
    mail_panel_section = tk.LabelFrame(cari_panel, text="üìß Mail G√∂nderim Paneli", 
                                      font=("Segoe UI", 11, "bold"), bg="white", fg="#d35400",
                                      padx=10, pady=10, relief="solid", bd=1)
    mail_panel_section.pack(fill="both", expand=True, pady=(5, 0))
    
    mail_frame = tk.Frame(mail_panel_section, bg="white")
    mail_frame.pack(fill="both", expand=True)
    
    # Mail ≈üablonu se√ßimi
    tk.Label(mail_frame, text="Mail ≈ûablonu:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=0, column=0, sticky="w", padx=5, pady=5)
    
    mail_template_var = tk.StringVar(value="Evrak Eksikliƒüi Bildirimi")
    mail_templates = [
        "Evrak Eksikliƒüi Bildirimi",
        "S√∂zle≈üme Yenileme Hatƒ±rlatmasƒ±",
        "Sertifika G√ºncellemesi",
        "Genel Bilgilendirme"
    ]
    mail_template_combo = ttk.Combobox(mail_frame, textvariable=mail_template_var,
                                       values=mail_templates, state="readonly",
                                       font=("Segoe UI", 9), width=30)
    mail_template_combo.grid(row=0, column=1, padx=5, pady=5, sticky="ew")
    
    # Mail konusu
    tk.Label(mail_frame, text="Konu:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=1, column=0, sticky="w", padx=5, pady=5)
    mail_subject_entry = tk.Entry(mail_frame, font=("Segoe UI", 9), width=50)
    mail_subject_entry.grid(row=1, column=1, padx=5, pady=5, sticky="ew")
    mail_subject_entry.insert(0, "Tedarik√ßi Evrak Eksikliƒüi Bildirimi")
    
    # Mail i√ßeriƒüi
    tk.Label(mail_frame, text="ƒ∞√ßerik:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=2, column=0, sticky="nw", padx=5, pady=5)
    
    mail_content_frame = tk.Frame(mail_frame, bg="white")
    mail_content_frame.grid(row=2, column=1, padx=5, pady=5, sticky="ew")
    
    mail_content_scroll = tk.Scrollbar(mail_content_frame, orient="vertical")
    mail_content_scroll.pack(side="right", fill="y")
    
    mail_content_text = tk.Text(mail_content_frame, font=("Segoe UI", 9), 
                               height=8, width=60, wrap="word",
                               yscrollcommand=mail_content_scroll.set)
    mail_content_text.pack(fill="both", expand=True)
    mail_content_scroll.config(command=mail_content_text.yview)
    
    # Varsayƒ±lan mail i√ßeriƒüi
    default_mail_content = """Sayƒ±n {{Yetkili Ki≈üi}},

{{Tedarik√ßi Adƒ±}} firmasƒ± i√ßin bazƒ± evraklarƒ±n eksik olduƒüunu tespit ettik.

Eksik Evraklar:
{{Eksik Evraklar}}

L√ºtfen eksik evraklarƒ± en kƒ±sa s√ºrede tamamlayarak bize iletmenizi rica ederiz.

Saygƒ±larƒ±mƒ±zla,
Tedarik√ßi Uyumluluk Merkezi"""
    
    mail_content_text.insert("1.0", default_mail_content)
    
    mail_frame.grid_columnconfigure(1, weight=1)
    
    def update_mail_template():
        """Mail ≈üablonunu g√ºncelle"""
        template = mail_template_var.get()
        
        templates_content = {
            "Evrak Eksikliƒüi Bildirimi": {
                "subject": "Tedarik√ßi Evrak Eksikliƒüi Bildirimi",
                "content": default_mail_content
            },
            "S√∂zle≈üme Yenileme Hatƒ±rlatmasƒ±": {
                "subject": "S√∂zle≈üme Yenileme Hatƒ±rlatmasƒ±",
                "content": """Sayƒ±n {{Yetkili Ki≈üi}},

{{Tedarik√ßi Adƒ±}} firmasƒ± ile yapƒ±lan s√∂zle≈ümenin yenileme zamanƒ± yakla≈ümaktadƒ±r.

L√ºtfen s√∂zle≈üme yenileme i≈ülemleri i√ßin bizimle ileti≈üime ge√ßiniz.

Saygƒ±larƒ±mƒ±zla,
Tedarik√ßi Uyumluluk Merkezi"""
            },
            "Sertifika G√ºncellemesi": {
                "subject": "Sertifika G√ºncelleme Talebi",
                "content": """Sayƒ±n {{Yetkili Ki≈üi}},

{{Tedarik√ßi Adƒ±}} firmasƒ±nƒ±n sertifikalarƒ±nƒ±n g√ºncellenme zamanƒ± gelmi≈ütir.

L√ºtfen g√ºncel sertifikalarƒ±nƒ±zƒ± en kƒ±sa s√ºrede bize iletiniz.

Saygƒ±larƒ±mƒ±zla,
Tedarik√ßi Uyumluluk Merkezi"""
            },
            "Genel Bilgilendirme": {
                "subject": "Genel Bilgilendirme",
                "content": """Sayƒ±n {{Yetkili Ki≈üi}},

{{Tedarik√ßi Adƒ±}} firmasƒ± i√ßin genel bilgilendirme.

[Buraya mesajƒ±nƒ±zƒ± yazƒ±nƒ±z]

Saygƒ±larƒ±mƒ±zla,
Tedarik√ßi Uyumluluk Merkezi"""
            }
        }
        
        if template in templates_content:
            mail_subject_entry.delete(0, tk.END)
            mail_subject_entry.insert(0, templates_content[template]["subject"])
            
            mail_content_text.delete("1.0", tk.END)
            mail_content_text.insert("1.0", templates_content[template]["content"])
    
    mail_template_combo.bind("<<ComboboxSelected>>", lambda e: update_mail_template())
    
    # Mail butonlarƒ±
    mail_btn_frame = tk.Frame(mail_panel_section, bg="white")
    mail_btn_frame.pack(fill="x", pady=(10, 0))
    
    def send_single_email():
        """Se√ßili veya i≈üaretli tedarik√ßiye mail g√∂nder"""
        # √ñnce i≈üaretli (checkbox) √∂ƒüeleri kontrol et
        checked_items = [item for item, checked in checkbox_states.items() if checked]
        
        # Eƒüer checkbox i≈üaretli deƒüilse, se√ßili √∂ƒüeleri kullan
        if not checked_items:
            checked_items = cari_tree.selection()
        
        if not checked_items:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen mail g√∂ndermek i√ßin tedarik√ßileri i≈üaretleyin veya se√ßin!\n\n" +
                                 "ƒ∞pucu: Tedarik√ßi satƒ±rƒ±nƒ±n en solundaki kutucuƒüa tƒ±klayarak i≈üaretleyebilirsiniz.")
            return
        
        subject = mail_subject_entry.get().strip()
        content = mail_content_text.get("1.0", tk.END).strip()
        
        if not subject or not content:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen mail konusu ve i√ßeriƒüini doldurun!")
            return
        
        success_count = 0
        fail_count = 0
        empty_email_count = 0
        
        for item in checked_items:
            values = cari_tree.item(item)["values"]
            if not values or len(values) < 6:
                continue
                
            tedarikci = str(values[0]) if len(values) > 0 else ''
            yetkili = str(values[1]) if len(values) > 1 else ''
            mail = str(values[3]) if len(values) > 3 else ''
            eksik_evraklar = str(values[5]) if len(values) > 5 else ''
            
            # Mail adresini kontrol et
            mail = mail.strip()
            if not mail or mail == '' or mail == 'nan':
                print(f"Bo≈ü mail adresi atlaniyor: {tedarikci}")
                empty_email_count += 1
                fail_count += 1
                continue
            
            # Mail i√ßeriƒüini ki≈üiselle≈ütir
            personalized_content = content.replace("{{Tedarik√ßi Adƒ±}}", tedarikci)
            personalized_content = personalized_content.replace("{{Yetkili Ki≈üi}}", yetkili)
            personalized_content = personalized_content.replace("{{Eksik Evraklar}}", eksik_evraklar)
            
            try:
                # SMTP ile mail g√∂nder
                msg = MIMEMultipart()
                msg['From'] = GMAIL_USER
                msg['To'] = mail
                msg['Subject'] = subject
                
                # HTML formatƒ±nda mail i√ßeriƒüi
                html_content = f"""
                <html>
                <body style="font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333;">
                    <div style="max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
                        <div style="background-color: #16a085; color: white; padding: 15px; border-radius: 5px 5px 0 0;">
                            <h2 style="margin: 0;">üèõÔ∏è Tedarik√ßi Uyumluluk Merkezi</h2>
                        </div>
                        <div style="padding: 20px; background-color: #f9f9f9;">
                            <pre style="font-family: 'Segoe UI', Arial, sans-serif; white-space: pre-wrap; word-wrap: break-word;">{personalized_content}</pre>
                        </div>
                        <div style="text-align: center; padding: 10px; background-color: #ecf0f1; border-radius: 0 0 5px 5px; font-size: 12px; color: #7f8c8d;">
                            Bu email Tedarik√ßi Uyumluluk Sistemi tarafƒ±ndan otomatik olu≈üturulmu≈ütur.
                        </div>
                    </div>
                </body>
                </html>
                """
                
                msg.attach(MIMEText(html_content, 'html'))
                
                # SMTP sunucusuna baƒülan ve g√∂nder
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
                server.send_message(msg)
                server.quit()
                
                success_count += 1
                activity_logger.log_email_sent(mail, subject, "Tedarik√ßi Uyumluluk")
                
            except Exception as e:
                fail_count += 1
                print(f"Mail g√∂nderme hatasƒ± ({mail}): {e}")
        
        # Sonu√ß mesajƒ±
        result_msg = f"Ba≈üarƒ±lƒ±: {success_count} mail g√∂nderildi"
        if fail_count > 0:
            result_msg += f"\nBa≈üarƒ±sƒ±z: {fail_count}"
        if empty_email_count > 0:
            result_msg += f"\nBo≈ü mail adresi: {empty_email_count}"
            result_msg += "\n\n√ñnemli: Bazƒ± kayƒ±tlarda mail adresi bo≈ü!"
        
        if success_count > 0:
            messagebox.showinfo("Mail G√∂nderimi Tamamlandƒ±", result_msg)
        else:
            messagebox.showwarning("Mail G√∂nderimi Ba≈üarƒ±sƒ±z", result_msg)
        
        if fail_count > 0:
            messagebox.showwarning("Uyarƒ±", f"{fail_count} mail g√∂nderilemedi!")
    
    def send_bulk_email():
        """T√ºm kayƒ±tlƒ± tedarik√ßilere toplu mail g√∂nder"""
        # Filtrelenmi≈ü t√ºm kayƒ±tlara g√∂nder
        records = cari_tree.get_children()
        
        if not records:
            messagebox.showwarning("Uyarƒ±", "G√∂nderilecek kayƒ±t bulunamadƒ±!")
            return
        
        result = messagebox.askyesno("Toplu Mail G√∂nderimi", 
                                    f"{len(records)} tedarik√ßiye toplu mail g√∂ndermek istediƒüinize emin misiniz?")
        
        if not result:
            return
        
        subject = mail_subject_entry.get().strip()
        content = mail_content_text.get("1.0", tk.END).strip()
        
        if not subject or not content:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen mail konusu ve i√ßeriƒüini doldurun!")
            return
        
        success_count = 0
        fail_count = 0
        empty_email_count = 0
        
        for item in records:
            values = cari_tree.item(item)["values"]
            if not values or len(values) < 6:
                continue
                
            tedarikci = str(values[0]) if len(values) > 0 else ''
            yetkili = str(values[1]) if len(values) > 1 else ''
            mail = str(values[3]) if len(values) > 3 else ''
            eksik_evraklar = str(values[5]) if len(values) > 5 else ''
            
            # Mail adresini kontrol et
            mail = mail.strip()
            if not mail or mail == '' or mail == 'nan':
                print(f"Bo≈ü mail adresi atlanƒ±yor: {tedarikci}")
                empty_email_count += 1
                fail_count += 1
                continue
            
            # Mail i√ßeriƒüini ki≈üiselle≈ütir
            personalized_content = content.replace("{{Tedarik√ßi Adƒ±}}", tedarikci)
            personalized_content = personalized_content.replace("{{Yetkili Ki≈üi}}", yetkili)
            personalized_content = personalized_content.replace("{{Eksik Evraklar}}", eksik_evraklar)
            
            try:
                # SMTP ile mail g√∂nder
                msg = MIMEMultipart()
                msg['From'] = GMAIL_USER
                msg['To'] = mail
                msg['Subject'] = subject
                
                # HTML formatƒ±nda mail i√ßeriƒüi
                html_content = f"""
                <html>
                <body style="font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333;">
                    <div style="max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
                        <div style="background-color: #16a085; color: white; padding: 15px; border-radius: 5px 5px 0 0;">
                            <h2 style="margin: 0;">üèõÔ∏è Tedarik√ßi Uyumluluk Merkezi</h2>
                        </div>
                        <div style="padding: 20px; background-color: #f9f9f9;">
                            <pre style="font-family: 'Segoe UI', Arial, sans-serif; white-space: pre-wrap; word-wrap: break-word;">{personalized_content}</pre>
                        </div>
                        <div style="text-align: center; padding: 10px; background-color: #ecf0f1; border-radius: 0 0 5px 5px; font-size: 12px; color: #7f8c8d;">
                            Bu email Tedarik√ßi Uyumluluk Sistemi tarafƒ±ndan otomatik olu≈üturulmu≈ütur.
                        </div>
                    </div>
                </body>
                </html>
                """
                
                msg.attach(MIMEText(html_content, 'html'))
                
                # SMTP sunucusuna baƒülan ve g√∂nder
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
                server.send_message(msg)
                server.quit()
                
                success_count += 1
                activity_logger.log_email_sent(mail, subject, "Tedarik√ßi Uyumluluk")
                
            except Exception as e:
                fail_count += 1
                print(f"Mail g√∂nderme hatasƒ± ({mail}): {e}")
        
        # Sonu√ß mesajƒ±
        result_msg = f"Ba≈üarƒ±lƒ±: {success_count}\nBa≈üarƒ±sƒ±z: {fail_count}"
        if empty_email_count > 0:
            result_msg += f"\nBo≈ü mail adresi: {empty_email_count}"
            result_msg += "\n\n√ñnemli: Bazƒ± kayƒ±tlarda mail adresi bo≈ü olduƒüu i√ßin g√∂nderilemedi!"
        
        messagebox.showinfo("Toplu Mail G√∂nderimi Tamamlandƒ±", result_msg)
    
    tk.Button(mail_btn_frame, text="üìß Se√ßili Tedarik√ßilere G√∂nder", font=("Segoe UI", 10, "bold"),
             bg="#27ae60", fg="white", cursor="hand2", padx=15, pady=8,
             command=send_single_email).pack(side="left", padx=5)
    
    tk.Button(mail_btn_frame, text="üìß Toplu Mail G√∂nder (T√ºm Liste)", font=("Segoe UI", 10, "bold"),
             bg="#e74c3c", fg="white", cursor="hand2", padx=15, pady=8,
             command=send_bulk_email).pack(side="left", padx=5)
    
    tk.Button(mail_btn_frame, text="üìã Excel'i A√ß", font=("Segoe UI", 10, "bold"),
             bg="#3498db", fg="white", cursor="hand2", padx=15, pady=8,
             command=lambda: os.startfile(MASTER_CARI_BILGILER_PATH) if os.path.exists(MASTER_CARI_BILGILER_PATH) else messagebox.showwarning("Uyarƒ±", "Excel dosyasƒ± bulunamadƒ±!")).pack(side="left", padx=5)
    
    # Ana grid container - 2 s√ºtun
    main_grid = tk.Frame(content, bg="#ecf0f1")
    main_grid.pack(fill="both", expand=True)
    main_grid.grid_columnconfigure(0, weight=1)
    main_grid.grid_columnconfigure(1, weight=1)
    
    def create_document_section(parent, title, path, color, icon, column):
        """Belge b√∂l√ºm√º olu≈ütur"""
        section_frame = tk.LabelFrame(
            parent,
            text=f"{icon} {title}",
            font=("Segoe UI", 13, "bold"),
            bg="white",
            fg=color,
            padx=12,
            pady=12,
            relief="solid",
            bd=2
        )
        section_frame.grid(row=0, column=column, padx=5, pady=5, sticky="nsew")
        
        # Scroll container
        scroll_container = tk.Frame(section_frame, bg="white")
        scroll_container.pack(fill="both", expand=True)
        
        canvas = tk.Canvas(scroll_container, bg="white", highlightthickness=0)
        scrollbar = ttk.Scrollbar(scroll_container, orient="vertical", command=canvas.yview)
        scrollable_frame = tk.Frame(canvas, bg="white")
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # Dosyalarƒ± listele
        if not os.path.exists(path):
            tk.Label(scrollable_frame, 
                    text=f"‚ö†Ô∏è Klas√∂r bulunamadƒ±:\n{path}",
                    font=("Segoe UI", 9),
                    fg="#e74c3c",
                    bg="white",
                    justify="left",
                    wraplength=300).pack(pady=20, padx=10)
            return
        
        try:
            pdf_files = sorted(glob.glob(os.path.join(path, "*.[pP][dD][fF]")))
            
            if not pdf_files:
                tk.Label(scrollable_frame, 
                        text="üì≠ Hen√ºz belge bulunmuyor",
                        font=("Segoe UI", 10),
                        fg="gray",
                        bg="white").pack(pady=20)
            else:
                for pdf_file in pdf_files:
                    file_name = os.path.basename(pdf_file)
                    file_size = os.path.getsize(pdf_file)
                    file_size_kb = file_size / 1024
                    file_mtime = datetime.fromtimestamp(os.path.getmtime(pdf_file))
                    
                    # Dosya kartƒ±
                    file_card = tk.Frame(scrollable_frame, bg="#f8f9fa", bd=1, relief="solid", padx=10, pady=8)
                    file_card.pack(fill="x", pady=3, padx=5)
                    
                    # Dosya adƒ±
                    name_label = tk.Label(file_card, text=f"üìÑ {file_name}", 
                                         font=("Segoe UI", 9, "bold"),
                                         bg="#f8f9fa", fg="#2c3e50",
                                         anchor="w")
                    name_label.pack(fill="x")
                    
                    # Dosya bilgileri
                    info_text = f"üìè {file_size_kb:.1f} KB  |  üìÖ {file_mtime.strftime('%d.%m.%Y %H:%M')}"
                    info_label = tk.Label(file_card, text=info_text,
                                         font=("Segoe UI", 8),
                                         bg="#f8f9fa", fg="gray",
                                         anchor="w")
                    info_label.pack(fill="x")
                    
                    # Butonlar
                    btn_frame = tk.Frame(file_card, bg="#f8f9fa")
                    btn_frame.pack(fill="x", pady=(5, 0))
                    
                    def open_file(filepath=pdf_file):
                        try:
                            import subprocess
                            if os.name == 'nt':  # Windows
                                os.startfile(filepath)
                            elif os.name == 'posix':  # macOS/Linux
                                subprocess.call(['open', filepath])
                            if activity_logger:
                                activity_logger.log_activity(f"Belge a√ßƒ±ldƒ±: {os.path.basename(filepath)}", 
                                                            "Tedarik√ßi Uyumluluk")
                        except Exception as e:
                            messagebox.showerror("Hata", f"Dosya a√ßƒ±lƒ±rken hata olu≈ütu:\n{str(e)}")
                    
                    def copy_path(filepath=pdf_file):
                        root.clipboard_clear()
                        root.clipboard_append(filepath)
                        messagebox.showinfo("Ba≈üarƒ±lƒ±", "Dosya yolu panoya kopyalandƒ±!")
                    
                    open_btn = tk.Button(btn_frame, text="üìÇ A√ß", 
                                        font=("Segoe UI", 8),
                                        bg=color, fg="white",
                                        relief="flat",
                                        cursor="hand2",
                                        padx=8, pady=2,
                                        command=open_file)
                    open_btn.pack(side="left", padx=2)
                    
                    copy_btn = tk.Button(btn_frame, text="üìã Yol Kopyala",
                                        font=("Segoe UI", 8),
                                        bg="#95a5a6", fg="white",
                                        relief="flat",
                                        cursor="hand2",
                                        padx=8, pady=2,
                                        command=copy_path)
                    copy_btn.pack(side="left", padx=2)
                    
        except Exception as e:
            tk.Label(scrollable_frame,
                    text=f"‚ùå Hata: {str(e)}",
                    font=("Segoe UI", 9),
                    fg="#e74c3c",
                    bg="white").pack(pady=20, padx=10)
    
    # Sertifikalar b√∂l√ºm√º (sol)
    create_document_section(main_grid, "SERTƒ∞Fƒ∞KALAR", MASTER_SERTIFIKA_PATH, "#27ae60", "üèÜ", 0)
    
    # S√∂zle≈ümeler b√∂l√ºm√º (saƒü)
    create_document_section(main_grid, "S√ñZLE≈ûMELER", MASTER_SOZLESME_PATH, "#e74c3c", "üìù", 1)
    
    # Alt bilgi
    info_frame = tk.Frame(content, bg="#ecf0f1", pady=10)
    info_frame.pack(side="bottom", fill="x")
    
    info_label = tk.Label(
        info_frame,
        text="üí° Belgeleri g√∂r√ºnt√ºlemek i√ßin 'üìÇ A√ß' butonuna tƒ±klayƒ±n  |  üîÑ Yeni belgeler otomatik olarak burada g√∂r√ºnecektir",
        font=("Segoe UI", 9, "italic"),
        fg="#7f8c8d",
        bg="#ecf0f1"
    )
    info_label.pack()
    
    # Yenile butonu
    refresh_btn = tk.Button(
        info_frame,
        text="üîÑ Listeyi Yenile",
        font=("Segoe UI", 10, "bold"),
        bg="#3498db",
        fg="white",
        relief="raised",
        bd=2,
        cursor="hand2",
        padx=15,
        pady=8,
        command=init_compliance_center_tab
    )
    refresh_btn.pack(pady=(10, 0))

# ---------- GUI BA≈ûLATILMASI ----------
def show_page(page_name):
    global current_page_name
    current_page_name = page_name
    
    # LOG: Sayfa ziyareti
    if activity_logger:
        activity_logger.log_page_visit(page_name)
    
    for frame in frames.values():
        frame.pack_forget()
    
    if page_name in frames:
        frames[page_name].pack(fill="both", expand=True)
        
        # Trend Avcƒ±sƒ± initialization on demand
        if page_name == "Trend Avcƒ±sƒ±":
            init_trend_hunter_tab()
        # Yeni Mod√ºller initialization on demand
        elif page_name == "√úretim Takibi":
            init_production_pipeline_tab()
        elif page_name == "Hammadde Fiyatlarƒ±":
            init_commodity_intelligence_tab()
        # Stok Y√∂netimi initialization on demand
        elif page_name == "Stok Y√∂netimi":
            init_stok_tab()
        # Tedarik√ßi Uyumluluk Merkezi initialization on demand
        elif page_name == "Tedarik√ßi Uyumluluk":
            init_compliance_center_tab()
        # Reklamasyon pages initialization on demand
        elif page_name == "Rek Y√∂netici √ñzeti":
            draw_rek_dashboard(frame_rek_ozet)
        elif page_name == "Rek Detaylƒ± Rapor":
            init_rek_detailed_report_tab()
        
    for btn_name, btn in menu_buttons.items():
        if btn_name == page_name:
            btn.configure(fg_color=("#3498db", "#3498db"), text_color="white")
        else:
            btn.configure(fg_color="transparent", text_color=("white", "white")) 

# Set CustomTkinter appearance mode and color theme
ctk.set_appearance_mode("dark")  # Modes: "System" (default), "Dark", "Light"
ctk.set_default_color_theme("blue")  # Themes: "blue" (default), "green", "dark-blue"

root = ctk.CTk()
root.title("Tedarik√ßi Rapor Analiz v2.9 - Geli≈ümi≈ü √ñzellikler S√ºr√ºm√º")
root.geometry("1280x850")

# ---------- KLAVYE KISAYOLLARI ----------
def setup_keyboard_shortcuts():
    """Klavye kƒ±sayollarƒ±nƒ± tanƒ±mlar."""
    # Ctrl+F: Global arama
    root.bind('<Control-f>', lambda e: show_global_search_dialog())
    root.bind('<Control-F>', lambda e: show_global_search_dialog())
    
    # Ctrl+S: Hƒ±zlƒ± yedek al
    root.bind('<Control-s>', lambda e: create_backup())
    root.bind('<Control-S>', lambda e: create_backup())
    
    # Ctrl+R: Veriyi yeniden y√ºkle
    root.bind('<Control-r>', lambda e: load_daily_files())
    root.bind('<Control-R>', lambda e: load_daily_files())
    
    # Ctrl+Q: √áƒ±kƒ±≈ü
    root.bind('<Control-q>', lambda e: on_closing())
    root.bind('<Control-Q>', lambda e: on_closing())
    
    # F5: Mevcut sayfayƒ± yenile
    def refresh_current_page(e=None):
        if 'current_page_name' in globals():
            show_page(current_page_name)
    root.bind('<F5>', refresh_current_page)
    
    # Ctrl+Z: Undo (mevcut durumda)
    root.bind('<Control-z>', lambda e: undo_last_action())
    root.bind('<Control-Z>', lambda e: undo_last_action())
    
    # Ctrl+Y: Redo
    root.bind('<Control-y>', lambda e: redo_last_action())
    root.bind('<Control-Y>', lambda e: redo_last_action())
    
    # Ctrl+E: Export
    root.bind('<Control-e>', lambda e: bulk_export_data())
    root.bind('<Control-E>', lambda e: bulk_export_data())
    
    # Ctrl+I: Import
    root.bind('<Control-i>', lambda e: bulk_import_files())
    root.bind('<Control-I>', lambda e: bulk_import_files())
    
    # Ctrl+T: Tema deƒüi≈ütir
    root.bind('<Control-t>', lambda e: toggle_dark_mode())
    root.bind('<Control-T>', lambda e: toggle_dark_mode())
    
    # Ctrl+H: Son kullanƒ±lanlar
    root.bind('<Control-h>', lambda e: show_recent_items_menu())
    root.bind('<Control-H>', lambda e: show_recent_items_menu())
    
    print("‚úÖ Klavye kƒ±sayollarƒ± aktif edildi!")
    print("  Ctrl+F: Global Arama")
    print("  Ctrl+S: Yedek Al")
    print("  Ctrl+R: Yeniden Y√ºkle")
    print("  Ctrl+Q: √áƒ±kƒ±≈ü")
    print("  F5: Sayfa Yenile")
    print("  Ctrl+Z: Geri Al")
    print("  Ctrl+Y: ƒ∞leri Al")
    print("  Ctrl+E: Export")
    print("  Ctrl+I: Import")
    print("  Ctrl+T: Tema Deƒüi≈ütir")
    print("  Ctrl+H: Son Kullanƒ±lanlar")

# Klavye kƒ±sayollarƒ±nƒ± ayarla
setup_keyboard_shortcuts()

# Ayarlar deƒüi≈ükenleri global olarak tanƒ±mlanƒ±r
price_weight = tk.DoubleVar(value=0.4)
delivery_weight = tk.DoubleVar(value=0.3)
return_weight = tk.DoubleVar(value=0.3)
exclude_outliers_var = tk.BooleanVar(value=False)  # Varsayƒ±lan: Aykƒ±rƒ± deƒüer filtresi KAPALI

style = ttk.Style()
style.configure("AI.Horizontal.TProgressbar", foreground='#4CAF50', background='#E8F5E9')

# --- CANLI TICKER ≈ûERƒ∞Dƒ∞ (EN √úSTTE) ---
ticker_frame = ctk.CTkFrame(root, height=30, corner_radius=0)
ticker_frame.pack(side="top", fill="x")
ticker_label = ctk.CTkLabel(ticker_frame, text="Piyasa verileri y√ºkleniyor...", font=("Consolas", 10, "bold"), text_color="#2ecc71")
ticker_label.pack(side="left", padx=10)
# Ticker'ƒ± Ba≈ülat - mainloop ba≈üladƒ±ktan sonra √ßalƒ±≈ütƒ±r
# update_market_ticker()  # Bu satƒ±r mainloop √∂ncesi √ßaƒürƒ±lamaz - threading hatasƒ± verir
scroll_ticker_animation()

sidebar = ctk.CTkFrame(root, width=250, corner_radius=0)
sidebar.pack(side="left", fill="y")
sidebar.pack_propagate(False) 

ctk.CTkLabel(sidebar, text="Tedarik√ßi\nAnaliz Sistemi", font=("Segoe UI", 16, "bold")).pack(fill="x", pady=20)

# --- KAYDIRILABƒ∞Lƒ∞R SOL MEN√ú (SCROLLABLE SIDEBAR) ---
# Scrollbar'ƒ± √∂nce tanƒ±mlayƒ±p saƒüa yaslƒ±yoruz, b√∂ylece her zaman g√∂r√ºn√ºr alanda kalƒ±yor.
sidebar_scrollbar = tk.Scrollbar(sidebar, orient="vertical")
sidebar_scrollbar.pack(side="right", fill="y")

sidebar_canvas = tk.Canvas(sidebar, bg="#2c3e50", highlightthickness=0, yscrollcommand=sidebar_scrollbar.set)
sidebar_canvas.pack(side="left", fill="both", expand=True)

sidebar_scrollbar.configure(command=sidebar_canvas.yview)

sidebar_content_frame = ctk.CTkFrame(sidebar_canvas, fg_color="transparent")

sidebar_content_frame.bind(
    "<Configure>",
    lambda e: sidebar_canvas.configure(scrollregion=sidebar_canvas.bbox("all"))
)

# Canvas i√ßinde pencere olu≈üturuyoruz.
canvas_window = sidebar_canvas.create_window((0, 0), window=sidebar_content_frame, anchor="nw")

# Canvas geni≈üliƒüi deƒüi≈ütiƒüinde (√∂rn: scrollbar g√∂r√ºnd√ºƒü√ºnde) i√ßerik frame'inin geni≈üliƒüini de g√ºncelliyoruz.
def on_sidebar_canvas_configure(event):
    sidebar_canvas.itemconfig(canvas_window, width=event.width)

sidebar_canvas.bind("<Configure>", on_sidebar_canvas_configure)

# Mouse Tekerleƒüi Desteƒüi
def on_mousewheel(event):
    sidebar_canvas.yview_scroll(int(-1*(event.delta/120)), "units")

# Fare sidebar √ºzerindeyken scroll √ßalƒ±≈üsƒ±n
sidebar_canvas.bind("<Enter>", lambda _: sidebar_canvas.bind_all("<MouseWheel>", on_mousewheel))
sidebar_canvas.bind("<Leave>", lambda _: sidebar_canvas.unbind_all("<MouseWheel>"))

content_area = ctk.CTkFrame(root, corner_radius=0)
content_area.pack(side="right", fill="both", expand=True)

frame_ozet = ttk.Frame(content_area)
frame_analiz = ttk.Frame(content_area, padding="20")
frame_siparis = ttk.Frame(content_area, padding="10")
frame_karne = ttk.Frame(content_area, padding="10")
frame_trend = ttk.Frame(content_area, padding="10")
frame_tahmin = ttk.Frame(content_area, padding="10")
frame_harita = ttk.Frame(content_area, padding="0")
frame_detaylar = ttk.Frame(content_area, padding="10")
frame_karsilastirma = ttk.Frame(content_area, padding="10")
frame_ocr = ttk.Frame(content_area, padding="10")
frame_chat = ttk.Frame(content_area, padding="10")
frame_ayarlar = ttk.Frame(content_area, padding="10")
frame_ai = ttk.Frame(content_area, padding="10")
frame_negotiator = ttk.Frame(content_area, padding="10") 
frame_haberler = ttk.Frame(content_area, padding="10") # YENƒ∞ FRAME
frame_trend_hunter = ttk.Frame(content_area, padding="10") # TREND AVCISI FRAME

# Yeni Mod√ºller
frame_production_pipeline = ttk.Frame(content_area, padding="10")  # √úretim Takibi GANT
frame_commodity_intel = ttk.Frame(content_area, padding="10")  # Hammadde Fiyat ƒ∞stihbaratƒ±

# Reklamasyon Y√∂netimi Frames
frame_rek_main = ttk.Frame(content_area, padding="10")
frame_rek_ozet = ttk.Frame(content_area, padding="10")
frame_rek_detayli = ttk.Frame(content_area, padding="10")
frame_rek_mail = ttk.Frame(content_area, padding="10")
frame_rek_galeri = ttk.Frame(content_area, padding="10")
frame_rek_veri = ttk.Frame(content_area, padding="10")

# Eksik-Fazla Y√ºklemeler Frame
frame_eksik_fazla = ttk.Frame(content_area, padding="10")

# Stok Y√∂netimi Frame
frame_stok = ttk.Frame(content_area, padding="10")

# Tedarik√ßi Uyumluluk Merkezi Frame
frame_compliance = ttk.Frame(content_area, padding="10")

frames = {
    "Y√∂netim Paneli": frame_ozet,
    "Analiz": frame_analiz,
    "Akƒ±llƒ± Sipari≈ü": frame_siparis,
    "Tedarik√ßi Karnesi": frame_karne,
    "Aylƒ±k Trend": frame_trend,
    "Gelecek Tahmini": frame_tahmin,
    "Harita": frame_harita,
    "Detaylar": frame_detaylar,
    "Kar≈üƒ±la≈ütƒ±rma": frame_karsilastirma,
    "OCR (Fatura)": frame_ocr,
    "Verilerinle Konu≈ü": frame_chat,
    "YZ Yorumu": frame_ai,
    "Pazarlƒ±k Robotu": frame_negotiator, 
    "Ayarlar": frame_ayarlar, # Artƒ±k kullanƒ±lmƒ±yor ama referans hatasƒ± olmamasƒ± i√ßin tutuldu
    "Sekt√∂r Haberleri": frame_haberler, # YENƒ∞ FRAME
    "Trend Avcƒ±sƒ±": frame_trend_hunter, # TREND HUNTER
    # Yeni Mod√ºller
    "√úretim Takibi": frame_production_pipeline,  # Sipari≈ü A≈üama Takibi
    "Hammadde Fiyatlarƒ±": frame_commodity_intel,  # Hammadde Fiyat ƒ∞stihbaratƒ±
    # Reklamasyon Y√∂netimi
    "Reklamasyon Y√∂netimi": frame_rek_main,
    "Rek Y√∂netici √ñzeti": frame_rek_ozet,
    "Rek Detaylƒ± Rapor": frame_rek_detayli,
    "Rek Mail Merkezi": frame_rek_mail,
    "Rek Galeri": frame_rek_galeri,
    "Rek Veri Y√ºkleme": frame_rek_veri,
    # Eksik-Fazla Y√ºklemeler
    "Eksik-Fazla Y√ºklemeler": frame_eksik_fazla,
    # Stok Y√∂netimi
    "Stok Y√∂netimi": frame_stok,
    # Tedarik√ßi Uyumluluk Merkezi
    "Tedarik√ßi Uyumluluk": frame_compliance
}

menu_items = [
    ("üìä Y√∂netim Paneli", "Y√∂netim Paneli"),
    ("üîç Analiz & Veri", "Analiz"),
    ("üõí Akƒ±llƒ± Sipari≈ü", "Akƒ±llƒ± Sipari≈ü"),
    ("üí∞ Pazarlƒ±k Robotu", "Pazarlƒ±k Robotu"), 
    ("üì∞ Sekt√∂r Haberleri", "Sekt√∂r Haberleri"), # YENƒ∞ BUTON
    ("üîÆ Trend Avcƒ±sƒ±", "Trend Avcƒ±sƒ±"), # TREND HUNTER
    ("üè≠ Reklamasyon Y√∂netimi", "Reklamasyon Y√∂netimi"), # YENƒ∞ BUTON
    ("üìÖ √úretim Takibi", "√úretim Takibi"),  # YENƒ∞: Sipari≈ü A≈üama Takibi - GANT
    ("üíπ Hammadde Fiyatlarƒ±", "Hammadde Fiyatlarƒ±"),  # YENƒ∞: Hammadde Fiyat ƒ∞stihbaratƒ±
    ("üè≠ Defacto √úretim Raporlarƒ±", "Stok Y√∂netimi"),  # YENƒ∞: √úretim Takibi
    ("üèõÔ∏è Tedarik√ßi Uyumluluk Merkezi", "Tedarik√ßi Uyumluluk"),  # YENƒ∞: Sertifika ve S√∂zle≈üme Y√∂netimi
    ("üì¶ Eksik-Fazla Y√ºklemeler", "Eksik-Fazla Y√ºklemeler"),  # YENƒ∞: Y√ºkleme Analizi
    ("üìù Tedarik√ßi Karnesi", "Tedarik√ßi Karnesi"),
    ("üìà Aylƒ±k Trend", "Aylƒ±k Trend"),
    ("üîÆ Gelecek Tahmini", "Gelecek Tahmini"),
    ("üó∫Ô∏è Harita", "Harita"),
    ("üìã Detaylar", "Detaylar"),
    ("‚öñÔ∏è Kar≈üƒ±la≈ütƒ±rma", "Kar≈üƒ±la≈ütƒ±rma"),
    ("üì∑ OCR (Fatura)", "OCR (Fatura)"),
    ("üí¨ Verilerinle Konu≈ü", "Verilerinle Konu≈ü"),
    ("ü§ñ YZ Raporu", "YZ Yorumu")
]

for text, name in menu_items:
    btn = ctk.CTkButton(sidebar_content_frame, text=text, font=("Segoe UI", 11), 
                        corner_radius=6, anchor="w", 
                        command=lambda n=name: show_page(n),
                        fg_color="transparent", hover_color=("#34495e", "#34495e"),
                        text_color=("white", "white"))
    btn.pack(fill="x", pady=2, padx=5)
    menu_buttons[name] = btn

# Sistem Ara√ßlarƒ± B√∂l√ºm√º
ctk.CTkLabel(sidebar_content_frame, text="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", font=("Arial", 8), text_color="#95a5a6").pack(pady=5)
ctk.CTkLabel(sidebar_content_frame, text="Sƒ∞STEM ARA√áLARI", font=("Segoe UI", 9, "bold"), text_color="#95a5a6").pack(pady=2)

system_tools_frame = ctk.CTkFrame(sidebar_content_frame, fg_color="transparent")
system_tools_frame.pack(fill="x", pady=5, padx=5)

ttk.Button(system_tools_frame, text="üíæ Yedek Al", 
          command=create_backup).pack(fill="x", pady=2)
ttk.Button(system_tools_frame, text="üì• Yedek Y√ºkle", 
          command=restore_backup).pack(fill="x", pady=2)
ttk.Button(system_tools_frame, text="üîî Bildirimleri Test Et", 
          command=lambda: show_desktop_notification("Test Bildirimi", "Sistem √ßalƒ±≈üƒ±yor! ‚úÖ")).pack(fill="x", pady=2)
ttk.Button(system_tools_frame, text="üîç Global Arama (Ctrl+F)", 
          command=show_global_search_dialog).pack(fill="x", pady=2)
ttk.Button(system_tools_frame, text="üì¶ Toplu Export", 
          command=bulk_export_data).pack(fill="x", pady=2)
ttk.Button(system_tools_frame, text="üì• Toplu Import", 
          command=bulk_import_files).pack(fill="x", pady=2)
ttk.Button(system_tools_frame, text="üåì Tema Deƒüi≈ütir", 
          command=toggle_dark_mode).pack(fill="x", pady=2)
ttk.Button(system_tools_frame, text="üìã Son Kullanƒ±lanlar", 
          command=show_recent_items_menu).pack(fill="x", pady=2)

ctk.CTkLabel(sidebar_content_frame, text="v2.8 | DeFacto", font=("Arial", 8), text_color="#95a5a6").pack(side="bottom", pady=10)

status_label = ttk.Label(content_area, text="Hazƒ±r", relief="sunken", anchor="w")
status_label.pack(side="bottom", fill="x")

draw_dashboard(frame_ozet)
init_map_tab() 
init_chat_tab() 
init_scorecard_tab() 
init_ocr_tab() 
init_smart_order_tab() 
init_negotiator_tab() 
init_news_tab() # YENƒ∞ FONKSƒ∞YON
init_eksik_fazla_tab() # Eksik-Fazla Y√ºklemeler

# Reklamasyon Y√∂netimi Ba≈ülatma
load_reklamasyon_data()
init_rek_main_tab()
init_rek_data_load_tab()
init_rek_gallery_tab()
init_rek_mail_tab()

show_page("Y√∂netim Paneli")

# --- ANALƒ∞Z & VERƒ∞ SAYFASI ---
ttk.Label(frame_analiz, text="1. Dosyalarƒ± Se√ßin:").pack(pady=5)

# Dosya se√ßim butonlarƒ± i√ßin frame
file_button_frame = ttk.Frame(frame_analiz)
file_button_frame.pack(pady=5, fill="x")

ttk.Button(file_button_frame, text="üìÅ Dosya Se√ß", command=dosyalarƒ±_sec).pack(side="left", padx=(0,5), expand=True, fill="x")
ttk.Button(file_button_frame, text="üóÑÔ∏è MySQL Veri Merkezi", command=mysql_unified_data_loader).pack(side="left", padx=(5,0), expand=True, fill="x")

# Fƒ∞LTRELEME SE√áENEKLERƒ∞ (Stok Kodu / Stok Grubu)
filter_options_frame = ttk.LabelFrame(frame_analiz, text="2. Filtreleme Se√ßenekleri (Opsiyonel)")
filter_options_frame.pack(pady=5, fill="x", padx=5)

# Filtreleme tipi se√ßimi
analiz_filter_type_var = tk.StringVar(value="none")

def toggle_analiz_filter_fields():
    """Filtreleme tipine g√∂re ilgili combobox'ƒ± g√∂ster/gizle"""
    filter_type = analiz_filter_type_var.get()
    if filter_type == "stock_code":
        stok_kod_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="ew")
        stok_grup_filter_combobox.grid_forget()
        stok_kod_combobox.configure(state="normal")
    elif filter_type == "stock_group":
        stok_grup_filter_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="ew")
        stok_kod_combobox.grid_forget()
    else:  # "none"
        stok_kod_combobox.grid_forget()
        stok_grup_filter_combobox.grid_forget()
        stok_kod_combobox.configure(state="disabled")

filter_type_frame = tk.Frame(filter_options_frame)
filter_type_frame.grid(row=0, column=0, columnspan=2, padx=5, pady=5, sticky="w")

ttk.Label(filter_type_frame, text="Filtre Tipi:").pack(side="left", padx=(0, 10))
ttk.Radiobutton(filter_type_frame, text="Filtre Yok", variable=analiz_filter_type_var, value="none", command=toggle_analiz_filter_fields).pack(side="left", padx=5)
ttk.Radiobutton(filter_type_frame, text="Stok Kodu", variable=analiz_filter_type_var, value="stock_code", command=toggle_analiz_filter_fields).pack(side="left", padx=5)
ttk.Radiobutton(filter_type_frame, text="Stok Grubu", variable=analiz_filter_type_var, value="stock_group", command=toggle_analiz_filter_fields).pack(side="left", padx=5)

ttk.Label(filter_options_frame, text="Se√ßim:").grid(row=1, column=0, padx=5, pady=5, sticky="w")

# Stok Kodu combobox (mevcut)
stok_kod_combobox = ttk.Combobox(filter_options_frame, state="disabled")
stok_kod_combobox.bind("<KeyRelease>", filter_stock_codes)

# Stok Grubu combobox
stok_grup_filter_combobox = ttk.Combobox(filter_options_frame, state="normal")

# Tarih aralƒ±ƒüƒ±
ttk.Label(frame_analiz, text="3. Tarih Aralƒ±ƒüƒ± (Opsiyonel):").pack(pady=5)
df_date = ttk.Frame(frame_analiz); df_date.pack(pady=5)
ttk.Label(df_date, text="Ba≈ülangƒ±√ß (gg-aa-yyyy):").pack(side="left")
start_date_entry = ttk.Entry(df_date, width=12); start_date_entry.pack(side="left", padx=5)
ttk.Label(df_date, text="Biti≈ü:").pack(side="left")
end_date_entry = ttk.Entry(df_date, width=12); end_date_entry.pack(side="left", padx=5)

# --- AYARLAR (EMBEDDED) ---
settings_frame = ttk.LabelFrame(frame_analiz, text="‚öôÔ∏è Analiz Parametreleri & Aƒüƒ±rlƒ±klar")
settings_frame.pack(pady=10, fill="x", padx=5)

# Aƒüƒ±rlƒ±klar
p_frame = tk.Frame(settings_frame); p_frame.pack(fill="x", padx=5, pady=2)
price_label = ttk.Label(p_frame, text="Fiyat: 0.40", width=12); price_label.pack(side="left")
ttk.Scale(p_frame, variable=price_weight, from_=0, to=1, command=update_weights).pack(side="left", fill="x", expand=True)

d_frame = tk.Frame(settings_frame); d_frame.pack(fill="x", padx=5, pady=2)
delivery_label = ttk.Label(d_frame, text="Teslim: 0.30", width=12); delivery_label.pack(side="left")
ttk.Scale(d_frame, variable=delivery_weight, from_=0, to=1, command=update_weights).pack(side="left", fill="x", expand=True)

r_frame = tk.Frame(settings_frame); r_frame.pack(fill="x", padx=5, pady=2)
return_label = ttk.Label(r_frame, text="ƒ∞ade: 0.30", width=12); return_label.pack(side="left")
ttk.Scale(r_frame, variable=return_weight, from_=0, to=1, command=update_weights).pack(side="left", fill="x", expand=True)

# Aykƒ±rƒ± Deƒüerler
outlier_subframe = tk.Frame(settings_frame)
outlier_subframe.pack(fill="x", padx=5, pady=5)
ttk.Checkbutton(outlier_subframe, text="Aykƒ±rƒ± Deƒüerleri Filtrele", variable=exclude_outliers_var).pack(side="left")
ttk.Button(outlier_subframe, text="üíæ Aykƒ±rƒ±larƒ± ƒ∞ndir", command=save_outliers_to_excel, width=15).pack(side="right")

# --- ANALƒ∞Z DURUM VE BUTONLARI ---
ai_status_label = ttk.Label(frame_analiz, text="", font=("Arial", 10, "italic")); ai_status_label.pack(pady=5)
ai_progress_bar = ttk.Progressbar(frame_analiz, style="AI.Horizontal.TProgressbar", mode='indeterminate')

ttk.Button(frame_analiz, text="ANALƒ∞Zƒ∞ BA≈ûLAT", command=start_analysis_threaded).pack(pady=10, fill="x")
ttk.Button(frame_analiz, text="Raporu E-Posta G√∂nder", command=send_report_email).pack(pady=5, fill="x")

monitor_frame = ttk.LabelFrame(frame_analiz, text="Otomatik Klas√∂r ƒ∞zleme"); monitor_frame.pack(pady=10, fill="x", padx=5)
start_button = ttk.Button(monitor_frame, text="Ba≈ülat", command=start_monitoring); start_button.pack(side="left", padx=5, pady=5, expand=True)
stop_button = ttk.Button(monitor_frame, text="Durdur", command=stop_monitoring, state="disabled"); stop_button.pack(side="right", padx=5, pady=5, expand=True)

# --- DETAYLAR SEKMESƒ∞ (Geli≈ütirilmi≈ü Filtreleme ile) ---
def init_detaylar_tab():
    """Detaylar sekmesini geli≈ümi≈ü filtreleme ile ba≈ülatƒ±r"""
    for widget in frame_detaylar.winfo_children(): widget.destroy()
    
    # Filtre √áubuƒüu
    filter_frame = tk.Frame(frame_detaylar, bg="#f8f9fa", padx=10, pady=15, bd=1, relief="solid")
    filter_frame.pack(fill="x", padx=10, pady=5)
    
    tk.Label(filter_frame, text="Tedarik√ßi:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=(0,5))
    supplier_var = tk.StringVar(value="T√ºm√º")
    supplier_combo = ttk.Combobox(filter_frame, textvariable=supplier_var, state="readonly", width=25)
    supplier_combo.pack(side="left", padx=5)
    
    tk.Label(filter_frame, text="|  Detaylƒ± Arama:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=15)
    search_col_var = tk.StringVar(value="T√ºm√º")
    search_col_combo = ttk.Combobox(filter_frame, textvariable=search_col_var, state="readonly", width=15)
    search_col_combo.pack(side="left", padx=5)
    entry_search = ttk.Entry(filter_frame, width=30)
    entry_search.pack(side="left", padx=5)
    
    # Export Buttons
    btn_xls = tk.Button(filter_frame, text="Excel", bg="#27ae60", fg="white", font=("Segoe UI", 8), command=lambda: export_detaylar_data("xlsx"))
    btn_xls.pack(side="right", padx=5)
    btn_pdf = tk.Button(filter_frame, text="PDF", bg="#c0392b", fg="white", font=("Segoe UI", 8), command=lambda: export_detaylar_data("pdf"))
    btn_pdf.pack(side="right", padx=5)
    
    # Telefon Arama Butonu
    btn_phone_search = tk.Button(filter_frame, text="üìû Telefon Ara", bg="#3498db", fg="white", font=("Segoe UI", 8, "bold"), command=search_suppliers_by_phone)
    btn_phone_search.pack(side="right", padx=5)
    
    # Treeview
    tree_frame = tk.Frame(frame_detaylar)
    tree_frame.pack(fill="both", expand=True, padx=10, pady=5)
    
    supplier_treeview_new = ttk.Treeview(tree_frame, show='headings', height=20)
    vsb = ttk.Scrollbar(tree_frame, orient="vertical", command=supplier_treeview_new.yview)
    hsb = ttk.Scrollbar(tree_frame, orient="horizontal", command=supplier_treeview_new.xview)
    supplier_treeview_new.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)
    
    supplier_treeview_new.grid(column=0, row=0, sticky='nsew')
    vsb.grid(column=1, row=0, sticky='ns')
    hsb.grid(column=0, row=1, sticky='ew')
    tree_frame.grid_columnconfigure(0, weight=1)
    tree_frame.grid_rowconfigure(0, weight=1)
    
    current_filtered_data = []
    
    def apply_detaylar_filters(event=None):
        """Detaylar sekmesi filtrelerini uygular"""
        nonlocal current_filtered_data
        
        # Treeview'i temizle
        for i in supplier_treeview_new.get_children():
            supplier_treeview_new.delete(i)
        
        if df_global is None or tedarikci_col_global is None:
            return
        
        # Veriyi kopyala
        df_filtered = df_global.copy()
        
        # Tedarik√ßi filtresi
        selected_supplier = supplier_combo.get()
        if selected_supplier and selected_supplier != "T√ºm√º":
            df_filtered = df_filtered[df_filtered[tedarikci_col_global] == selected_supplier]
        
        # Detaylƒ± arama filtresi
        search_text = entry_search.get().lower()
        if search_text:
            search_col = search_col_var.get()
            if search_col == "T√ºm√º":
                # T√ºm kolonlarda ara
                mask = df_filtered.apply(lambda row: any(search_text in str(val).lower() for val in row), axis=1)
                df_filtered = df_filtered[mask]
            else:
                # Belirli bir kolonda ara
                if search_col in df_filtered.columns:
                    df_filtered = df_filtered[df_filtered[search_col].astype(str).str.lower().str.contains(search_text, na=False)]
        
        # Sonu√ßlarƒ± g√∂ster (maksimum 1000 satƒ±r)
        current_filtered_data = df_filtered.head(1000)
        
        for row in current_filtered_data.itertuples(index=False):
            supplier_treeview_new.insert('', 'end', values=row)
    
    def export_detaylar_data(format_type):
        """Detaylar verilerini export et"""
        if not current_filtered_data or len(current_filtered_data) == 0:
            messagebox.showwarning("Uyarƒ±", "Export edilecek veri bulunamadƒ±!")
            return
        
        df_export = pd.DataFrame(current_filtered_data)
        if format_type == "xlsx":
            export_data(df_export, "xlsx", "Detaylar")
        elif format_type == "pdf":
            export_data(df_export, "pdf", "Detaylar")
    
    def update_detaylar_filters():
        """Analiz sonrasƒ± filtreleri g√ºncelle"""
        if df_global is None or tedarikci_col_global is None:
            return
        
        # Tedarik√ßi listesini g√ºncelle
        suppliers = ["T√ºm√º"] + sorted(df_global[tedarikci_col_global].unique().astype(str).tolist())
        supplier_combo['values'] = suppliers
        
        # Kolon listesini g√ºncelle
        columns = ["T√ºm√º"] + list(df_global.columns)
        search_col_combo['values'] = columns
        
        # Treeview kolonlarƒ±nƒ± ayarla
        supplier_treeview_new['columns'] = list(df_global.columns)
        for col in list(df_global.columns):
            supplier_treeview_new.heading(col, text=col)
            supplier_treeview_new.column(col, width=100)
        
        # ƒ∞lk filtrelemeyi uygula
        apply_detaylar_filters()
    
    # Event bindings
    supplier_combo.bind("<<ComboboxSelected>>", apply_detaylar_filters)
    entry_search.bind("<KeyRelease>", apply_detaylar_filters)
    search_col_combo.bind("<<ComboboxSelected>>", apply_detaylar_filters)
    
    # √áift tƒ±klama ile telefon/WhatsApp men√ºs√º
    def on_supplier_double_click(event):
        """Tedarik√ßiye √ßift tƒ±klanƒ±nca telefon/WhatsApp men√ºs√º g√∂ster"""
        selection = supplier_treeview_new.selection()
        if not selection:
            return
        
        item = supplier_treeview_new.item(selection[0])
        values = item['values']
        
        if not values:
            return
        
        # Tedarik√ßi adƒ±nƒ± ve telefon numarasƒ±nƒ± bul
        try:
            columns = list(df_global.columns)
            supplier_idx = columns.index(tedarikci_col_global) if tedarikci_col_global in columns else 0
            phone_idx = columns.index(phone_col_global) if phone_col_global and phone_col_global in columns else -1
            
            supplier_name = values[supplier_idx] if len(values) > supplier_idx else "Bilinmeyen"
            phone_number = values[phone_idx] if phone_idx >= 0 and len(values) > phone_idx else None
            
            if not phone_number or str(phone_number).strip() == "" or str(phone_number) == "nan":
                messagebox.showinfo("Bilgi", f"{supplier_name} i√ßin telefon numarasƒ± bulunamadƒ±.")
                return
            
            # ƒ∞≈ülem men√ºs√º
            action_menu = tk.Toplevel()
            action_menu.title(f"ƒ∞leti≈üim - {supplier_name}")
            action_menu.geometry("400x200")
            
            tk.Label(action_menu, text=f"Tedarik√ßi: {supplier_name}", font=("Segoe UI", 12, "bold")).pack(pady=10)
            tk.Label(action_menu, text=f"Telefon: {phone_number}", font=("Segoe UI", 10)).pack(pady=5)
            
            ttk.Button(action_menu, text="üìû Telefon ile Ara", 
                      command=lambda: [make_phone_call(supplier_name, phone_number), action_menu.destroy()]).pack(fill="x", padx=50, pady=5)
            ttk.Button(action_menu, text="üí¨ WhatsApp Mesajƒ± G√∂nder", 
                      command=lambda: [send_whatsapp_message(supplier_name, phone_number), action_menu.destroy()]).pack(fill="x", padx=50, pady=5)
            ttk.Button(action_menu, text="‚ùå ƒ∞ptal", command=action_menu.destroy).pack(fill="x", padx=50, pady=5)
            
        except Exception as e:
            if activity_logger:
                activity_logger.log_error(f"Tedarik√ßi bilgisi √ßekme hatasƒ±: {str(e)}", "Detaylar")
            messagebox.showerror("Hata", f"ƒ∞≈ülem yapƒ±lamadƒ±: {str(e)}")
    
    supplier_treeview_new.bind("<Double-1>", on_supplier_double_click)
    
    # Global fonksiyonlarƒ± g√ºncelle
    global update_supplier_details_tab
    def update_supplier_details_tab(df, t_col):
        root.after(0, update_detaylar_filters)

# Detaylar sekmesini ba≈ülat
init_detaylar_tab()

supplier_listbox = tk.Listbox(frame_karsilastirma, selectmode=tk.MULTIPLE, height=8); supplier_listbox.pack(fill="x")
ttk.Button(frame_karsilastirma, text="Kar≈üƒ±la≈ütƒ±r", command=show_comparison_chart).pack()
comparison_frame = ttk.Frame(frame_karsilastirma); comparison_frame.pack(expand=True, fill="both")


def on_closing():
    """Uygulama kapatƒ±lƒ±rken kaynaklarƒ± temizler ve g√ºvenli √ßƒ±kƒ±≈ü saƒülar."""
    try:
        save_settings()
        
        # Klas√∂r izlemeyi durdur
        if observer:
            try:
                observer.stop()
            except:
                pass
        
        # Harita widget'ƒ± varsa yok et (Tile loader thread'lerini durdurmaya yardƒ±mcƒ± olur)
        if map_widget:
            try:
                # Harita widget'ƒ±nƒ± manuel yok etmek, i√ßindeki resim referanslarƒ±nƒ±
                # interpreter kapanmadan temizlemeye yardƒ±mcƒ± olabilir.
                map_widget.destroy()
            except:
                pass

        root.quit()     # Mainloop'tan √ßƒ±k
        root.destroy()  # Pencereyi yok et
    except Exception as e:
        print(f"Kapatma sƒ±rasƒ±nda hata: {e}")
        # Her durumda √ßƒ±kmaya √ßalƒ±≈ü
        try:
            import sys
            sys.exit(0)
        except:
            pass

def load_daily_files():
    """Merkezi dosyalardan verileri otomatik y√ºkler (startup'ta √ßalƒ±≈üƒ±r)"""
    global df_global, all_stock_codes, all_stock_groups, status_label, file_paths_global
    
    messages = []
    
    # Tedarik verisini y√ºkle
    if os.path.exists(MASTER_TEDARIK_PATH):
        try:
            print(f"Merkezi Tedarik dosyasƒ± bulundu: {MASTER_TEDARIK_PATH}")
            df_global = pd.read_excel(MASTER_TEDARIK_PATH)
            
            # file_paths_global'ƒ± set et (analiz fonksiyonu i√ßin gerekli)
            file_paths_global = [MASTER_TEDARIK_PATH]
            
            # Stok kodu kolonunu tespit et
            stok_col = find_stok_kodu_column(df_global)
            if stok_col:
                # all_stock_codes listesini g√ºncelle
                all_stock_codes = sorted(df_global[stok_col].dropna().unique().tolist())
                print(f"Stok kodlarƒ± g√ºncellendi: {len(all_stock_codes)} adet")
                
                # Combobox'ƒ± g√ºncelle (UI thread'inde)
                if 'stok_kod_combobox' in globals() and stok_kod_combobox:
                    root.after(0, lambda: stok_kod_combobox.configure(values=all_stock_codes, state="normal"))
                    root.after(0, lambda: stok_kod_combobox.set("T√ºm Veri"))
            
            # Stok grubu kolonunu tespit et ve all_stock_groups'u g√ºncelle
            stok_grup_col = find_stok_grubu_column(df_global)
            if stok_grup_col:
                unique_gruplar = sorted(df_global[stok_grup_col].dropna().unique().tolist())
                all_stock_groups = ["T√ºm Veri"] + unique_gruplar
                print(f"Stok gruplarƒ± g√ºncellendi: {len(all_stock_groups)-1} adet")
                
                # Stok grup filter combobox'ƒ±nƒ± g√ºncelle (UI thread'inde)
                # Lambda'da deƒüeri capture etmek i√ßin deƒüi≈ükeni kopyalayalƒ±m
                gruplar_copy = all_stock_groups.copy()
                if 'stok_grup_filter_combobox' in globals() and stok_grup_filter_combobox:
                    root.after(0, lambda g=gruplar_copy: stok_grup_filter_combobox.configure(values=g))
                    root.after(0, lambda: stok_grup_filter_combobox.set("T√ºm Veri"))
            
            messages.append("‚úÖ Merkezi Tedarik verisi y√ºklendi")
            print(f"Tedarik verisi ba≈üarƒ±yla y√ºklendi: {len(df_global)} satƒ±r")
        except Exception as e:
            messages.append(f"‚ùå Tedarik y√ºkleme hatasƒ±: {str(e)}")
            print(f"Tedarik dosyasƒ± y√ºkleme hatasƒ±: {e}")
    else:
        messages.append(f"‚ö†Ô∏è Tedarik dosyasƒ± bulunamadƒ±: {MASTER_TEDARIK_PATH}")
        print(f"Tedarik dosyasƒ± bulunamadƒ±: {MASTER_TEDARIK_PATH}")
    
    # Reklamasyon verisini y√ºkle
    if os.path.exists(MASTER_REKLAMASYON_PATH):
        try:
            print(f"Merkezi Reklamasyon dosyasƒ± bulundu: {MASTER_REKLAMASYON_PATH}")
            success, message = load_reklamasyon_data(filepath=MASTER_REKLAMASYON_PATH)
            if success:
                messages.append("‚úÖ Merkezi Reklamasyon verisi y√ºklendi")
                print("Reklamasyon verisi ba≈üarƒ±yla y√ºklendi")
            else:
                messages.append(f"‚ùå Reklamasyon y√ºkleme hatasƒ±: {message}")
                print(f"Reklamasyon y√ºkleme hatasƒ±: {message}")
        except Exception as e:
            messages.append(f"‚ùå Reklamasyon y√ºkleme hatasƒ±: {str(e)}")
            print(f"Reklamasyon dosyasƒ± y√ºkleme hatasƒ±: {e}")
    else:
        messages.append(f"‚ö†Ô∏è Reklamasyon dosyasƒ± bulunamadƒ±: {MASTER_REKLAMASYON_PATH}")
        print(f"Reklamasyon dosyasƒ± bulunamadƒ±: {MASTER_REKLAMASYON_PATH}")
    
    # Status label'ƒ± g√ºncelle
    if status_label:
        status_text = " | ".join(messages)
        root.after(0, lambda: status_label.configure(text=status_text))
    
    # Veri ba≈üarƒ±yla y√ºklendiyse otomatik analiz ba≈ülat
    if df_global is not None and file_paths_global:
        print("Otomatik analiz ba≈ülatƒ±lƒ±yor...")
        # 500ms sonra analiz ba≈ülat (UI tamamen y√ºklendikten sonra)
        root.after(500, lambda: auto_run_initial_analysis())
    
    print("Merkezi dosya y√ºkleme tamamlandƒ±")

def auto_run_initial_analysis():
    """Ba≈ülangƒ±√ßta t√ºm veri i√ßin otomatik analiz yapar (aykƒ±rƒ± deƒüer filtresi olmadan)"""
    global file_paths_global, analiz_filter_type_var, exclude_outliers_var
    
    if not file_paths_global:
        print("Otomatik analiz atlandƒ±: Dosya y√ºklenmemi≈ü")
        return
    
    try:
        print("T√ºm veri analizi ba≈ülatƒ±lƒ±yor (aykƒ±rƒ± deƒüer filtresi olmadan)...")
        
        # Aykƒ±rƒ± deƒüer filtresini KAPALI yap (kullanƒ±cƒ± isterse sonra a√ßabilir)
        if 'exclude_outliers_var' in globals() and exclude_outliers_var:
            exclude_outliers_var.set(False)
            print("Aykƒ±rƒ± deƒüer filtresi devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ± (tik kaldƒ±rƒ±ldƒ±)")
        
        # Filter type'ƒ± "none" olarak ayarla (t√ºm veri i√ßin)
        if 'analiz_filter_type_var' in globals() and analiz_filter_type_var:
            analiz_filter_type_var.set("none")
        
        # Progress bar'ƒ± g√∂ster
        if 'ai_progress_bar' in globals() and ai_progress_bar:
            ai_progress_bar.pack(pady=10, fill="x")
            ai_progress_bar.start()
        
        # Loading gif'i ba≈ülat
        if 'play_loading_gif' in globals():
            play_loading_gif()
        
        # Analiz thread'ini ba≈ülat (filter_type="none", filter_value="" ile t√ºm veri)
        analysis_thread = threading.Thread(
            target=lambda: analiz_et_with_options(file_paths_global, "none", "")
        )
        analysis_thread.daemon = True
        analysis_thread.start()
        
        print("Otomatik analiz ba≈üarƒ±yla tetiklendi")
    except Exception as e:
        print(f"Otomatik analiz hatasƒ±: {e}")

if __name__ == "__main__":
    # Activity logger'ƒ± ba≈ülat
    activity_logger = ActivityLogger()
    
    # Zamanlanmƒ±≈ü g√∂revleri ayarla
    def scheduled_report_sender():
        """Zamanlanmƒ±≈ü rapor g√∂nderici"""
        while True:
            schedule.run_pending()
            threading.Event().wait(60)  # Her 60 saniyede bir kontrol et
    
    # G√ºnl√ºk saat 16:00'da rapor g√∂nder
    schedule.every().day.at("16:00").do(activity_logger.send_daily_report_email)
    
    # Periyodik raporlar (her 4 saatte bir)
    schedule.every(4).hours.do(activity_logger.send_daily_report_email)
    
    # Otomatik yedekleme planla (Her g√ºn saat 18:00)
    auto_backup_schedule()
    
    # S√∂zle≈üme bildirimleri (Her g√ºn saat 09:00)
    schedule.every().day.at("09:00").do(notify_expiring_contracts)
    
    # Kritik alarmlar (Her 4 saatte bir)
    schedule.every(4).hours.do(notify_critical_alerts)
    
    # Scheduler thread'i ba≈ülat
    scheduler_thread = threading.Thread(target=scheduled_report_sender, daemon=True)
    scheduler_thread.start()
    
    activity_logger.log_event("APP_START", "Uygulama ba≈ülatƒ±ldƒ±")
    
    # Ba≈ülangƒ±√ß bildirimi
    show_desktop_notification("Tedarik AI", "Sistem ba≈ülatƒ±ldƒ± ‚úÖ")
    
    load_settings()
    
    # Kapanƒ±≈ü fonksiyonunu g√ºncelle
    def on_closing_with_log():
        activity_logger.log_event("APP_CLOSE", "Uygulama kapatƒ±lƒ±yor")
        activity_logger.close_session()
        on_closing()
    
    root.protocol("WM_DELETE_WINDOW", on_closing_with_log)
    
    # Market ticker'ƒ± ba≈ülat - mainloop ba≈üladƒ±ktan sonra
    root.after(100, update_market_ticker)
    
    # Merkezi dosyalarƒ± otomatik y√ºkle - mainloop ba≈üladƒ±ktan sonra
    root.after(100, load_daily_files)
    
    # ƒ∞lk bildirimleri kontrol et (5 saniye sonra)
    root.after(5000, notify_expiring_contracts)
    
    try:
        root.mainloop()
    except KeyboardInterrupt:
        on_closing_with_log()
