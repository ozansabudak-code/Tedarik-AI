import tkinter as tk
from tkinter import filedialog, messagebox, ttk
import customtkinter as ctk
import pandas as pd
from rapidfuzz import process, fuzz
import requests
import os
import glob  # Dosya listeleme iÃ§in
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg, NavigationToolbar2Tk
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
import threading
import json
import numpy as np
import datetime
from PIL import Image, ImageTk
from fpdf import FPDF
from docx import Document
from docx.shared import Inches
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase
from email import encoders
import getpass
import socket
import math # Matematiksel hesaplamalar iÃ§in
import base64 # OCR iÃ§in resim kodlama
import io # Resim byte iÅŸlemleri iÃ§in
import webbrowser # Haber linkleri iÃ§in
import xml.etree.ElementTree as ET # RSS okumak iÃ§in
import random # Ticker simÃ¼lasyonu iÃ§in
import logging # Loglama iÃ§in
import schedule # ZamanlanmÄ±ÅŸ gÃ¶revler iÃ§in
from collections import defaultdict # Activity tracking iÃ§in
from datetime import timedelta # Zaman hesaplamalarÄ± iÃ§in
import shutil # Backup iÅŸlemleri iÃ§in
import zipfile # Backup arÅŸivleme iÃ§in
from pathlib import Path # Dosya yolu iÅŸlemleri iÃ§in

# Openpyxl kÃ¼tÃ¼phanesi kontrolÃ¼ (Excel yÃ¶netimi iÃ§in)
try:
    import openpyxl
    from openpyxl import Workbook
    from openpyxl.styles import Font, PatternFill, Alignment
    OPENPYXL_AVAILABLE = True
except ImportError:
    OPENPYXL_AVAILABLE = False
    print("Openpyxl kÃ¼tÃ¼phanesi bulunamadÄ±. Excel Ã¶zellikleri Ã§alÄ±ÅŸmayacak.")

# MySQL baÄŸlantÄ±sÄ± iÃ§in
try:
    import mysql.connector
    MYSQL_AVAILABLE = True
except ImportError:
    MYSQL_AVAILABLE = False
    print("MySQL Connector kÃ¼tÃ¼phanesi bulunamadÄ±. MySQL Ã¶zelliÄŸi kullanÄ±lamayacak.")

# Prophet kÃ¼tÃ¼phanesi kontrolÃ¼
try:
    from prophet import Prophet
    PROPHET_AVAILABLE = True
except ImportError:
    PROPHET_AVAILABLE = False
    print("Prophet kÃ¼tÃ¼phanesi bulunamadÄ±. Tahmin Ã¶zelliÄŸi sÄ±nÄ±rlÄ± olacak.")

# Pytrends kÃ¼tÃ¼phanesi kontrolÃ¼ (Trend AvcÄ±sÄ± iÃ§in)
try:
    from pytrends.request import TrendReq
    PYTRENDS_AVAILABLE = True
except ImportError:
    PYTRENDS_AVAILABLE = False
    print("Pytrends kÃ¼tÃ¼phanesi bulunamadÄ±. Trend AvcÄ±sÄ± gerÃ§ek veri Ã§ekemeyecek.")

# YFinance kÃ¼tÃ¼phanesi kontrolÃ¼ (Hammadde fiyatlarÄ± iÃ§in)
try:
    import yfinance as yf
    YFINANCE_AVAILABLE = True
except ImportError:
    YFINANCE_AVAILABLE = False
    print("YFinance kÃ¼tÃ¼phanesi bulunamadÄ±. Hammadde fiyatlarÄ± simÃ¼lasyon modunda Ã§alÄ±ÅŸacak.")

# Harita kÃ¼tÃ¼phanesi kontrolÃ¼
try:
    import tkintermapview
    MAP_AVAILABLE = True
except ImportError:
    MAP_AVAILABLE = False

# PyPDF2 kÃ¼tÃ¼phanesi kontrolÃ¼ (PDF okuma iÃ§in)
try:
    import PyPDF2
    PYPDF2_AVAILABLE = True
except ImportError:
    PYPDF2_AVAILABLE = False
    print("PyPDF2 kÃ¼tÃ¼phanesi bulunamadÄ±. PDF analizi sÄ±nÄ±rlÄ± olacak.")

# Google Generative AI kÃ¼tÃ¼phanesi kontrolÃ¼
try:
    import google.generativeai as genai
    GENAI_AVAILABLE = True
except ImportError:
    GENAI_AVAILABLE = False
    print("Google Generative AI kÃ¼tÃ¼phanesi bulunamadÄ±. AI Ã¶zellikleri Ã§alÄ±ÅŸmayacak.")

# Desktop notification kÃ¼tÃ¼phanesi kontrolÃ¼
try:
    from plyer import notification
    NOTIFICATION_AVAILABLE = True
except ImportError:
    NOTIFICATION_AVAILABLE = False
    print("Plyer kÃ¼tÃ¼phanesi bulunamadÄ±. MasaÃ¼stÃ¼ bildirimleri Ã§alÄ±ÅŸmayacak.")

# ---------- YAPILANDIRMA VE KÄ°MLÄ°K BÄ°LGÄ°LERÄ° ----------
GEMINI_API_KEY = ""  # KullanÄ±cÄ± tarafÄ±ndan gÃ¼ncellenecek
GMAIL_USER = "ozan.sabudak@defacto.com"
GMAIL_APP_PASSWORD = "dzeknqmdooemcwlk"
GMAIL_RECEIVER_LOGS = "ozan.sabudak@defacto.com"
REPORT_RECEIVERS = "ercan.karadas@defacto.com,serkan.ozturk@defacto.com,ozan.sabudak@defacto.com,ozlem.semacan@defacto.com"

GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent"
SETTINGS_FILE = 'app_settings.json'

# Master Data Paths - Merkezi Dosya YollarÄ±
MASTER_TEDARIK_PATH = r"X:\01.Public\TEDARÄ°KÃ‡Ä° PERFORMANS\Tedarik\Tedarik AI.xlsx"
MASTER_REKLAMASYON_PATH = r"X:\01.Public\TEDARÄ°KÃ‡Ä° PERFORMANS\Reklamasyon\Reklamasyon.xlsx"
MASTER_SERTIFIKA_PATH = r"X:\01.Public\TEDARÄ°KÃ‡Ä° PERFORMANS\Sertifikalar"
MASTER_SOZLESME_PATH = r"X:\01.Public\TEDARÄ°KÃ‡Ä° PERFORMANS\SÃ¶zleÅŸme"
MASTER_CARI_BILGILER_PATH = r"X:\01.Public\TEDARÄ°KÃ‡Ä° PERFORMANS\Cari Bilgiler\Cari Bilgiler.xlsx"

# MySQL BaÄŸlantÄ± YapÄ±landÄ±rmasÄ±
MYSQL_CONFIG = {
    "host": "",
    "user": "",
    "password": "",
    "database": "",
    "raise_on_warnings": True
}

# MySQL SQL SorgularÄ± - KullanÄ±cÄ± bu sorgularÄ± dÃ¼zenleyebilir
MYSQL_QUERIES = {
    "tedarik_analiz": "SELECT * FROM tedarikci_verileri",
    "reklamasyon": "SELECT * FROM reklamasyon_verileri",
    "stok": "SELECT * FROM stok_verileri"
}

# MySQL Kolon EÅŸleÅŸtirme - SQL sorgusundaki kolonlarÄ± Excel/uygulama kolonlarÄ±na eÅŸleÅŸtirin
# Format: "SQL_kolon_adi": "Uygulama_kolon_adi"
# Ã–rnek: "supplier_name": "TedarikÃ§i AdÄ±", "unit_price": "Birim Fiyat"
MYSQL_COLUMN_MAPPINGS = {
    "tedarik_analiz": {
        # KullanÄ±cÄ±nÄ±n SQL sorgusu kolonlarÄ± â†’ Excel baÅŸlÄ±klarÄ±
        "cari_firma_adi": "TedarikÃ§i AdÄ±",              # Zorunlu
        "stok_fisi_ortalama_fiyati": "Fiyat",            # Zorunlu (veya "Birim Fiyat")
        "gecikme_gun": "Teslim SÃ¼resi",                  # Zorunlu
        # Ä°ade kolonu SQL'de yok - sistem otomatik 0 deÄŸeri atayacak
        
        # Ek kolonlar
        "stok_kodu": "Stok Kodu",
        "siparis_miktari": "SipariÅŸ MiktarÄ±",
        "kalan_miktar": "Kalan Miktar",
        "toplam_net_miktar": "Miktar",
        "cari_adres": "Adres",
        
        # Not: SQL sorgunuzda ÅŸu kolonlar eksik (eklerseniz daha iyi sonuÃ§ alÄ±rsÄ±nÄ±z):
        # - Tarih (sf.tarih AS tarih)
        # - Åehir (c.sehir AS sehir veya city)
        # - Mail (c.email AS mail)
        # - Kategori (s.kategori AS kategori)
        # - Stok Grubu (s.grup AS stok_grubu)
        # - SipariÅŸ No (sf.siparis_no AS siparis_no)
        # - gsm (c.telefon AS gsm)
    },
    "reklamasyon": {
        # "sql_kolon_adi": "hedef_kolon_adi"
        # Ã–rnek: "complaint_date": "FiÅŸ Tarihi"
    },
    "stok": {
        # "sql_kolon_adi": "hedef_kolon_adi"
        # Ã–rnek: "stock_code": "Stok Kodu"
    }
}

# TÃ¼rkiye Ä°l KoordinatlarÄ± (Statik VeritabanÄ±)
TR_CITIES = {
    "adana": (37.0000, 35.3213), "adiyaman": (37.7648, 38.2786), "afyon": (38.7507, 30.5567), "agri": (39.7191, 43.0503),
    "aksaray": (38.3687, 34.0370), "amasya": (40.6499, 35.8353), "ankara": (39.9334, 32.8597), "antalya": (36.8969, 30.7133),
    "ardahan": (41.1105, 42.7022), "artvin": (41.1828, 41.8183), "aydin": (37.8560, 27.8416), "balikesir": (39.6484, 27.8826),
    "bartin": (41.6344, 32.3375), "batman": (37.8812, 41.1228), "bayburt": (40.2552, 40.2249), "bilecik": (40.1451, 29.9798),
    "bingol": (38.8851, 40.4983), "bitlis": (38.4006, 42.1095), "bolu": (40.7392, 31.6087), "burdur": (37.7204, 30.2908),
    "bursa": (40.1885, 29.0610), "canakkale": (40.1553, 26.4142), "cankiri": (40.6013, 33.6134), "corum": (40.5506, 34.9556),
    "denizli": (37.7765, 29.0864), "diyarbakir": (37.9144, 40.2306), "duzce": (40.8438, 31.1565), "edirne": (41.6768, 26.5604),
    "elazig": (38.6810, 39.2260), "erzincan": (39.7500, 39.5000), "erzurum": (39.9000, 41.2700), "eskisehir": (39.7767, 30.5206),
    "gaziantep": (37.0662, 37.3833), "giresun": (40.9128, 38.3895), "gumushane": (40.4600, 39.4700), "hakkari": (37.5833, 43.7333),
    "hatay": (36.4018, 36.3498), "igdir": (39.9167, 44.0333), "isparta": (37.7648, 30.5566), "istanbul": (41.0082, 28.9784),
    "izmir": (38.4192, 27.1287), "kahramanmaras": (37.5858, 36.9371), "karabuk": (41.2061, 32.6204), "karaman": (37.1759, 33.2287),
    "kars": (40.6167, 43.1000), "kastamonu": (41.3887, 33.7827), "kayseri": (38.7312, 35.4787), "kirikkale": (39.8468, 33.5153),
    "kirklareli": (41.7333, 27.2167), "kirsehir": (39.1425, 34.1709), "kilis": (36.7184, 37.1212), "kocaeli": (40.8533, 29.8815),
    "konya": (37.8667, 32.4833), "kutahya": (39.4167, 29.9833), "malatya": (38.3552, 38.3095), "manisa": (38.6191, 27.4289),
    "mardin": (37.3212, 40.7245), "mersin": (36.8000, 34.6333), "mugla": (37.2153, 28.3636), "mus": (38.7432, 41.5064),
    "nevsehir": (38.6244, 34.7144), "nigde": (37.9667, 34.6833), "ordu": (40.9839, 37.8764), "osmaniye": (37.0742, 36.2476),
    "rize": (41.0201, 40.5234), "sakarya": (40.7569, 30.3783), "samsun": (41.2928, 36.3313), "siirt": (37.9333, 41.9500),
    "sinop": (42.0231, 35.1531), "sivas": (39.7477, 37.0179), "sanliurfa": (37.1591, 38.7969), "sirnak": (37.5164, 42.4611),
    "tekirdag": (40.9833, 27.5167), "tokat": (40.3167, 36.5500), "trabzon": (41.0015, 39.7178), "tunceli": (39.1079, 39.5401),
    "usak": (38.6823, 29.4082), "van": (38.4891, 43.4089), "yalova": (40.6500, 29.2667), "yozgat": (39.8181, 34.8147),
    "zonguldak": (41.4564, 31.7987)
}

# Global deÄŸiÅŸkenler
df_global = None
tedarikci_col_global = None
phone_col_global = None # Telefon Kolonu (YENÄ°)
stok_grup_col_global = None # Stok Grubu Kolonu (YENÄ°)
detay_sonuc_global = None # Detay SonuÃ§lar (YENÄ°)
market_averages_global = None # Pazar OrtalamalarÄ± (YENÄ°)
observer = None
monitoring_folder = None
status_label = None
file_paths_global = []
ai_progress_bar = None
all_stock_codes = []
all_stock_groups = []
supplier_listbox = None
comparison_frame = None
ai_status_label = None
gif_label = None
gif_frames = []
gif_index = 0
sonuc_global = None
message_global = None
fig_global = None
grafik_ozet_global = ""
trend_fig_global = None
forecast_fig_global = None
map_widget = None
destination_marker = None
start_marker = None
supplier_markers = []
route_info_label = None
chat_history_text = None
karne_combobox = None
frame_karne_content = None
ocr_image_label = None
ocr_result_text = None
ocr_df_global = None
ocr_json_data = None # OCR JSON Verisi (YENÄ°)
ocr_order_combobox = None # OCR SipariÅŸ SeÃ§imi (YENÄ°)
order_treeview = None
order_ai_text = None
siparis_stok_combobox = None
siparis_grup_combobox = None
siparis_search_type_var = None
negotiator_combobox = None 
negotiator_text = None 
tone_combobox = None 
outliers_global = None 
news_scroll_canvas = None # Haberler iÃ§in
ticker_label = None # Ticker iÃ§in

# Reklamasyon YÃ¶netimi Global DeÄŸiÅŸkenler
df_reklamasyon_global = None
defect_images_rek = []

# Stok YÃ¶netimi Global DeÄŸiÅŸkenler
df_stok_global = None

# Ãœretim Takibi Global DeÄŸiÅŸkenler
production_orders_global = {}
gantt_canvas_global = None

# Hammadde Fiyat Ä°stihbaratÄ± Global DeÄŸiÅŸkenler
commodity_prices_global = {}
commodity_history_global = {}

# Frame YÃ¶netimi Global DeÄŸiÅŸkenler
frames = {} 
menu_buttons = {} 
current_page_name = None

# ---------- GELÄ°ÅMÄ°Å LOGLAMa VE AKTÄ°VÄ°TE TAKÄ°P SÄ°STEMÄ° ----------
class ActivityLogger:
    """DetaylÄ± kullanÄ±cÄ± aktivite loglama ve raporlama sistemi"""
    
    def __init__(self):
        self.user_name = getpass.getuser()
        self.machine_name = socket.gethostname()
        self.session_start = datetime.datetime.now()
        self.log_file = f"activity_logs_{datetime.date.today()}.json"
        self.activity_data = defaultdict(lambda: {
            'clicks': 0,
            'first_access': None,
            'last_access': None,
            'time_spent': 0,
            'actions': []
        })
        self.session_data = []
        
        # Logging configuration
        logging.basicConfig(
            filename=f'system_log_{datetime.date.today()}.log',
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S'
        )
        
        # Session baÅŸlangÄ±cÄ±
        self.log_event("SESSION_START", f"KullanÄ±cÄ±: {self.user_name}, Makine: {self.machine_name}")
        logging.info(f"=== YENÄ° OTURUM BAÅLADI === User: {self.user_name}, Host: {self.machine_name}")
        
    def log_event(self, event_type, details, page=None):
        """Olay loglama"""
        timestamp = datetime.datetime.now()
        
        event_data = {
            'timestamp': timestamp.strftime('%Y-%m-%d %H:%M:%S'),
            'user': self.user_name,
            'machine': self.machine_name,
            'event_type': event_type,
            'page': page or current_page_name,
            'details': details
        }
        
        self.session_data.append(event_data)
        logging.info(f"{event_type} | {page or 'N/A'} | {details}")
        
        # Save to JSON file
        self._save_to_file()
        
    def log_page_visit(self, page_name):
        """Sayfa ziyareti loglama"""
        timestamp = datetime.datetime.now()
        
        if self.activity_data[page_name]['first_access'] is None:
            self.activity_data[page_name]['first_access'] = timestamp
        
        self.activity_data[page_name]['last_access'] = timestamp
        self.activity_data[page_name]['clicks'] += 1
        
        self.log_event("PAGE_VISIT", f"Sayfa aÃ§Ä±ldÄ±: {page_name}", page_name)
        
    def log_button_click(self, button_name, page=None):
        """Buton tÄ±klama loglama"""
        self.log_event("BUTTON_CLICK", f"Buton: {button_name}", page)
        
    def log_data_load(self, file_name, record_count, page=None):
        """Veri yÃ¼kleme loglama"""
        self.log_event("DATA_LOAD", f"Dosya: {file_name}, KayÄ±t: {record_count}", page)
        
    def log_export(self, export_type, file_name, page=None):
        """Export iÅŸlemi loglama"""
        self.log_event("EXPORT", f"Tip: {export_type}, Dosya: {file_name}", page)
        
    def log_email_sent(self, recipient, subject, page=None):
        """Email gÃ¶nderimi loglama"""
        self.log_event("EMAIL_SENT", f"AlÄ±cÄ±: {recipient}, Konu: {subject}", page)
        
    def log_analysis(self, analysis_type, details, page=None):
        """Analiz iÅŸlemi loglama"""
        self.log_event("ANALYSIS", f"Tip: {analysis_type}, Detay: {details}", page)
    
    def log_phone_call(self, supplier_name, phone_number, page=None):
        """Telefon aramasÄ± loglama"""
        self.log_event("PHONE_CALL", f"TedarikÃ§i: {supplier_name}, Telefon: {phone_number}", page)
    
    def log_whatsapp_message(self, supplier_name, phone_number, message_preview, page=None):
        """WhatsApp mesajÄ± loglama"""
        self.log_event("WHATSAPP_MESSAGE", f"TedarikÃ§i: {supplier_name}, Telefon: {phone_number}, Mesaj: {message_preview[:50]}...", page)
        
    def log_error(self, error_message, page=None):
        """Hata loglama"""
        self.log_event("ERROR", error_message, page)
        logging.error(f"HATA | {page or 'N/A'} | {error_message}")
        
    def _save_to_file(self):
        """Log verilerini dosyaya kaydet"""
        try:
            # Mevcut verileri oku
            if os.path.exists(self.log_file):
                with open(self.log_file, 'r', encoding='utf-8') as f:
                    existing_data = json.load(f)
            else:
                existing_data = []
            
            # Yeni verileri ekle
            existing_data.extend(self.session_data)
            
            # Dosyaya yaz
            with open(self.log_file, 'w', encoding='utf-8') as f:
                json.dump(existing_data, f, ensure_ascii=False, indent=2)
            
            # Session data'yÄ± temizle (Ã§ift kayÄ±t olmamasÄ± iÃ§in)
            self.session_data = []
            
        except Exception as e:
            logging.error(f"Log dosyasÄ±na yazma hatasÄ±: {str(e)}")
    
    def get_session_duration(self):
        """Oturum sÃ¼resini hesapla"""
        duration = datetime.datetime.now() - self.session_start
        return duration
    
    def generate_daily_report(self):
        """GÃ¼nlÃ¼k aktivite raporu oluÅŸtur"""
        try:
            # Log dosyasÄ±nÄ± oku
            if not os.path.exists(self.log_file):
                return "BugÃ¼n iÃ§in log verisi bulunamadÄ±."
            
            with open(self.log_file, 'r', encoding='utf-8') as f:
                logs = json.load(f)
            
            # Ä°statistikleri hesapla
            page_stats = defaultdict(int)
            button_clicks = defaultdict(int)
            data_loads = []
            exports = []
            emails = []
            errors = []
            phone_calls = []
            whatsapp_messages = []
            
            for log in logs:
                event_type = log.get('event_type')
                page = log.get('page', 'N/A')
                
                if event_type == 'PAGE_VISIT':
                    page_stats[page] += 1
                elif event_type == 'BUTTON_CLICK':
                    button_clicks[log['details']] += 1
                elif event_type == 'DATA_LOAD':
                    data_loads.append(log)
                elif event_type == 'EXPORT':
                    exports.append(log)
                elif event_type == 'EMAIL_SENT':
                    emails.append(log)
                elif event_type == 'PHONE_CALL':
                    phone_calls.append(log)
                elif event_type == 'WHATSAPP_MESSAGE':
                    whatsapp_messages.append(log)
                elif event_type == 'ERROR':
                    errors.append(log)
            
            # Rapor HTML'i oluÅŸtur
            report_html = f"""
            <html>
            <head>
                <style>
                    body {{ font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }}
                    .header {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; }}
                    .header h1 {{ margin: 0; font-size: 28px; }}
                    .header p {{ margin: 5px 0 0 0; opacity: 0.9; }}
                    .section {{ background: white; padding: 20px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }}
                    .section h2 {{ color: #667eea; margin-top: 0; border-bottom: 2px solid #667eea; padding-bottom: 10px; }}
                    .stat-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }}
                    .stat-card {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }}
                    .stat-card .number {{ font-size: 32px; font-weight: bold; margin: 10px 0; }}
                    .stat-card .label {{ font-size: 14px; opacity: 0.9; }}
                    table {{ width: 100%; border-collapse: collapse; margin: 10px 0; }}
                    th {{ background-color: #667eea; color: white; padding: 12px; text-align: left; }}
                    td {{ padding: 10px; border-bottom: 1px solid #eee; }}
                    tr:hover {{ background-color: #f9f9f9; }}
                    .time {{ color: #888; font-size: 0.9em; }}
                    .error {{ color: #e74c3c; font-weight: bold; }}
                    .success {{ color: #27ae60; font-weight: bold; }}
                    .warning {{ color: #f39c12; }}
                    .footer {{ text-align: center; color: #888; margin-top: 30px; padding: 20px; }}
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>ğŸ“Š GÃ¼nlÃ¼k Aktivite Raporu</h1>
                    <p>KullanÄ±cÄ±: <strong>{self.user_name}</strong> | Makine: <strong>{self.machine_name}</strong></p>
                    <p>Tarih: <strong>{datetime.date.today().strftime('%d.%m.%Y')}</strong> | Rapor Saati: <strong>{datetime.datetime.now().strftime('%H:%M:%S')}</strong></p>
                </div>
                
                <div class="section">
                    <h2>ğŸ“ˆ Genel Ä°statistikler</h2>
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="number">{len(logs)}</div>
                            <div class="label">Toplam Aktivite</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(page_stats)}</div>
                            <div class="label">Ziyaret Edilen Sayfa</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{sum(page_stats.values())}</div>
                            <div class="label">Toplam Sayfa TÄ±klama</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(exports)}</div>
                            <div class="label">Export Ä°ÅŸlemi</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(emails)}</div>
                            <div class="label">GÃ¶nderilen Mail</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(phone_calls)}</div>
                            <div class="label">Telefon AramasÄ±</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(whatsapp_messages)}</div>
                            <div class="label">WhatsApp MesajÄ±</div>
                        </div>
                        <div class="stat-card">
                            <div class="number">{len(errors)}</div>
                            <div class="label">Hata SayÄ±sÄ±</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>ğŸ–±ï¸ Sayfa Ziyaret Ä°statistikleri</h2>
                    <table>
                        <tr>
                            <th>Sayfa AdÄ±</th>
                            <th>Ziyaret SayÄ±sÄ±</th>
                            <th>YÃ¼zde</th>
                        </tr>
            """
            
            total_visits = sum(page_stats.values())
            for page, count in sorted(page_stats.items(), key=lambda x: x[1], reverse=True):
                percentage = (count / total_visits * 100) if total_visits > 0 else 0
                report_html += f"""
                        <tr>
                            <td>{page}</td>
                            <td><strong>{count}</strong></td>
                            <td><span class="warning">{percentage:.1f}%</span></td>
                        </tr>
                """
            
            report_html += """
                    </table>
                </div>
            """
            
            # Veri yÃ¼kleme iÅŸlemleri
            if data_loads:
                report_html += """
                <div class="section">
                    <h2>ğŸ“‚ Veri YÃ¼kleme Ä°ÅŸlemleri</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Detaylar</th>
                        </tr>
                """
                for log in data_loads:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="success">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            # Export iÅŸlemleri
            if exports:
                report_html += """
                <div class="section">
                    <h2>ğŸ’¾ Export Ä°ÅŸlemleri</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Detaylar</th>
                        </tr>
                """
                for log in exports:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="success">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            # Email gÃ¶nderimler
            if emails:
                report_html += """
                <div class="section">
                    <h2>ğŸ“§ Email GÃ¶nderim Ä°ÅŸlemleri</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Detaylar</th>
                        </tr>
                """
                for log in emails:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="success">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            # Telefon AramalarÄ±
            if phone_calls:
                report_html += """
                <div class="section">
                    <h2>ğŸ“ Telefon AramalarÄ±</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Detaylar</th>
                        </tr>
                """
                for log in phone_calls:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="success">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            # WhatsApp MesajlarÄ±
            if whatsapp_messages:
                report_html += """
                <div class="section">
                    <h2>ğŸ’¬ WhatsApp MesajlarÄ±</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Detaylar</th>
                        </tr>
                """
                for log in whatsapp_messages:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="success">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            # Hatalar
            if errors:
                report_html += """
                <div class="section">
                    <h2>âš ï¸ Hata KayÄ±tlarÄ±</h2>
                    <table>
                        <tr>
                            <th>Zaman</th>
                            <th>Sayfa</th>
                            <th>Hata MesajÄ±</th>
                        </tr>
                """
                for log in errors:
                    report_html += f"""
                        <tr>
                            <td class="time">{log['timestamp']}</td>
                            <td>{log['page']}</td>
                            <td class="error">{log['details']}</td>
                        </tr>
                    """
                report_html += """
                    </table>
                </div>
                """
            
            report_html += """
                <div class="footer">
                    <p>Bu rapor <strong>Tedarik ve Reklamasyon YÃ¶netim Sistemi</strong> tarafÄ±ndan otomatik olarak oluÅŸturulmuÅŸtur.</p>
                    <p>Â© 2026 DeFacto - Tedarik Zinciri Ekibi</p>
                </div>
            </body>
            </html>
            """
            
            return report_html
            
        except Exception as e:
            logging.error(f"Rapor oluÅŸturma hatasÄ±: {str(e)}")
            return f"Rapor oluÅŸturulurken hata: {str(e)}"
    
    def send_daily_report_email(self):
        """GÃ¼nlÃ¼k raporu email ile gÃ¶nder"""
        try:
            report_html = self.generate_daily_report()
            
            # Email oluÅŸtur
            msg = MIMEMultipart('related')
            msg['Subject'] = f"GÃ¼nlÃ¼k Aktivite Raporu - {datetime.date.today().strftime('%d.%m.%Y')} - {self.user_name}"
            msg['From'] = GMAIL_USER
            msg['To'] = GMAIL_RECEIVER_LOGS
            
            msg_alternative = MIMEMultipart('alternative')
            msg.attach(msg_alternative)
            msg_alternative.attach(MIMEText(report_html, 'html'))
            
            # JSON log dosyasÄ±nÄ± ekle
            if os.path.exists(self.log_file):
                with open(self.log_file, 'rb') as f:
                    part = MIMEBase('application', 'json')
                    part.set_payload(f.read())
                    encoders.encode_base64(part)
                    part.add_header('Content-Disposition', f'attachment; filename="{self.log_file}"')
                    msg.attach(part)
            
            # GÃ¶nder
            server = smtplib.SMTP('smtp.gmail.com', 587)
            server.starttls()
            server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
            server.send_message(msg)
            server.quit()
            
            logging.info(f"GÃ¼nlÃ¼k rapor email ile gÃ¶nderildi: {GMAIL_RECEIVER_LOGS}")
            return True
            
        except Exception as e:
            logging.error(f"Email gÃ¶nderme hatasÄ±: {str(e)}")
            return False
    
    def close_session(self):
        """Oturumu kapat ve son raporu gÃ¶nder"""
        duration = self.get_session_duration()
        self.log_event("SESSION_END", f"Oturum sÃ¼resi: {duration}")
        logging.info(f"=== OTURUM SONLANDI === SÃ¼re: {duration}")
        
        # Son verileri kaydet
        self._save_to_file()

# Global activity logger
activity_logger = None

# ---------- BACKUP VE GERÄ° YÃœKLEME SÄ°STEMÄ° ----------
def create_backup():
    """
    TÃ¼m ayarlarÄ± ve Ã¶nemli verileri yedekler
    """
    try:
        backup_dir = Path("backups")
        backup_dir.mkdir(exist_ok=True)
        
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_name = f"tedarik_ai_backup_{timestamp}.zip"
        backup_path = backup_dir / backup_name
        
        # Yedeklenecek dosyalar
        files_to_backup = []
        
        # Ayar dosyasÄ±
        if os.path.exists(SETTINGS_FILE):
            files_to_backup.append(SETTINGS_FILE)
        
        # Activity log dosyasÄ±
        if os.path.exists("activity_log.json"):
            files_to_backup.append("activity_log.json")
        
        # Zip arÅŸivi oluÅŸtur
        with zipfile.ZipFile(backup_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for file in files_to_backup:
                if os.path.exists(file):
                    zipf.write(file, arcname=os.path.basename(file))
            
            # Metadata ekle
            metadata = {
                "backup_date": datetime.datetime.now().isoformat(),
                "version": "1.0",
                "files": [os.path.basename(f) for f in files_to_backup]
            }
            zipf.writestr("backup_info.json", json.dumps(metadata, indent=2))
        
        # Eski yedekleri temizle (30 gÃ¼nden eski)
        cleanup_old_backups(backup_dir, days=30)
        
        messagebox.showinfo("Yedekleme BaÅŸarÄ±lÄ±", 
                          f"âœ… Yedek oluÅŸturuldu!\n\nDosya: {backup_name}\n\nKonum: {backup_dir}")
        
        if activity_logger:
            activity_logger.log_event("BACKUP_CREATED", f"Yedek dosyasÄ±: {backup_name}")
        
        return True
        
    except Exception as e:
        messagebox.showerror("Yedekleme HatasÄ±", f"Yedek oluÅŸturulamadÄ±:\n{str(e)}")
        if activity_logger:
            activity_logger.log_error(f"Yedekleme hatasÄ±: {str(e)}")
        return False

def restore_backup():
    """
    Yedek dosyasÄ±ndan ayarlarÄ± geri yÃ¼kler
    """
    try:
        backup_file = filedialog.askopenfilename(
            title="Yedek DosyasÄ± SeÃ§",
            filetypes=[("Zip DosyalarÄ±", "*.zip"), ("TÃ¼m Dosyalar", "*.*")],
            initialdir="backups" if os.path.exists("backups") else "."
        )
        
        if not backup_file:
            return False
        
        # Onay al
        result = messagebox.askyesno("Geri YÃ¼kleme OnayÄ±",
                                     "Mevcut ayarlar yedek dosya ile deÄŸiÅŸtirilecek.\n\n"
                                     "Devam etmek istiyor musunuz?")
        if not result:
            return False
        
        # Zip dosyasÄ±nÄ± aÃ§
        with zipfile.ZipFile(backup_file, 'r') as zipf:
            # Metadata'yÄ± oku
            try:
                metadata_content = zipf.read("backup_info.json")
                metadata = json.loads(metadata_content)
                backup_date = metadata.get("backup_date", "Bilinmiyor")
            except:
                backup_date = "Bilinmiyor"
            
            # TÃ¼m dosyalarÄ± Ã§Ä±kar
            zipf.extractall(".")
        
        messagebox.showinfo("Geri YÃ¼kleme BaÅŸarÄ±lÄ±",
                          f"âœ… Yedek geri yÃ¼klendi!\n\nYedek tarihi: {backup_date}\n\n"
                          f"Program yeniden baÅŸlatÄ±lmalÄ±.")
        
        if activity_logger:
            activity_logger.log_event("BACKUP_RESTORED", f"Yedek dosyasÄ±: {os.path.basename(backup_file)}")
        
        return True
        
    except Exception as e:
        messagebox.showerror("Geri YÃ¼kleme HatasÄ±", f"Yedek geri yÃ¼klenemedi:\n{str(e)}")
        if activity_logger:
            activity_logger.log_error(f"Geri yÃ¼kleme hatasÄ±: {str(e)}")
        return False

def cleanup_old_backups(backup_dir, days=30):
    """
    Eski yedekleri temizler
    """
    try:
        cutoff_time = datetime.datetime.now() - datetime.timedelta(days=days)
        
        for backup_file in backup_dir.glob("tedarik_ai_backup_*.zip"):
            file_time = datetime.datetime.fromtimestamp(backup_file.stat().st_mtime)
            if file_time < cutoff_time:
                backup_file.unlink()
                print(f"Eski yedek silindi: {backup_file.name}")
    except Exception as e:
        print(f"Yedek temizleme hatasÄ±: {str(e)}")

def auto_backup_schedule():
    """
    Otomatik yedekleme planla
    """
    # Her gÃ¼n saat 18:00'de otomatik yedek al
    schedule.every().day.at("18:00").do(create_backup)
    print("Otomatik yedekleme planlandÄ±: Her gÃ¼n 18:00")

# ---------- MASAÃœSTÃœ BÄ°LDÄ°RÄ°M SÄ°STEMÄ° ----------
def show_desktop_notification(title, message, timeout=10):
    """
    MasaÃ¼stÃ¼ bildirimi gÃ¶sterir
    """
    if not NOTIFICATION_AVAILABLE:
        print(f"[Bildirim] {title}: {message}")
        return
    
    try:
        notification.notify(
            title=title,
            message=message,
            app_name="Tedarik AI",
            timeout=timeout
        )
    except Exception as e:
        print(f"Bildirim hatasÄ±: {str(e)}")

def notify_expiring_contracts(days_threshold=15):
    """
    SÃ¼resi dolmak Ã¼zere olan sÃ¶zleÅŸmeler iÃ§in bildirim gÃ¶nderir
    """
    try:
        records = load_cari_bilgiler()
        expiring_count = 0
        
        for record in records:
            sozlesme_str = str(record.get('SÃ¶zleÅŸme BitiÅŸ Tarihi', '')).strip()
            if sozlesme_str and sozlesme_str not in ['', 'nan', 'None', 'NaT']:
                try:
                    sozlesme_date = pd.to_datetime(sozlesme_str).date()
                    days_left = (sozlesme_date - datetime.date.today()).days
                    
                    if 0 < days_left <= days_threshold:
                        expiring_count += 1
                except:
                    pass
        
        if expiring_count > 0:
            show_desktop_notification(
                "âš ï¸ SÃ¶zleÅŸme UyarÄ±sÄ±",
                f"{expiring_count} adet sÃ¶zleÅŸme {days_threshold} gÃ¼n iÃ§inde dolacak!"
            )
            
            if activity_logger:
                activity_logger.log_event("CONTRACT_WARNING", 
                                        f"{expiring_count} sÃ¶zleÅŸme yakÄ±nda dolacak")
    except Exception as e:
        print(f"SÃ¶zleÅŸme bildirimi hatasÄ±: {str(e)}")

def notify_critical_alerts():
    """
    Kritik alarmlar iÃ§in masaÃ¼stÃ¼ bildirimi
    """
    try:
        records = load_cari_bilgiler()
        expired_count = 0
        
        for record in records:
            sozlesme_str = str(record.get('SÃ¶zleÅŸme BitiÅŸ Tarihi', '')).strip()
            if sozlesme_str and sozlesme_str not in ['', 'nan', 'None', 'NaT']:
                try:
                    sozlesme_date = pd.to_datetime(sozlesme_str).date()
                    days_left = (sozlesme_date - datetime.date.today()).days
                    
                    if days_left < 0:
                        expired_count += 1
                except:
                    pass
        
        if expired_count > 0:
            show_desktop_notification(
                "ğŸ”´ Kritik UyarÄ±!",
                f"{expired_count} adet sÃ¶zleÅŸme sÃ¼resi dolmuÅŸ!"
            )
    except Exception as e:
        print(f"Kritik alarm bildirimi hatasÄ±: {str(e)}")

# ---------- MYSQL BAÄLANTI FONKSÄ°YONLARI ----------
def create_mysql_connection():
    """
    MySQL baÄŸlantÄ±sÄ± oluÅŸturur.
    
    Returns:
        connection: MySQL baÄŸlantÄ± nesnesi veya None
    """
    if not MYSQL_AVAILABLE:
        messagebox.showerror("Hata", "MySQL Connector kÃ¼tÃ¼phanesi yÃ¼klÃ¼ deÄŸil.\nLÃ¼tfen 'pip install mysql-connector-python' komutunu Ã§alÄ±ÅŸtÄ±rÄ±n.")
        return None
    
    # YapÄ±landÄ±rma kontrolÃ¼
    if not all([MYSQL_CONFIG.get("host"), MYSQL_CONFIG.get("user"), MYSQL_CONFIG.get("database")]):
        messagebox.showerror("Hata", "MySQL baÄŸlantÄ± bilgileri eksik!\n\nLÃ¼tfen kodda MYSQL_CONFIG deÄŸerlerini doldurun:\n- host\n- user\n- password\n- database")
        return None
    
    try:
        connection = mysql.connector.connect(
            host=MYSQL_CONFIG["host"],
            user=MYSQL_CONFIG["user"],
            password=MYSQL_CONFIG["password"],
            database=MYSQL_CONFIG["database"],
            raise_on_warnings=MYSQL_CONFIG.get("raise_on_warnings", True)
        )
        
        if connection.is_connected():
            if activity_logger:
                activity_logger.log_event("MYSQL_CONNECT", f"BaÅŸarÄ±yla baÄŸlandÄ±: {MYSQL_CONFIG['database']}", "MySQL")
            return connection
    except mysql.connector.Error as err:
        error_msg = f"MySQL baÄŸlantÄ± hatasÄ±: {err}"
        messagebox.showerror("MySQL HatasÄ±", error_msg)
        if activity_logger:
            activity_logger.log_error(error_msg, "MySQL")
        return None

def load_data_from_mysql(query=None, table_name=None):
    """
    MySQL veritabanÄ±ndan veri yÃ¼kler ve pandas DataFrame dÃ¶ndÃ¼rÃ¼r.
    
    Args:
        query: SQL sorgusu (opsiyonel)
        table_name: Tablo adÄ± (query yoksa kullanÄ±lÄ±r)
    
    Returns:
        pd.DataFrame: YÃ¼klenen veri veya None
    """
    connection = create_mysql_connection()
    if not connection:
        return None
    
    try:
        # Sorgu oluÅŸtur
        if query is None:
            if table_name is None:
                messagebox.showerror("Hata", "SQL sorgusu veya tablo adÄ± belirtilmeli!")
                return None
            query = f"SELECT * FROM {table_name}"
        
        # Veriyi oku
        df = pd.read_sql(query, connection)
        
        # LOG: Veri yÃ¼klendi
        if activity_logger:
            activity_logger.log_data_load(f"MySQL: {table_name or 'Custom Query'}", len(df), "MySQL")
        
        messagebox.showinfo("BaÅŸarÄ±lÄ±", f"MySQL'den {len(df)} kayÄ±t yÃ¼klendi!")
        return df
        
    except mysql.connector.Error as err:
        error_msg = f"MySQL veri okuma hatasÄ±: {err}"
        messagebox.showerror("MySQL HatasÄ±", error_msg)
        if activity_logger:
            activity_logger.log_error(error_msg, "MySQL")
        return None
    except Exception as e:
        error_msg = f"Veri iÅŸleme hatasÄ±: {str(e)}"
        messagebox.showerror("Hata", error_msg)
        if activity_logger:
            activity_logger.log_error(error_msg, "MySQL")
        return None
    finally:
        if connection and connection.is_connected():
            connection.close()
            if activity_logger:
                activity_logger.log_event("MYSQL_DISCONNECT", "BaÄŸlantÄ± kapatÄ±ldÄ±", "MySQL")

def apply_column_mappings(df, data_type):
    """
    SQL sorgusundan gelen kolon isimlerini uygulama beklentilerine gÃ¶re eÅŸleÅŸtirir.
    
    Args:
        df: pandas DataFrame - MySQL'den yÃ¼klenen veri
        data_type: str - Veri tipi ("tedarik_analiz", "reklamasyon", "stok")
    
    Returns:
        pd.DataFrame: Kolon isimleri eÅŸleÅŸtirilmiÅŸ DataFrame
    """
    if data_type not in MYSQL_COLUMN_MAPPINGS:
        return df
    
    mappings = MYSQL_COLUMN_MAPPINGS[data_type]
    if not mappings:
        return df
    
    # Kolon isimlerini eÅŸleÅŸtir
    rename_dict = {}
    for sql_col, target_col in mappings.items():
        if sql_col in df.columns:
            rename_dict[sql_col] = target_col
    
    if rename_dict:
        df = df.rename(columns=rename_dict)
        if activity_logger:
            activity_logger.log_event("COLUMN_MAPPING", 
                                     f"{data_type}: {len(rename_dict)} kolon eÅŸleÅŸtirildi", 
                                     "MySQL")
    
    return df

def mysql_query_dialog():
    """
    MySQL sorgu penceresi aÃ§ar ve kullanÄ±cÄ±dan sorgu veya tablo adÄ± alÄ±r.
    """
    if not MYSQL_AVAILABLE:
        messagebox.showerror("Hata", "MySQL Connector kÃ¼tÃ¼phanesi yÃ¼klÃ¼ deÄŸil!\nLÃ¼tfen 'pip install mysql-connector-python' komutunu Ã§alÄ±ÅŸtÄ±rÄ±n.")
        return
    
    # Sorgu penceresi oluÅŸtur
    query_window = tk.Toplevel()
    query_window.title("MySQL'den Veri YÃ¼kle")
    query_window.geometry("600x400")
    
    # BaÅŸlÄ±k
    tk.Label(query_window, text="ğŸ—„ï¸ MySQL VeritabanÄ±ndan Veri YÃ¼kleme", font=("Segoe UI", 14, "bold")).pack(pady=10)
    
    # BaÄŸlantÄ± durumu
    config_frame = tk.Frame(query_window, bg="#e8f5e9", padx=10, pady=10)
    config_frame.pack(fill="x", padx=20, pady=5)
    
    config_status = f"ğŸ”§ YapÄ±landÄ±rma:\nHost: {MYSQL_CONFIG['host'] or 'âŒ BoÅŸ'}\nDatabase: {MYSQL_CONFIG['database'] or 'âŒ BoÅŸ'}\nUser: {MYSQL_CONFIG['user'] or 'âŒ BoÅŸ'}"
    tk.Label(config_frame, text=config_status, bg="#e8f5e9", justify="left", font=("Courier", 9)).pack(anchor="w")
    
    # SeÃ§enek 1: Tablo adÄ±
    tk.Label(query_window, text="SeÃ§enek 1: Tablo AdÄ±", font=("Segoe UI", 11, "bold")).pack(anchor="w", padx=20, pady=(15,5))
    table_frame = tk.Frame(query_window)
    table_frame.pack(fill="x", padx=20, pady=5)
    
    tk.Label(table_frame, text="Tablo:").pack(side="left", padx=5)
    table_entry = ttk.Entry(table_frame, width=30)
    table_entry.pack(side="left", padx=5)
    table_entry.insert(0, "tedarikci_verileri")
    
    def load_from_table():
        table_name = table_entry.get().strip()
        if not table_name:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen tablo adÄ± girin!")
            return
        
        query_window.destroy()
        
        # Arka planda veri yÃ¼kle
        def load_thread():
            df = load_data_from_mysql(table_name=table_name)
            if df is not None:
                # GeÃ§ici CSV olarak kaydet ve analiz et
                import tempfile
                with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False, encoding='utf-8') as tmp:
                    df.to_csv(tmp.name, index=False)
                    temp_file = tmp.name
                
                global file_paths_global, all_stock_codes
                file_paths_global = [temp_file]
                root.after(0, lambda: set_status(f"MySQL'den {len(df)} kayÄ±t yÃ¼klendi."))
                
                # Stok kodlarÄ±nÄ± Ã§Ä±kar
                try:
                    stok_col_temp = find_stok_kodu_column(df)
                    if stok_col_temp:
                        unique_kodlar = sorted(df[stok_col_temp].dropna().unique())
                        all_stock_codes = ["TÃ¼m Veri"] + list(unique_kodlar)
                        root.after(0, lambda: stok_kod_combobox.configure(values=all_stock_codes, state="normal"))
                        root.after(0, lambda: stok_kod_combobox.set("TÃ¼m Veri"))
                except:
                    pass
        
        threading.Thread(target=load_thread, daemon=True).start()
    
    ttk.Button(table_frame, text="ğŸ“¥ Tablodan YÃ¼kle", command=load_from_table).pack(side="left", padx=10)
    
    # SeÃ§enek 2: Ã–zel SQL sorgusu
    tk.Label(query_window, text="SeÃ§enek 2: Ã–zel SQL Sorgusu", font=("Segoe UI", 11, "bold")).pack(anchor="w", padx=20, pady=(15,5))
    
    query_text = tk.Text(query_window, wrap="word", font=("Courier", 10), height=6)
    query_text.pack(fill="both", expand=True, padx=20, pady=5)
    query_text.insert("1.0", "SELECT * FROM tedarikci_verileri WHERE tarih >= '2024-01-01'")
    
    def load_from_query():
        query = query_text.get("1.0", tk.END).strip()
        if not query:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen SQL sorgusu girin!")
            return
        
        query_window.destroy()
        
        # Arka planda veri yÃ¼kle
        def load_thread():
            df = load_data_from_mysql(query=query)
            if df is not None:
                # GeÃ§ici CSV olarak kaydet ve analiz et
                import tempfile
                with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False, encoding='utf-8') as tmp:
                    df.to_csv(tmp.name, index=False)
                    temp_file = tmp.name
                
                global file_paths_global, all_stock_codes
                file_paths_global = [temp_file]
                root.after(0, lambda: set_status(f"MySQL'den {len(df)} kayÄ±t yÃ¼klendi."))
                
                # Stok kodlarÄ±nÄ± Ã§Ä±kar
                try:
                    stok_col_temp = find_stok_kodu_column(df)
                    if stok_col_temp:
                        unique_kodlar = sorted(df[stok_col_temp].dropna().unique())
                        all_stock_codes = ["TÃ¼m Veri"] + list(unique_kodlar)
                        root.after(0, lambda: stok_kod_combobox.configure(values=all_stock_codes, state="normal"))
                        root.after(0, lambda: stok_kod_combobox.set("TÃ¼m Veri"))
                except:
                    pass
        
        threading.Thread(target=load_thread, daemon=True).start()
    
    # Buton Ã§ubuÄŸu
    btn_frame = tk.Frame(query_window)
    btn_frame.pack(fill="x", padx=20, pady=10)
    
    ttk.Button(btn_frame, text="ğŸ“¥ Sorguyu Ã‡alÄ±ÅŸtÄ±r ve YÃ¼kle", command=load_from_query).pack(side="left", padx=5)
    ttk.Button(btn_frame, text="âŒ Ä°ptal", command=query_window.destroy).pack(side="right", padx=5)

def mysql_unified_data_loader():
    """
    BirleÅŸik MySQL veri yÃ¼kleme penceresi - 3 veri tipi iÃ§in:
    1. Tedarik Analiz Verileri
    2. Reklamasyon Verileri
    3. Stok Verileri
    """
    if not MYSQL_AVAILABLE:
        messagebox.showerror("Hata", "MySQL Connector kÃ¼tÃ¼phanesi yÃ¼klÃ¼ deÄŸil!\nLÃ¼tfen 'pip install mysql-connector-python' komutunu Ã§alÄ±ÅŸtÄ±rÄ±n.")
        return
    
    # Ana pencere
    main_window = tk.Toplevel()
    main_window.title("MySQL Veri YÃ¼kleme Merkezi")
    main_window.geometry("900x700")
    
    # BaÅŸlÄ±k
    header_frame = tk.Frame(main_window, bg="#2c3e50", padx=20, pady=20)
    header_frame.pack(fill="x")
    tk.Label(header_frame, text="ğŸ—„ï¸ MySQL Veri YÃ¼kleme Merkezi", 
             font=("Segoe UI", 16, "bold"), fg="white", bg="#2c3e50").pack()
    tk.Label(header_frame, text="Tedarik Analiz, Reklamasyon ve Stok verilerinizi MySQL'den yÃ¼kleyin", 
             font=("Segoe UI", 10), fg="#ecf0f1", bg="#2c3e50").pack()
    
    # BaÄŸlantÄ± durumu
    config_frame = tk.Frame(main_window, bg="#e8f5e9", padx=15, pady=10)
    config_frame.pack(fill="x", padx=20, pady=10)
    
    config_status = f"ğŸ”§ MySQL YapÄ±landÄ±rmasÄ±:\n"
    config_status += f"  Host: {MYSQL_CONFIG['host'] or 'âŒ BoÅŸ - LÃ¼tfen yapÄ±landÄ±rÄ±n'}\n"
    config_status += f"  Database: {MYSQL_CONFIG['database'] or 'âŒ BoÅŸ - LÃ¼tfen yapÄ±landÄ±rÄ±n'}\n"
    config_status += f"  User: {MYSQL_CONFIG['user'] or 'âŒ BoÅŸ - LÃ¼tfen yapÄ±landÄ±rÄ±n'}"
    
    tk.Label(config_frame, text=config_status, bg="#e8f5e9", justify="left", 
             font=("Courier", 9)).pack(anchor="w")
    
    # Ana iÃ§erik alanÄ± (3 bÃ¶lÃ¼m)
    content_frame = tk.Frame(main_window, padx=20, pady=10)
    content_frame.pack(fill="both", expand=True)
    
    # --- BÃ–LÃœM 1: Tedarik Analiz Verileri ---
    section1 = tk.LabelFrame(content_frame, text="ğŸ“Š Tedarik Analiz Verileri", 
                             font=("Segoe UI", 11, "bold"), padx=15, pady=10)
    section1.pack(fill="both", expand=True, pady=5)
    
    tk.Label(section1, text="SQL Sorgusu:").pack(anchor="w")
    tedarik_query = tk.Text(section1, wrap="word", font=("Courier", 9), height=3)
    tedarik_query.pack(fill="x", pady=5)
    tedarik_query.insert("1.0", MYSQL_QUERIES["tedarik_analiz"])
    
    def load_tedarik_data():
        query = tedarik_query.get("1.0", tk.END).strip()
        if not query:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen SQL sorgusu girin!")
            return
        
        main_window.destroy()
        
        def load_thread():
            df = load_data_from_mysql(query=query)
            if df is not None:
                # Kolon eÅŸleÅŸtirmesi uygula
                df = apply_column_mappings(df, "tedarik_analiz")
                
                import tempfile
                with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False, encoding='utf-8') as tmp:
                    df.to_csv(tmp.name, index=False)
                    temp_file = tmp.name
                
                global file_paths_global, all_stock_codes
                file_paths_global = [temp_file]
                root.after(0, lambda: set_status(f"Tedarik Analiz: MySQL'den {len(df)} kayÄ±t yÃ¼klendi."))
                
                try:
                    stok_col_temp = find_stok_kodu_column(df)
                    if stok_col_temp:
                        unique_kodlar = sorted(df[stok_col_temp].dropna().unique())
                        all_stock_codes = ["TÃ¼m Veri"] + list(unique_kodlar)
                        root.after(0, lambda: stok_kod_combobox.configure(values=all_stock_codes, state="normal"))
                        root.after(0, lambda: stok_kod_combobox.set("TÃ¼m Veri"))
                except:
                    pass
                
                root.after(0, lambda: messagebox.showinfo("BaÅŸarÄ±lÄ±", "Tedarik analiz verileri yÃ¼klendi!\nÅimdi 'ANALÄ°ZÄ° BAÅLAT' butonuna tÄ±klayabilirsiniz."))
        
        threading.Thread(target=load_thread, daemon=True).start()
    
    ttk.Button(section1, text="ğŸ“¥ Tedarik Analiz Verilerini Getir", 
               command=load_tedarik_data).pack(fill="x", pady=5)
    
    # --- BÃ–LÃœM 2: Reklamasyon Verileri ---
    section2 = tk.LabelFrame(content_frame, text="ğŸ­ Reklamasyon Verileri", 
                             font=("Segoe UI", 11, "bold"), padx=15, pady=10)
    section2.pack(fill="both", expand=True, pady=5)
    
    tk.Label(section2, text="SQL Sorgusu:").pack(anchor="w")
    rek_query = tk.Text(section2, wrap="word", font=("Courier", 9), height=3)
    rek_query.pack(fill="x", pady=5)
    rek_query.insert("1.0", MYSQL_QUERIES["reklamasyon"])
    
    def load_reklamasyon_from_mysql():
        query = rek_query.get("1.0", tk.END).strip()
        if not query:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen SQL sorgusu girin!")
            return
        
        main_window.destroy()
        
        def load_thread():
            df = load_data_from_mysql(query=query)
            if df is not None:
                # Kolon eÅŸleÅŸtirmesi uygula
                df = apply_column_mappings(df, "reklamasyon")
                
                global df_reklamasyon_global
                
                # Reklamasyon verisini iÅŸle (mevcut load_reklamasyon_data mantÄ±ÄŸÄ±)
                try:
                    def get_islem_tipi(fis_tipi):
                        ft = str(fis_tipi).lower()
                        if '63' in ft or 'iade' in ft: return 'Ä°ade'
                        if '52' in ft or 'reklamasyon' in ft: return 'Reklamasyon'
                        return 'Normal AlÄ±m'
                    
                    df['Islem_Tipi'] = df.get('FiÅŸ Tipi', df.columns[0]).apply(get_islem_tipi)
                    
                    # Metrik hesaplamalarÄ±
                    def calculate_metrics(row):
                        tip = row.get('Islem_Tipi', '')
                        miktar = pd.to_numeric(row.get('Miktar', 0), errors='coerce')
                        if pd.isna(miktar): miktar = 0
                        
                        try:
                            birim_fiyat = pd.to_numeric(row.get('Birim Fiyat', 0), errors='coerce')
                            if pd.isna(birim_fiyat): birim_fiyat = 0
                            tutar = miktar * birim_fiyat
                        except:
                            tutar = 0
                        
                        on_time_qty = 0; late_qty = 0; return_qty = 0
                        reklamasyon_tutar = 0; iade_tutar = 0; alim_tutar = 0
                        alim_qty = 0; rek_qty = 0
                        
                        if tip == 'Normal AlÄ±m': on_time_qty = miktar; alim_tutar = tutar; alim_qty = miktar
                        elif tip == 'Ä°ade': return_qty = miktar; iade_tutar = tutar
                        elif tip == 'Reklamasyon': reklamasyon_tutar = tutar; rek_qty = miktar
                        
                        return pd.Series([on_time_qty, late_qty, return_qty, reklamasyon_tutar, 
                                        iade_tutar, alim_tutar, alim_qty, rek_qty])
                    
                    df[['On_Time_Miktar', 'Geciken_Miktar', 'Iade_Edilen_Miktar', 
                        'Reklamasyon_Tutari', 'Iade_Tutari', 'Alim_Tutari', 
                        'Alim_Miktar', 'Reklamasyon_Miktar']] = df.apply(calculate_metrics, axis=1)
                    
                    df_reklamasyon_global = df
                    
                    root.after(0, lambda: messagebox.showinfo("BaÅŸarÄ±lÄ±", 
                        f"Reklamasyon verileri yÃ¼klendi: {len(df)} kayÄ±t\n"
                        "Reklamasyon sayfalarÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyebilirsiniz."))
                    root.after(0, lambda: show_page("Rek YÃ¶netici Ã–zeti"))
                    
                except Exception as e:
                    root.after(0, lambda: messagebox.showerror("Hata", 
                        f"Reklamasyon verisi iÅŸlenirken hata:\n{str(e)}"))
        
        threading.Thread(target=load_thread, daemon=True).start()
    
    ttk.Button(section2, text="ğŸ“¥ Reklamasyon Verilerini Getir", 
               command=load_reklamasyon_from_mysql).pack(fill="x", pady=5)
    
    # --- BÃ–LÃœM 3: Stok Verileri ---
    section3 = tk.LabelFrame(content_frame, text="ğŸ“¦ Stok Verileri", 
                             font=("Segoe UI", 11, "bold"), padx=15, pady=10)
    section3.pack(fill="both", expand=True, pady=5)
    
    tk.Label(section3, text="SQL Sorgusu:").pack(anchor="w")
    stok_query = tk.Text(section3, wrap="word", font=("Courier", 9), height=3)
    stok_query.pack(fill="x", pady=5)
    stok_query.insert("1.0", MYSQL_QUERIES["stok"])
    
    def load_stok_from_mysql():
        query = stok_query.get("1.0", tk.END).strip()
        if not query:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen SQL sorgusu girin!")
            return
        
        main_window.destroy()
        
        def load_thread():
            df = load_data_from_mysql(query=query)
            if df is not None:
                # Kolon eÅŸleÅŸtirmesi uygula
                df = apply_column_mappings(df, "stok")
                
                global df_stok_global
                df_stok_global = df
                
                root.after(0, lambda: messagebox.showinfo("BaÅŸarÄ±lÄ±", 
                    f"Stok verileri yÃ¼klendi: {len(df)} kayÄ±t\n"
                    "Stok YÃ¶netimi sayfasÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyebilirsiniz."))
                root.after(0, lambda: show_page("Stok YÃ¶netimi"))
        
        threading.Thread(target=load_thread, daemon=True).start()
    
    ttk.Button(section3, text="ğŸ“¥ Stok Verilerini Getir", 
               command=load_stok_from_mysql).pack(fill="x", pady=5)
    
    # Alt bilgi
    info_frame = tk.Frame(main_window, bg="#ecf0f1", padx=15, pady=10)
    info_frame.pack(fill="x")
    tk.Label(info_frame, text="ğŸ’¡ Ä°pucu: SQL sorgularÄ±nÄ± dilediÄŸiniz gibi Ã¶zelleÅŸtirebilirsiniz. "
             "VarsayÄ±lan sorgular MYSQL_QUERIES dictionary'sinde tanÄ±mlÄ±dÄ±r.",
             font=("Segoe UI", 9), bg="#ecf0f1", wraplength=850, justify="left").pack()
    
    # Kapatma butonu
    ttk.Button(main_window, text="âŒ Kapat", command=main_window.destroy).pack(pady=10)

# ---------- TICKER (KAYAN BANT) FONKSÄ°YONLARI ----------
def fetch_tcmb_currency():
    """TCMB XML API'den gÃ¼ncel dÃ¶viz kurlarÄ±nÄ± Ã§eker."""
    try:
        url = "https://www.tcmb.gov.tr/kurlar/today.xml"
        response = requests.get(url, timeout=5)
        if response.status_code == 200:
            root_xml = ET.fromstring(response.content)
            
            usd_rate = None
            eur_rate = None
            
            for currency in root_xml.findall('Currency'):
                code = currency.get('CurrencyCode')
                if code == 'USD':
                    forex_buying = currency.find('ForexBuying')
                    if forex_buying is not None and forex_buying.text:
                        usd_rate = float(forex_buying.text)
                elif code == 'EUR':
                    forex_buying = currency.find('ForexBuying')
                    if forex_buying is not None and forex_buying.text:
                        eur_rate = float(forex_buying.text)
            
            return usd_rate, eur_rate
    except Exception as e:
        print(f"TCMB veri Ã§ekme hatasÄ±: {e}")
        return None, None

def fetch_yahoo_finance_data(symbol):
    """Yahoo Finance'den veri Ã§eker."""
    url = f"https://query1.finance.yahoo.com/v8/finance/chart/{symbol}?interval=1m&range=1d"
    headers = {'User-Agent': 'Mozilla/5.0'}
    try:
        response = requests.get(url, headers=headers, timeout=5)
        if response.status_code == 200:
            data = response.json()
            price = data['chart']['result'][0]['meta']['regularMarketPrice']
            prev_close = data['chart']['result'][0]['meta']['chartPreviousClose']
            return price, prev_close
    except:
        return None, None

def update_market_ticker():
    """Piyasa verilerini gÃ¼nceller (GerÃ§ek Veri - TCMB + Yahoo Finance)."""
    
    # Thread iÃ§inde Ã§alÄ±ÅŸtÄ±r ki arayÃ¼z donmasÄ±n
    def _fetch():
        # TCMB'den dÃ¶viz kurlarÄ±
        usd_now, eur_now = fetch_tcmb_currency()
        
        # Yahoo Finance'den Brent petrol
        brent_now, brent_prev = fetch_yahoo_finance_data("BZ=F")
        
        # Fallback deÄŸerler - TCMB baÅŸarÄ±sÄ±z olursa Yahoo Finance dene
        if usd_now is None or eur_now is None:
            usd_yf, usd_prev = fetch_yahoo_finance_data("USDTRY=X")
            eur_yf, eur_prev = fetch_yahoo_finance_data("EURTRY=X")
            if usd_now is None: usd_now, usd_prev = usd_yf if usd_yf else 36.50, 36.40
            else: usd_prev = usd_now * 0.998  # YaklaÅŸÄ±k Ã¶nceki deÄŸer
            if eur_now is None: eur_now, eur_prev = eur_yf if eur_yf else 38.20, 38.10
            else: eur_prev = eur_now * 0.998
        else:
            # TCMB baÅŸarÄ±lÄ±, Ã¶nceki deÄŸerleri tahmin et
            usd_prev = usd_now * 0.998
            eur_prev = eur_now * 0.998
        
        if brent_now is None: brent_now, brent_prev = 78.40, 78.00
        
        # ArayÃ¼z gÃ¼ncelleme
        root.after(0, lambda: _update_label(usd_now, usd_prev, eur_now, eur_prev, brent_now, brent_prev))

    def _update_label(usd, usd_p, eur, eur_p, brent, brent_p):
        usd_icon = "ğŸ”¼" if usd >= usd_p else "ğŸ”½"
        eur_icon = "ğŸ”¼" if eur >= eur_p else "ğŸ”½"
        brent_icon = "ğŸ”¼" if brent >= brent_p else "ğŸ”½"
        
        # Hammadde fiyatlarÄ±nÄ± ekle (commodity_prices_global'den)
        cotton_price = "94.20"
        polyester_price = "1,350"
        viscose_price = "2,100"
        cotton_icon = "â–"
        polyester_icon = "â–"
        viscose_icon = "â–"
        
        if commodity_prices_global:
            if 'Pamuk (Cotlook A Index)' in commodity_prices_global:
                cotton_data = commodity_prices_global['Pamuk (Cotlook A Index)']
                cotton_price = f"{cotton_data['current']:.2f}"
                cotton_icon = "ğŸ”¼" if cotton_data['change'] >= 0 else "ğŸ”½"
            if 'Polyester' in commodity_prices_global:
                poly_data = commodity_prices_global['Polyester']
                polyester_price = f"{poly_data['current']:,.0f}"
                polyester_icon = "ğŸ”¼" if poly_data['change'] >= 0 else "ğŸ”½"
            if 'Viskon' in commodity_prices_global:
                vis_data = commodity_prices_global['Viskon']
                viscose_price = f"{vis_data['current']:,.0f}"
                viscose_icon = "ğŸ”¼" if vis_data['change'] >= 0 else "ğŸ”½"
        
        ticker_text = f"  ğŸ’µ USD/TL: {usd:.4f} {usd_icon}   |   ğŸ’¶ EUR/TL: {eur:.4f} {eur_icon}   |   ğŸ›¢ï¸ BRENT: ${brent:.2f} {brent_icon}   |   ğŸ­ PAMUK: ${cotton_price} {cotton_icon}   |   ğŸ§µ POLYESTER: ${polyester_price}/ton {polyester_icon}   |   ğŸ€ VÄ°SKON: ${viscose_price}/ton {viscose_icon}   |   ğŸš¢ BALTIC DRY: 1,450 ğŸ”¼  "
        if ticker_label:
            ticker_label.configure(text=ticker_text)
    
    threading.Thread(target=_fetch, daemon=True).start()
    
    # 60 saniyede bir gÃ¼ncelle
    root.after(60000, update_market_ticker)

def scroll_ticker_animation():
    """Metni kaydÄ±rarak ticker efekti verir."""
    if not ticker_label: return
    text = ticker_label.cget("text")
    # Ä°lk karakteri sona al
    new_text = text[1:] + text[0]
    ticker_label.configure(text=new_text)
    # HÄ±z ayarÄ± (ms)
    root.after(200, scroll_ticker_animation)

# ---------- HABERLER (RSS) FONKSÄ°YONLARI ----------
def init_news_tab():
    """SektÃ¶rel haberler sekmesini oluÅŸturur."""
    for widget in frame_haberler.winfo_children(): widget.destroy()
    
    # BaÅŸlÄ±k
    header = tk.Frame(frame_haberler, bg="white", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="ğŸ“° SektÃ¶rel Haber Merkezi", font=("Segoe UI", 18, "bold"), fg="#2c3e50", bg="white").pack(anchor="w")
    tk.Label(header, text="Tekstil, Hammadde, HazÄ±r Giyim ve Ekonomi DÃ¼nyasÄ±ndan Son BaÅŸlÄ±klar", font=("Segoe UI", 10), fg="gray", bg="white").pack(anchor="w")
    
    # Haber Konteyneri
    news_container = tk.Frame(frame_haberler, bg="#ecf0f1")
    news_container.pack(fill="both", expand=True, padx=20, pady=10)
    
    # Canvas ve Scrollbar (Haberleri kaydÄ±rmak iÃ§in)
    canvas = tk.Canvas(news_container, bg="#ecf0f1", highlightthickness=0)
    scrollbar = ttk.Scrollbar(news_container, orient="vertical", command=canvas.yview)
    scrollable_frame = tk.Frame(canvas, bg="#ecf0f1")

    scrollable_frame.bind(
        "<Configure>",
        lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
    )

    canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
    canvas.configure(yscrollcommand=scrollbar.set)

    canvas.pack(side="left", fill="both", expand=True)
    scrollbar.pack(side="right", fill="y")
    
    # Haberleri Ã‡ekme Butonu
    btn_frame = tk.Frame(frame_haberler, bg="#ecf0f1")
    btn_frame.pack(fill="x", padx=20, pady=5)
    ttk.Button(btn_frame, text="ğŸ”„ Haberleri Yenile", command=lambda: fetch_and_display_news(scrollable_frame)).pack(anchor="e")
    
    # Ä°lk yÃ¼kleme
    fetch_and_display_news(scrollable_frame)

def fetch_and_display_news(parent_frame):
    """
    Google News RSS'den verileri Ã§eker.
    Ã–zellikler:
    1. Threading: ArayÃ¼zÃ¼ dondurmaz.
    2. User-Agent Header: Google'Ä±n bot korumasÄ±nÄ± aÅŸar.
    3. Error Handling: BaÄŸlantÄ± hatalarÄ±nÄ± yÃ¶netir.
    """
    # Ã–nceki iÃ§eriÄŸi temizle
    for widget in parent_frame.winfo_children(): widget.destroy()
    
    # YÃ¼kleniyor mesajÄ± (KullanÄ±cÄ± iÅŸlem yapÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶rsÃ¼n)
    loading = tk.Label(parent_frame, text="Haberler alÄ±nÄ±yor... LÃ¼tfen bekleyin.", 
                      font=("Segoe UI", 12, "italic"), fg="gray", bg="#ecf0f1")
    loading.pack(pady=20)
    
    # ArayÃ¼zÃ¼ zorla gÃ¼ncelle (MesajÄ±n hemen gÃ¶rÃ¼nmesi iÃ§in)
    parent_frame.update()
    
    # --- ARKA PLAN Ä°ÅÃ‡Ä°SÄ° (Thread) ---
    def _bg_task():
        # Google'Ä±n bizi "Python Script" deÄŸil "Chrome TarayÄ±cÄ±sÄ±" sanmasÄ± iÃ§in Header
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        }
        
        # Tekstil ve ekonomi odaklÄ± RSS adresi
        rss_url = "https://news.google.com/rss/search?q=tekstil+OR+hazÄ±r+giyim+OR+kumaÅŸ+OR+konfeksiyon+OR+iplik+when:7d&hl=tr&gl=TR&ceid=TR:tr"
        
        try:
            # timeout=10: 10 saniye cevap gelmezse iÅŸlemi iptal et (Sonsuz donmayÄ± Ã¶nler)
            response = requests.get(rss_url, headers=headers, timeout=10)
            
            if response.status_code == 200:
                # Veri baÅŸarÄ±yla geldi, ham XML iÃ§eriÄŸini al
                xml_content = response.content
                # ArayÃ¼z gÃ¼ncellemesi iÃ§in Ana Thread'e sinyal gÃ¶nder
                root.after(0, lambda: _update_ui_success(xml_content))
            else:
                # HTTP HatasÄ± (404, 429, 500 vb.)
                error_msg = f"HTTP HatasÄ±: {response.status_code}"
                root.after(0, lambda: _update_ui_error(error_msg))
                activity_logger.log_error(f"News RSS HTTP {response.status_code}", "SektÃ¶r Haberleri")
                
        except Exception as e:
            # BaÄŸlantÄ± HatasÄ± (Network, Timeout vb.)
            error_msg = f"BaÄŸlantÄ± HatasÄ±: {str(e)}"
            root.after(0, lambda: _update_ui_error(error_msg))
            activity_logger.log_error(f"News RSS hatasÄ±: {str(e)}", "SektÃ¶r Haberleri")

    # --- ARAYÃœZ GÃœNCELLEME (BaÅŸarÄ±lÄ±) ---
    def _update_ui_success(xml_data):
        try:
            loading.destroy()
            root_xml = ET.fromstring(xml_data)
            count = 0
            
            # Haber bulunamadÄ± kontrolÃ¼
            items = root_xml.findall('./channel/item')
            if not items:
                no_news = tk.Label(parent_frame, text="Haber bulunamadÄ±. LÃ¼tfen daha sonra tekrar deneyin.", 
                                  font=("Segoe UI", 12), fg="gray", bg="#ecf0f1")
                no_news.pack(pady=20)
                return
            
            for item in items:
                if count > 15: break # Max 15 haber
                
                title = item.find('title').text
                link = item.find('link').text
                pubDate = item.find('pubDate').text
                
                # Haber KartÄ±
                card = tk.Frame(parent_frame, bg="white", bd=1, relief="solid", padx=15, pady=10)
                card.pack(fill="x", pady=5, padx=5)
                
                # BaÅŸlÄ±k (Linkli)
                lbl_title = tk.Label(card, text=title, font=("Segoe UI", 11, "bold"), fg="#2980b9", bg="white", cursor="hand2", wraplength=900, justify="left")
                lbl_title.pack(anchor="w")
                lbl_title.bind("<Button-1>", lambda e, url=link: webbrowser.open_new(url))
                
                # Tarih
                tk.Label(card, text=f"ğŸ“… {pubDate}", font=("Arial", 9), fg="gray", bg="white").pack(anchor="w")
                
                count += 1
        except Exception as e:
            # XML parse hatasÄ±
            _update_ui_error(f"XML Parse HatasÄ±: {str(e)[:50]}...")
            activity_logger.log_error(f"News XML parse hatasÄ±: {str(e)}", "SektÃ¶r Haberleri")
    
    # --- ARAYÃœZ GÃœNCELLEME (Hata) ---
    def _update_ui_error(error_message):
        """Hata mesajÄ±nÄ± ekranda gÃ¶ster"""
        loading.configure(
            text=f"âŒ {error_message}\n\nğŸ’¡ Ä°pucu: VPN kullanmayÄ± deneyin veya biraz bekleyip tekrar deneyin.",
            fg="red",
            font=("Segoe UI", 10),
            wraplength=700,
            justify="center"
        )
    
    # Thread'i baÅŸlat (daemon=True: ana program kapanÄ±nca otomatik sonlanÄ±r)
    threading.Thread(target=_bg_task, daemon=True).start()

# ---------- TREND AVCISI (TREND HUNTER) FONKSÄ°YONLARI ----------
def init_trend_hunter_tab():
    """Dijital Ä°kiz & Trend AvcÄ±sÄ± Sekmesi"""
    global frame_trend_hunter
    
    # Mevcut widgetlarÄ± temizle
    for widget in frame_trend_hunter.winfo_children(): widget.destroy()

    # --- BaÅŸlÄ±k ---
    header = tk.Frame(frame_trend_hunter, bg="#8e44ad", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="ğŸ”® Trend AvcÄ±sÄ± & Dijital Ä°kiz", font=("Segoe UI", 18, "bold"), fg="white", bg="#8e44ad").pack(side="left")
    tk.Label(header, text="Sosyal Medya ve Arama Motoru Sinyalleri ile Erken UyarÄ± Sistemi", font=("Segoe UI", 10), fg="#f3e5f5", bg="#8e44ad").pack(side="left", padx=10)

    # --- Ana Ä°Ã§erik ---
    content = tk.PanedWindow(frame_trend_hunter, orient=tk.HORIZONTAL)
    content.pack(fill="both", expand=True, pady=10)

    # 1. SOL PANEL: Veri GiriÅŸi ve Kontrol
    left_panel = tk.Frame(content, bg="white", padx=10, pady=10)
    content.add(left_panel, width=400)

    tk.Label(left_panel, text="ğŸ“¡ Sinyal Takip Parametreleri", font=("Segoe UI", 12, "bold"), fg="#2c3e50", bg="white").pack(anchor="w", pady=10)
    
    tk.Label(left_panel, text="Takip Edilecek Anahtar Kelimeler (VirgÃ¼lle ayÄ±rÄ±n):", bg="white").pack(anchor="w")
    keywords_entry = ttk.Entry(left_panel, width=40)
    keywords_entry.insert(0, "Oversize GÃ¶mlek, Lila Elbise, Keten Pantolon")
    keywords_entry.pack(fill="x", pady=5)

    tk.Label(left_panel, text="BÃ¶lge / Platform:", bg="white").pack(anchor="w", pady=(10,0))
    platform_combo = ttk.Combobox(left_panel, values=["Google Arama (TR)", "Google Arama (Global)", "Instagram (SimÃ¼lasyon)", "TikTok (SimÃ¼lasyon)"], state="readonly")
    platform_combo.set("Google Arama (TR)")
    platform_combo.pack(fill="x", pady=5)

    # -- SimÃ¼lasyon AlanÄ± --
    sim_frame = tk.LabelFrame(left_panel, text="âš¡ Senaryo SimÃ¼lasyonu", bg="#f3e5f5", fg="#8e44ad", padx=10, pady=10)
    sim_frame.pack(fill="x", pady=20)
    
    tk.Label(sim_frame, text="Pazar akÅŸamÄ± aniden patlayan bir trendi simÃ¼le et:", bg="#f3e5f5", wraplength=350).pack(anchor="w")
    
    # Status label tanÄ±mÄ±nÄ± burada yapalÄ±m (closure iÃ§in)
    status_lbl = tk.Label(left_panel, text="HazÄ±r", fg="gray", bg="white")
    
    def simulate_viral_trend():
        """SimÃ¼lasyon: Pazar akÅŸamÄ± 'Lila Oversize GÃ¶mlek' patlÄ±yor"""
        trend_data = {
            "Lila Oversize GÃ¶mlek": [12, 15, 14, 18, 22, 85, 98], # Son gÃ¼n patlama
            "Normal GÃ¶mlek": [45, 46, 44, 45, 47, 48, 46]         # Stabil
        }
        # Son 7 gÃ¼nÃ¼n tarihlerini oluÅŸtur
        dates = [(datetime.datetime.now() - timedelta(days=i)).strftime("%d.%m") for i in range(6, -1, -1)]
        
        update_trend_chart(dates, trend_data)
        
        # AI Analizini Tetikle
        analyze_trend_with_ai("Lila Oversize GÃ¶mlek", 98, is_simulation=True)

    ttk.Button(sim_frame, text="ğŸ”¥ 'Lila GÃ¶mlek' Viral Oldu! (SimÃ¼le Et)", command=simulate_viral_trend).pack(fill="x", pady=5)
    
    # -- GerÃ§ek Veri Butonu --
    def fetch_real_trends():
        """Google Trends verilerini ARKA PLANDA Ã§eker (UI dondurmaz)."""
        if not PYTRENDS_AVAILABLE:
            messagebox.showerror("Hata", "pytrends kÃ¼tÃ¼phanesi eksik. LÃ¼tfen 'pip install pytrends' yapÄ±n.")
            return
            
        keywords = [k.strip() for k in keywords_entry.get().split(",")]
        # Google Trends max 5 kelime kabul eder
        if len(keywords) > 5:
            keywords = keywords[:5]
            messagebox.showinfo("Bilgi", "Google Trends limiti nedeniyle ilk 5 kelime alÄ±ndÄ±.")

        if not keywords: return

        # YÃ¼kleniyor durumunu gÃ¶ster
        status_lbl.configure(text="Google Trends verileri Ã§ekiliyor... (Arka planda, UI donmaz)")
        left_panel.update()
        
        # --- ARKA PLAN Ä°ÅÃ‡Ä°SÄ° (Thread) ---
        def _background_worker():
            try:
                # Google Trends BaÄŸlantÄ±sÄ± (Retry & Backoff ile)
                # retries=5: 429 hatasÄ± alÄ±rsa 5 kere yeniden dene
                # backoff_factor=10: Denemeler arasÄ± bekleme sÃ¼resi (10sn, 20sn, 40sn...)
                # timeout=(10,25): BaÄŸlantÄ± iÃ§in 10sn, veri okuma iÃ§in 25sn bekle
                pytrends = TrendReq(
                    hl='tr-TR', 
                    tz=180, 
                    retries=5, 
                    backoff_factor=10, 
                    timeout=(10, 25)
                )
                
                # Anahtar kelimeler iÃ§in veri Ã§ek
                pytrends.build_payload(keywords, cat=0, timeframe='now 7-d', geo='TR', gprop='')
                
                # Google'a nazik ol: Her istekte kÃ¼Ã§Ã¼k bir bekleme ekle
                import time
                time.sleep(2)  # 2 saniye bekle (Bot algÄ±lamasÄ±nÄ± azaltÄ±r)
                
                data = pytrends.interest_over_time()
                
                # BaÅŸarÄ±yla veri geldi - UI gÃ¼ncellemesi iÃ§in ana thread'e gÃ¶nder
                root.after(0, lambda: _update_ui_success(data, keywords))
                
            except Exception as e:
                # Hata oluÅŸtu - UI gÃ¼ncellemesi iÃ§in ana thread'e gÃ¶nder
                root.after(0, lambda: _update_ui_error(str(e)))
        
        # --- ARAYÃœZ GÃœNCELLEME (BaÅŸarÄ±lÄ±) ---
        def _update_ui_success(data, kw_list):
            try:
                if not data.empty:
                    # Tarih formatÄ±
                    dates = [d.strftime("%d.%m") for d in data.index]
                    # Chart iÃ§in veri hazÄ±rlÄ±ÄŸÄ±
                    chart_data = {col: data[col].tolist() for col in kw_list}
                    
                    update_trend_chart(dates, chart_data)
                    
                    # En Ã§ok artanÄ± bul
                    last_row = data.iloc[-1]
                    top_trend = last_row.idxmax()
                    current_score = last_row.max()
                    
                    analyze_trend_with_ai(top_trend, current_score, is_simulation=False)
                    status_lbl.configure(text="âœ… Veri baÅŸarÄ±yla Ã§ekildi.")
                else:
                    messagebox.showinfo("Bilgi", "Bu kelimeler iÃ§in yeterli veri bulunamadÄ±.")
                    status_lbl.configure(text="Veri bulunamadÄ±.")
            except Exception as parse_error:
                messagebox.showerror("Hata", f"Veri iÅŸleme hatasÄ±: {str(parse_error)}")
                status_lbl.configure(text="Veri iÅŸleme hatasÄ±.")
        
        # --- ARAYÃœZ GÃœNCELLEME (Hata) ---
        def _update_ui_error(error_msg):
            # 429 hatasÄ± kontrolÃ¼ (Rate Limit)
            if "429" in error_msg or "Too Many Requests" in error_msg:
                messagebox.showerror(
                    "â³ Google Rate Limit", 
                    "Google Trends geÃ§ici olarak istekleri engelliyor.\n\n"
                    "ğŸ”¹ Ã‡Ã¶zÃ¼m 1: 1-2 saat bekleyip tekrar deneyin\n"
                    "ğŸ”¹ Ã‡Ã¶zÃ¼m 2: VPN kullanarak IP adresinizi deÄŸiÅŸtirin\n"
                    "ğŸ”¹ Ã‡Ã¶zÃ¼m 3: SimÃ¼lasyon modunu kullanÄ±n (demo butonu)\n\n"
                    "Not: Bu bir Google API limiti, kodla ilgili deÄŸil."
                )
                status_lbl.configure(text="â³ Google Rate Limit - LÃ¼tfen 1-2 saat bekleyin")
            else:
                messagebox.showerror("Hata", f"Google Trends baÄŸlantÄ± hatasÄ±:\n{error_msg}\n\nÄ°pucu: SimÃ¼lasyon butonunu deneyebilirsiniz.")
                status_lbl.configure(text="âŒ Hata oluÅŸtu.")
            
            # Loglama
            if activity_logger:
                activity_logger.log_error(f"Google Trends hatasÄ±: {error_msg}", "Trend AvcÄ±sÄ±")
        
        # Arka plan thread'ini baÅŸlat (daemon=True: program kapanÄ±rken otomatik temizlenir)
        threading.Thread(target=_background_worker, daemon=True).start()

    ttk.Button(left_panel, text="ğŸŒ GerÃ§ek Verileri Tara (Google Trends)", command=fetch_real_trends).pack(fill="x", pady=10)
    status_lbl.pack()
    
    # Google Trends Web SayfasÄ± Butonu (ÅÄ±k ve dikkat Ã§ekici)
    trends_button_frame = tk.Frame(left_panel, bg="white")
    trends_button_frame.pack(fill="x", pady=15)
    
    # BÃ¼yÃ¼k, ÅŸÄ±k Google Trends butonu
    google_trends_btn = tk.Button(
        trends_button_frame,
        text="ğŸ”¥ Google Trends'i AÃ§\n(CanlÄ± Trendler)",
        font=("Segoe UI", 12, "bold"),
        bg="#e74c3c",  # KÄ±rmÄ±zÄ± arka plan
        fg="white",
        activebackground="#c0392b",
        activeforeground="white",
        relief="raised",
        bd=3,
        cursor="hand2",
        padx=20,
        pady=15,
        command=lambda: open_google_trends()
    )
    google_trends_btn.pack(fill="x", pady=5)
    
    # Hover efekti iÃ§in fonksiyonlar
    def on_enter(e):
        google_trends_btn.config(bg="#c0392b", font=("Segoe UI", 13, "bold"))
    
    def on_leave(e):
        google_trends_btn.config(bg="#e74c3c", font=("Segoe UI", 12, "bold"))
    
    google_trends_btn.bind("<Enter>", on_enter)
    google_trends_btn.bind("<Leave>", on_leave)
    
    def open_google_trends():
        """Google Trends sayfasÄ±nÄ± tarayÄ±cÄ±da aÃ§"""
        import webbrowser
        webbrowser.open("https://trends.google.com.tr/home?geo=TR&hl=tr")
        if activity_logger:
            activity_logger.log_activity("Google Trends web sayfasÄ± aÃ§Ä±ldÄ±", "Trend AvcÄ±sÄ±")
    
    # Bilgi etiketi
    tk.Label(
        trends_button_frame, 
        text="ğŸ’¡ AnlÄ±k trendleri tarayÄ±cÄ±da gÃ¶rÃ¼n\nRate limit sorunu yok!",
        font=("Segoe UI", 9, "italic"),
        fg="#7f8c8d",
        bg="white",
        justify="center"
    ).pack(pady=(5, 0))
    
    # Aksiyon ButonlarÄ± (Sol panelde, GerÃ§ek Verileri Tara butonunun altÄ±nda - Sabit konumda kalÄ±r)
    action_frame_left = tk.Frame(left_panel, bg="white")
    action_frame_left.pack(fill="x", pady=15)
    
    tk.Label(action_frame_left, text="ğŸ¯ HÄ±zlÄ± Aksiyonlar", font=("Segoe UI", 11, "bold"), fg="#2c3e50", bg="white").pack(anchor="w", pady=(0,5))
    
    ttk.Button(action_frame_left, text="ğŸ“¦ KumaÅŸ StoÄŸunu Kontrol Et", command=lambda: show_page("AkÄ±llÄ± SipariÅŸ")).pack(fill="x", pady=3)
    ttk.Button(action_frame_left, text="ğŸ­ Ãœretime Emir Ver (Draft)", command=lambda: messagebox.showinfo("ERP", "Ãœretim emri ERP sistemine taslak olarak girildi.")).pack(fill="x", pady=3)

    # 2. SAÄ PANEL: Grafik ve AI Analizi
    right_panel = tk.Frame(content, bg="white", padx=20, pady=10)
    content.add(right_panel)

    # Grafik AlanÄ±
    chart_frame = tk.Frame(right_panel, bg="white", height=350)
    chart_frame.pack(fill="x", expand=False)
    
    # AI SonuÃ§ AlanÄ±
    ai_frame = tk.LabelFrame(right_panel, text="ğŸ¤– Dijital Ä°kiz Karar MekanizmasÄ± (Gemini AI)", font=("Segoe UI", 12, "bold"), bg="white", fg="#2980b9", padx=15, pady=15)
    ai_frame.pack(fill="both", expand=True, pady=10)
    
    ai_text = tk.Text(ai_frame, wrap="word", font=("Segoe UI", 10), bg="#fdfefe", height=10, bd=0)
    ai_text.pack(fill="both", expand=True)
    ai_text.insert("1.0", "Veri bekleniyor... SimÃ¼lasyon veya gerÃ§ek veri butonuna basÄ±n.")
    ai_text.configure(state="disabled")

    # --- YardÄ±mcÄ± Fonksiyon: Grafik Ã‡izme ---
    def update_trend_chart(dates, data_dict):
        for widget in chart_frame.winfo_children(): widget.destroy()
        
        fig = plt.figure(figsize=(8, 4), dpi=100)
        ax = fig.add_subplot(111)
        
        for label, values in data_dict.items():
            # EÄŸer son deÄŸer Ã¶nceki ortalamadan %30 fazlaysa Ã§izgiyi kalÄ±nlaÅŸtÄ±r (Trend AlarmÄ±)
            avg = sum(values[:-1]) / len(values[:-1]) if len(values) > 1 else 0
            if avg == 0: avg = 1
            
            is_trending = values[-1] > avg * 1.3
            width = 3 if is_trending else 1.5
            style = '-' if is_trending else '--'
            
            ax.plot(dates, values, marker='o', linewidth=width, linestyle=style, label=label)
            
            # Son noktaya deÄŸer yaz
            ax.annotate(f"{values[-1]}", (dates[-1], values[-1]), textcoords="offset points", xytext=(0,10), ha='center', fontsize=8)

        ax.set_title("Arama Hacmi / Sosyal Medya Ä°lgisi (Son 7 GÃ¼n)")
        ax.set_ylabel("Ä°lgi Skoru (0-100)")
        ax.legend()
        ax.grid(True, alpha=0.3)
        plt.tight_layout()
        
        canvas = FigureCanvasTkAgg(fig, master=chart_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)

    # --- YardÄ±mcÄ± Fonksiyon: AI Analizi ---
    def analyze_trend_with_ai(trend_name, score, is_simulation=False):
        ai_text.configure(state="normal")
        ai_text.delete("1.0", tk.END)
        ai_text.insert("1.0", "ğŸ§  Trend verisi analiz ediliyor... (Gemini)\n")
        ai_text.configure(state="disabled")
        
        def _thread():
            if not GEMINI_API_KEY:
                update_ai_text("Hata: Gemini API anahtarÄ± yok.")
                return

            context = "SÄ°MÃœLASYON VERÄ°SÄ°" if is_simulation else "GERÃ‡EK GOOGLE TRENDS VERÄ°SÄ°"

            prompt = f"""
Sen bir HÄ±zlÄ± Moda (Fast Fashion) ve Tedarik Zinciri stratejistisin.

DURUM ({context}):
"{trend_name}" isimli Ã¼rÃ¼nÃ¼n ilgisi son 24 saatte aniden yÃ¼kseldi.
Mevcut Ä°lgi Skoru: {score}/100 (Ã‡ok YÃ¼ksek)

GÃ–REV:
1. Bu trendin olasÄ± sebebini 1 cÃ¼mleyle tahmin et (Ã–rn: Influencer etkisi, mevsim, viral video).
2. Tedarik zinciri iÃ§in ACÄ°L 3 maddelik aksiyon planÄ± Ã§Ä±kar.
3. Risk analizi yap (Bu geÃ§ici bir "micro-trend" mi yoksa sezonluk mu?).

YanÄ±tÄ±nÄ± TÃ¼rkÃ§e, profesyonel ve kÄ±sa tut.
"""
            
            try:
                # Mevcut kodundaki API yapÄ±sÄ±nÄ± kullanÄ±yoruz
                url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={GEMINI_API_KEY}"
                headers = {'Content-Type': 'application/json'}
                payload = {"contents": [{"parts": [{"text": prompt}]}]}
                
                resp = requests.post(url, headers=headers, json=payload, timeout=20)
                
                if resp.status_code == 200:
                    result = resp.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
                    root.after(0, lambda: update_ai_text(result))
                else:
                    root.after(0, lambda: update_ai_text(f"AI yanÄ±t vermedi. Kod: {resp.status_code}"))
            except Exception as e:
                root.after(0, lambda: update_ai_text(f"BaÄŸlantÄ± hatasÄ±: {e}"))

        threading.Thread(target=_thread, daemon=True).start()

    def update_ai_text(text):
        ai_text.configure(state="normal")
        ai_text.delete("1.0", tk.END)
        ai_text.insert("1.0", text)
        ai_text.configure(state="disabled")

# ---------- GOOGLE TRENDING - ARAMA VE TREND ANALÄ°ZÄ° ----------

def init_google_trending_tab():
    """Google Trending - Anahtar kelime arama ve trend analizi"""
    global frame_google_trending
    
    for widget in frame_google_trending.winfo_children(): widget.destroy()
    
    # BaÅŸlÄ±k
    header = tk.Frame(frame_google_trending, bg="#e74c3c", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="ğŸ”¥ Google Trending Arama", font=("Segoe UI", 18, "bold"), fg="white", bg="#e74c3c").pack(side="left")
    tk.Label(header, text="GerÃ§ek ZamanlÄ± Trend Analizi - TÃ¼rkiye", font=("Segoe UI", 10), fg="#fce5e5", bg="#e74c3c").pack(side="left", padx=10)
    
    # Ana iÃ§erik
    main_content = tk.Frame(frame_google_trending, bg="white")
    main_content.pack(fill="both", expand=True, padx=20, pady=20)
    
    # Arama BÃ¶lÃ¼mÃ¼
    search_frame = tk.LabelFrame(main_content, text="ğŸ” Anahtar Kelime Ara", 
                                font=("Segoe UI", 12, "bold"), bg="white", fg="#2c3e50", 
                                padx=15, pady=15)
    search_frame.pack(fill="x", pady=(0, 15))
    
    tk.Label(search_frame, text="Arama terimi girin (Ã¶r: defacto, moda, tekstil, oversize gÃ¶mlek):", 
            bg="white", font=("Segoe UI", 10)).pack(anchor="w", pady=(0, 5))
    
    search_entry = ttk.Entry(search_frame, font=("Segoe UI", 11), width=50)
    search_entry.pack(fill="x", pady=5)
    search_entry.insert(0, "defacto")
    
    # Zaman aralÄ±ÄŸÄ± seÃ§imi
    timeframe_frame = tk.Frame(search_frame, bg="white")
    timeframe_frame.pack(fill="x", pady=10)
    
    tk.Label(timeframe_frame, text="Zaman AralÄ±ÄŸÄ±:", bg="white", font=("Segoe UI", 10)).pack(side="left", padx=(0, 10))
    
    timeframe_var = tk.StringVar(value="now 1-d")
    timeframe_options = [
        ("Son 24 Saat", "now 1-d"),
        ("Son 7 GÃ¼n", "now 7-d"),
        ("Son 30 GÃ¼n", "today 1-m"),
        ("Son 3 Ay", "today 3-m"),
        ("Son 12 Ay", "today 12-m")
    ]
    
    for text, value in timeframe_options:
        ttk.Radiobutton(timeframe_frame, text=text, variable=timeframe_var, value=value).pack(side="left", padx=5)
    
    # Butonlar
    button_frame = tk.Frame(search_frame, bg="white")
    button_frame.pack(fill="x", pady=10)
    
    def search_trends():
        """Arama terimini Google Trends'de ara"""
        search_term = search_entry.get().strip()
        if not search_term:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen bir arama terimi girin.")
            return
        
        if not PYTRENDS_AVAILABLE:
            messagebox.showerror("Hata", "pytrends kÃ¼tÃ¼phanesi eksik. LÃ¼tfen 'pip install pytrends' yapÄ±n.")
            return
        
        # SonuÃ§ alanÄ±nÄ± temizle ve yÃ¼kleniyor mesajÄ± gÃ¶ster
        result_text.configure(state="normal")
        result_text.delete("1.0", tk.END)
        result_text.insert("1.0", f"â³ '{search_term}' iÃ§in Google Trends verileri Ã§ekiliyor...\n")
        result_text.configure(state="disabled")
        
        # Grafik alanÄ±nÄ± temizle
        for widget in chart_frame.winfo_children():
            widget.destroy()
        
        def _search_thread():
            try:
                # Arama terimini doÄŸrula
                if not search_term or len(search_term.strip()) < 2:
                    error_msg = "âš ï¸ GeÃ§ersiz arama terimi.\n\n"
                    error_msg += "En az 2 karakter uzunluÄŸunda bir terim girin."
                    root.after(0, lambda: update_result_text(error_msg))
                    return
                
                # Google Trends baÄŸlantÄ±sÄ±
                pytrends = TrendReq(
                    hl='tr-TR',
                    tz=180,
                    retries=3,
                    backoff_factor=5,
                    timeout=(10, 20)
                )
                
                # Arama terimini query'ye dÃ¶nÃ¼ÅŸtÃ¼r
                timeframe = timeframe_var.get()
                
                # Timeframe doÄŸrulama
                valid_timeframes = ["now 1-d", "now 7-d", "today 1-m", "today 3-m", "today 12-m"]
                if timeframe not in valid_timeframes:
                    timeframe = "now 7-d"  # VarsayÄ±lan
                
                # Google Trends API Ã§aÄŸrÄ±sÄ±
                pytrends.build_payload([search_term], cat=0, timeframe=timeframe, geo='TR', gprop='')
                
                # Ä°lgi verilerini al
                interest_data = pytrends.interest_over_time()
                
                if interest_data.empty or search_term not in interest_data.columns:
                    error_msg = f"âš ï¸ '{search_term}' iÃ§in veri bulunamadÄ±.\n\n"
                    error_msg += "Bu terim iÃ§in yeterli arama verisi yok olabilir.\n"
                    error_msg += "Daha genel terimler deneyin."
                    root.after(0, lambda: update_result_text(error_msg))
                    return
                
                # Verileri hazÄ±rla
                dates = [d.strftime("%d.%m.%Y") for d in interest_data.index]
                values = interest_data[search_term].tolist()
                
                # Ä°statistikler
                avg_value = sum(values) / len(values)
                max_value = max(values)
                min_value = min(values)
                current_value = values[-1]
                
                # Trend yÃ¶nÃ¼
                if len(values) >= 2:
                    change = current_value - values[0]
                    change_pct = (change / values[0] * 100) if values[0] > 0 else 0
                    trend_direction = "YÃ¼kseliÅŸ â†—" if change > 0 else "DÃ¼ÅŸÃ¼ÅŸ â†˜" if change < 0 else "Stabil â†’"
                    trend_color = "green" if change > 0 else "red" if change < 0 else "gray"
                else:
                    change_pct = 0
                    trend_direction = "Belirsiz"
                    trend_color = "gray"
                
                # SonuÃ§ metnini hazÄ±rla
                result_msg = f"ğŸ“Š '{search_term}' TREND ANALÄ°ZÄ°\n"
                result_msg += f"{'='*60}\n\n"
                result_msg += f"Zaman AralÄ±ÄŸÄ±: {dict(timeframe_options)[timeframe_var.get()]}\n"
                result_msg += f"BÃ¶lge: TÃ¼rkiye\n\n"
                result_msg += f"ğŸ“ˆ Ä°STATÄ°STÄ°KLER:\n"
                result_msg += f"   Mevcut Ä°lgi Skoru: {current_value}/100\n"
                result_msg += f"   Ortalama: {avg_value:.1f}\n"
                result_msg += f"   Maksimum: {max_value}\n"
                result_msg += f"   Minimum: {min_value}\n\n"
                result_msg += f"ğŸ“‰ TREND YÃ–NÃœ: {trend_direction}\n"
                result_msg += f"   DeÄŸiÅŸim: {change_pct:+.1f}%\n\n"
                result_msg += f"ğŸ’¡ YORUM:\n"
                
                if current_value > 75:
                    result_msg += f"   ğŸ”¥ Ã‡ok yÃ¼ksek ilgi! Bu terim ÅŸu anda Ã§ok popÃ¼ler.\n"
                elif current_value > 50:
                    result_msg += f"   âœ… YÃ¼ksek ilgi seviyesi. Ä°yi bir trend.\n"
                elif current_value > 25:
                    result_msg += f"   âš ï¸ Orta seviye ilgi. Potansiyel var.\n"
                else:
                    result_msg += f"   ğŸ“‰ DÃ¼ÅŸÃ¼k ilgi seviyesi.\n"
                
                if change_pct > 50:
                    result_msg += f"   ğŸš€ HÄ±zlÄ± yÃ¼kseliÅŸ! Viral olabilir.\n"
                elif change_pct < -50:
                    result_msg += f"   âš ï¸ HÄ±zlÄ± dÃ¼ÅŸÃ¼ÅŸ! Ä°lgi azalÄ±yor.\n"
                
                # UI'yi gÃ¼ncelle
                root.after(0, lambda: update_result_text(result_msg))
                root.after(0, lambda: draw_trend_chart(dates, values, search_term, trend_color))
                
            except Exception as e:
                error_msg = f"âŒ Hata oluÅŸtu\n\n"
                error_type = type(e).__name__
                error_details = str(e)
                
                # Google Trends Ã¶zel hata mesajlarÄ±
                if "429" in error_details or "Too Many Requests" in error_details:
                    error_msg += "â³ Google Trends Ã§ok fazla istek algÄ±ladÄ±.\n\n"
                    error_msg += "Ã‡Ã¶zÃ¼mler:\n"
                    error_msg += "â€¢ 10-15 dakika bekleyip tekrar deneyin\n"
                    error_msg += "â€¢ FarklÄ± bir arama terimi deneyin\n"
                    error_msg += "â€¢ Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin\n"
                elif "ResponseError" in error_type or "400" in error_details:
                    error_msg += "ğŸ” Arama terimi veya zaman aralÄ±ÄŸÄ± hatalÄ± olabilir.\n\n"
                    error_msg += "Ã‡Ã¶zÃ¼mler:\n"
                    error_msg += "â€¢ Daha genel bir terim deneyin (Ã¶r: 'moda' yerine 'tekstil')\n"
                    error_msg += "â€¢ TÃ¼rkÃ§e karakterler kullanmayÄ± deneyin\n"
                    error_msg += "â€¢ FarklÄ± bir zaman aralÄ±ÄŸÄ± seÃ§in\n"
                elif "Timeout" in error_type or "timeout" in error_details.lower():
                    error_msg += "â±ï¸ Ä°stek zaman aÅŸÄ±mÄ±na uÄŸradÄ±.\n\n"
                    error_msg += "Ã‡Ã¶zÃ¼mler:\n"
                    error_msg += "â€¢ Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin\n"
                    error_msg += "â€¢ BirkaÃ§ saniye bekleyip tekrar deneyin\n"
                else:
                    error_msg += f"Hata Tipi: {error_type}\n"
                    error_msg += f"Detay: {error_details}\n\n"
                    error_msg += "Ã‡Ã¶zÃ¼mler:\n"
                    error_msg += "â€¢ FarklÄ± bir arama terimi deneyin\n"
                    error_msg += "â€¢ Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin\n"
                    error_msg += "â€¢ BirkaÃ§ dakika sonra tekrar deneyin\n"
                    error_msg += "â€¢ pytrends kÃ¼tÃ¼phanesinin yÃ¼klÃ¼ olduÄŸundan emin olun\n"
                
                root.after(0, lambda: update_result_text(error_msg))
        
        # Thread baÅŸlat
        threading.Thread(target=_search_thread, daemon=True).start()
    
    def update_result_text(text):
        """SonuÃ§ metnini gÃ¼ncelle"""
        result_text.configure(state="normal")
        result_text.delete("1.0", tk.END)
        result_text.insert("1.0", text)
        result_text.configure(state="disabled")
    
    def draw_trend_chart(dates, values, term, trend_color):
        """Trend grafiÄŸini Ã§iz"""
        for widget in chart_frame.winfo_children():
            widget.destroy()
        
        fig = plt.figure(figsize=(12, 5), dpi=100)
        ax = fig.add_subplot(111)
        
        # Grafik Ã§iz
        ax.plot(dates, values, marker='o', linewidth=2, color=trend_color, label=term)
        ax.fill_between(range(len(dates)), values, alpha=0.3, color=trend_color)
        
        ax.set_title(f"'{term}' Trend GrafiÄŸi - Google Trends (TÃ¼rkiye)", 
                    fontsize=14, fontweight='bold')
        ax.set_xlabel("Tarih", fontsize=11)
        ax.set_ylabel("Ä°lgi Skoru (0-100)", fontsize=11)
        ax.legend(loc='best')
        ax.grid(True, alpha=0.3)
        
        # X ekseni etiketlerini dÃ¶ndÃ¼r
        ax.tick_params(axis='x', rotation=45)
        for label in ax.get_xticklabels():
            label.set_ha('right')
        fig.tight_layout()
        
        canvas = FigureCanvasTkAgg(fig, master=chart_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)
    
    ttk.Button(button_frame, text="ğŸ” Ara ve Analiz Et", command=search_trends).pack(side="left", padx=5)
    ttk.Button(button_frame, text="ğŸ”„ Temizle", command=lambda: (search_entry.delete(0, tk.END), 
                                                                  result_text.configure(state="normal"),
                                                                  result_text.delete("1.0", tk.END),
                                                                  result_text.insert("1.0", "Arama terimi girin ve 'Ara ve Analiz Et' butonuna basÄ±n."),
                                                                  result_text.configure(state="disabled"),
                                                                  [w.destroy() for w in chart_frame.winfo_children()])).pack(side="left", padx=5)
    
    # Grafik AlanÄ±
    chart_frame = tk.LabelFrame(main_content, text="ğŸ“Š Trend GrafiÄŸi", 
                                font=("Segoe UI", 12, "bold"), bg="white", fg="#2c3e50",
                                padx=10, pady=10)
    chart_frame.pack(fill="both", expand=True, pady=(0, 15))
    
    tk.Label(chart_frame, text="Grafik burada gÃ¶rÃ¼necek...", bg="white", fg="gray", 
            font=("Segoe UI", 12)).pack(expand=True)
    
    # SonuÃ§ AlanÄ±
    result_frame = tk.LabelFrame(main_content, text="ğŸ“ˆ Analiz SonuÃ§larÄ±", 
                                 font=("Segoe UI", 12, "bold"), bg="white", fg="#2c3e50",
                                 padx=10, pady=10)
    result_frame.pack(fill="both", expand=False)
    
    result_text = tk.Text(result_frame, wrap="word", font=("Courier New", 10), 
                         bg="#fdfefe", height=12)
    result_text.pack(fill="both", expand=True)
    result_text.insert("1.0", "Arama terimi girin ve 'Ara ve Analiz Et' butonuna basÄ±n.")
    result_text.configure(state="disabled")

# ---------- SÄ°PARÄ°Å AÅAMA TAKÄ°BÄ° - GANT PLANI (PRODUCTION PIPELINE) ----------

def init_production_pipeline_tab():
    """SipariÅŸ AÅŸama Takibi - Gantt PlanÄ± sekmesini oluÅŸturur"""
    global frame_production_pipeline
    
    for widget in frame_production_pipeline.winfo_children(): widget.destroy()
    
    # BaÅŸlÄ±k
    header = tk.Frame(frame_production_pipeline, bg="#34495e", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="ğŸ“Š SipariÅŸ AÅŸama Takibi - GANT PlanÄ±", font=("Segoe UI", 18, "bold"), fg="white", bg="#34495e").pack(side="left")
    tk.Label(header, text="Tekstil Ãœretim HattÄ± GÃ¶rselleÅŸtirme Sistemi", font=("Segoe UI", 10), fg="#ecf0f1", bg="#34495e").pack(side="left", padx=10)
    
    # Ana iÃ§erik paneli
    content = tk.PanedWindow(frame_production_pipeline, orient=tk.HORIZONTAL)
    content.pack(fill="both", expand=True, pady=10)
    
    # Sol Panel: SipariÅŸ KontrolÃ¼
    left_panel = tk.Frame(content, bg="white", padx=15, pady=15)
    content.add(left_panel, width=350)
    
    tk.Label(left_panel, text="ğŸ¯ SipariÅŸ YÃ¶netimi", font=("Segoe UI", 12, "bold"), fg="#2c3e50", bg="white").pack(anchor="w", pady=(0,10))
    
    # SipariÅŸ Ekleme
    add_frame = tk.LabelFrame(left_panel, text="Yeni SipariÅŸ Ekle", bg="#f8f9fa", fg="#34495e", font=("Segoe UI", 9, "bold"), padx=10, pady=10)
    add_frame.pack(fill="x", pady=10)
    
    tk.Label(add_frame, text="SipariÅŸ No:", bg="#f8f9fa").grid(row=0, column=0, sticky="w", pady=5)
    order_no_entry = ttk.Entry(add_frame, width=20)
    order_no_entry.grid(row=0, column=1, pady=5, padx=5)
    
    tk.Label(add_frame, text="SipariÅŸ AdÄ±:", bg="#f8f9fa").grid(row=1, column=0, sticky="w", pady=5)
    order_name_entry = ttk.Entry(add_frame, width=20)
    order_name_entry.grid(row=1, column=1, pady=5, padx=5)
    
    # AÅŸama Durumu GÃ¼ncelleme
    update_frame = tk.LabelFrame(left_panel, text="AÅŸama Durumu GÃ¼ncelle", bg="#e8f5e9", fg="#27ae60", font=("Segoe UI", 9, "bold"), padx=10, pady=10)
    update_frame.pack(fill="x", pady=10)
    
    tk.Label(update_frame, text="SipariÅŸ SeÃ§:", bg="#e8f5e9").grid(row=0, column=0, sticky="w", pady=5)
    order_select_combo = ttk.Combobox(update_frame, width=18, state="readonly")
    order_select_combo.grid(row=0, column=1, pady=5, padx=5)
    
    tk.Label(update_frame, text="AÅŸama:", bg="#e8f5e9").grid(row=1, column=0, sticky="w", pady=5)
    stage_combo = ttk.Combobox(update_frame, width=18, state="readonly")
    stage_combo['values'] = ["Ä°plik â†’ KumaÅŸ", "Boyama", "Paketleme", "Sevkiyat"]
    stage_combo.grid(row=1, column=1, pady=5, padx=5)
    
    tk.Label(update_frame, text="Durum (%):", bg="#e8f5e9").grid(row=2, column=0, sticky="w", pady=5)
    progress_scale = ttk.Scale(update_frame, from_=0, to=100, orient="horizontal")
    progress_scale.grid(row=2, column=1, pady=5, padx=5)
    progress_label = tk.Label(update_frame, text="0%", bg="#e8f5e9", font=("Segoe UI", 9, "bold"))
    progress_label.grid(row=2, column=2, pady=5)
    
    def update_progress_label(val):
        progress_label.configure(text=f"{int(float(val))}%")
    
    progress_scale.configure(command=update_progress_label)
    
    # SaÄŸ Panel: GANT Chart
    right_panel = tk.Frame(content, bg="white", padx=20, pady=10)
    content.add(right_panel)
    
    chart_frame = tk.Frame(right_panel, bg="white")
    chart_frame.pack(fill="both", expand=True)
    
    # Fonksiyonlar
    def add_order():
        order_no = order_no_entry.get().strip()
        order_name = order_name_entry.get().strip()
        
        if not order_no or not order_name:
            messagebox.showwarning("Eksik Bilgi", "LÃ¼tfen sipariÅŸ no ve adÄ± girin.")
            return
        
        if order_no in production_orders_global:
            messagebox.showwarning("UyarÄ±", "Bu sipariÅŸ numarasÄ± zaten mevcut.")
            return
        
        # Yeni sipariÅŸ ekle (baÅŸlangÄ±Ã§ta tÃ¼m aÅŸamalar %0)
        production_orders_global[order_no] = {
            'name': order_name,
            'stages': {
                'Ä°plik â†’ KumaÅŸ': 0,
                'Boyama': 0,
                'Paketleme': 0,
                'Sevkiyat': 0
            },
            'start_date': datetime.datetime.now()
        }
        
        order_no_entry.delete(0, tk.END)
        order_name_entry.delete(0, tk.END)
        
        update_order_list()
        draw_gantt_chart()
        
        if activity_logger:
            activity_logger.log_event("ORDER_ADDED", f"SipariÅŸ eklendi: {order_no} - {order_name}", "Ãœretim Takibi")
    
    def update_stage():
        order_no = order_select_combo.get()
        stage = stage_combo.get()
        progress = int(progress_scale.get())
        
        if not order_no or not stage:
            messagebox.showwarning("Eksik Bilgi", "LÃ¼tfen sipariÅŸ ve aÅŸama seÃ§in.")
            return
        
        if order_no in production_orders_global:
            production_orders_global[order_no]['stages'][stage] = progress
            draw_gantt_chart()
            messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{order_no} - {stage}: %{progress} gÃ¼ncellendi.")
            
            if activity_logger:
                activity_logger.log_event("STAGE_UPDATED", f"{order_no} - {stage}: {progress}%", "Ãœretim Takibi")
        else:
            messagebox.showerror("Hata", "SipariÅŸ bulunamadÄ±.")
    
    def update_order_list():
        order_list = list(production_orders_global.keys())
        order_select_combo['values'] = order_list
        if order_list:
            order_select_combo.set(order_list[0])
    
    def draw_gantt_chart():
        """GANT grafiÄŸini matplotlib ile Ã§izer"""
        for widget in chart_frame.winfo_children():
            widget.destroy()
        
        if not production_orders_global:
            tk.Label(chart_frame, text="HenÃ¼z sipariÅŸ eklenmedi.\nSol panelden sipariÅŸ ekleyin.", 
                    font=("Segoe UI", 12), fg="gray", bg="white").pack(expand=True)
            return
        
        fig = plt.figure(figsize=(10, 6), dpi=100)
        ax = fig.add_subplot(111)
        
        stages = ['Ä°plik â†’ KumaÅŸ', 'Boyama', 'Paketleme', 'Sevkiyat']
        colors = ['#3498db', '#9b59b6', '#e74c3c', '#2ecc71']
        
        y_pos = 0
        y_labels = []
        
        for order_no, order_data in production_orders_global.items():
            order_name = order_data['name']
            y_labels.append(f"{order_no}\n{order_name}")
            
            x_start = 0
            for idx, stage in enumerate(stages):
                progress = order_data['stages'][stage]
                width = progress / 100.0  # Her aÅŸama maksimum 1 birim
                
                if width > 0:
                    ax.barh(y_pos, width, left=x_start, height=0.6, 
                           color=colors[idx], alpha=0.8, 
                           edgecolor='black', linewidth=0.5)
                    
                    # Ä°lerleme yÃ¼zdesini gÃ¶ster
                    if width > 0.15:  # Sadece yeterince geniÅŸ Ã§ubuklar iÃ§in
                        ax.text(x_start + width/2, y_pos, f'{int(progress)}%', 
                               ha='center', va='center', fontsize=8, fontweight='bold', color='white')
                
                x_start += 1  # Her aÅŸama 1 birim geniÅŸliÄŸinde
            
            y_pos += 1
        
        ax.set_yticks(range(len(y_labels)))
        ax.set_yticklabels(y_labels, fontsize=9)
        ax.set_xticks(range(len(stages) + 1))
        ax.set_xticklabels([''] + stages, rotation=15, ha='right', fontsize=9)
        ax.set_xlabel('Ãœretim AÅŸamalarÄ±', fontsize=10, fontweight='bold')
        ax.set_ylabel('SipariÅŸler', fontsize=10, fontweight='bold')
        ax.set_title('Tekstil Ãœretim HattÄ± - Gantt PlanÄ±', fontsize=12, fontweight='bold')
        ax.set_xlim(0, len(stages))
        ax.grid(axis='x', alpha=0.3, linestyle='--')
        
        # Lejant ekle
        from matplotlib.patches import Patch
        legend_elements = [Patch(facecolor=colors[i], label=stages[i]) for i in range(len(stages))]
        ax.legend(handles=legend_elements, loc='upper right', fontsize=8)
        
        plt.tight_layout()
        
        canvas = FigureCanvasTkAgg(fig, master=chart_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)
        
        # Toolbar ekle
        toolbar_frame = tk.Frame(chart_frame)
        toolbar_frame.pack(fill="x")
        toolbar = NavigationToolbar2Tk(canvas, toolbar_frame)
        toolbar.update()
    
    # Butonlar
    ttk.Button(add_frame, text="â• SipariÅŸ Ekle", command=add_order).grid(row=2, column=0, columnspan=2, pady=10)
    ttk.Button(update_frame, text="ğŸ”„ Durumu GÃ¼ncelle", command=update_stage).grid(row=3, column=0, columnspan=3, pady=10)
    
    # Ã–rnek veriler ekle (ilk aÃ§Ä±lÄ±ÅŸta)
    if not production_orders_global:
        production_orders_global['ORD-001'] = {
            'name': 'Pamuklu GÃ¶mlek',
            'stages': {'Ä°plik â†’ KumaÅŸ': 100, 'Boyama': 75, 'Paketleme': 30, 'Sevkiyat': 0},
            'start_date': datetime.datetime.now() - timedelta(days=5)
        }
        production_orders_global['ORD-002'] = {
            'name': 'Denim Pantolon',
            'stages': {'Ä°plik â†’ KumaÅŸ': 100, 'Boyama': 100, 'Paketleme': 80, 'Sevkiyat': 20},
            'start_date': datetime.datetime.now() - timedelta(days=7)
        }
        production_orders_global['ORD-003'] = {
            'name': 'Polyester Ceket',
            'stages': {'Ä°plik â†’ KumaÅŸ': 60, 'Boyama': 0, 'Paketleme': 0, 'Sevkiyat': 0},
            'start_date': datetime.datetime.now() - timedelta(days=2)
        }
    
    update_order_list()
    draw_gantt_chart()

# ---------- HAMMADDE FÄ°YAT Ä°STÄ°HBARATI (COMMODITY INTELLIGENCE) ----------
# Price simulation constants
PRICE_VARIANCE_FACTOR = 0.15  # Â±15% price fluctuation
TREND_START_FACTOR = 0.90     # Trend starts at 90% of current price
PRICE_BLEND_RATIO = 0.7       # 70% random, 30% trend
TREND_BLEND_RATIO = 0.3       # Complement of PRICE_BLEND_RATIO

def init_commodity_intelligence_tab():
    """Hammadde Fiyat Ä°stihbaratÄ± sekmesini oluÅŸturur"""
    global frame_commodity_intel
    
    for widget in frame_commodity_intel.winfo_children(): widget.destroy()
    
    # BaÅŸlÄ±k
    header = tk.Frame(frame_commodity_intel, bg="#16a085", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="ğŸ’¹ Hammadde Fiyat Ä°stihbaratÄ±", font=("Segoe UI", 18, "bold"), fg="white", bg="#16a085").pack(side="left")
    tk.Label(header, text="GerÃ§ek ZamanlÄ± Emtia Fiyat Takibi ve Analiz Sistemi", font=("Segoe UI", 10), fg="#d5f4e6", bg="#16a085").pack(side="left", padx=10)
    
    # Ana iÃ§erik
    content = tk.PanedWindow(frame_commodity_intel, orient=tk.VERTICAL)
    content.pack(fill="both", expand=True, pady=10)
    
    # Ãœst Panel: Fiyat KartlarÄ±
    top_panel = tk.Frame(content, bg="#ecf0f1", padx=20, pady=15)
    content.add(top_panel, height=200)
    
    tk.Label(top_panel, text="ğŸ“Š GÃ¼ncel Emtia FiyatlarÄ±", font=("Segoe UI", 12, "bold"), fg="#2c3e50", bg="#ecf0f1").pack(anchor="w", pady=(0,10))
    
    cards_frame = tk.Frame(top_panel, bg="#ecf0f1")
    cards_frame.pack(fill="x")
    
    # Alt Panel: Grafik ve Kontroller
    bottom_panel = tk.Frame(content, bg="white")
    content.add(bottom_panel)
    
    # Kontrol paneli
    control_frame = tk.Frame(bottom_panel, bg="#f8f9fa", padx=15, pady=15)
    control_frame.pack(fill="x")
    
    tk.Label(control_frame, text="Emtia SeÃ§:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=5)
    commodity_combo = ttk.Combobox(control_frame, width=20, state="readonly")
    commodity_combo['values'] = ["Pamuk (Cotlook A Index)", "Polyester", "Viskon"]
    commodity_combo.set("Pamuk (Cotlook A Index)")
    commodity_combo.pack(side="left", padx=5)
    
    tk.Label(control_frame, text="Zaman AralÄ±ÄŸÄ±:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=15)
    period_combo = ttk.Combobox(control_frame, width=12, state="readonly")
    period_combo['values'] = ["30 GÃ¼n", "90 GÃ¼n", "365 GÃ¼n"]
    period_combo.set("30 GÃ¼n")
    period_combo.pack(side="left", padx=5)
    
    # Grafik alanÄ±
    chart_frame = tk.Frame(bottom_panel, bg="white")
    chart_frame.pack(fill="both", expand=True, padx=20, pady=10)
    
    # Alert alanÄ±
    alert_frame = tk.LabelFrame(bottom_panel, text="âš ï¸ Fiyat UyarÄ±larÄ±", bg="#fff3cd", fg="#856404", font=("Segoe UI", 10, "bold"), padx=15, pady=10)
    alert_frame.pack(fill="x", padx=20, pady=10)
    
    alert_text = tk.Text(alert_frame, height=4, wrap="word", font=("Segoe UI", 9), bg="#fffaeb", fg="#856404", bd=0)
    alert_text.pack(fill="x")
    alert_text.insert("1.0", "Fiyat uyarÄ±larÄ± burada gÃ¶rÃ¼necek...")
    alert_text.configure(state="disabled")
    
    # Fonksiyonlar
    def fetch_real_commodity_data():
        """GerÃ§ek emtia fiyatlarÄ±nÄ± Yahoo Finance'den Ã§eker"""
        global YFINANCE_AVAILABLE
        
        commodity_prices_global.clear()
        
        if YFINANCE_AVAILABLE:
            try:
                # Pamuk (Cotton) - CT=F (ICEUS Cotton No.2)
                cotton_ticker = yf.Ticker("CT=F")
                cotton_hist = cotton_ticker.history(period="2d")
                
                if not cotton_hist.empty and len(cotton_hist) >= 1:
                    cotton_current = cotton_hist['Close'].iloc[-1]
                    cotton_previous = cotton_hist['Close'].iloc[-2] if len(cotton_hist) >= 2 else cotton_current * 0.99
                    
                    commodity_prices_global['Pamuk (Cotlook A Index)'] = {
                        'current': float(cotton_current),
                        'previous': float(cotton_previous),
                        'unit': 'USD/lb',
                        'change': float(cotton_current - cotton_previous)
                    }
                    print(f"Pamuk fiyatÄ± Ã§ekildi: {cotton_current:.2f} USD/lb")
                else:
                    print("Pamuk fiyatÄ± Ã§ekilemedi, varsayÄ±lan deÄŸer kullanÄ±lÄ±yor")
                    commodity_prices_global['Pamuk (Cotlook A Index)'] = {
                        'current': 94.20,
                        'previous': 92.50,
                        'unit': 'USD/lb',
                        'change': 1.7
                    }
                
                # Polyester (PET) - Polyester iÃ§in doÄŸrudan ticker yok, tahmin kullanÄ±yoruz
                # Petrol fiyatlarÄ±na baÄŸlÄ± olarak hareket eder
                try:
                    oil_ticker = yf.Ticker("CL=F")  # Crude Oil WTI
                    oil_hist = oil_ticker.history(period="2d")
                    
                    if not oil_hist.empty:
                        oil_price = oil_hist['Close'].iloc[-1]
                        # Polyester fiyatÄ± yaklaÅŸÄ±k olarak petrol fiyatÄ±na gÃ¶re hesaplanÄ±r
                        # 1 varil petrol â‰ˆ 159 litre, polyester Ã¼retimi iÃ§in maliyet faktÃ¶rÃ¼
                        polyester_base = 1200
                        polyester_current = polyester_base + (float(oil_price) - 70) * 10
                        polyester_previous = polyester_current * 0.98
                        
                        commodity_prices_global['Polyester'] = {
                            'current': float(polyester_current),
                            'previous': float(polyester_previous),
                            'unit': 'USD/ton',
                            'change': float(polyester_current - polyester_previous)
                        }
                        print(f"Polyester fiyatÄ± hesaplandÄ±: {polyester_current:.0f} USD/ton (Petrol: {oil_price:.2f})")
                    else:
                        raise Exception("Petrol fiyatÄ± Ã§ekilemedi")
                        
                except Exception as e:
                    print(f"Polyester fiyatÄ± hesaplanamadÄ±: {e}, varsayÄ±lan deÄŸer kullanÄ±lÄ±yor")
                    commodity_prices_global['Polyester'] = {
                        'current': 1350,
                        'previous': 1420,
                        'unit': 'USD/ton',
                        'change': -70
                    }
                
                # Viskon (Viscose) - DoÄŸrudan ticker yok, pamuk fiyatÄ±na gÃ¶re tahmin
                if 'Pamuk (Cotlook A Index)' in commodity_prices_global:
                    cotton_price_cents = commodity_prices_global['Pamuk (Cotlook A Index)']['current'] * 100  # cent/lb
                    viscose_current = cotton_price_cents * 9.5  # YaklaÅŸÄ±k Ã§arpan
                    viscose_previous = viscose_current * 0.98
                    
                    commodity_prices_global['Viskon'] = {
                        'current': float(viscose_current),
                        'previous': float(viscose_previous),
                        'unit': 'USD/ton',
                        'change': float(viscose_current - viscose_previous)
                    }
                    print(f"Viskon fiyatÄ± hesaplandÄ±: {viscose_current:.0f} USD/ton")
                else:
                    commodity_prices_global['Viskon'] = {
                        'current': 2100,
                        'previous': 2050,
                        'unit': 'USD/ton',
                        'change': 50
                    }
                    
            except Exception as e:
                print(f"GerÃ§ek veri Ã§ekme hatasÄ±: {e}, varsayÄ±lan deÄŸerler kullanÄ±lÄ±yor")
                # Hata durumunda varsayÄ±lan deÄŸerleri yÃ¼kle
                commodity_prices_global['Pamuk (Cotlook A Index)'] = {
                    'current': 94.20,
                    'previous': 92.50,
                    'unit': 'USD/lb',
                    'change': 1.7
                }
                commodity_prices_global['Polyester'] = {
                    'current': 1350,
                    'previous': 1420,
                    'unit': 'USD/ton',
                    'change': -70
                }
                commodity_prices_global['Viskon'] = {
                    'current': 2100,
                    'previous': 2050,
                    'unit': 'USD/ton',
                    'change': 50
                }
        else:
            # yfinance kÃ¼tÃ¼phanesi yoksa varsayÄ±lan deÄŸerler
            print("YFinance kÃ¼tÃ¼phanesi yÃ¼klÃ¼ deÄŸil, varsayÄ±lan deÄŸerler kullanÄ±lÄ±yor")
            commodity_prices_global['Pamuk (Cotlook A Index)'] = {
                'current': 94.20,
                'previous': 92.50,
                'unit': 'USD/lb',
                'change': 1.7
            }
            commodity_prices_global['Polyester'] = {
                'current': 1350,
                'previous': 1420,
                'unit': 'USD/ton',
                'change': -70
            }
            commodity_prices_global['Viskon'] = {
                'current': 2100,
                'previous': 2050,
                'unit': 'USD/ton',
                'change': 50
            }
        
        # GeÃ§miÅŸ fiyat verisi oluÅŸtur (gerÃ§ek tarihsel veri veya simÃ¼lasyon)
        commodity_history_global.clear()
        
        for commodity in commodity_prices_global.keys():
            base_price = commodity_prices_global[commodity]['current']
            history = {}
            
            # Her zaman aralÄ±ÄŸÄ± iÃ§in geÃ§miÅŸ veri oluÅŸtur
            for days in [30, 90, 365]:
                if YFINANCE_AVAILABLE:
                    try:
                        # GerÃ§ek tarihsel veri Ã§ekmeyi dene
                        if commodity == 'Pamuk (Cotlook A Index)':
                            ticker = yf.Ticker("CT=F")
                            hist = ticker.history(period=f"{days}d")
                            
                            if not hist.empty and len(hist) > 0:
                                dates = [d.strftime("%Y-%m-%d") for d in hist.index]
                                prices = hist['Close'].tolist()
                                history[days] = {'dates': dates, 'prices': prices}
                                continue
                    except Exception as e:
                        print(f"{commodity} iÃ§in {days} gÃ¼nlÃ¼k gerÃ§ek veri Ã§ekilemedi: {e}")
                
                # GerÃ§ek veri Ã§ekilemezse simÃ¼lasyon oluÅŸtur
                dates = [(datetime.datetime.now() - timedelta(days=i)).strftime("%Y-%m-%d") for i in range(days, -1, -1)]
                prices = [base_price + random.uniform(-base_price*PRICE_VARIANCE_FACTOR, base_price*PRICE_VARIANCE_FACTOR) for _ in dates]
                trend = np.linspace(base_price * TREND_START_FACTOR, base_price, len(prices))
                prices = [p * PRICE_BLEND_RATIO + t * TREND_BLEND_RATIO for p, t in zip(prices, trend)]
                history[days] = {'dates': dates, 'prices': prices}
            
            commodity_history_global[commodity] = history
    
    def update_price_cards():
        """Fiyat kartlarÄ±nÄ± gÃ¼nceller"""
        for widget in cards_frame.winfo_children():
            widget.destroy()
        
        col = 0
        for commodity, data in commodity_prices_global.items():
            card = tk.Frame(cards_frame, bg="white", bd=1, relief="solid", padx=15, pady=15)
            card.grid(row=0, column=col, padx=10, sticky="ew")
            cards_frame.grid_columnconfigure(col, weight=1)
            
            # Ä°sim
            tk.Label(card, text=commodity, font=("Segoe UI", 10, "bold"), fg="#34495e", bg="white").pack(anchor="w")
            
            # Fiyat
            price_frame = tk.Frame(card, bg="white")
            price_frame.pack(fill="x", pady=5)
            tk.Label(price_frame, text=f"{data['current']:.2f}", font=("Segoe UI", 18, "bold"), fg="#2c3e50", bg="white").pack(side="left")
            tk.Label(price_frame, text=f" {data['unit']}", font=("Segoe UI", 10), fg="#7f8c8d", bg="white").pack(side="left")
            
            # DeÄŸiÅŸim
            change = data['change']
            change_color = "#27ae60" if change >= 0 else "#e74c3c"
            change_icon = "â–²" if change >= 0 else "â–¼"
            change_text = f"{change_icon} {abs(change):.2f}"
            if abs(change) >= 1:
                change_pct = (change / data['previous']) * 100
                change_text += f" ({change_pct:+.1f}%)"
            
            tk.Label(card, text=change_text, font=("Segoe UI", 9, "bold"), fg=change_color, bg="white").pack(anchor="w")
            
            col += 1
    
    def update_chart():
        """SeÃ§ilen emtia iÃ§in fiyat grafiÄŸini Ã§izer"""
        for widget in chart_frame.winfo_children():
            widget.destroy()
        
        commodity = commodity_combo.get()
        period_text = period_combo.get()
        period = int(period_text.split()[0])
        
        if commodity not in commodity_history_global:
            tk.Label(chart_frame, text="Veri yÃ¼kleniyor...", font=("Segoe UI", 12), fg="gray", bg="white").pack(expand=True)
            return
        
        history = commodity_history_global[commodity][period]
        dates = history['dates']
        prices = history['prices']
        
        fig = plt.figure(figsize=(10, 4), dpi=100)
        ax = fig.add_subplot(111)
        
        # Fiyat Ã§izgisi
        ax.plot(dates, prices, linewidth=2, color='#3498db', marker='o', markersize=3, label='Fiyat')
        
        # Hareketli ortalama ekle
        if len(prices) > 7:
            ma = pd.Series(prices).rolling(window=7).mean()
            ax.plot(dates, ma, linewidth=2, color='#e74c3c', linestyle='--', label='7 GÃ¼nlÃ¼k Ortalama')
        
        # GÃ¼ncel fiyat Ã§izgisi
        current_price = commodity_prices_global[commodity]['current']
        ax.axhline(y=current_price, color='#27ae60', linestyle=':', linewidth=1.5, label=f'GÃ¼ncel: {current_price:.2f}')
        
        ax.set_title(f'{commodity} - Son {period} GÃ¼n Fiyat GeÃ§miÅŸi', fontsize=12, fontweight='bold')
        ax.set_xlabel('Tarih', fontsize=10)
        ax.set_ylabel(f'Fiyat ({commodity_prices_global[commodity]["unit"]})', fontsize=10)
        ax.legend(loc='best', fontsize=9)
        ax.grid(True, alpha=0.3, linestyle='--')
        
        # X ekseni etiketlerini dÃ¶ndÃ¼r
        every_nth = max(1, len(dates) // 10)
        ax.set_xticks(range(0, len(dates), every_nth))
        ax.set_xticklabels([dates[i] for i in range(0, len(dates), every_nth)], rotation=45, ha='right', fontsize=8)
        
        plt.tight_layout()
        
        canvas = FigureCanvasTkAgg(fig, master=chart_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)
    
    def update_alerts():
        """Fiyat uyarÄ±larÄ±nÄ± gÃ¼nceller"""
        alert_text.configure(state="normal")
        alert_text.delete("1.0", tk.END)
        
        alerts = []
        for commodity, data in commodity_prices_global.items():
            current = data['current']
            previous = data['previous']
            
            if current > 0 and previous > 0:
                pct_change = ((current - previous) / previous) * 100
                
                if abs(pct_change) >= 5:
                    icon = "ğŸ”´" if pct_change > 0 else "ğŸŸ¢"
                    direction = "yÃ¼ksek" if pct_change > 0 else "dÃ¼ÅŸÃ¼k"
                    alerts.append(f"{icon} {commodity}: Bu fiyat %{abs(pct_change):.1f} {direction}! (Referans: {previous:.2f})")
        
        if alerts:
            alert_text.insert("1.0", "\n".join(alerts))
        else:
            alert_text.insert("1.0", "âœ… TÃ¼m emtia fiyatlarÄ± normal aralÄ±kta.")
        
        alert_text.configure(state="disabled")
    
    def refresh_data():
        """TÃ¼m verileri yeniler"""
        fetch_real_commodity_data()
        update_price_cards()
        update_chart()
        update_alerts()
        
        if activity_logger:
            activity_logger.log_event("COMMODITY_DATA_REFRESH", "Emtia fiyatlarÄ± gÃ¼ncellendi", "Hammadde Ä°stihbaratÄ±")
    
    # Yenile butonu
    ttk.Button(control_frame, text="ğŸ”„ Verileri Yenile", command=refresh_data).pack(side="left", padx=15)
    ttk.Button(control_frame, text="ğŸ“Š GrafiÄŸi GÃ¼ncelle", command=update_chart).pack(side="left", padx=5)
    
    # Combobox deÄŸiÅŸikliklerinde grafiÄŸi gÃ¼ncelle
    commodity_combo.bind("<<ComboboxSelected>>", lambda e: update_chart())
    period_combo.bind("<<ComboboxSelected>>", lambda e: update_chart())
    
    # Ä°lk veri yÃ¼klemesi
    refresh_data()

# ---------- REKLAMASYON YÃ–NETÄ°MÄ° FONKSÄ°YONLARI ----------
# YardÄ±mcÄ± Fonksiyonlar
def clean_currency_rek(val):
    """Para ve sayÄ± formatÄ±nÄ± temizler"""
    if pd.isna(val) or str(val).strip() in ['-', '', 'nan', 'NaT']: return 0.0
    if isinstance(val, (int, float)): return float(val)
    val = str(val).replace('â‚º', '').replace(' ', '')
    if '.' in val and ',' in val: val = val.replace('.', '').replace(',', '.')
    elif ',' in val: val = val.replace(',', '.')
    try: return float(val)
    except: return 0.0

def tr_to_eng(text):
    """TÃ¼rkÃ§e karakterleri Ä°ngilizce'ye Ã§evirir"""
    if not isinstance(text, str): return str(text)
    tr_map = str.maketrans("ÄŸÄÄ±Ä°Ã¶Ã–Ã¼ÃœÅŸÅÃ§Ã‡", "gGiIoOuUsScC")
    return text.translate(tr_map)

def export_rek_df_to_excel(df, default_name="Export", auto_save=False):
    """DataFrame'i Excel'e aktarÄ±r"""
    if df is None or df.empty: return None
    if auto_save:
        filename = f"{default_name}_{datetime.date.today()}.xlsx"
        df.to_excel(filename, index=False)
        return filename
    f = filedialog.asksaveasfilename(initialfile=f"{default_name}_{datetime.date.today()}", defaultextension=".xlsx", filetypes=[("Excel Files", "*.xlsx")])
    if f:
        try: df.to_excel(f, index=False); messagebox.showinfo("BaÅŸarÄ±lÄ±", "Excel dosyasÄ± oluÅŸturuldu.")
        except Exception as e: messagebox.showerror("Hata", str(e))
    return None

def export_rek_df_to_pdf(df, title, default_name="Export", auto_save=False):
    """DataFrame'i PDF'e aktarÄ±r"""
    if df is None or df.empty: return None
    
    def create_pdf(filename):
        pdf = FPDF(orientation='L', unit='mm', format='A4')
        pdf.add_page()
        pdf.set_font("Arial", 'B', 14)
        pdf.cell(0, 10, tr_to_eng(title), ln=True, align='C')
        pdf.ln(5)
        pdf.set_font("Arial", 'B', 8)
        cols = df.columns
        col_w = 275 / len(cols)
        for col in cols: pdf.cell(col_w, 8, tr_to_eng(str(col))[:15], 1)
        pdf.ln()
        pdf.set_font("Arial", '', 7)
        for _, row in df.iterrows():
            for col in cols:
                val = str(row[col])
                pdf.cell(col_w, 6, tr_to_eng(val)[:20], 1)
            pdf.ln()
        pdf.output(filename)
        return filename

    if auto_save:
        filename = f"{default_name}_{datetime.date.today()}.pdf"
        try: return create_pdf(filename)
        except: return None
    
    f = filedialog.asksaveasfilename(initialfile=f"{default_name}_{datetime.date.today()}", defaultextension=".pdf", filetypes=[("PDF Files", "*.pdf")])
    if f:
        try: create_pdf(f); messagebox.showinfo("BaÅŸarÄ±lÄ±", "PDF dosyasÄ± oluÅŸturuldu.")
        except Exception as e: messagebox.showerror("Hata", str(e))
    return None

def create_reklamasyon_dummy_data():
    """Ã–rnek reklamasyon verisi oluÅŸturur"""
    data = {
        "FiÅŸ Tipi": ["62 - Mamul KumaÅŸ AlÄ±m Ä°rsaliyesi", "62 - Mamul KumaÅŸ AlÄ±m Ä°rsaliyesi", "63 - Mamul KumaÅŸ AlÄ±m Ä°ade", "63 - Mamul KumaÅŸ AlÄ±m Ä°ade", "52 - Verilen Reklamasyon FiÅŸi", "62 - Mamul KumaÅŸ AlÄ±m Ä°rsaliyesi"],
        "FiÅŸ Tarihi": ["06.01.2026", "10.01.2026", "13.01.2026", "07.01.2026", "15.01.2026", "01.01.2026"],
        "Cari AdÄ±": ["UNÄ°TY TEKSTÄ°L", "UNÄ°TY TEKSTÄ°L", "BÄ°RCAN KUMAÅ", "REHA BOYA", "Ã–ZYURT TEKSTÄ°L", "TARTEKS Ä°PLÄ°K"],
        "Order No": ["G8773A8-1805799", "G8773A8-1805799", "F8160AX", "F8666AX", "G5901A5", "E8430A5"],
        "MÃ¼ÅŸteri Termin Tarihi": ["01.04.2026", "01.04.2026", "10.01.2026", "05.01.2026", "20.01.2026", "05.01.2026"],
        "SipariÅŸ Termin Tarihi": ["17.01.2026", "08.01.2026", "10.01.2026", "05.01.2026", "10.01.2026", "05.01.2026"],
        "Stok Kodu": ["05 BRIBDUZ", "05 BSUPDUZ", "05 BSUPBSK", "05 BRIB", "05 BKKDUZ", "05 B2IP"],
        "Stok AdÄ±": ["RÄ°BANA 1X1", "SÃœPREM DÃœZ", "SÃœPREM BASKILI", "RÄ°BANA", "KAÅKORSE", "2 Ä°PLÄ°K"],
        "Var - 1": ["ER105-ECRU", "ER105-ECRU", "BLUE", "ANTHRA", "GREEN", "RED"],
        "Parti/Lab No": ["12223-3", "12223-1", "1506", "7215", "2907", "2500"],
        "SipariÅŸ FiÅŸi FiÅŸ No": ["5", "6", "10", "11", "12", "13"],
        "Tahsis Net Mik.": ["64,00", "365,00", "24,00", "50,00", "1,00", "100,00"],
        "Tahsis TutarÄ±": ["16.640,00", "91.250,00", "6.996,00", "13.250,00", "33.000,00", "15.000,00"],
        "AÃ§Ä±klama": ["", "", "Leke HatasÄ±", "Termin Gecikmesi", "Fiyat FarkÄ±", ""],
        "Stok FiÅŸi Detay Reklamasyon Sebepleri": ["", "", "Kalite Kontrol Red", "Termin Gecikmesi", "Kalite OnaylanmadÄ±", ""],
        "Order Grup AdÄ±": ["YÄ° Ã–RME-5 (ERKEK Ã‡OCUK/BEBEK)", "YÄ° Ã–RME-5 (ERKEK Ã‡OCUK/BEBEK)", "YÄ° Ã–RME-2 (YOUNG)", "YÄ° Ã–RME-2 (YOUNG)", "YÄ° Ã–RME-5 (ERKEK Ã‡OCUK/BEBEK)", "YÄ° Ã–RME-1 (SMART CORE)"]
    }
    df = pd.DataFrame(data)
    df["Tahsis TutarÄ±_Clean"] = df["Tahsis TutarÄ±"].apply(clean_currency_rek)
    df["Tahsis Net Mik._Clean"] = df["Tahsis Net Mik."].apply(clean_currency_rek)
    return df

def load_reklamasyon_data(filepath=None):
    """Reklamasyon verisini yÃ¼kler ve iÅŸler"""
    global df_reklamasyon_global
    try:
        if filepath: df = pd.read_excel(filepath)
        else: df = create_reklamasyon_dummy_data()
        
        df.rename(columns={"SipariÅŸ FiÅŸi Termin Tarihi": "SipariÅŸ Termin Tarihi", "Order MÃ¼ÅŸteri Termin Tarihi": "MÃ¼ÅŸteri Termin Tarihi"}, inplace=True)
        if "Tahsis TutarÄ±" in df.columns: df["Tahsis TutarÄ±_Clean"] = df["Tahsis TutarÄ±"].apply(clean_currency_rek)
        else: df["Tahsis TutarÄ±_Clean"] = 0.0
        qty_col = "Tahsis Net Mik." if "Tahsis Net Mik." in df.columns else "Net Mik."
        if qty_col in df.columns: df["Miktar_Clean"] = df[qty_col].apply(clean_currency_rek)
        else: df["Miktar_Clean"] = 0.0

        for col in ["FiÅŸ Tarihi", "MÃ¼ÅŸteri Termin Tarihi", "SipariÅŸ Termin Tarihi"]:
            if col in df.columns: df[col] = pd.to_datetime(df[col], dayfirst=True, errors='coerce')
            else: df[col] = pd.NaT

        df["Musteri_Gecikme"] = (df["FiÅŸ Tarihi"] - df["MÃ¼ÅŸteri Termin Tarihi"]).dt.days
        df["Siparis_Gecikme"] = (df["FiÅŸ Tarihi"] - df["SipariÅŸ Termin Tarihi"]).dt.days

        def determine_type(row):
            ft = str(row.get('FiÅŸ Tipi', '')).lower()
            if '52' in ft or 'reklamasyon' in ft: return 'Reklamasyon'
            if '63' in ft or 'iade' in ft: return 'Ä°ade'
            if '62' in ft or 'alÄ±m' in ft: return 'AlÄ±m'
            return 'DiÄŸer'
        df['Islem_Tipi'] = df.apply(determine_type, axis=1)

        def calculate_metrics(row):
            tip = row['Islem_Tipi']; gecikme = row['Siparis_Gecikme'] if pd.notna(row['Siparis_Gecikme']) else 0
            miktar = row['Miktar_Clean']; tutar = row['Tahsis TutarÄ±_Clean']
            on_time_qty = 0; late_qty = 0; return_qty = 0; reklamasyon_tutar = 0; iade_tutar = 0; alim_tutar = 0; alim_qty = 0; rek_qty = 0
            if tip == 'AlÄ±m':
                alim_tutar = tutar; alim_qty = miktar
                if gecikme <= 0: on_time_qty = miktar
                else: late_qty = miktar
            elif tip == 'Ä°ade': iade_tutar = tutar; return_qty = miktar
            elif tip == 'Reklamasyon': reklamasyon_tutar = tutar; rek_qty = miktar
            return pd.Series([on_time_qty, late_qty, return_qty, reklamasyon_tutar, iade_tutar, alim_tutar, alim_qty, rek_qty])

        df[['On_Time_Miktar', 'Geciken_Miktar', 'Iade_Edilen_Miktar', 'Reklamasyon_Tutari', 'Iade_Tutari', 'Alim_Tutari', 'Alim_Miktar', 'Reklamasyon_Miktar']] = df.apply(calculate_metrics, axis=1)

        def get_reklamasyon_sebebi_tutar(row):
            if row['Islem_Tipi'] not in ['Ä°ade', 'Reklamasyon']: return 0, 0
            aciklama = str(row.get("AÃ§Ä±klama", "")).lower(); detay_sebep = str(row.get("Stok FiÅŸi Detay Reklamasyon Sebepleri", "")).lower()
            tutar = row['Tahsis TutarÄ±_Clean']
            if "gecikme" in aciklama or "termin" in aciklama or "gecikme" in detay_sebep: return tutar, 0
            elif "kalite" in detay_sebep: return 0, tutar
            else: return 0, 0 

        df[['Kesinti_Gecikme', 'Kesinti_Kalite']] = df.apply(lambda r: pd.Series(get_reklamasyon_sebebi_tutar(r)), axis=1)
        if "Order Grup AdÄ±" in df.columns: df["Order Grup AdÄ±"] = df["Order Grup AdÄ±"].fillna("DiÄŸer")
        else: df["Order Grup AdÄ±"] = "DiÄŸer"
        df_reklamasyon_global = df
        return True, f"Reklamasyon verisi yÃ¼klendi: {len(df)} satÄ±r."
    except Exception as e:
        df_reklamasyon_global = create_reklamasyon_dummy_data()
        return False, str(e)

# Reklamasyon YÃ¶netici Ã–zeti (Dashboard)
def draw_rek_dashboard(parent):
    """Reklamasyon YÃ¶netici Dashboard'Ä±nÄ± Ã§izer"""
    for widget in parent.winfo_children(): widget.destroy()
    top_bar = tk.Frame(parent, bg="white", padx=20, pady=15, bd=1, relief="raised"); top_bar.pack(fill="x")
    tk.Label(top_bar, text="ğŸ“Š REK LAMASYON YÃ–NETÄ°CÄ° Ã–ZETÄ°", font=("Segoe UI", 16, "bold"), fg="#2c3e50", bg="white").pack(side="left")
    
    # Butonlar
    btn_frame = tk.Frame(top_bar, bg="white"); btn_frame.pack(side="right", padx=10)
    tk.Button(btn_frame, text="ğŸ“§ Raporu Mail At", bg="#8e44ad", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: show_page("Rek Mail Merkezi")).pack(side="left", padx=5)
    
    tk.Label(top_bar, text="TedarikÃ§i:", font=("Segoe UI", 10), bg="white", fg="gray").pack(side="right", padx=5)
    all_suppliers = sorted(df_reklamasyon_global["Cari AdÄ±"].unique().astype(str)) if df_reklamasyon_global is not None else []
    cari_var = tk.StringVar(value="TÃ¼mÃ¼"); cari_combo = ttk.Combobox(top_bar, values=["TÃ¼mÃ¼"] + list(all_suppliers), textvariable=cari_var, state="readonly", width=25)
    cari_combo.pack(side="right", padx=5)
    
    canvas = tk.Canvas(parent, bg="#ecf0f1"); scrollbar = ttk.Scrollbar(parent, orient="vertical", command=canvas.yview)
    scrollable_frame = tk.Frame(canvas, bg="#ecf0f1")
    scrollable_frame.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
    canvas.create_window((0, 0), window=scrollable_frame, anchor="nw"); canvas.configure(yscrollcommand=scrollbar.set)
    canvas.pack(side="left", fill="both", expand=True); scrollbar.pack(side="right", fill="y")

    current_dash_data = None
    def refresh_content(event=None):
        nonlocal current_dash_data
        for w in scrollable_frame.winfo_children(): w.destroy()
        sel_cari = cari_combo.get()
        df_d = df_reklamasyon_global.copy() if sel_cari == "TÃ¼mÃ¼" else df_reklamasyon_global[df_reklamasyon_global["Cari AdÄ±"] == sel_cari]
        current_dash_data = df_d

        kpi_frame = tk.Frame(scrollable_frame, bg="#ecf0f1"); kpi_frame.pack(fill="x", pady=10, padx=10)
        t_alim_tut = df_d["Alim_Tutari"].sum(); t_iade_tut = df_d["Iade_Tutari"].sum(); t_rek_tut = df_d["Reklamasyon_Tutari"].sum()
        t_risk = t_iade_tut + t_rek_tut
        
        def draw_kpi(col, title, val1, val2, color):
            card = tk.Frame(kpi_frame, bg="white", bd=0, relief="flat", padx=15, pady=15)
            card.grid(row=0, column=col, sticky="ew", padx=10); kpi_frame.grid_columnconfigure(col, weight=1)
            tk.Frame(card, bg=color, width=5).pack(side="left", fill="y", padx=(0,10))
            tk.Label(card, text=title, font=("Segoe UI", 10, "bold"), fg="#95a5a6", bg="white").pack(anchor="w")
            tk.Label(card, text=val1, font=("Segoe UI", 18, "bold"), fg="#2c3e50", bg="white").pack(anchor="w")
            if val2: tk.Label(card, text=val2, font=("Segoe UI", 9), fg=color, bg="white").pack(anchor="w")

        draw_kpi(0, "TOPLAM ALIM HACMÄ°", f"{t_alim_tut:,.0f} â‚º", f"{df_d['Alim_Miktar'].sum():,.0f} Birim", "#27ae60")
        draw_kpi(1, "TOPLAM RÄ°SK (Ä°ade+Rek.)", f"{t_risk:,.0f} â‚º", f"Ä°ade: {t_iade_tut:,.0f} | Rek: {t_rek_tut:,.0f}", "#c0392b")
        draw_kpi(2, "Ä°ADE TUTARI (Fatura)", f"{t_iade_tut:,.0f} â‚º", f"{df_d['Iade_Edilen_Miktar'].sum():,.0f} Birim", "#f39c12")
        draw_kpi(3, "KESÄ°LEN REKLAMASYON", f"{t_rek_tut:,.0f} â‚º", f"{df_d['Reklamasyon_Miktar'].sum():,.0f} Birim", "#8e44ad")

        chart_frame = tk.Frame(scrollable_frame, bg="#ecf0f1"); chart_frame.pack(fill="x", pady=10, padx=20)
        fig = plt.figure(figsize=(10, 4), dpi=100)
        ax1 = fig.add_subplot(121)
        if not df_d.empty:
            df_d.groupby("Cari AdÄ±")[["Iade_Tutari", "Reklamasyon_Tutari"]].sum().sum(axis=1).sort_values(ascending=False).head(5).plot(kind="bar", ax=ax1, color="#e74c3c", alpha=0.8)
        ax1.set_title("En YÃ¼ksek Riskli 5 TedarikÃ§i"); ax1.set_xlabel(""); plt.setp(ax1.xaxis.get_majorticklabels(), rotation=45, ha="right", fontsize=8)
        ax2 = fig.add_subplot(122); sizes = [t_iade_tut, t_rek_tut]
        if sum(sizes) > 0: ax2.pie(sizes, labels=['Ä°ade', 'Reklamasyon'], autopct='%1.1f%%', colors=['#f39c12', '#8e44ad'], startangle=90)
        else: ax2.text(0.5, 0.5, "Veri Yok", ha='center')
        ax2.set_title("Risk DaÄŸÄ±lÄ±mÄ±")
        plt.tight_layout(); canvas_fig = FigureCanvasTkAgg(fig, master=chart_frame); canvas_fig.draw(); canvas_fig.get_tk_widget().pack(fill="both", expand=True)

    btn_ex = tk.Button(btn_frame, text="Excel Ä°ndir", bg="#27ae60", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: export_rek_df_to_excel(current_dash_data, "Rek_Dashboard"))
    btn_ex.pack(side="left", padx=5)
    btn_pdf = tk.Button(btn_frame, text="PDF Ä°ndir", bg="#c0392b", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: export_rek_df_to_pdf(current_dash_data.head(50) if current_dash_data is not None else pd.DataFrame(), "Reklamasyon YÃ¶netici Ã–zeti", "Rek_Dashboard"))
    btn_pdf.pack(side="left", padx=5)

    cari_combo.bind("<<ComboboxSelected>>", refresh_content); refresh_content()

# DetaylÄ± Reklamasyon Raporu
def init_rek_detailed_report_tab():
    """DetaylÄ± reklamasyon raporu sekmesi"""
    for widget in frame_rek_detayli.winfo_children(): widget.destroy()
    notebook = ttk.Notebook(frame_rek_detayli); notebook.pack(fill="both", expand=True, padx=10, pady=5)
    tab_detay = tk.Frame(notebook, bg="white"); notebook.add(tab_detay, text=" ğŸ“‹ DetaylÄ± Operasyonel Liste ")
    tab_ozet = tk.Frame(notebook, bg="white"); notebook.add(tab_ozet, text=" ğŸ“Š YÃ¶netici Ã–zeti (TakÄ±m BazlÄ±) ")

    def setup_detail_tab():
        filter_frame = tk.Frame(tab_detay, bg="#f8f9fa", padx=10, pady=15, bd=1, relief="solid")
        filter_frame.pack(fill="x", padx=10, pady=5)
        
        tk.Label(filter_frame, text="HÄ±zlÄ± Filtre:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=(0,5))
        status_var = tk.StringVar(value="TÃ¼mÃ¼")
        cb_status = ttk.Combobox(filter_frame, textvariable=status_var, state="readonly", values=["TÃ¼mÃ¼", "Geciken SipariÅŸler", "ZamanÄ±nda Teslim", "Ä°ade Olanlar", "Reklamasyon Olanlar"])
        cb_status.pack(side="left", padx=5)

        tk.Label(filter_frame, text="|  DetaylÄ± Arama:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=15)
        search_col_var = tk.StringVar(value="TÃ¼mÃ¼")
        cols_map = {"TedarikÃ§i": "Cari AdÄ±", "Order No": "Order No", "TakÄ±m": "Order Grup AdÄ±", "Stok AdÄ±": "Stok AdÄ±", "Parti No": "Parti/Lab No"}
        cb_col = ttk.Combobox(filter_frame, textvariable=search_col_var, state="readonly", values=["TÃ¼mÃ¼"] + list(cols_map.keys()), width=15)
        cb_col.pack(side="left", padx=5)
        entry_search = ttk.Entry(filter_frame, width=30); entry_search.pack(side="left", padx=5)
        
        # Sorumlu Ata Butonu
        btn_assign = tk.Button(filter_frame, text="ğŸ‘¤ Sorumlu Ata", bg="#9b59b6", fg="white", font=("Segoe UI", 9, "bold"), command=lambda: assign_responsible())
        btn_assign.pack(side="right", padx=5)
        
        # Export Buttons
        btn_xls = tk.Button(filter_frame, text="Excel", bg="#27ae60", fg="white", font=("Segoe UI", 8), command=lambda: export_rek_df_to_excel(current_data_detail, "Rek_Detayli"))
        btn_xls.pack(side="right", padx=5)
        btn_pdf = tk.Button(filter_frame, text="PDF", bg="#c0392b", fg="white", font=("Segoe UI", 8), command=lambda: export_rek_df_to_pdf(current_data_detail, "DetaylÄ± Reklamasyon Raporu", "Rek_Detayli"))
        btn_pdf.pack(side="right", padx=5)

        tree_frame = tk.Frame(tab_detay); tree_frame.pack(fill="both", expand=True, padx=10, pady=5)
        cols = ["â˜‘", "TedarikÃ§i", "Order No", "TakÄ±m", "Parti No", "Stok AdÄ±", "FiÅŸ No", "FiÅŸ Tarihi", "MÃ¼ÅŸ. Gecikme", "Sip. Gecikme", "Kesilmesi Gereken Ceza", "Reklamasyon Edilmesi Tutar", "On Time Mik.", "Geciken Mik.", "Ä°ade Mik.", "Ä°ade Tutar", "Rek. Mik.", "Rek. Tutar", "Net Mik.", "Rek. OranÄ±"]
        tree = ttk.Treeview(tree_frame, columns=cols, show="headings", height=15)
        vsb = ttk.Scrollbar(tree_frame, orient="vertical", command=tree.yview); hsb = ttk.Scrollbar(tree_frame, orient="horizontal", command=tree.xview)
        tree.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)
        tree.grid(column=0, row=0, sticky='nsew'); vsb.grid(column=1, row=0, sticky='ns'); hsb.grid(column=0, row=1, sticky='ew')
        tree_frame.grid_columnconfigure(0, weight=1); tree_frame.grid_rowconfigure(0, weight=1)

        for c in cols:
            tree.heading(c, text=c)
            if c == "â˜‘": tree.column(c, anchor="center", width=40)
            elif "Mik" in c or "Oran" in c or "Tutar" in c or "Gecikme" in c or "Ceza" in c or "Edilmesi" in c: tree.column(c, anchor="e", width=100)
            else: tree.column(c, anchor="w", width=120)
        
        # Checkbox durumlarÄ±nÄ± saklayacak dictionary
        checkbox_states = {}
        
        def toggle_checkbox(event):
            """Checkbox toggle iÅŸlemi"""
            item = tree.identify_row(event.y)
            column = tree.identify_column(event.x)
            if item and column == '#1':  # Ä°lk kolon (checkbox)
                current_val = tree.item(item, 'values')[0]
                new_val = 'â˜' if current_val == 'â˜‘' else 'â˜‘'
                values = list(tree.item(item, 'values'))
                values[0] = new_val
                tree.item(item, values=values)
                checkbox_states[item] = (new_val == 'â˜‘')
        
        tree.bind('<Button-1>', toggle_checkbox)
        
        current_data_detail = pd.DataFrame()
        current_row_data = {}  # Her satÄ±rÄ±n tam verisini saklamak iÃ§in

        def apply_filters(event=None):
            nonlocal current_data_detail, current_row_data
            for i in tree.get_children(): tree.delete(i)
            checkbox_states.clear()
            current_row_data.clear()
            if df_reklamasyon_global is None: return

            df_proc = df_reklamasyon_global.copy()
            num_cols = ["Alim_Miktar", "Alim_Tutari", "Iade_Edilen_Miktar", "Iade_Tutari", "Reklamasyon_Miktar", "Reklamasyon_Tutari", "Siparis_Gecikme", "Musteri_Gecikme", "On_Time_Miktar", "Geciken_Miktar"]
            for col in num_cols:
                if col in df_proc.columns: df_proc[col] = pd.to_numeric(df_proc[col], errors='coerce').fillna(0)

            if "FiÅŸ Tarihi" in df_proc.columns:
                df_proc["FiÅŸ_Tarihi_Str"] = df_proc["FiÅŸ Tarihi"].apply(lambda x: x.strftime('%d.%m.%Y') if pd.notna(x) else "")
            else: df_proc["FiÅŸ_Tarihi_Str"] = ""
            if "SipariÅŸ FiÅŸi FiÅŸ No" not in df_proc.columns: df_proc["SipariÅŸ FiÅŸi FiÅŸ No"] = ""

            obj_cols = df_proc.select_dtypes(include=['object']).columns
            df_proc[obj_cols] = df_proc[obj_cols].fillna("Bilinmiyor")
            
            grp = df_proc.groupby(["Cari AdÄ±", "Order No", "Order Grup AdÄ±", "Parti/Lab No", "Stok AdÄ±", "SipariÅŸ FiÅŸi FiÅŸ No", "FiÅŸ_Tarihi_Str"]).agg({
                "Musteri_Gecikme": "max", "Siparis_Gecikme": "max", "On_Time_Miktar": "sum", "Geciken_Miktar": "sum", "Iade_Edilen_Miktar": "sum", 
                "Alim_Miktar": "sum", "Reklamasyon_Miktar": "sum", "Alim_Tutari": "sum", "Iade_Tutari": "sum", "Reklamasyon_Tutari": "sum"
            }).reset_index()

            status = status_var.get()
            if status == "Geciken SipariÅŸler": grp = grp[grp["Siparis_Gecikme"] > 0]
            elif status == "ZamanÄ±nda Teslim": grp = grp[grp["Siparis_Gecikme"] <= 0]
            elif status == "Ä°ade Olanlar": grp = grp[(grp["Iade_Tutari"] > 0) | (grp["Iade_Edilen_Miktar"] > 0)]
            elif status == "Reklamasyon Olanlar": grp = grp[(grp["Reklamasyon_Tutari"] > 0) | (grp["Reklamasyon_Miktar"] > 0)]

            txt = entry_search.get().lower()
            if txt:
                s_col = search_col_var.get()
                if s_col == "TÃ¼mÃ¼":
                    mask = grp.apply(lambda x: txt in str(x["Cari AdÄ±"]).lower() or txt in str(x["Order No"]).lower() or txt in str(x["Order Grup AdÄ±"]).lower() or txt in str(x["Parti/Lab No"]).lower() or txt in str(x["Stok AdÄ±"]).lower(), axis=1)
                    grp = grp[mask]
                else:
                    target = cols_map.get(s_col, s_col)
                    if target in grp.columns: grp = grp[grp[target].astype(str).str.lower().str.contains(txt, na=False)]
            
            current_data_detail = grp 

            for idx, row in grp.iterrows():
                net_mik = row["Alim_Miktar"] - row["Iade_Edilen_Miktar"]
                total_risk = row["Iade_Tutari"] + row["Reklamasyon_Tutari"]
                oran = (total_risk / row["Alim_Tutari"] * 100) if row["Alim_Tutari"] > 0 else 0
                s_gec = int(row["Siparis_Gecikme"]); m_gec = int(row["Musteri_Gecikme"])
                
                # Ceza hesaplama
                ceza_orani = 0.0
                if s_gec > 0:
                    if s_gec < 7: ceza_orani = 0.05
                    elif 7 <= s_gec <= 15: ceza_orani = 0.10
                    else: ceza_orani = 0.25
                ceza_tutari = (row["Alim_Tutari"] - row["Iade_Tutari"]) * ceza_orani
                
                # Reklamasyon edilmesi tutar (Ä°ade + Reklamasyon + Ceza)
                reklamasyon_edilmesi_tutar = row["Iade_Tutari"] + row["Reklamasyon_Tutari"] + ceza_tutari

                vals = ('â˜', row["Cari AdÄ±"], row["Order No"], row["Order Grup AdÄ±"], row["Parti/Lab No"], row["Stok AdÄ±"], row["SipariÅŸ FiÅŸi FiÅŸ No"], row["FiÅŸ_Tarihi_Str"], m_gec, s_gec,
                        f"â‚º{ceza_tutari:,.0f}",
                        f"â‚º{reklamasyon_edilmesi_tutar:,.0f}",
                        f"{row['On_Time_Miktar']:,.0f}", f"{row['Geciken_Miktar']:,.0f}", f"{row['Iade_Edilen_Miktar']:,.0f}", f"{row['Iade_Tutari']:,.0f}",
                        f"{row['Reklamasyon_Miktar']:,.0f}", f"{row['Reklamasyon_Tutari']:,.0f}", f"{net_mik:,.0f}", f"%{oran:.2f}")
                tags = []
                if s_gec > 0: tags.append('late')
                if row['Iade_Tutari'] > 0: tags.append('return')
                if row['Reklamasyon_Tutari'] > 0: tags.append('reclaim')
                item_id = tree.insert("", "end", values=vals, tags=tuple(tags))
                
                # SatÄ±r verisini sakla
                current_row_data[item_id] = {
                    'TedarikÃ§i': row["Cari AdÄ±"],
                    'Order No': row["Order No"],
                    'TakÄ±m': row["Order Grup AdÄ±"],
                    'Parti No': row["Parti/Lab No"],
                    'Stok AdÄ±': row["Stok AdÄ±"],
                    'Siparis_Gecikme': s_gec,
                    'Musteri_Gecikme': m_gec,
                    'Iade_Tutari': row['Iade_Tutari'],
                    'Reklamasyon_Tutari': row['Reklamasyon_Tutari'],
                    'Alim_Tutari': row['Alim_Tutari'],
                    'Ceza_Tutari': ceza_tutari,
                    'Reklamasyon_Edilmesi_Tutar': reklamasyon_edilmesi_tutar
                }
            
            tree.tag_configure('late', foreground='#c0392b') 
            tree.tag_configure('return', background='#fff3e0') 
            tree.tag_configure('reclaim', background='#ffebee')

        def assign_responsible():
            """SeÃ§ili satÄ±rlar iÃ§in sorumlu atama ve AI mail taslaÄŸÄ± oluÅŸturma"""
            selected_items = [item for item, checked in checkbox_states.items() if checked]
            
            if not selected_items:
                messagebox.showwarning("UyarÄ±", "LÃ¼tfen en az bir satÄ±r seÃ§in!")
                return
            
            # SeÃ§ili satÄ±rlarÄ±n bilgilerini topla
            selected_data = []
            for item in selected_items:
                if item in current_row_data:
                    selected_data.append(current_row_data[item])
            
            if not selected_data:
                messagebox.showerror("Hata", "SeÃ§ili satÄ±r verileri bulunamadÄ±!")
                return
            
            # AI mail taslaÄŸÄ± oluÅŸturma penceresi
            draft_window = tk.Toplevel(root)
            draft_window.title("Sorumlu Atama - AI Mail TaslaÄŸÄ±")
            draft_window.geometry("800x700")
            draft_window.configure(bg="#ecf0f1")
            
            # BaÅŸlÄ±k
            header = tk.Frame(draft_window, bg="#34495e", padx=20, pady=15)
            header.pack(fill="x")
            tk.Label(header, text="ğŸ¤– Yapay Zeka Destekli Mail TaslaÄŸÄ±", font=("Segoe UI", 14, "bold"), fg="white", bg="#34495e").pack()
            
            # Ä°Ã§erik
            content = tk.Frame(draft_window, bg="#ecf0f1", padx=20, pady=20)
            content.pack(fill="both", expand=True)
            
            # SeÃ§ili kayÄ±t sayÄ±sÄ±
            tk.Label(content, text=f"âœ“ SeÃ§ili KayÄ±t: {len(selected_data)}", font=("Segoe UI", 10, "bold"), bg="#ecf0f1", fg="#27ae60").pack(anchor="w", pady=(0,10))
            
            # Mail adresi giriÅŸi
            mail_frame = tk.Frame(content, bg="#ecf0f1")
            mail_frame.pack(fill="x", pady=(0,10))
            tk.Label(mail_frame, text="ğŸ“§ AlÄ±cÄ± Email:", font=("Segoe UI", 10, "bold"), bg="#ecf0f1").pack(side="left", padx=(0,10))
            email_entry = ttk.Entry(mail_frame, width=40, font=("Segoe UI", 10))
            email_entry.pack(side="left", padx=5)
            email_entry.insert(0, GMAIL_RECEIVER_LOGS if GMAIL_RECEIVER_LOGS else "")
            
            # Mail taslaÄŸÄ± text alanÄ±
            tk.Label(content, text="Mail TaslaÄŸÄ±:", font=("Segoe UI", 10, "bold"), bg="#ecf0f1").pack(anchor="w", pady=(10,5))
            text_frame = tk.Frame(content)
            text_frame.pack(fill="both", expand=True, pady=5)
            
            text_scroll = ttk.Scrollbar(text_frame)
            text_scroll.pack(side="right", fill="y")
            
            draft_text = tk.Text(text_frame, wrap="word", font=("Segoe UI", 10), yscrollcommand=text_scroll.set, height=15)
            draft_text.pack(side="left", fill="both", expand=True)
            text_scroll.configure(command=draft_text.yview)
            
            draft_text.insert("1.0", "AI taslak oluÅŸturuluyor, lÃ¼tfen bekleyin...")
            draft_text.configure(state="disabled")
            
            # Butonlar
            btn_frame = tk.Frame(content, bg="#ecf0f1")
            btn_frame.pack(fill="x", pady=10)
            
            def copy_to_clipboard():
                root.clipboard_clear()
                root.clipboard_append(draft_text.get("1.0", "end-1c"))
                messagebox.showinfo("BaÅŸarÄ±lÄ±", "Mail taslaÄŸÄ± panoya kopyalandÄ±!")
            
            def send_email_now():
                """Mail'i hemen gÃ¶nder"""
                recipient = email_entry.get().strip()
                if not recipient:
                    messagebox.showwarning("UyarÄ±", "LÃ¼tfen alÄ±cÄ± email adresi girin!")
                    return
                
                if not GMAIL_USER or not GMAIL_APP_PASSWORD:
                    messagebox.showerror("Hata", "Email ayarlarÄ± yapÄ±landÄ±rÄ±lmamÄ±ÅŸ!")
                    return
                
                try:
                    # Mail iÃ§eriÄŸini al
                    mail_body = draft_text.get("1.0", "end-1c")
                    
                    # Konu satÄ±rÄ±nÄ± belirle
                    lines = mail_body.split('\n')
                    subject = "Reklamasyon Sorumlu AtamasÄ±"
                    for line in lines:
                        if line.startswith("Konu:"):
                            subject = line.replace("Konu:", "").strip()
                            break
                    
                    # Email gÃ¶nder
                    msg = MIMEMultipart()
                    msg['From'] = GMAIL_USER
                    msg['To'] = recipient
                    msg['Subject'] = subject
                    msg.attach(MIMEText(mail_body, 'plain', 'utf-8'))
                    
                    server = smtplib.SMTP('smtp.gmail.com', 587)
                    server.starttls()
                    server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
                    server.send_message(msg)
                    server.quit()
                    
                    # LOG
                    if activity_logger:
                        activity_logger.log_email_sent(recipient, subject, "Rek DetaylÄ± Rapor")
                    
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Mail baÅŸarÄ±yla gÃ¶nderildi!\nAlÄ±cÄ±: {recipient}")
                    draft_window.destroy()
                    
                except Exception as e:
                    messagebox.showerror("Hata", f"Mail gÃ¶nderilemedi:\n{str(e)}")
                    if activity_logger:
                        activity_logger.log_error(f"Mail gÃ¶nderim hatasÄ±: {str(e)}", "Rek DetaylÄ± Rapor")
            
            tk.Button(btn_frame, text="ğŸ“§ Mail GÃ¶nder", bg="#e74c3c", fg="white", font=("Segoe UI", 10, "bold"), padx=20, pady=8, command=send_email_now).pack(side="left", padx=5)
            tk.Button(btn_frame, text="ğŸ“‹ Panoya Kopyala", bg="#3498db", fg="white", font=("Segoe UI", 10), padx=20, pady=8, command=copy_to_clipboard).pack(side="left", padx=5)
            tk.Button(btn_frame, text="âœ– Kapat", bg="#95a5a6", fg="white", font=("Segoe UI", 10), padx=20, pady=8, command=draft_window.destroy).pack(side="right", padx=5)
            
            # AI taslak oluÅŸturma (thread'de)
            def generate_draft():
                try:
                    # Sorun analizi
                    problems = []
                    total_reclamation_amount = 0
                    for data in selected_data:
                        if data['Siparis_Gecikme'] > 0:
                            problems.append(f"Termin Gecikmesi ({data['Siparis_Gecikme']} gÃ¼n, Ceza: â‚º{data.get('Ceza_Tutari', 0):,.0f})")
                        if data['Iade_Tutari'] > 0:
                            problems.append(f"Ä°ade Durumu (â‚º{data['Iade_Tutari']:,.0f})")
                        if data['Reklamasyon_Tutari'] > 0:
                            problems.append(f"Reklamasyon (â‚º{data['Reklamasyon_Tutari']:,.0f})")
                        total_reclamation_amount += data.get('Reklamasyon_Edilmesi_Tutar', 0)
                    
                    problem_summary = ", ".join(set(problems))
                    
                    # Sorumlu alanÄ± belirleme
                    responsible_area = "Termin YÃ¶netimi ve Planlama"
                    if any(d['Iade_Tutari'] > 0 or d['Reklamasyon_Tutari'] > 0 for d in selected_data):
                        responsible_area = "Kalite Kontrol ve Reklamasyon YÃ¶netimi"
                    elif any(d['Siparis_Gecikme'] > 0 for d in selected_data):
                        responsible_area = "Termin YÃ¶netimi ve Planlama"
                    
                    # AI prompt hazÄ±rlama
                    if GEMINI_API_KEY:
                        prompt = f"""Bir tedarik zinciri yÃ¶neticisi olarak, aÅŸaÄŸÄ±daki reklamasyon kayÄ±tlarÄ± iÃ§in sorumlu ekibe gÃ¶nderilecek profesyonel bir mail taslaÄŸÄ± hazÄ±rla.

SeÃ§ili KayÄ±t SayÄ±sÄ±: {len(selected_data)}
Tespit Edilen Sorunlar: {problem_summary}
Toplam Reklamasyon Edilmesi Gereken Tutar: â‚º{total_reclamation_amount:,.0f}
Sorumlu Alan: {responsible_area}

Detaylar:
"""
                        for i, data in enumerate(selected_data, 1):
                            prompt += f"\n{i}. TedarikÃ§i: {data['TedarikÃ§i']}, Order: {data['Order No']}, TakÄ±m: {data['TakÄ±m']}"
                            if data['Siparis_Gecikme'] > 0:
                                prompt += f", Gecikme: {data['Siparis_Gecikme']} gÃ¼n (Ceza: â‚º{data.get('Ceza_Tutari', 0):,.0f})"
                            if data['Reklamasyon_Tutari'] > 0:
                                prompt += f", Reklamasyon: â‚º{data['Reklamasyon_Tutari']:,.0f}"
                            if data.get('Reklamasyon_Edilmesi_Tutar', 0) > 0:
                                prompt += f", Toplam Edilmesi Gereken: â‚º{data.get('Reklamasyon_Edilmesi_Tutar', 0):,.0f}"
                        
                        prompt += """\n\nMail taslaÄŸÄ±nda:
1. Konu satÄ±rÄ±nÄ± belirt
2. Profesyonel ve nazik bir ton kullan
3. Sorunu net bir ÅŸekilde aÃ§Ä±kla
4. Sorumlu alanÄ± belirt
5. Beklenen aksiyonlarÄ± listele
6. Termin belirt
7. Ä°mza iÃ§in yer bÄ±rak

Mail dilini TÃ¼rkÃ§e kullan ve profesyonel iÅŸ ortamÄ±na uygun yaz."""
                        
                        # Gemini API Ã§aÄŸrÄ±sÄ±
                        url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={GEMINI_API_KEY}"
                        headers = {'Content-Type': 'application/json'}
                        payload = {
                            "contents": [{
                                "parts": [{"text": prompt}]
                            }]
                        }
                        
                        response = requests.post(url, headers=headers, json=payload, timeout=30)
                        
                        if response.status_code == 200:
                            result = response.json()
                            ai_draft = result['candidates'][0]['content']['parts'][0]['text']
                        else:
                            ai_draft = f"AI yanÄ±t alÄ±namadÄ±. Hata: {response.status_code}"
                    else:
                        # Fallback: API key yoksa manuel taslak
                        ai_draft = f"""Konu: Acil - {responsible_area} Gereksinimi

SayÄ±n Yetkili,

{len(selected_data)} adet sipariÅŸ kaydÄ±nda tespit edilen sorunlar hakkÄ±nda bilgilendirme yapmak isteriz.

Tespit Edilen Sorunlar:
{problem_summary}

Detaylar:
"""
                        for i, data in enumerate(selected_data, 1):
                            ai_draft += f"\n{i}. TedarikÃ§i: {data['TedarikÃ§i']}"
                            ai_draft += f"\n   Order No: {data['Order No']}"
                            ai_draft += f"\n   TakÄ±m: {data['TakÄ±m']}"
                            if data['Siparis_Gecikme'] > 0:
                                ai_draft += f"\n   âš ï¸ Termin Gecikmesi: {data['Siparis_Gecikme']} gÃ¼n"
                            if data['Reklamasyon_Tutari'] > 0:
                                ai_draft += f"\n   âš ï¸ Reklamasyon TutarÄ±: â‚º{data['Reklamasyon_Tutari']:,.0f}"
                            if data['Iade_Tutari'] > 0:
                                ai_draft += f"\n   âš ï¸ Ä°ade TutarÄ±: â‚º{data['Iade_Tutari']:,.0f}"
                            ai_draft += "\n"
                        
                        ai_draft += f"""\nSorumlu Alan: {responsible_area}

Beklenen Aksiyonlar:
1. Durumun acil olarak deÄŸerlendirilmesi
2. TedarikÃ§i ile iletiÅŸime geÃ§ilmesi
3. DÃ¼zeltici Ã¶nlemlerin alÄ±nmasÄ±
4. 3 iÅŸ gÃ¼nÃ¼ iÃ§inde geri bildirim verilmesi

Konuyla ilgili destek iÃ§in iletiÅŸime geÃ§ebilirsiniz.

SaygÄ±larÄ±mÄ±zla,
[Ä°mza]"""
                    
                    # Text alanÄ±nÄ± gÃ¼ncelle
                    draft_text.configure(state="normal")
                    draft_text.delete("1.0", "end")
                    draft_text.insert("1.0", ai_draft)
                    draft_text.configure(state="normal")  # DÃ¼zenlenebilir bÄ±rak
                    
                    # LOG
                    if activity_logger:
                        activity_logger.log_event("AI_DRAFT_GENERATED", f"{len(selected_data)} kayÄ±t iÃ§in mail taslaÄŸÄ± oluÅŸturuldu", "Rek DetaylÄ± Rapor")
                    
                except Exception as e:
                    draft_text.configure(state="normal")
                    draft_text.delete("1.0", "end")
                    draft_text.insert("1.0", f"Hata oluÅŸtu: {str(e)}\n\nLÃ¼tfen tekrar deneyin veya manuel olarak mail oluÅŸturun.")
                    if activity_logger:
                        activity_logger.log_error(f"AI draft hatasÄ±: {str(e)}", "Rek DetaylÄ± Rapor")
            
            # Thread'de Ã§alÄ±ÅŸtÄ±r
            threading.Thread(target=generate_draft, daemon=True).start()

        cb_status.bind("<<ComboboxSelected>>", apply_filters)
        entry_search.bind("<KeyRelease>", apply_filters)
        apply_filters()

    def setup_summary_tab():
        exp_frame = tk.Frame(tab_ozet, bg="white", pady=5); exp_frame.pack(fill="x", padx=10)
        current_summary1 = pd.DataFrame(); current_summary2 = pd.DataFrame()
        btn_xls = tk.Button(exp_frame, text="TÃ¼m Ã–zeti Excel'e Aktar", bg="#27ae60", fg="white", font=("Segoe UI", 9), command=lambda: export_rek_df_to_excel(current_summary1 if not current_summary1.empty else current_summary2, "Rek_Yonetici_Ozeti")); btn_xls.pack(side="right", padx=5)
        btn_pdf = tk.Button(exp_frame, text="PDF Yap", bg="#c0392b", fg="white", font=("Segoe UI", 9), command=lambda: export_rek_df_to_pdf(current_summary1 if not current_summary1.empty else current_summary2, "Reklamasyon YÃ¶netici Ã–zeti", "Rek_Yonetici_Raporu")); btn_pdf.pack(side="right", padx=5)

        df_rek = df_reklamasyon_global[df_reklamasyon_global["Islem_Tipi"].isin(["Ä°ade", "Reklamasyon"])].copy() if df_reklamasyon_global is not None else pd.DataFrame()
        df_proc = df_reklamasyon_global.copy() if df_reklamasyon_global is not None else pd.DataFrame()
        
        # --- TÃœM VERÄ°YÄ° KAPSAYAN MERGE HAZIRLIÄI ---
        # 1. Ceza Verisi (Gecikme olan tÃ¼m satÄ±rlardan)
        ceza_summary = pd.DataFrame(columns=["Order Grup AdÄ±", "Cari AdÄ±", "Row_Ceza"])
        if not df_proc.empty:
             for col in ["Alim_Tutari", "Iade_Tutari", "Siparis_Gecikme"]:
                 if col in df_proc.columns: df_proc[col] = df_proc[col].fillna(0)
             # Order bazÄ±nda gecikme ve cezayÄ± hesapla
             grp_det = df_proc.groupby(["Cari AdÄ±", "Order No", "Order Grup AdÄ±"]).agg({"Siparis_Gecikme": "max", "Alim_Tutari": "sum", "Iade_Tutari": "sum"}).reset_index()
             def calc_penalty(r):
                 s_gec = r["Siparis_Gecikme"]; ceza_orani = 0.0
                 if s_gec > 0:
                     if s_gec < 7: ceza_orani = 0.05
                     elif 7 <= s_gec <= 15: ceza_orani = 0.10
                     else: ceza_orani = 0.25
                 return (r["Alim_Tutari"] - r["Iade_Tutari"]) * ceza_orani
             grp_det["Row_Ceza"] = grp_det.apply(calc_penalty, axis=1)
             ceza_summary = grp_det.groupby(["Order Grup AdÄ±", "Cari AdÄ±"])["Row_Ceza"].sum().reset_index()

        # 2. Ä°ade/Reklamasyon Verisi
        rek_summary = pd.DataFrame(columns=["Order Grup AdÄ±", "Cari AdÄ±", "Reklamasyon_Tutari", "Iade_Tutari", "Kesinti_Gecikme", "Kesinti_Kalite"])
        if not df_rek.empty:
            rek_summary = df_rek.groupby(["Order Grup AdÄ±", "Cari AdÄ±"]).agg({"Reklamasyon_Tutari": "sum", "Iade_Tutari": "sum", "Kesinti_Gecikme": "sum", "Kesinti_Kalite": "sum"}).reset_index()

        # 3. OUTER MERGE (KapsayÄ±cÄ± BirleÅŸtirme)
        # Hem ceza verisini hem de iade/reklamasyon verisini kaybetmemek iÃ§in outer join yapÄ±yoruz.
        if ceza_summary.empty and rek_summary.empty:
             merged_data = pd.DataFrame(columns=["Order Grup AdÄ±", "Cari AdÄ±", "Row_Ceza", "Reklamasyon_Tutari", "Iade_Tutari", "Kesinti_Gecikme", "Kesinti_Kalite"])
        else:
             merged_data = pd.merge(rek_summary, ceza_summary, on=["Order Grup AdÄ±", "Cari AdÄ±"], how="outer").fillna(0)
        
        current_summary1 = merged_data # Export iÃ§in

        f1 = tk.LabelFrame(tab_ozet, text="1. TakÄ±m ve TedarikÃ§i DetaylÄ± Analiz", font=("Segoe UI", 10, "bold"), bg="white", padx=10, pady=5); f1.pack(fill="both", expand=True, padx=10, pady=5)
        cols1 = ["TakÄ±m", "Cari AdÄ±", "Kesilmesi Gereken (Ceza)", "Reklamasyon TutarÄ± (52)", "Ä°ade TutarÄ± (63)", "Kesilen Reklamasyon - Gecikme", "Kesilen Reklamasyon - Kalite"]
        t1 = ttk.Treeview(f1, columns=cols1, show="headings", height=6)
        sb1 = ttk.Scrollbar(f1, orient="vertical", command=t1.yview); t1.configure(yscrollcommand=sb1.set)
        t1.grid(row=0, column=0, sticky='nsew'); sb1.grid(row=0, column=1, sticky='ns')
        f1.grid_columnconfigure(0, weight=1); f1.grid_rowconfigure(0, weight=1)
        for c in cols1: t1.heading(c, text=c); t1.column(c, anchor="e" if "TutarÄ±" in c or "Kesilen" in c or "Ceza" in c else "w", width=110)

        t1_ceza=0; t1_rek=0; t1_iade=0; t1_gec=0; t1_kal=0
        for i, r in merged_data.iterrows():
            t1.insert("", "end", values=(r["Order Grup AdÄ±"], r["Cari AdÄ±"], f"â‚º{r['Row_Ceza']:,.0f}", f"â‚º{r['Reklamasyon_Tutari']:,.0f}", f"â‚º{r['Iade_Tutari']:,.0f}", f"â‚º{r['Kesinti_Gecikme']:,.0f}", f"â‚º{r['Kesinti_Kalite']:,.0f}"))
            t1_ceza+=r['Row_Ceza']; t1_rek+=r['Reklamasyon_Tutari']; t1_iade+=r['Iade_Tutari']; t1_gec+=r['Kesinti_Gecikme']; t1_kal+=r['Kesinti_Kalite']
        # Tablo 1 Alt Toplam
        t1.insert("", "end", values=("GENEL TOPLAM", "", f"â‚º{t1_ceza:,.0f}", f"â‚º{t1_rek:,.0f}", f"â‚º{t1_iade:,.0f}", f"â‚º{t1_gec:,.0f}", f"â‚º{t1_kal:,.0f}"), tags=('bold',)); t1.tag_configure('bold', font=('Segoe UI', 10, 'bold'), background='#cfd8dc')


        f2 = tk.LabelFrame(tab_ozet, text="2. TakÄ±m Genel Ã–zeti", font=("Segoe UI", 10, "bold"), bg="white", padx=10, pady=5); f2.pack(fill="both", expand=True, padx=10, pady=5)
        cols2 = ["TakÄ±m", "Gereken Ceza (Hesaplanan)", "Reklamasyon TutarÄ± (52)", "Ä°ade TutarÄ± (63)", "Kesilen Reklamasyon - Gecikme", "Kesilen Reklamasyon - Kalite"]
        t2 = ttk.Treeview(f2, columns=cols2, show="headings", height=6)
        sb2 = ttk.Scrollbar(f2, orient="vertical", command=t2.yview); t2.configure(yscrollcommand=sb2.set)
        t2.grid(row=0, column=0, sticky='nsew'); sb2.grid(row=0, column=1, sticky='ns')
        f2.grid_columnconfigure(0, weight=1); f2.grid_rowconfigure(0, weight=1)
        for c in cols2: t2.heading(c, text=c); t2.column(c, anchor="e" if "TutarÄ±" in c or "Kesilen" in c or "Ceza" in c else "w", width=120)

        if not merged_data.empty:
            grp2 = merged_data.groupby("Order Grup AdÄ±").agg({"Row_Ceza": "sum", "Reklamasyon_Tutari": "sum", "Iade_Tutari": "sum", "Kesinti_Gecikme": "sum", "Kesinti_Kalite": "sum"}).reset_index()
            current_summary2 = grp2
            t_ceza=0; t_rek=0; t_iade=0; t_gec=0; t_kal=0
            for i, r in grp2.iterrows():
                t2.insert("", "end", values=(r["Order Grup AdÄ±"], f"â‚º{r['Row_Ceza']:,.0f}", f"â‚º{r['Reklamasyon_Tutari']:,.0f}", f"â‚º{r['Iade_Tutari']:,.0f}", f"â‚º{r['Kesinti_Gecikme']:,.0f}", f"â‚º{r['Kesinti_Kalite']:,.0f}"))
                t_ceza+=r['Row_Ceza']; t_rek+=r['Reklamasyon_Tutari']; t_iade+=r['Iade_Tutari']; t_gec+=r['Kesinti_Gecikme']; t_kal+=r['Kesinti_Kalite']
            t2.insert("", "end", values=("TOPLAM", f"â‚º{t_ceza:,.0f}", f"â‚º{t_rek:,.0f}", f"â‚º{t_iade:,.0f}", f"â‚º{t_gec:,.0f}", f"â‚º{t_kal:,.0f}"), tags=('bold',)); t2.tag_configure('bold', font=('Segoe UI', 10, 'bold'), background='#cfd8dc')

    setup_detail_tab(); setup_summary_tab()

# Mail Merkezi
def init_rek_mail_tab():
    """Reklamasyon mail merkezi"""
    for widget in frame_rek_mail.winfo_children(): widget.destroy()

    # BaÅŸlÄ±k
    header = tk.Frame(frame_rek_mail, bg="#2c3e50", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="ğŸ“§ Reklamasyon Rapor PaylaÅŸÄ±m Merkezi", font=("Segoe UI", 18, "bold"), fg="white", bg="#2c3e50").pack(side="left")

    # Ä°Ã§erik
    content = tk.Frame(frame_rek_mail, bg="#ecf0f1", padx=20, pady=20)
    content.pack(fill="both", expand=True)

    # Ayarlar Frame
    settings_frame = tk.LabelFrame(content, text="GÃ¶nderim AyarlarÄ±", bg="white", font=("Segoe UI", 10, "bold"), padx=15, pady=15)
    settings_frame.pack(fill="x", pady=10)

    tk.Label(settings_frame, text="AlÄ±cÄ± Email:", bg="white").grid(row=0, column=0, sticky="w", pady=5)
    entry_to = ttk.Entry(settings_frame, width=40); entry_to.grid(row=0, column=1, pady=5, padx=10)
    if GMAIL_RECEIVER_LOGS: entry_to.insert(0, GMAIL_RECEIVER_LOGS)

    tk.Label(settings_frame, text="Konu:", bg="white").grid(row=1, column=0, sticky="w", pady=5)
    entry_subject = ttk.Entry(settings_frame, width=40); entry_subject.grid(row=1, column=1, pady=5, padx=10)
    entry_subject.insert(0, f"HaftalÄ±k Reklamasyon Raporu - {datetime.date.today()}")

    # Kimlik Bilgileri
    tk.Label(settings_frame, text="GÃ¶nderen Email:", bg="white").grid(row=0, column=2, sticky="w", pady=5, padx=(20,0))
    entry_user = ttk.Entry(settings_frame, width=30); entry_user.grid(row=0, column=3, pady=5, padx=10)
    if GMAIL_USER: entry_user.insert(0, GMAIL_USER)
    
    tk.Label(settings_frame, text="Uygulama Åifresi:", bg="white").grid(row=1, column=2, sticky="w", pady=5, padx=(20,0))
    entry_pass = ttk.Entry(settings_frame, width=30, show="*"); entry_pass.grid(row=1, column=3, pady=5, padx=10)
    if GMAIL_APP_PASSWORD: entry_pass.insert(0, GMAIL_APP_PASSWORD)

    # GÃ¶nderim Fonksiyonu
    def send_rek_email():
        to_addr = entry_to.get()
        user_email = entry_user.get()
        user_pass = entry_pass.get()
        
        if not to_addr or not user_email or not user_pass:
            messagebox.showwarning("Eksik Bilgi", "LÃ¼tfen tÃ¼m alanlarÄ± doldurun.")
            return

        try:
            status_lbl.configure(text="Reklamasyon raporlarÄ± hazÄ±rlanÄ±yor...", fg="blue")
            root.update()

            # 1. GrafiÄŸi OluÅŸtur ve Kaydet
            fig = plt.figure(figsize=(8, 4), dpi=100)
            ax = fig.add_subplot(111)
            if df_reklamasyon_global is not None:
                risk_data = df_reklamasyon_global.groupby("Order Grup AdÄ±")[["Iade_Tutari", "Reklamasyon_Tutari"]].sum().sum(axis=1).sort_values(ascending=False).head(5)
                risk_data.plot(kind="barh", ax=ax, color="#e74c3c")
                ax.set_title("En YÃ¼ksek Riskli TakÄ±mlar")
            plt.tight_layout()
            chart_path = "temp_rek_chart.png"
            fig.savefig(chart_path)
            plt.close(fig)

            # 2. Excel Raporu OluÅŸtur
            excel_path = export_rek_df_to_excel(df_reklamasyon_global, "Rek_Rapor", auto_save=True)

            # 3. HTML Ä°Ã§erik HazÄ±rla
            total_risk = df_reklamasyon_global["Iade_Tutari"].sum() + df_reklamasyon_global["Reklamasyon_Tutari"].sum()
            total_buy = df_reklamasyon_global["Alim_Tutari"].sum()
            
            html_content = f"""
            <html>
                <body style="font-family: Arial, sans-serif; color: #333;">
                    <div style="background-color: #2c3e50; padding: 20px; color: white; text-align: center; border-radius: 5px 5px 0 0;">
                        <h1>Reklamasyon Kalite Raporu</h1>
                        <p>{datetime.date.today()}</p>
                    </div>
                    <div style="padding: 20px; border: 1px solid #ddd; border-top: none;">
                        <h2 style="color: #2c3e50;">ğŸ“Š YÃ¶netici Ã–zeti</h2>
                        <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                            <div style="background-color: #27ae60; color: white; padding: 15px; border-radius: 5px; width: 45%; text-align: center;">
                                <h3>Toplam AlÄ±m</h3>
                                <p style="font-size: 24px; margin: 0;">{total_buy:,.0f} â‚º</p>
                            </div>
                            <div style="background-color: #c0392b; color: white; padding: 15px; border-radius: 5px; width: 45%; text-align: center;">
                                <h3>Toplam Risk</h3>
                                <p style="font-size: 24px; margin: 0;">{total_risk:,.0f} â‚º</p>
                            </div>
                        </div>
                        <h3>ğŸ“‰ Risk Analizi GrafiÄŸi</h3>
                        <img src="cid:dashboard_chart" alt="Grafik" style="width: 100%; max-width: 600px; border: 1px solid #eee; border-radius: 5px;">
                        <p style="margin-top: 20px;">DetaylÄ± raporlar ekte sunulmuÅŸtur.</p>
                        <hr>
                        <p style="font-size: 12px; color: gray;">Bu mail Reklamasyon YÃ¶netim Sistemi tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.</p>
                    </div>
                </body>
            </html>
            """

            # 4. Maili OluÅŸtur
            from email.mime.multipart import MIMEMultipart
            from email.mime.text import MIMEText
            from email.mime.image import MIMEImage
            from email.mime.application import MIMEApplication
            msg = MIMEMultipart('related')
            msg['Subject'] = entry_subject.get()
            msg['From'] = user_email
            msg['To'] = to_addr

            msg_alternative = MIMEMultipart('alternative')
            msg.attach(msg_alternative)
            msg_alternative.attach(MIMEText(html_content, 'html'))

            # Resmi Ekle
            with open(chart_path, 'rb') as f:
                img_data = f.read()
            image = MIMEImage(img_data)
            image.add_header('Content-ID', '<dashboard_chart>')
            msg.attach(image)

            # DosyalarÄ± Ekle
            if excel_path and os.path.exists(excel_path):
                with open(excel_path, "rb") as f:
                    part = MIMEApplication(f.read(), Name=os.path.basename(excel_path))
                part['Content-Disposition'] = f'attachment; filename="{os.path.basename(excel_path)}"'
                msg.attach(part)

            # 5. GÃ¶nder
            server = smtplib.SMTP('smtp.gmail.com', 587)
            server.starttls()
            server.login(user_email, user_pass)
            server.send_message(msg)
            server.quit()

            # Temizlik
            if os.path.exists(chart_path): os.remove(chart_path)
            if excel_path and os.path.exists(excel_path): os.remove(excel_path)

            status_lbl.configure(text="âœ… Mail baÅŸarÄ±yla gÃ¶nderildi!", fg="green")
            messagebox.showinfo("BaÅŸarÄ±lÄ±", "Reklamasyon raporu maili gÃ¶nderildi.")

        except Exception as e:
            status_lbl.configure(text="Hata oluÅŸtu.", fg="red")
            messagebox.showerror("GÃ¶nderim HatasÄ±", f"Mail gÃ¶nderilemedi:\n{str(e)}")

    btn_send = tk.Button(content, text="ğŸš€ Raporu GÃ¶nder", bg="#2980b9", fg="white", font=("Segoe UI", 12, "bold"), padx=20, pady=10, command=send_rek_email)
    btn_send.pack(pady=20)
    
    status_lbl = tk.Label(content, text="", bg="#ecf0f1", font=("Segoe UI", 10))
    status_lbl.pack()

# FotoÄŸraf Galerisi
def init_rek_gallery_tab():
    """Reklamasyon fotoÄŸraf galerisi"""
    for w in frame_rek_galeri.winfo_children(): w.destroy()
    tk.Label(frame_rek_galeri, text="ğŸ“¸ Reklamasyon FotoÄŸraf KanÄ±tlarÄ±", font=("Segoe UI", 16, "bold")).pack(pady=10)
    btn_frame = tk.Frame(frame_rek_galeri); btn_frame.pack(fill="x", padx=20)
    def foto_yukle():
        path = filedialog.askopenfilename(filetypes=[("Resimler", "*.jpg *.png *.jpeg")]); 
        if path: defect_images_rek.append(path); refresh_gallery()
    ttk.Button(btn_frame, text="FotoÄŸraf Ekle", command=foto_yukle).pack(side="left")
    scroll = tk.Frame(frame_rek_galeri); scroll.pack(fill="both", expand=True, pady=10)
    canvas = tk.Canvas(scroll); sb = ttk.Scrollbar(scroll, command=canvas.yview); cont = tk.Frame(canvas)
    cont.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
    canvas.create_window((0,0), window=cont, anchor="nw"); canvas.configure(yscrollcommand=sb.set)
    canvas.pack(side="left", fill="both", expand=True); sb.pack(side="right", fill="y")
    def refresh_gallery():
        for w in cont.winfo_children(): w.destroy()
        r, c = 0, 0
        for p in defect_images_rek:
            try:
                img = Image.open(p); img.thumbnail((150, 150)); ph = ImageTk.PhotoImage(img)
                f = tk.Frame(cont, bd=1, relief="solid", padx=5, pady=5); f.grid(row=r, column=c, padx=5, pady=5)
                tk.Label(f, image=ph).pack(); tk.Label(f, text=os.path.basename(p)[:10]).pack(); f.image = ph
                c += 1; 
                if c > 4: c=0; r+=1
            except: pass
    refresh_gallery()

# Veri YÃ¼kleme
def init_rek_data_load_tab():
    """Reklamasyon veri yÃ¼kleme"""
    for w in frame_rek_veri.winfo_children(): w.destroy()
    tk.Label(frame_rek_veri, text="ğŸ“‚ Reklamasyon Veri YÃ¼kleme", font=("Segoe UI", 16, "bold")).pack(pady=20)
    
    info_frame = tk.Frame(frame_rek_veri, bg="#e8f5e9", padx=20, pady=15, bd=1, relief="solid")
    info_frame.pack(fill="x", padx=40, pady=10)
    tk.Label(info_frame, text="â„¹ï¸ Veri FormatÄ± HakkÄ±nda", font=("Segoe UI", 11, "bold"), bg="#e8f5e9").pack(anchor="w")
    tk.Label(info_frame, text="â€¢ Excel dosyasÄ± (.xlsx) olmalÄ±dÄ±r\nâ€¢ Gerekli kolonlar: FiÅŸ Tipi, FiÅŸ Tarihi, Cari AdÄ±, Order No, vb.\nâ€¢ Ã–rnek veri otomatik yÃ¼klenmiÅŸtir", 
             font=("Segoe UI", 10), bg="#e8f5e9", justify="left").pack(anchor="w", pady=5)
    
    btn_frame = tk.Frame(frame_rek_veri); btn_frame.pack(pady=20)
    
    def load_file():
        path = filedialog.askopenfilename(filetypes=[("Excel Files", "*.xlsx")])
        if path:
            success, msg = load_reklamasyon_data(path)
            if success:
                messagebox.showinfo("BaÅŸarÄ±lÄ±", msg)
                show_page("Rek YÃ¶netici Ã–zeti")
            else:
                messagebox.showerror("Hata", msg)
    
    tk.Button(btn_frame, text="ğŸ“‚ Excel DosyasÄ± YÃ¼kle", bg="#2980b9", fg="white", font=("Segoe UI", 12, "bold"), 
              padx=30, pady=15, command=load_file).pack()
    
    tk.Label(frame_rek_veri, text=f"Mevcut Durum: {len(df_reklamasyon_global)} kayÄ±t yÃ¼klÃ¼" if df_reklamasyon_global is not None else "HenÃ¼z veri yÃ¼klenmedi",
             font=("Segoe UI", 10), fg="gray").pack(pady=10)

# Reklamasyon Ana Sayfa
def init_rek_main_tab():
    """Reklamasyon yÃ¶netimi ana sayfasÄ±"""
    for widget in frame_rek_main.winfo_children(): widget.destroy()
    
    # BaÅŸlÄ±k
    header = tk.Frame(frame_rek_main, bg="#2c3e50", padx=20, pady=30)
    header.pack(fill="x")
    tk.Label(header, text="ğŸ­ REKLAMASYON YÃ–NETÄ°M SÄ°STEMÄ°", font=("Segoe UI", 20, "bold"), fg="white", bg="#2c3e50").pack()
    tk.Label(header, text="KumaÅŸ Kalite Kontrol ve Reklamasyon Takip Platformu", font=("Segoe UI", 12), fg="#ecf0f1", bg="#2c3e50").pack(pady=5)
    
    # Ä°Ã§erik
    content = tk.Frame(frame_rek_main, bg="#ecf0f1")
    content.pack(fill="both", expand=True, padx=40, pady=20)
    
    # HÄ±zlÄ± EriÅŸim ButonlarÄ±
    tk.Label(content, text="HÄ±zlÄ± EriÅŸim", font=("Segoe UI", 14, "bold"), bg="#ecf0f1", fg="#2c3e50").pack(anchor="w", pady=(10, 15))
    
    btn_container = tk.Frame(content, bg="#ecf0f1")
    btn_container.pack(fill="x")
    
    buttons = [
        ("ğŸ“Š YÃ¶netici Ã–zeti", "Rek YÃ¶netici Ã–zeti", "#3498db"),
        ("ğŸ“‘ DetaylÄ± Raporlar", "Rek DetaylÄ± Rapor", "#2ecc71"),
        ("ğŸ“§ Mail Merkezi", "Rek Mail Merkezi", "#9b59b6"),
        ("ğŸ“¸ FotoÄŸraf Galerisi", "Rek Galeri", "#e67e22"),
        ("ğŸ“‚ Veri YÃ¼kleme", "Rek Veri YÃ¼kleme", "#34495e"),
    ]
    
    for i, (text, page, color) in enumerate(buttons):
        btn = tk.Button(btn_container, text=text, bg=color, fg="white", font=("Segoe UI", 12, "bold"),
                       padx=20, pady=20, cursor="hand2", bd=0, command=lambda p=page: show_page(p))
        btn.grid(row=i//3, column=i%3, padx=10, pady=10, sticky="ew")
    
    for i in range(3):
        btn_container.grid_columnconfigure(i, weight=1)
    
    # Sistem Durumu
    status_frame = tk.LabelFrame(content, text="ğŸ“‹ Sistem Durumu", font=("Segoe UI", 11, "bold"), bg="white", padx=15, pady=15)
    status_frame.pack(fill="x", pady=20)
    
    if df_reklamasyon_global is not None:
        total_records = len(df_reklamasyon_global)
        total_risk = df_reklamasyon_global["Iade_Tutari"].sum() + df_reklamasyon_global["Reklamasyon_Tutari"].sum()
        tk.Label(status_frame, text=f"âœ… Toplam {total_records} kayÄ±t yÃ¼klÃ¼", font=("Segoe UI", 10), bg="white", fg="green").pack(anchor="w")
        tk.Label(status_frame, text=f"âš ï¸ Toplam Risk: {total_risk:,.0f} â‚º", font=("Segoe UI", 10), bg="white", fg="red").pack(anchor="w")
    else:
        tk.Label(status_frame, text="âŒ HenÃ¼z veri yÃ¼klenmedi", font=("Segoe UI", 10), bg="white", fg="gray").pack(anchor="w")

# ---------- DASHBOARD ----------
def draw_dashboard(parent, stats=None, df=None):
    """Profesyonel Dashboard ArayÃ¼zÃ¼nÃ¼ Ã‡izer"""
    for widget in parent.winfo_children():
        widget.destroy()

    if stats is None:
        stats = {"count": "-", "price": "-", "delivery": "-", "return": "-", "score": "-", "pareto_a": "-"}

    icon_map = {"Users": "ğŸ‘¥", "Money": "â‚º", "Truck": "ğŸšš", "Return": "â†©ï¸", "Star": "â­", "Pareto": "ğŸ…°ï¸"}
    bg_color = "#f4f6f9"
    parent.configure(style="Dashboard.TFrame")
    
    main_frame = tk.Frame(parent, bg=bg_color)
    main_frame.pack(fill="both", expand=True)

    header_frame = tk.Frame(main_frame, bg="white", height=60, bd=1, relief="solid")
    header_frame.pack(fill="x", side="top")
    tk.Label(header_frame, text="TedarikÃ§i Performans YÃ¶netim Paneli", font=("Segoe UI", 18, "bold"), bg="white", fg="#2c3e50").pack(pady=15, padx=20, anchor="w")

    cards_container = tk.Frame(main_frame, bg=bg_color)
    cards_container.pack(fill="x", padx=20, pady=20)

    def create_card(parent_frame, title, value, unit, color_code, icon_key):
        card = tk.Frame(parent_frame, bg="white", bd=0, relief="flat")
        strip = tk.Frame(card, bg=color_code, width=6)
        strip.pack(side="left", fill="y")
        content = tk.Frame(card, bg="white")
        content.pack(side="left", fill="both", expand=True, padx=15, pady=15)
        title_row = tk.Frame(content, bg="white")
        title_row.pack(anchor="w")
        symbol = icon_map.get(icon_key, "")
        if symbol:
            tk.Label(title_row, text=symbol, font=("Segoe UI", 14), fg=color_code, bg="white").pack(side="left", padx=(0, 8))
        tk.Label(title_row, text=title, font=("Segoe UI", 10, "bold"), fg="#7f8c8d", bg="white").pack(side="left")
        val_frame = tk.Frame(content, bg="white")
        val_frame.pack(anchor="w", pady=(5, 0))
        tk.Label(val_frame, text=str(value), font=("Segoe UI", 24, "bold"), fg="#2c3e50", bg="white").pack(side="left")
        if unit:
            tk.Label(val_frame, text=unit, font=("Segoe UI", 12), fg="#95a5a6", bg="white").pack(side="left", padx=(5, 0), anchor="sw")
        return card

    c1 = create_card(cards_container, "TOPLAM TEDARÄ°KÃ‡Ä°", stats['count'], "Adet", "#3498db", "Users")
    c1.grid(row=0, column=0, padx=5, sticky="ew")
    
    c2 = create_card(cards_container, "ORT. FÄ°YAT", stats['price'], "TL", "#2ecc71", "Money")
    c2.grid(row=0, column=1, padx=5, sticky="ew")

    c3 = create_card(cards_container, "A SINIFI (PARETO)", stats['pareto_a'], "Adet", "#e67e22", "Pareto")
    c3.grid(row=0, column=2, padx=5, sticky="ew")

    c4 = create_card(cards_container, "ORT. TESLÄ°M", stats['delivery'], "GÃ¼n", "#f39c12", "Truck")
    c4.grid(row=0, column=3, padx=5, sticky="ew")

    c5 = create_card(cards_container, "ORT. Ä°ADE", stats['return'], "Adet", "#e74c3c", "Return") 
    c5.grid(row=0, column=4, padx=5, sticky="ew")

    c6 = create_card(cards_container, "KALÄ°TE SKORU", stats['score'], "Puan", "#9b59b6", "Star")
    c6.grid(row=0, column=5, padx=5, sticky="ew")

    for i in range(6):
        cards_container.columnconfigure(i, weight=1)

    if df is not None and not df.empty:
        charts_frame = tk.Frame(main_frame, bg=bg_color)
        charts_frame.pack(fill="both", expand=True, padx=20, pady=10)
        
        fig = plt.figure(figsize=(12, 4), facecolor=bg_color)
        gs = fig.add_gridspec(1, 2, wspace=0.3)
        
        ax1 = fig.add_subplot(gs[0, 0])
        if "Pareto_Sinifi" in df.columns:
            counts = df["Pareto_Sinifi"].value_counts()
            colors = {'A': '#27ae60', 'B': '#f39c12', 'C': '#c0392b'}
            pie_colors = [colors.get(x, '#95a5a6') for x in counts.index]
            
            wedges, texts, autotexts = ax1.pie(counts, labels=counts.index, autopct='%1.1f%%', 
                                             colors=pie_colors, startangle=90, textprops={'fontsize': 9})
            ax1.set_title("TedarikÃ§i ABC SÄ±nÄ±fÄ± DaÄŸÄ±lÄ±mÄ±", fontsize=11, fontweight='bold', color="#2c3e50")
            plt.setp(autotexts, size=9, weight="bold", color="white")
        else:
            ax1.text(0.5, 0.5, "ABC Verisi Yok", ha='center')

        ax2 = fig.add_subplot(gs[0, 1])
        if "Skor" in df.columns:
            ax2.hist(df["Skor"], bins=10, color="#3498db", edgecolor='white', alpha=0.7)
            ax2.set_title("Performans Skoru DaÄŸÄ±lÄ±mÄ±", fontsize=11, fontweight='bold', color="#2c3e50")
            ax2.set_xlabel("Skor AralÄ±ÄŸÄ±", fontsize=9)
            ax2.set_ylabel("TedarikÃ§i SayÄ±sÄ±", fontsize=9)
            ax2.grid(axis='y', linestyle='--', alpha=0.5)
        
        canvas = FigureCanvasTkAgg(fig, master=charts_frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill="both", expand=True)

    else:
        info_frame = tk.Frame(main_frame, bg=bg_color)
        info_frame.pack(fill="both", expand=True, padx=20)
        info_text = """
        SÄ°STEM DURUMU VE TALÄ°MATLAR:
        -------------------------------------------
        1. 'Analiz' sekmesinden veri dosyanÄ±zÄ± yÃ¼kleyerek iÅŸleme baÅŸlayÄ±n.
        2. SonuÃ§lar yukarÄ±daki kartlarda ve grafiklerde otomatik olarak gÃ¼ncellenecektir.
        3. 'Karne' sekmesinden tedarikÃ§i detaylarÄ±nÄ± inceleyebilir ve mail gÃ¶nderebilirsiniz.
        """
        tk.Label(info_frame, text=info_text, justify="left", font=("Consolas", 10), bg="#ecf0f1", fg="#7f8c8d", relief="flat", padx=20, pady=20).pack(fill="both", expand=True)

# ---------- OCR VE GÃ–RÃœNTÃœ Ä°ÅLEME FONKSÄ°YONLARI (GELÄ°ÅTÄ°RÄ°LMÄ°Å) ----------
def extract_invoice_data_gemini(image_path):
    """GeliÅŸmiÅŸ OCR: JSON tabanlÄ± yapÄ±landÄ±rÄ±lmÄ±ÅŸ fatura verisi Ã§Ä±karma"""
    if not GEMINI_API_KEY: return None, "API AnahtarÄ± bulunamadÄ±."
    try:
        with open(image_path, "rb") as image_file:
            image_data = base64.b64encode(image_file.read()).decode('utf-8')
            
        ext = os.path.splitext(image_path)[1].lower()
        if ext == '.pdf':
            mime_type = "application/pdf"
        elif ext == '.png':
            mime_type = "image/png"
        else:
            mime_type = "image/jpeg"

        prompt = """
        Sen bir Fatura Analiz UzmanÄ±sÄ±n. Bu belgeyi analiz et ve aÅŸaÄŸÄ±daki alanlarÄ± iÃ§eren yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir JSON Ã§Ä±ktÄ±sÄ± ver.
        Ã–zellikle 'SipariÅŸ NumarasÄ±' (PO-, Order No, SipariÅŸ FiÅŸi vb.) ve 'Model Kodu' (Model, Style No, ÃœrÃ¼n Grubu vb.) alanlarÄ±na dikkat et.
        Sadece JSON formatÄ±nda yanÄ±t ver, baÅŸka bir metin ekleme.
        
        Ä°stenen JSON YapÄ±sÄ±:
        {
          "fatura_no": "...",
          "tarih": "YYYY-MM-DD",
          "tedarikci_adi": "...",
          "vergi_no": "...",
          "siparis_no": "...", 
          "model_kodu": "...",
          "toplam_tutar": 0.00,
          "para_birimi": "TRY",
          "kalemler": [
            {
              "urun_adi": "...",
              "miktar": 0,
              "birim_fiyat": 0.00,
              "satir_toplami": 0.00
            }
          ]
        }
        """
        payload = {"contents": [{"parts": [{"text": prompt}, {"inline_data": {"mime_type": mime_type, "data": image_data}}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=payload, timeout=60)
        
        if response.status_code == 200:
            text = response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
            # Clean markdown code blocks if present
            if text.startswith("```json"):
                text = text[7:]
            if text.endswith("```"):
                text = text[:-3]
            return json.loads(text.strip()), None
        else:
            return None, f"Hata: {response.status_code} - {response.text}"
    except Exception as e: return None, f"OCR HatasÄ±: {str(e)}"

def init_ocr_tab():
    """GeliÅŸtirilmiÅŸ OCR sekmesi: PDF desteÄŸi, JSON Ã¶nizleme, sipariÅŸ eÅŸleÅŸtirme"""
    global ocr_image_label, ocr_result_text, ocr_order_combobox
    for widget in frame_ocr.winfo_children(): widget.destroy()
    
    left_panel = tk.Frame(frame_ocr, bg="#f4f6f9", width=400)
    left_panel.pack(side="left", fill="y", padx=10, pady=10)
    tk.Label(left_panel, text="Dosya YÃ¼kle (Fatura/Liste - Resim veya PDF)", font=("Segoe UI", 12, "bold"), bg="#f4f6f9").pack(pady=10)
    
    def select_ocr_image():
        file_path = filedialog.askopenfilename(filetypes=[("Desteklenen Dosyalar", "*.jpg *.jpeg *.png *.pdf")])
        if file_path:
            # Preview logic
            if file_path.lower().endswith('.pdf'):
                 ocr_image_label.configure(image='', text=f"PDF DosyasÄ± SeÃ§ildi:\n{os.path.basename(file_path)}")
                 ocr_image_label.image = None
            else:
                 img = Image.open(file_path); img.thumbnail((350, 500)); img_tk = ImageTk.PhotoImage(img)
                 ocr_image_label.configure(image=img_tk, text=""); ocr_image_label.image = img_tk
            
            run_ocr_pipeline(file_path)
    
    ttk.Button(left_panel, text="Dosya SeÃ§ ve Ã‡evir", command=select_ocr_image).pack(pady=10, fill="x", padx=20)
    ocr_image_label = tk.Label(left_panel, text="Ã–nizleme Yok", bg="#ddd", width=40, height=20); ocr_image_label.pack(pady=10, expand=True, fill="both")
    
    right_panel = tk.Frame(frame_ocr, bg="white"); right_panel.pack(side="right", fill="both", expand=True, padx=10, pady=10)
    tk.Label(right_panel, text="Fatura Verisi (JSON)", font=("Segoe UI", 12, "bold"), bg="white").pack(pady=10)
    ocr_result_text = tk.Text(right_panel, font=("Consolas", 10), wrap="none"); ocr_result_text.pack(fill="both", expand=True, padx=10, pady=5)
    
    # SipariÅŸ No AlanÄ± (Otomatik EÅŸleÅŸtirme)
    meta_frame = tk.Frame(right_panel, bg="white", pady=10)
    meta_frame.pack(fill="x")
    tk.Label(meta_frame, text="BaÄŸlÄ± SipariÅŸ / Model Kodu:", font=("Segoe UI", 10, "bold"), bg="white").pack(anchor="w")
    ocr_order_combobox = ttk.Combobox(meta_frame, width=40) 
    if all_stock_codes: ocr_order_combobox['values'] = all_stock_codes
    ocr_order_combobox.pack(fill="x", pady=5)

    action_frame = tk.Frame(right_panel, bg="white"); action_frame.pack(fill="x", pady=10)
    
    def save_ocr_to_excel():
        content = ocr_result_text.get("1.0", tk.END).strip()
        if not content or "{" not in content: return
        try:
            start = content.find("{")
            end = content.rfind("}") + 1
            json_str = content[start:end]
            data = json.loads(json_str)
            
            if "kalemler" in data and data["kalemler"]:
                df = pd.DataFrame(data["kalemler"])
                for key in ["fatura_no", "tarih", "tedarikci_adi", "vergi_no", "toplam_tutar", "para_birimi", "siparis_no", "model_kodu"]:
                    if key in data: df[key] = data[key]
                
                f = filedialog.asksaveasfilename(defaultextension=".xlsx", filetypes=[("Excel", "*.xlsx")])
                if f: df.to_excel(f, index=False); messagebox.showinfo("BaÅŸarÄ±lÄ±", "Excel dosyasÄ± kaydedildi.")
            else:
                 messagebox.showwarning("UyarÄ±", "Kalem verisi bulunamadÄ±.")
        except Exception as e: messagebox.showerror("Hata", f"Excel'e Ã§evrilemedi:\n{e}")

    ttk.Button(action_frame, text="Excel Olarak Kaydet", command=save_ocr_to_excel).pack(side="right", padx=10)
    ttk.Button(action_frame, text="ERP'ye Aktar (SimÃ¼lasyon)", command=send_to_mock_erp).pack(side="right", padx=10)

def run_ocr_pipeline(image_path):
    """GeliÅŸtirilmiÅŸ OCR pipeline: JSON Ã§Ä±ktÄ± ve otomatik sipariÅŸ eÅŸleÅŸtirme"""
    global ocr_json_data
    ocr_result_text.configure(state="normal")
    ocr_result_text.delete("1.0", tk.END)
    ocr_result_text.insert("1.0", "Fatura iÅŸleniyor ve anlamsal veri Ã§Ä±karÄ±lÄ±yor... LÃ¼tfen bekleyin...\n")
    ocr_result_text.configure(state="disabled")
    
    def _thread():
        global ocr_json_data
        data, error = extract_invoice_data_gemini(image_path)
        
        if data:
            ocr_json_data = data
            formatted_json = json.dumps(data, indent=4, ensure_ascii=False)
            root.after(0, lambda: _update_text(formatted_json, success=True, data=data))
        else:
            ocr_json_data = None
            root.after(0, lambda: _update_text(error, success=False, data=None))
            
    def _update_text(val, success, data):
        ocr_result_text.configure(state="normal")
        ocr_result_text.delete("1.0", tk.END)
        if success:
            ocr_result_text.insert("1.0", "âœ… FATURA BAÅARIYLA Ã‡Ã–ZÃœMLENDÄ°!\n\n")
            ocr_result_text.insert(tk.END, val)
            
            # Otomatik SipariÅŸ No Doldurma
            if data:
                found_order = data.get("siparis_no") or data.get("model_kodu")
                if found_order:
                    ocr_order_combobox.set(found_order)
                else:
                    ocr_order_combobox.set("")
        else:
            ocr_result_text.insert("1.0", f"âŒ HATA: {val}")
        ocr_result_text.configure(state="disabled")

    threading.Thread(target=_thread, daemon=True).start()

def send_to_mock_erp():
    """ERP entegrasyonu simÃ¼lasyonu"""
    global ocr_json_data
    if not ocr_json_data:
        messagebox.showwarning("UyarÄ±", "GÃ¶nderilecek veri yok. LÃ¼tfen Ã¶nce bir fatura yÃ¼kleyin.")
        return
    
    # KullanÄ±cÄ±nÄ±n girdiÄŸi sipariÅŸ numarasÄ±nÄ± ekle
    user_order = ocr_order_combobox.get()
    if user_order:
        ocr_json_data["bagli_siparis"] = user_order
    
    # Mock sending
    msg_box = tk.Toplevel()
    msg_box.title("ERP Entegrasyonu")
    msg_box.geometry("400x150")
    tk.Label(msg_box, text="SAP/ERP Sistemine BaÄŸlanÄ±lÄ±yor...", font=("Segoe UI", 10)).pack(pady=20)
    
    progress = ttk.Progressbar(msg_box, mode='indeterminate')
    progress.pack(fill='x', padx=20)
    progress.start()
    
    def _finish():
        progress.stop()
        msg_box.destroy()
        
        info_text = f"Fatura No: {ocr_json_data.get('fatura_no', 'Bilinmiyor')}\n"
        if "bagli_siparis" in ocr_json_data:
             info_text += f"EÅŸleÅŸen SipariÅŸ: {ocr_json_data['bagli_siparis']}\n"
             
        messagebox.showinfo("BaÅŸarÄ±lÄ±", f"{info_text}ERP Sistemine baÅŸarÄ±yla aktarÄ±ldÄ±!\n(Transaction ID: {random.randint(100000, 999999)})")
        
    # Simulate network delay
    root.after(2000, _finish)

# ---------- HARÄ°TA VE ROTA FONKSÄ°YONLARI ----------
def init_map_tab():
    global map_widget, route_info_label
    for widget in frame_harita.winfo_children():
        widget.destroy()
        
    if not MAP_AVAILABLE:
        tk.Label(frame_harita, text="Harita modÃ¼lÃ¼ bulunamadÄ±.\nLÃ¼tfen 'pip install tkintermapview' komutunu Ã§alÄ±ÅŸtÄ±rÄ±n.", 
                 font=("Arial", 14), fg="red").pack(expand=True)
        return

    map_widget = tkintermapview.TkinterMapView(frame_harita, width=800, height=600, corner_radius=0)
    map_widget.pack(fill="both", expand=True)
    
    map_widget.set_tile_server("https://a.tile.openstreetmap.org/{z}/{x}/{y}.png")
    map_widget.set_position(39.0, 35.0) 
    map_widget.set_zoom(6)
    
    map_widget.add_right_click_menu_command(label="ğŸ“ BurayÄ± BaÅŸlangÄ±Ã§ NoktasÄ± Yap", command=set_start_marker, pass_coords=True)
    map_widget.add_right_click_menu_command(label="ğŸ BurayÄ± VarÄ±ÅŸ NoktasÄ± Yap", command=set_destination_marker, pass_coords=True)

    controls_panel = tk.Frame(map_widget, bg="white", bd=1, relief="solid")
    controls_panel.place(relx=0.02, rely=0.02, anchor="nw")
    tk.Label(controls_panel, text="Harita Kontrolleri", font=("Arial", 10, "bold"), bg="white").pack(padx=5, pady=2)
    
    def set_osm_std(): map_widget.set_tile_server("https://a.tile.openstreetmap.org/{z}/{x}/{y}.png")
    def set_carto_light(): map_widget.set_tile_server("https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png")
    def set_google_satellite(): map_widget.set_tile_server("https://mt0.google.com/vt/lyrs=s&hl=tr&x={x}&y={y}&z={z}", max_zoom=22)

    tk.Button(controls_panel, text="Standart (OSM)", command=set_osm_std, bg="#f0f0f0", width=15).pack(padx=5, pady=2)
    tk.Button(controls_panel, text="HÄ±zlÄ± (Sade)", command=set_carto_light, bg="#f0f0f0", width=15).pack(padx=5, pady=2)
    tk.Button(controls_panel, text="Google Uydu", command=set_google_satellite, bg="#f0f0f0", width=15).pack(padx=5, pady=2)
    tk.Button(controls_panel, text="TÃ¼mÃ¼nÃ¼ GÃ¶ster", command=lambda: map_widget.fit_bounding_box((42.0, 26.0), (36.0, 45.0)), bg="#e0e0e0", width=15).pack(padx=5, pady=(10, 5))
    tk.Button(controls_panel, text="ğŸ¯ TedarikÃ§i Risk HaritasÄ±", command=show_supplier_risk_map, bg="#e74c3c", fg="white", width=15, font=("Segoe UI", 9, "bold")).pack(padx=5, pady=2)

    route_info_label = tk.Label(map_widget, text="SaÄŸ tÄ±klayarak BaÅŸlangÄ±Ã§ veya VarÄ±ÅŸ noktasÄ± seÃ§in.", justify="left", 
                                font=("Segoe UI", 10), bg="white", fg="#333333", bd=1, relief="solid", padx=10, pady=10, wraplength=350)
    route_info_label.place(relx=0.98, rely=0.02, anchor="ne")

def show_supplier_risk_map():
    """TedarikÃ§ileri risk durumlarÄ±na gÃ¶re haritada gÃ¶sterir"""
    if not MAP_AVAILABLE or map_widget is None:
        messagebox.showwarning("UyarÄ±", "Harita modÃ¼lÃ¼ bulunamadÄ±!")
        return
    
    if sonuc_global is None or df_global is None:
        messagebox.showwarning("UyarÄ±", "LÃ¼tfen Ã¶nce verileri analiz edin!")
        return
    
    # Mevcut marker'larÄ± temizle
    map_widget.delete_all_marker()
    
    # TÃ¼rkiye'nin bÃ¼yÃ¼k ÅŸehirlerinin koordinatlarÄ± (tedarikÃ§i konumlarÄ± iÃ§in)
    city_coords = {
        'Ä°stanbul': (41.0082, 28.9784),
        'Ankara': (39.9334, 32.8597),
        'Ä°zmir': (38.4237, 27.1428),
        'Bursa': (40.1826, 29.0665),
        'Antalya': (36.8969, 30.7133),
        'Adana': (37.0000, 35.3213),
        'Gaziantep': (37.0662, 37.3833),
        'Konya': (37.8746, 32.4932),
        'Mersin': (36.8121, 34.6415),
        'Kayseri': (38.7312, 35.4787),
        'Denizli': (37.7765, 29.0864),
        'TekirdaÄŸ': (40.9833, 27.5167),
        'KahramanmaraÅŸ': (37.5858, 36.9371),
        'BalÄ±kesir': (39.6484, 27.8826),
        'Ã‡orum': (40.5506, 34.9556)
    }
    
    # TedarikÃ§i bazÄ±nda risk skorlarÄ±
    suppliers = sonuc_global[[tedarikci_col_global, 'Genel Skor', 'Not']].drop_duplicates()
    
    cities = list(city_coords.keys())
    markers = []
    
    for idx, (_, row) in enumerate(suppliers.iterrows()):
        supplier = row[tedarikci_col_global]
        score = row['Genel Skor']
        note = row['Not']
        
        # Risk seviyesi belirleme
        if score >= 80:
            risk_level = "GÃ¼venli"
            marker_color = "green"
            risk_icon = "âœ…"
        elif score >= 60:
            risk_level = "Orta Risk"
            marker_color = "orange"
            risk_icon = "âš ï¸"
        else:
            risk_level = "YÃ¼ksek Risk"
            marker_color = "red"
            risk_icon = "â›”"
        
        # Åehir atama (dÃ¶ngÃ¼sel)
        city = cities[idx % len(cities)]
        lat, lon = city_coords[city]
        
        # KÃ¼Ã§Ã¼k rastgele offset ekle (aynÄ± ÅŸehirdeki tedarikÃ§ileri ayÄ±rt etmek iÃ§in)
        lat += random.uniform(-0.1, 0.1)
        lon += random.uniform(-0.1, 0.1)
        
        # Marker ekle
        marker_text = f"{risk_icon} {supplier}\nSkor: {score:.0f}\n{note}\nKonum: {city}"
        marker = map_widget.set_marker(lat, lon, text=marker_text, marker_color_circle=marker_color, marker_color_outside="white")
        markers.append(marker)
    
    # HaritayÄ± TÃ¼rkiye'ye odakla
    map_widget.set_position(39.0, 35.0)
    map_widget.set_zoom(6)
    
    # Bilgi gÃ¼ncellemesi
    if route_info_label:
        info_text = f"""ğŸ¯ TEDARÄ°KÃ‡Ä° RÄ°SK HARÄ°TASI

Toplam: {len(suppliers)} tedarikÃ§i
        
âœ… YeÅŸil: GÃ¼venli (Skor â‰¥ 80)
âš ï¸ Turuncu: Orta Risk (60-79)
â›” KÄ±rmÄ±zÄ±: YÃ¼ksek Risk (< 60)

Marker'a tÄ±klayarak detaylarÄ± gÃ¶rÃ¼n."""
        route_info_label.configure(text=info_text)
    
    messagebox.showinfo("Risk HaritasÄ±", f"{len(suppliers)} tedarikÃ§i risk durumlarÄ±na gÃ¶re haritada iÅŸaretlendi!")

def get_weather_data(lat, lon):
    try:
        url = f"https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={lon}&current_weather=true"
        response = requests.get(url, timeout=5)
        if response.status_code == 200:
            data = response.json().get("current_weather", {})
            temp = data.get("temperature", "-")
            wcode = data.get("weathercode", 0)
            
            condition = "AÃ§Ä±k"
            if wcode in [1, 2, 3]: condition = "ParÃ§alÄ± Bulutlu"
            elif wcode in [45, 48]: condition = "Sisli"
            elif wcode in [51, 53, 55, 61, 63, 65]: condition = "YaÄŸmurlu"
            elif wcode in [71, 73, 75]: condition = "KarlÄ±"
            elif wcode >= 95: condition = "FÄ±rtÄ±nalÄ±"
            
            return f"{temp}Â°C, {condition}"
    except:
        pass
    return "Veri alÄ±namadÄ±"

def haversine_distance(lat1, lon1, lat2, lon2):
    R = 6371 
    dLat = math.radians(lat2 - lat1)
    dLon = math.radians(lon2 - lon1)
    a = math.sin(dLat/2) * math.sin(dLat/2) + math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) * math.sin(dLon/2) * math.sin(dLon/2)
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
    return R * c

def get_osrm_route(lat1, lon1, lat2, lon2):
    url = f"http://router.project-osrm.org/route/v1/driving/{lon1},{lat1};{lon2},{lat2}?overview=full&geometries=geojson"
    
    try:
        headers = {'User-Agent': 'TedarikciAnalizApp/1.0'}
        response = requests.get(url, headers=headers, timeout=5)
        
        if response.status_code == 200:
            data = response.json()
            if data.get("code") == "Ok" and data.get("routes"):
                route = data["routes"][0]
                distance_km = route["distance"] / 1000 
                duration_min = route["duration"] / 60 
                
                geometry = route["geometry"]["coordinates"]
                path_coords = [(p[1], p[0]) for p in geometry]
                
                return distance_km, duration_min, path_coords
    except Exception as e:
        print(f"OSRM HatasÄ±: {e}")
        
    return None, None, None

def get_ai_logistics_analysis(origin_name, destination_name, dist_km, weather):
    if not GEMINI_API_KEY: return "AI AnahtarÄ± yok."
    
    prompt = f"""
    Lojistik Analizi Ä°steÄŸi:
    - Ã‡Ä±kÄ±ÅŸ NoktasÄ±: {origin_name}
    - VarÄ±ÅŸ NoktasÄ±: {destination_name}
    - Rota Mesafesi: {dist_km:.1f} km
    - VarÄ±ÅŸ NoktasÄ± Hava Durumu: {weather}
    
    Bir lojistik uzmanÄ± gibi davran. AÅŸaÄŸÄ±dakileri iÃ§eren Ã§ok kÄ±sa (maksimum 4-5 cÃ¼mle) bir TÃ¼rkÃ§e Ã¶zet yaz:
    1. Bu mesafedeki karayolu taÅŸÄ±macÄ±lÄ±ÄŸÄ± iÃ§in kritik noktalar.
    2. Hava durumunun taÅŸÄ±macÄ±lÄ±ÄŸa olasÄ± etkisini deÄŸerlendir.
    3. Varsa potansiyel riskleri belirt.
    """
    
    try:
        data = {"contents": [{"parts":[{"text": prompt}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=10)
        if response.status_code == 200:
            return response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
    except Exception as e:
        return f"AI Analizi alÄ±namadÄ±: {str(e)}"
    return "AI YanÄ±t vermedi."

def set_start_marker(coords):
    global start_marker
    if not map_widget: return
    
    if start_marker:
        start_marker.delete()
        
    start_marker = map_widget.set_marker(coords[0], coords[1], text="BaÅŸlangÄ±Ã§", marker_color_circle="white", marker_color_outside="green")
    
    if destination_marker:
        set_destination_marker(destination_marker.position)

def set_destination_marker(coords):
    global destination_marker
    if not map_widget: return
    
    if destination_marker:
        destination_marker.delete()
        
    destination_marker = map_widget.set_marker(coords[0], coords[1], text="Depo / VarÄ±ÅŸ", marker_color_circle="black", marker_color_outside="red")
    
    weather_info = get_weather_data(coords[0], coords[1])
    
    map_widget.delete_all_path()
    dest_pos = destination_marker.position
    
    origin_name = "Bilinmiyor"
    min_dist = 0
    duration_str = ""
    route_type = ""
    
    start_pos = None
    
    if start_marker:
        start_pos = start_marker.position
        origin_name = "SeÃ§ilen BaÅŸlangÄ±Ã§ NoktasÄ±"
        
    elif supplier_markers:
        min_dist_bird = float('inf')
        nearest_sup_marker = None
        
        for marker in supplier_markers:
            dist = haversine_distance(marker.position[0], marker.position[1], dest_pos[0], dest_pos[1])
            if dist < min_dist_bird:
                min_dist_bird = dist
                nearest_sup_marker = marker
        
        if nearest_sup_marker:
            start_pos = nearest_sup_marker.position
            origin_name = nearest_sup_marker.text.split("\n")[0]
            
    else:
        if route_info_label:
            route_info_label.configure(text=f"ğŸ“ VARIÅ: {weather_info}\nLÃ¼tfen bir baÅŸlangÄ±Ã§ noktasÄ± seÃ§in veya dosya yÃ¼kleyin.")
        return

    if start_pos:
        road_dist, road_dur, path_points = get_osrm_route(start_pos[0], start_pos[1], dest_pos[0], dest_pos[1])
        
        if road_dist:
            min_dist = road_dist
            hours = int(road_dur // 60)
            mins = int(road_dur % 60)
            duration_str = f"{hours} sa {mins} dk" if hours > 0 else f"{mins} dk"
            
            map_widget.set_path(path_points, color="blue", width=3)
            route_type = "Karayolu"
        else:
            min_dist = haversine_distance(start_pos[0], start_pos[1], dest_pos[0], dest_pos[1])
            duration_str = f"~{int(min_dist / 70)} sa (KuÅŸ UÃ§uÅŸu Tahmini)" 
            
            map_widget.set_path([start_pos, dest_pos], color="gray", width=2)
            route_type = "KuÅŸ UÃ§uÅŸu"

    initial_text = f"ğŸ“ ROTA BÄ°LGÄ°SÄ° ({route_type})\n"
    initial_text += f"-----------------------------\n"
    initial_text += f"ğŸŒ¡ï¸ VarÄ±ÅŸ Hava: {weather_info}\n"
    initial_text += f"ğŸš© Ã‡Ä±kÄ±ÅŸ: {origin_name}\n"
    initial_text += f"ğŸ›£ï¸ Mesafe: {min_dist:.1f} km\n"
    initial_text += f"â±ï¸ SÃ¼re: {duration_str}\n"
    initial_text += f"ğŸ¤– Yapay Zeka Lojistik Analizi HazÄ±rlanÄ±yor..."
    
    if route_info_label:
        route_info_label.configure(text=initial_text)
    
    def fetch_ai_logistics():
        dest_coord_str = f"{coords[0]:.4f}, {coords[1]:.4f}"
        ai_insight = get_ai_logistics_analysis(origin_name, dest_coord_str, min_dist, weather_info)
        final_text = initial_text.replace("ğŸ¤– Yapay Zeka Lojistik Analizi HazÄ±rlanÄ±yor...", f"\nğŸ§  AI Lojistik Analizi:\n{ai_insight}")
        if route_info_label:
            route_info_label.configure(text=final_text)
    
    threading.Thread(target=fetch_ai_logistics, daemon=True).start()

def clean_city_name(name):
    if not isinstance(name, str): return ""
    name = name.replace("Ä°", "i").replace("I", "Ä±").replace("Ä", "ÄŸ").replace("Ãœ", "Ã¼").replace("Å", "ÅŸ").replace("Ã–", "Ã¶").replace("Ã‡", "Ã§")
    return name.lower().strip()

def update_map_with_suppliers(df, city_col, supplier_col):
    global supplier_markers
    if not MAP_AVAILABLE or not map_widget: return
    
    map_widget.delete_all_marker()
    map_widget.delete_all_path()
    supplier_markers.clear()
    
    if city_col not in df.columns:
        messagebox.showwarning("Harita UyarÄ±sÄ±", "Veride 'Ä°l' veya 'Åehir' kolonu bulunamadÄ±.\nHarita gÃ¼ncellenemedi.")
        return

    city_groups = df.groupby(city_col)[supplier_col].apply(list).to_dict()
    
    for city_name, suppliers in city_groups.items():
        clean_city = clean_city_name(city_name)
        
        coords = None
        if clean_city in TR_CITIES:
             coords = TR_CITIES[clean_city]
        else:
             for key in TR_CITIES:
                 if key in clean_city: 
                     coords = TR_CITIES[key]
                     break
        
        if coords:
            unique_suppliers = sorted(list(set(suppliers)))
            unique_count = len(unique_suppliers)
            
            display_list = []
            for sup in unique_suppliers:
                if sonuc_global is not None and not sonuc_global.empty:
                    match = sonuc_global[sonuc_global[tedarikci_col_global] == sup]
                    if not match.empty:
                        sc = match.iloc[0]["Skor"]
                        gr, _, _ = calculate_grade(sc)
                        display_list.append(f"{sup} (Not: {gr})")
                    else:
                        display_list.append(sup)
                else:
                    display_list.append(sup)

            text = f"{city_name}\n{unique_count} TedarikÃ§i\n"
            text += "\n".join(display_list[:3])
            if unique_count > 3: text += "\n..."
            
            marker = map_widget.set_marker(coords[0], coords[1], text=text, marker_color_circle="white", marker_color_outside="blue")
            supplier_markers.append(marker)
    
    if destination_marker:
        set_destination_marker(destination_marker.position)

# ---------- KARNE FONKSÄ°YONLARI (SCORECARD) ----------
def init_scorecard_tab():
    """GeliÅŸtirilmiÅŸ karne sekmesi: KaydÄ±rÄ±labilir iÃ§erik"""
    global karne_combobox, frame_karne_content
    for w in frame_karne.winfo_children(): w.destroy()
    
    header_frame = tk.Frame(frame_karne, bg="#f4f6f9")
    header_frame.pack(fill="x", pady=10, padx=10)
    
    tk.Label(header_frame, text="TedarikÃ§i SeÃ§in:", bg="#f4f6f9", font=("Segoe UI", 11)).pack(side="left", padx=5)
    karne_combobox = ttk.Combobox(header_frame, state="readonly", width=40)
    karne_combobox.pack(side="left", padx=5)
    ttk.Button(header_frame, text="Karneyi GÃ¶ster", command=show_scorecard).pack(side="left", padx=5)
    ttk.Button(header_frame, text="ğŸ“„ Karneyi PDF Ä°ndir", command=export_scorecard_pdf).pack(side="left", padx=5)
    
    # KaydÄ±rÄ±labilir canvas iÃ§in wrapper
    canvas = tk.Canvas(frame_karne, bg="white")
    scrollbar = ttk.Scrollbar(frame_karne, orient="vertical", command=canvas.yview)
    frame_karne_content = tk.Frame(canvas, bg="white")
    frame_karne_content.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
    canvas.create_window((0, 0), window=frame_karne_content, anchor="nw")
    canvas.configure(yscrollcommand=scrollbar.set)
    canvas.pack(side="left", fill="both", expand=True)
    scrollbar.pack(side="right", fill="y")
    
    tk.Label(frame_karne_content, text="LÃ¼tfen bir tedarikÃ§i seÃ§ip 'Karneyi GÃ¶ster' butonuna basÄ±n.", fg="gray").pack(pady=50)

def calculate_grade(score):
    """Yeni geliÅŸmiÅŸ notlandÄ±rma sistemi"""
    if score >= 90: return "A+", "#27ae60", "MÃ¼kemmel Performans"
    elif score >= 85: return "A", "#2ecc71", "Ã‡ok Ä°yi"
    elif score >= 75: return "B", "#3498db", "Ä°yi / Standart ÃœstÃ¼"
    elif score >= 60: return "C", "#f39c12", "Orta / GeliÅŸtirilmeli"
    elif score >= 50: return "D", "#e67e22", "ZayÄ±f / Riskli"
    else: return "F", "#c0392b", "Kritik / Acil Aksiyon"

def get_scorecard_ai_comment(row, grade, desc):
    """Yapay zeka destekli detaylÄ± karne yorumu"""
    if not GEMINI_API_KEY: return "Yapay zeka anahtarÄ± eksik."
    
    # DetaylÄ± puanlama bilgisini kontrol et
    score_price = row.get('Score_Price', 'N/A')
    score_deliv = row.get('Score_Deliv', 'N/A')
    score_return = row.get('Score_Return', 'N/A')
    
    prompt = f"""
    AÅŸaÄŸÄ±daki tedarikÃ§i karnesi verilerini analiz et ve detaylÄ± bir yorum yaz.
    
    TedarikÃ§i: {row[tedarikci_col_global]}
    Genel Performans Skoru: {row['Skor']:.2f} / 100
    Performans Notu: {grade} ({desc})
    Pareto SÄ±nÄ±fÄ± (Ciro): {row.get('Pareto_Sinifi', '-')}
    
    DetaylÄ± Metrik PuanlarÄ± (0-100 arasÄ±):
    - Fiyat PuanÄ±: {score_price if isinstance(score_price, (int, float)) else 'N/A'}
    - Teslimat PuanÄ±: {score_deliv if isinstance(score_deliv, (int, float)) else 'N/A'}
    - Ä°ade/Kalite PuanÄ±: {score_return if isinstance(score_return, (int, float)) else 'N/A'}
    
    LÃ¼tfen ÅŸu sorulara cevap ver:
    1. Bu tedarikÃ§i neden bu notu ({grade}) aldÄ±?
    2. Hangi alanda (Fiyat, Teslimat, Ä°ade) en baÅŸarÄ±lÄ±?
    3. Hangi alanda iyileÅŸtirme yapmalÄ±?
    4. Ciro bazlÄ± Pareto sÄ±nÄ±fÄ±na ({row.get('Pareto_Sinifi', '-')}) gÃ¶re stratejik Ã¶nemi nedir?
    
    CevabÄ± TÃ¼rkÃ§e, profesyonel ve madde iÅŸaretli olarak ver.
    """
    try:
        data = {"contents": [{"parts":[{"text": prompt}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=10)
        return response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
    except: return "AI yorumu alÄ±namadÄ±. BaÄŸlantÄ± hatasÄ±."

def send_scorecard_email_action():
    """AI destekli kiÅŸiselleÅŸtirilmiÅŸ email gÃ¶nderimi"""
    if not karne_combobox.get() or sonuc_global is None: return
    supplier_name = karne_combobox.get()
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    
    mail_col = find_col_by_keywords(sonuc_global, ["mail", "eposta", "email"])
    if not mail_col: 
        messagebox.showerror("Hata", "Mail adresi bulunamadÄ±.")
        return
    
    receiver_email = row[mail_col]
    if pd.isna(receiver_email) or str(receiver_email).strip() == "":
        messagebox.showerror("Hata", "TedarikÃ§inin mail adresi yok.")
        return

    grade, _, desc = calculate_grade(row["Skor"])
    pareto = row.get('Pareto_Sinifi', '-')
    
    def _send_thread():
        try:
            # AI ile Mail Ä°Ã§eriÄŸi OluÅŸtur
            prompt = f"""
            TedarikÃ§i: {supplier_name}
            Puan: {row['Skor']:.1f}/100
            Not: {grade} ({desc})
            Pareto: {pareto}
            
            Bu tedarikÃ§iye performans karnesini ileten, eksiklerini (eÄŸer puanÄ± dÃ¼ÅŸÃ¼kse) nazikÃ§e belirten kurumsal bir e-posta metni yaz.
            Sadece mail gÃ¶vdesini dÃ¶ndÃ¼r.
            """
            data = {"contents": [{"parts":[{"text": prompt}]}]}
            response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=20)
            body = response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
            
            subject = f"Performans Karnesi Bildirimi - {supplier_name}"
            success, msg = send_email_with_attachments(str(receiver_email), subject, body)
            
            if success: messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Mail gÃ¶nderildi: {receiver_email}")
            else: messagebox.showerror("Hata", f"Mail hatasÄ±: {msg}")
        except Exception as e: messagebox.showerror("Hata", str(e))

    threading.Thread(target=_send_thread, daemon=True).start()

def send_single_supplier_email():
    if not karne_combobox.get(): return
    supplier_name = karne_combobox.get()
    
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    
    mail_col = find_col_by_keywords(sonuc_global, ["mail", "eposta", "e-posta", "email"])
    
    if not mail_col:
        messagebox.showerror("Hata", "Analiz sonucunda 'Mail' bilgisi bulunamadÄ±.\nLÃ¼tfen yÃ¼klediÄŸiniz dosyada 'Mail' veya 'E-Posta' adÄ±nda bir sÃ¼tun olduÄŸundan emin olun.")
        return
        
    receiver_email = row[mail_col]
    
    if pd.isna(receiver_email) or str(receiver_email).strip() == "" or str(receiver_email) == "0":
        messagebox.showerror("Hata", f"{supplier_name} iÃ§in kayÄ±tlÄ± bir mail adresi bulunamadÄ±.")
        return

    grade, _, desc = calculate_grade(row["Skor"])
    
    subject = f"TedarikÃ§i Performans DeÄŸerlendirmesi - {supplier_name}"
    
    body = f"""SayÄ±n Yetkili,

DÃ¶nem iÃ§i performans deÄŸerlendirmesi sonucunda firmanÄ±zÄ±n tedarikÃ§i karnesi aÅŸaÄŸÄ±da Ã¶zetlenmiÅŸtir:

Firma AdÄ±: {supplier_name}
-----------------------------------
Genel Performans Skoru: {row['Skor']:.2f} / 100
BaÅŸarÄ± Notu: {grade} ({desc})
ABC SÄ±nÄ±fÄ±: {row.get('Pareto_Sinifi', '-')}

DetaylÄ± analiz raporu ve iyileÅŸtirme Ã¶nerileri iÃ§in ilgili departmanÄ±mÄ±zla iletiÅŸime geÃ§ebilirsiniz.

Ä°yi Ã§alÄ±ÅŸmalar dileriz.
"""

    try:
        success, msg = send_email_with_attachments(str(receiver_email), subject, body, [])
        if success:
            messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Mail baÅŸarÄ±yla gÃ¶nderildi:\n{receiver_email}")
        else:
            messagebox.showerror("GÃ¶nderim HatasÄ±", f"Mail gÃ¶nderilemedi:\n{msg}")
    except Exception as e:
        messagebox.showerror("Hata", f"Bir hata oluÅŸtu: {str(e)}")

def show_scorecard():
    """GeliÅŸtirilmiÅŸ karne gÃ¶rÃ¼nÃ¼mÃ¼: Split view + hesaplama kanÄ±tÄ± + AI analizi"""
    if sonuc_global is None or not karne_combobox.get():
        messagebox.showwarning("UyarÄ±", "LÃ¼tfen analiz yapÄ±n ve bir tedarikÃ§i seÃ§in.")
        return
    supplier_name = karne_combobox.get()
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    
    # Detay verileri al (Stok Grubu bazlÄ±)
    detay_rows = pd.DataFrame()
    if detay_sonuc_global is not None:
        detay_rows = detay_sonuc_global[detay_sonuc_global[tedarikci_col_global] == supplier_name]

    for w in frame_karne_content.winfo_children(): w.destroy()
    grade, color, description = calculate_grade(row["Skor"])
    
    # 1. ÃœST BÃ–LÃœM: Firma ve Pareto
    top_frame = tk.Frame(frame_karne_content, bg="white")
    top_frame.pack(fill="x", pady=20, padx=20)
    
    tk.Label(top_frame, text=supplier_name, font=("Segoe UI", 24, "bold"), bg="white", fg="#2c3e50").pack()
    
    # Pareto GÃ¶sterimi
    pareto_class = row.get("Pareto_Sinifi", "-")
    pareto_color = "#e67e22" if pareto_class == "A" else "#f1c40f" if pareto_class == "B" else "#95a5a6"
    pareto_desc = "(YÃ¼ksek Ciro)" if pareto_class == "A" else "(Orta Ciro)" if pareto_class == "B" else "(DÃ¼ÅŸÃ¼k Ciro)"
    
    pareto_frame = tk.Frame(top_frame, bg="white", pady=10)
    pareto_frame.pack()
    tk.Label(pareto_frame, text=f"PARETO SINIFI (CÄ°RO):", font=("Segoe UI", 10, "bold"), bg="white", fg="gray").pack(side="left")
    tk.Label(pareto_frame, text=f" {pareto_class} {pareto_desc}", font=("Segoe UI", 16, "bold"), bg="white", fg=pareto_color).pack(side="left")
    tk.Label(pareto_frame, text=f" | Toplam Ciro: {row['ToplamTutar']:,.2f} TL", font=("Segoe UI", 12, "bold"), bg="white", fg="#2c3e50").pack(side="left", padx=10)

    # 2. ORTA BÃ–LÃœM: Performans Notu
    grade_frame = tk.Frame(top_frame, bg=color, padx=20, pady=15, bd=2, relief="groove")
    grade_frame.pack(pady=15, fill="x", padx=100)
    
    tk.Label(grade_frame, text="PERFORMANS NOTU", font=("Segoe UI", 10, "bold"), bg=color, fg="white").pack()
    tk.Label(grade_frame, text=f"{grade}", font=("Arial", 64, "bold"), bg=color, fg="white").pack()
    tk.Label(grade_frame, text=description, font=("Segoe UI", 14, "bold"), bg=color, fg="white").pack()
    tk.Label(grade_frame, text=f"Genel Skor: {row['Skor']:.2f} / 100", font=("Segoe UI", 12), bg=color, fg="white").pack(pady=5)
    
    # Mail Butonu
    mail_col = find_col_by_keywords(sonuc_global, ["mail", "eposta", "email"])
    if mail_col and pd.notna(row.get(mail_col)):
        ttk.Button(top_frame, text="ğŸ“§ KiÅŸiye Ã–zel AI Mail GÃ¶nder", command=send_scorecard_email_action).pack(pady=10)

    # 3. ALT BÃ–LÃœM: Stok Grubu DetaylÄ± Analiz (SPLIT VIEW)
    split_frame = tk.Frame(frame_karne_content, bg="white")
    split_frame.pack(fill="both", expand=True, padx=20, pady=10)
    
    # Sol: TedarikÃ§i GerÃ§ekleÅŸenler
    left_sub = tk.LabelFrame(split_frame, text="Sizin Verileriniz (GerÃ§ekleÅŸen)", font=("Segoe UI", 10, "bold"), bg="white", fg="#2980b9", padx=5, pady=5)
    left_sub.pack(side="left", fill="both", expand=True, padx=(0, 5))
    
    cols_l = ("Stok Grubu", "Fiyat (TL)", "Termin (GÃ¼n)", "Ä°ade (Adet)")
    tree_l = ttk.Treeview(left_sub, columns=cols_l, show="headings", height=6)
    for col in cols_l: 
        tree_l.heading(col, text=col)
        tree_l.column(col, width=80, anchor="center")
    tree_l.column("Stok Grubu", width=120, anchor="w")
    tree_l.pack(fill="both", expand=True)

    # SaÄŸ: Pazar OrtalamalarÄ± ve Puan
    right_sub = tk.LabelFrame(split_frame, text="SektÃ¶r KÄ±yaslamasÄ± & Puanlama", font=("Segoe UI", 10, "bold"), bg="white", fg="#27ae60", padx=5, pady=5)
    right_sub.pack(side="right", fill="both", expand=True, padx=(5, 0))
    
    cols_r = ("Stok Grubu", "SektÃ¶r Fiyat", "SektÃ¶r Termin", "SektÃ¶r Ä°ade", "Puan")
    tree_r = ttk.Treeview(right_sub, columns=cols_r, show="headings", height=6)
    for col in cols_r: 
        tree_r.heading(col, text=col)
        tree_r.column(col, width=70, anchor="center")
    tree_r.column("Stok Grubu", width=120, anchor="w")
    tree_r.pack(fill="both", expand=True)

    if not detay_rows.empty and stok_grup_col_global:
        fiyat_col = find_col_by_keywords(detay_rows, ['fiyat','price'])
        teslim_col = find_col_by_keywords(detay_rows, ['teslim','delivery'])
        iade_col = find_col_by_keywords(detay_rows, ['iade','return'])
        
        for idx, r in detay_rows.iterrows():
            sg = r[stok_grup_col_global]
            # Sol Taraf
            tree_l.insert("", "end", values=(sg, f"{r[fiyat_col]:.2f}", f"{r[teslim_col]:.1f}", f"{r[iade_col]:.1f}"))
            
            # SaÄŸ Taraf (Pazar OrtalamasÄ± Bul)
            market_p = "-"
            market_t = "-"
            market_i = "-"
            if market_averages_global is not None and sg in market_averages_global.index:
                m_row = market_averages_global.loc[sg]
                market_p = f"{m_row[fiyat_col]:.2f}"
                market_t = f"{m_row[teslim_col]:.1f}"
                market_i = f"{m_row[iade_col]:.1f}"
            
            tree_r.insert("", "end", values=(sg, market_p, market_t, market_i, f"{r['Skor']:.1f}"))
    else:
        tk.Label(left_sub, text="Stok Grubu detayÄ± bulunamadÄ±.", bg="white").pack()
        tk.Label(right_sub, text="KÄ±yaslama yapÄ±lamadÄ±.", bg="white").pack()

    # 3.5 MATEMATÄ°KSEL HESAPLAMA TABLOSU
    calc_frame = tk.LabelFrame(frame_karne_content, text=f"Matematiksel Hesaplama (Fiyat: %{int(price_weight.get()*100)} + Termin: %{int(delivery_weight.get()*100)} + Ä°ade: %{int(return_weight.get()*100)})", font=("Segoe UI", 10, "bold"), bg="white", padx=10, pady=10)
    calc_frame.pack(fill="x", padx=20, pady=10)
    
    cols_calc = ("Stok Grubu", "Fiyat PuanÄ±", "Termin PuanÄ±", "Ä°ade PuanÄ±", "Toplam Puan (AÄŸÄ±rlÄ±klÄ±)")
    tree_calc = ttk.Treeview(calc_frame, columns=cols_calc, show="headings", height=4)
    for col in cols_calc:
        tree_calc.heading(col, text=col)
        tree_calc.column(col, anchor="center")
    
    if not detay_rows.empty and stok_grup_col_global:
        for idx, r in detay_rows.iterrows():
            tree_calc.insert("", "end", values=(
                r[stok_grup_col_global],
                f"{r.get('Score_Price', 0):.1f}",
                f"{r.get('Score_Deliv', 0):.1f}",
                f"{r.get('Score_Return', 0):.1f}",
                f"{r['Skor']:.1f}"
            ))
    tree_calc.pack(fill="x")

    # 3.7 HESAPLAMA KANITI VE MANTIÄI (DETAYLI AÃ‡IKLAMA)
    logic_frame = tk.LabelFrame(frame_karne_content, text="Hesaplama KanÄ±tÄ± ve MantÄ±ÄŸÄ± (ÅeffaflÄ±k Raporu)", font=("Segoe UI", 10, "bold"), bg="#fff3e0", padx=10, pady=10)
    logic_frame.pack(fill="x", padx=20, pady=10)
    
    logic_text = ""
    if not detay_rows.empty and stok_grup_col_global:
        r = detay_rows.iloc[0]  # Ä°lk satÄ±rÄ± Ã¶rnek olarak al
        fiyat_col = find_col_by_keywords(detay_rows, ['fiyat','price'])
        teslim_col = find_col_by_keywords(detay_rows, ['teslim','delivery'])
        iade_col = find_col_by_keywords(detay_rows, ['iade','return'])
        
        logic_text += f"Ã–RNEK ANALÄ°Z ({r[stok_grup_col_global]} Grubu Ä°Ã§in):\n"
        logic_text += f"--------------------------------------------------\n"
        logic_text += f"1. FÄ°YAT PUANI ({r.get('Score_Price', 0):.1f}): Hibrit skorlama (%50 min-max + %50 ranking).\n"
        logic_text += f"   Sizin fiyat: {r[fiyat_col]:.2f} TL. Grup iÃ§i min: {r.get('Min_Price', 0):.2f}, max: {r.get('Max_Price', 0):.2f}\n\n"
        
        logic_text += f"2. TERMÄ°N PUANI ({r.get('Score_Deliv', 0):.1f}): Teslimat sÃ¼renizin grup iÃ§i konumu.\n"
        logic_text += f"   Sizin termin: {r[teslim_col]:.1f} gÃ¼n. Grup iÃ§i min: {r.get('Min_Deliv', 0):.1f}, max: {r.get('Max_Deliv', 0):.1f}\n\n"
        
        logic_text += f"3. Ä°ADE PUANI ({r.get('Score_Return', 0):.1f}): Ä°ade performansÄ±nÄ±zÄ±n grup iÃ§i deÄŸerlendirmesi.\n"
        logic_text += f"   Sizin iade: {r[iade_col]:.1f} adet\n"
    else:
        logic_text = "Stok grubu detayÄ± mevcut deÄŸil. Genel deÄŸerlendirme yapÄ±ldÄ±."

    tk.Label(logic_frame, text=logic_text, justify="left", font=("Consolas", 9), bg="#fff3e0").pack(anchor="w")

    # Not SkalasÄ± ReferansÄ±
    scale_frame = tk.Frame(frame_karne_content, bg="white", pady=10)
    scale_frame.pack(fill="x", padx=40)
    scale_text = "NOT SKALASI:  A+ (90-100)  |  A (85-89)  |  B (75-84)  |  C (60-74)  |  D (50-59)  |  F (<50)"
    tk.Label(scale_frame, text=scale_text, font=("Consolas", 10), bg="#f0f0f0", fg="#555").pack()

    # 4. EN ALT: Yapay Zeka Yorumu
    ai_frame = tk.LabelFrame(frame_karne_content, text="ğŸ¤– DetaylÄ± Yapay Zeka Analizi", font=("Segoe UI", 12, "bold"), bg="white", fg="#8e44ad", padx=10, pady=10)
    ai_frame.pack(fill="x", padx=40, pady=10, side="bottom")
    
    ai_lbl = tk.Label(ai_frame, text="Analiz ediliyor...", font=("Segoe UI", 11), bg="white", justify="left", wraplength=800)
    ai_lbl.pack(fill="x", expand=True)
    
    def fetch_comment():
        comment = get_scorecard_ai_comment(row, grade, description)
        ai_lbl.configure(text=comment)
    threading.Thread(target=fetch_comment, daemon=True).start()

def export_scorecard_pdf():
    if not karne_combobox.get(): return
    supplier_name = karne_combobox.get()
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    grade, _, desc = calculate_grade(row["Skor"])
    
    pdf = FPDF()
    pdf.add_page()
    
    if os.path.exists('DejaVuSans.ttf'):
        pdf.add_font('DejaVu', '', 'DejaVuSans.ttf', uni=True)
        pdf.set_font('DejaVu', '', 14)
    else:
        pdf.set_font("Arial", size=12)
        
    pdf.cell(0, 10, f"TEDARÄ°KÃ‡Ä° KARNESÄ°: {supplier_name}", ln=True, align='C')
    pdf.ln(10)
    
    pdf.set_font_size(20)
    pdf.cell(0, 10, f"GENEL NOT: {grade}", ln=True, align='C')
    pdf.set_font_size(12)
    pdf.cell(0, 10, f"AÃ§Ä±klama: {desc}", ln=True, align='C')
    pdf.cell(0, 10, f"Performans Skoru: {row['Skor']:.2f}", ln=True, align='C')
    pdf.cell(0, 10, f"ABC Sinifi (Pareto): {row.get('Pareto_Sinifi', '-')}", ln=True, align='C')
    pdf.ln(20)
    
    col_width = 45
    pdf.cell(col_width, 10, "Kriter", 1)
    pdf.cell(col_width, 10, "DeÄŸer", 1)
    pdf.ln()
    
    metrics = {
        "Ortalama Fiyat": f"{row[find_col_by_keywords(sonuc_global, ['fiyat','price'])]:.2f}",
        "Teslim Suresi": f"{row[find_col_by_keywords(sonuc_global, ['teslim','delivery'])]:.2f}",
        "Iade Miktari": f"{row[find_col_by_keywords(sonuc_global, ['iade','return'])]:.2f}",
        "Toplam Hacim": f"{row.get('ToplamTutar', 0):,.2f}"
    }
    
    for k, v in metrics.items():
        pdf.cell(col_width, 10, k, 1)
        pdf.cell(col_width, 10, str(v), 1)
        pdf.ln()
        
    filename = filedialog.asksaveasfilename(defaultextension=".pdf", initialfile=f"Karne_{supplier_name}.pdf")
    if filename:
        pdf.output(filename)
        messagebox.showinfo("BaÅŸarÄ±lÄ±", "PDF kaydedildi.")

# ---------- TREND ANALÄ°ZÄ° VE AI ----------
def get_trend_ai_comment(trend_data_str):
    if not GEMINI_API_KEY: return "API AnahtarÄ± eksik."
    prompt = f"AylÄ±k satÄ±n alma verileri (Ay, Fiyat, Miktar):\n{trend_data_str}\nLÃ¼tfen miktar/fiyat iliÅŸkisini 2-3 cÃ¼mleyle TÃ¼rkÃ§e Ã¶zetle."
    try:
        data = {"contents": [{"parts":[{"text": prompt}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=30)
        return response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
    except: return "Yorum alÄ±namadÄ±."

def update_trend_tab(df, date_col, fiyat_col, miktar_col):
    global trend_fig_global
    for widget in frame_trend.winfo_children(): widget.destroy()
        
    if date_col not in df.columns or fiyat_col not in df.columns:
        tk.Label(frame_trend, text="Trend analizi iÃ§in 'Tarih' ve 'Fiyat' gereklidir.", font=("Arial", 12)).pack(pady=20); return

    df_trend = df.copy()
    df_trend[date_col] = pd.to_datetime(df_trend[date_col], errors='coerce')
    df_trend = df_trend.dropna(subset=[date_col])
    
    df_trend[fiyat_col] = pd.to_numeric(df_trend[fiyat_col].astype(str).str.replace(',', '.'), errors='coerce')
    if miktar_col and miktar_col in df_trend.columns:
        df_trend[miktar_col] = pd.to_numeric(df_trend[miktar_col].astype(str).str.replace(',', '.'), errors='coerce')
    else:
        df_trend['__count'] = 1; miktar_col = '__count'

    monthly_data = df_trend.groupby(pd.Grouper(key=date_col, freq='ME')).agg({fiyat_col: 'mean', miktar_col: 'sum'}).reset_index().sort_values(date_col)
    
    if monthly_data.empty: tk.Label(frame_trend, text="Veri bulunamadÄ±.", font=("Arial", 12)).pack(pady=20); return

    fig, ax1 = plt.subplots(figsize=(10, 5))
    ax1.set_xlabel('Tarih'); ax1.set_ylabel('Toplam Miktar', color='tab:blue', fontweight='bold')
    ax1.bar(monthly_data[date_col], monthly_data[miktar_col], color='tab:blue', alpha=0.6, width=20, label='Miktar')
    ax1.tick_params(axis='y', labelcolor='tab:blue')
    
    ax2 = ax1.twinx(); ax2.set_ylabel('Ortalama Fiyat', color='tab:red', fontweight='bold')
    line = ax2.plot(monthly_data[date_col], monthly_data[fiyat_col], color='tab:red', marker='o', linewidth=2, label='Fiyat')
    ax2.tick_params(axis='y', labelcolor='tab:red')

    plt.title("AylÄ±k AlÄ±m MiktarÄ± ve Fiyat Trendi", fontsize=14); fig.tight_layout(); trend_fig_global = fig

    canvas = FigureCanvasTkAgg(fig, master=frame_trend); canvas.draw(); canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
    NavigationToolbar2Tk(canvas, frame_trend).pack(fill=tk.X)

    comment_frame = tk.LabelFrame(frame_trend, text="Yapay Zeka Trend Analizi", font=("Arial", 10, "bold"), fg="#2c3e50"); comment_frame.pack(side=tk.BOTTOM, fill="x", padx=10, pady=10)
    loading_lbl = tk.Label(comment_frame, text="Yorum oluÅŸturuluyor...", font=("Arial", 9, "italic")); loading_lbl.pack(padx=10, pady=10, anchor="w")
    
    def fetch_comment():
        comment = get_trend_ai_comment(monthly_data.tail(12).to_string(index=False))
        if loading_lbl.winfo_exists(): loading_lbl.configure(text=comment, font=("Arial", 10), fg="#2c3e50", justify="left", wraplength=900)
    threading.Thread(target=fetch_comment, daemon=True).start()

# ---------- GELECEK TAHMÄ°NÄ° (FORECASTING) ----------
def update_forecast_tab(df, date_col, fiyat_col):
    global forecast_fig_global
    for widget in frame_tahmin.winfo_children(): widget.destroy()
    
    # BaÅŸlÄ±k ve kontrol paneli
    header_frame = tk.Frame(frame_tahmin, bg="#2c3e50", padx=20, pady=15)
    header_frame.pack(fill="x")
    tk.Label(header_frame, text="ğŸ“ˆ Gelecek Ay Fiyat Tahmini", font=("Segoe UI", 16, "bold"), fg="white", bg="#2c3e50").pack(anchor="w")
    tk.Label(header_frame, text="Lineer Regresyon ile Trend Analizi", font=("Segoe UI", 10), fg="#ecf0f1", bg="#2c3e50").pack(anchor="w")
    
    if date_col not in df.columns or fiyat_col not in df.columns:
        tk.Label(frame_tahmin, text="Tahmin iÃ§in 'Tarih' ve 'Fiyat' verisi gereklidir.", font=("Arial", 12)).pack(pady=20); return

    df_fc = df.copy()
    df_fc[date_col] = pd.to_datetime(df_fc[date_col], errors='coerce')
    df_fc = df_fc.dropna(subset=[date_col])
    df_fc[fiyat_col] = pd.to_numeric(df_fc[fiyat_col].astype(str).str.replace(',', '.'), errors='coerce')
    
    monthly_data = df_fc.groupby(pd.Grouper(key=date_col, freq='ME')).agg({fiyat_col: 'mean'}).reset_index().sort_values(date_col)
    monthly_data = monthly_data.dropna(subset=[fiyat_col])
    
    if monthly_data.empty or len(monthly_data) < 2:
        tk.Label(frame_tahmin, text="Tahmin yapabilmek iÃ§in en az 2 aylÄ±k veri gereklidir.", font=("Arial", 12)).pack(pady=20); return

    fig, ax1 = plt.subplots(1, 1, figsize=(12, 8))
    
    # SADECE LÄ°NEER REGRESYON KULLAN - Prophet kodu kaldÄ±rÄ±ldÄ±
    try:
        ax1.plot(monthly_data[date_col], monthly_data[fiyat_col], marker='o', linestyle='-', color='blue', label='GeÃ§miÅŸ Fiyatlar', linewidth=2, markersize=8)
        
        x_numeric = np.arange(len(monthly_data))
        y_price = monthly_data[fiyat_col].values
        
        # Veri istatistikleri
        price_mean = y_price.mean()
        price_std = y_price.std()
        price_min = y_price.min()
        price_max = y_price.max()
        last_price = y_price[-1]
        
        # Son 3 ayÄ±n ortalamasÄ± (daha stabil tahmin iÃ§in)
        recent_avg = y_price[-3:].mean() if len(y_price) >= 3 else last_price
        
        z = np.polyfit(x_numeric, y_price, 1)
        p = np.poly1d(z)
        slope = z[0]  # EÄŸim (trend)
        
        next_month_index = len(x_numeric)
        next_month_price_raw = p(next_month_index)
        
        # GELIÅTIRILMIÅ AÅIRI TAHMÄ°N Ã–NLEME - Daha Makul SonuÃ§lar
        next_month_price = next_month_price_raw
        
        # 1. MUTLAK KURAL: Negatif deÄŸerleri engelle
        if next_month_price < 0:
            next_month_price = max(recent_avg * 0.95, price_min * 0.95)
        
        # 2. AÅŸÄ±rÄ± deÄŸiÅŸimleri sÄ±nÄ±rla (Â±30% maksimum - daha makul)
        max_change_pct = 0.30  # %30 maksimum deÄŸiÅŸim (daha gerÃ§ekÃ§i)
        max_allowed_increase = last_price * (1 + max_change_pct)
        max_allowed_decrease = last_price * (1 - max_change_pct)
        
        if next_month_price > max_allowed_increase:
            # Ã‡ok yÃ¼ksek tahmin - son fiyata +%15 ekle
            next_month_price = last_price * 1.15
        elif next_month_price < max_allowed_decrease:
            # Ã‡ok dÃ¼ÅŸÃ¼k tahmin - son fiyata -%15 ekle
            next_month_price = max(last_price * 0.85, price_min * 0.95)
        
        # 3. Standart sapma kontrolÃ¼ (Â±1.5 standart sapma - daha sÄ±kÄ±)
        upper_bound = price_mean + (1.5 * price_std)
        lower_bound = max(price_min * 0.95, price_mean - (1.5 * price_std))
        
        if next_month_price > upper_bound:
            next_month_price = min(upper_bound, last_price * 1.10)
        elif next_month_price < lower_bound:
            next_month_price = max(lower_bound, last_price * 0.90, price_min * 0.95)
        
        # 4. ZayÄ±f trend kontrolÃ¼ - daha saÄŸlam mantÄ±k
        if abs(slope) < price_std * 0.15:
            # Trend Ã§ok zayÄ±f, son deÄŸere yakÄ±n kal
            next_month_price = last_price * (1 + (slope / last_price if last_price > 0 else 0) * 0.5)
        
        # 5. Veri aralÄ±ÄŸÄ± sÄ±nÄ±rlamasÄ± (daha sÄ±kÄ±)
        data_range = price_max - price_min
        if next_month_price > price_max + (data_range * 0.2):
            next_month_price = price_max + (data_range * 0.10)
        elif next_month_price < price_min - (data_range * 0.2):
            next_month_price = max(price_min * 0.95, price_min - (data_range * 0.10))
        
        # 6. SON KONTROL: Minimum 1 TL ve mevcut fiyatÄ±n %50'sinden az olmasÄ±n
        next_month_price = max(1.0, last_price * 0.50, next_month_price)
        
        # 7. Veri setindeki minimum deÄŸerin %90'Ä±ndan az olmasÄ±n
        next_month_price = max(price_min * 0.90, next_month_price)
        
        last_date = monthly_data[date_col].iloc[-1]
        next_date = last_date + pd.DateOffset(months=1)
        
        # Tahmin Ã§izgisi ve nokta
        ax1.plot([last_date, next_date], [y_price[-1], next_month_price], 'r--', marker='x', markersize=15, linewidth=3, label='Gelecek Ay Tahmini')
        ax1.plot(monthly_data[date_col], p(x_numeric), "g:", alpha=0.5, linewidth=2, label="Trend Ã‡izgisi")
        
        # GeÃ§miÅŸ verilere deÄŸer etiketleri ekle (son 6 ay)
        recent_indices = list(range(max(0, len(monthly_data)-6), len(monthly_data)))
        for i in recent_indices:
            ax1.annotate(f'{y_price[i]:.1f}', 
                       xy=(monthly_data[date_col].iloc[i], y_price[i]),
                       xytext=(0, 8), textcoords='offset points',
                       ha='center', fontsize=9, color='black',
                       bbox=dict(boxstyle='round,pad=0.3', facecolor='white', alpha=0.8, edgecolor='gray'))
        
        # Gelecek tahminine BÃœYÃœK deÄŸer etiketi ekle
        ax1.annotate(f'{next_month_price:.1f} TL', 
                   xy=(next_date, next_month_price),
                   xytext=(0, 15), textcoords='offset points',
                   ha='center', fontsize=12, fontweight='bold', color='red',
                   bbox=dict(boxstyle='round,pad=0.5', facecolor='yellow', alpha=0.9, edgecolor='red', linewidth=2))
        
        ax1.set_title("Lineer Regresyon ile Fiyat Tahmini", fontsize=16, fontweight='bold')
        ax1.set_xlabel("Tarih", fontsize=12)
        ax1.set_ylabel("Fiyat (TL)", fontsize=12)
        ax1.legend(loc='best', fontsize=11)
        ax1.grid(True, alpha=0.3)
        
        change = next_month_price - y_price[-1]
        change_pct = (change / y_price[-1] * 100) if y_price[-1] > 0 else 0
        trend = "ARTIÅ â†—" if change > 0 else "DÃœÅÃœÅ â†˜" if change < 0 else "STABIL â†’"
        trend_color = "green" if change > 0 else "red" if change < 0 else "gray"
        
        # GÃ¼ven seviyesi hesapla
        if abs(change_pct) < 10:
            confidence = "YÃ¼ksek âœ“"
        elif abs(change_pct) < 20:
            confidence = "Orta"
        else:
            confidence = "DÃ¼ÅŸÃ¼k"
        
        info_text = f"""ğŸ“Š TAHMÄ°N SONUÃ‡LARI (Lineer Regresyon):
        
ğŸ“… Gelecek Ay: {next_date.strftime('%B %Y')}
ğŸ’° Tahmini Fiyat: {next_month_price:.2f} TL
ğŸ“Š Mevcut Fiyat: {y_price[-1]:.2f} TL
ğŸ“ˆ Beklenen DeÄŸiÅŸim: {change:+.2f} TL ({change_pct:+.1f}% {trend})
ğŸ“‰ Son 3 Ay OrtalamasÄ±: {recent_avg:.2f} TL
ğŸ¯ GÃ¼ven Seviyesi: {confidence}

âœ… MAKUL FÄ°YAT KONTROLLERI:
â€¢ Maksimum deÄŸiÅŸim: Â±30%
â€¢ Standart sapma kontrolÃ¼ (Â±1.5Ïƒ)
â€¢ Minimum fiyat garantisi
â€¢ Negatif deÄŸer korumasÄ±
â€¢ Veri aralÄ±ÄŸÄ± sÄ±nÄ±rlamasÄ±"""
        
    except Exception as e:
        info_text = f"Tahmin hatasÄ±: {e}"
        next_month_price = 0
        change = 0
        change_pct = 0
        trend = "Hata"
        trend_color = "black"
    
    plt.tight_layout()
    
    canvas = FigureCanvasTkAgg(fig, frame_tahmin)
    canvas.draw()
    canvas.get_tk_widget().pack(fill='both', expand=True, padx=10, pady=10)
    
    # Bilgi kartÄ±
    info_frame = tk.Frame(frame_tahmin, bg="white", bd=2, relief="solid")
    info_frame.pack(fill="x", padx=20, pady=10)
    tk.Label(info_frame, text=info_text, font=("Courier New", 10), bg="white", fg="#2c3e50", justify="left", padx=15, pady=15).pack(anchor="w")
    
    # HAREKET EDEN EKRAN - DeÄŸiÅŸim gÃ¶stergesi (animasyonlu)
    if next_month_price > 0:
        movement_frame = tk.Frame(frame_tahmin, bg="#ecf0f1", bd=3, relief="raised")
        movement_frame.pack(fill="x", padx=20, pady=15)
        
        # DeÄŸiÅŸim baÅŸlÄ±ÄŸÄ±
        change_header = tk.Label(movement_frame, text="ğŸ’¹ FÄ°YAT DEÄÄ°ÅÄ°MÄ° TAHMÄ°NÄ°", 
                                font=("Segoe UI", 14, "bold"), bg="#ecf0f1", fg="#2c3e50")
        change_header.pack(pady=(10, 5))
        
        # BÃ¼yÃ¼k deÄŸiÅŸim gÃ¶stergesi
        change_display = tk.Label(movement_frame, 
                                 text=f"{change:+.2f} TL\n({change_pct:+.1f}%)",
                                 font=("Arial", 32, "bold"), 
                                 bg="#ecf0f1", 
                                 fg=trend_color)
        change_display.pack(pady=10)
        
        # Trend oku ve aÃ§Ä±klama
        trend_label = tk.Label(movement_frame, text=f"Trend: {trend}", 
                              font=("Segoe UI", 16, "bold"), bg="#ecf0f1", fg=trend_color)
        trend_label.pack(pady=5)
        
        # Basit animasyon efekti fonksiyonu
        def animate_change():
            colors = [trend_color, "#f0f0f0", trend_color]
            current_color = [0]
            
            def update_color():
                change_display.config(fg=colors[current_color[0] % len(colors)])
                current_color[0] += 1
                if current_color[0] < 6:  # 6 kere yanÄ±p sÃ¶n
                    root.after(500, update_color)
                else:
                    change_display.config(fg=trend_color)
            
            update_color()
        
        # Animasyonu baÅŸlat
        root.after(100, animate_change)
    
    forecast_fig_global = fig

# ---------- AKILLI SÄ°PARÄ°Å SÄ°HÄ°RBAZI ----------
def init_smart_order_tab():
    global order_treeview, order_ai_text, siparis_stok_combobox, siparis_grup_combobox, siparis_search_type_var
    
    for widget in frame_siparis.winfo_children(): widget.destroy()
    
    main_layout = tk.PanedWindow(frame_siparis, orient=tk.HORIZONTAL)
    main_layout.pack(fill="both", expand=True, padx=10, pady=10)
    
    left_panel = tk.Frame(main_layout)
    main_layout.add(left_panel, width=700)
    
    tk.Label(left_panel, text="ğŸ›’ AI Destekli SipariÅŸ Planlama", font=("Segoe UI", 16, "bold"), fg="#2c3e50").pack(anchor="w", pady=(0, 10))
    
    input_frame = tk.LabelFrame(left_panel, text="SipariÅŸ Parametreleri", font=("Segoe UI", 10, "bold"), fg="#2980b9", padx=10, pady=10)
    input_frame.pack(fill="x", pady=5)
    
    # Arama tipi seÃ§imi (Stok Kodu veya Stok Grubu)
    siparis_search_type_var = tk.StringVar(value="code")
    
    def toggle_search_fields():
        """Arama tipine gÃ¶re ilgili combobox'Ä± gÃ¶ster/gizle"""
        search_type = siparis_search_type_var.get()
        if search_type == "code":
            siparis_stok_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="w")
            siparis_grup_combobox.grid_forget()
        else:
            siparis_grup_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="w")
            siparis_stok_combobox.grid_forget()
    
    tk.Label(input_frame, text="Arama Tipi:", font=("Segoe UI", 10)).grid(row=0, column=0, padx=5, pady=5, sticky="e")
    radio_frame = tk.Frame(input_frame)
    radio_frame.grid(row=0, column=1, padx=5, pady=5, sticky="w", columnspan=2)
    ttk.Radiobutton(radio_frame, text="Stok Kodu", variable=siparis_search_type_var, value="code", command=toggle_search_fields).pack(side="left", padx=5)
    ttk.Radiobutton(radio_frame, text="Stok Grubu", variable=siparis_search_type_var, value="group", command=toggle_search_fields).pack(side="left", padx=5)
    
    tk.Label(input_frame, text="SeÃ§im:", font=("Segoe UI", 10)).grid(row=1, column=0, padx=5, pady=5, sticky="e")
    
    # Stok Kodu combobox
    siparis_stok_combobox = ttk.Combobox(input_frame, state="normal", width=30)
    siparis_stok_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="w")
    if all_stock_codes:
        siparis_stok_combobox['values'] = all_stock_codes
    
    # Stok Grubu combobox (initially hidden)
    siparis_grup_combobox = ttk.Combobox(input_frame, state="normal", width=30)
    if all_stock_groups:
        siparis_grup_combobox['values'] = all_stock_groups
    # Grid initially but then hide since default is "code" mode
    siparis_grup_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="w")
    siparis_grup_combobox.grid_forget()
    
    tk.Label(input_frame, text="Ä°htiyaÃ§ Duyulan Miktar (Adet):", font=("Segoe UI", 10)).grid(row=2, column=0, padx=5, pady=5, sticky="e")
    qty_entry = ttk.Entry(input_frame, width=15)
    qty_entry.grid(row=2, column=1, padx=5, pady=5, sticky="w")
    
    calc_btn = ttk.Button(input_frame, text="âš¡ Optimum DaÄŸÄ±tÄ±mÄ± Hesapla", command=lambda: run_order_allocation(qty_entry))
    calc_btn.grid(row=2, column=2, padx=15, pady=5, sticky="e")
    
    # DÃ¶viz SimÃ¼lasyonu Butonu
    currency_btn = tk.Button(input_frame, text="ğŸ’± DÃ¶viz SimÃ¼lasyonu", bg="#e74c3c", fg="white", font=("Segoe UI", 9, "bold"), command=show_currency_simulation)
    currency_btn.grid(row=2, column=3, padx=5, pady=5, sticky="e")
    
    tree_frame = tk.LabelFrame(left_panel, text="Ã–nerilen SipariÅŸ DaÄŸÄ±lÄ±mÄ±", font=("Segoe UI", 10, "bold"), fg="#27ae60")
    tree_frame.pack(fill="both", expand=True, pady=10)
    
    cols = ("TedarikÃ§i", "Skor", "Not", "Fiyat (TL)", "Tahsis Edilen Miktar", "Toplam Maliyet")
    order_treeview = ttk.Treeview(tree_frame, columns=cols, show="headings")
    
    for col in cols:
        order_treeview.heading(col, text=col)
        order_treeview.column(col, width=100, anchor="center")
    
    order_treeview.column("TedarikÃ§i", width=200, anchor="w")
    order_treeview.pack(side="left", fill="both", expand=True, padx=5, pady=5)
    
    sc = tk.Scrollbar(tree_frame, orient="vertical", command=order_treeview.yview)
    sc.pack(side="right", fill="y")
    order_treeview.configure(yscrollcommand=sc.set)
    
    right_panel = tk.Frame(main_layout, bg="white", bd=1, relief="solid")
    main_layout.add(right_panel)
    
    tk.Label(right_panel, text="ğŸ§  CPO Raporu & GerekÃ§e", font=("Segoe UI", 12, "bold"), bg="white", fg="#8e44ad").pack(pady=10)
    
    order_ai_text = tk.Text(right_panel, wrap="word", font=("Segoe UI", 10), bg="#f9f9f9", padx=10, pady=10, height=25)
    order_ai_text.pack(fill="both", expand=True, padx=10, pady=(0, 10))
    order_ai_text.insert("1.0", "LÃ¼tfen bir Ã¼rÃ¼n ve miktar seÃ§ip hesaplama baÅŸlatÄ±n.\n\nYapay Zeka, daÄŸÄ±tÄ±m mantÄ±ÄŸÄ±nÄ± burada aÃ§Ä±klayacaktÄ±r.")
    order_ai_text.configure(state="disabled")
    
    btn_frame = tk.Frame(right_panel, bg="white")
    btn_frame.pack(fill="x", pady=10, padx=10)
    
    ttk.Button(btn_frame, text="âœ‰ï¸ Taslak SipariÅŸ Maillerini OluÅŸtur", command=generate_order_drafts).pack(fill="x", pady=5)

def show_currency_simulation():
    """DÃ¶viz kuru deÄŸiÅŸimi simÃ¼lasyonu (What-If analizi)"""
    if df_global is None or sonuc_global is None:
        messagebox.showwarning("UyarÄ±", "LÃ¼tfen Ã¶nce verileri analiz edin!")
        return
    
    # SimÃ¼lasyon penceresi
    sim_window = tk.Toplevel(root)
    sim_window.title("ğŸ’± DÃ¶viz SimÃ¼lasyonu - What-If Analizi")
    sim_window.geometry("900x700")
    sim_window.configure(bg="#ecf0f1")
    
    # BaÅŸlÄ±k
    header = tk.Frame(sim_window, bg="#34495e", padx=20, pady=15)
    header.pack(fill="x")
    tk.Label(header, text="ğŸ’± DÃ¶viz Kuru SimÃ¼lasyonu", font=("Segoe UI", 16, "bold"), fg="white", bg="#34495e").pack()
    tk.Label(header, text="DÃ¶viz kurundaki deÄŸiÅŸimin maliyetlere etkisini analiz edin", font=("Segoe UI", 10), fg="#ecf0f1", bg="#34495e").pack()
    
    # Ä°Ã§erik
    content = tk.Frame(sim_window, bg="#ecf0f1", padx=20, pady=20)
    content.pack(fill="both", expand=True)
    
    # Senaryo giriÅŸi
    scenario_frame = tk.LabelFrame(content, text="Senaryo Parametreleri", font=("Segoe UI", 11, "bold"), bg="white", padx=15, pady=15)
    scenario_frame.pack(fill="x", pady=10)
    
    tk.Label(scenario_frame, text="USD DeÄŸiÅŸim OranÄ± (%):", bg="white", font=("Segoe UI", 10)).grid(row=0, column=0, sticky="w", pady=5, padx=5)
    usd_entry = ttk.Entry(scenario_frame, width=15)
    usd_entry.insert(0, "10")
    usd_entry.grid(row=0, column=1, pady=5, padx=5)
    
    tk.Label(scenario_frame, text="EUR DeÄŸiÅŸim OranÄ± (%):", bg="white", font=("Segoe UI", 10)).grid(row=1, column=0, sticky="w", pady=5, padx=5)
    eur_entry = ttk.Entry(scenario_frame, width=15)
    eur_entry.insert(0, "10")
    eur_entry.grid(row=1, column=1, pady=5, padx=5)
    
    tk.Label(scenario_frame, text="(Pozitif deÄŸer artÄ±ÅŸ, negatif deÄŸer dÃ¼ÅŸÃ¼ÅŸ)", bg="white", font=("Segoe UI", 8, "italic"), fg="gray").grid(row=2, column=0, columnspan=2, sticky="w", pady=2, padx=5)
    
    # SonuÃ§ alanÄ±
    result_text = tk.Text(content, wrap="word", font=("Courier New", 10), height=20, bg="#f9f9f9")
    result_text.pack(fill="both", expand=True, pady=10)
    result_text.insert("1.0", "Hesaplama yapmak iÃ§in 'SimÃ¼lasyonu Ã‡alÄ±ÅŸtÄ±r' butonuna tÄ±klayÄ±n...")
    
    def run_simulation():
        try:
            usd_change = float(usd_entry.get())
            eur_change = float(eur_entry.get())
            
            result_text.configure(state="normal")
            result_text.delete("1.0", "end")
            
            # Mevcut maliyet hesapla (basitleÅŸtirilmiÅŸ)
            fiyat_col = find_col_by_keywords(df_global, ["fiyat", "price"])
            if not fiyat_col:
                result_text.insert("1.0", "âš ï¸ Fiyat kolonu bulunamadÄ±!")
                return
            
            df_calc = df_global.copy()
            df_calc[fiyat_col] = pd.to_numeric(df_calc[fiyat_col].astype(str).str.replace(',', '.'), errors='coerce')
            
            miktar_col = find_col_by_keywords(df_global, ["miktar", "adet", "quantity"])
            if miktar_col:
                df_calc[miktar_col] = pd.to_numeric(df_calc[miktar_col], errors='coerce')
                current_total = (df_calc[fiyat_col] * df_calc[miktar_col]).sum()
            else:
                current_total = df_calc[fiyat_col].sum()
            
            # DÃ¶viz etkisi varsayÄ±mlarÄ±
            # Basit model: Maliyetin %40'Ä± USD, %30'u EUR, %30'u TL cinsinden
            usd_portion = 0.40
            eur_portion = 0.30
            tl_portion = 0.30
            
            usd_impact = current_total * usd_portion * (usd_change / 100)
            eur_impact = current_total * eur_portion * (eur_change / 100)
            total_impact = usd_impact + eur_impact
            
            new_total = current_total + total_impact
            impact_pct = (total_impact / current_total) * 100
            
            # TedarikÃ§i bazÄ±nda etki (Stok Grubu ile birlikte)
            supplier_col = tedarikci_col_global
            stok_grup_col = stok_grup_col_global
            
            supplier_impact = []
            supplier_by_stock_group = {}
            
            if supplier_col:
                # Stok Grubu varsa, Ã¶nce stok grubu bazÄ±nda grupla
                if stok_grup_col and stok_grup_col in df_calc.columns:
                    # Stok grubu + tedarikÃ§i kombinasyonlarÄ±
                    for idx, row in df_calc.iterrows():
                        supplier = row[supplier_col]
                        stock_group = row.get(stok_grup_col, "Bilinmiyor")
                        
                        if pd.isna(stock_group) or stock_group == "":
                            stock_group = "Bilinmiyor"
                        
                        # Hesaplama
                        if miktar_col:
                            row_total = row[fiyat_col] * row.get(miktar_col, 1)
                        else:
                            row_total = row[fiyat_col]
                        
                        key = (stock_group, supplier)
                        if key not in supplier_by_stock_group:
                            supplier_by_stock_group[key] = 0
                        supplier_by_stock_group[key] += row_total
                    
                    # Etki hesapla
                    for (stock_group, supplier), sup_total in supplier_by_stock_group.items():
                        sup_usd_impact = sup_total * usd_portion * (usd_change / 100)
                        sup_eur_impact = sup_total * eur_portion * (eur_change / 100)
                        sup_new_total = sup_total + sup_usd_impact + sup_eur_impact
                        
                        supplier_impact.append({
                            'stock_group': stock_group,
                            'supplier': supplier,
                            'current': sup_total,
                            'new': sup_new_total,
                            'change': sup_new_total - sup_total
                        })
                else:
                    # Stok grubu yoksa sadece tedarikÃ§i bazÄ±nda
                    for supplier in df_calc[supplier_col].unique():
                        supplier_data = df_calc[df_calc[supplier_col] == supplier]
                        if miktar_col:
                            sup_total = (supplier_data[fiyat_col] * supplier_data[miktar_col]).sum()
                        else:
                            sup_total = supplier_data[fiyat_col].sum()
                        
                        sup_usd_impact = sup_total * usd_portion * (usd_change / 100)
                        sup_eur_impact = sup_total * eur_portion * (eur_change / 100)
                        sup_new_total = sup_total + sup_usd_impact + sup_eur_impact
                        
                        supplier_impact.append({
                            'stock_group': None,
                            'supplier': supplier,
                            'current': sup_total,
                            'new': sup_new_total,
                            'change': sup_new_total - sup_total
                        })
            
            # Rapor oluÅŸtur
            report = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           DÃ–VÄ°Z KURU DEÄÄ°ÅÄ°MÄ° SÄ°MÃœLASYONU                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š SENARYO PARAMETRELERÄ°:
   â€¢ USD DeÄŸiÅŸimi: {usd_change:+.1f}%
   â€¢ EUR DeÄŸiÅŸimi: {eur_change:+.1f}%

ğŸ’° MALÄ°YET ANALÄ°ZÄ°:
   
   Mevcut Toplam Maliyet:    â‚º{current_total:,.2f}
   
   USD Etkisi ({usd_portion:.0%}):    {usd_impact:+,.2f} TL
   EUR Etkisi ({eur_portion:.0%}):    {eur_impact:+,.2f} TL
   TL KÄ±smÄ± ({tl_portion:.0%}):      DeÄŸiÅŸmez
   
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Yeni Toplam Maliyet:      â‚º{new_total:,.2f}
   Toplam DeÄŸiÅŸim:           {total_impact:+,.2f} TL ({impact_pct:+.2f}%)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

"""
            
            if supplier_impact:
                # Stok grubu varsa, gruplanmÄ±ÅŸ ÅŸekilde gÃ¶ster
                if stok_grup_col and any(item['stock_group'] is not None for item in supplier_impact):
                    report += "\nğŸ“‹ STOK GRUBU VE TEDARÄ°KÃ‡Ä° BAZINDA ETKÄ°:\n\n"
                    
                    # Stok gruplarÄ±na gÃ¶re sÄ±rala
                    supplier_impact_sorted = sorted(supplier_impact, key=lambda x: (x['stock_group'], -abs(x['change'])))
                    
                    current_group = None
                    for item in supplier_impact_sorted:
                        # Yeni stok grubu baÅŸlÄ±ÄŸÄ±
                        if item['stock_group'] != current_group:
                            current_group = item['stock_group']
                            report += f"\nğŸ”¹ {current_group}\n"
                            report += "â”€" * 85 + "\n"
                            report += f"{'  TedarikÃ§i':<30} {'Mevcut':<18} {'Yeni':<18} {'DeÄŸiÅŸim':<18}\n"
                            report += "â”€" * 85 + "\n"
                        
                        # TedarikÃ§i detayÄ±
                        report += f"  {item['supplier']:<28} â‚º{item['current']:>14,.0f} â‚º{item['new']:>14,.0f} {item['change']:>+15,.0f}\n"
                    
                    # Genel toplam tÃ¼m tedarikÃ§iler
                    report += "\n" + "â•" * 85 + "\n"
                    report += f"\nğŸ“Š GENEL Ã–ZET:\n"
                    report += f"   â€¢ Toplam TedarikÃ§i SayÄ±sÄ±: {len(supplier_impact)}\n"
                    report += f"   â€¢ Toplam Stok Grubu SayÄ±sÄ±: {len(set(item['stock_group'] for item in supplier_impact))}\n"
                    
                else:
                    # Stok grubu yoksa klasik gÃ¶sterim (tÃ¼m tedarikÃ§iler)
                    report += "\nğŸ“‹ TEDARÄ°KÃ‡Ä° BAZINDA ETKÄ° (TÃ¼m TedarikÃ§iler):\n\n"
                    report += f"{'TedarikÃ§i':<30} {'Mevcut':<18} {'Yeni':<18} {'DeÄŸiÅŸim':<18}\n"
                    report += "â”€" * 85 + "\n"
                    
                    for item in sorted(supplier_impact, key=lambda x: abs(x['change']), reverse=True):
                        report += f"{item['supplier']:<30} â‚º{item['current']:>14,.0f} â‚º{item['new']:>14,.0f} {item['change']:>+15,.0f}\n"
                    
                    report += "\n" + "â”€" * 85 + "\n"
                    report += f"Toplam TedarikÃ§i: {len(supplier_impact)}\n"
            
            report += f"""

ğŸ’¡ STRATEJÄ°K Ã–NERÄ°LER:

"""
            if impact_pct > 5:
                report += f"âš ï¸  YÃœKSEK ETKÄ°: %{abs(impact_pct):.1f} oranÄ±nda maliyet {'artÄ±ÅŸÄ±' if impact_pct > 0 else 'azalÄ±ÅŸÄ±'} bekleniyor!\n"
                if impact_pct > 0:
                    report += "   â€¢ Hedging stratejileri deÄŸerlendirilmeli\n"
                    report += "   â€¢ Alternatif tedarikÃ§iler araÅŸtÄ±rÄ±lmalÄ±\n"
                    report += "   â€¢ Fiyat revizyon planlarÄ± hazÄ±rlanmalÄ±\n"
            elif impact_pct > 2:
                report += f"âš¡ ORTA ETKÄ°: %{abs(impact_pct):.1f} oranÄ±nda maliyet deÄŸiÅŸimi\n"
                report += "   â€¢ BÃ¼tÃ§e revizyonu gerekebilir\n"
                report += "   â€¢ Risk yÃ¶netim planlarÄ± gÃ¶zden geÃ§irilmeli\n"
            else:
                report += f"âœ… DÃœÅÃœK ETKÄ°: %{abs(impact_pct):.1f} oranÄ±nda sÄ±nÄ±rlÄ± etki\n"
                report += "   â€¢ Mevcut stratejiler devam edebilir\n"
            
            result_text.insert("1.0", report)
            result_text.configure(state="disabled")
            
            # LOG
            if activity_logger:
                activity_logger.log_analysis("CURRENCY_SIMULATION", f"USD: {usd_change:+.1f}%, EUR: {eur_change:+.1f}%, Etki: {impact_pct:+.2f}%", "AkÄ±llÄ± SipariÅŸ")
            
        except ValueError:
            messagebox.showerror("Hata", "LÃ¼tfen geÃ§erli sayÄ±sal deÄŸerler girin!")
        except Exception as e:
            result_text.configure(state="normal")
            result_text.insert("1.0", f"âš ï¸ SimÃ¼lasyon hatasÄ±: {str(e)}")
    
    # Butonlar
    btn_frame = tk.Frame(content, bg="#ecf0f1")
    btn_frame.pack(fill="x", pady=10)
    
    tk.Button(btn_frame, text="ğŸ”„ SimÃ¼lasyonu Ã‡alÄ±ÅŸtÄ±r", bg="#3498db", fg="white", font=("Segoe UI", 10, "bold"), padx=20, pady=8, command=run_simulation).pack(side="left", padx=5)
    tk.Button(btn_frame, text="âœ– Kapat", bg="#95a5a6", fg="white", font=("Segoe UI", 10), padx=20, pady=8, command=sim_window.destroy).pack(side="right", padx=5)
    
    # Ä°lk simÃ¼lasyonu otomatik Ã§alÄ±ÅŸtÄ±r
    run_simulation()

def run_order_allocation(qty_entry):
    if df_global is None or sonuc_global is None:
        messagebox.showerror("Hata", "LÃ¼tfen Ã¶nce 'Analiz' sekmesinden verileri yÃ¼kleyin.")
        return
    
    # Arama tipini kontrol et
    search_type = siparis_search_type_var.get() if siparis_search_type_var else "code"
    
    if search_type == "code":
        search_value = siparis_stok_combobox.get()
        search_label = "Ã¼rÃ¼n"
    else:
        search_value = siparis_grup_combobox.get()
        search_label = "stok grubu"
    
    qty_str = qty_entry.get().strip()
    
    if not search_value or not qty_str:
        messagebox.showwarning("Eksik Bilgi", f"LÃ¼tfen {search_label} ve miktar giriniz.")
        return
        
    try:
        total_qty = int(qty_str)
    except ValueError:
        messagebox.showerror("Hata", "Miktar sayÄ±sal olmalÄ±dÄ±r.")
        return

    stok_col = find_stok_kodu_column(df_global)
    if not stok_col: return
    
    if search_value == "TÃ¼m Veri":
        messagebox.showwarning("UyarÄ±", f"SipariÅŸ planlamasÄ± iÃ§in spesifik bir {search_label} seÃ§melisiniz.")
        return
    
    # Arama tipine gÃ¶re veri filtreleme
    if search_type == "code":
        # Stok koduna gÃ¶re filtrele
        norm_stock = normalize_series(df_global[stok_col])
        norm_target = str(search_value).strip().lower()
        relevant_data = df_global[norm_stock == norm_target].copy()
    else:
        # Stok grubuna gÃ¶re filtrele
        if not stok_grup_col_global:
            messagebox.showerror("Hata", "Stok grubu kolonu bulunamadÄ±. LÃ¼tfen veri dosyanÄ±zÄ±n 'stok grubu' kolonuna sahip olduÄŸundan emin olun.")
            return
        
        norm_group = normalize_series(df_global[stok_grup_col_global])
        norm_target = str(search_value).strip().lower()
        relevant_data = df_global[norm_group == norm_target].copy()
    
    if relevant_data.empty:
        messagebox.showerror("Hata", f"Bu {search_label} iÃ§in veri bulunamadÄ±.")
        return
        
    fiyat_col = find_col_by_keywords(df_global, ["fiyat", "price"])
    ted_col = tedarikci_col_global
    
    relevant_data[fiyat_col] = pd.to_numeric(relevant_data[fiyat_col].astype(str).str.replace(',', '.'), errors='coerce')
    supplier_prices = relevant_data.groupby(ted_col)[fiyat_col].mean().reset_index()
    
    # DÃœZELTME: EÅŸleÅŸme hatasÄ±nÄ± Ã¶nlemek iÃ§in isimleri normalize et (strip ve lower)
    supplier_prices['temp_key'] = supplier_prices[ted_col].astype(str).str.strip().str.lower()
    
    temp_sonuc = sonuc_global.copy()
    temp_sonuc['temp_key'] = temp_sonuc[ted_col].astype(str).str.strip().str.lower()
    
    merged = pd.merge(supplier_prices, temp_sonuc[['temp_key', "Skor", "Pareto_Sinifi"]], on='temp_key', how="inner")
    
    if merged.empty:
        msg = "SeÃ§ilen Ã¼rÃ¼nÃ¼n tedarikÃ§ileri mevcut analiz sonuÃ§larÄ±yla eÅŸleÅŸtirilemedi.\n\n" \
              "OlasÄ± Sebepler:\n" \
              "1. 'Analiz' sekmesindeki tarih aralÄ±ÄŸÄ± bu tedarikÃ§ilerin verilerini dÄ±ÅŸlÄ±yor olabilir.\n" \
              "2. TedarikÃ§i isimlerinde uyuÅŸmazlÄ±k olabilir.\n\n" \
              "Ã‡Ã¶zÃ¼m: Tarih aralÄ±ÄŸÄ±nÄ± geniÅŸletip tekrar 'ANALÄ°ZÄ° BAÅLAT' diyerek deneyin."
        messagebox.showerror("EÅŸleÅŸme HatasÄ±", msg)
        return
        
    candidates = merged.sort_values("Skor", ascending=False).head(5).copy()
    
    min_price = candidates[fiyat_col].min()
    candidates["PriceFactor"] = min_price / candidates[fiyat_col]
    
    candidates["Weight"] = candidates["Skor"] * candidates["PriceFactor"]
    
    total_weight = candidates["Weight"].sum()
    
    candidates["AllocatedQty"] = (candidates["Weight"] / total_weight * total_qty).astype(int)
    
    allocated_sum = candidates["AllocatedQty"].sum()
    diff = total_qty - allocated_sum
    if diff > 0:
        candidates.iloc[0, candidates.columns.get_loc("AllocatedQty")] += diff
        
    candidates["TotalCost"] = candidates["AllocatedQty"] * candidates[fiyat_col]
    
    for i in order_treeview.get_children(): order_treeview.delete(i)
    
    global current_allocation_data
    current_allocation_data = candidates
    
    allocation_summary_for_ai = []
    
    for index, row in candidates.iterrows():
        grade, _, _ = calculate_grade(row["Skor"])
        order_treeview.insert("", "end", values=(
            row[ted_col],
            f"{row['Skor']:.1f}",
            grade,
            f"{row[fiyat_col]:.2f}",
            f"{row['AllocatedQty']:,}",
            f"{row['TotalCost']:,.2f}"
        ))
        
        allocation_summary_for_ai.append({
            "Supplier": row[ted_col],
            "Score": f"{row['Skor']:.1f}",
            "Price": f"{row[fiyat_col]:.2f} TL",
            "Allocated": f"{row['AllocatedQty']} units",
            "Share": f"{(row['AllocatedQty']/total_qty)*100:.1f}%"
        })
        
    threading.Thread(target=lambda: generate_order_rationale_gemini(search_value, total_qty, allocation_summary_for_ai), daemon=True).start()

def generate_order_rationale_gemini(product, qty, allocation_data):
    if not GEMINI_API_KEY: return
    
    root.after(0, lambda: order_ai_text.configure(state="normal"))
    root.after(0, lambda: order_ai_text.delete("1.0", tk.END))
    root.after(0, lambda: order_ai_text.insert("1.0", "â³ Yapay Zeka stratejik raporu hazÄ±rlÄ±yor...\n"))
    root.after(0, lambda: order_ai_text.configure(state="disabled"))
    
    prompt = f"""
    Sen kÄ±demli bir Tedarik Zinciri YÃ¶neticisisin. CPO'ya sunulmak Ã¼zere bir sipariÅŸ daÄŸÄ±tÄ±m gerekÃ§esi yaz.
    
    Durum:
    - ÃœrÃ¼n: {product}
    - Toplam SipariÅŸ: {qty} Adet
    
    Sistem tarafÄ±ndan yapÄ±lan daÄŸÄ±tÄ±m (Algoritma: Skor ve Fiyat dengeli):
    {json.dumps(allocation_data, indent=2)}
    
    Ä°stenen Ã‡Ä±ktÄ±:
    1. **YÃ¶netici Ã–zeti:** Neden bu daÄŸÄ±tÄ±mÄ± yaptÄ±k? (Risk daÄŸÄ±tÄ±mÄ±, maliyet avantajÄ± vs.)
    2. **Stratejik Analiz:** En bÃ¼yÃ¼k payÄ± alan tedarikÃ§i neden seÃ§ildi?
    3. **Risk Notu:** Varsa dikkat edilmesi gereken bir nokta.
    
    LÃ¼tfen profesyonel, kurumsal ve ikna edici bir TÃ¼rkÃ§e kullan. Rapor kÄ±sa ve net olsun.
    """
    
    try:
        data = {"contents": [{"parts":[{"text": prompt}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=30)
        
        if response.status_code == 200:
            text = response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
            root.after(0, lambda: update_ai_text_widget(text))
        else:
            root.after(0, lambda: update_ai_text_widget(f"Hata: {response.status_code}"))
    except Exception as e:
        root.after(0, lambda: update_ai_text_widget(f"BaÄŸlantÄ± HatasÄ±: {str(e)}"))

def update_ai_text_widget(text):
    order_ai_text.configure(state="normal")
    order_ai_text.delete("1.0", tk.END)
    order_ai_text.insert("1.0", text)
    order_ai_text.configure(state="disabled")

def generate_order_drafts():
    if 'current_allocation_data' not in globals() or current_allocation_data is None:
        messagebox.showwarning("UyarÄ±", "LÃ¼tfen Ã¶nce hesaplama yapÄ±n.")
        return
        
    win = tk.Toplevel()
    win.title("Taslak SipariÅŸ Mailleri")
    win.geometry("600x500")
    
    txt = tk.Text(win, font=("Consolas", 10), padx=10, pady=10)
    txt.pack(fill="both", expand=True)
    
    # Arama tipine gÃ¶re doÄŸru combobox'tan deÄŸeri al
    search_type = siparis_search_type_var.get() if siparis_search_type_var else "code"
    if search_type == "code":
        product = siparis_stok_combobox.get()
    else:
        product = siparis_grup_combobox.get()
    
    full_text = ""
    for index, row in current_allocation_data.iterrows():
        mail_body = f"""
------------------------------------------------------------
KÄ°ME: {row[tedarikci_col_global]} Yetkilisi
KONU: Yeni SipariÅŸ Talebi - {product}

SayÄ±n Yetkili,

DeFacto olarak {product} kodlu Ã¼rÃ¼n iÃ§in tarafÄ±nÄ±za {row['AllocatedQty']:,} adet sipariÅŸ geÃ§mek istiyoruz.
Birim Fiyat: {row[find_col_by_keywords(df_global, ['fiyat','price'])]:.2f} TL (Sistem KaydÄ±)

LÃ¼tfen termin tarihini ve proforma faturayÄ± tarafÄ±mÄ±za iletiniz.

Ä°yi Ã§alÄ±ÅŸmalar.
------------------------------------------------------------
"""
        full_text += mail_body
        
    txt.insert("1.0", full_text)

# ---------- THE NEGOTIATOR (YENÄ° MODÃœL) ----------
def init_negotiator_tab():
    """AI Destekli PazarlÄ±k Robotu sekmesini oluÅŸturur."""
    global negotiator_combobox, negotiator_text, tone_combobox # Global tanÄ±mlama

    for widget in frame_negotiator.winfo_children(): widget.destroy()

    # BaÅŸlÄ±k AlanÄ±
    header_frame = tk.Frame(frame_negotiator, bg="white", padx=20, pady=20)
    header_frame.pack(fill="x")
    
    tk.Label(header_frame, text="ğŸ’° AI Destekli PazarlÄ±k Robotu (The Negotiator)", 
             font=("Segoe UI", 18, "bold"), fg="#2c3e50", bg="white").pack(anchor="w")
    tk.Label(header_frame, text="TedarikÃ§inin zayÄ±f ve gÃ¼Ã§lÃ¼ yÃ¶nlerini analiz edip, psikolojik ikna teknikleriyle profesyonel bir pazarlÄ±k maili yazar.", 
             font=("Segoe UI", 10), fg="gray", bg="white").pack(anchor="w")

    # Kontrol Paneli
    control_frame = tk.Frame(frame_negotiator, bg="#ecf0f1", padx=20, pady=20)
    control_frame.pack(fill="x", padx=20, pady=10)

    # TedarikÃ§i SeÃ§imi
    tk.Label(control_frame, text="TedarikÃ§i SeÃ§:", font=("Segoe UI", 11), bg="#ecf0f1").grid(row=0, column=0, padx=5, sticky="w")
    negotiator_combobox = ttk.Combobox(control_frame, state="readonly", width=30)
    negotiator_combobox.grid(row=0, column=1, padx=5)

    # Hedef Ä°ndirim OranÄ±
    tk.Label(control_frame, text="Hedef Ä°ndirim (%):", font=("Segoe UI", 11), bg="#ecf0f1").grid(row=0, column=2, padx=5, sticky="w")
    discount_entry = ttk.Entry(control_frame, width=5)
    discount_entry.grid(row=0, column=3, padx=5)
    discount_entry.insert(0, "5")

    # Ton SeÃ§imi (YENÄ°)
    tk.Label(control_frame, text="Ãœslup:", font=("Segoe UI", 11), bg="#ecf0f1").grid(row=0, column=4, padx=5, sticky="w")
    tone_combobox = ttk.Combobox(control_frame, values=["NÃ¶tr (Profesyonel)", "Agresif (Sert)", "Olumlu (YapÄ±cÄ±)"], state="readonly", width=15)
    tone_combobox.set("NÃ¶tr (Profesyonel)")
    tone_combobox.grid(row=0, column=5, padx=5)

    # Aksiyon Butonu
    action_btn = tk.Button(control_frame, text="âœ¨ Analiz Et & Yaz", bg="#27ae60", fg="white", font=("Segoe UI", 10, "bold"),
                           padx=15, command=lambda: run_negotiator_ai(discount_entry.get(), tone_combobox.get()))
    action_btn.grid(row=0, column=6, padx=10)

    # Mail GÃ¶nder Butonu (YENÄ°)
    send_btn = tk.Button(control_frame, text="ğŸ“¤ Maili GÃ¶nder", bg="#2980b9", fg="white", font=("Segoe UI", 10, "bold"),
                         padx=15, command=send_negotiation_email_action)
    send_btn.grid(row=0, column=7, padx=10)

    # SonuÃ§ AlanÄ±
    result_frame = tk.Frame(frame_negotiator, bg="white", bd=1, relief="solid")
    result_frame.pack(fill="both", expand=True, padx=20, pady=10)

    tk.Label(result_frame, text="ğŸ¤– AI Analizi ve Mail TaslaÄŸÄ±", font=("Segoe UI", 12, "bold"), bg="white", fg="#2980b9").pack(pady=10)
    
    negotiator_text = tk.Text(result_frame, wrap="word", font=("Consolas", 11), bg="#fdfefe", padx=20, pady=20)
    negotiator_text.pack(fill="both", expand=True, padx=10, pady=(0, 10))
    
    negotiator_text.insert("1.0", "LÃ¼tfen bir tedarikÃ§i ve Ã¼slup seÃ§ip 'Analiz Et & Yaz' butonuna basÄ±n.\n")

def run_negotiator_ai(target_discount, selected_tone):
    """Gemini ile pazarlÄ±k maili ve analizi oluÅŸturur."""
    supplier_name = negotiator_combobox.get()
    
    if not supplier_name:
        messagebox.showwarning("UyarÄ±", "LÃ¼tfen bir tedarikÃ§i seÃ§in.")
        return
        
    if sonuc_global is None:
        messagebox.showerror("Hata", "LÃ¼tfen Ã¶nce analiz yapÄ±n.")
        return

    # Verileri Ã‡ek
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    
    fiyat_col = find_col_by_keywords(sonuc_global, ['fiyat','price'])
    teslim_col = find_col_by_keywords(sonuc_global, ['teslim','delivery'])
    iade_col = find_col_by_keywords(sonuc_global, ['iade','return'])
    
    price_val = row[fiyat_col]
    delivery_val = row[teslim_col]
    return_val = row[iade_col]
    volume_val = row.get('ToplamTutar', 'Bilinmiyor')
    
    # Ton AyarÄ±
    tone_instruction = "Profesyonel ve dengeli"
    if "Agresif" in selected_tone:
        tone_instruction = "Sert, talepkar ve tedarikÃ§inin hatalarÄ±nÄ± (gecikme/iade) yÃ¼zÃ¼ne vuran, kaybetme korkusu yaratan"
    elif "Olumlu" in selected_tone:
        tone_instruction = "YapÄ±cÄ±, iÅŸbirlikÃ§i, 'birlikte bÃ¼yÃ¼yelim' mesajÄ± veren ama yine de indirim isteyen"
    
    # KullanÄ±cÄ±ya beklemesini sÃ¶yle
    negotiator_text.delete("1.0", tk.END)
    negotiator_text.insert("1.0", f"ğŸ§  {selected_tone} modunda analiz yapÄ±lÄ±yor ve mail taslaÄŸÄ± hazÄ±rlanÄ±yor...\nLÃ¼tfen bekleyin...")
    
    # Thread iÃ§inde Ã§alÄ±ÅŸtÄ±r
    def _thread_task():
        prompt = f"""
        Sen 'The Negotiator' isimli yapay zeka destekli profesyonel bir satÄ±nalma robotusun.
        
        AÅŸaÄŸÄ±daki tedarikÃ§i verilerini analiz et ve bir pazarlÄ±k maili oluÅŸtur.
        
        TedarikÃ§i: {supplier_name}
        Veriler:
        - Teslimat Gecikmesi (Ortalama): {delivery_val:.1f} gÃ¼n
        - Ä°ade MiktarÄ± (Ortalama): {return_val:.1f} Adet
        - Bizim AlÄ±m Hacmimiz: {volume_val} TL
        - Hedeflenen Ä°ndirim: %{target_discount}
        - SEÃ‡Ä°LEN ÃœSLUP: {tone_instruction}
        
        GÃ–REVÄ°N:
        1. Ã–nce durumu analiz eden kÄ±sa bir sistem mesajÄ± yaz.
        
        2. ArdÄ±ndan tedarikÃ§iye gÃ¶nderilecek maili yaz.
        - Konu baÅŸlÄ±ÄŸÄ± eklemeyi unutma.
        - SeÃ§ilen Ã¼sluba ({selected_tone}) tam olarak sadÄ±k kal.
        
        Ã‡Ä±ktÄ± FormatÄ±:
        [SÄ°STEM ANALÄ°ZÄ°]
        ...analiz metni...
        
        [MAÄ°L TASLAÄI]
        Konu: ...
        SayÄ±n Yetkili,
        ...iÃ§erik...
        """
        
        try:
            data = {"contents": [{"parts":[{"text": prompt}]}]}
            response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=40)
            
            if response.status_code == 200:
                result = response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
                root.after(0, lambda: _update_negotiator_ui(result))
            else:
                root.after(0, lambda: _update_negotiator_ui(f"Hata: API YanÄ±t vermedi ({response.status_code})"))
                
        except Exception as e:
            root.after(0, lambda: _update_negotiator_ui(f"BaÄŸlantÄ± HatasÄ±: {str(e)}"))

    threading.Thread(target=_thread_task, daemon=True).start()

def _update_negotiator_ui(text):
    negotiator_text.delete("1.0", tk.END)
    
    # Renklendirme taglarÄ±
    negotiator_text.tag_configure("system", foreground="#e74c3c", font=("Segoe UI", 11, "bold")) # KÄ±rmÄ±zÄ± Sistem MesajÄ±
    negotiator_text.tag_configure("mail", foreground="#2c3e50", font=("Consolas", 11))
    
    if "[SÄ°STEM ANALÄ°ZÄ°]" in text:
        parts = text.split("[MAÄ°L TASLAÄI]")
        system_part = parts[0].replace("[SÄ°STEM ANALÄ°ZÄ°]", "").strip()
        mail_part = parts[1].strip() if len(parts) > 1 else ""
        
        negotiator_text.insert(tk.END, "ğŸ“¢ SÄ°STEM MESAJI:\n", "system")
        negotiator_text.insert(tk.END, system_part + "\n\n", "system")
        negotiator_text.insert(tk.END, "-"*50 + "\n", "mail")
        negotiator_text.insert(tk.END, mail_part, "mail")
    else:
        negotiator_text.insert(tk.END, text)

def send_negotiation_email_action():
    """PazarlÄ±k mailini gÃ¶nderir."""
    supplier_name = negotiator_combobox.get()
    if not supplier_name: 
        messagebox.showwarning("UyarÄ±", "TedarikÃ§i seÃ§ilmedi.")
        return
        
    if sonuc_global is None: return

    # Mail adresini bul
    row = sonuc_global[sonuc_global[tedarikci_col_global] == supplier_name].iloc[0]
    mail_col = find_col_by_keywords(sonuc_global, ["mail", "eposta", "e-posta", "email"])
    
    if not mail_col:
        messagebox.showerror("Hata", "Mail adresi sÃ¼tunu bulunamadÄ±.")
        return
        
    receiver_email = row[mail_col]
    if pd.isna(receiver_email) or str(receiver_email).strip() == "":
        messagebox.showerror("Hata", "TedarikÃ§inin mail adresi yok.")
        return

    # Metni al ve parse et
    full_text = negotiator_text.get("1.0", tk.END).strip()
    if not full_text: return

    if "[MAÄ°L TASLAÄI]" in full_text:
        # Sistem mesajÄ±nÄ± at, sadece maili al
        mail_content = full_text.split("[MAÄ°L TASLAÄI]")[1].strip()
        # Ã‡izgiyi temizle
        if mail_content.startswith("-"):
             mail_content = mail_content.lstrip("-").strip()
    else:
        mail_content = full_text

    # Konuyu ayÄ±kla
    subject = "PazarlÄ±k Hk." # VarsayÄ±lan
    body = mail_content
    
    lines = mail_content.split('\n')
    cleaned_lines = []
    subject_found = False
    
    for line in lines:
        if not subject_found and (line.lower().startswith("konu:") or line.lower().startswith("subject:")):
            subject = line.split(":", 1)[1].strip()
            subject_found = True
        else:
            cleaned_lines.append(line)
            
    body = "\n".join(cleaned_lines).strip()

    # GÃ¶nder
    confirm = messagebox.askyesno("Onay", f"Åu adrese mail gÃ¶nderilecek:\n{receiver_email}\n\nDevam edilsin mi?")
    if confirm:
        success, msg = send_email_with_attachments(str(receiver_email), subject, body, [])
        if success:
            messagebox.showinfo("BaÅŸarÄ±lÄ±", "Mail gÃ¶nderildi.")
        else:
            messagebox.showerror("Hata", f"GÃ¶nderilemedi: {msg}")

# ---------- EKSÄ°K-FAZLA YÃœKLEMELER ANALÄ°ZÄ° ----------
def init_eksik_fazla_tab():
    """Eksik-Fazla yÃ¼kleme analizi sekmesini baÅŸlatÄ±r"""
    global eksik_fazla_treeview, eksik_fazla_supplier_combo
    
    for widget in frame_eksik_fazla.winfo_children(): widget.destroy()
    
    # BaÅŸlÄ±k
    header_frame = tk.Frame(frame_eksik_fazla, bg="#2c3e50", padx=20, pady=15)
    header_frame.pack(fill="x")
    tk.Label(header_frame, text="ğŸ“¦ Eksik-Fazla YÃ¼kleme Analizi", font=("Segoe UI", 16, "bold"), fg="white", bg="#2c3e50").pack(anchor="w")
    tk.Label(header_frame, text="TedarikÃ§ilerin aylÄ±k yÃ¼kleme performansÄ±nÄ± takip edin", font=("Segoe UI", 10), fg="#ecf0f1", bg="#2c3e50").pack(anchor="w")
    
    # Filtre Paneli
    filter_frame = tk.LabelFrame(frame_eksik_fazla, text="Filtreler", font=("Segoe UI", 11, "bold"), padx=15, pady=10, bg="#ecf0f1")
    filter_frame.pack(fill="x", padx=20, pady=10)
    
    tk.Label(filter_frame, text="TedarikÃ§i SeÃ§:", font=("Segoe UI", 10), bg="#ecf0f1").grid(row=0, column=0, padx=5, pady=5, sticky="w")
    eksik_fazla_supplier_combo = ttk.Combobox(filter_frame, state="readonly", width=35)
    eksik_fazla_supplier_combo.grid(row=0, column=1, padx=5, pady=5, sticky="w")
    
    # Analiz butonu
    analyze_btn = tk.Button(filter_frame, text="ğŸ” Analizi GÃ¶ster", bg="#3498db", fg="white", font=("Segoe UI", 10, "bold"), 
                           padx=15, pady=5, command=lambda: show_eksik_fazla_analysis())
    analyze_btn.grid(row=0, column=2, padx=15, pady=5)
    
    # Export butonlarÄ±
    export_frame = tk.Frame(filter_frame, bg="#ecf0f1")
    export_frame.grid(row=0, column=3, padx=5, pady=5, sticky="e")
    tk.Button(export_frame, text="Excel", bg="#27ae60", fg="white", font=("Segoe UI", 8, "bold"), 
             command=lambda: export_eksik_fazla_data("xlsx")).pack(side="left", padx=2)
    tk.Button(export_frame, text="PDF", bg="#c0392b", fg="white", font=("Segoe UI", 8, "bold"),
             command=lambda: export_eksik_fazla_data("pdf")).pack(side="left", padx=2)
    
    # SonuÃ§ Tablosu
    result_frame = tk.LabelFrame(frame_eksik_fazla, text="AylÄ±k YÃ¼kleme DetaylarÄ±", font=("Segoe UI", 11, "bold"), padx=10, pady=10)
    result_frame.pack(fill="both", expand=True, padx=20, pady=10)
    
    # Treeview
    columns = ("Ay", "SipariÅŸ MiktarÄ±", "YÃ¼klenen Miktar", "Kalan Miktar", "Durum")
    eksik_fazla_treeview = ttk.Treeview(result_frame, columns=columns, show="headings", height=20)
    
    # Kolon baÅŸlÄ±klarÄ±
    eksik_fazla_treeview.heading("Ay", text="Ay")
    eksik_fazla_treeview.heading("SipariÅŸ MiktarÄ±", text="SipariÅŸ MiktarÄ±")
    eksik_fazla_treeview.heading("YÃ¼klenen Miktar", text="YÃ¼klenen Miktar")
    eksik_fazla_treeview.heading("Kalan Miktar", text="Kalan Miktar")
    eksik_fazla_treeview.heading("Durum", text="Durum")
    
    # Kolon geniÅŸlikleri
    eksik_fazla_treeview.column("Ay", width=150, anchor="center")
    eksik_fazla_treeview.column("SipariÅŸ MiktarÄ±", width=150, anchor="center")
    eksik_fazla_treeview.column("YÃ¼klenen Miktar", width=150, anchor="center")
    eksik_fazla_treeview.column("Kalan Miktar", width=150, anchor="center")
    eksik_fazla_treeview.column("Durum", width=200, anchor="center")
    
    # Scrollbar
    vsb = ttk.Scrollbar(result_frame, orient="vertical", command=eksik_fazla_treeview.yview)
    eksik_fazla_treeview.configure(yscrollcommand=vsb.set)
    
    eksik_fazla_treeview.pack(side="left", fill="both", expand=True)
    vsb.pack(side="right", fill="y")
    
    # Durum renklendirmesi iÃ§in tag'ler
    eksik_fazla_treeview.tag_configure("tam", background="#d5f4e6", foreground="#27ae60")
    eksik_fazla_treeview.tag_configure("eksik", background="#fadbd8", foreground="#c0392b")
    eksik_fazla_treeview.tag_configure("fazla", background="#fcf3cf", foreground="#f39c12")
    
    # Ã–zet bilgi kartÄ±
    summary_frame = tk.Frame(frame_eksik_fazla, bg="white", bd=2, relief="solid", padx=15, pady=10)
    summary_frame.pack(fill="x", padx=20, pady=(0, 10))
    
    global eksik_fazla_summary_label
    eksik_fazla_summary_label = tk.Label(summary_frame, text="TedarikÃ§i seÃ§ip analizi gÃ¶rÃ¼ntÃ¼leyin.", 
                                         font=("Segoe UI", 10), bg="white", fg="#7f8c8d", justify="left")
    eksik_fazla_summary_label.pack(anchor="w")
    
    # TedarikÃ§i listesini yÃ¼kle
    update_eksik_fazla_suppliers()

def update_eksik_fazla_suppliers():
    """TedarikÃ§i listesini gÃ¼nceller"""
    if df_global is not None and tedarikci_col_global is not None:
        suppliers = ["TÃ¼mÃ¼"] + sorted(df_global[tedarikci_col_global].unique().astype(str).tolist())
        eksik_fazla_supplier_combo['values'] = suppliers
        if suppliers:
            eksik_fazla_supplier_combo.set(suppliers[0])

def show_eksik_fazla_analysis():
    """SeÃ§ili tedarikÃ§i iÃ§in eksik-fazla yÃ¼kleme analizini gÃ¶sterir"""
    if df_global is None:
        messagebox.showwarning("UyarÄ±", "LÃ¼tfen Ã¶nce veri yÃ¼kleyin!")
        return
    
    selected_supplier = eksik_fazla_supplier_combo.get()
    if not selected_supplier:
        messagebox.showwarning("UyarÄ±", "LÃ¼tfen bir tedarikÃ§i seÃ§in!")
        return
    
    # Treeview'i temizle
    for item in eksik_fazla_treeview.get_children():
        eksik_fazla_treeview.delete(item)
    
    # Veriyi hazÄ±rla
    df_analysis = df_global.copy()
    
    # Gerekli kolonlarÄ± bul
    date_col = find_col_by_keywords(df_analysis, ["tarih", "date"])
    siparis_no_col = find_col_by_keywords(df_analysis, ["sipariÅŸ no", "siparis no", "order no", "order number", "sipariÅŸ numarasÄ±"])
    siparis_miktar_col = find_col_by_keywords(df_analysis, ["sipariÅŸ miktarÄ±", "siparis miktari", "order quantity"])
    kalan_col = find_col_by_keywords(df_analysis, ["kalan", "remaining", "kalan miktar"])
    
    if not date_col or not siparis_no_col:
        messagebox.showerror("Hata", "Tarih veya SipariÅŸ No kolonu bulunamadÄ±!")
        return
    
    # TedarikÃ§i filtresi
    if selected_supplier != "TÃ¼mÃ¼":
        df_analysis = df_analysis[df_analysis[tedarikci_col_global] == selected_supplier]
    
    if df_analysis.empty:
        messagebox.showinfo("Bilgi", "SeÃ§ili tedarikÃ§i iÃ§in veri bulunamadÄ±.")
        return
    
    # Tarih dÃ¶nÃ¼ÅŸÃ¼mÃ¼
    df_analysis[date_col] = pd.to_datetime(df_analysis[date_col], errors='coerce')
    df_analysis = df_analysis.dropna(subset=[date_col])
    
    # SipariÅŸ MiktarÄ± kolonu kontrolÃ¼
    if siparis_miktar_col:
        df_analysis[siparis_miktar_col] = pd.to_numeric(df_analysis[siparis_miktar_col].astype(str).str.replace(',', '.'), errors='coerce')
    else:
        # SipariÅŸ MiktarÄ± yoksa, alternatif Miktar kolonunu ara
        miktar_col = find_col_by_keywords(df_analysis, ["miktar", "adet", "quantity", "qty"])
        if miktar_col:
            df_analysis[miktar_col] = pd.to_numeric(df_analysis[miktar_col].astype(str).str.replace(',', '.'), errors='coerce')
            siparis_miktar_col = miktar_col
        else:
            messagebox.showerror("Hata", "SipariÅŸ MiktarÄ± veya Miktar kolonu bulunamadÄ±!")
            return
    
    # Kalan Miktar dÃ¶nÃ¼ÅŸÃ¼mÃ¼
    if kalan_col:
        df_analysis[kalan_col] = pd.to_numeric(df_analysis[kalan_col].astype(str).str.replace(',', '.'), errors='coerce')
    else:
        # Kalan miktar kolonu yoksa, sÄ±fÄ±r olarak varsay (tam yÃ¼kleme)
        df_analysis['_kalan_temp'] = 0
        kalan_col = '_kalan_temp'
    
    # Ay bilgisini ekle
    df_analysis['Ay'] = df_analysis[date_col].dt.to_period('M')
    
    # Benzersiz kombinasyon oluÅŸtur: SipariÅŸ No + SipariÅŸ MiktarÄ±
    # AynÄ± sipariÅŸ no ancak farklÄ± miktarlar olabilir, bunlarÄ± ayrÄ± tutmalÄ±yÄ±z
    df_analysis['_unique_key'] = df_analysis[siparis_no_col].astype(str) + '_' + df_analysis[siparis_miktar_col].astype(str)
    
    # Her benzersiz kombinasyon iÃ§in sadece BÄ°R KAYIT al (ilk kaydÄ± al)
    # AynÄ± sipariÅŸ no + sipariÅŸ miktarÄ± birden fazla satÄ±rda olabilir, ama biz sadece birini alÄ±yoruz
    df_unique_orders = df_analysis.drop_duplicates(subset=['_unique_key'], keep='first')
    
    # AylÄ±k gruplama - Her ay iÃ§in sipariÅŸleri grupla
    monthly_summary = df_unique_orders.groupby('Ay').agg({
        siparis_miktar_col: 'sum',  # AylÄ±k toplam sipariÅŸ miktarÄ±
        kalan_col: 'sum'  # AylÄ±k toplam kalan miktar (her sipariÅŸ iÃ§in tek bir deÄŸer)
    }).reset_index()
    
    # YÃ¼klenen miktarÄ± hesapla (SipariÅŸ MiktarÄ± - Kalan Miktar = YÃ¼klenen)
    monthly_summary['YÃ¼klenen'] = monthly_summary[siparis_miktar_col] - monthly_summary[kalan_col]
    
    # Ã–zet istatistikler
    total_months = len(monthly_summary)
    tam_yukleme = len(monthly_summary[monthly_summary[kalan_col] == 0])
    eksik_yukleme = len(monthly_summary[monthly_summary[kalan_col] > 0])
    fazla_yukleme = len(monthly_summary[monthly_summary[kalan_col] < 0])
    
    # SonuÃ§larÄ± treeview'e ekle
    for idx, row in monthly_summary.iterrows():
        ay_str = str(row['Ay'])
        siparis = row[siparis_miktar_col]
        yuklenen = row['YÃ¼klenen']
        kalan = row[kalan_col]
        
        # Durumu belirle
        if kalan == 0:
            durum = "âœ… Tam YÃ¼kleme"
            tag = "tam"
        elif kalan > 0:
            durum = f"âš ï¸ Eksik YÃ¼kleme ({kalan:.0f} eksik)"
            tag = "eksik"
        else:
            durum = f"ğŸ“ˆ Fazla YÃ¼kleme ({abs(kalan):.0f} fazla)"
            tag = "fazla"
        
        eksik_fazla_treeview.insert("", "end", values=(
            ay_str,
            f"{siparis:,.0f}",
            f"{yuklenen:,.0f}",
            f"{kalan:,.0f}",
            durum
        ), tags=(tag,))
    
    # Ã–zet bilgiyi gÃ¼ncelle
    total_siparis = monthly_summary[siparis_miktar_col].sum()
    total_yuklenen = monthly_summary['YÃ¼klenen'].sum()
    basari_orani = (tam_yukleme / total_months * 100) if total_months > 0 else 0
    
    # Toplam sipariÅŸ sayÄ±sÄ±nÄ± hesapla (benzersiz sipariÅŸ no + miktar kombinasyonlarÄ±)
    total_orders = len(df_unique_orders)
    
    summary_text = f"""ğŸ“Š Ã–ZET BÄ°LGÄ°LER - {selected_supplier}

ğŸ“… Toplam Ay SayÄ±sÄ±: {total_months}
ğŸ“¦ Benzersiz SipariÅŸ Kombinasyonu: {total_orders} adet (SipariÅŸ No + Miktar)
âœ… Tam YÃ¼kleme: {tam_yukleme} ay ({(tam_yukleme/total_months*100 if total_months else 0):.1f}%)
âš ï¸ Eksik YÃ¼kleme: {eksik_yukleme} ay
ğŸ“ˆ Fazla YÃ¼kleme: {fazla_yukleme} ay

ğŸ’¼ Toplam SipariÅŸ MiktarÄ±: {total_siparis:,.0f} adet
ğŸ“¦ Toplam YÃ¼klenen: {total_yuklenen:,.0f} adet
ğŸ¯ BaÅŸarÄ± OranÄ±: {basari_orani:.1f}%"""
    
    eksik_fazla_summary_label.configure(text=summary_text, fg="#2c3e50")
    
    # LOG
    if activity_logger:
        activity_logger.log_analysis("EKSIK_FAZLA_YUKLEME", f"TedarikÃ§i: {selected_supplier}, BaÅŸarÄ±: {basari_orani:.1f}%", "Eksik-Fazla YÃ¼klemeler")

def export_eksik_fazla_data(format_type):
    """Eksik-fazla yÃ¼kleme verilerini export eder"""
    items = eksik_fazla_treeview.get_children()
    if not items:
        messagebox.showwarning("UyarÄ±", "Export edilecek veri bulunamadÄ±!")
        return
    
    # Treeview verilerini DataFrame'e dÃ¶nÃ¼ÅŸtÃ¼r
    data = []
    for item in items:
        values = eksik_fazla_treeview.item(item)['values']
        data.append(values)
    
    df_export = pd.DataFrame(data, columns=["Ay", "SipariÅŸ MiktarÄ±", "YÃ¼klenen Miktar", "Kalan Miktar", "Durum"])
    
    if format_type == "xlsx":
        export_data(df_export, "xlsx", "Eksik_Fazla_Yuklemeler")
    elif format_type == "pdf":
        export_data(df_export, "pdf", "Eksik_Fazla_Yuklemeler")

# ---------- VERÄ°LERÄ°NLE KONUÅ (CHATBOT) ----------
def init_chat_tab():
    global chat_history_text
    for widget in frame_chat.winfo_children(): widget.destroy()
    
    tk.Label(frame_chat, text="ğŸ¤– Defacto Ãœretim AsistanÄ±", font=("Segoe UI", 16, "bold"), fg="#2c3e50").pack(pady=(15, 5))
    tk.Label(frame_chat, text="Merhaba! Ben Defacto Ãœretim, tekstil alanÄ±nda uzman yapay zeka asistanÄ±nÄ±zÄ±m. Verileriniz ve tekstil hakkÄ±nda her ÅŸeyi sorabilirsiniz!", 
             font=("Segoe UI", 10), fg="gray").pack(pady=(0, 15))

    chat_frame = tk.Frame(frame_chat)
    chat_frame.pack(fill="both", expand=True, padx=20, pady=5)
    
    scrollbar = tk.Scrollbar(chat_frame)
    scrollbar.pack(side="right", fill="y")
    
    chat_history_text = tk.Text(chat_frame, wrap="word", font=("Segoe UI", 11), bg="white", bd=1, relief="solid",
                                state="disabled", yscrollcommand=scrollbar.set)
    chat_history_text.pack(side="left", fill="both", expand=True)
    scrollbar.configure(command=chat_history_text.yview)
    
    chat_history_text.tag_configure("user", foreground="#2980b9", font=("Segoe UI", 11, "bold"), justify="right")
    chat_history_text.tag_configure("ai", foreground="#2c3e50", font=("Segoe UI", 11), justify="left")
    chat_history_text.tag_configure("error", foreground="red", font=("Segoe UI", 11, "italic"))

    input_frame = tk.Frame(frame_chat, bg="#f0f0f0", height=50)
    input_frame.pack(fill="x", side="bottom", padx=20, pady=20)
    
    user_entry = ttk.Entry(input_frame, font=("Segoe UI", 11))
    user_entry.pack(side="left", fill="x", expand=True, padx=(0, 10), ipady=5)
    user_entry.bind("<Return>", lambda event: send_chat_message(user_entry))
    
    send_btn = ttk.Button(input_frame, text="GÃ¶nder â¤", command=lambda: send_chat_message(user_entry))
    send_btn.pack(side="right")

def send_chat_message(entry_widget):
    query = entry_widget.get().strip()
    if not query: return
    
    chat_history_text.configure(state="normal")
    chat_history_text.insert("end", f"\nSiz: {query}\n", "user")
    chat_history_text.configure(state="disabled")
    entry_widget.delete(0, 'end')
    
    threading.Thread(target=lambda: fetch_chat_response(query), daemon=True).start()

def fetch_chat_response(query):
    if not GEMINI_API_KEY:
        append_chat_response("Hata: API AnahtarÄ± eksik.", "error")
        return

    # Veri konteksti oluÅŸtur
    context_data = ""
    has_data = False
    
    if sonuc_global is not None:
        has_data = True
        context_data = f"Veri Ã–zeti (Ä°lk 50 KayÄ±t):\n{sonuc_global.head(50).to_string()}\n"
        context_data += f"\nSÃ¼tunlar: {list(sonuc_global.columns)}\n"
    
    # Ham veri de varsa ekle
    if df_global is not None:
        has_data = True
        context_data += f"\n\nHam Veri Ã–zeti (Ä°lk 30 KayÄ±t):\n{df_global.head(30).to_string()}\n"
        context_data += f"\nToplam KayÄ±t SayÄ±sÄ±: {len(df_global)}\n"

    # GeliÅŸtirilmiÅŸ prompt - Defacto Ãœretim kiÅŸiliÄŸi ve tekstil uzmanlÄ±ÄŸÄ±
    prompt = f"""
    Sen "Defacto Ãœretim" adÄ±nda, tekstil sektÃ¶rÃ¼nde uzmanlaÅŸmÄ±ÅŸ yapay zeka asistanÄ±sÄ±n.
    
    KÄ°ÅÄ°LÄ°ÄÄ°N VE UZMANLIÄIN:
    - Ä°smin: Defacto Ãœretim
    - UzmanlÄ±k: Tekstil Ã¼retimi, kumaÅŸ teknolojileri, tedarik zinciri yÃ¶netimi, kalite kontrol
    - Tekstil bilgin: Dokuma, Ã¶rme, boya, baskÄ±, aksesuar, konfeksiyon, hammadde (pamuk, polyester, elastan vb.)
    - DavranÄ±ÅŸ: SÄ±cak, yardÄ±msever, profesyonel ve konuÅŸkan
    - Her zaman samimi ve dostÃ§a yanÄ±tlar verirsin
    
    GÃ–REVIN:
    1. KullanÄ±cÄ± selamlaÅŸtÄ±ÄŸÄ±nda (merhaba, selam, hello vb.) karÅŸÄ±lÄ±k ver ve kendini tanÄ±t
    2. Sohbet etmeye hazÄ±r ol - sadece veri analizi deÄŸil, tekstil hakkÄ±nda genel sorulara da cevap ver
    3. YÃ¼klenen verilere %100 odaklan ve veriden iÃ§gÃ¶rÃ¼ler sun
    4. Veri yoksa bile tekstil sektÃ¶rÃ¼ hakkÄ±nda bilgi ver ve yardÄ±mcÄ± ol
    
    {"VERÄ° MEVCUT - Analiz edebileceÄŸin veriler:" if has_data else "VERÄ° YOK - Ancak tekstil ve tedarik zinciri hakkÄ±nda sorular sorabilir."}
    ---
    {context_data if has_data else "HenÃ¼z veri yÃ¼klenmedi."}
    ---
    
    KullanÄ±cÄ± Sorusu: {query}
    
    YANITLAMA KURALLARI:
    - EÄŸer kullanÄ±cÄ± selamlaÅŸÄ±yorsa (merhaba, selam, hello, hi vb.), sÄ±cak karÅŸÄ±la ve kendini tanÄ±t
    - Veri varsa, veriye dayalÄ± detaylÄ± analiz yap
    - Veri yoksa, tekstil sektÃ¶rÃ¼ bilginle yardÄ±mcÄ± ol ve kullanÄ±cÄ±yÄ± yÃ¶nlendir
    - Her zaman TÃ¼rkÃ§e, samimi ve profesyonel yanÄ±t ver
    - Tekstil terimleri kullan ve uzmanlÄ±ÄŸÄ±nÄ± gÃ¶ster
    """
    
    try:
        data = {"contents": [{"parts":[{"text": prompt}]}]}
        response = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json=data, timeout=30)
        
        if response.status_code == 200:
            reply = response.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
            append_chat_response(reply, "ai")
        else:
            append_chat_response(f"Hata: API yanÄ±t vermedi. Kod: {response.status_code}", "error")
            
    except Exception as e:
        append_chat_response(f"Bir hata oluÅŸtu: {str(e)}", "error")

def append_chat_response(message, tag):
    def _update():
        chat_history_text.configure(state="normal")
        chat_history_text.insert("end", f"\nDefacto Ãœretim: {message}\n", tag)
        chat_history_text.insert("end", "-"*50 + "\n", "ai")
        chat_history_text.see("end")
        chat_history_text.configure(state="disabled")
    
    if chat_history_text:
        chat_history_text.after(0, _update)

# ---------- DiÄŸer Fonksiyonlar ----------
def send_usage_log_email(islem_detayi):
    if not GMAIL_USER or not GMAIL_APP_PASSWORD: return
    try:
        msg = MIMEMultipart(); msg['From'] = GMAIL_USER; msg['To'] = GMAIL_RECEIVER_LOGS; msg['Subject'] = f"KullanÄ±m - {getpass.getuser()}"
        msg.attach(MIMEText(f"Ä°ÅŸlem: {islem_detayi}\nZaman: {datetime.datetime.now()}", 'plain'))
        server = smtplib.SMTP('smtp.gmail.com', 587); server.starttls(); server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
        server.sendmail(GMAIL_USER, GMAIL_RECEIVER_LOGS, msg.as_string()); server.quit()
    except: pass

def save_settings():
    settings = {
        'price_weight': price_weight.get(),
        'delivery_weight': delivery_weight.get(),
        'return_weight': return_weight.get(),
        'exclude_outliers': exclude_outliers_var.get(),
        'monitoring_folder': monitoring_folder if monitoring_folder else None,
        'auto_analyze': True  # Otomatik analiz her zaman aÃ§Ä±k
    }
    try:
        with open(SETTINGS_FILE, 'w') as f: 
            json.dump(settings, f, indent=2)
        print(f"Ayarlar kaydedildi: {settings}")
    except Exception as e:
        print(f"Ayar kaydetme hatasÄ±: {e}")

def load_settings():
    global monitoring_folder
    try:
        with open(SETTINGS_FILE, 'r') as f:
            settings = json.load(f)
            price_weight.set(settings.get('price_weight', 0.4))
            delivery_weight.set(settings.get('delivery_weight', 0.3))
            return_weight.set(settings.get('return_weight', 0.3))
            exclude_outliers_var.set(settings.get('exclude_outliers', False))  # VarsayÄ±lan FALSE
            
            # KlasÃ¶r izleme ayarÄ±nÄ± yÃ¼kle
            saved_folder = settings.get('monitoring_folder')
            if saved_folder and os.path.exists(saved_folder):
                monitoring_folder = saved_folder
                # UI'da gÃ¶ster
                root.after(100, lambda: set_status(f"KaydedilmiÅŸ klasÃ¶r: {os.path.basename(monitoring_folder)}"))
                # Otomatik baÅŸlat
                root.after(200, auto_start_monitoring)
            
            update_weights()
            print(f"Ayarlar yÃ¼klendi: {settings}")
    except FileNotFoundError:
        print("Ayar dosyasÄ± bulunamadÄ±, varsayÄ±lanlar kullanÄ±lÄ±yor")
    except Exception as e:
        print(f"Ayar yÃ¼kleme hatasÄ±: {e}")

def export_data(data, format_type, sheet_name=None, filename=None):
    if data is None or data.empty: messagebox.showerror("Hata", "Veri yok."); return
    if not filename: filename = filedialog.asksaveasfilename(defaultextension=f".{format_type}", filetypes=[(f"{format_type.upper()}", f"*.{format_type}")])
    if not filename: return
    try:
        if format_type == "xlsx":
            with pd.ExcelWriter(filename, engine='openpyxl') as writer: data.to_excel(writer, sheet_name=sheet_name or "Veri", index=False)
        elif format_type == "pdf": export_df_to_pdf(data, filename)
        elif format_type == "docx": export_df_to_docx(data, filename)
        
        # LOG: Export baÅŸarÄ±lÄ±
        if activity_logger:
            activity_logger.log_export(format_type.upper(), os.path.basename(filename))
        
        messagebox.showinfo("BaÅŸarÄ±lÄ±", "Kaydedildi.")
    except Exception as e: 
        # LOG: Export hatasÄ±
        if activity_logger:
            activity_logger.log_error(f"Export hatasÄ± ({format_type}): {str(e)}")
        messagebox.showerror("Hata", str(e))

def export_df_to_pdf(df, filename):
    pdf = FPDF(); pdf.add_font('DejaVuSans', '', 'DejaVuSans.ttf', uni=True) if os.path.exists('DejaVuSans.ttf') else pdf.set_font("Arial", size=10)
    pdf.add_page(); pdf.cell(200, 10, txt="Rapor", ln=True, align='C'); pdf.ln(5)
    for i, col in enumerate(df.columns[:10]): pdf.cell(20, 8, str(col)[:10], 1)
    pdf.ln()
    for index, row in df.iterrows():
        for i, item in enumerate(row[:10]): pdf.cell(20, 8, str(item)[:10], 1)
        pdf.ln()
    pdf.output(filename)

def export_df_to_docx(df, filename):
    doc = Document(); doc.add_heading("Rapor", level=1); table = doc.add_table(df.shape[0]+1, df.shape[1]); table.style='Table Grid'
    for j, col in enumerate(df.columns): table.cell(0, j).text = str(col)
    for i in range(df.shape[0]):
        for j in range(df.shape[1]): table.cell(i+1, j).text = str(df.iloc[i, j])
    doc.save(filename)

def export_charts(format_type, filename=None):
    if fig_global is None: messagebox.showerror("Hata", "Grafik yok."); return
    if not filename: filename = filedialog.asksaveasfilename(defaultextension=f".{format_type}")
    if not filename: return
    try: fig_global.savefig(filename, dpi=300); messagebox.showinfo("BaÅŸarÄ±lÄ±", "Kaydedildi.")
    except Exception as e: messagebox.showerror("Hata", str(e))

def export_ai_comment(format_type, filename=None):
    if message_global is None: messagebox.showerror("Hata", "Yorum yok."); return
    if not filename: filename = filedialog.asksaveasfilename(defaultextension=f".{format_type}")
    if not filename: return
    try:
        with open(filename, 'w', encoding='utf-8') as f: f.write(message_global)
        messagebox.showinfo("BaÅŸarÄ±lÄ±", "Kaydedildi.")
    except Exception as e: messagebox.showerror("Hata", str(e))

def send_email_with_attachments(to_email, subject, body, attachment_paths):
    if not GMAIL_USER or not GMAIL_APP_PASSWORD: return False, "Ayarlar eksik."
    
    # LOG: Email gÃ¶nderimi baÅŸladÄ±
    if activity_logger:
        activity_logger.log_email_sent(to_email, subject)
    
    msg = MIMEMultipart(); msg['From'] = GMAIL_USER; msg['To'] = to_email; msg['Subject'] = subject; msg.attach(MIMEText(body, 'plain'))
    for path in attachment_paths:
        try:
            with open(path, "rb") as f:
                part = MIMEBase('application', 'octet-stream'); part.set_payload(f.read()); encoders.encode_base64(part)
                part.add_header('Content-Disposition', f"attachment; filename= {os.path.basename(path)}"); msg.attach(part)
        except: pass
    try:
        server = smtplib.SMTP('smtp.gmail.com', 587); server.starttls(); server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
        server.sendmail(GMAIL_USER, to_email.split(','), msg.as_string()); server.quit(); 
        
        # LOG: Email baÅŸarÄ±yla gÃ¶nderildi
        if activity_logger:
            activity_logger.log_event("EMAIL_SUCCESS", f"Mail baÅŸarÄ±yla gÃ¶nderildi: {to_email}")
        
        return True, "GÃ¶nderildi."
    except Exception as e: 
        # LOG: Email hatasÄ±
        if activity_logger:
            activity_logger.log_error(f"Email hatasÄ±: {str(e)}")
        return False, str(e)

def send_report_email():
    if sonuc_global is None: messagebox.showerror("Hata", "Analiz yok."); return
    excel_path = "rapor.xlsx"; pdf_path = "yorum.pdf"
    with pd.ExcelWriter(excel_path) as w: sonuc_global.to_excel(w, index=False)
    export_ai_comment("pdf", pdf_path)
    
    attachments = [excel_path, pdf_path]
    success, msg = send_email_with_attachments(REPORT_RECEIVERS, "TedarikÃ§i Raporu", "Ektedir.", attachments)
    messagebox.showinfo("Durum", msg)
    for p in attachments: 
        if os.path.exists(p): os.remove(p)

def set_status(message):
    if status_label: root.after(0, lambda: status_label.configure(text=message))

def normalize_series(s): return s.astype(str).fillna("").str.strip().str.lower()

def find_stok_kodu_column(df):
    keys = ["stok kodu", "stok_kodu", "stokkod", "stok kod", "stok", "sku", "kod", "item code", "item_code", "stock code", "barcode"]
    cols = list(df.columns)
    for col in cols:
        if any(k in str(col).lower() for k in keys): return col
    return ask_user_to_pick_column(cols)

def find_stok_grubu_column(df):
    """Find stock group column in the dataframe - prioritizes 'Stok Grubu' over generic terms"""
    # First check for exact or close matches to "Stok Grubu"
    priority_keys = ["stok grubu", "stok_grubu", "stokgrubu"]
    cols = list(df.columns)
    for col in cols:
        col_lower = str(col).lower()
        if any(k in col_lower for k in priority_keys):
            return col
    
    # If not found, check for generic group terms
    fallback_keys = ["grup", "group", "item group", "product group"]
    for col in cols:
        col_lower = str(col).lower()
        if any(k in col_lower for k in fallback_keys):
            return col
    
    return None  # Return None if not found, don't ask user

def find_col_by_keywords(df, keywords):
    for col in df.columns:
        if any(k in str(col).lower() for k in keywords): return col
    return None

def ask_user_to_pick_column(cols):
    win = tk.Toplevel(); win.title("Kolon SeÃ§"); tk.Label(win, text="SeÃ§im yapÄ±n:").pack()
    combo = ttk.Combobox(win, values=cols, state="readonly"); combo.pack()
    sel = [None]
    def on_ok(): sel[0] = combo.get(); win.destroy()
    ttk.Button(win, text="Tamam", command=on_ok).pack(); win.wait_window()
    return sel[0]

def show_best_supplier(en_iyi_df):
    if en_iyi_df.empty: return
    bs = en_iyi_df.iloc[0]
    # DÃœZELTME: SÃ¼tun ismine gÃ¶re eriÅŸim (Ã¶nceden indexe gÃ¶reydi ve kayma oluyordu)
    sup_name = bs[tedarikci_col_global]
    score = bs['Skor'] 
    messagebox.showinfo("En Ä°yi", f"TedarikÃ§i: {sup_name}\nSkor: {score:.2f}")

def update_ai_comment_tab(message, en_iyi_df):
    root.after(0, lambda: _update_ai_comment_tab(message, en_iyi_df))

def _update_ai_comment_tab(message, en_iyi_df):
    global sonuc_global 
    for w in frame_ai.winfo_children(): w.destroy()
    
    text_frame = tk.Frame(frame_ai, bg="#f4f6f9")
    text_frame.pack(fill="both", expand=True, padx=10, pady=10)
    
    scrollbar = tk.Scrollbar(text_frame)
    scrollbar.pack(side="right", fill="y")
    
    txt = tk.Text(text_frame, wrap="word", font=("Segoe UI", 11), bg="white", fg="#333333",
                  bd=0, padx=20, pady=20, yscrollcommand=scrollbar.set)
    txt.pack(side="left", fill="both", expand=True)
    scrollbar.configure(command=txt.yview)
    
    txt.tag_configure("header", font=("Segoe UI", 12, "bold"), foreground="#2980b9", spacing3=10, spacing1=5)
    txt.tag_configure("risk", font=("Segoe UI", 11, "bold"), foreground="#e74c3c") 
    txt.tag_configure("action", font=("Segoe UI", 11, "bold"), foreground="#27ae60") 
    txt.tag_configure("normal", font=("Segoe UI", 11), foreground="#2c3e50", spacing1=2)
    txt.tag_configure("bullet", font=("Segoe UI", 11, "bold"), foreground="#f39c12") 
    txt.tag_configure("supplier_red", font=("Segoe UI", 11, "bold"), foreground="#c0392b") 

    known_suppliers = []
    if sonuc_global is not None and tedarikci_col_global is not None:
        known_suppliers = sonuc_global[tedarikci_col_global].unique().tolist()
    
    lines = message.split('\n')
    for line in lines:
        line = line.strip()
        if not line: continue
        
        current_tags = "normal"
        if "Genel Yorum:" in line or line.endswith(":"): current_tags = "header"
        elif "Risk Analizi:" in line: current_tags = "risk"
        elif "Aksiyon PlanÄ±:" in line: current_tags = "action"
        
        if line.startswith("-") or line.startswith("*") or line.startswith("â€¢"):
             txt.insert(tk.END, " â€¢ ", "bullet")
             content = line.lstrip("-*â€¢ ")
             
             found_supplier = False
             for sup in known_suppliers:
                 if str(sup).lower() in content.lower():
                     start_idx = content.lower().find(str(sup).lower())
                     end_idx = start_idx + len(str(sup))
                     
                     txt.insert(tk.END, content[:start_idx], current_tags)
                     txt.insert(tk.END, content[start_idx:end_idx], "supplier_red")
                     txt.insert(tk.END, content[end_idx:] + "\n", current_tags)
                     found_supplier = True
                     break
             if not found_supplier:
                 txt.insert(tk.END, content + "\n", current_tags)
                 
        else:
             found_supplier = False
             for sup in known_suppliers:
                 if str(sup).lower() in line.lower():
                     start_idx = line.lower().find(str(sup).lower())
                     end_idx = start_idx + len(str(sup))
                     
                     txt.insert(tk.END, line[:start_idx], current_tags)
                     txt.insert(tk.END, line[start_idx:end_idx], "supplier_red")
                     txt.insert(tk.END, line[end_idx:] + "\n", current_tags)
                     found_supplier = True
                     break
             if not found_supplier:
                txt.insert(tk.END, line + "\n", current_tags)
        
    txt.configure(state="disabled")

    bf = tk.Frame(frame_ai, bg="#f4f6f9")
    bf.pack(fill="x", pady=10, padx=10)
    
    style = ttk.Style()
    style.configure("Accent.TButton", font=("Segoe UI", 9, "bold"))
    
    ttk.Button(bf, text="ğŸ† En Ä°yi TedarikÃ§iyi GÃ¶ster", style="Accent.TButton", command=lambda: show_best_supplier(en_iyi_df)).pack(side="left", padx=5)
    ttk.Button(bf, text="ğŸ’¾ Yorumu Kaydet (TXT)", command=lambda: export_ai_comment("txt")).pack(side="left", padx=5)
    ttk.Button(bf, text="ğŸ“„ Yorumu Kaydet (PDF)", command=lambda: export_ai_comment("pdf")).pack(side="left", padx=5)

def yapay_zeka_analizi_gemini(sonuc_df, ham_df, tedarikci_col, fiyat_col, teslim_col, iade_col):
    if not GEMINI_API_KEY: return "API yok."
    root.after(0, lambda: ai_status_label.configure(text="AI Analizi..."))
    prompt = f"TedarikÃ§i verileri:\n{sonuc_df.head(20).to_dict(orient='records')}\nLÃ¼tfen en iyi/kÃ¶tÃ¼ tedarikÃ§ileri, riskleri ve aksiyonlarÄ± yorumla."
    try:
        resp = requests.post(f"{GEMINI_API_URL}?key={GEMINI_API_KEY}", headers={"Content-Type": "application/json"}, json={"contents": [{"parts":[{"text": prompt}]}]}, timeout=120)
        return resp.json()["candidates"][0]["content"]["parts"][0]["text"].strip()
    except: return "Yorum alÄ±namadÄ±."

def update_summary_tab(num, price, deliv, ret, score, pareto_a, df=None):
    root.after(0, lambda: _update_summary_tab(num, price, deliv, ret, score, pareto_a, df))

def _update_summary_tab(num, price, deliv, ret, score, pareto_a, df=None):
    draw_dashboard(frame_ozet, {"count": num, "price": f"{price:.2f}", "delivery": f"{deliv:.2f}", "return": f"{ret:.2f}", "score": f"{score:.2f}", "pareto_a": pareto_a}, df)

def show_comparison_chart():
    if df_global is None: return
    sel = [supplier_listbox.get(i) for i in supplier_listbox.curselection()]
    if not sel: return
    sub = df_global[df_global[tedarikci_col_global].isin(sel)].copy()
    
    f = find_col_by_keywords(df_global, ["fiyat", "price"])
    t = find_col_by_keywords(df_global, ["teslim", "delivery"])
    i = find_col_by_keywords(df_global, ["iade", "return"])
    
    if not (f and t and i): return
    for c in [f, t, i]: sub[c] = pd.to_numeric(sub[c].astype(str).str.replace(',', '.'), errors='coerce')
    
    metrics = sub.groupby(tedarikci_col_global)[[f, t, i]].mean().fillna(0).T
    for w in comparison_frame.winfo_children(): w.destroy()
    fig, ax = plt.subplots(figsize=(10, 6)); metrics.plot(kind='bar', ax=ax)
    canvas = FigureCanvasTkAgg(fig, master=comparison_frame); canvas.draw(); canvas.get_tk_widget().pack(fill='both', expand=True)

def find_outliers(df, col):
    Q1 = df[col].quantile(0.25); Q3 = df[col].quantile(0.75); IQR = Q3 - Q1
    return df[(df[col] < Q1 - 1.5 * IQR) | (df[col] > Q3 + 1.5 * IQR)].copy(), Q1 - 1.5 * IQR, Q3 + 1.5 * IQR

def play_loading_gif(): ai_progress_bar.pack(pady=10, fill="x"); ai_progress_bar.start()
def stop_loading_gif(): ai_progress_bar.stop(); ai_progress_bar.pack_forget()

def analiz_et_with_options(dosyalar, filter_type, filter_value):
    """GeliÅŸtirilmiÅŸ analiz motoru: Hibrit skorlama + stok grubu bazlÄ± detaylÄ± analiz + Ã§oklu filtreleme"""
    global df_global, tedarikci_col_global, phone_col_global, sonuc_global, message_global, grafik_ozet_global, outliers_global
    global stok_grup_col_global, detay_sonuc_global, market_averages_global
    try:
        # LOG: Analiz baÅŸlatÄ±ldÄ±
        if activity_logger:
            file_names = ", ".join([os.path.basename(f) for f in dosyalar])
            filter_desc = f"{filter_type}: {filter_value}" if filter_value else "TÃ¼mÃ¼"
            activity_logger.log_analysis("TEDARIKCI_ANALIZ", f"Dosyalar: {file_names}, Filtre: {filter_desc}", "Analiz")
        
        threading.Thread(target=lambda: send_usage_log_email(f"Analiz: {len(dosyalar)} dosya")).start()
        root.after(0, lambda: ai_status_label.configure(text="Okunuyor..."))
        
        df_list = [pd.read_csv(f, dtype=str) if f.endswith('.csv') else pd.read_excel(f, dtype=str) for f in dosyalar]
        df = pd.concat(df_list, ignore_index=True)
        df_global = df.copy()
        
        # LOG: Veri yÃ¼klendi
        if activity_logger:
            activity_logger.log_data_load(file_names, len(df), "Analiz")
        
        stok_col = find_stok_kodu_column(df) or df.columns[0]
        ted_col = find_col_by_keywords(df, ["tedarik", "supplier"])
        fiyat_col = find_col_by_keywords(df, ["fiyat", "price"])
        teslim_col = find_col_by_keywords(df, ["teslim", "delivery"])
        iade_col = find_col_by_keywords(df, ["iade", "return"])
        miktar_col = find_col_by_keywords(df, ["miktar", "adet", "quantity", "qty"])
        date_col = find_col_by_keywords(df, ["tarih", "date"])
        city_col = find_col_by_keywords(df, ["ÅŸehir", "sehir", "city", "il"]) 
        mail_col = find_col_by_keywords(df, ["mail", "eposta", "e-posta", "email"]) 
        phone_col = find_col_by_keywords(df, ["telefon", "tel", "phone", "mobil", "mobile", "gsm"]) # Telefon Kolonu (YENÄ°)
        stok_grup_col = find_col_by_keywords(df, ["stok grubu", "stock group", "grup", "family", "product group", "malzeme grubu"])
        
        tedarikci_col_global = ted_col
        phone_col_global = phone_col
        stok_grup_col_global = stok_grup_col
        
        # Stok gruplarÄ±nÄ± Ã§Ä±kar ve global deÄŸiÅŸkene ata
        global all_stock_groups
        if stok_grup_col:
            try:
                unique_gruplar = sorted(df[stok_grup_col].dropna().unique())
                all_stock_groups = ["TÃ¼m Veri"] + list(unique_gruplar)
            except:
                all_stock_groups = []
        else:
            all_stock_groups = []

        # Zorunlu kolonlarÄ± kontrol et (iade_col opsiyonel)
        if not all([ted_col, fiyat_col, teslim_col]):
            # Hangi kolonlarÄ±n eksik olduÄŸunu belirle
            eksik_kolonlar = []
            if not ted_col: eksik_kolonlar.append("TedarikÃ§i (tedarik/supplier)")
            if not fiyat_col: eksik_kolonlar.append("Fiyat (fiyat/price)")
            if not teslim_col: eksik_kolonlar.append("Teslim SÃ¼resi (teslim/delivery)")
            
            hata_mesaji = "âŒ Gerekli kolonlar eksik!\n\n"
            hata_mesaji += "Eksik kolonlar:\n"
            for kolon in eksik_kolonlar:
                hata_mesaji += f"  â€¢ {kolon}\n"
            hata_mesaji += f"\nğŸ“‹ Mevcut kolonlar:\n{', '.join(df.columns[:10])}"
            if len(df.columns) > 10:
                hata_mesaji += f"... (toplam {len(df.columns)} kolon)"
            hata_mesaji += "\n\nğŸ’¡ Ã‡Ã¶zÃ¼m: MYSQL_COLUMN_MAPPINGS yapÄ±landÄ±rmasÄ±nda\nSQL kolon isimlerinizi eÅŸleÅŸtirin."
            
            messagebox.showerror("Kolonlar Eksik", hata_mesaji)
            return
        
        # Ä°ade kolonu yoksa varsayÄ±lan deÄŸerle oluÅŸtur
        if not iade_col:
            df["Ä°ade OranÄ±"] = 0.0
            iade_col = "Ä°ade OranÄ±"
            root.after(0, lambda: messagebox.showinfo("Bilgi", 
                "âš ï¸ Ä°ade OranÄ± kolonu bulunamadÄ±.\n\n"
                "Analiz devam ediyor ancak tÃ¼m iade deÄŸerleri 0 olarak kabul edilecek.\n\n"
                "ğŸ’¡ Daha doÄŸru sonuÃ§lar iÃ§in Ä°ade OranÄ± kolonunu ekleyin veya eÅŸleÅŸtirin."))

        df[stok_col] = normalize_series(df[stok_col])
        df_analiz = df.copy()
        
        if date_col and date_col in df_analiz.columns:
            df_analiz[date_col] = pd.to_datetime(df_analiz[date_col], errors='coerce')
            df_analiz.dropna(subset=[date_col], inplace=True)
            s_d = pd.to_datetime(start_date_entry.get(), format="%d-%m-%Y", errors='coerce')
            e_d = pd.to_datetime(end_date_entry.get(), format="%d-%m-%Y", errors='coerce')
            if pd.notna(s_d): df_analiz = df_analiz[df_analiz[date_col] >= s_d]
            if pd.notna(e_d): df_analiz = df_analiz[df_analiz[date_col] <= e_d]

        # Ã‡OK TÄ°PLÄ° FÄ°LTRELEME - Stok Kodu veya Stok Grubu
        if filter_value and filter_type != "none":
            if filter_type == "stock_code":
                # Stok koduna gÃ¶re filtrele
                norm_filter = str(filter_value).strip().lower()
                norm_stock_series = normalize_series(df_analiz[stok_col])
                df_analiz = df_analiz[norm_stock_series == norm_filter]
            elif filter_type == "stock_group":
                # Stok grubuna gÃ¶re filtrele
                if stok_grup_col:
                    norm_filter = str(filter_value).strip().lower()
                    norm_group_series = normalize_series(df_analiz[stok_grup_col])
                    df_analiz = df_analiz[norm_group_series == norm_filter]
                else:
                    root.after(0, lambda: messagebox.showwarning("UyarÄ±", "Veri setinde 'Stok Grubu' kolonu bulunamadÄ±."))

        if df_analiz.empty:
            root.after(0, lambda: messagebox.showwarning("UyarÄ±", "Filtreleme sonucu veri bulunamadÄ±.")); return

        for c in [fiyat_col, teslim_col, iade_col]:
            df_analiz[c] = pd.to_numeric(df_analiz[c].astype(str).str.replace(',', '.'), errors='coerce')
        
        # AYKIRI DEÄER YÃ–NETÄ°MÄ°
        outliers, lb, ub = find_outliers(df_analiz, fiyat_col)
        outliers_global = outliers
        if exclude_outliers_var.get(): 
            df_analiz = df_analiz[~df_analiz.index.isin(outliers.index)]
        
        root.after(0, lambda: ai_status_label.configure(text="HesaplanÄ±yor..."))
        
        agg_dict = {fiyat_col: "mean", teslim_col: "mean", iade_col: "mean"}
        if miktar_col: 
            df_analiz[miktar_col] = pd.to_numeric(df_analiz[miktar_col].astype(str).str.replace(',', '.'), errors='coerce')
            agg_dict[miktar_col] = "sum"
            df_analiz["_SatirTutar"] = df_analiz[fiyat_col] * df_analiz[miktar_col]
        else:
            df_analiz["_SatirTutar"] = df_analiz[fiyat_col]
        agg_dict["_SatirTutar"] = "sum"
        if mail_col:
            agg_dict[mail_col] = "first"
        if phone_col:
            agg_dict[phone_col] = "first"
        
        # Stok Grubu bazlÄ± gruplama (varsa)
        group_cols = [ted_col]
        if stok_grup_col: 
            group_cols.append(stok_grup_col)
            
        sonuc_grouped = df_analiz.groupby(group_cols).agg(agg_dict).reset_index().fillna(0)
        sonuc_grouped.rename(columns={"_SatirTutar": "ToplamTutar"}, inplace=True)

        # HÄ°BRÄ°T SKORLAMA FONKSÄ°YONU (%50 Min-Max + %50 Ranking)
        def apply_scoring(sub_df):
            # 1. Min-Max Normalizasyon (0-100)
            min_p, max_p = sub_df[fiyat_col].min(), sub_df[fiyat_col].max()
            sub_df["Min_Price"] = min_p
            sub_df["Max_Price"] = max_p
            sub_df["Raw_Price"] = 100 if max_p == min_p else ((max_p - sub_df[fiyat_col]) / (max_p - min_p)) * 100
            
            min_d, max_d = sub_df[teslim_col].min(), sub_df[teslim_col].max()
            sub_df["Min_Deliv"] = min_d
            sub_df["Max_Deliv"] = max_d
            sub_df["Raw_Deliv"] = 100 if max_d == min_d else ((max_d - sub_df[teslim_col]) / (max_d - min_d)) * 100
            
            min_r, max_r = sub_df[iade_col].min(), sub_df[iade_col].max()
            sub_df["Min_Return"] = min_r
            sub_df["Max_Return"] = max_r
            sub_df["Raw_Return"] = 100 if max_r == min_r else ((max_r - sub_df[iade_col]) / (max_r - min_r)) * 100
            
            # 2. SÄ±ralama BazlÄ± Skorlama (0-100)
            n = len(sub_df)
            if n > 1:
                sub_df["Rank_Price"] = (n - sub_df[fiyat_col].rank(method='min')) / (n - 1) * 100
                sub_df["Rank_Deliv"] = (n - sub_df[teslim_col].rank(method='min')) / (n - 1) * 100
                sub_df["Rank_Return"] = (n - sub_df[iade_col].rank(method='min')) / (n - 1) * 100
            else:
                sub_df["Rank_Price"] = 100
                sub_df["Rank_Deliv"] = 100
                sub_df["Rank_Return"] = 100

            # 3. Hibrit Skor (%50 + %50)
            sub_df["Score_Price"] = 0.5 * sub_df["Raw_Price"] + 0.5 * sub_df["Rank_Price"]
            sub_df["Score_Deliv"] = 0.5 * sub_df["Raw_Deliv"] + 0.5 * sub_df["Rank_Deliv"]
            sub_df["Score_Return"] = 0.5 * sub_df["Raw_Return"] + 0.5 * sub_df["Rank_Return"]
            
            # 4. AÄŸÄ±rlÄ±klÄ± Toplam Skor
            total_w = price_weight.get() + delivery_weight.get() + return_weight.get()
            if total_w == 0: total_w = 1
            sub_df["Skor"] = (sub_df["Score_Price"] * price_weight.get() + 
                             sub_df["Score_Deliv"] * delivery_weight.get() + 
                             sub_df["Score_Return"] * return_weight.get()) / total_w
            return sub_df

        # Skorlama: Stok grubu varsa grup iÃ§inde, yoksa global
        if stok_grup_col:
            # Pazar ortalamalarÄ± (kÄ±yaslama iÃ§in)
            market_averages_global = df_analiz.groupby(stok_grup_col)[[fiyat_col, teslim_col, iade_col]].mean()
            sonuc_grouped = sonuc_grouped.groupby(stok_grup_col, group_keys=False).apply(apply_scoring)
        else:
            sonuc_grouped = apply_scoring(sonuc_grouped)

        # DetaylÄ± sonuÃ§larÄ± sakla (karne iÃ§in)
        detay_sonuc_global = sonuc_grouped.copy()

        # Ana liste iÃ§in tedarikÃ§i bazÄ±nda topla (aÄŸÄ±rlÄ±klÄ± ortalama)
        def weighted_avg(x, df, w_col):
            try:
                return np.average(x, weights=df.loc[x.index, w_col])
            except:
                return x.mean()

        if stok_grup_col:
            sonuc_main = sonuc_grouped.groupby(ted_col).agg({
                fiyat_col: lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                teslim_col: lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                iade_col: lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                "Skor": lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                "Score_Price": lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                "Score_Deliv": lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                "Score_Return": lambda x: weighted_avg(x, sonuc_grouped, "ToplamTutar"),
                "ToplamTutar": "sum"
            }).reset_index()
            if mail_col:
                mail_map = df_analiz.groupby(ted_col)[mail_col].first()
                sonuc_main[mail_col] = sonuc_main[ted_col].map(mail_map)
            if phone_col:
                phone_map = df_analiz.groupby(ted_col)[phone_col].first()
                sonuc_main[phone_col] = sonuc_main[ted_col].map(phone_map)
        else:
            sonuc_main = sonuc_grouped.copy()

        # Pareto sÄ±nÄ±flandÄ±rmasÄ± (ciroya gÃ¶re)
        sonuc_main = sonuc_main.sort_values("ToplamTutar", ascending=False)
        sonuc_main["KumulatifYuzde"] = 100 * sonuc_main["ToplamTutar"].cumsum() / sonuc_main["ToplamTutar"].sum()
        
        def pareto_sinif(yuzde):
            return "A" if yuzde <= 80 else "B" if yuzde <= 95 else "C"
        sonuc_main["Pareto_Sinifi"] = sonuc_main["KumulatifYuzde"].apply(pareto_sinif)
        
        sonuc_global = sonuc_main.copy()
        
        update_summary_tab(len(sonuc_main), sonuc_main[fiyat_col].mean(), sonuc_main[teslim_col].mean(), 
                          sonuc_main[iade_col].mean(), sonuc_main["Skor"].mean(), 
                          len(sonuc_main[sonuc_main["Pareto_Sinifi"] == "A"]), sonuc_main)
        
        mesaj = yapay_zeka_analizi_gemini(sonuc_main, df_analiz, ted_col, fiyat_col, teslim_col, iade_col)
        message_global = mesaj
        
        update_supplier_details_tab(df_global, tedarikci_col_global)
        
        if date_col: 
            root.after(0, lambda: update_trend_tab(df_analiz, date_col, fiyat_col, miktar_col))
            root.after(0, lambda: update_forecast_tab(df_analiz, date_col, fiyat_col))
        else: 
            root.after(0, lambda: tk.Label(frame_trend, text="Veride tarih kolonu bulunamadÄ±.", font=("Arial", 12)).pack(pady=20))

        if city_col:
            root.after(0, lambda: update_map_with_suppliers(df_analiz, city_col, ted_col))
        elif MAP_AVAILABLE:
            root.after(0, lambda: messagebox.showinfo("Bilgi", "Veride 'Ä°l' veya 'Åehir' kolonu bulunamadÄ±ÄŸÄ± iÃ§in harita oluÅŸturulamadÄ±."))

        root.after(0, lambda: update_listbox(sorted(df_analiz[ted_col].unique())))
        
        if karne_combobox:
             root.after(0, lambda: karne_combobox.configure(values=sorted(sonuc_main[ted_col].unique())))
        
        if siparis_stok_combobox and all_stock_codes:
             root.after(0, lambda: siparis_stok_combobox.configure(values=all_stock_codes))
        
        if siparis_grup_combobox and all_stock_groups:
             root.after(0, lambda: siparis_grup_combobox.configure(values=all_stock_groups))

        if negotiator_combobox:
             root.after(0, lambda: negotiator_combobox.configure(values=sorted(sonuc_main[ted_col].unique())))
        
        # Eksik-Fazla YÃ¼klemeler sekmesini gÃ¼ncelle
        root.after(0, update_eksik_fazla_suppliers)

        update_ai_comment_tab(mesaj, sonuc_main.sort_values("Skor", ascending=False).head(7))
        
        root.after(0, lambda: show_page("YÃ¶netim Paneli"))
        root.after(0, lambda: messagebox.showinfo("Tamam", "Analiz bitti."))
        root.after(0, lambda: ai_status_label.configure(text="HazÄ±r."))
        
    except Exception as e:
        root.after(0, lambda: messagebox.showerror("Hata", str(e)))
        root.after(0, lambda: ai_status_label.configure(text="Hata"))
    finally:
        root.after(0, stop_loading_gif)

def update_listbox(items):
    supplier_listbox.delete(0, tk.END); [supplier_listbox.insert(tk.END, i) for i in items]

def update_weights(val=None):
    price_label.configure(text=f"Fiyat: {price_weight.get():.2f}")
    delivery_label.configure(text=f"Teslim: {delivery_weight.get():.2f}")
    return_label.configure(text=f"Ä°ade: {return_weight.get():.2f}")

def save_outliers_to_excel():
    if outliers_global is None or outliers_global.empty:
        messagebox.showinfo("Bilgi", "Herhangi bir aykÄ±rÄ± deÄŸer bulunamadÄ± veya henÃ¼z analiz yapÄ±lmadÄ±.")
        return
        
    f = filedialog.asksaveasfilename(defaultextension=".xlsx", filetypes=[("Excel", "*.xlsx")])
    if f:
        try:
            outliers_global.to_excel(f, index=False)
            messagebox.showinfo("BaÅŸarÄ±lÄ±", f"AykÄ±rÄ± deÄŸerler kaydedildi.\nDosya: {os.path.basename(f)}")
        except Exception as e:
            messagebox.showerror("Hata", str(e))

class MyEventHandler(FileSystemEventHandler):
    def on_created(self, event):
        if not event.is_directory and event.src_path.lower().endswith(('.xlsx', '.csv')):
            set_status(f"Yeni dosya: {os.path.basename(event.src_path)}")
            # Otomatik dosya yÃ¼kleme
            self._auto_load_file(event.src_path)
    
    def _auto_load_file(self, file_path):
        """Yeni dosyayÄ± otomatik olarak yÃ¼kler"""
        global file_paths_global, all_stock_codes
        try:
            # Dosya tam yazÄ±lana kadar kÄ±sa bir bekleme
            import time
            time.sleep(0.5)
            
            # DosyayÄ± file_paths_global'e ekle
            file_paths_global = [file_path]
            root.after(0, lambda: set_status(f"{os.path.basename(file_path)} otomatik yÃ¼klendi."))
            
            # Stok kodlarÄ±nÄ± Ã§Ä±kar
            try:
                df_temp = pd.read_csv(file_path, dtype=str) if file_path.endswith('.csv') else pd.read_excel(file_path, dtype=str)
                stok_col_temp = find_stok_kodu_column(df_temp)
                if stok_col_temp:
                    unique_kodlar = sorted(df_temp[stok_col_temp].dropna().unique())
                    all_stock_codes = ["TÃ¼m Veri"] + list(unique_kodlar)
                    root.after(0, lambda: stok_kod_combobox.configure(values=all_stock_codes, state="normal"))
                    root.after(0, lambda: stok_kod_combobox.set("TÃ¼m Veri"))
                    
                    # LOG: Otomatik yÃ¼kleme
                    if activity_logger:
                        activity_logger.log_event("AUTO_FILE_LOAD", f"Dosya: {os.path.basename(file_path)}, Stok sayÄ±sÄ±: {len(unique_kodlar)}", "Analiz")
            except Exception as e:
                root.after(0, lambda: set_status(f"Dosya yÃ¼klendi ama stok kodlarÄ± Ã§Ä±karÄ±lamadÄ±: {str(e)}"))
                if activity_logger:
                    activity_logger.log_error(f"Stok kodu Ã§Ä±karma hatasÄ±: {str(e)}", "Analiz")
                    
        except Exception as e:
            root.after(0, lambda: set_status(f"Dosya yÃ¼kleme hatasÄ±: {str(e)}"))
            if activity_logger:
                activity_logger.log_error(f"Otomatik dosya yÃ¼kleme hatasÄ±: {str(e)}", "Analiz")

def start_monitoring():
    global observer, monitoring_folder
    monitoring_folder_temp = filedialog.askdirectory(title="Ä°zlemek iÃ§in klasÃ¶r seÃ§in")
    if monitoring_folder_temp:
        monitoring_folder = monitoring_folder_temp
        _start_monitoring_internal()
        # KlasÃ¶r ayarÄ±nÄ± kaydet
        save_settings()

def auto_start_monitoring():
    """KaydedilmiÅŸ klasÃ¶rÃ¼ otomatik olarak izlemeye baÅŸla"""
    global monitoring_folder
    if monitoring_folder and os.path.exists(monitoring_folder):
        print(f"Otomatik klasÃ¶r izleme baÅŸlatÄ±lÄ±yor: {monitoring_folder}")
        _start_monitoring_internal()

def _start_monitoring_internal():
    """KlasÃ¶r izlemeyi baÅŸlat (iÃ§ fonksiyon)"""
    global observer, monitoring_folder
    if not monitoring_folder:
        return
    
    set_status(f"'{os.path.basename(monitoring_folder)}' izleniyor...")
    event_handler = MyEventHandler()
    observer = Observer()
    observer.schedule(event_handler, monitoring_folder, recursive=False)
    observer.start()
    try:
        start_button.configure(state="disabled")
        stop_button.configure(state="normal")
    except: 
        pass

def stop_monitoring():
    global observer, monitoring_folder
    if observer:
        observer.stop()
        observer.join()
        set_status("KlasÃ¶r izleme durduruldu.")
        try:
            start_button.configure(state="normal")
            stop_button.configure(state="disabled")
        except: 
            pass
    # KlasÃ¶r ayarÄ±nÄ± kaldÄ±r
    monitoring_folder = None
    save_settings()

def clean_phone_number(phone_number):
    """
    Telefon numarasÄ±nÄ± temizler ve uluslararasÄ± formata Ã§evirir.
    
    Args:
        phone_number: Temizlenecek telefon numarasÄ± (str)
    
    Returns:
        str: TemizlenmiÅŸ ve formatlanmÄ±ÅŸ telefon numarasÄ± (+90XXXXXXXXXX)
        None: GeÃ§ersiz numara durumunda
    
    Example:
        clean_phone_number("0555 123 45 67") -> "905551234567"
        clean_phone_number("+90 555 123 45 67") -> "905551234567"
    """
    if not phone_number:
        return None
    
    # Sadece rakamlar ve + iÅŸaretini tut
    clean_phone = ''.join(c for c in str(phone_number) if c.isdigit() or c == '+')
    
    if not clean_phone:
        return None
    
    # + iÅŸaretini kaldÄ±r (Ã¼lke kodu ayrÄ± ekleneceÄŸi iÃ§in)
    clean_phone = clean_phone.replace('+', '')
    
    # EÄŸer 0 ile baÅŸlÄ±yorsa, ilk 0'Ä± kaldÄ±r
    if clean_phone.startswith('0'):
        clean_phone = clean_phone[1:]
    
    # EÄŸer 90 ile baÅŸlamÄ±yorsa, TÃ¼rkiye kodu ekle
    if not clean_phone.startswith('90'):
        clean_phone = '90' + clean_phone
    
    return clean_phone

def make_phone_call(supplier_name, phone_number):
    """Telefon aramasÄ± baÅŸlat (tel: URL scheme)"""
    try:
        # Telefon numarasÄ±nÄ± temizle
        clean_phone = clean_phone_number(phone_number)
        
        if not clean_phone:
            messagebox.showerror("Hata", "GeÃ§erli bir telefon numarasÄ± bulunamadÄ±.")
            return
        
        # tel: URL scheme kullanarak arama baÅŸlat
        tel_url = f"tel:{clean_phone}"
        webbrowser.open(tel_url)
        
        # LOG: Telefon aramasÄ±
        if activity_logger:
            activity_logger.log_phone_call(supplier_name, clean_phone, "Detaylar")
        
        # Email bildirimi gÃ¶nder (arka planda)
        def send_notification():
            try:
                subject = f"Telefon AramasÄ± YapÄ±ldÄ± - {supplier_name}"
                body = f"""
TedarikÃ§i Ä°letiÅŸim Bildirimi

TedarikÃ§i: {supplier_name}
Telefon: {clean_phone}
Ä°ÅŸlem ZamanÄ±: {datetime.datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
KullanÄ±cÄ±: {activity_logger.user_name if activity_logger else 'Bilinmiyor'}
Makine: {activity_logger.machine_name if activity_logger else 'Bilinmiyor'}

Bu bir otomatik bildirimdir.
                """
                send_email_with_attachments(GMAIL_RECEIVER_LOGS, subject, body, [])
            except Exception as email_error:
                # Email gÃ¶nderim hatasÄ± - loglama ve kullanÄ±cÄ±ya bilgi
                if activity_logger:
                    activity_logger.log_error(f"Email bildirimi gÃ¶nderilemedi: {str(email_error)}", "Detaylar")
                print(f"Email bildirimi hatasÄ±: {email_error}")  # Console log

        
        threading.Thread(target=send_notification, daemon=True).start()
        
        messagebox.showinfo("Arama BaÅŸlatÄ±ldÄ±", f"{supplier_name} iÃ§in arama baÅŸlatÄ±ldÄ±.\nTelefon: {clean_phone}")
        
    except Exception as e:
        if activity_logger:
            activity_logger.log_error(f"Telefon aramasÄ± hatasÄ±: {str(e)}", "Detaylar")
        messagebox.showerror("Hata", f"Arama baÅŸlatÄ±lamadÄ±: {str(e)}")

def send_whatsapp_message(supplier_name, phone_number):
    """WhatsApp mesajÄ± gÃ¶nder (WhatsApp Web URL scheme)"""
    try:
        # Telefon numarasÄ±nÄ± temizle ve uluslararasÄ± formata Ã§evir
        clean_phone = clean_phone_number(phone_number)
        
        if not clean_phone:
            messagebox.showerror("Hata", "GeÃ§erli bir telefon numarasÄ± bulunamadÄ±.")
            return
        
        # Mesaj iÃ§eriÄŸini kullanÄ±cÄ±dan al
        msg_window = tk.Toplevel()
        msg_window.title(f"WhatsApp MesajÄ± - {supplier_name}")
        msg_window.geometry("500x400")
        
        tk.Label(msg_window, text=f"AlÄ±cÄ±: {supplier_name}", font=("Segoe UI", 12, "bold")).pack(pady=10)
        tk.Label(msg_window, text=f"Telefon: {clean_phone}", font=("Segoe UI", 10)).pack(pady=5)
        
        tk.Label(msg_window, text="MesajÄ±nÄ±z:", font=("Segoe UI", 10)).pack(pady=10)
        msg_text = tk.Text(msg_window, wrap="word", font=("Segoe UI", 10), height=10)
        msg_text.pack(fill="both", expand=True, padx=20, pady=10)
        
        # VarsayÄ±lan mesaj ÅŸablonu
        default_message = f"Merhaba {supplier_name},\n\nTedarik zinciri ekibi olarak sizinle iletiÅŸime geÃ§mek istedik.\n\nSaygÄ±larÄ±mÄ±zla,\nDeFacto Tedarik Ekibi"
        msg_text.insert("1.0", default_message)
        
        def send_msg():
            message_content = msg_text.get("1.0", tk.END).strip()
            if not message_content:
                messagebox.showwarning("UyarÄ±", "LÃ¼tfen bir mesaj yazÄ±n.")
                return
            
            # WhatsApp Web URL oluÅŸtur
            # + iÅŸaretini URL encoding yap
            phone_for_url = clean_phone.replace('+', '')
            import urllib.parse
            encoded_message = urllib.parse.quote(message_content)
            whatsapp_url = f"https://wa.me/{phone_for_url}?text={encoded_message}"
            
            # WhatsApp Web'i aÃ§
            webbrowser.open(whatsapp_url)
            
            # LOG: WhatsApp mesajÄ±
            if activity_logger:
                activity_logger.log_whatsapp_message(supplier_name, clean_phone, message_content, "Detaylar")
            
            # Email bildirimi gÃ¶nder (arka planda)
            def send_notification():
                try:
                    subject = f"WhatsApp MesajÄ± GÃ¶nderildi - {supplier_name}"
                    body = f"""
TedarikÃ§i Ä°letiÅŸim Bildirimi

TedarikÃ§i: {supplier_name}
Telefon: {clean_phone}
Ä°ÅŸlem ZamanÄ±: {datetime.datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
KullanÄ±cÄ±: {activity_logger.user_name if activity_logger else 'Bilinmiyor'}
Makine: {activity_logger.machine_name if activity_logger else 'Bilinmiyor'}

Mesaj Ä°Ã§eriÄŸi:
{message_content}

Bu bir otomatik bildirimdir.
                    """
                    send_email_with_attachments(GMAIL_RECEIVER_LOGS, subject, body, [])
                except Exception as email_error:
                    # Email gÃ¶nderim hatasÄ± - loglama ve kullanÄ±cÄ±ya bilgi
                    if activity_logger:
                        activity_logger.log_error(f"Email bildirimi gÃ¶nderilemedi: {str(email_error)}", "Detaylar")
                    print(f"Email bildirimi hatasÄ±: {email_error}")  # Console log
            
            threading.Thread(target=send_notification, daemon=True).start()
            
            msg_window.destroy()
            messagebox.showinfo("Mesaj GÃ¶nderildi", f"{supplier_name} iÃ§in WhatsApp Web aÃ§Ä±ldÄ±.\n\nLÃ¼tfen WhatsApp Web'den mesajÄ±nÄ±zÄ± gÃ¶nderin.")
        
        btn_frame = tk.Frame(msg_window)
        btn_frame.pack(fill="x", pady=10, padx=20)
        ttk.Button(btn_frame, text="âŒ Ä°ptal", command=msg_window.destroy).pack(side="left", padx=5)
        ttk.Button(btn_frame, text="ğŸ“¤ WhatsApp'ta GÃ¶nder", command=send_msg).pack(side="right", padx=5)
        
    except Exception as e:
        if activity_logger:
            activity_logger.log_error(f"WhatsApp mesajÄ± hatasÄ±: {str(e)}", "Detaylar")
        messagebox.showerror("Hata", f"WhatsApp mesajÄ± gÃ¶nderilemedi: {str(e)}")

def search_suppliers_by_phone():
    """Telefon numarasÄ±na gÃ¶re tedarikÃ§i ara"""
    if df_global is None or tedarikci_col_global is None:
        messagebox.showwarning("UyarÄ±", "LÃ¼tfen Ã¶nce veri yÃ¼kleyin ve analiz yapÄ±n.")
        return
    
    if phone_col_global is None or phone_col_global not in df_global.columns:
        messagebox.showwarning("UyarÄ±", "Veride telefon kolonu bulunamadÄ±.\n\nLÃ¼tfen veri dosyanÄ±zda 'Telefon', 'Tel', 'Phone', 'Mobil' veya 'GSM' baÅŸlÄ±klÄ± bir kolon olduÄŸundan emin olun.")
        return
    
    # Arama penceresi
    search_window = tk.Toplevel()
    search_window.title("Telefon ile TedarikÃ§i Ara")
    search_window.geometry("700x500")
    
    tk.Label(search_window, text="ğŸ“ Telefon ile TedarikÃ§i Arama", font=("Segoe UI", 14, "bold")).pack(pady=10)
    
    search_frame = tk.Frame(search_window)
    search_frame.pack(fill="x", padx=20, pady=10)
    
    tk.Label(search_frame, text="Telefon NumarasÄ±:", font=("Segoe UI", 10)).pack(side="left", padx=5)
    phone_entry = ttk.Entry(search_frame, width=30)
    phone_entry.pack(side="left", padx=5)
    
    result_frame = tk.Frame(search_window)
    result_frame.pack(fill="both", expand=True, padx=20, pady=10)
    
    # Treeview oluÅŸtur
    tree = ttk.Treeview(result_frame, show='headings', height=15)
    vsb = ttk.Scrollbar(result_frame, orient="vertical", command=tree.yview)
    tree.configure(yscrollcommand=vsb.set)
    
    tree.grid(column=0, row=0, sticky='nsew')
    vsb.grid(column=1, row=0, sticky='ns')
    result_frame.grid_columnconfigure(0, weight=1)
    result_frame.grid_rowconfigure(0, weight=1)
    
    def do_search():
        # Treeview'i temizle
        for i in tree.get_children():
            tree.delete(i)
        
        search_text = phone_entry.get().strip()
        if not search_text:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen bir telefon numarasÄ± girin.")
            return
        
        # Telefon numarasÄ±nda ara
        df_filtered = df_global[df_global[phone_col_global].astype(str).str.contains(search_text, na=False, case=False)]
        
        if df_filtered.empty:
            messagebox.showinfo("SonuÃ§", f"'{search_text}' iÃ§eren telefon numarasÄ± bulunamadÄ±.")
            return
        
        # TedarikÃ§i bazÄ±nda grupla
        suppliers = df_filtered.groupby(tedarikci_col_global).agg({
            phone_col_global: 'first'
        }).reset_index()
        
        # KolonlarÄ± ayarla
        cols = [tedarikci_col_global, phone_col_global]
        tree['columns'] = cols
        
        for col in cols:
            tree.heading(col, text=col)
            tree.column(col, width=200)
        
        # SonuÃ§larÄ± gÃ¶ster
        for row in suppliers.itertuples(index=False):
            tree.insert('', 'end', values=row)
        
        messagebox.showinfo("SonuÃ§", f"{len(suppliers)} tedarikÃ§i bulundu.")
    
    def on_double_click(event):
        """Ã‡ift tÄ±klamada seÃ§ili tedarikÃ§i iÃ§in iÅŸlem menÃ¼sÃ¼ gÃ¶ster"""
        selection = tree.selection()
        if not selection:
            return
        
        item = tree.item(selection[0])
        values = item['values']
        
        if len(values) < 2:
            return
        
        supplier_name = values[0]
        phone_number = values[1]
        
        # Ä°ÅŸlem menÃ¼sÃ¼
        action_menu = tk.Toplevel()
        action_menu.title(f"Ä°ÅŸlemler - {supplier_name}")
        action_menu.geometry("400x200")
        
        tk.Label(action_menu, text=f"TedarikÃ§i: {supplier_name}", font=("Segoe UI", 12, "bold")).pack(pady=10)
        tk.Label(action_menu, text=f"Telefon: {phone_number}", font=("Segoe UI", 10)).pack(pady=5)
        
        ttk.Button(action_menu, text="ğŸ“ Ara", 
                  command=lambda: [make_phone_call(supplier_name, phone_number), action_menu.destroy()]).pack(fill="x", padx=50, pady=5)
        ttk.Button(action_menu, text="ğŸ’¬ WhatsApp GÃ¶nder", 
                  command=lambda: [send_whatsapp_message(supplier_name, phone_number), action_menu.destroy()]).pack(fill="x", padx=50, pady=5)
        ttk.Button(action_menu, text="âŒ Ä°ptal", command=action_menu.destroy).pack(fill="x", padx=50, pady=5)
    
    tree.bind("<Double-1>", on_double_click)
    
    btn_frame = tk.Frame(search_window)
    btn_frame.pack(fill="x", padx=20, pady=10)
    
    ttk.Button(btn_frame, text="ğŸ” Ara", command=do_search).pack(side="left", padx=5)
    ttk.Button(btn_frame, text="âŒ Kapat", command=search_window.destroy).pack(side="right", padx=5)
    
    # Enter tuÅŸu ile arama
    phone_entry.bind("<Return>", lambda e: do_search())

def dosyalarÄ±_sec():
    global file_paths_global, all_stock_codes, all_stock_groups
    file_paths = filedialog.askopenfilenames(filetypes=[("Excel/CSV", "*.*")])
    if file_paths:
        file_paths_global = list(file_paths)
        set_status(f"{len(file_paths_global)} adet dosya seÃ§ildi.")
        try:
             df_temp = pd.read_csv(file_paths[0], dtype=str) if file_paths[0].endswith('.csv') else pd.read_excel(file_paths[0], dtype=str)
             stok_col_temp = find_stok_kodu_column(df_temp)
             if stok_col_temp:
                unique_kodlar = sorted(df_temp[stok_col_temp].dropna().unique())
                all_stock_codes = ["TÃ¼m Veri"] + list(unique_kodlar)
                stok_kod_combobox['values'] = all_stock_codes
                stok_kod_combobox.set("TÃ¼m Veri")
                stok_kod_combobox.configure(state="normal")
             
             # Stok gruplarÄ±nÄ± Ã§Ä±kar
             stok_grup_temp = find_col_by_keywords(df_temp, ["stok grubu", "stock group", "grup", "family", "product group", "malzeme grubu"])
             if stok_grup_temp:
                unique_gruplar = sorted(df_temp[stok_grup_temp].dropna().unique())
                all_stock_groups = ["TÃ¼m Veri"] + list(unique_gruplar)
                stok_grup_filter_combobox['values'] = all_stock_groups
        except:
            pass

def filter_stock_codes(event):
    if not all_stock_codes:
        return
    typed_text = event.widget.get().lower()
    if typed_text == "":
        stok_kod_combobox['values'] = all_stock_codes
    else:
        filtered_list = [item for item in all_stock_codes if typed_text in str(item).lower()]
        stok_kod_combobox['values'] = filtered_list

def start_analysis_threaded():
    global file_paths_global
    if not file_paths_global:
        messagebox.showerror("Hata", "LÃ¼tfen Ã¶nce dosya seÃ§in.")
        return
    
    ai_progress_bar.pack(pady=10, fill="x")
    ai_progress_bar.start()
    play_loading_gif()

    # Filtreleme tipini ve deÄŸerini al
    filter_type = analiz_filter_type_var.get()
    filter_value = ""
    
    if filter_type == "stock_code":
        filter_value = stok_kod_combobox.get()
        if filter_value == "TÃ¼m Veri":
            filter_value = ""
    elif filter_type == "stock_group":
        filter_value = stok_grup_filter_combobox.get()
        if filter_value == "TÃ¼m Veri":
            filter_value = ""
    # filter_type == "none" iÃ§in filter_value boÅŸ kalÄ±r

    analysis_thread = threading.Thread(
        target=lambda: analiz_et_with_options(file_paths_global, filter_type, filter_value)
    )
    analysis_thread.daemon = True
    analysis_thread.start()

def export_all_data():
    global df_global
    if df_global is None:
        messagebox.showerror("Hata", "Veri yok.")
        return
    export_data(df_global, "xlsx", sheet_name="Ham Veri")

# ---------- STOK YÃ–NETÄ°MÄ° FONKSÄ°YONLARI ----------
def init_stok_tab():
    """Stok yÃ¶netimi sekmesini baÅŸlatÄ±r"""
    global df_stok_global
    
    for widget in frame_stok.winfo_children():
        widget.destroy()
    
    # BaÅŸlÄ±k
    header = tk.Frame(frame_stok, bg="#2c3e50", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="ğŸ­ Defacto Ãœretim RaporlarÄ±", font=("Segoe UI", 18, "bold"), 
             fg="white", bg="#2c3e50").pack(anchor="w")
    tk.Label(header, text="Profesyonel Ã¼retim takip ve raporlama sistemi", 
             font=("Segoe UI", 10), fg="#ecf0f1", bg="#2c3e50").pack(anchor="w")
    
    # Ä°Ã§erik alanÄ±
    content = tk.Frame(frame_stok, padx=15, pady=15, bg="#ecf0f1")
    content.pack(fill="both", expand=True)
    
    # YardÄ±mcÄ± fonksiyonlar
    def darken_color(hex_color):
        """Rengi koyulaÅŸtÄ±r"""
        hex_color = hex_color.lstrip('#')
        r, g, b = tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))
        r = max(0, int(r * 0.7))
        g = max(0, int(g * 0.7))
        b = max(0, int(b * 0.7))
        return f'#{r:02x}{g:02x}{b:02x}'
    
    def create_report_button(parent, text, link, color):
        """ÅÄ±k rapor butonu oluÅŸtur"""
        def open_link():
            import webbrowser
            webbrowser.open(link)
            if activity_logger:
                activity_logger.log_activity(f"{text} aÃ§Ä±ldÄ±", "Defacto Ãœretim RaporlarÄ±")
        
        btn = tk.Button(
            parent,
            text=text,
            font=("Segoe UI", 10, "bold"),
            bg=color,
            fg="white",
            activebackground=darken_color(color),
            activeforeground="white",
            relief="raised",
            bd=2,
            cursor="hand2",
            padx=12,
            pady=10,
            command=open_link
        )
        btn.pack(fill="both", expand=True, pady=4)
        
        # Hover efektleri
        darker = darken_color(color)
        def on_enter(e):
            btn.config(bg=darker, font=("Segoe UI", 11, "bold"))
        
        def on_leave(e):
            btn.config(bg=color, font=("Segoe UI", 10, "bold"))
        
        btn.bind("<Enter>", on_enter)
        btn.bind("<Leave>", on_leave)
        
        return btn
    
    # Ana grid container - 3 eÅŸit sÃ¼tun
    main_grid = tk.Frame(content, bg="#ecf0f1")
    main_grid.pack(fill="both", expand=True)
    main_grid.grid_columnconfigure(0, weight=1, uniform="col")
    main_grid.grid_columnconfigure(1, weight=1, uniform="col")
    main_grid.grid_columnconfigure(2, weight=1, uniform="col")
    
    # 1. RAPORLAR BÃ–LÃœMÃœ (Sol)
    reports_frame = tk.LabelFrame(
        main_grid, 
        text="ğŸ“Š RAPORLAR", 
        font=("Segoe UI", 13, "bold"),
        bg="white",
        fg="#2c3e50",
        padx=12,
        pady=12,
        relief="solid",
        bd=2
    )
    reports_frame.grid(row=0, column=0, padx=5, pady=5, sticky="nsew")
    
    # Raporlar listesi
    reports_list = [
        ("ğŸ“Š Stok Risk Raporu", "https://drive.google.com/drive/folders/0AAOTHYnHn5W6Uk9PVA", "#e74c3c"),
        ("ğŸ“ˆ ABC (Pareto) Stok", "https://drive.google.com/drive/folders/0AN3M8nD1sYoxUk9PVA", "#3498db"),
        ("âœ‚ï¸ Kesim Bekleyen KumaÅŸlar", "https://drive.google.com/drive/folders/0AKlwNnWGHfLxUk9PVA", "#9b59b6"),
        ("ğŸ”„ AktarÄ±m Bekleyen Orderlar", "https://drive.google.com/drive/folders/0AG84uaK9yXNbUk9PVA", "#e67e22"),
        ("ğŸ“‹ Stok Hareket Raporu", "https://drive.google.com/drive/folders/0AMBu85Fby69mUk9PVA", "#1abc9c"),
        ("ğŸ‘— Dikili Kalan ÃœrÃ¼nler", "https://drive.google.com/drive/folders/0AFNhNFxnZJelUk9PVA", "#16a085"),
        ("ğŸ“‚ Ticari ÃœrÃ¼n Dosya Takibi", "https://docs.google.com/spreadsheets/d/1P-ipmcYfHZgN3Ds1y_X4slIad-X4MfOv/edit?gid=997396063#gid=997396063", "#2980b9")
    ]
    
    for btn_text, btn_link, btn_color in reports_list:
        create_report_button(reports_frame, btn_text, btn_link, btn_color)
    
    # 2. FORMLAR BÃ–LÃœMÃœ (Orta)
    forms_frame = tk.LabelFrame(
        main_grid, 
        text="ğŸ“ FORMLAR", 
        font=("Segoe UI", 13, "bold"),
        bg="white",
        fg="#27ae60",
        padx=12,
        pady=12,
        relief="solid",
        bd=2
    )
    forms_frame.grid(row=0, column=1, padx=5, pady=5, sticky="nsew")
    
    # Formlar listesi
    forms_list = [
        ("ğŸ“ KumaÅŸ Teklif Alma Formu", "https://docs.google.com/forms/d/e/1FAIpQLSf3usmhN_SmM_joVM6U_duSeap14mheAGXwLnzveboCOMMabA/viewform?usp=header", "#27ae60"),
        ("ğŸ”¥ Fire KumaÅŸ Talep Formu", "https://docs.google.com/forms/d/e/1FAIpQLScZA2Gsw_B8rv6r6cUxC71dX5hXZPZpQc4Fi7WgmxgOjAbTkg/viewform?usp=header", "#c0392b")
    ]
    
    for btn_text, btn_link, btn_color in forms_list:
        create_report_button(forms_frame, btn_text, btn_link, btn_color)
    
    # 3. RESÄ°MLER BÃ–LÃœMÃœ (SaÄŸ)
    images_frame = tk.LabelFrame(
        main_grid, 
        text="ğŸ–¼ï¸ RESÄ°MLER", 
        font=("Segoe UI", 13, "bold"),
        bg="white",
        fg="#34495e",
        padx=12,
        pady=12,
        relief="solid",
        bd=2
    )
    images_frame.grid(row=0, column=2, padx=5, pady=5, sticky="nsew")
    
    # Resimler listesi
    images_list = [
        ("ğŸ–¼ï¸ Order Resimleri", "https://drive.google.com/drive/folders/1mw1QjBCPo9iBhA7tNkIOigJvatqkgI0-", "#34495e")
    ]
    
    for btn_text, btn_link, btn_color in images_list:
        create_report_button(images_frame, btn_text, btn_link, btn_color)
    
    # Bilgi notu (alt kÄ±sÄ±m)
    info_frame = tk.Frame(content, bg="#ecf0f1", pady=10)
    info_frame.pack(side="bottom", fill="x")
    
    info_label = tk.Label(
        info_frame,
        text="ğŸ’¡ Raporlara eriÅŸmek iÃ§in Google hesabÄ±nÄ±zla giriÅŸ yapmanÄ±z gerekebilir",
        font=("Segoe UI", 9, "italic"),
        fg="#7f8c8d",
        bg="#ecf0f1"
    )
    info_label.pack()
    
    # Not: MySQL mesajÄ±nÄ± kaldÄ±rdÄ±k - artÄ±k gÃ¶sterilmeyecek
    if False:  # Bu blok artÄ±k hiÃ§ Ã§alÄ±ÅŸmayacak
        # Veri var - Ã¶zet istatistikler
        stats_frame = tk.Frame(content, bg="white", bd=1, relief="solid", padx=20, pady=15)
        stats_frame.pack(fill="x", pady=10)
        
        tk.Label(stats_frame, text="ğŸ“Š Ã–zet Ä°statistikler", font=("Segoe UI", 12, "bold"), 
                bg="white").pack(anchor="w", pady=(0,10))
        
        # Ä°statistik kartlarÄ±
        stats_grid = tk.Frame(stats_frame, bg="white")
        stats_grid.pack(fill="x")
        
        # Toplam kayÄ±t sayÄ±sÄ±
        card1 = tk.Frame(stats_grid, bg="#e8f5e9", padx=15, pady=10, bd=1, relief="solid")
        card1.pack(side="left", padx=5, expand=True, fill="both")
        tk.Label(card1, text="Toplam KayÄ±t", font=("Segoe UI", 9), bg="#e8f5e9", fg="gray").pack()
        tk.Label(card1, text=f"{len(df_stok_global):,}", font=("Segoe UI", 16, "bold"), 
                bg="#e8f5e9", fg="#27ae60").pack()
        
        # EÄŸer stok miktarÄ± kolonu varsa
        stok_miktar_col = find_col_by_keywords(df_stok_global, ["miktar", "quantity", "qty", "adet", "stok"])
        if stok_miktar_col:
            try:
                total_qty = pd.to_numeric(df_stok_global[stok_miktar_col], errors='coerce').sum()
                card2 = tk.Frame(stats_grid, bg="#e3f2fd", padx=15, pady=10, bd=1, relief="solid")
                card2.pack(side="left", padx=5, expand=True, fill="both")
                tk.Label(card2, text="Toplam Stok MiktarÄ±", font=("Segoe UI", 9), 
                        bg="#e3f2fd", fg="gray").pack()
                tk.Label(card2, text=f"{total_qty:,.0f}", font=("Segoe UI", 16, "bold"), 
                        bg="#e3f2fd", fg="#2196f3").pack()
            except:
                pass
        
        # Kolon sayÄ±sÄ±
        card3 = tk.Frame(stats_grid, bg="#fff3e0", padx=15, pady=10, bd=1, relief="solid")
        card3.pack(side="left", padx=5, expand=True, fill="both")
        tk.Label(card3, text="Kolon SayÄ±sÄ±", font=("Segoe UI", 9), bg="#fff3e0", fg="gray").pack()
        tk.Label(card3, text=f"{len(df_stok_global.columns)}", font=("Segoe UI", 16, "bold"), 
                bg="#fff3e0", fg="#ff9800").pack()
        
        # Tablo gÃ¶rÃ¼nÃ¼mÃ¼
        table_frame = tk.LabelFrame(content, text="ğŸ“‹ Stok Verileri", font=("Segoe UI", 11, "bold"), 
                                   padx=10, pady=10)
        table_frame.pack(fill="both", expand=True, pady=10)
        
        # Treeview oluÅŸtur
        tree_container = tk.Frame(table_frame)
        tree_container.pack(fill="both", expand=True)
        
        tree = ttk.Treeview(tree_container, show='headings', height=15)
        vsb = ttk.Scrollbar(tree_container, orient="vertical", command=tree.yview)
        hsb = ttk.Scrollbar(tree_container, orient="horizontal", command=tree.xview)
        tree.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)
        
        tree.grid(column=0, row=0, sticky='nsew')
        vsb.grid(column=1, row=0, sticky='ns')
        hsb.grid(column=0, row=1, sticky='ew')
        tree_container.grid_columnconfigure(0, weight=1)
        tree_container.grid_rowconfigure(0, weight=1)
        
        # KolonlarÄ± ayarla
        tree['columns'] = list(df_stok_global.columns)
        for col in df_stok_global.columns:
            tree.heading(col, text=col)
            tree.column(col, width=120)
        
        # Verileri ekle (maksimum 1000 satÄ±r)
        for row in df_stok_global.head(1000).itertuples(index=False):
            tree.insert('', 'end', values=row)
        
        # Export butonlarÄ±
        btn_frame = tk.Frame(content)
        btn_frame.pack(fill="x", pady=10)
        
        def export_stok_excel():
            f = filedialog.asksaveasfilename(defaultextension=".xlsx", 
                                            filetypes=[("Excel", "*.xlsx")])
            if f:
                try:
                    df_stok_global.to_excel(f, index=False)
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", f"Stok verileri Excel'e aktarÄ±ldÄ±:\n{f}")
                except Exception as e:
                    messagebox.showerror("Hata", f"Export hatasÄ±: {str(e)}")
        
        ttk.Button(btn_frame, text="ğŸ“Š Excel'e Aktar", command=export_stok_excel).pack(side="left", padx=5)
        ttk.Button(btn_frame, text="ğŸ”„ Yeniden YÃ¼kle", command=mysql_unified_data_loader).pack(side="left", padx=5)
        
        if len(df_stok_global) > 1000:
            tk.Label(content, text=f"â„¹ï¸ Not: Toplam {len(df_stok_global)} kayÄ±t var, ilk 1000 gÃ¶steriliyor.", 
                    font=("Segoe UI", 9), fg="gray").pack(pady=5)

# ========== AI-POWERED FIRE SATIÅ HELPER FUNCTIONS ==========

def analyze_pdf_with_gemini(pdf_path):
    """Gemini AI ile PDF belgesi analiz et"""
    try:
        import PyPDF2
        import google.generativeai as genai
        
        # API yapÄ±landÄ±rmasÄ±
        if not GEMINI_API_KEY:
            return {"error": "Gemini API anahtarÄ± tanÄ±mlÄ± deÄŸil"}
        
        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel('models/gemini-2.0-flash')
        
        # PDF okuma
        with open(pdf_path, 'rb') as file:
            pdf_reader = PyPDF2.PdfReader(file)
            text = ""
            for page in pdf_reader.pages[:5]:  # Ä°lk 5 sayfa
                text += page.extract_text()
        
        # AI analizi
        prompt = f"""AÅŸaÄŸÄ±daki TÃ¼rkÃ§e belgeyi analiz et:

{text[:3000]}

LÃ¼tfen ÅŸu bilgileri Ã§Ä±kar:
1. Belge TÃ¼rÃ¼ (sertifika, sÃ¶zleÅŸme, izin belgesi, vb.)
2. TedarikÃ§i/Firma AdÄ±
3. GeÃ§erlilik Tarihi (varsa)
4. Ã–nemli Maddeler
5. Referans NumarasÄ±

CevabÄ±nÄ± JSON formatÄ±nda ver."""
        
        response = model.generate_content(prompt)
        return {"success": True, "analysis": response.text}
        
    except Exception as e:
        return {"error": str(e)}

def extract_supplier_info_from_pdf(pdf_path):
    """SÃ¶zleÅŸme veya Sertifika PDF'inden tedarikÃ§i bilgilerini AI ile Ã§Ä±kar"""
    try:
        if not PYPDF2_AVAILABLE:
            return {"error": "PyPDF2 kÃ¼tÃ¼phanesi yÃ¼klÃ¼ deÄŸil"}
        
        if not GENAI_AVAILABLE or not GEMINI_API_KEY:
            return {"error": "Gemini AI yapÄ±landÄ±rÄ±lmamÄ±ÅŸ. API anahtarÄ±nÄ± ayarlayÄ±n."}
        
        import PyPDF2
        import google.generativeai as genai
        
        # API yapÄ±landÄ±rmasÄ±
        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel('models/gemini-2.0-flash')
        
        # PDF okuma
        print(f"[AI PDF] PDF okunuyor: {pdf_path}")
        with open(pdf_path, 'rb') as file:
            pdf_reader = PyPDF2.PdfReader(file)
            text = ""
            # Ä°lk 10 sayfa (genelde yeterli)
            for page in pdf_reader.pages[:10]:
                text += page.extract_text()
        
        if not text.strip():
            return {"error": "PDF'den metin Ã§Ä±karÄ±lamadÄ±"}
        
        # AI ile analiz
        prompt = f"""AÅŸaÄŸÄ±daki TÃ¼rkÃ§e sÃ¶zleÅŸme veya sertifika belgesini analiz et ve tedarikÃ§i bilgilerini Ã§Ä±kar.

Belge Metni:
{text[:5000]}

LÃ¼tfen ÅŸu bilgileri Ã§Ä±kar ve JSON formatÄ±nda ver:
{{
    "tedarikci_adi": "TedarikÃ§i firma adÄ±",
    "yetkili_kisi": "Yetkili kiÅŸinin adÄ± soyadÄ±",
    "telefon": "Telefon numarasÄ±",
    "mail": "Email adresi",
    "adres": "Åirket adresi",
    "alim_turu": "KumaÅŸ, Fire, Tekleme, Aksesuar veya DiÄŸer (belgeden tahmin et)",
    "sozlesme_bitis": "SÃ¶zleÅŸme bitiÅŸ tarihi YYYY-MM-DD formatÄ±nda",
    "sertifika_bitis": "Sertifika bitiÅŸ tarihi YYYY-MM-DD formatÄ±nda",
    "belge_turu": "SÃ¶zleÅŸme veya Sertifika"
}}

EÄŸer bir bilgi bulunamazsa null deÄŸeri ver.
Sadece JSON formatÄ±nda yanÄ±t ver, baÅŸka aÃ§Ä±klama ekleme."""
        
        print("[AI PDF] AI analizi yapÄ±lÄ±yor...")
        response = model.generate_content(prompt)
        
        # JSON parse et
        import json
        import re
        
        # JSON'u metinden Ã§Ä±kar
        response_text = response.text
        # Markdown code block varsa temizle
        response_text = re.sub(r'```json\s*', '', response_text)
        response_text = re.sub(r'```\s*', '', response_text)
        response_text = response_text.strip()
        
        print(f"[AI PDF] AI yanÄ±tÄ±: {response_text[:200]}...")
        
        try:
            data = json.loads(response_text)
            print(f"[AI PDF] Ã‡Ä±karÄ±lan bilgiler: {data}")
            return {"success": True, "data": data}
        except json.JSONDecodeError as e:
            print(f"[AI PDF] JSON parse hatasÄ±: {e}")
            # JSON parse edilemezse ham metin dÃ¶ndÃ¼r
            return {"success": False, "raw_text": response_text, "error": "JSON formatÄ± hatalÄ±"}
        
    except Exception as e:
        print(f"[AI PDF] Hata: {e}")
        import traceback
        traceback.print_exc()
        return {"error": str(e)}

def generate_sample_cari_data():
    """Test iÃ§in Ã¶rnek cari bilgileri oluÅŸtur"""
    try:
        if not OPENPYXL_AVAILABLE:
            return False, "Openpyxl kÃ¼tÃ¼phanesi yÃ¼klÃ¼ deÄŸil"
        
        # Dosya yoksa oluÅŸtur
        if not os.path.exists(MASTER_CARI_BILGILER_PATH):
            initialize_cari_bilgiler_excel()
        
        from datetime import datetime, timedelta
        import random
        
        # Ã–rnek veriler
        sample_data = [
            {
                "tedarikci_adi": "ABC Tekstil Ltd. Åti.",
                "yetkili_kisi": "Ahmet YÄ±lmaz",
                "telefon": "0212 555 0001",
                "adres": "Merkez Mah. Sanayi Cad. No:123 BeyoÄŸlu/Ä°stanbul",
                "alim_turu": "KumaÅŸ",
                "mail": "ahmet.yilmaz@abctekstil.com",
                "eksik_evraklar": "",
                "sozlesme_bitis": (datetime.now() + timedelta(days=45)).strftime('%Y-%m-%d'),
                "sertifika_bitis": (datetime.now() + timedelta(days=120)).strftime('%Y-%m-%d')
            },
            {
                "tedarikci_adi": "XYZ Fire Geri DÃ¶nÃ¼ÅŸÃ¼m A.Å.",
                "yetkili_kisi": "Mehmet Demir",
                "telefon": "0216 444 0002",
                "adres": "Organize Sanayi BÃ¶lgesi 5. Cad. No:78 Gebze/Kocaeli",
                "alim_turu": "Fire",
                "mail": "mehmet.demir@xyzfire.com",
                "eksik_evraklar": "",
                "sozlesme_bitis": (datetime.now() + timedelta(days=-5)).strftime('%Y-%m-%d'),  # Expired
                "sertifika_bitis": (datetime.now() + timedelta(days=10)).strftime('%Y-%m-%d')   # Expiring soon
            },
            {
                "tedarikci_adi": "DEF Aksesuar San. Tic.",
                "yetkili_kisi": "AyÅŸe Kaya",
                "telefon": "0232 333 0003",
                "adres": "HalkapÄ±nar Mah. Ä°nÃ¶nÃ¼ Cad. No:456 Konak/Ä°zmir",
                "alim_turu": "Aksesuar",
                "mail": "ayse.kaya@defaksesuar.com",
                "eksik_evraklar": "Vergi LevhasÄ±",
                "sozlesme_bitis": (datetime.now() + timedelta(days=200)).strftime('%Y-%m-%d'),
                "sertifika_bitis": (datetime.now() + timedelta(days=180)).strftime('%Y-%m-%d')
            },
            {
                "tedarikci_adi": "GHI Tekleme Hizmetleri Ltd.",
                "yetkili_kisi": "Fatma Ã–ztÃ¼rk",
                "telefon": "0312 777 0004",
                "adres": "AtatÃ¼rk BulvarÄ± No:234 Ã‡ankaya/Ankara",
                "alim_turu": "Tekleme",
                "mail": "fatma.ozturk@ghitekleme.com",
                "eksik_evraklar": "",
                "sozlesme_bitis": (datetime.now() + timedelta(days=5)).strftime('%Y-%m-%d'),   # Expiring soon
                "sertifika_bitis": (datetime.now() + timedelta(days=90)).strftime('%Y-%m-%d')
            },
            {
                "tedarikci_adi": "JKL Tekstil Yan ÃœrÃ¼nleri",
                "yetkili_kisi": "Ali Åahin",
                "telefon": "0224 999 0005",
                "adres": "DemirtaÅŸ OSB 12. Sokak No:89 Osmangazi/Bursa",
                "alim_turu": "DiÄŸer",
                "mail": "ali.sahin@jkltekstil.com",
                "eksik_evraklar": "SÃ¶zleÅŸme, Sertifika",
                "sozlesme_bitis": (datetime.now() + timedelta(days=-20)).strftime('%Y-%m-%d'),  # Expired
                "sertifika_bitis": (datetime.now() + timedelta(days=-10)).strftime('%Y-%m-%d')  # Expired
            }
        ]
        
        # Excel'e kaydet
        for data in sample_data:
            result = save_cari_bilgi(data)
            if not result[0]:
                print(f"Ã–rnek veri kaydedilemedi: {result[1]}")
        
        return True, f"{len(sample_data)} Ã¶rnek kayÄ±t eklendi"
        
    except Exception as e:
        import traceback
        traceback.print_exc()
        return False, f"Hata: {str(e)}"

def initialize_cari_bilgiler_excel():
    """Cari Bilgiler Excel dosyasÄ±nÄ± oluÅŸtur veya kontrol et"""
    try:
        if not OPENPYXL_AVAILABLE:
            print("Openpyxl kÃ¼tÃ¼phanesi yÃ¼klÃ¼ deÄŸil!")
            return False
        
        # Dosya yoksa oluÅŸtur
        if not os.path.exists(MASTER_CARI_BILGILER_PATH):
            # KlasÃ¶rÃ¼ oluÅŸtur
            os.makedirs(os.path.dirname(MASTER_CARI_BILGILER_PATH), exist_ok=True)
            
            # Yeni workbook oluÅŸtur
            wb = Workbook()
            ws = wb.active
            ws.title = "Cari Bilgiler"
            
            # BaÅŸlÄ±klarÄ± ekle
            headers = ["TedarikÃ§i AdÄ±", "Yetkili KiÅŸi", "Telefon", "Adres", "AlÄ±m TÃ¼rÃ¼", "Mail", "Eksik Evraklar", 
                      "SÃ¶zleÅŸme BitiÅŸ Tarihi", "Sertifika BitiÅŸ Tarihi", "KayÄ±t Tarihi"]
            ws.append(headers)
            
            # BaÅŸlÄ±klarÄ± formatla
            header_fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
            header_font = Font(bold=True, color="FFFFFF")
            header_alignment = Alignment(horizontal="center", vertical="center")
            
            for cell in ws[1]:
                cell.fill = header_fill
                cell.font = header_font
                cell.alignment = header_alignment
            
            # SÃ¼tun geniÅŸliklerini ayarla
            ws.column_dimensions['A'].width = 30  # TedarikÃ§i AdÄ±
            ws.column_dimensions['B'].width = 25  # Yetkili KiÅŸi
            ws.column_dimensions['C'].width = 20  # Telefon
            ws.column_dimensions['D'].width = 40  # Adres
            ws.column_dimensions['E'].width = 20  # AlÄ±m TÃ¼rÃ¼
            ws.column_dimensions['F'].width = 30  # Mail
            ws.column_dimensions['G'].width = 40  # Eksik Evraklar
            ws.column_dimensions['H'].width = 20  # SÃ¶zleÅŸme BitiÅŸ Tarihi
            ws.column_dimensions['I'].width = 20  # Sertifika BitiÅŸ Tarihi
            ws.column_dimensions['J'].width = 20  # KayÄ±t Tarihi
            
            wb.save(MASTER_CARI_BILGILER_PATH)
            print(f"Cari Bilgiler dosyasÄ± oluÅŸturuldu: {MASTER_CARI_BILGILER_PATH}")
        
        return True
    except Exception as e:
        print(f"Cari Bilgiler Excel dosyasÄ± oluÅŸturma hatasÄ±: {e}")
        return False

def load_cari_bilgiler():
    """Cari Bilgiler Excel dosyasÄ±ndan verileri yÃ¼kle"""
    try:
        if not OPENPYXL_AVAILABLE:
            return []
        
        if not os.path.exists(MASTER_CARI_BILGILER_PATH):
            initialize_cari_bilgiler_excel()
            return []
        
        # Pandas ile oku (daha kolay)
        df = pd.read_excel(MASTER_CARI_BILGILER_PATH)
        
        # SÃ¼tun isimlerindeki boÅŸluklarÄ± temizle
        df.columns = df.columns.str.strip()
        
        # SÃ¼tun isimlerini standartlaÅŸtÄ±r (eski adlar iÃ§in mapping)
        column_mapping = {
            'Tarih': 'KayÄ±t Tarihi'
        }
        
        # Kritik: Tarih sÃ¼tunlarÄ± iÃ§in Ã¶zel mapping
        # EÄŸer 'BitiÅŸ Tarihi' varsa ve 'SÃ¶zleÅŸme BitiÅŸ Tarihi' yoksa, map et
        if 'BitiÅŸ Tarihi' in df.columns and 'SÃ¶zleÅŸme BitiÅŸ Tarihi' not in df.columns:
            # Ã–nce 'BitiÅŸ Tarihi'yi 'SÃ¶zleÅŸme BitiÅŸ Tarihi' olarak kopyala
            df['SÃ¶zleÅŸme BitiÅŸ Tarihi'] = df['BitiÅŸ Tarihi']
            # Sertifika iÃ§in de aynÄ± tarihi kullan (kullanÄ±cÄ± ayÄ±rÄ±m yapmamÄ±ÅŸ)
            df['Sertifika BitiÅŸ Tarihi'] = df['BitiÅŸ Tarihi']
            print("[MAPPING] 'BitiÅŸ Tarihi' sÃ¼tunu 'SÃ¶zleÅŸme BitiÅŸ Tarihi' ve 'Sertifika BitiÅŸ Tarihi' olarak eÅŸlendi")
        
        # EÄŸer 'BaÅŸlangÄ±Ã§ Tarihi' varsa ve kullanÄ±labilirse bilgi olarak gÃ¶ster
        if 'BaÅŸlangÄ±Ã§ Tarihi' in df.columns:
            print("[INFO] 'BaÅŸlangÄ±Ã§ Tarihi' sÃ¼tunu mevcut (ÅŸu an kullanÄ±lmÄ±yor)")
        
        df.rename(columns=column_mapping, inplace=True)
        
        # NaN deÄŸerlerini boÅŸ string ile deÄŸiÅŸtir
        df = df.fillna('')
        
        # SÃ¼tun isimlerini kontrol et ve dÃ¼zelt
        print(f"Excel sÃ¼tun isimleri: {df.columns.tolist()}")
        
        # DataFrame'i liste olarak dÃ¶ndÃ¼r
        records = df.to_dict('records')
        print(f"YÃ¼klenen kayÄ±t sayÄ±sÄ±: {len(records)}")
        if len(records) > 0:
            print(f"Ã–rnek kayÄ±t: {records[0]}")
        return records
    except Exception as e:
        print(f"Cari Bilgiler yÃ¼kleme hatasÄ±: {e}")
        import traceback
        traceback.print_exc()
        return []

def save_cari_bilgi(data):
    """Yeni cari bilgiyi Excel dosyasÄ±na kaydet"""
    import time
    
    try:
        if not OPENPYXL_AVAILABLE:
            return False, "Openpyxl kÃ¼tÃ¼phanesi yÃ¼klÃ¼ deÄŸil!"
        
        # Dosya yoksa oluÅŸtur
        if not os.path.exists(MASTER_CARI_BILGILER_PATH):
            initialize_cari_bilgiler_excel()
        
        # Dosya kilidi kontrolÃ¼ ve retry mekanizmasÄ±
        max_retries = 3
        retry_delay = 1  # saniye
        
        for attempt in range(max_retries):
            try:
                # Dosya kilidi kontrolÃ¼ - dosyayÄ± yazma modunda aÃ§mayÄ± dene
                with open(MASTER_CARI_BILGILER_PATH, 'a'):
                    pass
                
                # DosyayÄ± aÃ§
                wb = openpyxl.load_workbook(MASTER_CARI_BILGILER_PATH)
                ws = wb.active
                
                # Yeni satÄ±r ekle
                new_row = [
                    data.get('tedarikci_adi', ''),
                    data.get('yetkili_kisi', ''),
                    data.get('telefon', ''),
                    data.get('adres', ''),
                    data.get('alim_turu', ''),
                    data.get('mail', ''),
                    data.get('eksik_evraklar', ''),
                    data.get('sozlesme_bitis', ''),  # SÃ¶zleÅŸme bitiÅŸ tarihi
                    data.get('sertifika_bitis', ''),  # Sertifika bitiÅŸ tarihi
                    datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                ]
                ws.append(new_row)
                
                # DosyayÄ± kaydet
                wb.save(MASTER_CARI_BILGILER_PATH)
                wb.close()
                return True, "Cari bilgi baÅŸarÄ±yla kaydedildi!"
                
            except PermissionError as pe:
                if attempt < max_retries - 1:
                    time.sleep(retry_delay)
                    continue
                else:
                    # Son deneme de baÅŸarÄ±sÄ±z oldu
                    return False, (
                        "Excel dosyasÄ± aÃ§Ä±k veya eriÅŸim izni yok!\n\n"
                        "LÃ¼tfen aÅŸaÄŸÄ±daki adÄ±mlarÄ± deneyin:\n"
                        "1. Excel dosyasÄ±nÄ± kapatÄ±n (Cari Bilgiler.xlsx)\n"
                        "2. DosyanÄ±n bulunduÄŸu klasÃ¶re yazma izniniz olduÄŸundan emin olun\n"
                        "3. Tekrar kaydetmeyi deneyin\n\n"
                        f"Dosya: {MASTER_CARI_BILGILER_PATH}"
                    )
            except Exception as inner_e:
                # DiÄŸer hatalar iÃ§in hemen Ã§Ä±k
                raise inner_e
                
    except Exception as e:
        error_msg = str(e)
        if "Permission denied" in error_msg or "PermissionError" in str(type(e)):
            return False, (
                "Excel dosyasÄ± aÃ§Ä±k veya eriÅŸim izni yok!\n\n"
                "LÃ¼tfen aÅŸaÄŸÄ±daki adÄ±mlarÄ± deneyin:\n"
                "1. Excel dosyasÄ±nÄ± kapatÄ±n (Cari Bilgiler.xlsx)\n"
                "2. DosyanÄ±n bulunduÄŸu klasÃ¶re yazma izniniz olduÄŸundan emin olun\n"
                "3. Tekrar kaydetmeyi deneyin\n\n"
                f"Dosya: {MASTER_CARI_BILGILER_PATH}"
            )
        return False, f"Kaydetme hatasÄ±: {error_msg}"

def update_cari_bilgi(row_index, data):
    """Var olan cari bilgiyi gÃ¼ncelle"""
    import time
    
    try:
        if not OPENPYXL_AVAILABLE:
            return False, "Openpyxl kÃ¼tÃ¼phanesi yÃ¼klÃ¼ deÄŸil!"
        
        if not os.path.exists(MASTER_CARI_BILGILER_PATH):
            return False, "Cari Bilgiler dosyasÄ± bulunamadÄ±!"
        
        # Dosya kilidi kontrolÃ¼ ve retry mekanizmasÄ±
        max_retries = 3
        retry_delay = 1  # saniye
        
        for attempt in range(max_retries):
            try:
                # Dosya kilidi kontrolÃ¼
                with open(MASTER_CARI_BILGILER_PATH, 'a'):
                    pass
                
                # DosyayÄ± aÃ§
                wb = openpyxl.load_workbook(MASTER_CARI_BILGILER_PATH)
                ws = wb.active
                
                # SatÄ±r indeksini gÃ¼ncelle (Excel 1-indexed, baÅŸlÄ±k satÄ±rÄ± var)
                excel_row = row_index + 2  # +1 for header, +1 for 0-indexed to 1-indexed
                
                # SatÄ±rÄ± gÃ¼ncelle
                ws.cell(row=excel_row, column=1).value = data.get('tedarikci_adi', '')
                ws.cell(row=excel_row, column=2).value = data.get('yetkili_kisi', '')
                ws.cell(row=excel_row, column=3).value = data.get('telefon', '')
                ws.cell(row=excel_row, column=4).value = data.get('adres', '')
                ws.cell(row=excel_row, column=5).value = data.get('alim_turu', '')
                ws.cell(row=excel_row, column=6).value = data.get('mail', '')
                ws.cell(row=excel_row, column=7).value = data.get('eksik_evraklar', '')
                
                # DosyayÄ± kaydet
                wb.save(MASTER_CARI_BILGILER_PATH)
                wb.close()
                return True, "Cari bilgi baÅŸarÄ±yla gÃ¼ncellendi!"
                
            except PermissionError as pe:
                if attempt < max_retries - 1:
                    time.sleep(retry_delay)
                    continue
                else:
                    return False, (
                        "Excel dosyasÄ± aÃ§Ä±k veya eriÅŸim izni yok!\n\n"
                        "LÃ¼tfen aÅŸaÄŸÄ±daki adÄ±mlarÄ± deneyin:\n"
                        "1. Excel dosyasÄ±nÄ± kapatÄ±n (Cari Bilgiler.xlsx)\n"
                        "2. DosyanÄ±n bulunduÄŸu klasÃ¶re yazma izniniz olduÄŸundan emin olun\n"
                        "3. Tekrar kaydetmeyi deneyin\n\n"
                        f"Dosya: {MASTER_CARI_BILGILER_PATH}"
                    )
            except Exception as inner_e:
                raise inner_e
                
    except Exception as e:
        error_msg = str(e)
        if "Permission denied" in error_msg or "PermissionError" in str(type(e)):
            return False, (
                "Excel dosyasÄ± aÃ§Ä±k veya eriÅŸim izni yok!\n\n"
                "LÃ¼tfen aÅŸaÄŸÄ±daki adÄ±mlarÄ± deneyin:\n"
                "1. Excel dosyasÄ±nÄ± kapatÄ±n (Cari Bilgiler.xlsx)\n"
                "2. DosyanÄ±n bulunduÄŸu klasÃ¶re yazma izniniz olduÄŸundan emin olun\n"
                "3. Tekrar kaydetmeyi deneyin\n\n"
                f"Dosya: {MASTER_CARI_BILGILER_PATH}"
            )
        return False, f"GÃ¼ncelleme hatasÄ±: {error_msg}"

def check_waste_disposal_compliance(supplier_name):
    """TedarikÃ§i iÃ§in Ã§evre uyumluluk kontrolÃ¼ yap"""
    import glob
    
    compliance_data = {
        "supplier": supplier_name,
        "score": 0,
        "total_checks": 5,
        "passed_checks": 0,
        "documents": {
            "cevre_izin": False,
            "atik_kodlari": False,
            "uatf": False,
            "tartim": False,
            "geri_kazanim": False
        },
        "found_files": []
    }
    
    try:
        # Sertifika ve sÃ¶zleÅŸme klasÃ¶rlerini tara
        all_pdfs = []
        
        if os.path.exists(MASTER_SERTIFIKA_PATH):
            cert_pdfs = glob.glob(os.path.join(MASTER_SERTIFIKA_PATH, "*.[pP][dD][fF]"))
            all_pdfs.extend(cert_pdfs)
        
        if os.path.exists(MASTER_SOZLESME_PATH):
            contract_pdfs = glob.glob(os.path.join(MASTER_SOZLESME_PATH, "*.[pP][dD][fF]"))
            all_pdfs.extend(contract_pdfs)
        
        # TedarikÃ§iye ait dosyalarÄ± filtrele
        supplier_files = [f for f in all_pdfs if supplier_name.upper() in os.path.basename(f).upper()]
        
        for pdf_file in supplier_files:
            filename = os.path.basename(pdf_file).lower()
            
            # Dosya adÄ±na gÃ¶re belge tÃ¼rÃ¼nÃ¼ tespit et
            if any(keyword in filename for keyword in ['cevre', 'izin', 'lisans', 'environmental']):
                compliance_data["documents"]["cevre_izin"] = True
                compliance_data["found_files"].append(("Ã‡evre Ä°zin", pdf_file))
                compliance_data["passed_checks"] += 1
            
            if any(keyword in filename for keyword in ['atik', 'waste', '200111', 'kod']):
                compliance_data["documents"]["atik_kodlari"] = True
                compliance_data["found_files"].append(("AtÄ±k KodlarÄ±", pdf_file))
                compliance_data["passed_checks"] += 1
            
            if any(keyword in filename for keyword in ['uatf', 'tasima', 'transport']):
                compliance_data["documents"]["uatf"] = True
                compliance_data["found_files"].append(("UATF", pdf_file))
                compliance_data["passed_checks"] += 1
            
            if any(keyword in filename for keyword in ['tartim', 'kantar', 'weigh', 'agirlik']):
                compliance_data["documents"]["tartim"] = True
                compliance_data["found_files"].append(("TartÄ±m/Kantar", pdf_file))
                compliance_data["passed_checks"] += 1
            
            if any(keyword in filename for keyword in ['r12', 'geri', 'kazanim', 'recovery']):
                compliance_data["documents"]["geri_kazanim"] = True
                compliance_data["found_files"].append(("Geri KazanÄ±m R12", pdf_file))
                compliance_data["passed_checks"] += 1
        
        # Uyumluluk skorunu hesapla
        compliance_data["score"] = int((compliance_data["passed_checks"] / compliance_data["total_checks"]) * 100)
        
    except Exception as e:
        compliance_data["error"] = str(e)
    
    return compliance_data

def generate_waste_contract_with_ai(supplier_name, compliance_data, template_path=None):
    """Gemini AI ile atÄ±k bertaraf sÃ¶zleÅŸmesi oluÅŸtur"""
    try:
        import google.generativeai as genai
        
        if not GEMINI_API_KEY:
            return "âŒ Gemini API anahtarÄ± tanÄ±mlÄ± deÄŸil. LÃ¼tfen GEMINI_API_KEY deÄŸiÅŸkenini gÃ¼ncelleyin."
        
        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel('models/gemini-2.0-flash')
        
        # Uyumluluk durumunu Ã¶zetle
        missing_docs = []
        if not compliance_data["documents"]["cevre_izin"]:
            missing_docs.append("Ã‡evre Ä°zin ve Lisans Belgesi")
        if not compliance_data["documents"]["atik_kodlari"]:
            missing_docs.append("AtÄ±k KodlarÄ± LisansÄ±")
        if not compliance_data["documents"]["uatf"]:
            missing_docs.append("UATF")
        if not compliance_data["documents"]["tartim"]:
            missing_docs.append("TartÄ±m FiÅŸi")
        if not compliance_data["documents"]["geri_kazanim"]:
            missing_docs.append("Geri KazanÄ±m Belgesi")
        
        # Åablon sÃ¶zleÅŸme varsa oku
        template_content = ""
        if template_path and os.path.exists(template_path):
            try:
                if template_path.lower().endswith('.pdf'):
                    import PyPDF2
                    with open(template_path, 'rb') as file:
                        pdf_reader = PyPDF2.PdfReader(file)
                        template_content = ""
                        for page in pdf_reader.pages[:10]:  # Ä°lk 10 sayfa
                            template_content += page.extract_text()
                elif template_path.lower().endswith('.docx'):
                    from docx import Document
                    doc = Document(template_path)
                    template_content = "\n".join([para.text for para in doc.paragraphs])
                elif template_path.lower().endswith('.txt'):
                    with open(template_path, 'r', encoding='utf-8') as file:
                        template_content = file.read()
                
                if template_content:
                    template_content = f"\n\nÅablon SÃ¶zleÅŸme ReferansÄ±:\n{template_content[:3000]}\n"  # Ä°lk 3000 karakter
            except Exception as e:
                template_content = f"\n\nâš ï¸ Åablon okuma hatasÄ±: {str(e)}\n"
        
        prompt = f"""Defacto ile {supplier_name} arasÄ±nda imzalanacak profesyonel bir Fire (AtÄ±k Tekstil) Bertaraf SÃ¶zleÅŸmesi taslaÄŸÄ± oluÅŸtur.

SÃ¶zleÅŸme ÅŸu 8 maddeyi iÃ§ermeli:
1. Ã‡evre Ä°zin ve Lisans Belgesi gereksinimi
2. Lisans kapsamÄ±nda atÄ±k kodlarÄ± (Ã¶zellikle 200111 tekstil atÄ±ÄŸÄ±)
3. UATF (Ulusal AtÄ±k TaÅŸÄ±ma Formu) UÃ‡BS Ã¼zerinden dÃ¼zenleme zorunluluÄŸu
4. TartÄ±m fiÅŸi/kantar belgesi gerekliliÄŸi (lokasyon, miktar, atÄ±k kodu bilgileri ile)
5. AylÄ±k/yÄ±llÄ±k atÄ±k raporlama yÃ¼kÃ¼mlÃ¼lÃ¼ÄŸÃ¼
6. Geri kazanÄ±m yÃ¶ntemi (R12 atÄ±k iÅŸleme) belgelendirme
7. Nihai atÄ±k sorumluluÄŸu ve kanÄ±t dokÃ¼manlarÄ±
8. Cezai ÅŸartlar ve sÃ¶zleÅŸme feshi koÅŸullarÄ±

Mevcut Uyumluluk Durumu:
- Uyumluluk Skoru: %{compliance_data["score"]}
- Eksik Belgeler: {", ".join(missing_docs) if missing_docs else "YOK"}
{template_content}
{"YukarÄ±daki ÅŸablon sÃ¶zleÅŸmeyi referans alarak benzer format, stil ve dil kullanarak yeni sÃ¶zleÅŸme oluÅŸtur." if template_content else ""}
Profesyonel, yasal terminoloji kullanarak TÃ¼rkÃ§e sÃ¶zleÅŸme taslaÄŸÄ± hazÄ±rla."""
        
        response = model.generate_content(prompt)
        return response.text
        
    except Exception as e:
        return f"âŒ SÃ¶zleÅŸme oluÅŸturma hatasÄ±: {str(e)}"

def send_compliance_email(supplier_email, supplier_name, compliance_data, ai_message):
    """TedarikÃ§iye uyumluluk raporu emaili gÃ¶nder"""
    try:
        import smtplib
        from email.mime.text import MIMEText
        from email.mime.multipart import MIMEMultipart
        
        # Email iÃ§eriÄŸi
        msg = MIMEMultipart('alternative')
        msg['Subject'] = f"Fire SatÄ±ÅŸ Ã‡evre Uyumluluk Raporu - {supplier_name}"
        msg['From'] = GMAIL_USER
        msg['To'] = supplier_email
        
        # HTML iÃ§erik
        status_color = "#27ae60" if compliance_data["score"] == 100 else "#e67e22"
        status_text = "âœ… TAM UYUMLU" if compliance_data["score"] == 100 else "âš ï¸ EKSÄ°KLER VAR"
        
        html_content = f"""
        <html>
        <body style="font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4;">
            <div style="max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px;">
                <h2 style="color: #2c3e50;">ğŸ›ï¸ Fire SatÄ±ÅŸ Ã‡evre Uyumluluk Raporu</h2>
                <hr style="border: 1px solid #ecf0f1;">
                
                <p><strong>TedarikÃ§i:</strong> {supplier_name}</p>
                <p><strong>Tarih:</strong> {datetime.datetime.now().strftime('%d.%m.%Y %H:%M')}</p>
                
                <div style="background: {status_color}; color: white; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h3 style="margin: 0;">Uyumluluk Skoru: %{compliance_data["score"]}</h3>
                    <p style="margin: 5px 0 0 0;">{status_text}</p>
                </div>
                
                <h3>ğŸ“‹ Gerekli Belgeler Durumu:</h3>
                <ul style="list-style: none; padding: 0;">
                    <li>{"âœ…" if compliance_data["documents"]["cevre_izin"] else "âŒ"} Ã‡evre Ä°zin ve Lisans Belgesi</li>
                    <li>{"âœ…" if compliance_data["documents"]["atik_kodlari"] else "âŒ"} AtÄ±k KodlarÄ± LisansÄ± (200111)</li>
                    <li>{"âœ…" if compliance_data["documents"]["uatf"] else "âŒ"} UATF (Ulusal AtÄ±k TaÅŸÄ±ma Formu)</li>
                    <li>{"âœ…" if compliance_data["documents"]["tartim"] else "âŒ"} TartÄ±m FiÅŸi / Kantar Belgesi</li>
                    <li>{"âœ…" if compliance_data["documents"]["geri_kazanim"] else "âŒ"} Geri KazanÄ±m Belgesi (R12)</li>
                </ul>
                
                <div style="background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 20px 0;">
                    <h3>ğŸ¤– AI DeÄŸerlendirme:</h3>
                    <p style="white-space: pre-wrap;">{ai_message[:500]}...</p>
                </div>
                
                <hr style="border: 1px solid #ecf0f1;">
                <p style="color: #7f8c8d; font-size: 12px;">
                    Bu email Defacto TedarikÃ§i Uyumluluk Sistemi tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.<br>
                    SorularÄ±nÄ±z iÃ§in: {GMAIL_USER}
                </p>
            </div>
        </body>
        </html>
        """
        
        part = MIMEText(html_content, 'html', 'utf-8')
        msg.attach(part)
        
        # Email gÃ¶nder
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
        server.send_message(msg)
        server.quit()
        
        return True, "âœ… Email baÅŸarÄ±yla gÃ¶nderildi!"
        
    except Exception as e:
        return False, f"âŒ Email gÃ¶nderme hatasÄ±: {str(e)}"

# ========== END OF AI HELPER FUNCTIONS ==========

def init_compliance_center_tab():
    """TedarikÃ§i Uyumluluk Merkezi - AI Destekli Sertifika ve SÃ¶zleÅŸme YÃ¶netimi"""
    import glob
    from datetime import datetime, timedelta
    
    for widget in frame_compliance.winfo_children():
        widget.destroy()
    
    # BaÅŸlÄ±k
    header = tk.Frame(frame_compliance, bg="#2c3e50", padx=20, pady=20)
    header.pack(fill="x")
    tk.Label(header, text="ğŸ›ï¸ TedarikÃ§i Uyumluluk Merkezi (AI Powered)", font=("Segoe UI", 20, "bold"), 
             fg="white", bg="#2c3e50").pack(anchor="w")
    tk.Label(header, text="Supplier Compliance Center - Fire SatÄ±ÅŸ Kontrol & Ã‡evre Uyumluluk", 
             font=("Segoe UI", 11), fg="#ecf0f1", bg="#2c3e50").pack(anchor="w")
    
    # Scrollable canvas container
    canvas_container = tk.Frame(frame_compliance)
    canvas_container.pack(fill="both", expand=True)
    
    # Canvas and scrollbar
    canvas = tk.Canvas(canvas_container, bg="#ecf0f1", highlightthickness=0)
    scrollbar = ttk.Scrollbar(canvas_container, orient="vertical", command=canvas.yview)
    
    # Frame inside canvas
    content = tk.Frame(canvas, padx=15, pady=15, bg="#ecf0f1")
    
    # Configure scrolling
    canvas.configure(yscrollcommand=scrollbar.set)
    canvas.pack(side="left", fill="both", expand=True)
    scrollbar.pack(side="right", fill="y")
    
    # Create window in canvas
    canvas_frame = canvas.create_window((0, 0), window=content, anchor="nw")
    
    # Update scrollregion when content changes
    def on_frame_configure(event=None):
        canvas.configure(scrollregion=canvas.bbox("all"))
        canvas.itemconfig(canvas_frame, width=canvas.winfo_width())
    
    content.bind("<Configure>", on_frame_configure)
    canvas.bind("<Configure>", on_frame_configure)
    
    # Mouse wheel scrolling
    def on_mousewheel(event):
        canvas.yview_scroll(int(-1*(event.delta/120)), "units")
    
    canvas.bind_all("<MouseWheel>", on_mousewheel)
    
    # Ana bilgi kartlarÄ±
    info_container = tk.Frame(content, bg="#ecf0f1")
    info_container.pack(fill="x", pady=(0, 15))
    
    def create_info_card(parent, title, value, color, icon):
        """Bilgi kartÄ± oluÅŸtur"""
        card = tk.Frame(parent, bg="white", bd=2, relief="solid", padx=20, pady=15)
        card.pack(side="left", padx=5, expand=True, fill="both")
        
        tk.Label(card, text=icon, font=("Segoe UI", 24), bg="white", fg=color).pack()
        tk.Label(card, text=title, font=("Segoe UI", 10), bg="white", fg="gray").pack()
        tk.Label(card, text=value, font=("Segoe UI", 16, "bold"), bg="white", fg=color).pack()
        
        return card
    
    # Dosya sayÄ±larÄ±nÄ± hesapla
    cert_count = 0
    contract_count = 0
    
    try:
        if os.path.exists(MASTER_SERTIFIKA_PATH):
            cert_files = glob.glob(os.path.join(MASTER_SERTIFIKA_PATH, "*.[pP][dD][fF]"))
            cert_count = len(cert_files)
    except Exception as e:
        print(f"Sertifika klasÃ¶rÃ¼ okuma hatasÄ±: {e}")
    
    try:
        if os.path.exists(MASTER_SOZLESME_PATH):
            contract_files = glob.glob(os.path.join(MASTER_SOZLESME_PATH, "*.[pP][dD][fF]"))
            contract_count = len(contract_files)
    except Exception as e:
        print(f"SÃ¶zleÅŸme klasÃ¶rÃ¼ okuma hatasÄ±: {e}")
    
    total_docs = cert_count + contract_count
    
    # Bilgi kartlarÄ±
    create_info_card(info_container, "Toplam Belge", str(total_docs), "#3498db", "ğŸ“„")
    create_info_card(info_container, "Sertifikalar", str(cert_count), "#27ae60", "ğŸ†")
    create_info_card(info_container, "SÃ¶zleÅŸmeler", str(contract_count), "#e74c3c", "ğŸ“")
    
    # ğŸ”¥ FIRE SATIÅ KONTROL PANELÄ°
    fire_panel = tk.LabelFrame(content, text="ğŸ”¥ Fire SatÄ±ÅŸ Ã‡evre Uyumluluk KontrolÃ¼", 
                               font=("Segoe UI", 13, "bold"), bg="white", fg="#e67e22",
                               padx=15, pady=15, relief="solid", bd=2)
    fire_panel.pack(fill="x", pady=(0, 15))
    
    # Kontrol formu
    form_frame = tk.Frame(fire_panel, bg="white")
    form_frame.pack(fill="x", pady=10)
    
    tk.Label(form_frame, text="TedarikÃ§i AdÄ±:", font=("Segoe UI", 10, "bold"),
             bg="white").grid(row=0, column=0, sticky="w", padx=5, pady=5)
    
    supplier_entry = tk.Entry(form_frame, font=("Segoe UI", 10), width=30)
    supplier_entry.grid(row=0, column=1, padx=5, pady=5, sticky="ew")
    
    tk.Label(form_frame, text="TedarikÃ§i Email:", font=("Segoe UI", 10, "bold"),
             bg="white").grid(row=1, column=0, sticky="w", padx=5, pady=5)
    
    email_entry = tk.Entry(form_frame, font=("Segoe UI", 10), width=30)
    email_entry.grid(row=1, column=1, padx=5, pady=5, sticky="ew")
    
    tk.Label(form_frame, text="Defacto SÃ¶zleÅŸme Åablonu:", font=("Segoe UI", 10, "bold"),
             bg="white").grid(row=2, column=0, sticky="w", padx=5, pady=5)
    
    template_frame = tk.Frame(form_frame, bg="white")
    template_frame.grid(row=2, column=1, padx=5, pady=5, sticky="ew")
    
    template_entry = tk.Entry(template_frame, font=("Segoe UI", 9), width=30)
    template_entry.pack(side="left", fill="x", expand=True, padx=(0, 5))
    
    def browse_template():
        """Åablon sÃ¶zleÅŸme dosyasÄ± seÃ§"""
        file_path = filedialog.askopenfilename(
            title="Defacto SÃ¶zleÅŸme Åablonu SeÃ§in",
            filetypes=[("PDF DosyalarÄ±", "*.pdf"), ("Word DosyalarÄ±", "*.docx"), ("Metin DosyalarÄ±", "*.txt"), ("TÃ¼m Dosyalar", "*.*")]
        )
        if file_path:
            template_entry.delete(0, tk.END)
            template_entry.insert(0, file_path)
    
    tk.Button(template_frame, text="GÃ¶zat", font=("Segoe UI", 8),
             bg="#95a5a6", fg="white", cursor="hand2", command=browse_template).pack(side="left")
    
    form_frame.grid_columnconfigure(1, weight=1)
    
    # SonuÃ§ alanÄ± with scrollbar
    result_frame = tk.Frame(fire_panel, bg="white")
    result_frame.pack(fill="both", expand=True, pady=10)
    
    result_scrollbar = tk.Scrollbar(result_frame, orient="vertical")
    result_scrollbar.pack(side="right", fill="y")
    
    result_text = tk.Text(result_frame, height=12, width=80, font=("Consolas", 9),
                         wrap="word", bg="#f8f9fa", relief="solid", bd=1,
                         yscrollcommand=result_scrollbar.set)
    result_text.pack(side="left", fill="both", expand=True)
    
    result_scrollbar.config(command=result_text.yview)
    
    def check_fire_compliance():
        """Fire satÄ±ÅŸ uyumluluk kontrolÃ¼ yap"""
        supplier = supplier_entry.get().strip()
        if not supplier:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen tedarikÃ§i adÄ± girin!")
            return
        
        result_text.delete("1.0", "end")
        result_text.insert("end", "ğŸ” Kontrol ediliyor...\n\n")
        result_text.update()
        
        # Uyumluluk kontrolÃ¼
        compliance = check_waste_disposal_compliance(supplier)
        
        # SonuÃ§larÄ± gÃ¶ster
        result_text.delete("1.0", "end")
        result_text.insert("end", f"{'='*60}\n")
        result_text.insert("end", f"ğŸ›ï¸ FIRE SATIÅ Ã‡EVRE UYUMLULUK RAPORU\n")
        result_text.insert("end", f"{'='*60}\n\n")
        
        result_text.insert("end", f"TedarikÃ§i: {compliance['supplier']}\n")
        result_text.insert("end", f"Uyumluluk Skoru: %{compliance['score']}\n")
        result_text.insert("end", f"Durum: {'âœ… TAM UYUMLU' if compliance['score'] == 100 else 'âš ï¸ EKSÄ°KLER VAR'}\n\n")
        
        result_text.insert("end", "ğŸ“‹ Gerekli Belgeler Durumu:\n")
        result_text.insert("end", f"{'-'*60}\n")
        
        # Belge durumlarÄ±nÄ± gÃ¶ster
        docs_turkish = {
            "cevre_izin": "Ã‡evre Ä°zin ve Lisans Belgesi",
            "atik_kodlari": "AtÄ±k KodlarÄ± LisansÄ± (200111)",
            "uatf": "UATF (Ulusal AtÄ±k TaÅŸÄ±ma Formu)",
            "tartim": "TartÄ±m FiÅŸi / Kantar Belgesi",
            "geri_kazanim": "Geri KazanÄ±m Belgesi (R12)"
        }
        
        missing_docs = []
        for doc_key, doc_name in docs_turkish.items():
            status = compliance['documents'][doc_key]
            status_icon = "âœ…" if status else "âŒ"
            result_text.insert("end", f"{status_icon} {doc_name} - {'MEVCUT' if status else 'EKSÄ°K'}\n")
            if not status:
                missing_docs.append(doc_name)
        
        if missing_docs:
            result_text.insert("end", f"\nâš ï¸ Eksik Belgeler ({len(missing_docs)}):\n")
            for doc in missing_docs:
                result_text.insert("end", f"  â€¢ {doc}\n")
        
        if compliance['found_files']:
            result_text.insert("end", f"\nâœ… Bulunan Belgeler ({len(compliance['found_files'])}):\n")
            for doc_name, doc_path in compliance['found_files']:
                result_text.insert("end", f"  â€¢ {doc_name}: {os.path.basename(doc_path)}\n")
        else:
            result_text.insert("end", f"\nâš ï¸ HiÃ§bir belge bulunamadÄ±!\n")
            result_text.insert("end", f"TedarikÃ§i adÄ±nÄ±n dosya adlarÄ±nda geÃ§tiÄŸinden emin olun.\n")
        
        result_text.insert("end", f"\n{'='*60}\n")
        
        # Global deÄŸiÅŸkene kaydet (email iÃ§in)
        globals()['last_compliance_check'] = compliance
    
    def generate_contract():
        """AI ile sÃ¶zleÅŸme oluÅŸtur"""
        supplier = supplier_entry.get().strip()
        if not supplier:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen Ã¶nce tedarikÃ§i adÄ± girin!")
            return
        
        if 'last_compliance_check' not in globals():
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen Ã¶nce uyumluluk kontrolÃ¼ yapÄ±n!")
            return
        
        result_text.delete("1.0", "end")
        template_path = template_entry.get().strip() if template_entry.get().strip() else None
        
        if template_path:
            result_text.insert("end", "ğŸ¤– AI ile sÃ¶zleÅŸme oluÅŸturuluyor (Defacto ÅŸablonu kullanÄ±lÄ±yor)...\n\n")
        else:
            result_text.insert("end", "ğŸ¤– AI ile sÃ¶zleÅŸme oluÅŸturuluyor...\n\n")
        result_text.update()
        
        # AI ile sÃ¶zleÅŸme oluÅŸtur
        contract = generate_waste_contract_with_ai(supplier, globals()['last_compliance_check'], template_path)
        
        result_text.delete("1.0", "end")
        result_text.insert("end", contract)
    
    def send_email():
        """TedarikÃ§iye email gÃ¶nder"""
        supplier = supplier_entry.get().strip()
        email = email_entry.get().strip()
        
        if not supplier or not email:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen tedarikÃ§i adÄ± ve email girin!")
            return
        
        if 'last_compliance_check' not in globals():
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen Ã¶nce uyumluluk kontrolÃ¼ yapÄ±n!")
            return
        
        compliance_data = globals()['last_compliance_check']
        
        # AI yorumu oluÅŸtur
        ai_msg = "LÃ¼tfen eksik belgeleri en kÄ±sa sÃ¼rede tamamlayÄ±nÄ±z." if compliance_data['score'] < 100 else "TÃ¼m belgeleriniz eksiksizdir."
        
        # Email gÃ¶nder
        success, message = send_compliance_email(email, supplier, compliance_data, ai_msg)
        
        if success:
            messagebox.showinfo("BaÅŸarÄ±lÄ±", message)
        else:
            messagebox.showerror("Hata", message)
    
    # Butonlar
    btn_container = tk.Frame(fire_panel, bg="white")
    btn_container.pack(fill="x", pady=(0, 5))
    
    tk.Button(btn_container, text="ğŸ” Uyumluluk KontrolÃ¼ Yap", font=("Segoe UI", 10, "bold"),
             bg="#3498db", fg="white", relief="raised", bd=2, cursor="hand2",
             padx=15, pady=8, command=check_fire_compliance).pack(side="left", padx=5)
    
    tk.Button(btn_container, text="ğŸ¤– AI ile SÃ¶zleÅŸme OluÅŸtur", font=("Segoe UI", 10, "bold"),
             bg="#9b59b6", fg="white", relief="raised", bd=2, cursor="hand2",
             padx=15, pady=8, command=generate_contract).pack(side="left", padx=5)
    
    tk.Button(btn_container, text="ğŸ“§ TedarikÃ§iye Email GÃ¶nder", font=("Segoe UI", 10, "bold"),
             bg="#e67e22", fg="white", relief="raised", bd=2, cursor="hand2",
             padx=15, pady=8, command=send_email).pack(side="left", padx=5)
    
    # ğŸ“‹ CARÄ° BÄ°LGÄ°LER YÃ–NETÄ°MÄ° VE MAÄ°L PANELÄ°
    cari_panel = tk.LabelFrame(content, text="ğŸ“‹ Cari Bilgiler KayÄ±t ve Mail Paneli", 
                               font=("Segoe UI", 13, "bold"), bg="white", fg="#16a085",
                               padx=15, pady=15, relief="solid", bd=2)
    cari_panel.pack(fill="both", expand=True, pady=(15, 15))
    
    # Ãœst kÄ±sÄ±m: Form ve Liste (2 sÃ¼tun)
    top_section = tk.Frame(cari_panel, bg="white")
    top_section.pack(fill="both", expand=True, pady=5)
    top_section.grid_columnconfigure(0, weight=1)
    top_section.grid_columnconfigure(1, weight=2)
    
    # Sol: Cari Bilgi GiriÅŸ Formu
    form_section = tk.LabelFrame(top_section, text="â• Yeni Cari Bilgisi Ekle", 
                                 font=("Segoe UI", 11, "bold"), bg="white", fg="#2980b9",
                                 padx=10, pady=10, relief="solid", bd=1)
    form_section.grid(row=0, column=0, padx=5, pady=5, sticky="nsew")
    
    # Form alanlarÄ±
    form_frame = tk.Frame(form_section, bg="white")
    form_frame.pack(fill="both", expand=True)
    
    # TedarikÃ§i AdÄ±
    tk.Label(form_frame, text="TedarikÃ§i AdÄ±:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=0, column=0, sticky="w", padx=5, pady=3)
    tedarikci_adi_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    tedarikci_adi_entry.grid(row=0, column=1, padx=5, pady=3, sticky="ew")
    
    # Yetkili KiÅŸi
    tk.Label(form_frame, text="Yetkili KiÅŸi:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=1, column=0, sticky="w", padx=5, pady=3)
    yetkili_kisi_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    yetkili_kisi_entry.grid(row=1, column=1, padx=5, pady=3, sticky="ew")
    
    # Telefon
    tk.Label(form_frame, text="Telefon:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=2, column=0, sticky="w", padx=5, pady=3)
    telefon_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    telefon_entry.grid(row=2, column=1, padx=5, pady=3, sticky="ew")
    
    # Mail
    tk.Label(form_frame, text="Mail:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=3, column=0, sticky="w", padx=5, pady=3)
    mail_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    mail_entry.grid(row=3, column=1, padx=5, pady=3, sticky="ew")
    
    # Adres
    tk.Label(form_frame, text="Adres:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=4, column=0, sticky="nw", padx=5, pady=3)
    adres_text = tk.Text(form_frame, font=("Segoe UI", 9), width=25, height=3)
    adres_text.grid(row=4, column=1, padx=5, pady=3, sticky="ew")
    
    # AlÄ±m TÃ¼rÃ¼
    tk.Label(form_frame, text="AlÄ±m TÃ¼rÃ¼:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=5, column=0, sticky="w", padx=5, pady=3)
    alim_turu_var = tk.StringVar(value="KumaÅŸ")
    alim_turu_combo = ttk.Combobox(form_frame, textvariable=alim_turu_var, 
                                   values=["KumaÅŸ", "Fire", "Tekleme", "Aksesuar", "DiÄŸer"],
                                   state="readonly", font=("Segoe UI", 9), width=23)
    alim_turu_combo.grid(row=5, column=1, padx=5, pady=3, sticky="ew")
    
    # Eksik Evraklar (Checkbox'lar)
    tk.Label(form_frame, text="Eksik Evraklar:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=6, column=0, sticky="nw", padx=5, pady=3)
    
    eksik_evrak_frame = tk.Frame(form_frame, bg="white")
    eksik_evrak_frame.grid(row=6, column=1, padx=5, pady=3, sticky="w")
    
    evrak_checkboxes = {}
    evrak_tipleri = ["SÃ¶zleÅŸme", "Sertifika", "Vergi LevhasÄ±", "Ä°mza SirkÃ¼leri", "Fatura Bilgileri"]
    for i, evrak in enumerate(evrak_tipleri):
        var = tk.BooleanVar()
        evrak_checkboxes[evrak] = var
        tk.Checkbutton(eksik_evrak_frame, text=evrak, variable=var, 
                      font=("Segoe UI", 8), bg="white").grid(row=i, column=0, sticky="w")
    
    # SÃ¶zleÅŸme BitiÅŸ Tarihi
    tk.Label(form_frame, text="SÃ¶zleÅŸme BitiÅŸ:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=7, column=0, sticky="w", padx=5, pady=3)
    sozlesme_date_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    sozlesme_date_entry.grid(row=7, column=1, padx=5, pady=3, sticky="ew")
    sozlesme_date_entry.insert(0, "YYYY-MM-DD")
    sozlesme_date_entry.config(fg="gray")
    
    def sozlesme_date_focus_in(event):
        if sozlesme_date_entry.get() == "YYYY-MM-DD":
            sozlesme_date_entry.delete(0, tk.END)
            sozlesme_date_entry.config(fg="black")
    
    def sozlesme_date_focus_out(event):
        if not sozlesme_date_entry.get():
            sozlesme_date_entry.insert(0, "YYYY-MM-DD")
            sozlesme_date_entry.config(fg="gray")
    
    sozlesme_date_entry.bind("<FocusIn>", sozlesme_date_focus_in)
    sozlesme_date_entry.bind("<FocusOut>", sozlesme_date_focus_out)
    
    # Sertifika BitiÅŸ Tarihi
    tk.Label(form_frame, text="Sertifika BitiÅŸ:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=8, column=0, sticky="w", padx=5, pady=3)
    sertifika_date_entry = tk.Entry(form_frame, font=("Segoe UI", 9), width=25)
    sertifika_date_entry.grid(row=8, column=1, padx=5, pady=3, sticky="ew")
    sertifika_date_entry.insert(0, "YYYY-MM-DD")
    sertifika_date_entry.config(fg="gray")
    
    def sertifika_date_focus_in(event):
        if sertifika_date_entry.get() == "YYYY-MM-DD":
            sertifika_date_entry.delete(0, tk.END)
            sertifika_date_entry.config(fg="black")
    
    def sertifika_date_focus_out(event):
        if not sertifika_date_entry.get():
            sertifika_date_entry.insert(0, "YYYY-MM-DD")
            sertifika_date_entry.config(fg="gray")
    
    sertifika_date_entry.bind("<FocusIn>", sertifika_date_focus_in)
    sertifika_date_entry.bind("<FocusOut>", sertifika_date_focus_out)
    
    form_frame.grid_columnconfigure(1, weight=1)
    
    # Form butonlarÄ±
    form_btn_frame = tk.Frame(form_section, bg="white")
    form_btn_frame.pack(fill="x", pady=(10, 0))
    
    def clear_cari_form():
        """Formu temizle"""
        tedarikci_adi_entry.delete(0, tk.END)
        yetkili_kisi_entry.delete(0, tk.END)
        telefon_entry.delete(0, tk.END)
        mail_entry.delete(0, tk.END)
        adres_text.delete("1.0", tk.END)
        alim_turu_var.set("KumaÅŸ")
        for var in evrak_checkboxes.values():
            var.set(False)
        sozlesme_date_entry.delete(0, tk.END)
        sozlesme_date_entry.insert(0, "YYYY-MM-DD")
        sozlesme_date_entry.config(fg="gray")
        sertifika_date_entry.delete(0, tk.END)
        sertifika_date_entry.insert(0, "YYYY-MM-DD")
        sertifika_date_entry.config(fg="gray")
    
    def save_cari_form():
        """Formu kaydet"""
        # Verileri topla
        tedarikci = tedarikci_adi_entry.get().strip()
        yetkili = yetkili_kisi_entry.get().strip()
        telefon = telefon_entry.get().strip()
        mail = mail_entry.get().strip()
        adres = adres_text.get("1.0", tk.END).strip()
        alim_turu = alim_turu_var.get()
        
        # Tarih bilgilerini al
        sozlesme_bitis = sozlesme_date_entry.get().strip()
        if sozlesme_bitis == "YYYY-MM-DD" or not sozlesme_bitis:
            sozlesme_bitis = ""
        
        sertifika_bitis = sertifika_date_entry.get().strip()
        if sertifika_bitis == "YYYY-MM-DD" or not sertifika_bitis:
            sertifika_bitis = ""
        
        # Eksik evraklarÄ± topla
        eksik_evraklar = [evrak for evrak, var in evrak_checkboxes.items() if var.get()]
        eksik_evrak_str = ", ".join(eksik_evraklar) if eksik_evraklar else "Yok"
        
        # Zorunlu alanlarÄ± kontrol et
        if not tedarikci:
            messagebox.showwarning("UyarÄ±", "TedarikÃ§i adÄ± zorunludur!")
            return
        
        if not mail:
            messagebox.showwarning("UyarÄ±", "Mail adresi zorunludur!")
            return
        
        # Veriyi kaydet
        data = {
            'tedarikci_adi': tedarikci,
            'yetkili_kisi': yetkili,
            'telefon': telefon,
            'adres': adres,
            'alim_turu': alim_turu,
            'mail': mail,
            'eksik_evraklar': eksik_evrak_str,
            'sozlesme_bitis': sozlesme_bitis,
            'sertifika_bitis': sertifika_bitis
        }
        
        success, message = save_cari_bilgi(data)
        
        if success:
            messagebox.showinfo("BaÅŸarÄ±lÄ±", message)
            clear_cari_form()
            refresh_cari_list()
            activity_logger.log_event("CARI_BILGI_SAVED", f"TedarikÃ§i: {tedarikci}", "TedarikÃ§i Uyumluluk")
        else:
            messagebox.showerror("Hata", message)
    
    tk.Button(form_btn_frame, text="ğŸ’¾ Kaydet", font=("Segoe UI", 9, "bold"),
             bg="#27ae60", fg="white", cursor="hand2", padx=10, pady=5,
             command=save_cari_form).pack(side="left", padx=5)
    
    tk.Button(form_btn_frame, text="ğŸ”„ Temizle", font=("Segoe UI", 9, "bold"),
             bg="#95a5a6", fg="white", cursor="hand2", padx=10, pady=5,
             command=clear_cari_form).pack(side="left", padx=5)
    
    def read_from_pdf():
        """PDF'den AI ile bilgileri oku ve formu doldur"""
        # PDF seÃ§
        pdf_path = filedialog.askopenfilename(
            title="SÃ¶zleÅŸme veya Sertifika PDF'i SeÃ§in",
            filetypes=[("PDF DosyalarÄ±", "*.pdf"), ("TÃ¼m Dosyalar", "*.*")],
            initialdir=MASTER_SOZLESME_PATH if os.path.exists(MASTER_SOZLESME_PATH) else None
        )
        
        if not pdf_path:
            return
        
        # Ä°ÅŸlem gÃ¶stergesi
        progress_window = tk.Toplevel()
        progress_window.title("AI Ä°ÅŸleniyor")
        progress_window.geometry("400x150")
        progress_window.transient(frame_compliance)
        progress_window.grab_set()
        
        tk.Label(progress_window, text="ğŸ¤– Yapay Zeka PDF'i Analiz Ediyor...", 
                font=("Segoe UI", 12, "bold")).pack(pady=20)
        tk.Label(progress_window, text="LÃ¼tfen bekleyin...", 
                font=("Segoe UI", 10)).pack(pady=10)
        
        progress_label = tk.Label(progress_window, text="PDF okunuyor...", 
                                 font=("Segoe UI", 9))
        progress_label.pack(pady=10)
        
        progress_window.update()
        
        def process_pdf():
            try:
                progress_label.config(text="AI ile analiz ediliyor...")
                progress_window.update()
                
                # AI ile analiz
                result = extract_supplier_info_from_pdf(pdf_path)
                
                progress_window.destroy()
                
                if "error" in result:
                    messagebox.showerror("Hata", f"PDF analizi baÅŸarÄ±sÄ±z:\n{result['error']}")
                    return
                
                if result.get("success") and "data" in result:
                    data = result["data"]
                    
                    # Formu doldur
                    if data.get("tedarikci_adi"):
                        tedarikci_adi_entry.delete(0, tk.END)
                        tedarikci_adi_entry.insert(0, data["tedarikci_adi"])
                    
                    if data.get("yetkili_kisi"):
                        yetkili_kisi_entry.delete(0, tk.END)
                        yetkili_kisi_entry.insert(0, data["yetkili_kisi"])
                    
                    if data.get("telefon"):
                        telefon_entry.delete(0, tk.END)
                        telefon_entry.insert(0, data["telefon"])
                    
                    if data.get("mail"):
                        mail_entry.delete(0, tk.END)
                        mail_entry.insert(0, data["mail"])
                    
                    if data.get("adres"):
                        adres_text.delete("1.0", tk.END)
                        adres_text.insert("1.0", data["adres"])
                    
                    if data.get("alim_turu") and data["alim_turu"] in ["KumaÅŸ", "Fire", "Tekleme", "Aksesuar", "DiÄŸer"]:
                        alim_turu_var.set(data["alim_turu"])
                    
                    if data.get("sozlesme_bitis") and data["sozlesme_bitis"] != "null":
                        sozlesme_date_entry.delete(0, tk.END)
                        sozlesme_date_entry.insert(0, data["sozlesme_bitis"])
                        sozlesme_date_entry.config(fg="black")
                    
                    if data.get("sertifika_bitis") and data["sertifika_bitis"] != "null":
                        sertifika_date_entry.delete(0, tk.END)
                        sertifika_date_entry.insert(0, data["sertifika_bitis"])
                        sertifika_date_entry.config(fg="black")
                    
                    messagebox.showinfo("BaÅŸarÄ±lÄ±", 
                                      f"âœ… PDF'den bilgiler Ã§Ä±karÄ±ldÄ±!\n\n"
                                      f"Belge TÃ¼rÃ¼: {data.get('belge_turu', 'Bilinmiyor')}\n"
                                      f"TedarikÃ§i: {data.get('tedarikci_adi', '-')}\n\n"
                                      f"LÃ¼tfen bilgileri kontrol edin ve 'Kaydet' butonuna tÄ±klayÄ±n.")
                else:
                    messagebox.showwarning("UyarÄ±", 
                                         "PDF analiz edildi ancak yapÄ±landÄ±rÄ±lmÄ±ÅŸ veri Ã§Ä±karÄ±lamadÄ±.\n\n"
                                         f"Ham YanÄ±t:\n{result.get('raw_text', 'Veri yok')[:500]}")
            
            except Exception as e:
                progress_window.destroy()
                messagebox.showerror("Hata", f"Beklenmeyen hata:\n{str(e)}")
                import traceback
                traceback.print_exc()
        
        # Thread'de Ã§alÄ±ÅŸtÄ±r (UI donmasÄ±nÄ± Ã¶nlemek iÃ§in)
        threading.Thread(target=process_pdf, daemon=True).start()
    
    tk.Button(form_btn_frame, text="ğŸ¤– PDF'den Oku", font=("Segoe UI", 9, "bold"),
             bg="#9b59b6", fg="white", cursor="hand2", padx=10, pady=5,
             command=read_from_pdf).pack(side="left", padx=5)
    
    def add_test_data():
        """Test iÃ§in Ã¶rnek veri ekle"""
        result = messagebox.askyesno("Test Verisi Ekle", 
                                     "5 adet Ã¶rnek tedarikÃ§i kaydÄ± eklenecek.\n\n"
                                     "Bu test verileri alarm sistemini test etmek iÃ§indir.\n"
                                     "Devam etmek istiyor musunuz?")
        if result:
            success, message = generate_sample_cari_data()
            if success:
                messagebox.showinfo("BaÅŸarÄ±lÄ±", f"âœ… {message}\n\nAlarm sistemi artÄ±k Ã§alÄ±ÅŸmalÄ±.")
                refresh_cari_list()
                # Alarm display'i gÃ¼ncelle
                if 'update_all_displays' in dir():
                    update_all_displays()
            else:
                messagebox.showerror("Hata", f"Test verisi eklenemedi:\n{message}")
    
    tk.Button(form_btn_frame, text="ğŸ§ª Test Verisi Ekle", font=("Segoe UI", 9, "bold"),
             bg="#3498db", fg="white", cursor="hand2", padx=10, pady=5,
             command=add_test_data).pack(side="left", padx=5)
    
    # SaÄŸ: Cari Bilgileri Listesi
    list_section = tk.LabelFrame(top_section, text="ğŸ“‹ KayÄ±tlÄ± Cari Bilgileri", 
                                 font=("Segoe UI", 11, "bold"), bg="white", fg="#c0392b",
                                 padx=10, pady=10, relief="solid", bd=1)
    list_section.grid(row=0, column=1, padx=5, pady=5, sticky="nsew")
    
    # Arama ve filtre Ã§ubuÄŸu
    search_frame = tk.Frame(list_section, bg="white")
    search_frame.pack(fill="x", pady=(0, 5))
    
    tk.Label(search_frame, text="ğŸ” Ara:", font=("Segoe UI", 9, "bold"),
             bg="white").pack(side="left", padx=5)
    search_var = tk.StringVar()
    search_entry = tk.Entry(search_frame, textvariable=search_var, font=("Segoe UI", 9), width=20)
    search_entry.pack(side="left", padx=5)
    
    tk.Label(search_frame, text="AlÄ±m TÃ¼rÃ¼:", font=("Segoe UI", 9, "bold"),
             bg="white").pack(side="left", padx=(10, 5))
    filter_var = tk.StringVar(value="TÃ¼mÃ¼")
    filter_combo = ttk.Combobox(search_frame, textvariable=filter_var,
                                values=["TÃ¼mÃ¼", "KumaÅŸ", "Fire", "Tekleme", "Aksesuar", "DiÄŸer"],
                                state="readonly", font=("Segoe UI", 9), width=12)
    filter_combo.pack(side="left", padx=5)
    
    def apply_filter():
        refresh_cari_list()
    
    tk.Button(search_frame, text="Ara", font=("Segoe UI", 8, "bold"),
             bg="#3498db", fg="white", cursor="hand2", padx=8, pady=2,
             command=apply_filter).pack(side="left", padx=5)
    
    tk.Button(search_frame, text="ğŸ”„", font=("Segoe UI", 8, "bold"),
             bg="#95a5a6", fg="white", cursor="hand2", padx=6, pady=2,
             command=lambda: (search_var.set(""), filter_var.set("TÃ¼mÃ¼"), refresh_cari_list())).pack(side="left", padx=2)
    
    # Treeview iÃ§in container
    tree_container = tk.Frame(list_section, bg="white")
    tree_container.pack(fill="both", expand=True)
    
    # Scrollbar'lar
    tree_scroll_y = ttk.Scrollbar(tree_container, orient="vertical")
    tree_scroll_y.pack(side="right", fill="y")
    
    tree_scroll_x = ttk.Scrollbar(tree_container, orient="horizontal")
    tree_scroll_x.pack(side="bottom", fill="x")
    
    # Treeview
    columns = ("TedarikÃ§i", "Yetkili", "Telefon", "Mail", "AlÄ±m TÃ¼rÃ¼", "Eksik Evraklar", "Tarih")
    cari_tree = ttk.Treeview(tree_container, columns=columns, show="tree headings", 
                            yscrollcommand=tree_scroll_y.set, xscrollcommand=tree_scroll_x.set,
                            selectmode="extended",  # Multi-select desteÄŸi
                            height=10)
    cari_tree.pack(fill="both", expand=True)
    
    tree_scroll_y.config(command=cari_tree.yview)
    tree_scroll_x.config(command=cari_tree.xview)
    
    # Checkbox durumlarÄ± iÃ§in dictionary
    checkbox_states = {}
    
    # Treeview'e tÄ±klama eventi ekle (checkbox toggle iÃ§in)
    def toggle_checkbox(event):
        """Checkbox'Ä± tÄ±klandÄ±ÄŸÄ±nda deÄŸiÅŸtir"""
        region = cari_tree.identify("region", event.x, event.y)
        if region == "tree":
            item = cari_tree.identify_row(event.y)
            if item:
                # Checkbox durumunu deÄŸiÅŸtir
                current_text = cari_tree.item(item, "text")
                if current_text == "â˜":
                    cari_tree.item(item, text="â˜‘")
                    checkbox_states[item] = True
                else:
                    cari_tree.item(item, text="â˜")
                    checkbox_states[item] = False
    
    cari_tree.bind("<Button-1>", toggle_checkbox)
    
    # SÃ¼tun ayarlarÄ±
    cari_tree.column("#0", width=40, minwidth=40)
    cari_tree.column("TedarikÃ§i", width=150, minwidth=100)
    cari_tree.column("Yetkili", width=120, minwidth=100)
    cari_tree.column("Telefon", width=100, minwidth=80)
    cari_tree.column("Mail", width=150, minwidth=100)
    cari_tree.column("AlÄ±m TÃ¼rÃ¼", width=100, minwidth=80)
    cari_tree.column("Eksik Evraklar", width=200, minwidth=150)
    cari_tree.column("Tarih", width=130, minwidth=100)
    
    # BaÅŸlÄ±klar
    cari_tree.heading("#0", text="â˜‘")
    cari_tree.heading("TedarikÃ§i", text="TedarikÃ§i AdÄ±")
    cari_tree.heading("Yetkili", text="Yetkili KiÅŸi")
    cari_tree.heading("Telefon", text="Telefon")
    cari_tree.heading("Mail", text="Mail")
    cari_tree.heading("AlÄ±m TÃ¼rÃ¼", text="AlÄ±m TÃ¼rÃ¼")
    cari_tree.heading("Eksik Evraklar", text="Eksik Evraklar")
    cari_tree.heading("Tarih", text="KayÄ±t Tarihi")
    
    def refresh_cari_list():
        """Cari listesini yenile"""
        # Mevcut kayÄ±tlarÄ± temizle
        for item in cari_tree.get_children():
            cari_tree.delete(item)
        
        # Checkbox durumlarÄ±nÄ± temizle
        checkbox_states.clear()
        
        # Verileri yÃ¼kle
        records = load_cari_bilgiler()
        
        # Filtreleri uygula
        search_text = search_var.get().strip().lower()
        filter_alim = filter_var.get()
        
        for idx, record in enumerate(records):
            # Arama filtresi
            if search_text:
                tedarikci = str(record.get('TedarikÃ§i AdÄ±', '')).lower()
                yetkili = str(record.get('Yetkili KiÅŸi', '')).lower()
                if search_text not in tedarikci and search_text not in yetkili:
                    continue
            
            # AlÄ±m tÃ¼rÃ¼ filtresi
            if filter_alim != "TÃ¼mÃ¼":
                if str(record.get('AlÄ±m TÃ¼rÃ¼', '')) != filter_alim:
                    continue
            
            # KayÄ±t ekle
            values = (
                str(record.get('TedarikÃ§i AdÄ±', '')),
                str(record.get('Yetkili KiÅŸi', '')),
                str(record.get('Telefon', '')),
                str(record.get('Mail', '')),
                str(record.get('AlÄ±m TÃ¼rÃ¼', '')),
                str(record.get('Eksik Evraklar', '')),
                str(record.get('KayÄ±t Tarihi', ''))
            )
            item_id = cari_tree.insert("", "end", text="â˜", values=values, tags=(idx,))
            checkbox_states[item_id] = False
    
    # Ä°lk yÃ¼kleme
    refresh_cari_list()
    
    # Orta kÄ±sÄ±m: SÃ¶zleÅŸme ve Sertifika Alarm Paneli
    alarm_panel_section = tk.LabelFrame(cari_panel, text="â° SÃ¶zleÅŸme ve Sertifika Alarm Sistemi", 
                                       font=("Segoe UI", 11, "bold"), bg="white", fg="#8e44ad",
                                       padx=10, pady=10, relief="solid", bd=1)
    alarm_panel_section.pack(fill="both", expand=False, pady=(5, 0))
    
    alarm_frame = tk.Frame(alarm_panel_section, bg="white")
    alarm_frame.pack(fill="both", expand=True)
    
    def check_expiration_status():
        """SÃ¶zleÅŸme ve sertifikalarÄ±n sÃ¼re durumunu kontrol et"""
        from datetime import datetime, timedelta
        
        records = load_cari_bilgiler()
        today = datetime.now().date()
        
        # Debug logging
        print(f"\n[ALARM DEBUG] Toplam kayÄ±t sayÄ±sÄ±: {len(records)}")
        
        results = {
            'sozlesme_expired': [],
            'sozlesme_expiring': [],
            'sozlesme_valid': [],
            'sertifika_expired': [],
            'sertifika_expiring': [],
            'sertifika_valid': []
        }
        
        sozlesme_checked = 0
        sertifika_checked = 0
        sozlesme_parse_errors = 0
        sertifika_parse_errors = 0
        
        for idx, record in enumerate(records):
            tedarikci = record.get('TedarikÃ§i AdÄ±', '')
            mail = record.get('Mail', '')
            
            # Debug: Show first record details
            if idx == 0:
                print(f"[ALARM DEBUG] Ä°lk kayÄ±t sÃ¼tunlarÄ±: {list(record.keys())}")
                print(f"[ALARM DEBUG] Ä°lk kayÄ±t - TedarikÃ§i: {tedarikci}")
            
            # SÃ¶zleÅŸme kontrolÃ¼
            sozlesme_str = str(record.get('SÃ¶zleÅŸme BitiÅŸ Tarihi', '')).strip()
            if idx == 0:
                print(f"[ALARM DEBUG] Ä°lk kayÄ±t - SÃ¶zleÅŸme deÄŸeri: '{sozlesme_str}'")
            
            if sozlesme_str and sozlesme_str != '' and sozlesme_str != 'nan':
                sozlesme_checked += 1
                try:
                    sozlesme_date = datetime.strptime(sozlesme_str[:10], '%Y-%m-%d').date()
                    days_diff = (sozlesme_date - today).days
                    
                    if days_diff < 0:
                        results['sozlesme_expired'].append({
                            'tedarikci': tedarikci,
                            'mail': mail,
                            'date': sozlesme_str,
                            'days': abs(days_diff)
                        })
                    elif days_diff <= 15:
                        results['sozlesme_expiring'].append({
                            'tedarikci': tedarikci,
                            'mail': mail,
                            'date': sozlesme_str,
                            'days': days_diff
                        })
                    else:
                        results['sozlesme_valid'].append({
                            'tedarikci': tedarikci,
                            'date': sozlesme_str,
                            'days': days_diff
                        })
                except Exception as e:
                    sozlesme_parse_errors += 1
                    if sozlesme_parse_errors <= 3:  # Log first 3 errors
                        print(f"[ALARM DEBUG] SÃ¶zleÅŸme parse hatasÄ± ({tedarikci}): {sozlesme_str} - {e}")
            
            # Sertifika kontrolÃ¼
            sertifika_str = str(record.get('Sertifika BitiÅŸ Tarihi', '')).strip()
            if idx == 0:
                print(f"[ALARM DEBUG] Ä°lk kayÄ±t - Sertifika deÄŸeri: '{sertifika_str}'")
            
            if sertifika_str and sertifika_str != '' and sertifika_str != 'nan':
                sertifika_checked += 1
                try:
                    sertifika_date = datetime.strptime(sertifika_str[:10], '%Y-%m-%d').date()
                    days_diff = (sertifika_date - today).days
                    
                    if days_diff < 0:
                        results['sertifika_expired'].append({
                            'tedarikci': tedarikci,
                            'mail': mail,
                            'date': sertifika_str,
                            'days': abs(days_diff)
                        })
                    elif days_diff <= 15:
                        results['sertifika_expiring'].append({
                            'tedarikci': tedarikci,
                            'mail': mail,
                            'date': sertifika_str,
                            'days': days_diff
                        })
                    else:
                        results['sertifika_valid'].append({
                            'tedarikci': tedarikci,
                            'date': sertifika_str,
                            'days': days_diff
                        })
                except Exception as e:
                    sertifika_parse_errors += 1
                    if sertifika_parse_errors <= 3:  # Log first 3 errors
                        print(f"[ALARM DEBUG] Sertifika parse hatasÄ± ({tedarikci}): {sertifika_str} - {e}")
        
        # Summary logging
        print(f"[ALARM DEBUG] Ä°ÅŸlenen sÃ¶zleÅŸme sayÄ±sÄ±: {sozlesme_checked}")
        print(f"[ALARM DEBUG] Ä°ÅŸlenen sertifika sayÄ±sÄ±: {sertifika_checked}")
        print(f"[ALARM DEBUG] SÃ¶zleÅŸme parse hatalarÄ±: {sozlesme_parse_errors}")
        print(f"[ALARM DEBUG] Sertifika parse hatalarÄ±: {sertifika_parse_errors}")
        print(f"[ALARM DEBUG] SonuÃ§ - SÃ¶zleÅŸme sÃ¼resi dolmuÅŸ: {len(results['sozlesme_expired'])}")
        print(f"[ALARM DEBUG] SonuÃ§ - SÃ¶zleÅŸme yakÄ±nda dolacak: {len(results['sozlesme_expiring'])}")
        print(f"[ALARM DEBUG] SonuÃ§ - SÃ¶zleÅŸme geÃ§erli: {len(results['sozlesme_valid'])}")
        print(f"[ALARM DEBUG] SonuÃ§ - Sertifika sÃ¼resi dolmuÅŸ: {len(results['sertifika_expired'])}")
        print(f"[ALARM DEBUG] SonuÃ§ - Sertifika yakÄ±nda dolacak: {len(results['sertifika_expiring'])}")
        print(f"[ALARM DEBUG] SonuÃ§ - Sertifika geÃ§erli: {len(results['sertifika_valid'])}\n")
        
        return results
    
    # Alarm gÃ¶sterge frame'leri
    indicators_frame = tk.Frame(alarm_frame, bg="white")
    indicators_frame.pack(fill="x", pady=5)
    
    # SÃ¶zleÅŸme gÃ¶stergeleri
    sozlesme_frame = tk.LabelFrame(indicators_frame, text="ğŸ“„ SÃ¶zleÅŸme Durumu", 
                                   font=("Segoe UI", 10, "bold"), bg="white", fg="#2c3e50",
                                   relief="solid", bd=1, padx=10, pady=5)
    sozlesme_frame.pack(side="left", fill="both", expand=True, padx=5)
    
    sozlesme_expired_label = tk.Label(sozlesme_frame, text="ğŸ”´ SÃ¼resi DolmuÅŸ: 0", 
                                     font=("Segoe UI", 9), bg="white", fg="#e74c3c")
    sozlesme_expired_label.pack(anchor="w", pady=2)
    
    sozlesme_expiring_label = tk.Label(sozlesme_frame, text="ğŸŸ¡ YakÄ±nda Dolacak: 0", 
                                      font=("Segoe UI", 9), bg="white", fg="#f39c12")
    sozlesme_expiring_label.pack(anchor="w", pady=2)
    
    sozlesme_valid_label = tk.Label(sozlesme_frame, text="ğŸŸ¢ GeÃ§erli: 0", 
                                    font=("Segoe UI", 9), bg="white", fg="#27ae60")
    sozlesme_valid_label.pack(anchor="w", pady=2)
    
    # Sertifika gÃ¶stergeleri
    sertifika_frame = tk.LabelFrame(indicators_frame, text="ğŸ… Sertifika Durumu", 
                                    font=("Segoe UI", 10, "bold"), bg="white", fg="#2c3e50",
                                    relief="solid", bd=1, padx=10, pady=5)
    sertifika_frame.pack(side="left", fill="both", expand=True, padx=5)
    
    sertifika_expired_label = tk.Label(sertifika_frame, text="ğŸ”´ SÃ¼resi DolmuÅŸ: 0", 
                                      font=("Segoe UI", 9), bg="white", fg="#e74c3c")
    sertifika_expired_label.pack(anchor="w", pady=2)
    
    sertifika_expiring_label = tk.Label(sertifika_frame, text="ğŸŸ¡ YakÄ±nda Dolacak: 0", 
                                       font=("Segoe UI", 9), bg="white", fg="#f39c12")
    sertifika_expiring_label.pack(anchor="w", pady=2)
    
    sertifika_valid_label = tk.Label(sertifika_frame, text="ğŸŸ¢ GeÃ§erli: 0", 
                                     font=("Segoe UI", 9), bg="white", fg="#27ae60")
    sertifika_valid_label.pack(anchor="w", pady=2)
    
    def update_alarm_display():
        """Alarm gÃ¶stergelerini gÃ¼ncelle"""
        results = check_expiration_status()
        
        # SÃ¶zleÅŸme sayÄ±larÄ±nÄ± gÃ¼ncelle
        sozlesme_expired_label.config(text=f"ğŸ”´ SÃ¼resi DolmuÅŸ: {len(results['sozlesme_expired'])}")
        sozlesme_expiring_label.config(text=f"ğŸŸ¡ YakÄ±nda Dolacak (â‰¤15 gÃ¼n): {len(results['sozlesme_expiring'])}")
        sozlesme_valid_label.config(text=f"ğŸŸ¢ GeÃ§erli: {len(results['sozlesme_valid'])}")
        
        # Sertifika sayÄ±larÄ±nÄ± gÃ¼ncelle
        sertifika_expired_label.config(text=f"ğŸ”´ SÃ¼resi DolmuÅŸ: {len(results['sertifika_expired'])}")
        sertifika_expiring_label.config(text=f"ğŸŸ¡ YakÄ±nda Dolacak (â‰¤15 gÃ¼n): {len(results['sertifika_expiring'])}")
        sertifika_valid_label.config(text=f"ğŸŸ¢ GeÃ§erli: {len(results['sertifika_valid'])}")
        
        # EÄŸer tÃ¼m sayÄ±lar 0 ise kullanÄ±cÄ±ya bilgi gÃ¶ster
        total_count = (len(results['sozlesme_expired']) + len(results['sozlesme_expiring']) + 
                      len(results['sozlesme_valid']) + len(results['sertifika_expired']) + 
                      len(results['sertifika_expiring']) + len(results['sertifika_valid']))
        
        if total_count == 0:
            print("\n" + "="*70)
            print("âš ï¸  UYARI: Alarm sistemi veri bulamadÄ±!")
            print("="*70)
            print("TÃ¼m sayaÃ§lar 0 gÃ¶steriyor. OlasÄ± nedenler:")
            print("1. Excel dosyasÄ±nda veri yok (sadece baÅŸlÄ±klar var)")
            print("2. 'SÃ¶zleÅŸme BitiÅŸ Tarihi' ve 'Sertifika BitiÅŸ Tarihi' sÃ¼tunlarÄ± boÅŸ")
            print("3. Tarih formatÄ± yanlÄ±ÅŸ (beklenen format: YYYY-MM-DD, Ã¶rn: 2026-02-15)")
            print("\nKonsol Ã§Ä±ktÄ±sÄ±nda [ALARM DEBUG] mesajlarÄ±na bakÄ±n.")
            print("="*70 + "\n")
    
    def send_expiration_alerts():
        """SÃ¼resi dolmuÅŸ ve dolmak Ã¼zere olanlara mail gÃ¶nder"""
        results = check_expiration_status()
        
        success_count = 0
        fail_count = 0
        
        # SÃ¶zleÅŸme uyarÄ±larÄ±
        for item in results['sozlesme_expired']:
            mail = str(item['mail']).strip()
            if not mail or mail == '' or mail == 'nan':
                fail_count += 1
                continue
                
            subject = "ğŸ”´ ACIL: SÃ¶zleÅŸme SÃ¼resi DolmuÅŸ!"
            content = f"""SayÄ±n {item['tedarikci']},

SÃ¶zleÅŸmenizin sÃ¼resi {item['days']} gÃ¼n Ã¶nce dolmuÅŸtur.

BitiÅŸ Tarihi: {item['date']}

LÃ¼tfen en kÄ±sa sÃ¼rede sÃ¶zleÅŸme yenileme iÅŸlemlerini baÅŸlatÄ±nÄ±z.

SaygÄ±larÄ±mÄ±zla,
TedarikÃ§i Uyumluluk Merkezi"""
            
            if send_single_alert_email(mail, subject, content):
                success_count += 1
            else:
                fail_count += 1
        
        for item in results['sozlesme_expiring']:
            mail = str(item['mail']).strip()
            if not mail or mail == '' or mail == 'nan':
                fail_count += 1
                continue
                
            subject = "ğŸŸ¡ UyarÄ±: SÃ¶zleÅŸmeniz YakÄ±nda Dolacak"
            content = f"""SayÄ±n {item['tedarikci']},

SÃ¶zleÅŸmenizin sÃ¼resi {item['days']} gÃ¼n iÃ§inde dolacaktÄ±r.

BitiÅŸ Tarihi: {item['date']}

LÃ¼tfen sÃ¶zleÅŸme yenileme iÅŸlemlerini planlayÄ±nÄ±z.

SaygÄ±larÄ±mÄ±zla,
TedarikÃ§i Uyumluluk Merkezi"""
            
            if send_single_alert_email(mail, subject, content):
                success_count += 1
            else:
                fail_count += 1
        
        # Sertifika uyarÄ±larÄ±
        for item in results['sertifika_expired']:
            mail = str(item['mail']).strip()
            if not mail or mail == '' or mail == 'nan':
                fail_count += 1
                continue
                
            subject = "ğŸ”´ ACIL: Sertifika SÃ¼resi DolmuÅŸ!"
            content = f"""SayÄ±n {item['tedarikci']},

SertifikanÄ±zÄ±n sÃ¼resi {item['days']} gÃ¼n Ã¶nce dolmuÅŸtur.

BitiÅŸ Tarihi: {item['date']}

LÃ¼tfen en kÄ±sa sÃ¼rede sertifika yenileme iÅŸlemlerini baÅŸlatÄ±nÄ±z.

SaygÄ±larÄ±mÄ±zla,
TedarikÃ§i Uyumluluk Merkezi"""
            
            if send_single_alert_email(mail, subject, content):
                success_count += 1
            else:
                fail_count += 1
        
        for item in results['sertifika_expiring']:
            mail = str(item['mail']).strip()
            if not mail or mail == '' or mail == 'nan':
                fail_count += 1
                continue
                
            subject = "ğŸŸ¡ UyarÄ±: SertifikanÄ±z YakÄ±nda Dolacak"
            content = f"""SayÄ±n {item['tedarikci']},

SertifikanÄ±zÄ±n sÃ¼resi {item['days']} gÃ¼n iÃ§inde dolacaktÄ±r.

BitiÅŸ Tarihi: {item['date']}

LÃ¼tfen sertifika yenileme iÅŸlemlerini planlayÄ±nÄ±z.

SaygÄ±larÄ±mÄ±zla,
TedarikÃ§i Uyumluluk Merkezi"""
            
            if send_single_alert_email(mail, subject, content):
                success_count += 1
            else:
                fail_count += 1
        
        messagebox.showinfo("Mail GÃ¶nderimi TamamlandÄ±", 
                          f"BaÅŸarÄ±lÄ±: {success_count}\nBaÅŸarÄ±sÄ±z: {fail_count}")
    
    def send_single_alert_email(to_email, subject, content):
        """Tek bir alarm maili gÃ¶nder"""
        try:
            msg = MIMEMultipart()
            msg['From'] = GMAIL_USER
            msg['To'] = to_email
            msg['Subject'] = subject
            
            html_content = f"""
            <html>
            <body style="font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333;">
                <div style="max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
                    <div style="background-color: #8e44ad; color: white; padding: 15px; border-radius: 5px 5px 0 0;">
                        <h2 style="margin: 0;">â° TedarikÃ§i Uyumluluk Alarm Sistemi</h2>
                    </div>
                    <div style="padding: 20px; background-color: #f9f9f9;">
                        <pre style="font-family: 'Segoe UI', Arial, sans-serif; white-space: pre-wrap; word-wrap: break-word;">{content}</pre>
                    </div>
                    <div style="text-align: center; padding: 10px; background-color: #ecf0f1; border-radius: 0 0 5px 5px; font-size: 12px; color: #7f8c8d;">
                        Bu email TedarikÃ§i Uyumluluk Sistemi tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.
                    </div>
                </div>
            </body>
            </html>
            """
            
            msg.attach(MIMEText(html_content, 'html'))
            
            server = smtplib.SMTP('smtp.gmail.com', 587)
            server.starttls()
            server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
            server.send_message(msg)
            server.quit()
            
            activity_logger.log_email_sent(to_email, subject, "Alarm Sistemi")
            return True
        except Exception as e:
            print(f"Mail gÃ¶nderme hatasÄ± ({to_email}): {e}")
            return False
    
    # Butonlar
    btn_frame = tk.Frame(alarm_frame, bg="white")
    btn_frame.pack(fill="x", pady=5)
    
    update_status_btn = tk.Button(btn_frame, text="ğŸ”„ Durumu GÃ¼ncelle", font=("Segoe UI", 9, "bold"),
             bg="#3498db", fg="white", cursor="hand2", padx=15, pady=5,
             command=update_alarm_display)
    update_status_btn.pack(side="left", padx=5)
    
    tk.Button(btn_frame, text="ğŸ“§ Alarm Maillerini GÃ¶nder", font=("Segoe UI", 9, "bold"),
             bg="#e74c3c", fg="white", cursor="hand2", padx=15, pady=5,
             command=send_expiration_alerts).pack(side="left", padx=5)
    
    # Ä°lk yÃ¼kleme
    update_alarm_display()
    
    # Yeni: DetaylÄ± SÃ¶zleÅŸme ve Sertifika Takip Tablosu
    detail_table_section = tk.LabelFrame(cari_panel, text="ğŸ“Š SÃ¶zleÅŸme ve Sertifika DetaylÄ± Takip Tablosu", 
                                        font=("Segoe UI", 11, "bold"), bg="white", fg="#2980b9",
                                        padx=10, pady=10, relief="solid", bd=1)
    detail_table_section.pack(fill="both", expand=True, pady=(5, 0))
    
    detail_frame = tk.Frame(detail_table_section, bg="white")
    detail_frame.pack(fill="both", expand=True)
    
    # Buton Ã§ubuÄŸu
    detail_btn_frame = tk.Frame(detail_frame, bg="white")
    detail_btn_frame.pack(fill="x", pady=(0, 5))
    
    # Treeview container
    detail_tree_container = tk.Frame(detail_frame, bg="white")
    detail_tree_container.pack(fill="both", expand=True)
    
    # Scrollbar'lar
    detail_scroll_y = ttk.Scrollbar(detail_tree_container, orient="vertical")
    detail_scroll_y.pack(side="right", fill="y")
    
    detail_scroll_x = ttk.Scrollbar(detail_tree_container, orient="horizontal")
    detail_scroll_x.pack(side="bottom", fill="x")
    
    # Treeview
    detail_columns = ("TedarikÃ§i", "TÃ¼r", "BitiÅŸ Tarihi", "Kalan GÃ¼n", "Durum")
    detail_tree = ttk.Treeview(detail_tree_container, columns=detail_columns, show="headings", 
                              yscrollcommand=detail_scroll_y.set, xscrollcommand=detail_scroll_x.set,
                              height=12)
    detail_tree.pack(fill="both", expand=True)
    
    detail_scroll_y.config(command=detail_tree.yview)
    detail_scroll_x.config(command=detail_tree.xview)
    
    # SÃ¼tun ayarlarÄ±
    detail_tree.column("TedarikÃ§i", width=250, minwidth=150)
    detail_tree.column("TÃ¼r", width=120, minwidth=100)
    detail_tree.column("BitiÅŸ Tarihi", width=120, minwidth=100)
    detail_tree.column("Kalan GÃ¼n", width=100, minwidth=80)
    detail_tree.column("Durum", width=150, minwidth=120)
    
    # BaÅŸlÄ±klar
    detail_tree.heading("TedarikÃ§i", text="TedarikÃ§i AdÄ±")
    detail_tree.heading("TÃ¼r", text="Belge TÃ¼rÃ¼")
    detail_tree.heading("BitiÅŸ Tarihi", text="BitiÅŸ Tarihi")
    detail_tree.heading("Kalan GÃ¼n", text="Kalan GÃ¼n")
    detail_tree.heading("Durum", text="Durum")
    
    # Tag'leri tanÄ±mla (color coding iÃ§in)
    detail_tree.tag_configure('expired', background='#ffcccc', foreground='#c0392b')  # AÃ§Ä±k kÄ±rmÄ±zÄ±
    detail_tree.tag_configure('expiring', background='#fff3cd', foreground='#f39c12')  # AÃ§Ä±k sarÄ±
    detail_tree.tag_configure('valid', background='#d4edda', foreground='#27ae60')  # AÃ§Ä±k yeÅŸil
    
    def get_status_and_tag(days_diff):
        """Helper function to determine status and tag based on days remaining"""
        if days_diff < 0:
            status = f"ğŸ”´ SÃ¼resi DolmuÅŸ ({abs(days_diff)} gÃ¼n Ã¶nce)"
            tag = 'expired'
        elif days_diff <= 15:
            status = f"ğŸŸ¡ YakÄ±nda Dolacak"
            tag = 'expiring'
        else:
            status = f"ğŸŸ¢ GeÃ§erli"
            tag = 'valid'
        return status, tag
    
    def refresh_detail_table():
        """DetaylÄ± tabloyu yenile"""
        # Mevcut kayÄ±tlarÄ± temizle
        for item in detail_tree.get_children():
            detail_tree.delete(item)
        
        records = load_cari_bilgiler()
        today = datetime.now().date()
        
        for record in records:
            tedarikci = record.get('TedarikÃ§i AdÄ±', '')
            alim_turu = record.get('AlÄ±m TÃ¼rÃ¼', '')
            
            # SÃ¶zleÅŸme bilgileri
            sozlesme_str = str(record.get('SÃ¶zleÅŸme BitiÅŸ Tarihi', '')).strip()
            if sozlesme_str and sozlesme_str != '' and sozlesme_str != 'nan':
                try:
                    sozlesme_date = datetime.strptime(sozlesme_str[:10], '%Y-%m-%d').date()
                    days_diff = (sozlesme_date - today).days
                    
                    # Durum ve renk belirleme
                    status, tag = get_status_and_tag(days_diff)
                    
                    values = (tedarikci, "SÃ¶zleÅŸme", sozlesme_str[:10], days_diff, status)
                    detail_tree.insert("", "end", values=values, tags=(tag,))
                except (ValueError, IndexError) as e:
                    print(f"SÃ¶zleÅŸme tarihi parse hatasÄ± ({tedarikci}): {e}")
            
            # Sertifika bilgileri
            sertifika_str = str(record.get('Sertifika BitiÅŸ Tarihi', '')).strip()
            if sertifika_str and sertifika_str != '' and sertifika_str != 'nan':
                try:
                    sertifika_date = datetime.strptime(sertifika_str[:10], '%Y-%m-%d').date()
                    days_diff = (sertifika_date - today).days
                    
                    # Durum ve renk belirleme
                    status, tag = get_status_and_tag(days_diff)
                    
                    # Fire Sales tedarikÃ§ileri iÃ§in sertifika Ã¶zellikle vurgulanÄ±r
                    is_fire_sales = alim_turu == 'Fire'
                    tur = "Sertifika (Fire Sales)" if is_fire_sales else "Sertifika"
                    values = (tedarikci, tur, sertifika_str[:10], days_diff, status)
                    detail_tree.insert("", "end", values=values, tags=(tag,))
                except (ValueError, IndexError) as e:
                    print(f"Sertifika tarihi parse hatasÄ± ({tedarikci}): {e}")
    
    # Yenile butonu
    refresh_btn = tk.Button(detail_btn_frame, text="ğŸ”„ Tabloyu Yenile", font=("Segoe UI", 9, "bold"),
             bg="#3498db", fg="white", cursor="hand2", padx=15, pady=5,
             command=refresh_detail_table)
    refresh_btn.pack(side="left", padx=5)
    
    # AÃ§Ä±klama etiketi
    legend_label = tk.Label(detail_btn_frame, 
                           text="Renk KodlarÄ±: ğŸ”´ KÄ±rmÄ±zÄ± = SÃ¼resi DolmuÅŸ | ğŸŸ¡ SarÄ± = YakÄ±nda Dolacak (â‰¤15 gÃ¼n) | ğŸŸ¢ YeÅŸil = GeÃ§erli (>15 gÃ¼n)", 
                           font=("Segoe UI", 8), bg="white", fg="#7f8c8d")
    legend_label.pack(side="left", padx=10)
    
    # Ä°lk yÃ¼kleme
    refresh_detail_table()
    
    # TÃ¼m gÃ¶stergeleri gÃ¼ncelleyen birleÅŸik fonksiyon
    def update_all_displays():
        """Hem alarm gÃ¶stergelerini hem de detay tablosunu gÃ¼ncelle"""
        update_alarm_display()
        refresh_detail_table()
    
    # Alarm panelindeki gÃ¼ncelleme butonunu yeniden yapÄ±landÄ±r (stored reference kullanarak)
    update_status_btn.config(command=update_all_displays)
    
    # Alt kÄ±sÄ±m: Mail GÃ¶nderim Paneli
    mail_panel_section = tk.LabelFrame(cari_panel, text="ğŸ“§ Mail GÃ¶nderim Paneli", 
                                      font=("Segoe UI", 11, "bold"), bg="white", fg="#d35400",
                                      padx=10, pady=10, relief="solid", bd=1)
    mail_panel_section.pack(fill="both", expand=True, pady=(5, 0))
    
    mail_frame = tk.Frame(mail_panel_section, bg="white")
    mail_frame.pack(fill="both", expand=True)
    
    # Mail ÅŸablonu seÃ§imi
    tk.Label(mail_frame, text="Mail Åablonu:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=0, column=0, sticky="w", padx=5, pady=5)
    
    mail_template_var = tk.StringVar(value="Evrak EksikliÄŸi Bildirimi")
    mail_templates = [
        "Evrak EksikliÄŸi Bildirimi",
        "SÃ¶zleÅŸme Yenileme HatÄ±rlatmasÄ±",
        "Sertifika GÃ¼ncellemesi",
        "Genel Bilgilendirme"
    ]
    mail_template_combo = ttk.Combobox(mail_frame, textvariable=mail_template_var,
                                       values=mail_templates, state="readonly",
                                       font=("Segoe UI", 9), width=30)
    mail_template_combo.grid(row=0, column=1, padx=5, pady=5, sticky="ew")
    
    # Mail konusu
    tk.Label(mail_frame, text="Konu:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=1, column=0, sticky="w", padx=5, pady=5)
    mail_subject_entry = tk.Entry(mail_frame, font=("Segoe UI", 9), width=50)
    mail_subject_entry.grid(row=1, column=1, padx=5, pady=5, sticky="ew")
    mail_subject_entry.insert(0, "TedarikÃ§i Evrak EksikliÄŸi Bildirimi")
    
    # Mail iÃ§eriÄŸi
    tk.Label(mail_frame, text="Ä°Ã§erik:", font=("Segoe UI", 9, "bold"),
             bg="white").grid(row=2, column=0, sticky="nw", padx=5, pady=5)
    
    mail_content_frame = tk.Frame(mail_frame, bg="white")
    mail_content_frame.grid(row=2, column=1, padx=5, pady=5, sticky="ew")
    
    mail_content_scroll = tk.Scrollbar(mail_content_frame, orient="vertical")
    mail_content_scroll.pack(side="right", fill="y")
    
    mail_content_text = tk.Text(mail_content_frame, font=("Segoe UI", 9), 
                               height=8, width=60, wrap="word",
                               yscrollcommand=mail_content_scroll.set)
    mail_content_text.pack(fill="both", expand=True)
    mail_content_scroll.config(command=mail_content_text.yview)
    
    # VarsayÄ±lan mail iÃ§eriÄŸi
    default_mail_content = """SayÄ±n {{Yetkili KiÅŸi}},

{{TedarikÃ§i AdÄ±}} firmasÄ± iÃ§in bazÄ± evraklarÄ±n eksik olduÄŸunu tespit ettik.

Eksik Evraklar:
{{Eksik Evraklar}}

LÃ¼tfen eksik evraklarÄ± en kÄ±sa sÃ¼rede tamamlayarak bize iletmenizi rica ederiz.

SaygÄ±larÄ±mÄ±zla,
TedarikÃ§i Uyumluluk Merkezi"""
    
    mail_content_text.insert("1.0", default_mail_content)
    
    mail_frame.grid_columnconfigure(1, weight=1)
    
    def update_mail_template():
        """Mail ÅŸablonunu gÃ¼ncelle"""
        template = mail_template_var.get()
        
        templates_content = {
            "Evrak EksikliÄŸi Bildirimi": {
                "subject": "TedarikÃ§i Evrak EksikliÄŸi Bildirimi",
                "content": default_mail_content
            },
            "SÃ¶zleÅŸme Yenileme HatÄ±rlatmasÄ±": {
                "subject": "SÃ¶zleÅŸme Yenileme HatÄ±rlatmasÄ±",
                "content": """SayÄ±n {{Yetkili KiÅŸi}},

{{TedarikÃ§i AdÄ±}} firmasÄ± ile yapÄ±lan sÃ¶zleÅŸmenin yenileme zamanÄ± yaklaÅŸmaktadÄ±r.

LÃ¼tfen sÃ¶zleÅŸme yenileme iÅŸlemleri iÃ§in bizimle iletiÅŸime geÃ§iniz.

SaygÄ±larÄ±mÄ±zla,
TedarikÃ§i Uyumluluk Merkezi"""
            },
            "Sertifika GÃ¼ncellemesi": {
                "subject": "Sertifika GÃ¼ncelleme Talebi",
                "content": """SayÄ±n {{Yetkili KiÅŸi}},

{{TedarikÃ§i AdÄ±}} firmasÄ±nÄ±n sertifikalarÄ±nÄ±n gÃ¼ncellenme zamanÄ± gelmiÅŸtir.

LÃ¼tfen gÃ¼ncel sertifikalarÄ±nÄ±zÄ± en kÄ±sa sÃ¼rede bize iletiniz.

SaygÄ±larÄ±mÄ±zla,
TedarikÃ§i Uyumluluk Merkezi"""
            },
            "Genel Bilgilendirme": {
                "subject": "Genel Bilgilendirme",
                "content": """SayÄ±n {{Yetkili KiÅŸi}},

{{TedarikÃ§i AdÄ±}} firmasÄ± iÃ§in genel bilgilendirme.

[Buraya mesajÄ±nÄ±zÄ± yazÄ±nÄ±z]

SaygÄ±larÄ±mÄ±zla,
TedarikÃ§i Uyumluluk Merkezi"""
            }
        }
        
        if template in templates_content:
            mail_subject_entry.delete(0, tk.END)
            mail_subject_entry.insert(0, templates_content[template]["subject"])
            
            mail_content_text.delete("1.0", tk.END)
            mail_content_text.insert("1.0", templates_content[template]["content"])
    
    mail_template_combo.bind("<<ComboboxSelected>>", lambda e: update_mail_template())
    
    # Mail butonlarÄ±
    mail_btn_frame = tk.Frame(mail_panel_section, bg="white")
    mail_btn_frame.pack(fill="x", pady=(10, 0))
    
    def send_single_email():
        """SeÃ§ili veya iÅŸaretli tedarikÃ§iye mail gÃ¶nder"""
        # Ã–nce iÅŸaretli (checkbox) Ã¶ÄŸeleri kontrol et
        checked_items = [item for item, checked in checkbox_states.items() if checked]
        
        # EÄŸer checkbox iÅŸaretli deÄŸilse, seÃ§ili Ã¶ÄŸeleri kullan
        if not checked_items:
            checked_items = cari_tree.selection()
        
        if not checked_items:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen mail gÃ¶ndermek iÃ§in tedarikÃ§ileri iÅŸaretleyin veya seÃ§in!\n\n" +
                                 "Ä°pucu: TedarikÃ§i satÄ±rÄ±nÄ±n en solundaki kutucuÄŸa tÄ±klayarak iÅŸaretleyebilirsiniz.")
            return
        
        subject = mail_subject_entry.get().strip()
        content = mail_content_text.get("1.0", tk.END).strip()
        
        if not subject or not content:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen mail konusu ve iÃ§eriÄŸini doldurun!")
            return
        
        success_count = 0
        fail_count = 0
        empty_email_count = 0
        
        for item in checked_items:
            values = cari_tree.item(item)["values"]
            if not values or len(values) < 6:
                continue
                
            tedarikci = str(values[0]) if len(values) > 0 else ''
            yetkili = str(values[1]) if len(values) > 1 else ''
            mail = str(values[3]) if len(values) > 3 else ''
            eksik_evraklar = str(values[5]) if len(values) > 5 else ''
            
            # Mail adresini kontrol et
            mail = mail.strip()
            if not mail or mail == '' or mail == 'nan':
                print(f"BoÅŸ mail adresi atlaniyor: {tedarikci}")
                empty_email_count += 1
                fail_count += 1
                continue
            
            # Mail iÃ§eriÄŸini kiÅŸiselleÅŸtir
            personalized_content = content.replace("{{TedarikÃ§i AdÄ±}}", tedarikci)
            personalized_content = personalized_content.replace("{{Yetkili KiÅŸi}}", yetkili)
            personalized_content = personalized_content.replace("{{Eksik Evraklar}}", eksik_evraklar)
            
            try:
                # SMTP ile mail gÃ¶nder
                msg = MIMEMultipart()
                msg['From'] = GMAIL_USER
                msg['To'] = mail
                msg['Subject'] = subject
                
                # HTML formatÄ±nda mail iÃ§eriÄŸi
                html_content = f"""
                <html>
                <body style="font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333;">
                    <div style="max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
                        <div style="background-color: #16a085; color: white; padding: 15px; border-radius: 5px 5px 0 0;">
                            <h2 style="margin: 0;">ğŸ›ï¸ TedarikÃ§i Uyumluluk Merkezi</h2>
                        </div>
                        <div style="padding: 20px; background-color: #f9f9f9;">
                            <pre style="font-family: 'Segoe UI', Arial, sans-serif; white-space: pre-wrap; word-wrap: break-word;">{personalized_content}</pre>
                        </div>
                        <div style="text-align: center; padding: 10px; background-color: #ecf0f1; border-radius: 0 0 5px 5px; font-size: 12px; color: #7f8c8d;">
                            Bu email TedarikÃ§i Uyumluluk Sistemi tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.
                        </div>
                    </div>
                </body>
                </html>
                """
                
                msg.attach(MIMEText(html_content, 'html'))
                
                # SMTP sunucusuna baÄŸlan ve gÃ¶nder
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
                server.send_message(msg)
                server.quit()
                
                success_count += 1
                activity_logger.log_email_sent(mail, subject, "TedarikÃ§i Uyumluluk")
                
            except Exception as e:
                fail_count += 1
                print(f"Mail gÃ¶nderme hatasÄ± ({mail}): {e}")
        
        # SonuÃ§ mesajÄ±
        result_msg = f"BaÅŸarÄ±lÄ±: {success_count} mail gÃ¶nderildi"
        if fail_count > 0:
            result_msg += f"\nBaÅŸarÄ±sÄ±z: {fail_count}"
        if empty_email_count > 0:
            result_msg += f"\nBoÅŸ mail adresi: {empty_email_count}"
            result_msg += "\n\nÃ–nemli: BazÄ± kayÄ±tlarda mail adresi boÅŸ!"
        
        if success_count > 0:
            messagebox.showinfo("Mail GÃ¶nderimi TamamlandÄ±", result_msg)
        else:
            messagebox.showwarning("Mail GÃ¶nderimi BaÅŸarÄ±sÄ±z", result_msg)
        
        if fail_count > 0:
            messagebox.showwarning("UyarÄ±", f"{fail_count} mail gÃ¶nderilemedi!")
    
    def send_bulk_email():
        """TÃ¼m kayÄ±tlÄ± tedarikÃ§ilere toplu mail gÃ¶nder"""
        # FiltrelenmiÅŸ tÃ¼m kayÄ±tlara gÃ¶nder
        records = cari_tree.get_children()
        
        if not records:
            messagebox.showwarning("UyarÄ±", "GÃ¶nderilecek kayÄ±t bulunamadÄ±!")
            return
        
        result = messagebox.askyesno("Toplu Mail GÃ¶nderimi", 
                                    f"{len(records)} tedarikÃ§iye toplu mail gÃ¶ndermek istediÄŸinize emin misiniz?")
        
        if not result:
            return
        
        subject = mail_subject_entry.get().strip()
        content = mail_content_text.get("1.0", tk.END).strip()
        
        if not subject or not content:
            messagebox.showwarning("UyarÄ±", "LÃ¼tfen mail konusu ve iÃ§eriÄŸini doldurun!")
            return
        
        success_count = 0
        fail_count = 0
        empty_email_count = 0
        
        for item in records:
            values = cari_tree.item(item)["values"]
            if not values or len(values) < 6:
                continue
                
            tedarikci = str(values[0]) if len(values) > 0 else ''
            yetkili = str(values[1]) if len(values) > 1 else ''
            mail = str(values[3]) if len(values) > 3 else ''
            eksik_evraklar = str(values[5]) if len(values) > 5 else ''
            
            # Mail adresini kontrol et
            mail = mail.strip()
            if not mail or mail == '' or mail == 'nan':
                print(f"BoÅŸ mail adresi atlanÄ±yor: {tedarikci}")
                empty_email_count += 1
                fail_count += 1
                continue
            
            # Mail iÃ§eriÄŸini kiÅŸiselleÅŸtir
            personalized_content = content.replace("{{TedarikÃ§i AdÄ±}}", tedarikci)
            personalized_content = personalized_content.replace("{{Yetkili KiÅŸi}}", yetkili)
            personalized_content = personalized_content.replace("{{Eksik Evraklar}}", eksik_evraklar)
            
            try:
                # SMTP ile mail gÃ¶nder
                msg = MIMEMultipart()
                msg['From'] = GMAIL_USER
                msg['To'] = mail
                msg['Subject'] = subject
                
                # HTML formatÄ±nda mail iÃ§eriÄŸi
                html_content = f"""
                <html>
                <body style="font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333;">
                    <div style="max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
                        <div style="background-color: #16a085; color: white; padding: 15px; border-radius: 5px 5px 0 0;">
                            <h2 style="margin: 0;">ğŸ›ï¸ TedarikÃ§i Uyumluluk Merkezi</h2>
                        </div>
                        <div style="padding: 20px; background-color: #f9f9f9;">
                            <pre style="font-family: 'Segoe UI', Arial, sans-serif; white-space: pre-wrap; word-wrap: break-word;">{personalized_content}</pre>
                        </div>
                        <div style="text-align: center; padding: 10px; background-color: #ecf0f1; border-radius: 0 0 5px 5px; font-size: 12px; color: #7f8c8d;">
                            Bu email TedarikÃ§i Uyumluluk Sistemi tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.
                        </div>
                    </div>
                </body>
                </html>
                """
                
                msg.attach(MIMEText(html_content, 'html'))
                
                # SMTP sunucusuna baÄŸlan ve gÃ¶nder
                server = smtplib.SMTP('smtp.gmail.com', 587)
                server.starttls()
                server.login(GMAIL_USER, GMAIL_APP_PASSWORD)
                server.send_message(msg)
                server.quit()
                
                success_count += 1
                activity_logger.log_email_sent(mail, subject, "TedarikÃ§i Uyumluluk")
                
            except Exception as e:
                fail_count += 1
                print(f"Mail gÃ¶nderme hatasÄ± ({mail}): {e}")
        
        # SonuÃ§ mesajÄ±
        result_msg = f"BaÅŸarÄ±lÄ±: {success_count}\nBaÅŸarÄ±sÄ±z: {fail_count}"
        if empty_email_count > 0:
            result_msg += f"\nBoÅŸ mail adresi: {empty_email_count}"
            result_msg += "\n\nÃ–nemli: BazÄ± kayÄ±tlarda mail adresi boÅŸ olduÄŸu iÃ§in gÃ¶nderilemedi!"
        
        messagebox.showinfo("Toplu Mail GÃ¶nderimi TamamlandÄ±", result_msg)
    
    tk.Button(mail_btn_frame, text="ğŸ“§ SeÃ§ili TedarikÃ§ilere GÃ¶nder", font=("Segoe UI", 10, "bold"),
             bg="#27ae60", fg="white", cursor="hand2", padx=15, pady=8,
             command=send_single_email).pack(side="left", padx=5)
    
    tk.Button(mail_btn_frame, text="ğŸ“§ Toplu Mail GÃ¶nder (TÃ¼m Liste)", font=("Segoe UI", 10, "bold"),
             bg="#e74c3c", fg="white", cursor="hand2", padx=15, pady=8,
             command=send_bulk_email).pack(side="left", padx=5)
    
    tk.Button(mail_btn_frame, text="ğŸ“‹ Excel'i AÃ§", font=("Segoe UI", 10, "bold"),
             bg="#3498db", fg="white", cursor="hand2", padx=15, pady=8,
             command=lambda: os.startfile(MASTER_CARI_BILGILER_PATH) if os.path.exists(MASTER_CARI_BILGILER_PATH) else messagebox.showwarning("UyarÄ±", "Excel dosyasÄ± bulunamadÄ±!")).pack(side="left", padx=5)
    
    # Ana grid container - 2 sÃ¼tun
    main_grid = tk.Frame(content, bg="#ecf0f1")
    main_grid.pack(fill="both", expand=True)
    main_grid.grid_columnconfigure(0, weight=1)
    main_grid.grid_columnconfigure(1, weight=1)
    
    def create_document_section(parent, title, path, color, icon, column):
        """Belge bÃ¶lÃ¼mÃ¼ oluÅŸtur"""
        section_frame = tk.LabelFrame(
            parent,
            text=f"{icon} {title}",
            font=("Segoe UI", 13, "bold"),
            bg="white",
            fg=color,
            padx=12,
            pady=12,
            relief="solid",
            bd=2
        )
        section_frame.grid(row=0, column=column, padx=5, pady=5, sticky="nsew")
        
        # Scroll container
        scroll_container = tk.Frame(section_frame, bg="white")
        scroll_container.pack(fill="both", expand=True)
        
        canvas = tk.Canvas(scroll_container, bg="white", highlightthickness=0)
        scrollbar = ttk.Scrollbar(scroll_container, orient="vertical", command=canvas.yview)
        scrollable_frame = tk.Frame(canvas, bg="white")
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        
        # DosyalarÄ± listele
        if not os.path.exists(path):
            tk.Label(scrollable_frame, 
                    text=f"âš ï¸ KlasÃ¶r bulunamadÄ±:\n{path}",
                    font=("Segoe UI", 9),
                    fg="#e74c3c",
                    bg="white",
                    justify="left",
                    wraplength=300).pack(pady=20, padx=10)
            return
        
        try:
            pdf_files = sorted(glob.glob(os.path.join(path, "*.[pP][dD][fF]")))
            
            if not pdf_files:
                tk.Label(scrollable_frame, 
                        text="ğŸ“­ HenÃ¼z belge bulunmuyor",
                        font=("Segoe UI", 10),
                        fg="gray",
                        bg="white").pack(pady=20)
            else:
                for pdf_file in pdf_files:
                    file_name = os.path.basename(pdf_file)
                    file_size = os.path.getsize(pdf_file)
                    file_size_kb = file_size / 1024
                    file_mtime = datetime.fromtimestamp(os.path.getmtime(pdf_file))
                    
                    # Dosya kartÄ±
                    file_card = tk.Frame(scrollable_frame, bg="#f8f9fa", bd=1, relief="solid", padx=10, pady=8)
                    file_card.pack(fill="x", pady=3, padx=5)
                    
                    # Dosya adÄ±
                    name_label = tk.Label(file_card, text=f"ğŸ“„ {file_name}", 
                                         font=("Segoe UI", 9, "bold"),
                                         bg="#f8f9fa", fg="#2c3e50",
                                         anchor="w")
                    name_label.pack(fill="x")
                    
                    # Dosya bilgileri
                    info_text = f"ğŸ“ {file_size_kb:.1f} KB  |  ğŸ“… {file_mtime.strftime('%d.%m.%Y %H:%M')}"
                    info_label = tk.Label(file_card, text=info_text,
                                         font=("Segoe UI", 8),
                                         bg="#f8f9fa", fg="gray",
                                         anchor="w")
                    info_label.pack(fill="x")
                    
                    # Butonlar
                    btn_frame = tk.Frame(file_card, bg="#f8f9fa")
                    btn_frame.pack(fill="x", pady=(5, 0))
                    
                    def open_file(filepath=pdf_file):
                        try:
                            import subprocess
                            if os.name == 'nt':  # Windows
                                os.startfile(filepath)
                            elif os.name == 'posix':  # macOS/Linux
                                subprocess.call(['open', filepath])
                            if activity_logger:
                                activity_logger.log_activity(f"Belge aÃ§Ä±ldÄ±: {os.path.basename(filepath)}", 
                                                            "TedarikÃ§i Uyumluluk")
                        except Exception as e:
                            messagebox.showerror("Hata", f"Dosya aÃ§Ä±lÄ±rken hata oluÅŸtu:\n{str(e)}")
                    
                    def copy_path(filepath=pdf_file):
                        root.clipboard_clear()
                        root.clipboard_append(filepath)
                        messagebox.showinfo("BaÅŸarÄ±lÄ±", "Dosya yolu panoya kopyalandÄ±!")
                    
                    open_btn = tk.Button(btn_frame, text="ğŸ“‚ AÃ§", 
                                        font=("Segoe UI", 8),
                                        bg=color, fg="white",
                                        relief="flat",
                                        cursor="hand2",
                                        padx=8, pady=2,
                                        command=open_file)
                    open_btn.pack(side="left", padx=2)
                    
                    copy_btn = tk.Button(btn_frame, text="ğŸ“‹ Yol Kopyala",
                                        font=("Segoe UI", 8),
                                        bg="#95a5a6", fg="white",
                                        relief="flat",
                                        cursor="hand2",
                                        padx=8, pady=2,
                                        command=copy_path)
                    copy_btn.pack(side="left", padx=2)
                    
        except Exception as e:
            tk.Label(scrollable_frame,
                    text=f"âŒ Hata: {str(e)}",
                    font=("Segoe UI", 9),
                    fg="#e74c3c",
                    bg="white").pack(pady=20, padx=10)
    
    # Sertifikalar bÃ¶lÃ¼mÃ¼ (sol)
    create_document_section(main_grid, "SERTÄ°FÄ°KALAR", MASTER_SERTIFIKA_PATH, "#27ae60", "ğŸ†", 0)
    
    # SÃ¶zleÅŸmeler bÃ¶lÃ¼mÃ¼ (saÄŸ)
    create_document_section(main_grid, "SÃ–ZLEÅMELER", MASTER_SOZLESME_PATH, "#e74c3c", "ğŸ“", 1)
    
    # Alt bilgi
    info_frame = tk.Frame(content, bg="#ecf0f1", pady=10)
    info_frame.pack(side="bottom", fill="x")
    
    info_label = tk.Label(
        info_frame,
        text="ğŸ’¡ Belgeleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in 'ğŸ“‚ AÃ§' butonuna tÄ±klayÄ±n  |  ğŸ”„ Yeni belgeler otomatik olarak burada gÃ¶rÃ¼necektir",
        font=("Segoe UI", 9, "italic"),
        fg="#7f8c8d",
        bg="#ecf0f1"
    )
    info_label.pack()
    
    # Yenile butonu
    refresh_btn = tk.Button(
        info_frame,
        text="ğŸ”„ Listeyi Yenile",
        font=("Segoe UI", 10, "bold"),
        bg="#3498db",
        fg="white",
        relief="raised",
        bd=2,
        cursor="hand2",
        padx=15,
        pady=8,
        command=init_compliance_center_tab
    )
    refresh_btn.pack(pady=(10, 0))

# ---------- GUI BAÅLATILMASI ----------
def show_page(page_name):
    global current_page_name
    current_page_name = page_name
    
    # LOG: Sayfa ziyareti
    if activity_logger:
        activity_logger.log_page_visit(page_name)
    
    for frame in frames.values():
        frame.pack_forget()
    
    if page_name in frames:
        frames[page_name].pack(fill="both", expand=True)
        
        # Trend AvcÄ±sÄ± initialization on demand
        if page_name == "Trend AvcÄ±sÄ±":
            init_trend_hunter_tab()
        # Yeni ModÃ¼ller initialization on demand
        elif page_name == "Ãœretim Takibi":
            init_production_pipeline_tab()
        elif page_name == "Hammadde FiyatlarÄ±":
            init_commodity_intelligence_tab()
        # Stok YÃ¶netimi initialization on demand
        elif page_name == "Stok YÃ¶netimi":
            init_stok_tab()
        # TedarikÃ§i Uyumluluk Merkezi initialization on demand
        elif page_name == "TedarikÃ§i Uyumluluk":
            init_compliance_center_tab()
        # Reklamasyon pages initialization on demand
        elif page_name == "Rek YÃ¶netici Ã–zeti":
            draw_rek_dashboard(frame_rek_ozet)
        elif page_name == "Rek DetaylÄ± Rapor":
            init_rek_detailed_report_tab()
        
    for btn_name, btn in menu_buttons.items():
        if btn_name == page_name:
            btn.configure(fg_color=("#3498db", "#3498db"), text_color="white")
        else:
            btn.configure(fg_color="transparent", text_color=("white", "white")) 

# Set CustomTkinter appearance mode and color theme
ctk.set_appearance_mode("dark")  # Modes: "System" (default), "Dark", "Light"
ctk.set_default_color_theme("blue")  # Themes: "blue" (default), "green", "dark-blue"

root = ctk.CTk()
root.title("TedarikÃ§i Rapor Analiz v2.8 (Production Pipeline & Commodity Intelligence)")
root.geometry("1280x850")
# Ayarlar deÄŸiÅŸkenleri global olarak tanÄ±mlanÄ±r
price_weight = tk.DoubleVar(value=0.4)
delivery_weight = tk.DoubleVar(value=0.3)
return_weight = tk.DoubleVar(value=0.3)
exclude_outliers_var = tk.BooleanVar(value=False)  # VarsayÄ±lan: AykÄ±rÄ± deÄŸer filtresi KAPALI

style = ttk.Style()
style.configure("AI.Horizontal.TProgressbar", foreground='#4CAF50', background='#E8F5E9')

# --- CANLI TICKER ÅERÄ°DÄ° (EN ÃœSTTE) ---
ticker_frame = ctk.CTkFrame(root, height=30, corner_radius=0)
ticker_frame.pack(side="top", fill="x")
ticker_label = ctk.CTkLabel(ticker_frame, text="Piyasa verileri yÃ¼kleniyor...", font=("Consolas", 10, "bold"), text_color="#2ecc71")
ticker_label.pack(side="left", padx=10)
# Ticker'Ä± BaÅŸlat - mainloop baÅŸladÄ±ktan sonra Ã§alÄ±ÅŸtÄ±r
# update_market_ticker()  # Bu satÄ±r mainloop Ã¶ncesi Ã§aÄŸrÄ±lamaz - threading hatasÄ± verir
scroll_ticker_animation()

sidebar = ctk.CTkFrame(root, width=250, corner_radius=0)
sidebar.pack(side="left", fill="y")
sidebar.pack_propagate(False) 

ctk.CTkLabel(sidebar, text="TedarikÃ§i\nAnaliz Sistemi", font=("Segoe UI", 16, "bold")).pack(fill="x", pady=20)

# --- KAYDIRILABÄ°LÄ°R SOL MENÃœ (SCROLLABLE SIDEBAR) ---
# Scrollbar'Ä± Ã¶nce tanÄ±mlayÄ±p saÄŸa yaslÄ±yoruz, bÃ¶ylece her zaman gÃ¶rÃ¼nÃ¼r alanda kalÄ±yor.
sidebar_scrollbar = tk.Scrollbar(sidebar, orient="vertical")
sidebar_scrollbar.pack(side="right", fill="y")

sidebar_canvas = tk.Canvas(sidebar, bg="#2c3e50", highlightthickness=0, yscrollcommand=sidebar_scrollbar.set)
sidebar_canvas.pack(side="left", fill="both", expand=True)

sidebar_scrollbar.configure(command=sidebar_canvas.yview)

sidebar_content_frame = ctk.CTkFrame(sidebar_canvas, fg_color="transparent")

sidebar_content_frame.bind(
    "<Configure>",
    lambda e: sidebar_canvas.configure(scrollregion=sidebar_canvas.bbox("all"))
)

# Canvas iÃ§inde pencere oluÅŸturuyoruz.
canvas_window = sidebar_canvas.create_window((0, 0), window=sidebar_content_frame, anchor="nw")

# Canvas geniÅŸliÄŸi deÄŸiÅŸtiÄŸinde (Ã¶rn: scrollbar gÃ¶rÃ¼ndÃ¼ÄŸÃ¼nde) iÃ§erik frame'inin geniÅŸliÄŸini de gÃ¼ncelliyoruz.
def on_sidebar_canvas_configure(event):
    sidebar_canvas.itemconfig(canvas_window, width=event.width)

sidebar_canvas.bind("<Configure>", on_sidebar_canvas_configure)

# Mouse TekerleÄŸi DesteÄŸi
def on_mousewheel(event):
    sidebar_canvas.yview_scroll(int(-1*(event.delta/120)), "units")

# Fare sidebar Ã¼zerindeyken scroll Ã§alÄ±ÅŸsÄ±n
sidebar_canvas.bind("<Enter>", lambda _: sidebar_canvas.bind_all("<MouseWheel>", on_mousewheel))
sidebar_canvas.bind("<Leave>", lambda _: sidebar_canvas.unbind_all("<MouseWheel>"))

content_area = ctk.CTkFrame(root, corner_radius=0)
content_area.pack(side="right", fill="both", expand=True)

frame_ozet = ttk.Frame(content_area)
frame_analiz = ttk.Frame(content_area, padding="20")
frame_siparis = ttk.Frame(content_area, padding="10")
frame_karne = ttk.Frame(content_area, padding="10")
frame_trend = ttk.Frame(content_area, padding="10")
frame_tahmin = ttk.Frame(content_area, padding="10")
frame_harita = ttk.Frame(content_area, padding="0")
frame_detaylar = ttk.Frame(content_area, padding="10")
frame_karsilastirma = ttk.Frame(content_area, padding="10")
frame_ocr = ttk.Frame(content_area, padding="10")
frame_chat = ttk.Frame(content_area, padding="10")
frame_ayarlar = ttk.Frame(content_area, padding="10")
frame_ai = ttk.Frame(content_area, padding="10")
frame_negotiator = ttk.Frame(content_area, padding="10") 
frame_haberler = ttk.Frame(content_area, padding="10") # YENÄ° FRAME
frame_trend_hunter = ttk.Frame(content_area, padding="10") # TREND AVCISI FRAME

# Yeni ModÃ¼ller
frame_production_pipeline = ttk.Frame(content_area, padding="10")  # Ãœretim Takibi GANT
frame_commodity_intel = ttk.Frame(content_area, padding="10")  # Hammadde Fiyat Ä°stihbaratÄ±

# Reklamasyon YÃ¶netimi Frames
frame_rek_main = ttk.Frame(content_area, padding="10")
frame_rek_ozet = ttk.Frame(content_area, padding="10")
frame_rek_detayli = ttk.Frame(content_area, padding="10")
frame_rek_mail = ttk.Frame(content_area, padding="10")
frame_rek_galeri = ttk.Frame(content_area, padding="10")
frame_rek_veri = ttk.Frame(content_area, padding="10")

# Eksik-Fazla YÃ¼klemeler Frame
frame_eksik_fazla = ttk.Frame(content_area, padding="10")

# Stok YÃ¶netimi Frame
frame_stok = ttk.Frame(content_area, padding="10")

# TedarikÃ§i Uyumluluk Merkezi Frame
frame_compliance = ttk.Frame(content_area, padding="10")

frames = {
    "YÃ¶netim Paneli": frame_ozet,
    "Analiz": frame_analiz,
    "AkÄ±llÄ± SipariÅŸ": frame_siparis,
    "TedarikÃ§i Karnesi": frame_karne,
    "AylÄ±k Trend": frame_trend,
    "Gelecek Tahmini": frame_tahmin,
    "Harita": frame_harita,
    "Detaylar": frame_detaylar,
    "KarÅŸÄ±laÅŸtÄ±rma": frame_karsilastirma,
    "OCR (Fatura)": frame_ocr,
    "Verilerinle KonuÅŸ": frame_chat,
    "YZ Yorumu": frame_ai,
    "PazarlÄ±k Robotu": frame_negotiator, 
    "Ayarlar": frame_ayarlar, # ArtÄ±k kullanÄ±lmÄ±yor ama referans hatasÄ± olmamasÄ± iÃ§in tutuldu
    "SektÃ¶r Haberleri": frame_haberler, # YENÄ° FRAME
    "Trend AvcÄ±sÄ±": frame_trend_hunter, # TREND HUNTER
    # Yeni ModÃ¼ller
    "Ãœretim Takibi": frame_production_pipeline,  # SipariÅŸ AÅŸama Takibi
    "Hammadde FiyatlarÄ±": frame_commodity_intel,  # Hammadde Fiyat Ä°stihbaratÄ±
    # Reklamasyon YÃ¶netimi
    "Reklamasyon YÃ¶netimi": frame_rek_main,
    "Rek YÃ¶netici Ã–zeti": frame_rek_ozet,
    "Rek DetaylÄ± Rapor": frame_rek_detayli,
    "Rek Mail Merkezi": frame_rek_mail,
    "Rek Galeri": frame_rek_galeri,
    "Rek Veri YÃ¼kleme": frame_rek_veri,
    # Eksik-Fazla YÃ¼klemeler
    "Eksik-Fazla YÃ¼klemeler": frame_eksik_fazla,
    # Stok YÃ¶netimi
    "Stok YÃ¶netimi": frame_stok,
    # TedarikÃ§i Uyumluluk Merkezi
    "TedarikÃ§i Uyumluluk": frame_compliance
}

menu_items = [
    ("ğŸ“Š YÃ¶netim Paneli", "YÃ¶netim Paneli"),
    ("ğŸ” Analiz & Veri", "Analiz"),
    ("ğŸ›’ AkÄ±llÄ± SipariÅŸ", "AkÄ±llÄ± SipariÅŸ"),
    ("ğŸ’° PazarlÄ±k Robotu", "PazarlÄ±k Robotu"), 
    ("ğŸ“° SektÃ¶r Haberleri", "SektÃ¶r Haberleri"), # YENÄ° BUTON
    ("ğŸ”® Trend AvcÄ±sÄ±", "Trend AvcÄ±sÄ±"), # TREND HUNTER
    ("ğŸ­ Reklamasyon YÃ¶netimi", "Reklamasyon YÃ¶netimi"), # YENÄ° BUTON
    ("ğŸ“… Ãœretim Takibi", "Ãœretim Takibi"),  # YENÄ°: SipariÅŸ AÅŸama Takibi - GANT
    ("ğŸ’¹ Hammadde FiyatlarÄ±", "Hammadde FiyatlarÄ±"),  # YENÄ°: Hammadde Fiyat Ä°stihbaratÄ±
    ("ğŸ­ Defacto Ãœretim RaporlarÄ±", "Stok YÃ¶netimi"),  # YENÄ°: Ãœretim Takibi
    ("ğŸ›ï¸ TedarikÃ§i Uyumluluk Merkezi", "TedarikÃ§i Uyumluluk"),  # YENÄ°: Sertifika ve SÃ¶zleÅŸme YÃ¶netimi
    ("ğŸ“¦ Eksik-Fazla YÃ¼klemeler", "Eksik-Fazla YÃ¼klemeler"),  # YENÄ°: YÃ¼kleme Analizi
    ("ğŸ“ TedarikÃ§i Karnesi", "TedarikÃ§i Karnesi"),
    ("ğŸ“ˆ AylÄ±k Trend", "AylÄ±k Trend"),
    ("ğŸ”® Gelecek Tahmini", "Gelecek Tahmini"),
    ("ğŸ—ºï¸ Harita", "Harita"),
    ("ğŸ“‹ Detaylar", "Detaylar"),
    ("âš–ï¸ KarÅŸÄ±laÅŸtÄ±rma", "KarÅŸÄ±laÅŸtÄ±rma"),
    ("ğŸ“· OCR (Fatura)", "OCR (Fatura)"),
    ("ğŸ’¬ Verilerinle KonuÅŸ", "Verilerinle KonuÅŸ"),
    ("ğŸ¤– YZ Raporu", "YZ Yorumu")
]

for text, name in menu_items:
    btn = ctk.CTkButton(sidebar_content_frame, text=text, font=("Segoe UI", 11), 
                        corner_radius=6, anchor="w", 
                        command=lambda n=name: show_page(n),
                        fg_color="transparent", hover_color=("#34495e", "#34495e"),
                        text_color=("white", "white"))
    btn.pack(fill="x", pady=2, padx=5)
    menu_buttons[name] = btn

# Sistem AraÃ§larÄ± BÃ¶lÃ¼mÃ¼
ctk.CTkLabel(sidebar_content_frame, text="â”€â”€â”€â”€â”€â”€â”€â”€â”€", font=("Arial", 8), text_color="#95a5a6").pack(pady=5)
ctk.CTkLabel(sidebar_content_frame, text="SÄ°STEM ARAÃ‡LARI", font=("Segoe UI", 9, "bold"), text_color="#95a5a6").pack(pady=2)

system_tools_frame = ctk.CTkFrame(sidebar_content_frame, fg_color="transparent")
system_tools_frame.pack(fill="x", pady=5, padx=5)

ttk.Button(system_tools_frame, text="ğŸ’¾ Yedek Al", 
          command=create_backup).pack(fill="x", pady=2)
ttk.Button(system_tools_frame, text="ğŸ“¥ Yedek YÃ¼kle", 
          command=restore_backup).pack(fill="x", pady=2)
ttk.Button(system_tools_frame, text="ğŸ”” Bildirimleri Test Et", 
          command=lambda: show_desktop_notification("Test Bildirimi", "Sistem Ã§alÄ±ÅŸÄ±yor! âœ…")).pack(fill="x", pady=2)

ctk.CTkLabel(sidebar_content_frame, text="v2.8 | DeFacto", font=("Arial", 8), text_color="#95a5a6").pack(side="bottom", pady=10)

status_label = ttk.Label(content_area, text="HazÄ±r", relief="sunken", anchor="w")
status_label.pack(side="bottom", fill="x")

draw_dashboard(frame_ozet)
init_map_tab() 
init_chat_tab() 
init_scorecard_tab() 
init_ocr_tab() 
init_smart_order_tab() 
init_negotiator_tab() 
init_news_tab() # YENÄ° FONKSÄ°YON
init_eksik_fazla_tab() # Eksik-Fazla YÃ¼klemeler

# Reklamasyon YÃ¶netimi BaÅŸlatma
load_reklamasyon_data()
init_rek_main_tab()
init_rek_data_load_tab()
init_rek_gallery_tab()
init_rek_mail_tab()

show_page("YÃ¶netim Paneli")

# --- ANALÄ°Z & VERÄ° SAYFASI ---
ttk.Label(frame_analiz, text="1. DosyalarÄ± SeÃ§in:").pack(pady=5)

# Dosya seÃ§im butonlarÄ± iÃ§in frame
file_button_frame = ttk.Frame(frame_analiz)
file_button_frame.pack(pady=5, fill="x")

ttk.Button(file_button_frame, text="ğŸ“ Dosya SeÃ§", command=dosyalarÄ±_sec).pack(side="left", padx=(0,5), expand=True, fill="x")
ttk.Button(file_button_frame, text="ğŸ—„ï¸ MySQL Veri Merkezi", command=mysql_unified_data_loader).pack(side="left", padx=(5,0), expand=True, fill="x")

# FÄ°LTRELEME SEÃ‡ENEKLERÄ° (Stok Kodu / Stok Grubu)
filter_options_frame = ttk.LabelFrame(frame_analiz, text="2. Filtreleme SeÃ§enekleri (Opsiyonel)")
filter_options_frame.pack(pady=5, fill="x", padx=5)

# Filtreleme tipi seÃ§imi
analiz_filter_type_var = tk.StringVar(value="none")

def toggle_analiz_filter_fields():
    """Filtreleme tipine gÃ¶re ilgili combobox'Ä± gÃ¶ster/gizle"""
    filter_type = analiz_filter_type_var.get()
    if filter_type == "stock_code":
        stok_kod_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="ew")
        stok_grup_filter_combobox.grid_forget()
        stok_kod_combobox.configure(state="normal")
    elif filter_type == "stock_group":
        stok_grup_filter_combobox.grid(row=1, column=1, padx=5, pady=5, sticky="ew")
        stok_kod_combobox.grid_forget()
    else:  # "none"
        stok_kod_combobox.grid_forget()
        stok_grup_filter_combobox.grid_forget()
        stok_kod_combobox.configure(state="disabled")

filter_type_frame = tk.Frame(filter_options_frame)
filter_type_frame.grid(row=0, column=0, columnspan=2, padx=5, pady=5, sticky="w")

ttk.Label(filter_type_frame, text="Filtre Tipi:").pack(side="left", padx=(0, 10))
ttk.Radiobutton(filter_type_frame, text="Filtre Yok", variable=analiz_filter_type_var, value="none", command=toggle_analiz_filter_fields).pack(side="left", padx=5)
ttk.Radiobutton(filter_type_frame, text="Stok Kodu", variable=analiz_filter_type_var, value="stock_code", command=toggle_analiz_filter_fields).pack(side="left", padx=5)
ttk.Radiobutton(filter_type_frame, text="Stok Grubu", variable=analiz_filter_type_var, value="stock_group", command=toggle_analiz_filter_fields).pack(side="left", padx=5)

ttk.Label(filter_options_frame, text="SeÃ§im:").grid(row=1, column=0, padx=5, pady=5, sticky="w")

# Stok Kodu combobox (mevcut)
stok_kod_combobox = ttk.Combobox(filter_options_frame, state="disabled")
stok_kod_combobox.bind("<KeyRelease>", filter_stock_codes)

# Stok Grubu combobox
stok_grup_filter_combobox = ttk.Combobox(filter_options_frame, state="normal")

# Tarih aralÄ±ÄŸÄ±
ttk.Label(frame_analiz, text="3. Tarih AralÄ±ÄŸÄ± (Opsiyonel):").pack(pady=5)
df_date = ttk.Frame(frame_analiz); df_date.pack(pady=5)
ttk.Label(df_date, text="BaÅŸlangÄ±Ã§ (gg-aa-yyyy):").pack(side="left")
start_date_entry = ttk.Entry(df_date, width=12); start_date_entry.pack(side="left", padx=5)
ttk.Label(df_date, text="BitiÅŸ:").pack(side="left")
end_date_entry = ttk.Entry(df_date, width=12); end_date_entry.pack(side="left", padx=5)

# --- AYARLAR (EMBEDDED) ---
settings_frame = ttk.LabelFrame(frame_analiz, text="âš™ï¸ Analiz Parametreleri & AÄŸÄ±rlÄ±klar")
settings_frame.pack(pady=10, fill="x", padx=5)

# AÄŸÄ±rlÄ±klar
p_frame = tk.Frame(settings_frame); p_frame.pack(fill="x", padx=5, pady=2)
price_label = ttk.Label(p_frame, text="Fiyat: 0.40", width=12); price_label.pack(side="left")
ttk.Scale(p_frame, variable=price_weight, from_=0, to=1, command=update_weights).pack(side="left", fill="x", expand=True)

d_frame = tk.Frame(settings_frame); d_frame.pack(fill="x", padx=5, pady=2)
delivery_label = ttk.Label(d_frame, text="Teslim: 0.30", width=12); delivery_label.pack(side="left")
ttk.Scale(d_frame, variable=delivery_weight, from_=0, to=1, command=update_weights).pack(side="left", fill="x", expand=True)

r_frame = tk.Frame(settings_frame); r_frame.pack(fill="x", padx=5, pady=2)
return_label = ttk.Label(r_frame, text="Ä°ade: 0.30", width=12); return_label.pack(side="left")
ttk.Scale(r_frame, variable=return_weight, from_=0, to=1, command=update_weights).pack(side="left", fill="x", expand=True)

# AykÄ±rÄ± DeÄŸerler
outlier_subframe = tk.Frame(settings_frame)
outlier_subframe.pack(fill="x", padx=5, pady=5)
ttk.Checkbutton(outlier_subframe, text="AykÄ±rÄ± DeÄŸerleri Filtrele", variable=exclude_outliers_var).pack(side="left")
ttk.Button(outlier_subframe, text="ğŸ’¾ AykÄ±rÄ±larÄ± Ä°ndir", command=save_outliers_to_excel, width=15).pack(side="right")

# --- ANALÄ°Z DURUM VE BUTONLARI ---
ai_status_label = ttk.Label(frame_analiz, text="", font=("Arial", 10, "italic")); ai_status_label.pack(pady=5)
ai_progress_bar = ttk.Progressbar(frame_analiz, style="AI.Horizontal.TProgressbar", mode='indeterminate')

ttk.Button(frame_analiz, text="ANALÄ°ZÄ° BAÅLAT", command=start_analysis_threaded).pack(pady=10, fill="x")
ttk.Button(frame_analiz, text="Raporu E-Posta GÃ¶nder", command=send_report_email).pack(pady=5, fill="x")

monitor_frame = ttk.LabelFrame(frame_analiz, text="Otomatik KlasÃ¶r Ä°zleme"); monitor_frame.pack(pady=10, fill="x", padx=5)
start_button = ttk.Button(monitor_frame, text="BaÅŸlat", command=start_monitoring); start_button.pack(side="left", padx=5, pady=5, expand=True)
stop_button = ttk.Button(monitor_frame, text="Durdur", command=stop_monitoring, state="disabled"); stop_button.pack(side="right", padx=5, pady=5, expand=True)

# --- DETAYLAR SEKMESÄ° (GeliÅŸtirilmiÅŸ Filtreleme ile) ---
def init_detaylar_tab():
    """Detaylar sekmesini geliÅŸmiÅŸ filtreleme ile baÅŸlatÄ±r"""
    for widget in frame_detaylar.winfo_children(): widget.destroy()
    
    # Filtre Ã‡ubuÄŸu
    filter_frame = tk.Frame(frame_detaylar, bg="#f8f9fa", padx=10, pady=15, bd=1, relief="solid")
    filter_frame.pack(fill="x", padx=10, pady=5)
    
    tk.Label(filter_frame, text="TedarikÃ§i:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=(0,5))
    supplier_var = tk.StringVar(value="TÃ¼mÃ¼")
    supplier_combo = ttk.Combobox(filter_frame, textvariable=supplier_var, state="readonly", width=25)
    supplier_combo.pack(side="left", padx=5)
    
    tk.Label(filter_frame, text="|  DetaylÄ± Arama:", bg="#f8f9fa", font=("Segoe UI", 9, "bold")).pack(side="left", padx=15)
    search_col_var = tk.StringVar(value="TÃ¼mÃ¼")
    search_col_combo = ttk.Combobox(filter_frame, textvariable=search_col_var, state="readonly", width=15)
    search_col_combo.pack(side="left", padx=5)
    entry_search = ttk.Entry(filter_frame, width=30)
    entry_search.pack(side="left", padx=5)
    
    # Export Buttons
    btn_xls = tk.Button(filter_frame, text="Excel", bg="#27ae60", fg="white", font=("Segoe UI", 8), command=lambda: export_detaylar_data("xlsx"))
    btn_xls.pack(side="right", padx=5)
    btn_pdf = tk.Button(filter_frame, text="PDF", bg="#c0392b", fg="white", font=("Segoe UI", 8), command=lambda: export_detaylar_data("pdf"))
    btn_pdf.pack(side="right", padx=5)
    
    # Telefon Arama Butonu
    btn_phone_search = tk.Button(filter_frame, text="ğŸ“ Telefon Ara", bg="#3498db", fg="white", font=("Segoe UI", 8, "bold"), command=search_suppliers_by_phone)
    btn_phone_search.pack(side="right", padx=5)
    
    # Treeview
    tree_frame = tk.Frame(frame_detaylar)
    tree_frame.pack(fill="both", expand=True, padx=10, pady=5)
    
    supplier_treeview_new = ttk.Treeview(tree_frame, show='headings', height=20)
    vsb = ttk.Scrollbar(tree_frame, orient="vertical", command=supplier_treeview_new.yview)
    hsb = ttk.Scrollbar(tree_frame, orient="horizontal", command=supplier_treeview_new.xview)
    supplier_treeview_new.configure(yscrollcommand=vsb.set, xscrollcommand=hsb.set)
    
    supplier_treeview_new.grid(column=0, row=0, sticky='nsew')
    vsb.grid(column=1, row=0, sticky='ns')
    hsb.grid(column=0, row=1, sticky='ew')
    tree_frame.grid_columnconfigure(0, weight=1)
    tree_frame.grid_rowconfigure(0, weight=1)
    
    current_filtered_data = []
    
    def apply_detaylar_filters(event=None):
        """Detaylar sekmesi filtrelerini uygular"""
        nonlocal current_filtered_data
        
        # Treeview'i temizle
        for i in supplier_treeview_new.get_children():
            supplier_treeview_new.delete(i)
        
        if df_global is None or tedarikci_col_global is None:
            return
        
        # Veriyi kopyala
        df_filtered = df_global.copy()
        
        # TedarikÃ§i filtresi
        selected_supplier = supplier_combo.get()
        if selected_supplier and selected_supplier != "TÃ¼mÃ¼":
            df_filtered = df_filtered[df_filtered[tedarikci_col_global] == selected_supplier]
        
        # DetaylÄ± arama filtresi
        search_text = entry_search.get().lower()
        if search_text:
            search_col = search_col_var.get()
            if search_col == "TÃ¼mÃ¼":
                # TÃ¼m kolonlarda ara
                mask = df_filtered.apply(lambda row: any(search_text in str(val).lower() for val in row), axis=1)
                df_filtered = df_filtered[mask]
            else:
                # Belirli bir kolonda ara
                if search_col in df_filtered.columns:
                    df_filtered = df_filtered[df_filtered[search_col].astype(str).str.lower().str.contains(search_text, na=False)]
        
        # SonuÃ§larÄ± gÃ¶ster (maksimum 1000 satÄ±r)
        current_filtered_data = df_filtered.head(1000)
        
        for row in current_filtered_data.itertuples(index=False):
            supplier_treeview_new.insert('', 'end', values=row)
    
    def export_detaylar_data(format_type):
        """Detaylar verilerini export et"""
        if not current_filtered_data or len(current_filtered_data) == 0:
            messagebox.showwarning("UyarÄ±", "Export edilecek veri bulunamadÄ±!")
            return
        
        df_export = pd.DataFrame(current_filtered_data)
        if format_type == "xlsx":
            export_data(df_export, "xlsx", "Detaylar")
        elif format_type == "pdf":
            export_data(df_export, "pdf", "Detaylar")
    
    def update_detaylar_filters():
        """Analiz sonrasÄ± filtreleri gÃ¼ncelle"""
        if df_global is None or tedarikci_col_global is None:
            return
        
        # TedarikÃ§i listesini gÃ¼ncelle
        suppliers = ["TÃ¼mÃ¼"] + sorted(df_global[tedarikci_col_global].unique().astype(str).tolist())
        supplier_combo['values'] = suppliers
        
        # Kolon listesini gÃ¼ncelle
        columns = ["TÃ¼mÃ¼"] + list(df_global.columns)
        search_col_combo['values'] = columns
        
        # Treeview kolonlarÄ±nÄ± ayarla
        supplier_treeview_new['columns'] = list(df_global.columns)
        for col in list(df_global.columns):
            supplier_treeview_new.heading(col, text=col)
            supplier_treeview_new.column(col, width=100)
        
        # Ä°lk filtrelemeyi uygula
        apply_detaylar_filters()
    
    # Event bindings
    supplier_combo.bind("<<ComboboxSelected>>", apply_detaylar_filters)
    entry_search.bind("<KeyRelease>", apply_detaylar_filters)
    search_col_combo.bind("<<ComboboxSelected>>", apply_detaylar_filters)
    
    # Ã‡ift tÄ±klama ile telefon/WhatsApp menÃ¼sÃ¼
    def on_supplier_double_click(event):
        """TedarikÃ§iye Ã§ift tÄ±klanÄ±nca telefon/WhatsApp menÃ¼sÃ¼ gÃ¶ster"""
        selection = supplier_treeview_new.selection()
        if not selection:
            return
        
        item = supplier_treeview_new.item(selection[0])
        values = item['values']
        
        if not values:
            return
        
        # TedarikÃ§i adÄ±nÄ± ve telefon numarasÄ±nÄ± bul
        try:
            columns = list(df_global.columns)
            supplier_idx = columns.index(tedarikci_col_global) if tedarikci_col_global in columns else 0
            phone_idx = columns.index(phone_col_global) if phone_col_global and phone_col_global in columns else -1
            
            supplier_name = values[supplier_idx] if len(values) > supplier_idx else "Bilinmeyen"
            phone_number = values[phone_idx] if phone_idx >= 0 and len(values) > phone_idx else None
            
            if not phone_number or str(phone_number).strip() == "" or str(phone_number) == "nan":
                messagebox.showinfo("Bilgi", f"{supplier_name} iÃ§in telefon numarasÄ± bulunamadÄ±.")
                return
            
            # Ä°ÅŸlem menÃ¼sÃ¼
            action_menu = tk.Toplevel()
            action_menu.title(f"Ä°letiÅŸim - {supplier_name}")
            action_menu.geometry("400x200")
            
            tk.Label(action_menu, text=f"TedarikÃ§i: {supplier_name}", font=("Segoe UI", 12, "bold")).pack(pady=10)
            tk.Label(action_menu, text=f"Telefon: {phone_number}", font=("Segoe UI", 10)).pack(pady=5)
            
            ttk.Button(action_menu, text="ğŸ“ Telefon ile Ara", 
                      command=lambda: [make_phone_call(supplier_name, phone_number), action_menu.destroy()]).pack(fill="x", padx=50, pady=5)
            ttk.Button(action_menu, text="ğŸ’¬ WhatsApp MesajÄ± GÃ¶nder", 
                      command=lambda: [send_whatsapp_message(supplier_name, phone_number), action_menu.destroy()]).pack(fill="x", padx=50, pady=5)
            ttk.Button(action_menu, text="âŒ Ä°ptal", command=action_menu.destroy).pack(fill="x", padx=50, pady=5)
            
        except Exception as e:
            if activity_logger:
                activity_logger.log_error(f"TedarikÃ§i bilgisi Ã§ekme hatasÄ±: {str(e)}", "Detaylar")
            messagebox.showerror("Hata", f"Ä°ÅŸlem yapÄ±lamadÄ±: {str(e)}")
    
    supplier_treeview_new.bind("<Double-1>", on_supplier_double_click)
    
    # Global fonksiyonlarÄ± gÃ¼ncelle
    global update_supplier_details_tab
    def update_supplier_details_tab(df, t_col):
        root.after(0, update_detaylar_filters)

# Detaylar sekmesini baÅŸlat
init_detaylar_tab()

supplier_listbox = tk.Listbox(frame_karsilastirma, selectmode=tk.MULTIPLE, height=8); supplier_listbox.pack(fill="x")
ttk.Button(frame_karsilastirma, text="KarÅŸÄ±laÅŸtÄ±r", command=show_comparison_chart).pack()
comparison_frame = ttk.Frame(frame_karsilastirma); comparison_frame.pack(expand=True, fill="both")


def on_closing():
    """Uygulama kapatÄ±lÄ±rken kaynaklarÄ± temizler ve gÃ¼venli Ã§Ä±kÄ±ÅŸ saÄŸlar."""
    try:
        save_settings()
        
        # KlasÃ¶r izlemeyi durdur
        if observer:
            try:
                observer.stop()
            except:
                pass
        
        # Harita widget'Ä± varsa yok et (Tile loader thread'lerini durdurmaya yardÄ±mcÄ± olur)
        if map_widget:
            try:
                # Harita widget'Ä±nÄ± manuel yok etmek, iÃ§indeki resim referanslarÄ±nÄ±
                # interpreter kapanmadan temizlemeye yardÄ±mcÄ± olabilir.
                map_widget.destroy()
            except:
                pass

        root.quit()     # Mainloop'tan Ã§Ä±k
        root.destroy()  # Pencereyi yok et
    except Exception as e:
        print(f"Kapatma sÄ±rasÄ±nda hata: {e}")
        # Her durumda Ã§Ä±kmaya Ã§alÄ±ÅŸ
        try:
            import sys
            sys.exit(0)
        except:
            pass

def load_daily_files():
    """Merkezi dosyalardan verileri otomatik yÃ¼kler (startup'ta Ã§alÄ±ÅŸÄ±r)"""
    global df_global, all_stock_codes, all_stock_groups, status_label, file_paths_global
    
    messages = []
    
    # Tedarik verisini yÃ¼kle
    if os.path.exists(MASTER_TEDARIK_PATH):
        try:
            print(f"Merkezi Tedarik dosyasÄ± bulundu: {MASTER_TEDARIK_PATH}")
            df_global = pd.read_excel(MASTER_TEDARIK_PATH)
            
            # file_paths_global'Ä± set et (analiz fonksiyonu iÃ§in gerekli)
            file_paths_global = [MASTER_TEDARIK_PATH]
            
            # Stok kodu kolonunu tespit et
            stok_col = find_stok_kodu_column(df_global)
            if stok_col:
                # all_stock_codes listesini gÃ¼ncelle
                all_stock_codes = sorted(df_global[stok_col].dropna().unique().tolist())
                print(f"Stok kodlarÄ± gÃ¼ncellendi: {len(all_stock_codes)} adet")
                
                # Combobox'Ä± gÃ¼ncelle (UI thread'inde)
                if 'stok_kod_combobox' in globals() and stok_kod_combobox:
                    root.after(0, lambda: stok_kod_combobox.configure(values=all_stock_codes, state="normal"))
                    root.after(0, lambda: stok_kod_combobox.set("TÃ¼m Veri"))
            
            # Stok grubu kolonunu tespit et ve all_stock_groups'u gÃ¼ncelle
            stok_grup_col = find_stok_grubu_column(df_global)
            if stok_grup_col:
                unique_gruplar = sorted(df_global[stok_grup_col].dropna().unique().tolist())
                all_stock_groups = ["TÃ¼m Veri"] + unique_gruplar
                print(f"Stok gruplarÄ± gÃ¼ncellendi: {len(all_stock_groups)-1} adet")
                
                # Stok grup filter combobox'Ä±nÄ± gÃ¼ncelle (UI thread'inde)
                # Lambda'da deÄŸeri capture etmek iÃ§in deÄŸiÅŸkeni kopyalayalÄ±m
                gruplar_copy = all_stock_groups.copy()
                if 'stok_grup_filter_combobox' in globals() and stok_grup_filter_combobox:
                    root.after(0, lambda g=gruplar_copy: stok_grup_filter_combobox.configure(values=g))
                    root.after(0, lambda: stok_grup_filter_combobox.set("TÃ¼m Veri"))
            
            messages.append("âœ… Merkezi Tedarik verisi yÃ¼klendi")
            print(f"Tedarik verisi baÅŸarÄ±yla yÃ¼klendi: {len(df_global)} satÄ±r")
        except Exception as e:
            messages.append(f"âŒ Tedarik yÃ¼kleme hatasÄ±: {str(e)}")
            print(f"Tedarik dosyasÄ± yÃ¼kleme hatasÄ±: {e}")
    else:
        messages.append(f"âš ï¸ Tedarik dosyasÄ± bulunamadÄ±: {MASTER_TEDARIK_PATH}")
        print(f"Tedarik dosyasÄ± bulunamadÄ±: {MASTER_TEDARIK_PATH}")
    
    # Reklamasyon verisini yÃ¼kle
    if os.path.exists(MASTER_REKLAMASYON_PATH):
        try:
            print(f"Merkezi Reklamasyon dosyasÄ± bulundu: {MASTER_REKLAMASYON_PATH}")
            success, message = load_reklamasyon_data(filepath=MASTER_REKLAMASYON_PATH)
            if success:
                messages.append("âœ… Merkezi Reklamasyon verisi yÃ¼klendi")
                print("Reklamasyon verisi baÅŸarÄ±yla yÃ¼klendi")
            else:
                messages.append(f"âŒ Reklamasyon yÃ¼kleme hatasÄ±: {message}")
                print(f"Reklamasyon yÃ¼kleme hatasÄ±: {message}")
        except Exception as e:
            messages.append(f"âŒ Reklamasyon yÃ¼kleme hatasÄ±: {str(e)}")
            print(f"Reklamasyon dosyasÄ± yÃ¼kleme hatasÄ±: {e}")
    else:
        messages.append(f"âš ï¸ Reklamasyon dosyasÄ± bulunamadÄ±: {MASTER_REKLAMASYON_PATH}")
        print(f"Reklamasyon dosyasÄ± bulunamadÄ±: {MASTER_REKLAMASYON_PATH}")
    
    # Status label'Ä± gÃ¼ncelle
    if status_label:
        status_text = " | ".join(messages)
        root.after(0, lambda: status_label.configure(text=status_text))
    
    # Veri baÅŸarÄ±yla yÃ¼klendiyse otomatik analiz baÅŸlat
    if df_global is not None and file_paths_global:
        print("Otomatik analiz baÅŸlatÄ±lÄ±yor...")
        # 500ms sonra analiz baÅŸlat (UI tamamen yÃ¼klendikten sonra)
        root.after(500, lambda: auto_run_initial_analysis())
    
    print("Merkezi dosya yÃ¼kleme tamamlandÄ±")

def auto_run_initial_analysis():
    """BaÅŸlangÄ±Ã§ta tÃ¼m veri iÃ§in otomatik analiz yapar (aykÄ±rÄ± deÄŸer filtresi olmadan)"""
    global file_paths_global, analiz_filter_type_var, exclude_outliers_var
    
    if not file_paths_global:
        print("Otomatik analiz atlandÄ±: Dosya yÃ¼klenmemiÅŸ")
        return
    
    try:
        print("TÃ¼m veri analizi baÅŸlatÄ±lÄ±yor (aykÄ±rÄ± deÄŸer filtresi olmadan)...")
        
        # AykÄ±rÄ± deÄŸer filtresini KAPALI yap (kullanÄ±cÄ± isterse sonra aÃ§abilir)
        if 'exclude_outliers_var' in globals() and exclude_outliers_var:
            exclude_outliers_var.set(False)
            print("AykÄ±rÄ± deÄŸer filtresi devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ± (tik kaldÄ±rÄ±ldÄ±)")
        
        # Filter type'Ä± "none" olarak ayarla (tÃ¼m veri iÃ§in)
        if 'analiz_filter_type_var' in globals() and analiz_filter_type_var:
            analiz_filter_type_var.set("none")
        
        # Progress bar'Ä± gÃ¶ster
        if 'ai_progress_bar' in globals() and ai_progress_bar:
            ai_progress_bar.pack(pady=10, fill="x")
            ai_progress_bar.start()
        
        # Loading gif'i baÅŸlat
        if 'play_loading_gif' in globals():
            play_loading_gif()
        
        # Analiz thread'ini baÅŸlat (filter_type="none", filter_value="" ile tÃ¼m veri)
        analysis_thread = threading.Thread(
            target=lambda: analiz_et_with_options(file_paths_global, "none", "")
        )
        analysis_thread.daemon = True
        analysis_thread.start()
        
        print("Otomatik analiz baÅŸarÄ±yla tetiklendi")
    except Exception as e:
        print(f"Otomatik analiz hatasÄ±: {e}")

if __name__ == "__main__":
    # Activity logger'Ä± baÅŸlat
    activity_logger = ActivityLogger()
    
    # ZamanlanmÄ±ÅŸ gÃ¶revleri ayarla
    def scheduled_report_sender():
        """ZamanlanmÄ±ÅŸ rapor gÃ¶nderici"""
        while True:
            schedule.run_pending()
            threading.Event().wait(60)  # Her 60 saniyede bir kontrol et
    
    # GÃ¼nlÃ¼k saat 16:00'da rapor gÃ¶nder
    schedule.every().day.at("16:00").do(activity_logger.send_daily_report_email)
    
    # Periyodik raporlar (her 4 saatte bir)
    schedule.every(4).hours.do(activity_logger.send_daily_report_email)
    
    # Otomatik yedekleme planla (Her gÃ¼n saat 18:00)
    auto_backup_schedule()
    
    # SÃ¶zleÅŸme bildirimleri (Her gÃ¼n saat 09:00)
    schedule.every().day.at("09:00").do(notify_expiring_contracts)
    
    # Kritik alarmlar (Her 4 saatte bir)
    schedule.every(4).hours.do(notify_critical_alerts)
    
    # Scheduler thread'i baÅŸlat
    scheduler_thread = threading.Thread(target=scheduled_report_sender, daemon=True)
    scheduler_thread.start()
    
    activity_logger.log_event("APP_START", "Uygulama baÅŸlatÄ±ldÄ±")
    
    # BaÅŸlangÄ±Ã§ bildirimi
    show_desktop_notification("Tedarik AI", "Sistem baÅŸlatÄ±ldÄ± âœ…")
    
    load_settings()
    
    # KapanÄ±ÅŸ fonksiyonunu gÃ¼ncelle
    def on_closing_with_log():
        activity_logger.log_event("APP_CLOSE", "Uygulama kapatÄ±lÄ±yor")
        activity_logger.close_session()
        on_closing()
    
    root.protocol("WM_DELETE_WINDOW", on_closing_with_log)
    
    # Market ticker'Ä± baÅŸlat - mainloop baÅŸladÄ±ktan sonra
    root.after(100, update_market_ticker)
    
    # Merkezi dosyalarÄ± otomatik yÃ¼kle - mainloop baÅŸladÄ±ktan sonra
    root.after(100, load_daily_files)
    
    # Ä°lk bildirimleri kontrol et (5 saniye sonra)
    root.after(5000, notify_expiring_contracts)
    
    try:
        root.mainloop()
    except KeyboardInterrupt:
        on_closing_with_log()
